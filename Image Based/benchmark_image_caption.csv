Context,Source,Subclause,Image Path,Image Caption
"Home Node B should detect Macro Node B’s DwPCH, and define its timing benchmark according to Macro Node B’s DwPCH. Considering the complex deployment scenario of Home Node B networks, we advise Macro Node BS and Home Node B be deployed on different frequency band.
If Home Node B can detect multi Macro Node Bs’ signal, it should select the best suitable macro cell from all candidate Macro Node Bs.
Figure 7.5.1-1: 1.28Mcps TDD Home NodeB Timing according to Macro Node B’s DwPCH
Figure 7.5.1-1 gives three candidate 1.28Mcps TDD Home Node B air interface timing adjust methods:
-	Reference 1: The frame boundary of Home Node B precedes anchored macro one with oneτadv , which is given by macro Node B via a uplink synchronisation procedure;
-	Reference 2: The frame boundary of Home Node B is exactly aligned with anchored macro one via uplink synchronisation procedure;
-	Reference 3: Home Node B sets its frame boundary at the time point when it detects a downlink synchronisation peak, which in principle lagτadv behind anchored macro one.
If reference 1 or 2 is selected, Home Node B shall behave as a regular 1.28Mcps TDD UE and perform a ‘fake’ random access in its synchronization.
If Home Node B can not detect Macro Node Bs’ DwPCH, according to its SON characters, Home Node B should select one empty frequency that not occupied by its neighbour Home Node Bs.
-	When Home Node B is power on, it should search the best suitable Home Node B from Home Node B available frequency list, and get its timing advance.
-	Apply any type of Home Node B timing reference as shown in figure 1.",TR 25.968,7.5.1,all_images/image_1.jpeg,1.28Mcps TDD Home NodeB Timing according to Macro Node B’s DwPCH
"Figure 5.1.2-1: UE Registration for non CSG UEs or non CSG HNBs.
1.	Upon camping on the HNB, the UE initiates an initial NAS procedure (e.g. LU Procedure) by establishing an RRC connection with the HNB. UE identity, UE capabilities and Establishment Cause, are reported to the HNB as part of the RRC Connection establishment procedure.
2.	The UE then transmits a RRC Initial Direct Transfer message carrying the initial NAS message (e.g. Location Updating Request message) with some form of UE identity.
3.	The HNB checks the UE capabilities provided in step 1, and if these indicate that CSG is not supported, or the HNB itself does not support CSG, and if the identity of the UE (provided during RRC Connection Establishment) is unknown at the HNB being accessed, i.e. no Context id exists for the UE, the HNB initiates UE registration towards the HNB-GW (step 5-7). Before starting the UE Registration procedure, the HNB triggers the Identity request procedure (step 3) asking the UE for its IMSI, unless that identity has been provided during the RRC Connection Establishment or optionally if it is an emergency call. If the HNB has a context id for the UE, the UE registration procedure is not performed nor is the Identification procedure.
4.	The HNB may optionally perform access control or membership verification based on the provided IMSI and the provided Allowed IMSI list. If the UE requests emergency services it shall always be admitted to the cell.
5.	The HNB attempts to register the UE on the HNB-GW by transmitting the UE REGISTER REQUEST. The message contains at a minimum:
-	UE Identity: a unique identity for the UE provided in step 1 or 3.
-	UE Capabilities: derived from that provided in step 1.
-	Registration Cause: the indication about a UE registration for an emergency call.
NOTE:	The UE Identity provided in the HNBAP UE REGISTER REQUEST message is unauthenticated.
6.	The HNB-GW checks the UE capabilities and the Registration Cause. If the UE capabilities indicate that CSG is not supported or if the HNB does not support CSG, the HNB-GW shall perform access control or membership verification for the particular UE attempting to utilize the specific HNB. If the UE requests emergency services it shall always be admitted to the cell.
7.	If the HNB-GW accepts the UE registration attempt it shall allocate a context-id for the UE and respond with an HNBAP UE REGISTER ACCEPT message, including the context-id, to the HNB. For non-CSG UEs, the HNB-GW may also include the CSG  Status in the HNBAP UE REGISTER ACCEPT message. If the HNB-GW chooses not to accept the incoming UE registration request then the HNB-GW shall respond with an HNBAP UE REGISTER REJECT message.
8.	The HNB then sends an RUA CONNECT message containing the RANAP Initial UE message. If a L-GW function is deployed within the HNB the RANAP Initial UE message includes the corresponding IP address for Gn/S5 signalling and user data transport on the Gi interface.
9.	The reception of the RUA CONNECT message at the HNB-GW triggers the setup of an SCCP connection by the HNB-GW towards the CN. The HNB-GW then forwards the RANAP Initial UE Message to the CN.
10.	The CN responds with an SCCP Connection Confirm message.
10a. The HNB-GW shall additionally utilize a CN assisted method if available (e.g. using IMSI provided in the COMMON ID message), to alleviate the security risks associated with spoofing of IMSI and can subsequently trigger a UE deregistration upon detection of such an event.
11.	The UE continues with the NAS procedure (e.g. Location Updating procedure) towards the CN, via the HNB and the HNB-GW.",TS 25.467,5.1.2,all_images/image_2.png,UE Registration for non CSG UEs or non CSG HNBs.
"This call flow assumes that the Core Network is able to perform access control on the basis of Closed Subscriber Groups.
Figure 5.1.3-1: UE Registration for CSG UEs and CSG or Hybrid HNBs.
1.	Upon camping on the HNB, the UE initiates an initial NAS procedure (e.g. LU Procedure) by establishing an RRC connection with the HNB. UE identity and UE capabilities are reported to the HNB as part of the RRC Connection establishment procedure.
2.	The UE then transmits a RRC Initial Direct Transfer message carrying the initial NAS message (e.g. Location Updating Request message) with some form of identity (e.g. IMSI or TMSI...).
3.	The HNB checks the UE capabilities provided in step 1, and if these indicate that CSG is supported and if the identity of the UE (provided during RRC Connection Establishment) is unknown at the HNB being accessed, i.e. no Context id exist for the UE, the HNB initiates UE registration towards the HNB-GW (steps 4-6). If the HNB has a context id for the UE, UE registration procedure is not performed. No Identification procedure is triggered, independent of the identity reported by the UE during the RRC Connection Establishment.
4.	The HNB attempts to register the UE on the HNB-GW by transmitting the UE REGISTER REQUEST. The message contains:
-	UE Identity: a unique identifier for the UE and provided in step 1.
-	UE capabilities: derived from that provided in step 1.
-	Registration Cause: the indication about a UE registration for an emergency call.
NOTE:	The UE Identity provided in the UE REGISTER message is unauthenticated.
5.	The HNB-GW checks UE capabilities and if these indicate that CSG is supported and if the HNB supports CSG, the HNB-GW may accept the UE registration and allocate a context-id for the UE.
6.	The HNB-GW responds with a UE REGISTER ACCEPT message back to the HNB including a context-id allocated to the UE
7.	The HNB then sends a RUA CONNECT message containing the RANAP Initial UE message. The RANAP Initial UE message may contain the Cell Access Mode. If a L-GW function is deployed within the HNB, the RANAP Initial UE message includes the corresponding IP address for Gn/S5 interface signalling and user data transport on the Gi interface.
8.	The HNB-GW shall verify, for CSG HNBs, that the validity of the indicated cell access mode and the CSG ID in the Initial UE message as specified in TS 33.320 [16]. The reception of the RUA CONNECT message at the HNB-GW triggers the setup of an SCCP connection by the HNB-GW towards the CN. The HNB-GW then forwards the Initial UE Message including the CSG id of the HNB.
9.	The CN responds with an SCCP Connection Confirm message.
10.	The CN may optionally perform Mobility Management procedures, e.g. Authentication procedure.
11.	The CN performs access control (in case of CSG cells) or membership verification (in case of Hybrid cells) of the UE.
12.	After being granted access the UE then continues with the NAS procedure (e.g. Location Updating procedure) towards the CN, via the HNB and the HNB-GW. During such procedures the CN may send to the HNB the UE membership status for the accessed cell in the COMMON ID message.",TS 25.467,5.1.3,all_images/image_3.jpeg,UE Registration for CSG UEs and CSG or Hybrid HNBs.
"Figure 5.1.5-1: UE Registration to open access HNBs.
1.	Upon camping on the HNB, the UE initiates an initial NAS procedure (e.g. LU Procedure) by establishing an RRC connection with the HNB. UE identity and UE capabilities are reported to the HNB as part of the RRC Connection establishment procedure.
2.	The UE then transmits a RRC Initial Direct Transfer message carrying the initial NAS message (e.g. Location Updating Request message) with some form of identity (e.g. IMSI or TMSI).
3.	If the identity of the UE (provided during RRC Connection Establishment) is unknown at the HNB being accessed, i.e. no Context id exist for the UE, the HNB initiates UE registration towards the HNB-GW (steps 4-6). If the HNB has a context id for the UE, UE registration procedure is not performed. No Identification procedure is triggered, independent of the identity reported by the UE during the RRC Connection Establishment.
4.	The HNB attempts to register the UE on the HNB-GW by transmitting the UE REGISTER REQUEST. The message contains:
-	UE Identity: a unique identifier for the UE and provided in step 1.
-	UE capabilities: derived from that provided in step 1.
-	Registration Cause: the indication about a UE registration for an emergency call.
NOTE:	The UE Identity provided in the UE REGISTER message is unauthenticated.
5.	The HNB-GW may accept the UE registration and allocate a context-id for the UE.
6.	The HNB-GW responds with a UE REGISTER ACCEPT message back to the HNB including a context-id allocated to the UE.
7.	The HNB then sends a RUA CONNECT message containing the RANAP Initial UE message.
8.	The reception of the RUA CONNECT message at the HNB-GW triggers the setup of an SCCP connection by the HNB-GW towards the CN. The HNB-GW then forwards the Initial UE Message to the Core Network.
9.	The CN responds with an SCCP Connection Confirm message.
10.	The CN may optionally perform Mobility Management procedures, e.g. Authentication procedure.
11.	After being granted access the UE then continues with the NAS procedure (e.g. Location Updating procedure) towards the CN, via the HNB and the HNB-GW.",TS 25.467,5.1.5,all_images/image_4.jpeg,UE Registration to open access HNBs.
"RNSAP Relocation utilises existing protocol functions specified for Enhanced Relocation between non-CSG cells within TS 25.413 [9] and TS 25.423 [18].
Additional information from the Source HNB to the Target HNB is provided within the RANAP Enhanced Relocation Information and the RANAP Relocation Information procedures as specified in subclause 5.10.
Figure 5.7.2.1-1 below depicts the case where the UE is involved in the RNSAP Relocation and the HNBs are directly Iurh-connected. In case of UE not being involved, an Iurh signalling connection (i.e. RNA signalling resources) already exists between the involved HNBs which can be utilised for RNSAP signalling. In case of Iurh-connectivity via the HNB-GW, RNA signalling terminates at the HNB-GW, whereas RNSAP signalling is still performed peer-to-peer.
Figure 5.7.2.1-1: HNB to HNB Handover via Iurh interface – UE involved.
1.	The Source HNB evaluates the UE’s access rights against the available neighbour information. If the UE has access rights for the Target HNB the Source HNB may decide to send an RNA:CONNECT message (or an RNA:DIRECT TRANSFER message if already in SHO) containing an RNSAP:ENHANCED RELOCATION REQUEST message to the Target HNB to prepare the Target HNB for relocation.
2.	The Target HNB updates the transport network layer information for any RABs that are to be relocated to it by sending an HNBAP:TNL UPDATE REQUEST message to the HNB-GW, the HNB-GW responds with an HNBAP:TNL UPDATE RESPONSE.
3.	The Target HNB sends an RNA:DIRECT TRANSFER message containing an RNSAP:ENHANCED RELOCATION RESPONSE message back to the Source HNB to indicate that it has successfully prepared the relocation.
4.	The Source HNB sends an RNA:DIRECT TRANSFER message containing an RNSAP:RELOCATION COMMIT message, to commit the relocation preparation on the Target HNB. This message includes information to aid the relocation procedure, these are described in subclause 5.10.
5.	The Source HNB reconfigures the UE to commence the relocation procedure.
6.	At some point later Layer 1 synchronisation is achieved between the UE and the Target HNB. The UE then completes the RRC Reconfiguration procedure by sending an RRC:RADIO BEARER RECONFIGURATION COMPLETE message to the Target HNB.
7.	The Target HNB indicates to the HNB-GW that the UE has successfully relocated via the HNBAP:UE RELOCATION COMPLETE message. The HNB-GW also switches the U-plane to the Target HNB.
8.	The Target HNB initiates the RAB Release Request Procedure to the CN to release unaccepted RABs, if any, with an appropriate cause value.
9.	The HNB-GW sends the HNBAP:UE-DEREGISTER to the Source HNB indicating Successful RNSAP Relocation with an appropriate cause value.
10.	The Source HNB sends an RNA:DISCONNECT message  containing an RNSAP:ENHANCED RELOCATION SIGNALLING TRANSFER message to the Target HNB to transfer any L3 information that the Source HNB may have received during the relocation procedure and locally releases any resources it has for the UE.
NOTE:	If the involved HNBs are Iurh connected via the HNB-GW, the RNA messages are routed via the HNB-GW.",TS 25.467,5.7.2.1,all_images/image_6.jpeg,HNB to HNB Handover via Iurh interface – UE involved.
"Figure 5.7.3-1 below depicts Soft Handover Initiation in case HNBs are directly Iurh-connected. In case of Iurh-connectivity via the HNB-GW, RNA signalling terminates at the HNB-GW, whereas RNSAP signalling is still performed on a HNB-to-HNB basis.
Figure 5.7.3-1: Soft Handover Initiation HNB to HNB.
1.	The Serving HNB (SHNB) receives an RRC measurement report indicating that Soft handover is possible and the SHNB decides to setup a RL to the Drift HNB (DHNB).
2.	The SHNB evaluates the UE’s access rights against neighbour information available from the HNB Configuration Transfer function. If the UE has access rights for the DHNB, the SHNB may decide to setup a new RL and send an RNA:CONNECT message containing an RNSAP:RADIO LINK SETUP REQUEST message to the DHNB to set up a radio link at the DHNB.
3.	The DHNB starts receiving from the UE and sends an RNSAP: RADIO LINK SETUP RESPONSE message.
4.	When the radio link is established on the DHNB, the DHNB sends an RNSAP: RADIO LINK RESTORE INDICATION message.
5.	The SHNB sends an RRC Active Set Update to the UE
6.	The SHNB receives an RRC Active Set Update Complete from the UE.",TS 25.467,5.7.3,all_images/image_7.jpeg,Soft Handover Initiation HNB to HNB.
"The mobility procedure described in Figure 5.11.2.1-1 requires the HNB-GW to route the incoming Enhanced Relocation signalling from the Source HNB to the appropriate Target RNC indicated by an RNC-ID provided within the RNA:CONNECT message.
Figure 5.11.2.1-1: Enhanced Relocation from Open Access and Hybrid HNBs to RNC.
0-9.	The RNSAP signalling for preparing and executing the relocation between the HNB and the RNC follows the standardised Enhanced SRNS Relocation procedure as defined between two RNCs (see TS 23.060 [10]).
10-13. After the UE has completed RRC signalling for the relocation, the RANAP: ENHANCED RELOCATION COMPLETE REQUEST message is sent from the Target RNC to the MSC/SGSN. The MSC/SGSN replies with a RANAP: ENHANCED RELCOATION COMPLETE RESPONSE message. In case of CS domain, the target RNC sends RANAP Enhanced Relocation Complete Confirm message to the MSC after completion of UP initialization.
14-17. Subsequently the CN initiates Iu Release procedure to release the source-side Iu(h) resources.",TS 25.467,5.11.2.1,all_images/image_10.jpeg,Enhanced Relocation from Open Access and Hybrid HNBs to RNC.
"The mobility procedure described in Figure 5.11.2.2-1 requires the following:
-	The Source RNC is able to determine the target HNB and its Cell Access Mode based on UE measurements.
NOTE:	It is assumed that the source RNC has a priori knowledge whether the target cell is an open mode cell or not, e.g., via the PSC range configured for open cells in this part of the network
-	The HNB-GW is able to route the incoming Enhanced Relocation signalling from the Source RNC to the appropriate target HNB using the target cell identity provided in RNSAP: ENHANCED RELOCATION REQUEST.
Figure 5.11.2.2-1: Enhanced Relocation from RNC to Open Access HNB for CSG UEs.
0-9. The RNSAP signalling for preparing and executing the relocation between the RNC and the HNB follows the standardised Enhanced SRNS Relocation procedure as defined between two RNCs (see TS 23.060 [10]).
10-12.	After the UE has completed RRC signalling for the relocation, the RANAP: ENHANCED RELOCATION COMPLETE REQUEST message is sent from target HNB to HNB GW (via Iuh) and forwarded from HNB GW to MSC/SGSN (via Iu).
13-14.	After the reception of RANAP: ENHANCED RELOCATION COMPLETE REQUEST the MSC/SGSN replies with RANAP: ENHANCED RELOCATION COMPLETE RESPONSE. The HNB-GW forwards this message to the target HNB (via Iuh).
15-16. In case of CS domain, the target HNB sends RANAP Enhanced Relocation Complete Confirm message to the MSC after completion of UP initialization.
17-18.	The MSC/SGSN mandates the RNC to release the former Iu resources.",TS 25.467,5.11.2.2,all_images/image_11.jpeg,Enhanced Relocation from RNC to Open Access HNB for CSG UEs.
"The mobility procedure described in Figure 5.11.2.3-1 requires the following:
-	The UE is CSG capable from Rel-9 onwards and SIB-reading capable.
-	The Source RNC is able to determine the Cell Access Mode of the target HNB.
NOTE:	It is assumed that the source RNC is able to initiate and interpret respective UE measurements and may in addition have an a priori knowledge whether the target cell is a hybrid cell, e.g., via the PSC range configured for hybrid cells in this part of the network.
-	The HNB-GW is able to route the incoming Enhanced Relocation signalling from the Source RNC to the appropriate target HNB using the target cell identity provided in RNSAP: ENHANCED RELOCATION REQUEST.
Figure 5.11.2.3-1: Enhanced Relocation from RNC to Hybrid HNB for CSG UEs.
0-9. RNSAP Signalling for preparing and executing the relocation between the RNC and the HNB follows the currently standardised Enhanced SRNS Relocation procedure as defined between two RNCs (See TS 23.060 [10]).
10-11.	Upon successful relocation preparation and RRC signalling completion, the UE is temporarily admitted in the target hybrid cell according to the access status declared by the UE and provided by the Source RNC to the Target HNB within the CSG Membership Status IE included in the RNSAP: ENHANCED RELOCATION REQUEST message. The UE may be admitted as its reported CSG membership status until the outcomes of membership verification are received from CN.
12-13.	The RANAP: ENHANCED RELOCATION COMPLETE REQUEST message is sent from target HNB to HNB GW (via Iuh) and forwarded from HNB GW to MSC/SGSN (via Iu). The RANAP: ENHANCED RELOCATION COMPLETE REQUEST includes CSG ID IE and Cell Access Mode IE of the target cell.
14-16.	After reception of RANAP: ENHANCED RELOCATION COMPLETE REQUEST the MSC/SGSN performs membership verification of the relocated UE according to CSG ID IE and Cell Access Mode IE received. The MSC/SGSN replies to the HNB GW with RANAP: ENHANCED RELOCATION COMPLETE RESPONSE containing the CSG Membership Status IE. The RANAP: ENHANCED RELOCATION COMPLETE RESPONSE message is forwarded from HNB GW to target HNB (via Iuh). The target HNB may apply the appropriate level of prioritisation to the UE according to the CSG Membership Status IE received.
17-18.	In case of CS domain, the target HNB sends RANAP Enhanced Relocation Complete Confirm message to the MSC after completion of UP initialization.
19-20. The MSC/SGSN requests the RNC to release the source-side Iu resources.",TS 25.467,5.11.2.3,all_images/image_12.png,Enhanced Relocation from RNC to Hybrid HNB for CSG UEs.
"Mobility from HNB cells (hybrid or open access) to macro RNC using Soft Handover (SHO) follows the same principles as mobility between macro cells and uses an Iur interface established between HNB and macro RNC via the HNB-GW to support RNSAP signalling.
The HNB-GW acts as a single RNC towards the macro RNC (as it does towards the CN) and therefore acts as a concentrator for HNB-RNC connectivity via the HNB-GW.
For this case there is no involvement of the CN in the SHO operations, as there is no access control/membership verification needed for SHO to a macro RNC.
The HNB acts as a SRNC and requests resources from the macro RNC, however this may happen only in case of HNBs deployed in a secure and operator controlled way (coordinated deployment) and, in this case, it is managed by the CAC of the DRNC.
Figure 5.11.3.1-1 shows the sequence of messages involved.
Figure 5.11.3.1-1: Soft Handover HNB to RNC via HNB-GW.
1.	HNB determines that a RL can be established to a macro RNC cell.
2-7. Normal RL setup procedure between HNB and RNC via the HNB-GW.",TS 25.467,5.11.3.1,all_images/image_13.jpeg,Soft Handover HNB to RNC via HNB-GW.
"Mobility from macro cells to Open or Hybrid Access HNB cells using Soft Handover follows the same principles as mobility between macro cells and uses an Iur interface established between the HNB and the macro RNC via the HNB-GW to support RNSAP signalling.
The HNB-GW acts as a single RNC towards the macro RNC (as it does towards the CN) and therefore acts as a concentrator for HNB-RNC connectivity via the HNB-GW.
For this case of open or hybrid access HNB, there is no involvement of the CN in the SHO operations. For the case of SHO to hybrid access HNB, if supported, the Radio Link is established assuming the UE is non-member.
The macro RNC acting as SRNC requests resources from the HNB, it is managed by the CAC of the HNB.
Figure 5.11.3.2-1 shows the sequence of messages involved.
Figure 5.11.3.2-1: Soft Handover from RNC to Open or Hybrid Access HNB via HNB-GW.
1.	RNC determines that a RL can be established to a HNB cell.
2-7. Normal RL setup procedure between RNC and HNB via the HNB-GW. For Hybrid cells, if supported, the Radio Link is established assuming the UE is a non-member.",TS 25.467,5.11.3.2,all_images/image_14.jpeg,Soft Handover from RNC to Open or Hybrid Access HNB via HNB-GW.
"The CELL_FACH, CELL_PCH and URA_PCH mobility message flow is described in Figure 5.11.5-1 below.
Figure 5.11.5-1: RNC to HNB CELL_FACH/CELL_PCH and URA_PCH mobility
1.	At initial RRC Connection Setup, the source HNB assigns to the UE a U-RNTI based on its RNC-ID and a set of locally defined bits.
2.	Subsequently, the UE performs Cell or URA Reselection to a HNB supporting CELL_FACH/CELL_PCH/URA_PCH.
3.	Based on the received U-RNTI, the target HNB detects the UE is reselecting from a neighbour RNC.
If, based on the received U-RNTI, the Target HNB cannot detect from which node the UE is coming from,
3a.	it may establish an Iurh interface with the source RNC;
3b.alternatively, it may terminate the mobility procedure, re-establish the RRC connection for the UE and skip the subsequent steps.
4.	The HNB forwards the received message Cell/URA update via Uplink Signalling Transfer Indication RNSAP message to the selected HNB-GW.
5.	The HNB-GW finds the proper source RNC based on the RNC-ID.
6.	The HNB-GW forwards the RNSAP Uplink Signalling Transfer Indication message to the source RNC.
7.	The source RNC may now execute the SRNS Relocation/Enhanced SRNS Relocation towards the target HNB to  transfer the UE context or initialise the UE context in the target HNB via RNSAP Common Transport Channel Resources Initialisation procedure.
8.	The HNB sends to the UE an RRC: Cell Update Confirm message (in case of CELL_FACH or CELL_PCH) or an RRC: URA Update Confirm message (in case of URA_PCH) to terminate the mobility procedure. If the SRNS relocation procedure is not used, the RRC: Cell Update Confirm (in case of CELL_FACH or CELL_PCH) or the RRC: URA Update Confirm message (in case of URA_PCH) is sent by the serving HNB.",TS 25.467,5.11.5,all_images/image_16.jpeg,RNC to HNB CELL_FACH/CELL_PCH and URA_PCH mobility
"Figure 7.2.2.2-1: Establishment of signalling connection over Iupc and Iuh connections between HNB and SAS via HNB-GW – HNB Initiated.
1.	If the Source HNB is configured for Iupc-connectivity via the HNB-GW, and wants to send a PCAP message to the SAS for which a signalling connection over the Iuh and Iupc connections has to be established, it issues a PUA:CONNECT message containing the PUA Context Id and the PCAP PDU1.
2.	The HNB-GW identifies the signalling interface to which the PCAP message shall be routed to and maintains a mapping between the PUA-based signalling connection and the SCCP-based signalling connection for the HNB-SAS end-to-end. If the SAS indicator is included in the PUA: Connect message the HNB-GW may use this to route the PCAP message to the selected SAS.
3.	The HNB-GW sends PCAP PDU1 to the SAS and the SAS sends back PCAP PDU2 (see TS 25.450 [37]).
4.	The HNB-GW routes the PCAP PDU2 towards the Source HNB.
5.	The HNB-GW sends a PUA:Direct Transfer message, including PCAP PDU2 if any, received from the SAS to the source HNB.",TS 25.467,7.2.2.2,all_images/image_18.png,Establishment of signalling connection over Iupc and Iuh connections between HNB
"Figure 7.2.2.3-1: Establishment of signalling connection over Iuh and Iupc connections between HNB and SAS via HNB-GW – HNB Initiated with refusal from SAS.
1.	If the Source HNB is configured for Iupc-connectivity via the HNB-GW, and wants to send a PCAP message to the SAS for which a signalling connection over the Iuh and Iupc connections has to be established, it issues a PUA:CONNECT message containing the PUA Context Id and the PCAP PDU1.
2.	The HNB-GW identifies the signalling interface to which the PCAP message shall be routed to and maintains a mapping between the PUA-based signalling connection and the SCCP-based signalling connection for the HNB-SAS end-to-end. If the SAS indicator is included in the PUA: Connect message the HNB-GW may use this to route the PCAP message to the selected SAS.
3.	The HNB-GW sends PCAP PDU1 to the SAS as received from the HNB via SCCP Connection Request  and the SAS refuses the connection request (see TS 25.450 [37]).
4.	The HNB-GW maps the SCCP:CREF message into a PUA:DISCONNECT.
5.	The HNB-GW sends a PUA:DISCONNECT message to the source HNB, including the optional PCAP PDU2 if received from the SAS.",TS 25.467,7.2.2.3,all_images/image_19.png,Establishment of signalling connection over Iuh and Iupc connections between HNB
"Figure 7.2.2.4.1-1: Transport of PCAP messages via signalling connection over Iuh and Iupc connections – HNB initiated.
If the Source HNB wants to send a PCAP message to the SAS for which a connection oriented data transfer service is already established for a location session, it issues a PUA:DIRECT TRANSFER message towards the HNB-GW which contains the PUA Context Id and the PCAP PDU.
The HNB-GW will forward the PCAP PDU to the SAS within an SCCP message.",TS 25.467,7.2.2.4.1,all_images/image_20.jpeg,Transport of PCAP messages via signalling connection over Iuh and Iupc
"Figure 7.2.2.5-1: Release of established signalling connection over Iupc and Iuh connections – HNB initiated.
If an HNB wants to release a signalling connection previously established over Iupc and Iuh connections towards a SAS, it sends a PUA:DISCONNECT message, which includes the PUA Context Id and may include a PCAP PDU. The HNB-GW maps the PUA:DISCONNECT message to an SCCP:Release message and triggers the SCCP connection release procedure defined in TS 25.450 [37] for the coresponding SCPP connection.",TS 25.467,7.2.2.5,all_images/image_22.png,Release of established signalling connection over Iupc and Iuh connections – HNB
"Figure 7.2.2.6.2-1: Connectionless data transfer over Iupc and Iuh connections – SAS initiated.
If the SAS sends a PCAP PDU to the HNB-GW for the Receiving HNB, the HNB-GW has to be able to route the message to the correct HNB. The HNB-GW uses the PCAP transaction ID to determine the correct destination HNB.  Then the HNB-GW issues a PUA:CONNECTIONLESS TRANSFER message containing the PCAP PDU.",TS 25.467,7.2.2.6.2,all_images/image_24.jpeg,Connectionless data transfer over Iupc and Iuh connections – SAS initiated.
"Figure 7.3.2.2.1-1: Signalling Connection Establishment – Direct Iurh-connectivity.
If the Sending HNB wants to send an RNSAP message to the Receiving HNB for which a dedicated Iurh signalling connection has to be established, it issues an RNA:CONNECT message containing the Iurh Context Id, the RNSAP PDU, the Senders HNB RNL Identity and the Receivers HNB RNL Identity. The Reception of the RNA:CONNECT message at the Receiving HNB completes the signalling connection establishment.",TS 25.467,7.3.2.2.1,all_images/image_26.jpeg,Signalling Connection Establishment – Direct Iurh-connectivity.
"Figure 7.3.3.2.1-1: Establishment of signalling connection over Iurh and Iur connections between HNB and RNC via HNB-GW – HNB Initiated.
1.	If the Source HNB is configured for Iurh-connectivity via the HNB-GW, and wants to send an RNSAP message to the Target RNC for which signalling connection over Iurh and Iur connections has to be established, it issues an RNA:CONNECT message containing the Iurh Context Id, the RNSAP PDU1, the Source HNB RNL Identity and the Target RNC RNL Identity.
2.	The HNB-GW identifies the signalling interface to which the RNA message shall be routed by the Target RNC’s RNL Identity as received from the Source HNB and maintains a mapping between the RNA-based signalling connection and the SCCP-based signalling connection for the HNB-RNC end-to-end.
3.	The HNB-GW sends RNSAP PDU1 to the Target RNC and the Target RNC sends back RNSAP PDU2 (see TS 25.420 [31] subclause 4.5.1.3).
4.	The HNB-GW routes the RNSAP PDU2 towards the Source HNB.
5.	The HNB-GW sends an RNA:Direct Transfer message, including RNSAP PDU2 received from the Target RNC.",TS 25.467,7.3.3.2.1,all_images/image_27.png,Establishment of signalling connection over Iurh and Iur connections between
"Figure 7.3.3.3.1-1: Transport of RNSAP messages via signalling connection over Iurh and Iur connections – HNB initiated.
If the Sending HNB wants to send an RNSAP message to the Receiving RNC for which a connection oriented data transfer service is already established, it issues an RNA:DIRECT TRANSFER message towards the HNB-GW which contains the Iurh Context Id, the RNSAP PDU and the Receivers HNB RNL Identity.
The HNB-GW will forward the RNSAP PDU to the Receiving RNC within an SCCP message.",TS 25.467,7.3.3.3.1,all_images/image_30.jpeg,Transport of RNSAP messages via signalling connection over Iurh and Iur
"Figure 7.3.3.4.1-1: Release of established signalling connection over Iurh and Iur connections – HNB initiated.
If an HNB wants to release a signalling connection previously established over Iurh and Iur connections previously established towards an RNC, it sends an RNA:DISCONNECT message, which includes the Iurh Context Id and the Receivers HNB RNL Identity (i.e., the Global RNC Id) and may include an RNSAP PDU. The HNB-GW maps the RNA:DISCONNECT message to an SCCP:Released message and triggers the SCCP connection release procedure defined in TS 25.420 [31] subclause 4.5.1.4.",TS 25.467,7.3.3.4.1,all_images/image_32.jpeg,Release of established signalling connection over Iurh and Iur connections – HNB
"Figure 7.3.3.5.1-1: Connectionless data transfer over Iurh and Iur connections – HNB initiated.
If the Sending HNB wants to send in a connectionless manner an RNSAP PDU to the HNB-GW for the Receiving RNC, it issues an RNA:CONNECTIONLESS TRANSFER message containing the RNSAP PDU, the Senders and the Receivers HNB RNL Identities.
The HNB-GW then generates and routes the RNSAP PDU within an SCCP message towards the Receiving RNC.",TS 25.467,7.3.3.5.1,all_images/image_34.jpeg,Connectionless data transfer over Iurh and Iur connections – HNB initiated.
"The performance of using dynamic control of the receiver gain or UL attenuation can be obtained using the following analysis setup. The general set up for the uplink analysis is given in Figure 7.3.3.1-1. The cell edge case is considered first, where a HNB is deployed at the edge of a macro cell and it has an active HUE associated with it. There is also a MUE which is located close to the HNB. The HNB, HUE and the MUE are assumed to have 140dB PL with the MNB (X=140dB). The HUE and the MUE are assumed to be separated from the HNB by Y and Z dB PL, respectively.
Figure 7.3.3.1-1: UL Interference Analysis Setup
The PL values of interest (i.e., Y and Z) depend on the HNB coverage determined by the tx power chosen. Three deployment scenarios are considered: a) HNB with 70dB coverage radius, b) HNB with 80dB coverage radius, and c) HNB with 90dB coverage radius. Both cell edge and cell site scenarios are analyzed. The performance analysis for the cell edge and cell site scenarios demonstrate the need for an adaptive algorithm that adjusts the UL attenuation / padding based on the out-of-cell interference experienced at the HNB.",TR 25.967,7.3.3.1,all_images/image_36.jpeg,UL cell edge scenario: noise rise contribution of non-associated UEs
"The performance of using dynamic control of the receiver gain or UL attenuation can be obtained using the following analysis setup. The general set up for the uplink analysis is given in Figure 7.3.3.1-1. The cell edge case is considered first, where a HNB is deployed at the edge of a macro cell and it has an active HUE associated with it. There is also a MUE which is located close to the HNB. The HNB, HUE and the MUE are assumed to have 140dB PL with the MNB (X=140dB). The HUE and the MUE are assumed to be separated from the HNB by Y and Z dB PL, respectively.
Figure 7.3.3.1-1: UL Interference Analysis Setup
The PL values of interest (i.e., Y and Z) depend on the HNB coverage determined by the tx power chosen. Three deployment scenarios are considered: a) HNB with 70dB coverage radius, b) HNB with 80dB coverage radius, and c) HNB with 90dB coverage radius. Both cell edge and cell site scenarios are analyzed. The performance analysis for the cell edge and cell site scenarios demonstrate the need for an adaptive algorithm that adjusts the UL attenuation / padding based on the out-of-cell interference experienced at the HNB.",TR 25.967,7.3.3.1,all_images/image_37.jpeg,UL cell edge scenario: Ec/No at serving NB
"The performance of using dynamic control of the receiver gain or UL attenuation can be obtained using the following analysis setup. The general set up for the uplink analysis is given in Figure 7.3.3.1-1. The cell edge case is considered first, where a HNB is deployed at the edge of a macro cell and it has an active HUE associated with it. There is also a MUE which is located close to the HNB. The HNB, HUE and the MUE are assumed to have 140dB PL with the MNB (X=140dB). The HUE and the MUE are assumed to be separated from the HNB by Y and Z dB PL, respectively.
Figure 7.3.3.1-1: UL Interference Analysis Setup
The PL values of interest (i.e., Y and Z) depend on the HNB coverage determined by the tx power chosen. Three deployment scenarios are considered: a) HNB with 70dB coverage radius, b) HNB with 80dB coverage radius, and c) HNB with 90dB coverage radius. Both cell edge and cell site scenarios are analyzed. The performance analysis for the cell edge and cell site scenarios demonstrate the need for an adaptive algorithm that adjusts the UL attenuation / padding based on the out-of-cell interference experienced at the HNB.",TR 25.967,7.3.3.1,all_images/image_38.jpeg,UL cell site scenario: noise rise contribution of non-associated UEs
"The performance of using dynamic control of the receiver gain or UL attenuation can be obtained using the following analysis setup. The general set up for the uplink analysis is given in Figure 7.3.3.1-1. The cell edge case is considered first, where a HNB is deployed at the edge of a macro cell and it has an active HUE associated with it. There is also a MUE which is located close to the HNB. The HNB, HUE and the MUE are assumed to have 140dB PL with the MNB (X=140dB). The HUE and the MUE are assumed to be separated from the HNB by Y and Z dB PL, respectively.
Figure 7.3.3.1-1: UL Interference Analysis Setup
The PL values of interest (i.e., Y and Z) depend on the HNB coverage determined by the tx power chosen. Three deployment scenarios are considered: a) HNB with 70dB coverage radius, b) HNB with 80dB coverage radius, and c) HNB with 90dB coverage radius. Both cell edge and cell site scenarios are analyzed. The performance analysis for the cell edge and cell site scenarios demonstrate the need for an adaptive algorithm that adjusts the UL attenuation / padding based on the out-of-cell interference experienced at the HNB.",TR 25.967,7.3.3.1,all_images/image_39.jpeg,UL cell site scenario: Ec/No at serving NB
"Figure 4.1-1: Interaction between RNC and O&M due to ANR
The ANR function resides in the RNC and is composed of the Neighbour Relation Table (NRT) Management Function, Neighbour Detection Function and Neighbour Removal Function.
The Neighbour Detection Function detects new neighbours and adds them to the NRT. The Neighbour Removal Function removes outdated NRs.
A Neighbour cell Relation (NR) between a Base UTRAN Cell and a Neighbour Cell exists if the RNC controlling the Base UTRAN Cell:
a)	Knows the following Neighbour Cell information:
-	Neighbour cell is in UTRAN: PLMN-Id, Cell Identifier(C-ID), RNC-ID/Extended RNC-ID,
-	Neighbour cell is in LTE: ECGI (PLMN Id + Cell Identity)
-	Neighbour cell is in GSM/GERAN: PLMN Id, LAC, CI, BSIC
b)	Has an entry in the Neighbour Relation Table for the Base UTRAN Cell identifying the neighbour cell.
c)	Has all required attributes defined in the Neighbour Relation Table entry or set to default values. Among these attributes are the frequency information (UARFCN, BCCH ARFCN, EARFCN) and handover routing parameters not already considered in (a):
-	Neighbour cell is in UTRAN: LAC and RAC
-	Neighbour cell is in LTE: TAI
For each NR, the NRT contains the Neighbour Cell Identifier (NCI), which identifies the neighbour cells. A neighbour cell may be a UTRAN, LTE or GSM cell. Furthermore, each NR has two attributes, the No Remove and the No HO attributes. These attributes have the following definitions:
-	No Remove: If checked, the RNC shall not remove the Neighbour cell Relation from the NRT.
-	No HO: If checked, the Neighbour cell Relation shall not be used as a neighbour cell by Intra RNS, Inter RNS or Inter RAT mobility functions in UTRAN.
The ANR function also allows O&M to manage the NRT. O&M can add and delete NRs. It can also change the attributes of the NR. The O&M system is informed about changes in the NRT.",TS 25.484,4.1,all_images/image_40.png,Interaction between RNC and O&M due to ANR
"ANR logging is configured with Logged Measurements Configuration procedure, as shown in Figure 5.3-1.
Figure 5.3-1: ANR Logging configuration with Logging measurement configuration message
UTRAN initiates the ANR logging procedure to UE by sending ANR logging configuration in the Logging measurement configuration message as defined in TS 25.331.",TS 25.484,5.3,all_images/image_41.jpeg,ANR Logging configuration with Logging measurement configuration message
"Figure 3.5.7-1 is an example of a TE-TA-ME setup when messages are sent to network or stored to ME. The volatile memory may as well be in the ME, or a non-volatile memory may be used instead when constructing messages.
Figure 3.5.7-1: Message service send and write procedures
An example of sending a GSM 7 bit default alphabet message in text mode and a SMS-STATUS-REPORT is wanted:
AT+CNMI?			(check that status reports are routed to TE)
+CNMI: 2,1,0,1,0
OK
AT+CSMP=49,167,0,0		(status report wanted; otherwise default settings)
OK
AT+CMGS=""+358501234567""	(start editing a message)
> This the first line.	(edit first line and press carriage return)
> This is the last line.^Z	(edit second line and send message by pressing control-Z)
+CMGS: 10			(success: message reference 10 returned from SMSC)
OK
+CDS: 2,10,""+358501234567"",145,""95/07/04/13:12:14+04"",
""95/07/04/13:12:20+04"",0	(status report of successful message delivery received)
Storing an unsent message in memory, sending it from there, and deleting it:
AT+CPMS?			(check memory settings)
+CPMS: ""ME"",4,10,""ME"",4,10,""ME"",4,10
OK
AT+CMGW=""9501231234""	(write message)
> This is the message body^Z
+CMGW: 7			(index number in storage returned)
OK
AT+CMSS=7			(send from storage)
+CMSS: 12			(success: reference value 12 sent from SC)
OK
AT+CMGD=7			(delete message)
OK",TS 27.005,3.5.7,all_images/image_44.jpeg,Message service send and write procedures
"If a UICC connected to an MT uses USIM Application Toolkit (USAT), some USAT features can be provided by the MT itself, whereas other features can be implemented in the TE. This applies especially to MTs with limited capabilities, where the user interface could be provided by the TE.
If there are multiple entities inside the TE providing USAT services, for the purpose of this specification, the TE is visible as one entity handling AT commands and responses on the interface to the TA/MT, see figure 12.1-1.
Figure 12.1-1: Overview of the interfaces between TE, TA/MT and UICC for USAT
The AT commands for definition of the USAT profiles and transmission of USAT proactive commands, USAT terminal responses and USAT envelope commands between the TE and UICC are specified in the subsequent clauses.
Compared to APDUs, where the MT is the initiator, USAT defines logic where the UICC is the initiator of the USAT proactive commands and the MT sends responses to these commands. Due to that, USAT proactive commands are sent in unsolicited result codes, whereas the associated responses are transported in subsequent AT commands.",TS 27.007,12.1,all_images/image_45.png,"Overview of the interfaces between TE, TA/MT and UICC for USAT"
"13.000 Containers are on a ship and later on on the dock of the container terminal. In each container, the UE collects the data from both embedded sensors and remote sensors and aggregates it in packets to be forwarded.
On a cargo vessel, one of the main challenges is that the containers are stocked together in large populations concentrated in limited spaces in very high density and arranged in stacks and about half of the containers are stowed under-deck where the space available for the propagation of the signals is significantly reduced. In addition, during the navigation the ship hold is isolated by a steel hatch cover which strongly limits the propagation of signals inwards and outwards. Moreover, harsh weather conditions can also degrade the performances of radio communications. Therefore, the communication is reduced and not all containers are able to communicate with the cellular network. Overall, the position of a container will vary from travel to travel. In one travel it will be in bad condition to be able to communicate while the next travel it could be in a better situation.
Furthermore, when the ship arrives to port, these containers plus the one already in the port will compete for the same radio frequencies creating a non-desirable temporary overload. Therefore, it is more appropriate to adopt efficient strategies to manage and distribute the traffic load in this context.
To avoid this situation and to be able to communicate their data, the UE of the containers which cannot connect directly to the network are identifying and using others containers’ UE which are better situated as relays thought with single hop or multi-hops to communicate their data depending on their battery usage.
An UE can be identified by several UEs as being able to communicate with the WAN (terrestrial or satellite) and to ultimately route their data. This chain of relays and group of UEs is forming a dynamic and temporary “virtual cluster” where the UE in charge of relaying the data of the other UEs becomes the head of this cluster. In an area with many containers, several virtual clusters can be formed and only the head of the cluster is communicating with the WAN as illustrated by Figure 5.2.3-1 and Figure 5.2.3-3. All UEs are able to be used as relay. UEs can “join” this virtual cluster as long as they are given permission. They can also “leave” the cluster when selecting another UE to route their data.
Figure 5.2.3-1: Communication clusters between containers
In a typical case and as average, a chain of relays is likely to be formed of 2 to 3 hops but in case of very dense area of containers stacked combined with very harsh environment, a chain of 9 hops is foreseen as to be the upper maximum to be supported.
To be able to identify the UE relaying the data and to create these virtual clusters, all UE needs to be able to listen the other UEs in a very low power mode. To be viable, the listening mode should not exceed more than 1% per year of the initial battery capacity of the UE. Typically for a 3,6 V battery with a nominal capacity of 12 Ah, it will represent less than 50 µJ / second.  This should be considered as the maximum usage to be able to have business model viable for the industry.
The UE in charge of the virtual cluster aggregates all data from its members and sends it.
By doing such a scheme, the battery of each UE is optimized at maximum.
In the case of a gateway is present (either on a ship or in shore in the port/terminal), the gateway is in charge of the cluster and is the ultimate relay to the 5G WAN access network as illustrated by Figure 5.2.3-2.
A cluster formed only by UEs shall be limited in term of capacity to remain efficient. It is foreseen that such cluster should be formed of maximum 4.000 UEs while a cluster managed by a gateway shall be able to support as much as 50.000 UEs.
Figure 5.2.3-2: Communications between containers in a ship
All the communications need to be secured and only UE of containers that are allowed to communicate between them and gateways recognised can be used in a cluster and as relay.
Figure 5.2.3-3: Different communication clusters of containers in a container terminal",TR 22.866,5.2.3,all_images/image_47.png,Communications between containers in a ship
"Each wagon to be tracked is equipped with a battery-powered IoT type UE including a 5G communication module. Depending on its content and its purpose (nature of the goods transported), the wagon is including different sensors and is able to detect critical events (physical shocks, vibrations, temperature, dislocation…) as illustrated in figure 4.
Figure 5.3.2-1: Different sensors managed in a wagon
The battery-powered UE should be able to operate for a period of 20 years without large capacity battery packs and without being replaced during this period of time.
Depending on the service level required by the owner of the goods and the supply chain associated, the wagon sends regular status update (could vary between one every hour to twice a day – periodicity could even be set up to 10 min). The status update can be based on event (arrival on station for example). Additionally, based on non desired events such as shocks, the wagon can send an alarm to inform of the event. The conductor of the locomotive may need to be informed of such event to trigger right answer.
A locomotive can be equipped with a gateway including a 5G communications module that can communicate to satellite access networks.
The size of the data payload containing the status information related to a wagon can be up to 2500 Bytes. This size depends as well as the service level required by the carried goods (refrigerated vans with perishable goods for example are providing more data based on various additional sensors than a wagon for mineral transportation).
The 5G system is interfaced to an application server (e.g. Wagons Tracking Management System). The payload size and the periodicity by the application are defined according to the context expected.",TR 22.866,5.3.2,all_images/image_49.jpeg,Different sensors managed in a wagon
"Figure 5.5.3-1: Illustration of service flow for elderly healthcare use case
1.	Sam is asked to wear 3 devices, one to measure his heart rate and respiratory rate, one to measure his SpO2 and a medicine administration device. Since the devices are in close proximity to each other, they will become part of a single group of which only one acts as the relay device for communicating with the 5G network, in order to increase the battery life over the group.
2.	The wearable device that acts as the relay device for the group uses low power transmission to reach a mobile device of one of the nursing staff members that acts as relay towards the 5G network. While Sam moves around to other locations in the elderly home, always the best relay node/path is selected automatically.
3.	After a few days, Sam’s condition is deteriorating. He faints. Luckily, the sensors are able to send their data/alarm information in very short amount of time through a communication path via multi-hop relay to the (mobile edge) cloud, and via the (mobile edge) cloud to the central patient monitoring system. An alarm indicating that Sam has fainted is shown on the central patient monitoring system screen(s) and a message that Sam is in trouble is sent to all the mobile devices carried by the nursing staff, which quickly come to aid Sam. They can easily locate Sam, since even though Sam’s devices were using multi-hop relay communication, the location of the UE can still be accurately determined (preferably with room level/floor level accuracy, if possible).",TR 22.866,5.5.3,all_images/image_52.jpeg,Illustration of service flow for elderly healthcare use case
"Figure 5.6.3-1: Illustration of service flow for connected ambulance use case
1.	After an accident in a public building, several people got injured, including Julia. When the first ambulance arrives, paramedics are directed into the building, towards Julia who needs care most urgently. Julia is lying deep inside the building, at a location where cellular coverage is insufficient to communicate with a nearby base station.
2.	The paramedics stabilize Julia and attach sensors to monitor her vital signs. The sensors activate and discover the paramedic phone/UE as a nearby relay. The paramedic’s phone uses the ambulance 5G UE as default relay, to guarantee the best connection to all services including voice communication and data collection servers in the hospital. If needed, the paramedic’s phone can also relay the communication via the phone of other first responders as additional intermediate relay device if the ambulance would not be reachable or if the quality/reliability of the connection is getting too low.
3.	Whilst Julia is being treated, the paramedic uses the voice communication connection that has been set up between the paramedic’s phone and the hospital via the ambulance’s 5G UE, in order to talk with a medical expert in the hospital. The medical expert proposes to perform an ultrasound. The paramedic takes the portable ultrasound device and initiate a connection it to the hospital by using the paramedic’s phone and the ambulance as relay. However, the resources that are requested by the ultrasound device for real-time streaming to the hospital are not available.
4.	Instead, with the voice assistance from the medical expert, the paramedic is able to record a short clip of the ultrasound scan, which is sent non real-time to the hospital. The expert analyses the ultrasound scan and sees that Julia can be moved, and should be transported right away to the hospital. In addition to sending the data to the hospital, the ultrasound device and the sensors report a copy of their data directly to the local storage for archiving and for use by the medical monitors inside the ambulance.
5.	The paramedics carry Julia to the ambulance. Once in the ambulance, the sensors attached to Julia switch to the ambulance as their default relay. Even when the ambulance loses its 5G connection when in a tunnel, the local functions still work real-time and seamlessly.
6.	During the drive to the hospital, the data collected from Julia is used by medical staff to plan her treatment and prepare staff & resources needed.
7.	When Julia is transported out of the ambulance and into the hospital, the sensors remain active and used. They automatically switch to another relay UE e.g. units in the hospital’s infrastructure.
8.	Julia is treated in the hospital. The data stored throughout the accident emergency response is used to decide on the optimal next steps in her treatment. At some point in time the sensors are returned to the ambulance to use for a next emergency.",TR 22.866,5.6.3,all_images/image_53.jpeg,Illustration of service flow for connected ambulance use case
"For containers stored in a port or in a ship, it is assumed that most of the containers will not be able to communicate with the network directly due to the harsh environment and several hops will be needed to reach efficiently the containers able to communicate with the network.
In the figure 6.4.2-1, containers A, B, C, D, E, F, G and J cannot use WAN directly while containers K, I and H are better positioned for WAN communication and can be used as ultimate relay to the network by the other containers. Containers C, D, F, G and J can be used as intermediate relay by A, B & E in multi hops
Figure 6.4.2-1: Communication between containers using multi Hop
In a typical case and as average, 2 to 3 hops are likely sufficient to provide a path to the network while in case of very dense area of containers stacked combined with very harsh environment, the use of 9 hops is foreseen as to be the upper maximum to be supported.
It is likely to have several relays able to communicate to the network and each of these ultimate relays could be used by several UEs which could be acting as well as intermediate relays. It is foreseen that to be efficient, a relay should have a capacity of relaying up to 4.000 UEs.
This will likely lead to the following topology.
Figure 6.4.2-2: Topology foreseen for container use case
The overall latency between the UE and the network using relay is not critical for this use case. A relay used for metering should support an operating range superior to 100 meter.
The largest container ships have a capacity of 22,000 TEU (twenty foot equivalent unit). As there generally is a mix of 40 ft and 20 ft containers, the number of containers is lower. We assume here 15,000 containers per ship (approximately equal numbers of 40 ft and 20 ft containers).
The assumption is that monitoring data is sent every 15 minutes. Every measurement generates a 100 bytes message and response.",TR 22.866,6.4.2,all_images/image_58.jpeg,Communication between containers using multi Hop
"One key issue of the integration of TSN and 5G wireless networks that has to be handled is mobility. The integration of 5G wireless communication into the industrial communication infrastructure allows for mobility in the manufacturing process. This mobility enhances flexibility in the manufacturing process, e.g. through adding certain manufacturing capabilities on-demand by having a machine move to the respective production line. This means that machines that are synchronized to different working clock domains may need to interact with each other.
Mobile machines/AGVs providing additional functionality or material for stationary production line
In a flexible manufacturing process, some specialized manufacturing capabilities are provided by mobile machines. The mobile machine has its own internal TSN network with its own working clock domain (restricted to the mobile machine). After the mobile machine has arrived at the intended location and is stationary again, the two interacting working clock domains of the stationary production line and the mobile machine have to be synchronized with each other. Otherwise interaction and collaboration might not be possible without interfering with ongoing operations. An example is an autonomous mobile handling robot adding parts to an assembly line. Without synchronization between both, correct placement of the parts would be impossible. Similarly, the working clock domains of AGVs providing material or work pieces to a production line need to be merged if they need to interact and to collaborate.
Cooperative work of mobile robots
In a future smart factory, otherwise independent mobile robots may gather in order to do a certain task together in a cooperative way, such as carrying a large or heavy work piece. In order to do such demanding cyber-physical control task, the mobile robots require synchronized clocks (time synchronization) between each other. They have to be in the same working clock domain. Each of the mobile robots has its own internal TSN network with its own working clock domain (restricted to the mobile robot) when it is on its own (i.e. not collaborating with any other mobile robot or machine). After the mobile robots have come together to do the cooperative task, the different interacting working clock domains of the mobile robots have to be synchronized with each other. Otherwise interaction and collaboration will not be possible.
However, it is not always desired that working clock domains are merged if the meet or get into range of each other. For instance, the working clock domains of an AGV and a production line have to stay separate if the AGV just pases the production line. Therefore, the interaction between different working clock domains requires a concept for controlling the merging and non-merging of different working clock domains.
Figure 5.4.1-1: Working clock domain interactions ""Merge"" and ""Separate""
When members of different working clock domains interact, there are two possible options (Figure 5.4.1-1). Which option is used depends on the manufacturing process, the cyber-physical control application and its requirements.
-	Merge: The working clock domains merge into one. This option can be used in applications where synchronization is critical, e.g. high precision robots interacting with each other.
-	Separate: The members of the different working clock domains interact while keeping their own separate time synchronizations. This option can be used in applications where synchronization is non-critical, e.g. an AGV collecting finished products from a production line.",TR 22.832,5.4.1,all_images/image_61.png,"Working clock domain interactions ""Merge"" and ""Separate"""
"There are many earthquakes in Japan and it is hardly possible to predict when and where earthquake happens, therefore the approach to increase installed capacity in all the areas that costs considerable much is impossible. In order to produce communication in congestion conditions in the earthquake, it is not only efficient from installed capacity aspect but also vital from service aspect to perform ""access control interval application"" that description below explains.
There is an area where access control is performed. In order to allow all the users in the area to setup calls, broadcasting access class numbers are changed at an interval of some seconds. For example, in an interval UEs with access class 0 can perform setup and UEs with access classes 1-9 cannot do setup, in another interval UEs with access class 1 can do setup and UEs with access classes 0, 2-9 cannot do setup.
Figure 4.3-1: Access control interval application
Due to access control interval application, the communication between the unauthorised users in the disaster areas is possible. The communication helps users in the emergency situation. Following are use cases.
-	A mother calls to her child to know where he/she is in the disaster areas.
-	A mother sends a message to her child to know where he/she is in the disaster areas.
Figure 4.3-2:  Use-case of the communication between the unauthorised users",TR 22.908,4.3,all_images/image_66.png, Use-case of the communication between the unauthorised users
"Regarding communications in the condition where the originating users are the authorised users and the terminating users in the disasters are not the authorised users as identified in the use cases in section 4.1, there is an issue that the authorised user cannot access to the unauthorised user in the condition that access class control barring is applied to the unauthorised users.
Regarding emergency service call back as identified in section 4.2, there is an issue that emergency service center cannot make callback to the users in the condition that access class control barring is applied to the users.
Regarding the communication using voice or messaging service between the unauthorised users in the area with access control interval application as identified in section 4.3, there is an issue that communication between UE with an access class number and UE with another access class number cannot be established.
Furthermore, it is a further consideration where the current access control mechanism prohibits any access attempts including call control and location registration.
As also described in section 4.3, it is hardly possible to predict when and where a disaster happens. Therefore it is important that a network has to maximize the efficiency of the limited network resources for provisioning of the communications. However, with current access control scheme,  even if messages establishing the multimedia telephony calls or messaging service are sent to the UEs that are access class barred, they are not allowed to respond to such messages, consequently resources for the paging messages get wasted. See Figure 5.1-1. Hence, it is a consideration where the multimedia telephony calls and messages to the users to whom access class control barring is applied to end up causing waste of network resources. The resource management efficiency with paging permission under the influence of access class barring is described in Annex X by comparing pattern 3 (i.e. with paging permission) with pattern 2 (i.e. without paging permission).
Figure 5.1-1: Waste of resources for the paging messages.",TR 22.908,5.1,all_images/image_68.png,Waste of resources for the paging messages.
".. Figure 5.10.3-1: Use case on ″Backup″ PLMNs for the international roamer. A UE roams to vPLMN-A, and accesses to services successfully, according to an international roaming agreement.. vPLMN-A cannot offer radio services when a disaster occurs.. All the users camped on vPLMN-A have no service due to the disaster.. The UE previously registered with vPLMN-A attempts to access vPLMN-2.. Normally the UE would not select vPLMN2 (for whatever reason.). However, since the Disaster Condition applies, the ″Backup″ Agreement will be used.. vPLMN-2 authenticates the international roamers with hPLMN1 using the Backup Agreement.. vPLMN-2 accepts the UE as a Disaster Inbound Roamer.",TR 22.831,5.10.3,all_images/image_71.jpeg,Use case on ″Backup″ PLMNs for the international roamer
"Use cases under this modality take place e.g. into hybrid operating rooms. Hybrid operating rooms (OR) are in general equipped with advanced imaging systems such as e.g. fixed C-arms (x-ray generator and intensifiers), CT scans (Computer Tomography) and MRI scans (Magnetic Resonance Imaging). The whole idea is that advanced imaging enables minimally-invasive surgery that is intended to be less traumatic for the patient as it minimizes incisions and allows to perform surgery procedure through one or several small cuts. This is as an example useful for cardio-vascular surgery or neurosurgery to place deep brain stimulation electrodes.. Due to its many benefits for the patients, image guided surgery is now the main stream for many specialties from cardiology to gastroenterology or ophthalmology. This is the underlying force for a very dynamic market predicted to reach $4,163 million by 2025 and experiencing a sustained growth of 11.2% from 2018 to 2025 (see [6]).. But, as of now, a lack of real interfaces between technologies and devices inside operating rooms is putting progress at risk. In fact, devices and software must be able to work together to create a truly digitally integrated system in the operating room. Multiple vendors are proposing integrated OR proprietary solutions but they are often limited to their particular standpoint, depending on the category of equipment they usually provide: OR tables and lighting providers, anaesthesia and monitoring equipment, endoscopes or microscopes, medical imaging (X-Ray, ultrasounds), video monitors and streaming. No category dominates others with the capacity to impose a particular solution that could be adopted by all. This roadblock to full digitalization is addressed by standards like e.g. DICOM supplement 202: RTV which leverages on SMPTE (ST 2110 family of standards) to enable the deployment of equipment in a distributed way. The intention is to connect various video or multi-frame sources to various destinations, through a standard IP switch, instead of using a proprietary video switch. This is shown on the figure below (see [2]):. Figure 5.2.1.1-1: Overview diagram of an Operating Room (O.R.). Carriage of audio-visual signals in their digital form has historically been achieved using coaxial cables that interconnect equipment through Serial Digital Interface (SDI) ports. The SDI technology provides a reliable transport method to carry a multiplex of video, audio and metadata with strict timing relationships but as new image formats such as Ultra High Definition (UHD) get introduced, the corresponding SDI bit-rates increases way beyond 10Gb/s and the cost of equipment that need to be used at different points in a video system to embed, de-embed, process, condition, distribute, etc. the SDI signals becomes a major concern. The emergence of professional video over IP solutions, enabling high quality and very low latency performance, now calls for a reengineering of ORs, usually a long and costly process but that can be accelerated thanks to the adoption of wireless communications whose flexibility also reduces installation costs.. Witnessing the increasing interest of health industry actor in wireless technologies, [8] predicts that the global wireless health market is projected to grow from $39 Billion in 2015 to $110 Billion by 2020. More specifically, [7] points out the increasingly prevalence of wireless technology in hospital which has led to the vision of the connected hospital, a fully integrated hospital where caregivers use wireless medical equipment to provide the best quality of care to patients and automatically feed Electronic Health Records (EHR) systems. As a natural evolution, for wireless technologies that can cope with hospitals’ difficult RF environment and can provide needed security warranties, it is expected that they can be a promising opportunity enabling surgeons to benefit from advanced imaging/control systems directly in operating rooms while still keeping the flexibility of wireless connectivity. In practice, one can also expect the following benefits from going wireless in O.R.:. -	Equipment sharing between operating rooms in the same hospital which makes procedures planning easier and allows hospitals to deploy an efficient resource optimization strategy,. -	On-demand addition of complementary imaging equipment in case of incident during a surgery procedure which eventually leads to better care provided to patients,. -	Suppression of a range of cables connecting a multitude of medical devices, constituting as many obstacles, that makes the job of a surgical team easier and reduces the infection risk.. In addition, hybrid O.R. trend makes operating rooms increasingly congested and complex with a multitude (up to 100) of medical devices and monitors from different vendors. In addition to surgical tables, surgical lighting, and room lighting positioned throughout the OR, multiple surgical displays, communication system monitors, camera systems, image capturing devices, and medical printers are all quickly becoming associated with a modern OR. Installing a hybrid O.R. represents therefore a significant cost, not only coming from the advanced imaging systems themselves, but also from the complex cabling infrastructure and the multiple translation systems that are needed to make all those proprietary devices communicating together. Enabling wireless connectivity in O.R. simplifies the underlying infrastructure, helps streamlining the whole setup and reducing associated installation costs.",TR 22.826,5.2.1.1,all_images/image_73.png,Overview diagram of an Operating Room (O.R.)
"Robotic aided surgery is particularly suitable to invasive surgical procedures that require delicate tissue manipulation and access to areas with difficult exposure. It is achieved through complex systems that translate the surgeon’s hand movements into smaller, precise movements of tiny instruments that can generally bend and rotate far more than a human hand is capable of doing inside the patient’s body. In addition, those systems are usually able to filter out hand tremor and therefore allow more consistent outcomes for existing procedures, and more importantly the development of new procedures currently made impractical by the accuracy limits of unaided manipulation.. For example in abdominal surgery, surgeon’s movements are guided by a specific instrument called a laparoscope which is a thin tube with a tiny camera and light at the end that provides in some cases a 3D view of the patient’s body internals by sending potentially stereoscopic images to a suitable 3D rendering system at the control console and to 2D video monitors in the operating room.. In order to further improve precision, shorten learning curve and prevent extended operating times, surgeons need to get their human sense of touch back. For that purpose, the control console is fed with haptic feedback generated by the instruments to render the exact applied forces and tissue deflections resulting from the surgical procedure. In this context, the system creates a virtual operative space that mimics the feel of open surgery with artificial haptic forces related to the zones to avoid (veins, fragile tissues) or the target to reach where the zones to avoid have been defined during pre-operative 3D reconstruction of the patient body and fed to the robot.. Figure 5.2.4.1.1-1: Example of a surgery aiding robotic system. Typical surgery robotic systems can have around 40 actuators and the same number of sensors which allow to compute the data rate requires in each direction in order to execute a given movement.. Human sensitivity of touch is very high, tactile sensing has about 400 Hz bandwidth, where bandwidth refers to the frequency of which the stimuli can be sensed. This is why in general haptic feedback systems operate at frequencies around 1000 Hz. This rate naturally applies to the update of all information used in the generation of the haptic feedback, e.g. instruments velocity, position … Therefore, the robot control process involves:. The surgeon console periodically sending a set of points to actuators in 50 bytes messages. Actuators executing a given process. Sensors sampling velocity, forces, positions, … at the very same time and returning that information to the surgeon console, in 50 bytes messages at the rate of 1 kHz. As opposed to machine to machine communication, robotic aided surgery implies there is a human being in the middle of the control loop, which means that the console does not autonomously generate new commands based on the system state collected in the previous 1 kHz cycle but based on surgeon’s hand movement.. In order to improved surgeon’s spatial perception, it is expected that the endoscope can produce 8K stereoscopic uncompressed video, supports also HDR (High Dynamic Range) for larger colour gamut management (up to 10 bits per channel) as well as HFR (High Frame Rate), i.e.; up to 120 fps.. Of course, all messages exchanged have to be properly secured (especially in terms of data integrity and authenticity) and the probability of two consecutive packet errors shall be negligible.. The endoscope, the displays, the monitoring equipment and the robot’s sensors shall be synchronised on the same clock synchronisation service with a clock synchronicity in the order of 1µs to enable offline replay of the whole procedure. In particular, all sensors shall sample the system state at the same exact time and send it back to the control console in order to allow for a consistent haptic feedback generation.",TR 22.826,5.2.4.1.1,all_images/image_76.jpeg,Example of a surgery aiding robotic system
"Healthcare systems in developed countries currently face a strong trend towards concentration of care in large hospitals located in urban centers. This is on one hand due to efficiency/cost reasons and on the other hand due to a simple lack of skilled experts. Some studies even state that small rural clinics with very limited possibilities for examination or treatment might be dangerous for patients with serious diseases due to the lack of expertise. This concentration leads to huge travel efforts even in rather standard cases like aftercare examinations, screenings or medical check-ups. In addition to that, these large hospital centers today also have to provide care for emergency cases, which means that standard cases get lower priorities and thus, long waiting times are quite usual.. Many of the aftercare examinations, screenings or medical check-ups do not necessarily require an expert who is locally present during the exam if a broadband, low latency and high quality of service data link would be available. In this case video examinations based on high end camera and audio systems (even supported by haptic feedback if necessary), remote diagnosis of imaging data from ultrasound, X-ray, computed tomography or even magnetic resonance imaging could be conducted by a ""remote expert"". In order to provide such remote expert examinations, the following features need to be in place:. A mobile specialist practice which is located in a truck. It may contain. an examination room with high end video/audio equipment which can establish a broadband connection to an expert located in a remote location. optionally a set of medical imaging equipment like ultrasound, X-ray, CT or even MRI all capable of connecting to a dedicated 5G network and transmitting diagnostic data in real time to the remote expert. optionally mobile lab diagnostic equipment. Figure 5.3.4.1-1: 40 ft standard container with exemplary mobile specialist practice equipment. A country-wide network of dedicated non-public network (NPN) 5G access points owned by communities or other service providers, or a corresponding private slice. Once the mobile specialist practice arrives at the access point and checks in, the necessary network resources according to the examinations schedule are allocated.. Figure 5.3.4.1-2: Community owned NPN access points. An efficient scheduler to align all required resources:. Patient appointment. Allocation of necessary equipment (might be added on demand for non-common cases). Local staff, e.g. MTAs or paramedics. Remote specialist. Network resources (reserve links with appropriate bandwidth, latency and QoS for each planned examination). Depending on the availability of staff, specialists, equipment and network resources, more than one examination at a time could be scheduled.. Figure 5.3.4.1-3: Exemplary schedule, allocation of equipment and network resources is usually defined by type of examination. In order to make such a mobile specialist practice an efficient and accepted part of tomorrow’s healthcare system it is key that it is patient centered. That means that currently well-known nuisances like long waiting times for appointments, long waiting times due to inefficient planning or emergencies or non-ideal communication need to be avoided. Thus, one of the key features of such a mobile specialist practice is the scheduler which works in the background. A further very important factor is trust: it needs to be guaranteed, that the patient contacts as many virtual experts as necessary but as few as possible – the well-known annoying call-center situation with a new ""expert"" in every new call is a no go. It also needs to be ensured that the patient keeps informed about each step of the examination, that he gets information about the experts he is connected to and that the procedure ends with a satisfying outcome – either the patient is cured or a longterm treatment plan has been defined.",TR 22.826,5.3.4.1,all_images/image_77.jpeg,40 ft standard container with exemplary mobile specialist practice equipment
"In the field of data security, the following roles are often defined:. Controllers: natural or legal person that is responsible for handling the whole data life cycle and will have to establish or amend technical and organizational measures to ensure and prove that the processing of personal data fully complies with regulatory requirements. In practise, controllers can be e.g. hospitals, health houses or physicians…. Processors: natural or legal person that processes medical data. A processor is required to maintain records of all its processing activities and to maintain disclosure readiness of this information to show compliance. A processor could be for instance a cloud provider offering services to a controller for data storage and processing.. In the process of transporting medical data over a 5G network, in particular if the mobile operator is responsible for any key material that can be used to decrypt the medical data, or is otherwise involved in storing or adjusting the data, then this would involve assigning a processor role to telecom operators. Also, if the operator did not provide sufficient safeguards to protect data loss or if the operator lacks behind in fixing known security holes and vulnerabilities, they may be held accountable by health data controllers and processors.. Interactions between data subjects, regulators, controllers and processors are shown on the picture below:. Figure 6.2-1: Role model on personal data security. For more information on general data requirements from regulatory bodies, see Annex A.",TR 22.826,6.2,all_images/image_79.png,Role model on personal data security
"The conceptual model for shareable MCPTT UEs is that of a pool of UEs, each UE being interchangeable with any other, and users randomly choosing one or more UEs from the pool, each user for his temporary exclusive use. A shareable MCPTT UE can be used by user who can gain access to the MCPTT client application stored on it and can become an authenticated MCPTT User. A shareable MCPTT UE can serve only one MCPTT User at a time. An MCPTT User who signs into a shareable MCPTT UE that is already in-use causes the sign-off of the previous MCPTT User.
An MCPTT User can simultaneously have several active MCPTT UEs, which, from an MCPTT Service point of view, are addressable individually and/or collectively within the context of their association to the MCPTT User.
The conceptual model for a gateway UE is that of a UE capable of providing service to an MCPTT User employing a non-3GPP device. A gateway UE is usable simultaneously by multiple MCPTT Users. Unlike a shareable MCPTT UE, if a new person enters his valid credentials towards signing in the MCPTT Service, his successful signing in and becoming an MCPTT User does not affect the initial MCPTT Users already served by the gateway UE.
A gateway UE is typically installed in a vehicle (e.g., a police car, fire truck) and has wired and/or wireless connections to various devices in use by the MCPTT Users.
A gateway UE differs functionally from a ProSe relay node. In the ProSe paradigm, the relay node and the devices served by it are all (ProSe enabled) 3GPP UEs, and are ""visible"" to the 3GPP system as UEs. In the gateway UE paradigm, only the gateway UE is an 3GPP device and only it is ""visible"" at the 3GPP network layer.
Figure 4.5.4.1 shows schematically some of the relationships between MCPTT Users and MCPTT UEs.
Figure 4.5.4-1: Relationships between MCPTT Users and MCPTT UEs",TS 22.179,4.5.4,all_images/image_80.jpeg,Relationships between MCPTT Users and MCPTT UEs
"The present document is an 800 series Technical Report (TR) written by 3GPP TSG SA WG1 (SA1). Such a TR is not normative, i.e. cannot be used for implementation directly and cannot be referred to by other 3GPP specifications. It was primarily written by SA1 to summarise the high-level communication needs of the railway community and to identify the corresponding requirements, which, in another step have been introduced into normative Technical Specifications (TS) of 3GPP.
An 800 series TR will not be updated when in the process of introduction of the requirements to TS changes are made to those requirements, i.e. the text of the requirements listed here in this TR will not be aligned with the requirements in the TS. Due to the fact that most of the requirements identified in this document were introduced in already existing Mission Critical Communication (MCX) TS, an alignment with the MCX terminology and functionality was made resulting in most of the requirements in here being reworded in the TS. Also, TS requirements changes due to future work affecting requirements stemming from this TR will not result in updates of this TR.
However, the columns “Comments” of the requirements tables listed below were updated to indicate the disposition of the requirement in the TS and most of the time summarising deviations and decisions taken when introducing those requirement into normative TS. By following these references into the normative TS the functionality provided by 3GPP for railway communication can be derived by the reader.
FRMCS will adapt 3GPP transport to provide communication to railway users. It eventually will resemble GSM-R and will additionally provide communication capabilities beyond what GSM-R has been able to. It will provide higher data rates, lower data latencies, multimedia communication, and improved communication reliability. FRMCS considers end-to-end use cases and also provides requirements that might or might not be in scope of 3GPP existing specifications. To facilitate smooth migration from legacy communication systems (e.g. GSM) to FRMCS, interworking requirements between legacy communication systems and FRMCS are provided.
FRMCS Equipment shall connect to application domain through 3GPP radio access or other access. It provides emergency group communication, low latency and high reliable data and video service in high speed train environment. Amongst others it has the following important features:
-	Prioritized emergency group communication, train control data and video service
-	Seamless connectivity in high speed railway moving environments
-	Low latency and high reliable data and video service
-	Real time train monitoring and management for safe train operation
-	Reliable location tracking including in tunnel tracking
-	Legacy railway communication interworking to GSM-R system
Figure 4-1: High-level relation of FRMCS and legacy systems
Basically, railway communication services [5] can be categorized into
-	Train control services
-	Maintenance services
-	Railway specific services (such as Railway Emergency Call, functional addressing, and location-based addressing)
-	Other services (providing train crews or train Drivers with information of train operation and interworking with the existing railway communication systems)
This study categorizes all the use cases by considering inherent characteristics of railway applications. Specifically, the following categories of use cases are considered.
-	Basic functionality
-	Critical communication applications
-	Performance communication applications
-	Business communication applications
-	Critical support applications
-	Performance support applications
-	Business support applications
-	FRMCS System principles
The categories can be depicted conceptually as follows:
Figure 4-2: Grouping of FRMCS Applications",TR 22.889,4,all_images/image_82.jpeg,High-level relation of FRMCS and legacy systems
,TR 22.889,12.17,all_images/image_86.jpeg,FRMCS On-network and Off-network communication mode - Relay mode 1
"In the service requirements of Rel-16 ID_UAS, it is assumed that the UAS is operated by the human-operator using a UAV controller to control a paired UAV, in which both UAV and the UAV controller are connected using two individual connections via 3GPP network for commands and control (C2) communication.
However, the ID_UAS service in Rel-16 does not take into account the KPIs of the C2 communication.
First thing to consider for the UAS operation is the raised safety concerns, including the risk of mid-air collision with another UAV, the risk of loss of control of a UAV, the risk of intentional misuse of a UAV, and the risk of various UAS users, e.g. business, leisure, etc, sharing the airspace. Therefore, to avoid the safety risks, when considering 5G network as the transport network, it is important to provision UAS services by guaranteeing QoS for the C2 communication.
Figure 5.3.1-1 shows four C2 communication models in this use case.
Figure 5.3.1-1: Four C2 Communication Models (blue arrows show C2 communication links)
Model-A: Direct C2; the UAV controller and UAV establish a direct C2 link to communicate with each other and both are registered to the 5G network using the radio resource configured and scheduled provided by the 5G network for direct C2 communication.
Model-B: Network-Assisted C2; the UAV controller and UAV register and establish respective unicast C2 communication links to the 5G network and communicate with each other via 5G network. Also, both the UAV controller and UAV may be registered to the 5G network via different NG-RAN nodes. The 5G network needs to support mechanism to handle the reliable routing of C2 communication in any case.
Model-C: Network-Assisted Dual C2; following the Model-B Network-Assisted C2 model, in order to ensure the service availability and reliability of the C2 communication for UAS operation, especially when the UAV is flying beyond line of sight (BLOS) of the operator, redundant C2 communication link are supported for UAV.
Model-D: UTM-Navigated C2; the UAV has provided pre-scheduled flight plan for autonomous flying, however the UTM still maintain a C2 communication link with the UAV in order to monitor the UAV and navigate the UAV whenever necessary.
In general, Model-A, Model-B, and Model-C are for direct command and control to fly the UAV by the human-operator using a UAV controller. To avoid the risk for losing control of the UAV, it is critically important to ensure the 5G connectivity for C2 communication.
On the contrary, Model-D is for indirect command and control to fly the UAV using pre-schedule flying route provided by the UTM. In this case, the UTM needs to regularly monitor the flying status and provide updates to adjust the route if needed.
For reliability and service availability consideration, hybrid C2 models may also be applicable by combining any models with one as a backup C2 communication link.
-	For example, Model-A direct C2 can be used at first and then switch to the Model-B indirect C2 when the UAV is flying BLOS.
-	For example, the Model-C Network-Assisted dual C2 can be used when the Model-B indirect C2 communication is only available with weak connectivity, the 5G network can enable Model-C dual indirect C2 communication to ensure the reliability of the C2 communication.
-	For example, the Model-D UTM-navigated C2 can also be utilized whenever needed, e.g. for air traffic control, the UAV is approaching a No Drone Zone, and detected potential security threats, etc.
According to [6], based on the system architecture with ground radio station (GRS) to repeat the signals for the Remotely Piloted Air System (RPAS), the communication speed (in bps) requirements have been identified for the uplink and downlink C2 communication based on traffic types, e.g.
-	From RPAS to GRS (downlink): Telemetry (7595 bps), Navaid Display Data (1137 bps), ATC Voice (4800 bps), ATS Data (59 bps), Weather (27770 bps).
-	From GRS to RPAS (uplink): Telecommand (4563bps), Navigational Aid Setting (666 bps), Air Traffic Control-Voice (4800 bps), Air Traffic Control-Data (49 bps).
It has been shown that the requirement for the C2 communication would greatly depend on the required traffic types in UAS services for a UAV in the end-to-end communication path. Therefore, there are four service classes have been defined in [6] to support one to multiple traffic types.
Similarly, the bandwidth and latency KPIs for different traffic types can be considered for C2 communication via the 3GPP network as provided in Figure 5.3-1. In principle, the following traffic types need to be considered:
-	Command and Control: using C2 communication for delivering the instructions from the UAV controller/UTM to the UAV. The C2 communication of this type includes two different subclasses to reflect different distances between the UAV and the UAV controller/UTM, including visual line of sight (VLOS), and non-visual line of sight (Non-VLOS). The latency of this VLOS traffic type needs to consider instruction delivery time, human reaction time and assisted media, e.g. video streaming, delivery latency. As such, the sustainable latency for VLOS is shorter than that for Non-VLOS.
-	Telemetry C2: using C2 communication for the monitoring events reporting. The bandwidth and latency requirements are not critical.
-	Real-time C2: using C2 communication for telecommands, the required latency needs to consider end-to-end C2 communication path (both for uplink and downlink) as well as reaction time of the operator.
-	Video Streaming C2: using C2 communication for uploading live video stream from the UAV to the UTM in 3GPP network or UAV controller. In the latter case, the bandwidth and latency requirement need to be supported in both uplink and downlink for the end-to-end C2 communication path. Depending on the resolution of the video stream, the required bandwidths are different. However, the latency requirement is critical and needs to take into account human reaction delay if using Model-A/B/C.
-	Situation-Aware Report C2: using C2 communication for reporting configured monitoring events, e.g. for detected identifiable objects, and urgent event alarm due to detected unidentifiable objects/obstacles, e.g. birds, kites, aliens, UFO, etc. In later case, the video clips may be sent with the alarm.
Table 5.3.1-1 shows the KPIs for the considered use cases for C2 communication:
Furthermore, according to the type of the UAS services, some traffics may require higher priority in C2 communication for responding to the urgent events, e.g. sudden bird flocks are approaching, etc.",TR 22.829,5.3.1,all_images/image_90.jpeg,Four C2 Communication Models (blue arrows show C2 communication links)
"A wildlife conservation park deploys UAVs to monitor the trees, animal distribution, and activity. The operator has completed 5G coverage for the area. The park meets the following conditions:
Figure 5.4.2-1: Simultaneously support data transmission for UAVs and eMBB users
The park used for testing is a 10km x 20km area.
There are three base stations in the park, and 10 UAVs patrol once a day.
Each UAV has a cruising area of 20 square kilometres per day
In addition, there are staff and tourists in the park who use 5G mobile phones to work or visit. These workers or tourists use the base stations of the park together with the UAVs.",TR 22.829,5.4.2,all_images/image_91.jpeg,Simultaneously support data transmission for UAVs and eMBB users
"An AI system is deployed for UAV scenarios (such as oil pipeline patrol, UAV joint operations) to enable real-time UAV control. The network operators provide the coverage for the UAVs and the connections between UAVs and the AI system. AI system may be located in the UTM or another third-party devices which is out of the 3GPP system.
Figure 5.5.2-1: Use of autonomous UAVs controlled by AI system",TR 22.829,5.5.2,all_images/image_92.jpeg,Use of autonomous UAVs controlled by AI system
"Conventionally, antennas for cellular communication are mounted on high-rise cell towers and tilted toward a little bit downward direction. It is because humans are typically either on the ground or in a building.
Figure 5.8.1-1: Coverage provided by cell tower for typical users.
With introduction of communication service to UAVs, some UEs are located above conventional coverage. Thus, there is a need to adjust antenna system so that there is a coverage at the height where a UAV operates. In some cases, additional equipment can be installed. This is illustrated in the following figures.
Figure 5.8.1-2: Change of tilting to accommodate UAV.
Figure 5.8.1-3: Addition of equipment to accommodate UAV.
Thus, it is necessary to differentiate service offering to various UEs. In above scenario, where and what can be provided to UAV UEs is different from where and what can be provided for other non-UAV UEs.",TR 22.829,5.8.1,all_images/image_95.jpeg,Coverage provided by cell tower for typical users.
"Conventionally, antennas for cellular communication are mounted on high-rise cell towers and tilted toward a little bit downward direction. It is because humans are typically either on the ground or in a building.
Figure 5.8.1-1: Coverage provided by cell tower for typical users.
With introduction of communication service to UAVs, some UEs are located above conventional coverage. Thus, there is a need to adjust antenna system so that there is a coverage at the height where a UAV operates. In some cases, additional equipment can be installed. This is illustrated in the following figures.
Figure 5.8.1-2: Change of tilting to accommodate UAV.
Figure 5.8.1-3: Addition of equipment to accommodate UAV.
Thus, it is necessary to differentiate service offering to various UEs. In above scenario, where and what can be provided to UAV UEs is different from where and what can be provided for other non-UAV UEs.",TR 22.829,5.8.1,all_images/image_96.jpeg,Change of tilting to accommodate UAV.
"Figure 5.9.3-1: User path optimization of Data transmission path.
1. UAV A gets access to PLMN A and requests network resources with a certain KPI (e.g. requesting low latency).
2. PLMN A finds two possible traffic routes for the traffic to/from this UAV A.
3. the network calculates the end-to-end latency for each traffic path, according to the KPI requirement of the UAV A, the network decides to choose one traffic path with lower latency for this UAV A.
Traffic path optimization of remote control link
1. UAV B and controller get access to MNO network, and request to establish remote control link. UAV controllers may be independent, or in UAV server.
2. the network optimizes the transmission path of remote control link to minimize the latency.
Figure 5.9.3-2: User path optimization of remote control link.",TR 22.829,5.9.3,all_images/image_98.jpeg,User path optimization of Data transmission path.
"In a typical on-site live audio presentation situation, one or several persons (presenters) are holding a talk in front of an interested audience. Usually the audience interacts with the presenter/s, for instance by posing questions. Other scenarios include the moderation of corporate events, panel discussions or conferences.
On-site live audio presentation scenarios are typically confined to a local area, e.g. conference rooms, lecture halls, press centres and trade fairs. They can be located indoors or outdoors. Typical operation has a defined duration known in advance. Characteristic for this use case is that all production equipment is available at the location, the wireless communication service is limited to the local area and all audio processing such as audio mixing is done in real time.
Wireless microphones are used for capturing audio from presenters within the local service area. A number between 5 and 300 simultaneously active wireless microphones can be expected. These wireless microphones can be scattered into different rooms, stages or spaces within the same complex.
The captured audio signals are transmitted to a central audio mixing console. Each active wireless microphone produces an audio, which has a data rate dependent on the audio codec, and may vary between 50 kbit/s and 250 kbit/s, possibly higher, if uncompressed audio is required. In addition, control signals with a maximum of 50 kbit/s are transferred bidirectionally for management and remote-control purposes. The audio mixing console creates the new desired audio streams. These streams delivered to downstream equipment and applications, such as amplifiers and loudspeakers of a public-address system, streaming services for hearing impaired participants, translation services, recordings, etc.
The typical mouth-to-ear latency between the wireless microphone (analogue audio source) and the audio sink (e.g. loudspeaker, assistive listening device) is below 20 ms. For small scenarios where the distance between presenters and listeners is very short, the mouth-to-ear latency is below 5ms.
In a live scenario, where a PA is used, the mouth-to-ear latency related to the speaker must not exceed 20 ms, otherwise performance may be impaired. If part of the audience is very close to the speaker the direct audio signal will arrive earlier at the listener’s ear than the PA audio signal, which leads to an uncomfortable experience. Therefore, the system latency shall be below 10 ms for most of the cases, and below 5 ms for acoustically challenging surroundings.
The packet error ratio of the wireless transmission needs to be kept lower than 10-5 to assure that no audio dropouts or audible interference occur. A packet error ratio above 10-5 would likely lead to disturbance of the audience and degradation of the audio content at the very beginning of the production value chain.
Table 5.1.1-1 lists the system parameter and its value range for the on-site live audio presentation use case.
Table 5.1.1-1: System parameters for on-site live audio presentation use case",TR 22.827,5.1.1,all_images/image_103.jpeg,On site Live audio presentation network
"Figure 5.3.3-1: Example scenario for live production with integrated audience services
The service flows are shown for the actors: Paul, Ringo, Yoko, John, George: Individual members of the audience
Case 1: A listener wants to hear better audio quality stream
Paul is located at a good position to listen to the band playing on stage 1, but he wants to hear a 3D enhanced version using his mobile phone and high-quality headphones
If Paul doesn’t have the subscription of this NPN, he can quickly sign up this service online and receive the correct credential from the network.
Paul turns on the app, which gets connected to the audio distribution system using the audio distribution NPN
Paul gets the list of available channels and chooses to listen to stage 1 with enhanced 3D
The app starts playback through Paul’s headphones, which could have not enough acoustic insulation, and Paul listens to both the PA system and its own headphones
The time difference between Paul’s headphone sound and the sound coming from the PA system is small, and doesn’t result in noticeable audio artifacts like reverberation or echo effects
Case 2: A listener wants enhanced audio quality because he/she is between two stages
At the position Yoko is located, she can listen to both stages 1 and 2, but she really wants to hear stage 2.
If Yoko doesn’t have the subscription of this NPN, he can quickly sign up this service online and receive the correct credential from the network.
Yoko turns on the app, which gets connected to the audio distribution system using the distribution NPN.
Yoko gets the list of available channels and chooses to listen to stage 2.
The app starts playback through Yoko’s headphones, which could have not enough acoustic insulation, and Yoko listens to both the PA system and its own headphones.
The sound that comes from Yoko’s headphone is loud enough in order to mask the sound coming from the PA system of stage 1 and does not generate artifacts when combined with the sound that comes from the stage 2.
Case 3: A listener wants is located next to one stage, but it wants to listen another stage
At the position John is located, he can listen only the stage 2, but he really wants to hear stage 1 where his friend Paul is.
If John doesn’t have the subscription of this NPN, he can quickly sign up this service online and receive the correct credential from the network.
John turns on the app, which gets connected to the audio distribution system using the distribution NPN.
John gets the list of available channels and chooses to listen to stage 1.
The app starts playback through John’s headphones.
The sound that comes from John’s headphone is loud enough in order to mask the sound coming from the PA system of stage 2.
Case 4: A listener wants enhanced audio quality because he/she is far from the stage
At the position George is located, he can hear several stages simultaneously, with lots of echo effects generated by multiple PA systems resulting in poor sound quality
If George doesn’t have the subscription of this NPN, he can quickly sign up this service online and receive the correct credential from the network.
George turns on the app, which gets connected to the audio distribution system using the distribution NPN
George gets the list of available channels and choose to listen to stage 1
The app starts playback through George’s headphones, which could have not enough acoustic insulation, and he listens to both the PA systems and his own headphones
The sound that comes from George’s headphones is loud enough in order to mask the sound coming from the PA system of stage 2 and don’t generate audible artefacts when combined with the sound from stage 1
Case 5: A listener wants enhanced audio quality and wants to use other data services
At the position Ringo is located, he can hear several stages simultaneously, with lots of echo effects generated by multiple PA systems resulting in poor sound quality
If Ringo doesn’t have the subscription of this NPN, he can quickly sign up the service online and receive the correct credential from the network.
Ringo turns on the app, which gets connected to the audio distribution system using the distribution NPN
Ringo gets the list of available channels and choose to listen to stage 1
-	After a while listening to stage 1, Ringo makes a short video and wants to share the video on his favorite social network
-	The data transfer of the video is handled by his home RAN, while the audio playback keeps active through the audio distribution NPN",TR 22.827,5.3.3,all_images/image_105.jpeg,Example scenario for live production with integrated audience services
"The service flows are shown for the actors:
Controller operates the master unit: Alan, who has many colleagues
Security staff member: Brian
Camera operator: Charles
Stage personal: David, Ed
The intercom system operates in a number of modes as demonstrated in the following use cases:
Figure 5.4.3-1: Case 1: Broadcast mode - Master unit controller (Alan) sends message to everyone
Case 1: Broadcast mode - Master unit controller (Alan) sends message to everyone
Alan selects broadcast mode
Alan presses the talk button on the microphone at the master unit
Alan talks into the microphone
Audio message is received simultaneously by Brian, Charles and David (and up to 1000 other users)
Case 2: Individual mode - Direct message from master unit controller (Alan) to Charles
Alan selects individual mode and selects Charles as a recipient
Alan presses the talk button on the microphone at the master unit
Alan talks into the microphone
Audio message is received by Charles only
Charles can optionally reply using push-to-talk (PTT)
Optional PTT message from Charles only received by Alan (not other master unit controllers)
Case 3: Uplink
Brian sends an audio message to Alan (or other master unit controllers) with PTT or voice activity detection
Alan selects Brian as a recipient
Alan press the button on the microphone at the master unit
Message from Alan received by Brian
Repeat 1 to 4 for a conversation
Case 4: Downlink message to talk-groups
Alan selects a talk-group (a group of users e.g. stage personnel)
Alan press the button on the microphone at the master unit
Audio message is received simultaneously by David and his stage personnel colleagues
Ed (a member of stage personnel) did not understand the message and request a repeat from Alan using PTT on his handset
Audio message from Ed goes to all members of the stage personnel talk-group
Case 5: Uplink message to talk-groups
Ed sends audio message to a talk-group (e.g. security talk-group) with PTT or voice activity detection
Audio message is received simultaneously by David and his stage personnel colleagues including Ed
David and Ed may be in close proximity but could not talk to each other directly due to loud noise. As they can see each other’s lips, the ongoing Intercom communication must by lip-synchronous, i.e. mouth-to-ear latency smaller than 20 ms
Ed can also hear his own voice through the intercom channel, the communication delay should be small enough not to disturb him while talking",TR 22.827,5.4.3,all_images/image_106.jpeg,Case 1: Broadcast mode - Master unit controller (Alan) sends message to everyone
"The director of a live sports programme needs to broadcast the events unfolding at a sports arena in a remote location. He does not have the budget to send many people or lots of equipment. He can only send three cameras with operators and two presenters. The director remains in a different location and will produce the programme live from his Production Gallery. The Production Gallery has connectivity to a 5G network, either via radio or a direct connection to a 5G network.
The director needs to receive ultra-reliable, low latency, uncompressed, synchronous and coherent audio and video programme feeds from the remote arena.
The director needs to have ultra-reliable connectivity as his company will potentially have millions of viewers, both the broadcaster and the consumers could have paid a premium for the rights to transmit and receive the content.
Low latency is required to facilitate intelligible and rapid communications and immediate responses in terms of verbal replies as well as reacting to instructions.
The director needs to make remote camera adjustments in as close to real time as possible.
Any latency needs to be constant and predictable and should remain so over the period of production which could be hours or even days.
The director needs to be able to cut between two or more different cameras covering the same action without an obvious difference in timing.
He needs to be able to mix between audio sources without differences in timing causing audio disturbance.
The director also needs to be able to establish voice communication with each of the camera operators and presenters individually. He may decide to communicate with the group using Production Gallery controls.
The camera operators and presenters also need to be able to communicate with one another locally either individually or in small groups.
The three camera operators each need to be able to see and hear a preview programme feed to line up shots with graphics overlays.
The presenters also need to be able to see and hear a return programme feed from the Production Gallery.
The director also needs the ability to control the on-site equipment from the Production Gallery remotely and receive confirmation messages back, all with low latency.
This use case is likely to use compressed video in as high a quality and at as low latency as possible. Current thinking envisages the availability of two streams of video per camera, one a lower quality proxy and one in as higher quality as possible.
The low-quality feed is sent back to the broadcast centre to allow for monitoring and mixing with other sources while the higher quality is held at site. When a decision to cut or mix between cameras is made at the broadcast centre the high-quality feed of the selected camera is sent form the location to be broadcast.
Figure 5.7.1-1: 	An example of a multi-camera outside broadcast where contributions are independently fed back to a remote production gallery complete with return communications.",TR 22.827,5.7.1,all_images/image_109.png,An example of a multi-camera outside broadcast where contributions are
"Producing and capturing a live event, i.e. for further exploitation of the cultural and creative content, involve many wireless links. For instance, artists on stage use wireless microphones to capture their voices or instruments’ sound while hearing themselves via a wireless in-ear monitoring system. Cameramen operate their wireless cameras capturing the performance. The technical crew, the production team and the security staff are usually connected to each other via an intercom system. Lighting, video and sound effects are remotely controlled over stage control systems. The term PMSE equipment is used to sum up all wireless audio and video equipment involved in professional AV productions.
Live outside events like cycling races, marathons and triathlons, typically take place over large distances like hundreds of square kilometres. For covering these large distances, an airborne relay is used. A pressurized aircraft circling at 6000 m receiving and transmitting all information between all involved UE’s. Typical operation has a defined and in advanced known duration. All PMSE equipment required for the production and capturing of an event is always available along the track of the event. It either belongs to the broadcaster or a rental company has been engaged to deploy the network for the event.
Wireless cameras are used for capturing the picture, voice and data signals of the competitors along the track. PMSE content capturing sits at the very beginning of the supply and value chains for a wide range of products, such as recordings of live performances or the archiving of culturally significant material. Consequently, content capture is expected to be provided at the highest quality possible, with producers and program makers taking steps to ensure the quality and robustness of content capture and delivery. For these reasons, quality and reliability of the radio link are fundamental to PMSE users. For live PMSE productions especially, the commercial pressures on users are significant as there is no opportunity for recovery. It is not possible to re-run a race and so the tolerance for degradation of the QoS is extremely low. Often contractual obligations between the producer and the broadcaster specify a minimum amount of dropout or freezing of pictures.
In a typical outside broadcast live event using an airborne relay, a number between 5 and 10 simultaneously active wireless cameras can be expected. Each wireless camera signal is streamed via an airborne relay to the central video mixing console. Each active wireless camera can produce a video stream of up to 100 Mbit/s (4K@100fps) and receives a return video signal of maximum 12 Mbit/s (1080i@50fps).
The video mixing console performs the mixing and combining of the different video streams. Many cameramen rely on receiving a personalized video mix of the event streamed back to his camera viewfinder, this being a lower quality compressed feed. In this context, personalized means that each cameraman can receive a different video mix (i.e. point to point downlink transmission) fully adapted to his or her needs and preferences. Sometimes a group of cameramen in the production may want to receive the same video-mix. For this latter case, a point to multipoint downlink transmission could be used. The maximum network latency tolerated by a professional cameraman between his wireless camera and the return video picture in his viewfinder coming via the mixing console is a maximum of 40 ms The maximum round trip time for the network (airborne Core and RAN) is set to 6 ms The backhaul IP-link between the airborne relay and the base-station takes 4 ms which leaves 30 ms. for the codec and the mixing console. The video mixing console produces further outgoing high-quality streams for playout and recording.
Figure 5.9.1-1: Live content production network for a large area event
With the aircraft at 6 km altitude we expect to cover an area with a diameter of 30 km. If all the motorbikes and the camera helicopter are within these 30 km’s they can be covered by the up and the downlink of a 5G small cell based on the aircraft. The receive site can also receive the up and downlink of the small cell if within range. If the aircraft is 200 km. from the receive site, it will not be able to receive the 5G on-board network due to the antenna pattern necessarily pointing downwards. For that reason, a separate IP link between the aircraft and the receive site is specified, in this case on 2035 MHz. This gives the opportunity to have the 5G network core in the OB- van, studio or cloud and put only the NG-RAN in the aircraft. This is for the scenario where it is necessary to cover a long-distance cycling event. In order to cover a marathon it will be possible to connect directly to the 5G on-board network from the receive site.",TR 22.827,5.9.1,all_images/image_110.jpeg,Live content production network for a large area event
"This use case proposes a new service using real-time AV production in sports ground. According to reports, broadcast revenue from the 2016 Summer Olympic Games in Athens was at about 1.5 billion U.S. dollars. In recent years, immersive media applications have attracted lots of attentions and made some technical breakthrough, e.g. freepoint technologies, and improving computing powers. In Olympics, the immersive media services can be provided to audiences at the scene or remote audiences all over the world. On the other hand, such services would be potential business opportunities for multiple operators, and production vendors. The natures of flexibility and virtualization in 5GS and the support of network slicing and non-public network make the support of live immersive media services possible to overcome deployment challenges for 3rd parties.
The real-time AV production for live immersive media involve three major processes, including media acquisition, media production, and media distribution, as shown in Figure 5.10.1-1 for an example of real-time AV production to provision live immersive media service at NFL in the US. The example shows 30+ cameras of UE capability are deployed around the football stadium to bean on the football players and connected to 5G network via NG-RANs in local non-public network which can be operated by 3rd party or MNO.
Figure 5.10.1-1: Live Immersive Media production for Sport Games in 5G network
The LMPF) composes of the following three functionalities:
Media Acquisition: the involving entities/functions include sensors, the professional 360 degree cameras, live media production function (LMPF), and 5G network infrastructure. In support of live immersive media production, it is important to capture as much live videos in different angles, locations as possible. Therefore, the live media production function has to be able to remotely control cameras in real-time whenever needed.
Media Production: the LMPF has the following logical functionalities:
Media Content Storage: to store the uploaded video streams/clips from all the sensors and cameras for further production.
Media Production Console: to decide the actions of the monitoring IoT devices, e.g. cameras, and send commands for dynamically adjusting parameters, e.g. for calibration and video shootings, of one or more cameras based on information provided by cameras and media production console. The monitoring features provided by the 5GS is used to configure the cameras and sensors for reporting specific events to the LMPF. Further, there may have different Media Production Consoles to produce media for different subscribed services subject to different service requirements. For example, for provisioning immersive media for audiences at the scene, the high throughput and low latency delivery of the live immersive media is required. On the other hand, for remote audiences, which may allow relaxed latency requirements, the production of the media can mixed with other media sources, e.g. reporting, and advertisements.
Media Distribution: the produced media is stored and provided by the LMPF to the audiences at the scene, which have service subscriptions to the non-public network or private slice in PLMN, or audiences at remote sites all over the world, which have service subscriptions from their service providers. The LMPF can offer live media service by distributing it to the other operators (MNO/3rd parties) as service subscribers. If service agreements for the live media service are available. There are two methods to distribute the service:
[pull model]: the LMPF already configures and setups the address and port to be accessed by the subscriber. The subscriber can retrieve the live media accordingly. The corresponding APIs are provided for the subscriber to retrieve the live media.
[push model]: the LMPF already has stored address and port information to access the network of the subscribers. The LMPF can push the live media accordingly whenever available.
NOTE:	The functionality of the Media Distribution is out of scope of this study.
The 5G system can provision the live immersive media production service using a Live/Local Media Production Function (LMPF) to its customer, including MNOs and 3rd parties. The LMPF can be deployed as a virtual network function in 5G network or as an AF interfacing with 5G network over a standardized interface. The operation of the LMPF is for temporary and in a limited time.
When LMPF as a virtual network function, the 5G system needs to provide APIs to the LMPF subscribers/customers, e.g. MNOs, 3rd parties, to request the live media service with required media types, media compression types, media related parameters, and its subscriber ID for LMPF service; to provide service authentication and authorization; to provide the security parameters for the media, e.g. integrity key, encryption key, encryption algorithms, etc.; to provides the access information, including network function address(s) (may be in other network function address depending on the deployment) or port number(s) for retrieving the live media, etc.
When LMPF as an AF, the 5G system needs to provide APIs to allow the LMPF service provider to request for media acquisition service from the 5G system with required media parameters with required media types, media compression types, media related parameters, and its subscriber ID; to request for media acquisition service from the 5G system with required device configuration, e.g. camera shooting angles, resolutions, resolutions, number of cameras, etc.; to request for device monitoring/reporting services from the IoT devices, e.g. the sensors and cameras; to request for device parameters adjustments for the specific devices, e.g. camera, when conducting media acquisitions, etc.
In addition, if the 5G system is also a service subscriber/customer of the produced live media from the LMPF, it needs to provide the APIs to receive the live media including to obtain the live media service with required media types, media compression types, media related parameters, and its subscriber ID for LMPF service; to get service authentication and authorization; to get the security parameters for the media, e.g. integrity key, encryption key, encryption algorithms, etc.; to get the access information, including LMPF function address(s) (may be in other address depending on the deployment) or port number(s) for retrieving the live media, etc.
Please note that service subscribers of the live media service is not limited to the service subscriber of the live media production service. The live immersive media production service in 5G network can be deployed in the following scenarios:
a private slice in a PLMN shared among MNOs and 3rd parties (as shown in Figure 5.10.1-1)
a non-public network which RAN/CN infrastructure is deployed by a 3rd party using spectrum leased from one or more MNO(s) and operated as a RAN sharing network shared among one or more MNO(s)/3rd parties.",TR 22.827,5.10.1,all_images/image_111.jpeg,Live Immersive Media production for Sport Games in 5G network
"The use device for mobile gaming can be a normal smart phone or AR/VR devices. When playing the game, the sensors within the devices produce some data which is needed to perform rendering computing.  Following the description in S4-190260 (Permanent Document for FS_XR5G as attached to S4-190261), different rendering scenarios exist. Rendering may be done exclusively on the device (see clause 5.9.3.1). This model follows also the architecture of VR Streaming as specified in TS26.118. In other instantiations, all or part of the rendering is done in the network/cloud.
For cloud rending use case (equivalent to S4-190260, clause 5.9.3.2 Network Rendering: Viewport rendering in Edge), the user device doesn’t perform rendering computing, instead, it sends the sensor data in uplink direction to the cloud side in a real time manner.  When the cloud side receives the sensor data, it performs rendering computing and produces the multimedia data and then sends back to the user devices for display.
The following Figure 5.3.1-1 shows the general idea of this use case. Please note that this figure is only used to illustrate how cloud rendering for mobile games works and the major impacts to 3GPP is whether and how 5GS can be used to transport the uplink sensor information and downlink rendered multimedia data to display.
Figure 5.3.1-1: Cloud rendering for games
In order to reduce the latency, edge computing can be enabled for the cloud side.  To achieve this purpose, NEF may be enhanced to support network capability exposure to the cloud render server as an AF.
VR services are considered as an important application in 5G network.  Based on the feasibility study [2] and normative work [4], the service requirements are specified as follows in [4]:
To support VR environments with low motion-to-photon capabilities, the 5G system shall support:
-		motion-to-photon latency in the range of 7-15ms while maintaining the required user data rate of [1Gbps] and
-		motion-to-sound delay of [<20ms].
NOTE: 	The motion-to-photon latency is defined as the latency between the physical movement of a user's head and the updated picture in the VR headset. The motion-to-sound latency is the latency between the physical movement of a user's head and updated sound waves from a head mounted speaker reaching their ears.
Regarding to the performance indicators like required data rate and latency, different research institutes and companies have different observations since the assumed parameters are different. In [9], the motivations and technical trends for low latency and ultra-reliable VR services which is quite aligned with this use case. In [5], it demonstrates that for some VR use cases like remote machinery control, the latency needs to be lower than 5ms and depending on the frame rate and DoF (degree of freedom) the required bandwidth can be up to 1Gbps.  In [10], one given example shows that the resolution of Oculus Rift CV1 is 1080 × 1200 (1,296,000) per eye driven at 90Hz resulting in an uncompressed data rate of about 5.3 Gbps. In [11], it can be observed that the required data rate is dependent in the resolution, frame rate, DoF (Degree of Freedom) and other factors like the codec and compressing algorithms.
Compared with existing gaming services, cloud gaming is extremely delay and bandwidth sensitive because there is no buffer for the video frame and any non-real time delivery or packet loss will cause discontinuous frame or bad gaming experience.  For example, current mainstream FPS (First Person Shooter) game requires 60 frames per second, which means frame interval is 16.67ms.  Taking out the delay for rendering and encoding/decoding processing, the round-trip time (RTT) delay over 5GS should be less than 5ms. Another example is that for MOBA (Multiplayer Online Battle Arena) game which requires 20ms RTT which is more relaxed than FPS game. For all these games which need rendering in cloud side, guaranteed data rate very critical as there is no buffering or retransmission mechanism for real time rendering which is quite different from streaming games. The means peak or average bandwidth is not sufficient for cloud gaming but guaranteed data rate is needed. In [12], one analysis shows that for streaming services 0.1% packet loss will downgrade MOS by 10%. Considering the short latency and lack of need for buffering, the impact of packet loss is more serious than streaming services.  Thus, packet loss rate should be ultra-low which means reliability similar to URLLC with is in general align with the analysis in [9].  In [17], it has illustrated that 1% packet loss would impact user experience and patience for cloud gaming. In [13], the forecast from GSMA and China Academy of Information and Communications Technology (CAICT) show that above 60 FPS and 8K video would be popular for AR/VR. There is another way to specify the requirement without requiring data rate which is from FPS and resolution perspective. For cloud game with VR rendering, to fulfil the foresee user expectations for cloud gaming, the frame rate higher than 60 FPS and 8K resolution should be supported. Given the frame rate and/or resolution, since there are many factors which may affect the required bandwidth, depending on the data rate which can be provided by the 5G system, the 3rd party i.e. cloud server for VR rendering can configure the other parameters like codec algorithms to fit the bandwidth.
To address some of the challenges listed above (extremely low-latency requirements, all rendering done in the network), also so-called split rendering architectures are defined in equivalent to S4-190260. Two instantiations of split rendering are copied below
Split Rendering: Viewport rendering with Time Warp in device (see S4-190260, clause 5.9.3.3)
In Figure 5.3.1-2, the viewport is pre-dominantly rendered in the XR edge server, but the device is able to do time-warping to address local correction.
VR graphics workload split into rendering workload on powerful XR server and TW on device
Low motion-to-photon latency preserved via on device Asynchronous Time Warping (ATW)
Figure 5.3.1-2: Split Rendering with Time Warp in HMD
More details are expected to be developed in the context of the FS_XR5G study item.
Split Rendering 3D-Video Streaming (see S4-190260, clause 5.9.3.4)
Figure 5.3.1-3 below shows the 3D-video Streaming approach.
Split rendering framework based on generating textures and meshes (geometry) for even XR graphics quality
Seamless support for enhanced XR rendering optimizations (e.g. foveated rendering, asynchronous space warp)
Figure 5.3.1-2: Split Rendering 3D Streaming
More details are expected to be developed in the context of the FS_XR5G study item.",TR 22.842,5.3.1,all_images/image_114.jpeg,Split Rendering with Time Warp in HMD
,TR 33.846,6.2.5,all_images/image_122.jpeg,Signalling flow of mitigation against the linkability attack
"Figure 6.2.9.2-1: Cause concealment (5GS) in case of authentication failure
The initial Registration procedure is triggered from UE and the procedure is the same as described in clause 6.1.2 of TS 33.501 [2]. Only step 7 varies by creating a new 5GMM cause value.
Step 0:	SQNms is shared from UE to UDM in registration request message. Concealed format of SQNms (could be encrypted separately or sent as AUTN or embedded in SUCI).
Step 1: UDM generates authentication vector, derives KAUSF and calculates XRES*. UDM/ARPF will create 5G HE AV from RAND, AUTN, XRES* and KAUSF.
Step 2: UDM will return 5G HE authentication vector to AUSF to be used for 5G AKA in Nudm_UEAuthentication_Get Response. UDM will include SUPI in the SUPI in the Nudm_UEAuthentication_Get Response after deconcealment of SUCI by SIDF.
Step 3: AUSF will store the XRES* temporarily together with the received SUCI or SUPI.
Step 4: AUSF will then generate 5G authentication vector from the 5G HE authentication vector received from the UDM/ARPF by computing the HXRES* from XRES* and KSEAF from KAUSF, and replacing the XRES* with the HXRES* and KAUSF with KSEAF in the 5G.
Step 5: AUSF will remove the KSEAF and return the 5G SE authentication vector (RAND, AUTN, HXRES*) to the SEAF in a Nausf_UEAuthentication_Authenticate Response.
Step 6: SEAF will send RAND, AUTN to the UE in a NAS message Authentication Request. This message will also include ngKSI that will be used by UE and AMF to identify the KAMF and the partial native security context that is created if the authentication is successful. This message will also include the ABBA parameter. ME will forward the RAND and AUTN received in NAS message Authentication Request to the USIM.
Step 7: These three steps are followed at USIM after reception of RAND and AUTN.
7.1.	USIM computes XMAC and compares this with received MAC from AUTN. If they are different, then it results in MAC failure. If it is same, then it continues to step 7.2.
7.2.	USIM verifies if the received sequence number SQN is in correct range or not. If it is not in correct range, then it results in Synchronisation failure. If it is in correct range, then it continues to step 7.3.
7.3.	As MAC verification and sequence number range is verified, USIM computes RES to be included in authentication response.
For MAC failure or Synchronisation failure, the cause value is taken as input for concealment in AUTSCAUSE.
The generation of MAC-S, AK and Cause concealment is shown below.
MAC-S = f1*K(Cause value || RAND || AMF)
AK = f5*K(RAND)
Conc(Cause value) = Cause value  AK
AUTSCAUSE = Conc(Cause value) || MAC-S
NOTE 1:	AUTSCAUSE containing cause value will be sent for both MAC and Synch failure. USIM conceals the cause values in AUTSCAUSE and forwards it to ME.
Step 8: Authentication failure message is sent from UE to SEAF with new 5GMM cause value as generic ""authentication failure cause"" along with AUTSCAUSE.
Step 9: Upon receiving an authentication failure message with AUTSCAUSE from the UE, the SEAF sends a Nausf_UEAuthentication_Authenticate Request message with a ""synchronisation failure indication"" to the AUSF.
Step 10: AUSF sends a Nudm_UEAuthentication_Get Request message to the UDM/ARPF, together with the following parameters:
-	RAND sent to the UE in the preceding Authentication Request, and
-	AUTSCAUSE received by the SEAF in the response from the UE to that request.
Step 11: UDM retrieves cause value from AUTSCAUSE using RAND value.
Step 12: In case of MAC failure cause value, UDM updates SEAF with MAC failure for the Authentication procedure. Rest of the procedures of how MAC failure is treated remains the same (as described in TS 33.501[V] & TS 24.501[W] 5.4.1.3.6 & 5.4.1.3.7 item c.).
In case of Synch failure, a new Authentication vector is generated in UDM and the AKA challenge is sent to UE. Below figure 6.2 shows the concealed cause value in AUTSCAUSE generation at step 7 in USIM and related 5GS procedures.
NOTE 2:	In order to handle the attack scenario, where the attacker repeats the same RAND and AUTN in 5G AKA challenge and retrieves the ""cause value"", which is concealed (similar to SQN leakage key issue), USIM generated 128 bits of RAND (RANDMS / RANDSQN as described in solution #4.5 or #4.7) is used in initial registration request message to conceal the SQNMS at UE / UDM.
When registration request is sent with RANDMS / RANDSQN, USIM stores only LSB of 128 bits for future verification purposes and UDM uses received RAND (RANDMS / RANDSQN) to concatenate with newly generated random value at UDM (Note, only LSB of 128 bits RANDMS / RANDSQN is concatenated). AKA challenge is sent with concatenated RAND, so USIM can verify the received RAND by checking the LSB from stored RANDMS/RANDSQN. After verification, USIM deletes previously stored RANDMS / RANDSQN. An attacker cannot repeat the same RAND and AUTN, as LSB of random number does not exist in USIM and verification of RAND fails.",TR 33.846,6.2.9.2,all_images/image_124.png,Cause concealment (5GS) in case of authentication failure
"When a UDM receives a SUCI from the AUSF, the UDM de-conceals the SUCI to SUPI. The UDM stores the SUCI and the timestamp when the SUCI was received for the SUPI. The UDM initiates the authentication procedure.
When the UDM receives the SUCI again, then it calculates the time period T between the first time the SUCI was received and the latest time the SUCI was received, if the T is less than or equal to T3519 then the UDM initiates authentication procedure otherwise the UDM determines either the UE is fake or there is man in the middle on receiving SUCI 1 and the UDM rejects the authentication procedure as SUCI retransmission is not expected after T3519. The UDM stores the time stamp of first time the SUCI was received for a SUPI for period of time (e.g. 24 hours or 48 hours or longer).
Figure 6.2.10.2-1: Procedure to handle SUCI parameter in the UDM
The detailed steps of the solution is as described below.
1.	The UE is registered to the network for the first time by sending SUCI-1 in the registration procedure. The UE has been assigned 5G-GUTI 1. The UDM stores the SUCI 1 and the time stamp when the SUCI 1 was received. The UDM stores the time stamp when the SUCI was received for the very first time per SUPI for period of time (e.g. 24 hours or 48hours or longer).
2-3.	The UE initiates an initial NAS procedure including the 5G-GUTI 1 in an initial NAS message. The MITM corrupts the 5G-GUTI 1. The context is not found in the AMF and the AMF initiates the identification procedure requesting SUCI.
4.	Upon receiving the identity request message with identity type = SUCI, the UE calculates a new SUCI, SUCI 2, as the timer T3519 expires in the UE and sends SUCI 2 in the identity response message. The MITM replaces SUCI 2 with SUCI 1. The AMF on receiving the identity response message initiate authentication procedure towards the UDM for SUCI 1.
5.	The UDM deconceals the SUCI 1 to SUPI. The UDM calculates the time period T from the time when the SUCI 1 was received first time using the time stamp stored for the SUCI 1 in step 0-d. If T is less than or equal to T3519 then the step 6a takes place otherwise step 6b takes place.
6a.	If the timer T is running for the SUCI 1 then the UDM initiates authentication procedure as described in sub clause 6.1.3 of TS 33.501. After successful registration procedure, the UDM stops the timer T.
6b	If the timer T has expired then the UDM rejects the authentication procedure as SUCI retransmission is not expected after T3519.",TR 33.846,6.2.10.2,all_images/image_125.jpeg,Procedure to handle SUCI parameter in the UDM
"This solution proposes to introduce a new parameter Check Value behind SUPI to mitigate the SUPI guessing attacks.
Figure. 6.3.2.2-1 shows a structure of the IMSI and Check Value (IMSICV). the IMSICV comprises the respective features of the IMSI, namely a Mobile Country Code (MCC), a Mobile Network Code (MNC) and a Mobile Subscriber Identification Number (MSIN). In addition, as shown in Figure. 6.3.2.2-1, the Check Value is used to verify the validity of the IMSI (SUPI) or MSIN. The length of the Check Value depends on the network operator. The Check Value may be updated by the home network through the way update routing indicator in SUCI.
Figure 6.3.2.2-1: Structure of IMSI and Check Value
Figure 6.3.2.2-2 shows the procedure of mitigating the SUPI guessing attacks, the IMSICV are stored at the UE and the UDM/ARPF.
Figure 6.3.2.2-2: The procedure of mitigating the SUPI guessing attacks
1.	The UE sends the Registration Request message to the AMF/SEAF containing SUCI, and the SUCI includes SUPI Type, Home Network Identifier, Routing Indicator, Protection Scheme Identifier, Home Network Public Key Identifier and Scheme Output. The Cipher value text in Scheme Output is the encryption of MSIN and Check value.
2.	The SEAF invokes the Nausf_UEAuthentication service by sending a Nausf_UEAuthentication_Authenticate Request message containing the SUCI to the AUSF.
3.	The Nudm_UEAuthentication_Get Request containing SUCI is sent from AUSF to UDM.
4.	Upon reception of the Nudm_UEAuthentication_Get Request, the UDM invokes SIDF (Subscriber Identity De-concealing Function) to de-conceal the SUCI to obtain (e.g. determine) the SUPI and the Check Value. The UDM determines whether the SUPI is stored in the database. If the SUPI is found in the database of the UDM, the UDM determines whether the Check Value is stored in the database as well.
5.	If SUPI and Check Value are both found in the database of the UDM, the UDM selects the authentication method according to the SUPI. Then, the UDM generates the authentication data including authentication vector and sends it to AUSF in the Nudm_UEAuthentication_Get Response message with ""200 OK"". If SUPI or Check Value are not found in the database, the UDM returns ""404 Not Found"" with ""USER_NOT_FOUND"" in the Nudm_UEAuthentication_Get Response message.
6.	Upon reception of ""200 OK"", the AUSF sends ""201 Created"" to AMF/SEAF with UEAuthentictionCtx containing authentication vector in the Nausf_UEAuthentication_Authenticate Response message. Upon reception of ""404 Not Found"", the AUSF sends ""404 Not Found"" to AMF/SEAF with ""USER_NOT_FOUND"".
7.	The AMF/SEAF sends RAND and AUTN to the UE in the Authentication Request message in the case of ""201 Created"". Otherwise, the AMF/SEAF sends the Registration Reject message with Cause#3 to the UE in the case of ""404 Not Found"".",TR 33.846,6.3.2.2,all_images/image_127.jpeg,The procedure of mitigating the SUPI guessing attacks
"Current usage of ECIES for concealment of SUPI can be expanded to accommodate SQNMS and SUPI. Maximum allowed size of cipher text from concealment of protection scheme output is 3000 digits. SUPI utilizes only few bytes of those maximum allowed digits and still can adapt SQNMS.
Figure 6.4.3.2-1 Encryption based on ECIES at UE
Figure 6.4.3.2-1 shows the encryption based on ECIES at UE side, where SUPI is concatenated with SQNMS and taken as one plain text block for symmetric encryption. In case of SUPI type as IMSI, then MSIN (9 to 10 digits) and SQNMS (48 bits: 6 bytes) is concatenated in UE.
Figure 6.4.3.2-2: Decryption based on ECIES at home network
Figure 6.4.3.2-2 shows the decryption based on ECIES at home network, where SUPI and SQNMS is dissociated after the symmetric decryption.
Figure 6.4.3.2-3: Structure of SUCI
Figure 6.4.3.2-3 shows the structure of SUCI with SUPI Type, which consists values in the range 0 to 7 as specified in clause 2.2B of TS 23.003 [8]. SUPI Type identifies the type of the SUPI concealed in the SUCI.
For this solution, the encoding of SUCI for 'SUPI plus SQNMS' will be represented by a new SUPI Type value, e.g. value 4.
-	0: IMSI
-	1: Network Specific Identifier
-	2: Global Line Identifier (GLI)
-	3: Global Cable Identifier (GCI)
-	4: SUPI plus SQNMS
-  5 to 7: spare values for future use.",TR 33.846,6.4.3.2,all_images/image_128.jpeg,Decryption based on ECIES at home network
"Figure 6.4.3.3.3-1: Authentication procedure for 5G AKA (Failure case)
Figure 6.4.3.3.3-1 shows the failure case of Authentication procedure (considering example of 5G AKA). Changes are shown in bold.
1.	For each Nudm_Authenticate_Get Request, the UDM/ARPF creates a 5G HE AV. The UDM/ARPF does this by generating an AV with the Authentication Management Field (AMF) separation bit set to ""1"" as defined in TS 33.102 [3]. The UDM/ARPF then derives KAUSF (as per Annex A.2 of TS 33.102 [3]) and calculate XRES* (as per Annex A.4 of TS 33.102 [3]). Finally, the UDM/ARPF creates a 5G HE AV from RAND, AUTN, XRES*, and KAUSF.
2.	The UDM then returns the 5G HE AV to the AUSF together with an indication that the 5G HE AV is to be used for 5G-AKA in a Nudm_UEAuthentication_Get Response. In case SUCI was included in the Nudm_UEAuthentication_Get Request, UDM will include the SUPI in the Nudm_UEAuthentication_Get Response.
3.	The AUSF stores the XRES* temporarily together with the received SUCI or SUPI.
4.	The AUSF then generates the 5G AV from the 5G HE AV received from the UDM/ARPF by computing the HXRES* from XRES* (according to TS 33.501 [2] Annex A.5) and KSEAF from KAUSF(according to TS 33.501 [2]Annex A.6), and replacing the XRES* with the HXRES* and KAUSF with KSEAF in the 5G HE AV.
5.	The AUSF then removes the KSEAF return the 5G SE AV (RAND, AUTN, HXRES*) to the SEAF in a Nausf_UEAuthentication_Authenticate Response.
6.	The SEAF sends RAND, AUTN to the UE in a NAS message Authentication -Request. This message also includes the ngKSI that will be used by the UE and AMF to identify the KAMF and the partial native security context that is created if the authentication is successful. This message also includes the ABBA parameter. The SEAF sets the ABBA parameter as defined in Annex A.7.1 of TS 33.102 [3]. The ME forwards the RAND and AUTN received in NAS message Authentication Request to the USIM.
7. At receipt of the RAND and AUTN, the USIM verifies the freshness of the 5G AV by checking whether AUTN can be accepted as described in TS 33.102 [3]. If the verification of the AUTN fails, then the USIM indicates to the ME the reason for failure.
8. The ME responds with NAS message Authentication Failure only with a CAUSE value indicating the reason for failure (as SQN failure/mismatch). AUTS is not calculated by the UE and not shared to network.
9. Upon receiving an authentication failure message from the UE, the SEAF sends an Nausf_UEAuthentication_Authenticate Request message to the AUSF.
10. AUSF sends an Nudm_UEAuthentication_Get Request message to the UDM/ARPF.
11. When the UDM/ARPF receives an Nudm_UEAuthentication_Get Request message it acts as described in TS 33.102 [3], clause 6.3.5 where ARPF is mapped to HE/AuC. The UDM/ARPF sends an Nudm_UEAuthentication_Get Response message with a new authentication vector by considering the SQNMS from database (i.e. SQNMS received in Nudm_UEAuthentication_ Get Request). UDM synchronizes its SQNHE value, i.e. SQNHE = SNQMS. The AUSF runs a new authentication procedure with the UE according to clauses 6.1.3.1 or 6.1.3.2 of TS 33.501 [2] depending on the authentication method applicable for the user.",TR 33.846,6.4.3.3.3,all_images/image_130.jpeg,Authentication procedure for 5G AKA (Failure case)
"If an attacker is able to retrieve the SQNMS details by having the database built with RAND and AUTN (captured from network) and use those against a victim UE with repetition of RAND and AUTN values, privacy of the victim UE is compromised. Such an attack can be carried out with control of RAND and AUTN.
The following solution is applicable to EPS and prevents such attack, even with repeated RAND or AUTN. This can be achieved, if SQNMS is never sent in Authentication failure. Instead USIM calculates AUTS during the registration step using a newly generated RANDMS value. The new RANDMS will be used only for AUTS calculation and sent to home network along with AUTS (i.e. with the Registration request message). In the home network, after deconcealing SQNMS (from AUTS), RANDMS will be deleted and SQNMS is stored temporarily in UDM for future use.
Later after AKA challenge, when there is synch failure, then only the cause value is sent to network. A new AV is generated with the previously stored SQNMS and re-synch procedure begins.
Figure 6.4.5.2-1: SQNMS shared to SN in Registration Request (5GS)
Figure 6.4.5.2-1: depicts the solution of SQNMS shared in Registration request in AUTS from USIM to HSS.
1.	At USIM, new RANDMS is generated and SQNMS retrieved (fetch the highest previously accepted sequence number anywhere in the array). AUTS is calculated at USIM (according to clause 6.3.3 of TS 33.102 [3]) and the registration request is sent from UE to AMF/SEAF with AUTS, RANDMS and SUCI or 5G-GUTI.
2.	Authentication request is sent from SEAF to AUSF with SUCI or SUPI, SN-name, AUTS and RANDMS.
3.	AUSF forwards the same content in Authentication Get Request message to UDM.
4.	SIDF performs the deconcealment of SUCI and Authentication method is selected. UDM tries to retrieve SQNMS from AUTS, stores SQNMS temporarily and deletes RANDMS. A new Authentication vector is generated using the existing SQNHE.
5.	The Authentication get response message is sent with the newly generated 5G AV.
6.	AUSF forwards the 5G SE AV in Nausf_UEAuthentication_Authenticate Response to SEAF.
7.	SEAF forwards the RAND and AUTN in Authentication request message to UE.
8.	In USIM(UE), MAC will be verified followed by it, the SQN will be checked against the correct range.
9.	Success case: Authentication is successful, as HRES* is verified in Serving network and RES* is verified in home environment. When Authentication results are updated from AUSF to UDM, SQNMS will be deleted as home environment and UE are synchronized.
10.	Failure case: Authentication failure message is sent from UE to SEAF with only new failure cause for sync failure. SEAF forwards the failure message to AUSF and AUSF forwards it to UDM. UDM begins to re- synchronize using SQNMS received at step 4. SQNHE is updated with SQNMS.
NOTE:	This solution can also be adapted for EPS as follows. USIM generates a new RANDMS and calculates AUTS. AUTS and RANDMS is used in Attach request sent to HSS. Using RANDMS, SQNMS is retrieved from AUTS in HSS and RANDMS is deleted. The new Authentication vectors are generated with existing SQNHE and sent to MME along with SQNMS. MME stores SQNMS for future use. Both the generated RAND and AUTN is sent in Authentication request message to UE. In case of success, MME deletes SQNMS. In case of failure, AUTS is not calculated in USIM and only sync failure cause is shared to MME. MME shares the SQNMS in Authentication data request message to HSS and HSS starts re- synchronization procedure with SQNMS received before. Also, HSS updates SQNHE with SQNMS.
In the scenario of UE triggered service request, authentication may be performed. AMF gets AUTS and RANDMS from UE and send them in authentication request to AUSF.
Figure 6.4.5.2-2: UE Triggered Service Request procedure (AUSF get AUTS, RANDMS from UE)
Figure 6.4.5.2-2 depicts the procedure of UE triggered service request.
1.	UE to (R)AN: AN message (AN parameters, Service Request (List Of PDU Sessions To Be Activated, List Of Allowed PDU Sessions, security parameters, PDU Session status, 5G-S-TMSI, [NAS message container], Exempt Indication), AUTS and RANDMS).
2.	(R)AN to AMF: N2 Message (N2 parameters, Service Request, AUTS and RANDMS).
After receiving the Service Request message, the AMF may perform authentication.
3.	Authentication request is sent from SEAF to AUSF with SUCI or SUPI, SN-name, AUTS and RANDMS.
4.	The further steps of the authentication procedure are as step 5 to 10 in figure 6.4.5.2-1.
5.	Subsequent service request procedure is as described in sub-clause 4.2.3.2 of TS 23.502.
After the establishment of the signalling connection to an AMF, the UE or network may send signalling messages, e.g. PDU Session establishment from UE to the SMF, via the AMF.",TR 33.846,6.4.5.2,all_images/image_131.png,SQNMS shared to SN in Registration Request (5GS)
"If an attacker is able to retrieve the SQNMS details by having the database built with RAND and AUTN (captured from network) and use those against a victim UE with repetition of RAND and AUTN values, privacy of the victim UE is compromised. Such an attack can be carried out with control of RAND and AUTN.
The following solution is applicable to EPS and prevents such attack, even with repeated RAND or AUTN. This can be achieved, if SQNMS is never sent in Authentication failure. Instead USIM calculates AUTS during the registration step using a newly generated RANDMS value. The new RANDMS will be used only for AUTS calculation and sent to home network along with AUTS (i.e. with the Registration request message). In the home network, after deconcealing SQNMS (from AUTS), RANDMS will be deleted and SQNMS is stored temporarily in UDM for future use.
Later after AKA challenge, when there is synch failure, then only the cause value is sent to network. A new AV is generated with the previously stored SQNMS and re-synch procedure begins.
Figure 6.4.5.2-1: SQNMS shared to SN in Registration Request (5GS)
Figure 6.4.5.2-1: depicts the solution of SQNMS shared in Registration request in AUTS from USIM to HSS.
1.	At USIM, new RANDMS is generated and SQNMS retrieved (fetch the highest previously accepted sequence number anywhere in the array). AUTS is calculated at USIM (according to clause 6.3.3 of TS 33.102 [3]) and the registration request is sent from UE to AMF/SEAF with AUTS, RANDMS and SUCI or 5G-GUTI.
2.	Authentication request is sent from SEAF to AUSF with SUCI or SUPI, SN-name, AUTS and RANDMS.
3.	AUSF forwards the same content in Authentication Get Request message to UDM.
4.	SIDF performs the deconcealment of SUCI and Authentication method is selected. UDM tries to retrieve SQNMS from AUTS, stores SQNMS temporarily and deletes RANDMS. A new Authentication vector is generated using the existing SQNHE.
5.	The Authentication get response message is sent with the newly generated 5G AV.
6.	AUSF forwards the 5G SE AV in Nausf_UEAuthentication_Authenticate Response to SEAF.
7.	SEAF forwards the RAND and AUTN in Authentication request message to UE.
8.	In USIM(UE), MAC will be verified followed by it, the SQN will be checked against the correct range.
9.	Success case: Authentication is successful, as HRES* is verified in Serving network and RES* is verified in home environment. When Authentication results are updated from AUSF to UDM, SQNMS will be deleted as home environment and UE are synchronized.
10.	Failure case: Authentication failure message is sent from UE to SEAF with only new failure cause for sync failure. SEAF forwards the failure message to AUSF and AUSF forwards it to UDM. UDM begins to re- synchronize using SQNMS received at step 4. SQNHE is updated with SQNMS.
NOTE:	This solution can also be adapted for EPS as follows. USIM generates a new RANDMS and calculates AUTS. AUTS and RANDMS is used in Attach request sent to HSS. Using RANDMS, SQNMS is retrieved from AUTS in HSS and RANDMS is deleted. The new Authentication vectors are generated with existing SQNHE and sent to MME along with SQNMS. MME stores SQNMS for future use. Both the generated RAND and AUTN is sent in Authentication request message to UE. In case of success, MME deletes SQNMS. In case of failure, AUTS is not calculated in USIM and only sync failure cause is shared to MME. MME shares the SQNMS in Authentication data request message to HSS and HSS starts re- synchronization procedure with SQNMS received before. Also, HSS updates SQNHE with SQNMS.
In the scenario of UE triggered service request, authentication may be performed. AMF gets AUTS and RANDMS from UE and send them in authentication request to AUSF.
Figure 6.4.5.2-2: UE Triggered Service Request procedure (AUSF get AUTS, RANDMS from UE)
Figure 6.4.5.2-2 depicts the procedure of UE triggered service request.
1.	UE to (R)AN: AN message (AN parameters, Service Request (List Of PDU Sessions To Be Activated, List Of Allowed PDU Sessions, security parameters, PDU Session status, 5G-S-TMSI, [NAS message container], Exempt Indication), AUTS and RANDMS).
2.	(R)AN to AMF: N2 Message (N2 parameters, Service Request, AUTS and RANDMS).
After receiving the Service Request message, the AMF may perform authentication.
3.	Authentication request is sent from SEAF to AUSF with SUCI or SUPI, SN-name, AUTS and RANDMS.
4.	The further steps of the authentication procedure are as step 5 to 10 in figure 6.4.5.2-1.
5.	Subsequent service request procedure is as described in sub-clause 4.2.3.2 of TS 23.502.
After the establishment of the signalling connection to an AMF, the UE or network may send signalling messages, e.g. PDU Session establishment from UE to the SMF, via the AMF.",TR 33.846,6.4.5.2,all_images/image_132.jpeg,"UE Triggered Service Request procedure (AUSF get AUTS, RANDMS from UE)"
"This solution uses UICC Over-The-Air (OTA) management TS 31.115 [21], TS 31.116 [23] to deliver the public key and associated parameters to the subscriber. UICC OTA is a 3GPP standard in which the network can manipulate data on the UICC by sending a series of APDU commands to the terminal.  The commands are bundled together and protected using a special UICC OTA key before they are sent to the terminal for execution. The example in figure 7.8.2-1 uses SMS for transport but other types of transport are also possible, such as USSD or HTTP. Note that SMS is assumed to be available in LTE using SMS over SGs.
Figure 7.8.2-1: UICC OTA delivery of PWS key using SMS as transport bearer
3GPP needs to decide on the type of data items that should be present on the UICC and the content of the UICC OTA messages. However, the UICC OTA Gateway in itself can be left non-standardized.  It is up to the regulators and operators in each country to decide on the implementation details and the interface towards the CBE(s). It is also possible to select a different distribution method, such as configuring the UICC at the time of manufacturing.",TR 33.969,7.8.2,all_images/image_134.jpeg,UICC OTA delivery of PWS key using SMS as transport bearer
"Usually, the 5G RAN HO decision is based on the UE MR (Measurement Report).The UE executes the signal power measurement of the neighbour cell based on the SS Block which carries the broadcasted synchronization signal and MIB signal which is sent without security protection [1] and [2]. Assuming there is a false base station C counterfeiting the system information of a legitimate base station B. The serving base station A receives the UE MR which include measurements from C. Base station A would assume the included information in the UE MR belongs to base station B and then may decide to handover the UE to B and consequently the UE instead connects to the false base station C. Eventually, the handover will fail, as shown in figure 6.6.2.1-1.
Figure 6.6.2.1-1: HO procedure caused by false base station C
Step 0: The UE reports the measurement report (MR) to the source gNB (A).
Step 1: The source gNB (A) decides the measurement from false gNB C meets the HO trigger threshold, then the source gNB (A) lookup the NCRT (neighbour cell relation Table) [16] with the reported PCI (physical cell identity), and finds the target cell of gNB (B).
Step 2: The source gNB (A) sends HO request to target gNB (B).
Step 3: The target gNB (B) makes the HO admission decision and prepares radio resource for the UE (e.g. SRB and DRB resource for the UE).
Step 4: The target gNB (B) responds with the HO request ACK message containing all the prepared RRC configuration information.
Step 5: The source gNB (A) sends HO command to indicate the UE to execute the HO to the target cell.
Step 6: The UE detaches from the source cell.
Step 7: The UE tries to synchronize and camp on the target cell based on the broadcasted SSB signal (including the synchronization signal and MIB signal) and SIB1. Because the SSB signal and SIB1 are not security protected, the UE cannot verify the authenticity of these message. The false gNB can copy the SSB signal and SIB1of the target cell, and sends that with stronger power. Finally, the UE camps on the false cell.
Step 8: The UE sends MSG1 to the camped cell in clear.
Step 9: The false cell responds with MSG2 in plaintext, instructing the UE to send the next uplink message using the dedicated UL allocation resource.
Step 10: The UE sends the HO confirm message using the dedicated UL allocation resource. Although, HO Confirm message is protected using the AS security keys with the real target gNB, the false base station does not need to send any confirmation or acknowledgement to the UE in order for the UE to validate that the receiving base station is the real base station which holds the same AS security context.
The real target cell does not receive the HO confirm message from the UE, then thinks the HO fails. And the source cell does not receive the UE context release message from target cell, then decides the HO failure.
For the UE, the false cell does not have the UE security context, the UE would find RLF at later time. But the UE has camped on the false cell, the false cell can launch some attacks to the UE, e.g. sending spoofing SIBs with false cell reselection blacklisted to the UE.
To avoid this HO procedure and the possibility for UE connecting to false base station during HO, this solution introduces a second measurement based on a specific CSI-RS (Channel State Information Reference Signal) [5] assigned by the target gNB to the UE.",TR 33.809,6.6.2.1,all_images/image_136.jpeg,HO procedure caused by false base station C
"The target gNB B assigns a specific CSI-RS to the UE during the preparation phase, and carries the CSI-RS information in the HO request ACK message. The source gNB A indicates the UE to do second measurement based on the dedicated CSI-RS information. Only when the second UE MR meets the HO trigger condition, then the source gNB A would indicate the UE to do the HO execution.
Because the false gNB C does not know the dedicated CSI-RS information in advance, therefore the second MR reported by the UE is measured with the real reference signal of the target gNB B.
Figure 6.6.2.2.1-1: HO procedure with second measurement and HO decision
The source gNB (A) should support to turn on/off this feature according to the network circumstances.
Step 2: When the local configuration in the source gNB indicates that the feature of second measurement is enabled, the source gNB (A) sends HO request with a new indicator to request the target gNB to prepare a specific CSI-RS for the UE.
Step 3: The target gNB (B) performs admission control and prepares basic RRC configuration information for the UE, including a dedicated CSI-RS information.
Step 4: The target gNB (B) respond with the HO request ACK message containing all the prepared RRC configuration information (including the dedicated CSI-RS information).
Step5: When the source gNB (A) receives the CSI-RS information in the Handover request ACK, and the feature is turned on, the source gNB decides to request the UE for a second time measurement based on the specified CSI-RS information.
Step 6: The source gNB (A) sends a measurement task including the CSI-RS information to the UE while being protected with RRC security context.
Step 7: The UE executes a second measurement of the dedicated CSI-RS signal indicated in the measurement task.
Step 8: The UE reports the second MR to the source gNB (A).
Step 9: Based on the second MR, the source gNB (A) decides whether or not to continue the HO. If the second MR meets the HO trigger threshold, that means the real reference signal power of the target cell is strong enough, the source gNB A sends the HO command to indicate the UE to execute the HO to the target cell. Otherwise, the source gNB A sends HO cancel to the target gNB B to stop the HO procedure.",TR 33.809,6.6.2.2.1,all_images/image_137.png,HO procedure with second measurement and HO decision
"This solution is applicable only for verification of authenticity of the cell during RRC_IDLE mode and RRC_INACTIVE mode cell reselection. This solution is not applicable for cell authenticity verification during initial Registration procedure.
In order to enable the UE to validate the authenticity of received system information, the NR digitally signs the broadcasted system information as shown in Figure 6.7.2.1-1. System information to be broadcasted, Private security key (K-SIGPrivate) and Time Counter are input to security algorithm to generate the digital signature. The input also contains downlink frequency and physical cell ID of the cell that is broadcasting the SI message, which ensures that any replay of the SI message in a different frequency/PCI is detected by the UE. The generated DS together with some least significant bits of Time Counter is added to the system information before transmitting over the air. K-SIGPrivate is specific to the Tracking area. The private key (K-SIGPrivate) is provisioned in the gNB by the MNO. The public K-SIGPublic key and its lifetime is provisioned by the core network to the UE, when performing location update procedure, as shown in Figure 6.7.2.1-2. Time Counter is maintained based on UTC time (number of UTC seconds in 10 ms units since 00:00:00 on Gregorian calendar date 1 January, 1900 (midnight between Sunday, December 31, 1899 and Monday, January 1, 1900), similar to the mechanism used in ProSe Discovery protection TS 33.303) and can be units of milliseconds or seconds or minutes. The gNB obtains a value for a UTC-based counter associated with a transmission slot based on UTC time. The UE may obtain UTC time from any sources available, e.g. the RAN (via SIB, as in LTE via SIB16), NITZ, NTP, GPS (depending on which is available). The Time Counter input to the security algorithm is the value of counter corresponding to time slot in which system information is transmitted. The usage of Time Counter ensures that received system information cannot be replayed. There can be differences in the Time Counter maintained in the UE and the AN because of different UTC source or implementation errors. To take care of these errors least significant bits of Time Counter are also transmitted along with system information.
Editor's Note: The impact of new signature inputs is FFS.
In addition, the along with the public key, the AMF provides the UE with a MAX_OFFSET parameter. The UE stores the MAX_OFFSET parameter. The UE sets a clock which is used for authenticity verification to the value of CURRENT_TIME, obtained from the SIB (as LTE SIB16 provides the timeReferenceInfo which is time reference with 0.25 us granularity). Current Time (maintained at the UE) provides the UE with the time at the base station, and along with the Max Offset parameter, is used to ensure that the time the UE associates with the MIB/SIB transmission slot is reasonably close to the real time. Max Offset indicates how close the time associated with the discovery slot needs to be to the time provided by the base station. The MAX_OFFSET parameter is used to limit the ability of an attacker to successfully replay digitally signed MIBs and SIBs for later use. This is achieved by using MAX_OFFSET as a maximum difference between the UTC-based counter associated with the discovery slot and the CURRENT TIME held by the UE (at 0.25 us granularity).
On receiving the system information the UE verifies the digital signature. The system information with digital signature received, public security key (K-SIGPublic) and Time Counter of the time slot in which system information is received are used to check the authenticity of the SI. If authenticity verification is successful, then the system information is authentic and the UE considers the cell as authentic.
The size of the digital signature leads to increase in the signalling overhead. In order to reduce the overhead, digital signature can be generated for multiple system information together instead of generating the digital signature for each system information. System information is periodically broadcasted, in order to reduce the overhead; protection can be applied once every 'N' period instead of every period. Mechanisms to reduce the overhead are detailed in the clause 6.7.2.3 of the present document.
Editor's Note: It is FFS whether the K-SIG-Priv of all gNBs within a TA are same or different. The possible key leakage if the same K-SIG-Priv is shared by all eNBs needs to be considered.
Figure 6.7.2.1-1: System Information verification using Digital Signatures
Figure 6.7.2.1-2: Provisioning of Public Keys to the UE
Editor's Note: It is FFS, how the UE handles location update reject message from a false base station.",TR 33.809,6.7.2.1,all_images/image_138.jpeg,System Information verification using Digital Signatures
"5G SI is divided into minimum SI and other SI. The other SI may either be broadcast, or provided in a dedicated manner by the gNB, triggered either by the network or upon request from the UE [2]. The authenticity verification information can be classified into the other SI. The gNB generate the digital signature with the minimum SI broadcasted, Private security key (K-SIGPrivate) and Time Counter as input (as shown in Figure 6.7.2.3-1) and provides the digital signature in the other SI (as a separate SI) either periodically or upon request from the UE (as shown in Figure 6.7.2.3-2). As the UE needs to verify the authenticity of the gNB, only signing of the minimum SI is performed in order to reduce the overhead in the UE and in the gNB.
Figure 6.7.2.3-1: Cell authenticity verification using other SI
Figure 6.7.2.3-2: Transmission of cell authenticity verification using other SI
6.7.2.4	Capability negotiation
The UE and the VPLMN require a secure negotiation mechanism so that both have a common understanding of where and which SI messages are protected. This solution proposes the NAS layer based negotiation as shown in the Figure 6.7.2.4-1.
Figure 6.7.2.4-1: SI protection capability negotiation
This proposed negotiation works as below:
1)	The UE indicates its capability to verify SI signatures to the AMF in a Registration Request message.
2)	The AMF uses the UE's capability to decide whether or not to give SI protection information to the UE.
3)	For capable UEs, the AMF sends the following SI protection information in a Registration Accept message:
Editor's Note: The feasibility of including these parameters in this step is FFS.
3.1)	Cells for which the broadcast SI should have signature, e.g., TAIs, PCIs, and Cell IDs. It is proposed that at least the TAIs are included.
3.2)	SI numbers which should be covered by the signature. It is proposed that at least the minimal SI (i.e., MIB and SIB1) should always be covered.
The sending of SI protection information from the AMF to the UE in the Registration Accept message covers both types of Registration Request, i.e., the initial registration and the mobility registration update. It also covers handovers with AMF change because the mobility registration update follows a handover.",TR 33.809,6.7.2.3,all_images/image_140.png,Cell authenticity verification using other SI
"Following figure shows the 4 stages of the solution - Protection Key Agreement (PKA) procedure, Protection Key Transfer (PKT) procedure, Protection Area Information Provisioning (PAIP) procedure, and Cell Authenticity procedure, wherein the stage 1 and stage 2 are executed together, i.e. stage 2 always follows stage1:
Figure 6.9.2.1.1-1: Four stages of cell authenticity with symmetric algorithm
The protection key (CKp) agreed between the home network and the USIM should have the same security requirement as Long Term Key (LTK), which means the USIM should prevent reading out the CKp that used to encrypt the provisioned information (e.g. keys of gNBs).
The serving network provisions protection area (PA) information to the ME, which includes keys that the gNBs uses to integrity protect the radio signaling. The keys in the PA information are encrypted by the CKp and can only be decrypted by the USIM. The ME sends the protection area information and the radio signaling to the USIM for cell authenticity. The CKp and the keys used by the gNBs should be updated periodically, so that they will be useless when they have been cracked.
This solutions can also provide capability to encrypt sensitive information in the radio signaling before 5G security context is active.",TR 33.809,6.9.2.1.1,all_images/image_141.jpeg,Four stages of cell authenticity with symmetric algorithm
"The following figure shows the principle of dynamic information provisioning:
Figure 6.9.2.1.2-1: Principle of dynamic information provisioning to ME",TR 33.809,6.9.2.1.2,all_images/image_142.jpeg,Principle of dynamic information provisioning to ME
"In order to reduce the encrypted keys provisioned to the ME, a group of gNBs can share a root key (i.e. 256-bit KRBS) that used for deriving key per gNB (i.e. 256-bit KBS) for base station protection, hence the serving network can just provision the encrypted root keys of groups in the PA to the ME. The group is called Share Root Key Group (SRKG). Each gNB is included in one and only one SRKG. Each SRKG is identified by a Group Key Identifier (i.e. 24-bit bsGKI), each gNB in a SRKG is identified by a Group Node Identifier (i.e. 8-bit bsGNI).
Each SRKG is included in one or more PAs, and each of those PAs includes the full SRKG. The following figure illustrates the relationship between SRKG and protection area (PA).
Figure 6.9.2.2.2-1: Relationship between shared root key group (SRKG) and protection area (PA)
Any registration area (RA) is fully covered by one and only one PA, so that when UE performs registration procedure, the serving network can provision encrypted keys of the PA to the ME. The following figure illustrates the relationship between registration area (RA) and protection area (PA).
Figure 6.9.2.2.2-2: Relationship between registration area (RA) and protection area (PA)
During registration procedure (initial, mobility, or periodic) or other initial NAS message handling, the AMF should provide the information of the protection area, which includes a list of bsGKI, corresponding encrypted root keys, and corresponding expiry time, to the ME. The ME should store the protection area information. Only the USIM can de-conceal the encrypted root keys. The expiry time is used to avoid a false base station, who cracks a KBS of a gNB, to cheat the UE after key expiration. The expiry time should be short enough to make the key cracking impossible in time.
The serving network should change the root key of a SRKG before expiration. In order to improve performance, a PA should include those gNBs that adjacent to the tracking area that fully covered by the PA, so that the UE can have protection information of every neighbour gNBs when it is at the edge of a tracking area.
The PA should not be too large. It will be difficult to mitigate the false base station attack based on replayed broadcast radio signalling if the PA is too large.",TR 33.809,6.9.2.2.2,all_images/image_143.jpeg,PKA procedure combined with PKT procedure
"In order to reduce the encrypted keys provisioned to the ME, a group of gNBs can share a root key (i.e. 256-bit KRBS) that used for deriving key per gNB (i.e. 256-bit KBS) for base station protection, hence the serving network can just provision the encrypted root keys of groups in the PA to the ME. The group is called Share Root Key Group (SRKG). Each gNB is included in one and only one SRKG. Each SRKG is identified by a Group Key Identifier (i.e. 24-bit bsGKI), each gNB in a SRKG is identified by a Group Node Identifier (i.e. 8-bit bsGNI).
Each SRKG is included in one or more PAs, and each of those PAs includes the full SRKG. The following figure illustrates the relationship between SRKG and protection area (PA).
Figure 6.9.2.2.2-1: Relationship between shared root key group (SRKG) and protection area (PA)
Any registration area (RA) is fully covered by one and only one PA, so that when UE performs registration procedure, the serving network can provision encrypted keys of the PA to the ME. The following figure illustrates the relationship between registration area (RA) and protection area (PA).
Figure 6.9.2.2.2-2: Relationship between registration area (RA) and protection area (PA)
During registration procedure (initial, mobility, or periodic) or other initial NAS message handling, the AMF should provide the information of the protection area, which includes a list of bsGKI, corresponding encrypted root keys, and corresponding expiry time, to the ME. The ME should store the protection area information. Only the USIM can de-conceal the encrypted root keys. The expiry time is used to avoid a false base station, who cracks a KBS of a gNB, to cheat the UE after key expiration. The expiry time should be short enough to make the key cracking impossible in time.
The serving network should change the root key of a SRKG before expiration. In order to improve performance, a PA should include those gNBs that adjacent to the tracking area that fully covered by the PA, so that the UE can have protection information of every neighbour gNBs when it is at the edge of a tracking area.
The PA should not be too large. It will be difficult to mitigate the false base station attack based on replayed broadcast radio signalling if the PA is too large.",TR 33.809,6.9.2.2.2,all_images/image_144.jpeg,Relationship between shared root key group (SRKG) and protection area (PA)
"Pre-conditions:
1.	The serving network provides the bsGKI and bsGNI to the corresponding gNB, e.g., via OAM platform or a dedicated network function.
2.	The serving network manages root keys and related information for the SRKGs, e.g., on OAM platform or a dedicated network function. The serving network derives KBS based on the KRBS, bsGKI, and bsGNI for each gNB as follow:
KBS = HMAC-SHA-256 (KRBS, <bsGKI, bsGNI>)
The combination of <bsGKI, bsGNI> is a 32-bit value. The serving network also has provided the KBS to the corresponding gNB. In order to make sure that different gNB has different KBS, the combination of <bsGKI, bsGNI> should be unique on each gNB.
Following figure illustrates the initial shared key provisioning procedure between UE and the serving network.
Figure 6.9.2.2.3-1: Protection Area Information Provisioning (PAIP) procedure
0.	The protection key (CKp) has been transferred from hone network to the serving network during Protection Key Transfer (PKT) procedure.
1.	The UE sends a Registration Request message to the AMF/SEAF. This message may also trigger the PKA and PKT procedure as described in sub-clause 6.9.2.2.1.
2.	If the AMF/SEAF supports Anti-False-Base-Station (AFBS), the AMF/SEAF should obtain the PA information, i.e. a list of {bsGKI, EKRBS, expiry time} associated with the PA that covers the tracking area that the UE resides in. The EKRBS is encrypted KRBS based on the CKp, the expiry time indicates that the EKRBS will have been changed after that.
3.	The AMF/SEAF sends Registration Accept (PA information) to the UE.
4.	If the ME supports AFBS, the ME stores the received PA information.
NOTE: 	The procedure also can be triggered by other initial NAS message, if the step 1 is not registration request, the step 4 can be other DL NAS message, e.g. UE Configuration Update.",TR 33.809,6.9.2.2.3,all_images/image_146.png,Protection Area Information Provisioning (PAIP) procedure
"Detailed call flow is as following.
Figure 6.10.2.5-1: Protect unicast message using ECDH and MAC",TR 33.809,6.10.2.5,all_images/image_149.jpeg,Protect unicast message using ECDH and MAC
"Figure 6.18.2.2-1: CHO procedure with indicated second measurement
1)	The UEs performs measurement, and sends measurement report including measured signal 1 of this specific cell to the source gNB (A). The measured signal may be false gNB C's who forged the same cell to the target gNB B.
2)	-2. When the source gNB receives Measurement Report, the measured signal is going to trigger Conditional Handover, the source gNB (A) sends CHO request with a CSI-RS to request the target gNB to prepare a specific CSI-RS for the UE.
3)	The target gNB (B) performs admission control and prepares basic RRC configuration information for the UE, including a dedicated CSI-RS information.
4)	The target gNB (B) responds with the CHO request ACK message containing all the prepared RRC configuration information (including the dedicated CSI-RS information).
5)	Once the source gNB (A) receives the CSI-RS information in the Conditional Handover request ACK, the source gNB attaches threshold of HO.
6)	The source gNB (A) sends CHO Command including the dedicated CSI-RS information and threshold to the UE while being protected with RRC security context.
7)	The UE executes a second measurement of the dedicated CSI-RS signal indicated in the CHO Command, and get measured signal 2.
8)	Based on the signal 2 and measurement condition, the UE decides whether or not to continue the HO. If the signal 2 meets the threshold, that means the real reference signal power of the target cell is strong enough, the UE sends the HO confirm to the target cell, no latency is added. Otherwise, the signal 1 may be false gNB C's signal, and the UE will not trigger handover. Thus, the UE will not connect to the false base station.",TR 33.809,6.18.2.2,all_images/image_154.jpeg,CHO procedure with indicated second measurement
"A concrete instantiation of the short-term certificates taking into account how to achieve efficient replay protection and low overhead towards the DSnF is as follows.
Each base station has to send a request to sign static information to the DSnF where the static information is considered to remain static during 10.24 s, i.e., the time it takes for the SFN to repeat. Upon reception of the signing request, the DSnF signs the static fields of the SI as well as (i) DSnF starting time for which this set of data is valid, the gNB's SFN value for this DSnF starting time (T_DSnF(gNB's SFN=0)), as well as a short-term public-key that can be used by the UE to verify dynamic data signed by the base station in this period of time of 10.24 s. The DSnF sends this signed data, whose validity is limited to 10.24 s, together with the private key associated with the signed short-term public key to the gNB.
When a period of 10.24 s starts, the gNB starts broadcasting the short-term certificate for this period of time. It is left for normative phase in which SIB this information is broadcasted. Furthermore, the base station broadcast the SI dynamic fields, in particular the SFN, that are signed with the corresponding short-term private key associated to this period of time.
Upon reception of both static and dynamic data, the UE can obtain the time in which the SI has been broadcast (T_Broadcast_SI) as
T_Broadcast_SI = T_DSnF(gNB's SFN=0) + 10*SFN
The UE checks the freshness of T_Received_SI comparing it with its current UE time.
There are two main alternatives for the signing technology used in the short-term certificates:
An option is to use the same type of algorithm as in the DSnF.
NOTE: 	Since the digital signature only needs to remain valid for a short period of time, 10.24 s, the key sizes can likely be shorter, e.g., an ECDSA curve with a length of 224 (equivalent security of 112 bits) might be used instead of a curve of length 256 (equivalent security of 128 bits). This improves performance, e.g., it decreases the communication overhead. Specific parameters are out of scope of the present document and would be defined in the normative phase.
Another option is the use a type of hash chain solution as TESLA. In a concrete instantiation, the DSnF signs the anchor of a hash chain with 64 links assuming that  a hash chain link is needed every 160 ms, i.e., each step of 16 SFNs is linked to a new hash chain link (see note 2). This hash chain is then h64  h63  …h1 h 0  seed where h64 is the public anchor of the hash chain and seed is the secret seed of the hash chain. h0=HASH(seed) and hi = HASH(h{i-1}) with i = 1, …, 64 and HASH() is a cryptographic hash function. The public anchor is signed by the DSnF as part of the static data and is the seed of the hash chain is provided to the gNB in a secure way. When the base station broadcasts a message, it discloses the message authentication code (MAC) that is computed with hash chain link that is only disclosed in the following message. For instance, the first message M0 will contain the current values of dynamic fields denoted here as m0, a MAC of the dynamic fields computed with h63. Next to it, M0 also includes the current hash chain link, in this case, this corresponds to the anchor h64, i.e.,
NOTE 2: 	This fits the periodicity of 160 ms of SIB1 as described in TS 38.213, clause 13. A higher frequency can be used if it decided to sign MIB/SIB1 more frequently in order to allow UEs to take a decision faster regarding the trustworthiness of a base station.
M0 = m0, h64, MAC(m0, h63)
The UE needs to buffer m0 and the MAC that can be verified in the following timeslot (after 160 ms) when the following message M1 = (m1, h63, MAC(m1, h62) is received. In particular, the verification consists in checking: (i) whether h64 = HASH(h63) and the message authentication code is correct.
The following diagram illustrates how MIB and SIB1 are digitally signed by DSnF and how a hash chain is generated and used to verify dynamic fields (e.g., SFN). It shows that MIB can be extended to include some bits of a MAC if not a complete MAC due to its constraint in size, and SIB1 can be extended to include a MAC. When the MAC is included in MIB or SIB1, the corresponding hash key used to generate the MAC may be disclosed in a new SIB that is broadcasted after SIB1. In this way, a UE can verify both static and dynamic fields after acquiring the new SIB.
Figure 6.20.2.2.4-1: Authentication of MIB and SIB1 with a combination of digital signature and TESLA",TR 33.809,6.20.2.2.4,all_images/image_155.jpeg,Authentication of MIB and SIB1 with a combination of digital signature and
"Editor’s note: Applicability of the solution due to message sizes and performance in terms of bandwidth needs is ffs.
Editor’s note: evaluation to be added.
Editor’s note: evaluation under the presence of repeaters is ffs.
KI#2 is about: “investigating if and how a new protection mechanism could be introduced against over-the-air attackers who broadcast rogue SI messages or replay previously captured SI messages as-is (without modification). Since SI messages are broadcast messages meant for all UEs, it is not apparent that an integrity and replay protection is strictly necessary. Nevertheless, in general, an integrity and replay protected SIs could add security value by at least making it difficult for over-the-air attackers to succeed in using a rogue SI or a previously captures SI at a later time, e.g., to lure UEs using SI messages with incorrect neighbouring cells, and to send self-crafted or old PWS messages”
KI#2 includes as potential requirement: “5G system should provide a means to ensure a UE in any RRC state is able to determine the authenticity of system information obtained from a cell.”
This solution addresses both the authenticity and replay protection of system information.
The authenticity is provided by signing system information with a private key only known to the signing party.  Authenticity of the received system information is ensured in any RRC state.
KI#2 acknowledges the difficulty of accurate time synchronization by stating that:  “Time synchronization. It is because of difficulty to achieve fairly acceptable time synchronization between one gNB and other gNBs, and between UEs and gNBs”. When time synchronization is used, the UE has to check whether the received message is fresh compared with its current time. The UE should use a time window to deal with time differences due to, e.g., time synchronization or propagation delay. If the UE and gNB are not perfectly synchronized and time window is:
1) too big, then a MitM can perform replay attacks.
2) too small, then the likelihood of a UE rejecting a trustworthy gNB increases.
Figure 6.26.3-1: Impact of a big or small time window when verifying the freshness of messages. In case 1), the UE might accept a replayed message by a FBS, in case 2) the UE might reject a message coming from a trustworthy gNB if the time window is small and time is not fully synchronized.
Since detecting whether the SI is replayed or not is important but time checks might have some limitations, this solution proposes to apply the Cryptographic CRC solution as soon as feasible by negotiating a symmetric key so that the presence of a MitM replaying messsages is detected as soon as feasible.",TR 33.809,6.26.3,all_images/image_156.jpeg,"Impact of a big or small time window when verifying the freshness of messages. In case 1), the"
"Figure 5..1.2.3.1-1 describes the MCX User Authentication Framework using the OpenID Connect protocol. Specifically, it describes the steps by which an MCX user authenticates to the Identity Management server (IdMS), resulting in a set of credentials delivered to the UE uniquely identifying the MC service ID(s). The means by which these credentials are sent from the UE to the MCX services are described in clause 5.1.3. The authentication framework supports extensible user authentication solutions based on the MCX service provider policy (shown in step 3), with username/password-based user authentication as a mandatory supported method. Other user authentication methods in step 3 (e.g. biometrics, secureID, etc.) are possible but not defined here. A detailed OpenID Connect flow can be found in annex C.
Figure 5.1.2.3.1-1: OpenID Connect (OIDC) flow supporting MCX user authentication
Step 1:	UE establishes a secure tunnel with the Identity Management server (IdMS).
Step 2:	UE sends an OpenID Connect Authentication Request to the IdMS. The request may contain an indication of authentication methods supported by the UE.
Step 3:	User Authentication is performed.
NOTE:	The primary credentials for user authentication (e.g. biometrics, secureID, OTP, username/password) are based on MCX service provider policy. The method chosen by the MCX service provider is neither defined nor limited by the present document.
Step 4:	IdMS sends an OpenID Connect Authentication Response to the UE containing an authorization code.
Step 5:	UE sends an OpenID Connect Token Request to the IdMS, passing the authorization code.
Step 6:	IdMS sends an OpenID Connect Token Response to the UE containing an ID token and an access token (each which uniquely identify the user of the MCX service). The ID token is consumed by the UE to personalize the MCX client for the MCX user, and the access token is used by the UE to communicate the identity of the MCX user to the MCX server(s).",TS 33.180,5.1.2.3.1,all_images/image_160.jpeg,OpenID Connect (OIDC) flow supporting MCX user authentication 
"Figure 5.1.2.3.2-1 shows the OIDC flow when Username/Password is used as the user authentication method.
Figure 5.1.2.3.2-1: OpenID Connect (OIDC) Example Using Username/Password
Step 1:	UE establishes a secure tunnel with the Identity Management server (IdMS).
Step 2:	UE sends an OpenID Connect Authentication Request to the IdMS. The request may contain an indication of authentication methods supported by the UE.
Step 3a:	IdMS sends an HTML form to UE prompting the user for their username & password.
Step 3b:	UE sends the username & password (as provided by the user) to the IdMS.
Step 4:	IdMS sends an OpenID Connect Authentication Response to the UE containing an authorization code.
Step 5:	UE sends an OpenID Connect Token Request to the IdMS, passing the authorization code.
Step 6:	IdMS sends an OpenID Connect Token Response to the UE containing an ID token and an access token (each which uniquely identify the user of the MCX service). The ID token is consumed by the UE to personalize the MCX client for the MCX user, and the access token is used by the UE to communicate the identity of the MCX user to the MCX server(s).",TS 33.180,5.1.2.3.2,all_images/image_161.jpeg,OpenID Connect (OIDC) Example Using Username/Password
"The use of a SIP REGISTER message to provide the access token to the MCX server is shown in figure 5.1.3.2.2-1. The inclusion of an access token in any particular SIP REGISTER message is optional.
Figure 5.1.3.2.2-1: MCX User Service Authorization using SIP REGISTER message
Step 5 of figure 5.1.3.2.2-1 shows the access token message passed to the SIP core in a SIP REGISTER. Upon successful SIP authentication, the SIP core forwards the access token to the MCX server in the third part registration request message (Step 9).
In Steps 9 through 11, the MCX server receives the third part registration request message, validates the access token, binds the IMPU and MC service ID (MCPTT ID, MCVideo ID or MCData ID) if the access token is valid, and responds to the 3rd party registration message.",TS 33.180,5.1.3.2.2,all_images/image_163.jpeg,MCX User Service Authorization using SIP REGISTER message
"The use of a SIP PUBLISH message to provide the access token to the MCX server is shown in figure 5.1.3.2.3-1. The inclusion of an access token in any particular SIP PUBLISH message is optional.
Figure 5.1.3.2.3-1: MCX User Service Authorization using SIP PUBLISH message
As shown in Step 1 of figure 5.1.3.2.3-1, the SIP PUBLISH message carries the access token through the SIP core to the MCX server.
In Steps 2 and 3, the MCX server receives the SIP PUBLISH message, validates the access token, binds the IMPU and MC service ID (MCPTT ID, MCVideo ID or MCData ID) if the access token is valid, and responds to the SIP PUBLISH message.",TS 33.180,5.1.3.2.3,all_images/image_164.jpeg,MCX User Service Authorization using SIP PUBLISH message
"The inter-domain identity management functional model is shown in Figure 5.1.4.2-1.
Figure 5.1.4.2-1: Functional Model for Inter-Domain Identity Management
In Figure 5.1.4.2-1, the IdMS located in the primary Identity Management Domain (MC Domain A) is the home identity management server for the user.  The partner IdMS is located in a second Identity Management Domain (MC Domain B) and provides identity mangement services for the primary user when authorising to partner group services or when the MC user is attempting to migrate.
The CSC-1 reference point between the UE IdM client and the partner IdM server endpoints shall be a direct connection and shall be protected with HTTPS (TLS).
The primary IdMS certificate(s) used to validate the user credentials at the partner IdMS are provisioned into the partner IdMS using an out of band mechanism beyond the scope of this document.
As defined in Clause 5.1.2 an access token is required for user service authorisation.  The same principle applies for inter-domain user service authorisation, in that the MC client must present a valid access token issued from the partner IdMS in MC Domain B for authorisation to services located in MC Domain B.
The inter-domain identity management procedure shall be triggered when an MC client, after performing user service authorisation within the primary Identity Management Domain, determines that the user is a member of a group service that is located in a partner IdMS domain (as indicated in the user profile).
Additionally, the inter-domain identity management procedure shall be triggered when a user attempts to migrate from their primary MC system to a partner MC system.
In order for the MC client to obtain the MC Domain B authorisation access token(s), the token exchange procedure with the primary IdM service (MC Domain A) shall be used to obtain a security token that identifies the user to the partner IdM service.  This security token shall be specific to the partner IdM service and signed by the primary IdM service per IETF RFC 7515 [35].  Upon validation of the security token, the partner IdM service shall provide the access token(s) to the MC client specifically scoped for that user.  The access token(s) shall provide the user with authorisation to the service(s) in the partner Identity Management Domain (MC Domain B) which may include services related to migration.
Figure 5.1.4.2-2 shows the token exchange and authentication procedure.
Figure 5.1.4.2-2:  Token exchange procedure
The token exchange profile for accessing the partner identity management service (steps 1-5 in Figure 5.1.4.2-2) shall consist of [45] and [46] and shall be profiled as defined in Annex B.7.
NOTE:	A specific and independent security token is required for each partner identity management domain.
Within a single MC System with interconnected MC domains, once the MC client obtains the access token specific to the partner group service(s) (step 5 in Figure 5.1.4.2-2), the MC client shall follow the user service authorisation procedure defined in clause 5.1.3 to access the group service(s) within the partner domain.
For migration of an MC user from their primary MC domain to a partner MC domain, once the MC client obtains the access token specific to the partner MC system (step 5 in Figure 5.1.4.2-2), the MC client shall follow the user service authorisation procedure defined in clause 5.1.5.
The token exchange procedure shall be repeated for each partner identity management domain where the MC client requires access and authorisation to group service(s) within that partner MC domain or when the user migrates from their primary MC system to a partner MC system.
Annex C.2 shows the detailed flow for inter-domain MC user service authorization using the OAuth 2.0 token exchange procedure.",TS 33.180,5.1.4.2,all_images/image_165.png,Functional Model for Inter-Domain Identity Management
"The security mechanism described in this clause extends that defined in clause 5.2.2 to provide end-point key diversity. The mechanism is identical to that described in clause 5.2.2, except for the distribution of K-ID. Contrary to clause 5.2.2, the key is distributed with an end-point-specific key identity (UK-ID) (e.g. a GUK-ID) derived from the key id (K-ID). This allows the receiving entity of the key distribution to diversify the shared key for end-point-specific use.
Specific types of key require use of end-point key diversity. The type of key is defined by the 'purpose tag' within the key identifier stored in the CSB-ID field of the MIKEY payload. Hence on receipt of a key, the contents of the CSB-ID field instruct the receiving entity whether end-point diversity should be applied to the key.
The key, K, is distributed encrypted specifically to the receiving entity and signed by the initiating entity as described in clause 5.2.2. The key is distributed with a 32-bit entity-specific Key Identifier (UK-ID) derived from a common key id (K-ID) and a salt (which is derived from the receiving entity's MCX URI). The security domain parameters are provided in the public values in the certificate received from the KMS.
The payload includes the entity-specific Key Identifier (UK-ID) within the CSB-ID field. The key, K, is identified by a Key Identifier (K-ID) from which the UK-ID is derived. On creating the key, K, the initiating entity generates a K-ID as follows. The 4 most significant bits of the K-ID is the 'purpose tag' which defines the purpose of the key. The 28 least significant bits of the K-ID is a 28-bit randomly-generated value.
For each receiving entity, the initiating entity creates a 28-bit Salt by hashing the receiving entity's URI through a KDF using the key, K, as the key (as defined in Annex F.1.3). The Salt is xor'd with the 28 least-significant bits of the K-ID to create the 32-bit UK-ID.
NOTE:	Knowledge of the UK-ID, K-ID and Salt does not reveal the receiving entity URI to those without the key K.
The process for generating the UK-ID is summarized in figure 5.2.3-1.
Figure 5.2.3-1: Generating the UK-ID
The UK-ID is placed in the CSB ID field within the header of the I_MESSAGE. The security processes are summarized in figure 5.2.3-2.
Figure 5.2.3-2: Common key distribution mechanism with end-point diversity
At the receiving MCX entity, the initiating entity's URI is extracted from the initiator field (IDRi) of the message. Along with the time, this is used to check the signature on the payload. If valid, the receiving entity extracts and decrypts the encapsulated key, K, using the (KMS-provisioned) entity's UID key.
The receiving MCX entity also extracts UK-ID from the CSB-ID field of the I_MESSAGE. If the 'purpose tag' of the UK-ID indicates that end-point diversity is applied, the receiving entity generates the Salt using its URI and the decrypted key, K. The receiving entity xors the UK-ID and Salt together to obtain the K-ID. The K-ID and UK-ID are stored.
The extraction procedure is described in figure 5.2.3-3.
Figure 5.2.3-3: Common key extraction mechanism with end-point diversity",TS 33.180,5.2.3,all_images/image_169.png,Common key extraction mechanism with end-point diversity
"The key distribution mechanisms described in Clause 5.2.2 and clause 5.2.3 may be extended to include data associated with the key in the MIKEY I_MESSAGE. This data is stored within a format known as 'associated parameters' and defined in Annex E.6.
The associated parameters are encrypted using K, the key distributed within the MIKEY I_MESSAGE. The security mechanism is summarised in Figure 5.2.4-1.
Figure 5.2.4-1: Common key distribution mechanism with associated parameters
At the receiving MCX entity, the initiating entity's URI is extracted from the initiator field (IDRi) of the message. Along with the time, this is used to check the signature on the payload. If valid, the receiving entity extracts and decrypts the encapsulated key, K, using the (KMS-provisioned) receiving entity's decryption key.
The receiving MCX entity also extracts 'associated parameters' payload from the I_MESSAGE. The receiving entity uses the decrypted key, K, to decrypt these associated parameters. The receiving entity stores these parameters with the distributed key, K. If the Status field within the ‘associated parameters' payload indicates the key has been revoked, the distributed key, K, and the K-ID shall not be used. If the decryption process for the encapsulated associated parameters fails, the key is rejected.
The security mechanism is summarised in Figure 5.2.4-2.
Figure 5.2.4-2: Common key extraction mechanism with associated parameters",TS 33.180,5.2.4,all_images/image_171.png,Common key extraction mechanism with associated parameters
"The key distribution mechanism defined in clauses 5.2.2, 5.2.3 and 5.2.4 may be extended to allow the initiating entity to be able to decrypt the distributed key, K contained within the payload.
NOTE:	Where the initiating entity is an MCX user logged into multiple devices, this extension is necessary to allow all devices to obtain the key, K and decrypt any subsequent communication.
In addition to encrypting the key, K, to the receiving entity, the key is also encrypted to the initiating entity. The UID used to encrypt the data is derived from the initiating entity's URI (e.g. sip:user.002@mcptt.example.org) and a time-related parameter (e.g. the current year and month). The encapsulated key is added to a SAKKE-to-self payload within the MIKEY I_MESSAGE. No other payloads (e.g. IDRr) are affected.
Figure 5.2.5-1: Common key distribution mechanism with SAKKE-to-self payload",TS 33.180,5.2.5,all_images/image_172.png,Common key distribution mechanism with SAKKE-to-self payload
"The key distribution mechanism defined in clauses 5.2.2, 5.2.3, 5.2.4 and 5.2.5 may be extended to allow identities to be masked within the MIKEY payload. This is achieved by adding the UID, rather than the URI to the payload as described in Annex E.7 and shown in figure 5.2.6-1.
Figure 5.2.6-1: Common key distribution mechanism with identity hiding
On receipt of a MIKEY payload with identities hidden, the receiving entity should recognise the receiver UID in the packet. If not, the I_MESSAGE shall be rejected. Based on the initiator UID, the receiver checks the validity of the I_MESSAGE signature. At this point the initiator is anonymous to the receiver. If this check fails, the I_MESSAGE shall be rejected. The receiver then extracts the key K. This may be used to decrypt other parts of the packet and extract the initiator URI. Once the initiator URI is extracted, this shall be used to generate the initiator UID and check that it is the one provided in the I_MESSAGE. If not, the I_MESSAGE shall be rejected. This procedure is shown in figure 5.2.6-2
Figure 5.2.6-2: Common key extraction mechanism with identity hiding",TS 33.180,5.2.6,all_images/image_174.png,Common key extraction mechanism with identity hiding
"The following private communication security procedures provide a mechanism for establishing a security context as part of the Private Call Request sent from the initiating UE to the terminating UE.
3GPP TS 23.379 [2] describes manual and automatic commencement for private MCPTT communications in both a single MC system and across multiple MC systems, while 3GPP TS 23.281 [37] describes manual and automatic commencement for private MCVideo communications within a single MC system.
Securing of on-network private MCPTT or MCVideo communications is summarized in the following sub clauses and applies to the aforementioned MCPTT and MCVideo private call use cases.
The private call setup message used to establish these security procedures may be pre-generated to increase the efficiency of the communication.  Additionally, the MC UE may attach a second SAKKE component which encrypts the PCK to the initiating user (in addition to the terminating user) for use in the ‘SAKKE-to-self' procedure.
The security procedure for an on-network MCPTT or MCVideo private call within a single MC system is summarized in figure 7.2.2-1,  The security procedure for securing an on-network MCPTT private call between multiple MC systems is summarized in figure 7.2.2-2. The intent of these on-network security procedures is to transfer a PCK and PCK-ID to the terminating UE in order to provide end-to-end security of the media.
Figure 7.2.2-1: Private call security procedure for on-network PCK distribution for single domain
The procedure in figure 7.2.2-1 is now described step-by-step.
0.	Prior to beginning this procedure it is assumed that the MC UEs have an authenticated MC user and that the MC UEs have been provisioned with key material associated with a user's MC service ID by a KMS as described in clause 5.3.
1.	The initiating MC UE generates the PCK and sends a private call request to the terminating MC UE. The message is sent to the primary MC server of the initiating UE where it is forwarded to the intended receipient UE. Within this message includes an SDP offer which contains a MIKEY-SAKKE I_MESSAGEs as defined in IETF RFC 6509 [11]. The I_MESSAGE encapsulates the PCK for the terminating MC user, encrypting the key to the UID of the terminating user (derived from the user's URI). The I_MESSAGE also contains an identifier for the PCK (PCK-ID). The I_MESSAGE is signed using (the key associated with) the initiating user's UID.
a)	If the choice of initiator KMS (IDRkmsi) or receiver KMS (IDRkmsr) within the MIKEY message is unacceptable, a KMS Redirect Response may be returned to the initiating client providing KMS information. In this case, the initiating client may re-attempt the above procedures.
2.	Further session signalling occurs as defined in 3GPP TS 23.379 [2] for MCPTT and 3GPP TS 23.281 [39] for MCVideo.
Figure 7.2.2-2: Private call security procedure for on-network PCK distribution between multiple domains
The procedure in figure 7.2.2-2 is now described step-by-step.
0.	Prior to beginning this procedure it is assumed that the MC UEs have an authenticated MC user and that the MC UEs have been provisioned with key material associated with a user's MC service ID by a KMS as described in clause 5.3.
1.	The initiating MC UE generates the PCK and sends a  private call request addressed to the terminating MC UE. The message is first routed to the primary MC server of the initiating UE.  The primary MC server routes the private call request to the partner server (home of the intended receipient UE), which is then routed to the receipient UE. The private call request message includes an SDP offer which contains a MIKEY-SAKKE I_MESSAGE as defined in IETF RFC 6509 [11]. The I_MESSAGE encapsulates the PCK for the terminating MC user, encrypting the key to the UID of the terminating user (derived from the user's URI). The I_MESSAGE also contains an identifier for the PCK (PCK-ID). The I_MESSAGE is signed using (the key associated with) the initiating user's UID.
a)	If the choice of initiator KMS (IDRkmsi) or receiver KMS (IDRkmsr) within the MIKEY message is unacceptable, a KMS Redirect Response may be returned to the initiating client providing KMS information. In this case, the initiating client may re-attempt the above procedures.
2.	Further session signalling occurs as defined in 3GPP TS 23.379 [2].
It is possible that the terminating MC client may be represented by an MC Security Gateway (as defined in Annex L), rather than using full end-to-end security. In this case, the user's KMS Certificate will have the ‘IsSecurityGateway' attribute set to ‘true' (see clause D.3.2.2). Should the terminating client be represented by an MC Security Gateway, the initiating MC client shall warn the MC user that an MC Security Gateway is in use during the private call.
With the PCK and PCK-ID shared between the initiating and terminating users, the media communicated between the UEs may be end-to-end protected using the PCK.",TS 33.180,7.2.2,all_images/image_176.png,Private call security procedure for on-network PCK distribution for single domain
"The following private communication security procedures provide a mechanism for establishing a security context as part of the Private Call Request sent from the initiating UE to the terminating UE.
3GPP TS 23.379 [2] describes manual and automatic commencement for private MCPTT communications in both a single MC system and across multiple MC systems, while 3GPP TS 23.281 [37] describes manual and automatic commencement for private MCVideo communications within a single MC system.
Securing of on-network private MCPTT or MCVideo communications is summarized in the following sub clauses and applies to the aforementioned MCPTT and MCVideo private call use cases.
The private call setup message used to establish these security procedures may be pre-generated to increase the efficiency of the communication.  Additionally, the MC UE may attach a second SAKKE component which encrypts the PCK to the initiating user (in addition to the terminating user) for use in the ‘SAKKE-to-self' procedure.
The security procedure for an on-network MCPTT or MCVideo private call within a single MC system is summarized in figure 7.2.2-1,  The security procedure for securing an on-network MCPTT private call between multiple MC systems is summarized in figure 7.2.2-2. The intent of these on-network security procedures is to transfer a PCK and PCK-ID to the terminating UE in order to provide end-to-end security of the media.
Figure 7.2.2-1: Private call security procedure for on-network PCK distribution for single domain
The procedure in figure 7.2.2-1 is now described step-by-step.
0.	Prior to beginning this procedure it is assumed that the MC UEs have an authenticated MC user and that the MC UEs have been provisioned with key material associated with a user's MC service ID by a KMS as described in clause 5.3.
1.	The initiating MC UE generates the PCK and sends a private call request to the terminating MC UE. The message is sent to the primary MC server of the initiating UE where it is forwarded to the intended receipient UE. Within this message includes an SDP offer which contains a MIKEY-SAKKE I_MESSAGEs as defined in IETF RFC 6509 [11]. The I_MESSAGE encapsulates the PCK for the terminating MC user, encrypting the key to the UID of the terminating user (derived from the user's URI). The I_MESSAGE also contains an identifier for the PCK (PCK-ID). The I_MESSAGE is signed using (the key associated with) the initiating user's UID.
a)	If the choice of initiator KMS (IDRkmsi) or receiver KMS (IDRkmsr) within the MIKEY message is unacceptable, a KMS Redirect Response may be returned to the initiating client providing KMS information. In this case, the initiating client may re-attempt the above procedures.
2.	Further session signalling occurs as defined in 3GPP TS 23.379 [2] for MCPTT and 3GPP TS 23.281 [39] for MCVideo.
Figure 7.2.2-2: Private call security procedure for on-network PCK distribution between multiple domains
The procedure in figure 7.2.2-2 is now described step-by-step.
0.	Prior to beginning this procedure it is assumed that the MC UEs have an authenticated MC user and that the MC UEs have been provisioned with key material associated with a user's MC service ID by a KMS as described in clause 5.3.
1.	The initiating MC UE generates the PCK and sends a  private call request addressed to the terminating MC UE. The message is first routed to the primary MC server of the initiating UE.  The primary MC server routes the private call request to the partner server (home of the intended receipient UE), which is then routed to the receipient UE. The private call request message includes an SDP offer which contains a MIKEY-SAKKE I_MESSAGE as defined in IETF RFC 6509 [11]. The I_MESSAGE encapsulates the PCK for the terminating MC user, encrypting the key to the UID of the terminating user (derived from the user's URI). The I_MESSAGE also contains an identifier for the PCK (PCK-ID). The I_MESSAGE is signed using (the key associated with) the initiating user's UID.
a)	If the choice of initiator KMS (IDRkmsi) or receiver KMS (IDRkmsr) within the MIKEY message is unacceptable, a KMS Redirect Response may be returned to the initiating client providing KMS information. In this case, the initiating client may re-attempt the above procedures.
2.	Further session signalling occurs as defined in 3GPP TS 23.379 [2].
It is possible that the terminating MC client may be represented by an MC Security Gateway (as defined in Annex L), rather than using full end-to-end security. In this case, the user's KMS Certificate will have the ‘IsSecurityGateway' attribute set to ‘true' (see clause D.3.2.2). Should the terminating client be represented by an MC Security Gateway, the initiating MC client shall warn the MC user that an MC Security Gateway is in use during the private call.
With the PCK and PCK-ID shared between the initiating and terminating users, the media communicated between the UEs may be end-to-end protected using the PCK.",TS 33.180,7.2.2,all_images/image_177.png,Private call security procedure for on-network PCK distribution between multiple
"Figure 7.2.4.3-1 below illustrates the first-to-answer call setup procedure with security.
Figure 7.2.4.3-1: First-to-answer call setup and key management
1 to 6.	First-to-answer call signalling occurs as defined in TS 23.379 [2]. These messages do not contain security-related key material.
7.	MCPTT user at MCPTT client 2 accepts the call, which causes the MCPTT client 2 to send a first-to-answer call response to the MCPTT server. Included in the response, is the PCK (PCK_1) encapsulated to the user associated with the initiating client, MCPTT client 1.  The PCK is then included in the SDP content of the response.
NOTE 1:	If the choice of initiator KMS (IDRkmsi) or receiver KMS (IDRkmsr) within the MIKEY message is unacceptable, a KMS Redirect Response may be returned to the responding client providing KMS information. In this case, the responding client may re-attempt the above procedures.
8.	The MCPTT server forwards the first-to-answer call response to MCPTT client 1 indicating that the MCPTT user at MCPTT client 2 has accepted the call. MCPTT client 1 extracts the PCK from the message.
9.	The media plane for communication is now established and protected with the shared PCK.
10. MCPTT user at MCPTT client 3 accepts the call and sends a first-to-answer call response to the MCPTT server. MCPTT client 3 also includes an encapsulated PCK (PCK_2) in the response.
11. Since the first-to-answer call response from MCPTT client 2 has already been accepted, the MCPTT server sends a MCPTT first-to-answer call cancel request to MCPTT client 3. The encapsulated PCK provided by MCPTT client 3 (PCK_2) is discarded.
12-16. First-to-answer call signalling occurs as defined in TS 23.379 [2]. These messages do not contain security-related key material.",TS 33.180,7.2.4.3,all_images/image_178.jpeg,First-to-answer call setup and key management
"The MCPTT group regroup security procedure (shown below in figure 7.3.3.3-1) involves multiple MC users from multiple MC domains and is an integrated component of the MCPTT group regrouping procedure described in clause 10.2.4.2 of 3GPP TS 23.280 [36].
Figure 7.3.3.3-1: Group regroup security procedure (multiple MC domains)
Prior to beginning the procedure, the MC UEs, primary GMS and partner GMS are provisioned by a KMS as described in clause 5.3.
1-5:	These steps are as defined in clause 10.2.4.2 of 3GPP TS 23.280 [36].
6:	To create the security context for the temporary group, the primary GMS creates a new GMK and GMK-ID for the temporary group along with other group related information.
7,8:	The primary GMS notifies the partner GMS of the group regroup operation. The primary GMS includes a Group Key Transport payload following the procedures in clause 5.7, treating the partner GMS as another user within the group. Accordingly, the payload encrypts the new GMK to the identity of the partner GMS and is signed using the identity of the primary GMS. The GUK-ID is derived using the User Salt generated from the partner GMS's URI.
NOTE 1:	If the choice of initiator KMS (IDRkmsi) or receiver KMS (IDRkmsr) within the MIKEY message is unacceptable, a KMS Redirect Response may be returned to the primary GMS providing KMS information. In this case, the primary GMS may re-attempt the above procedures.
9,10:	These steps are as defined in clause 10.2.4.2 of 3GPP TS 23.280 [36].
11:	The partner GMS extracts the GMK and GMK-ID from the notification. The partner GMS then notifies the affiliated users within the partner MC domain. The partner GMS re-encrypts the GMK to the identity of the affiliated users in the partner system, generates new GUK-IDs for each user and signs using its identity (the identity of the partner GMS) following the procedure in clause 5.7.
12,13:	These steps are as defined in clause 10.2.4.2 of 3GPP TS 23.280 [36].
14:	The primary GMS notifies the affiliated users within its own MC domain. The primary GMS includes a Group Key Transport payload including a GMK and GUK-ID following the procedures in clause 5.7. The GMK is encrypted to the identity of the MC user and is signed using the identity of the primary GMS.
15:		This step is as defined in clause 10.2.4.2 of 3GPP TS 23.280 [36].
It is possible that a partner GMS may be represented by an MC Security Gateway (as defined in Annex L), rather than using full end-to-end security. In this case, the partner GMS's KMS Certificate will have the ‘IsSecurityGateway' attribute set to ‘true' (see clause D.3.2.2). Should a partner GMS be represented by an MC Security Gateway, the primary GMS shall indicate to all group users and partner GMS(s) that the GMK is shared with an MC Security Gateway. This is achieved by setting the ‘Security Gateway' bit in the ‘Status' field of the GMK's key parameters (see clause E.6.9).",TS 33.180,7.3.3.3,all_images/image_181.jpeg,Group regroup security procedure (multiple MC domains)
"A MC gateway server is part of the mission critical architecture for interconnection as defined in 3GPP TS 23.280 [36]. The MC gateway server includes an IS Proxy for inter-domain security as defined in Annex I.  The IS Proxy provides protection of the SIP-3 interface (i.e. SIP payload and RTCP protection using a SPK as defined in clause 9 and clause 6.3.2).  The SIP-3 interface is covered as part of the interconnection MCX-1 reference point.
Figure 11.1.3-1 shows an interconnection architecture between two MC domains (MC domain A and MC Domain B) each with the MC gateway server which contains the IS proxy for interconnection security.  The MC gateway provides the necessary topology hiding and address translation along with signalling protection via the IS proxy.  HTTP communications for interconnection over the HTTP-3 reference point are provided for via the HTTP proxy as described in 3GPP TS 23.280 [36] and protected as defined in clause 6.1.3 of this specification.
Figure 11.1.3-1: Interconnection security using MC gateway with HTTP and IS proxies
In Figure 11.1.3-1, the interface between the MC domains shall be protected hop-by-hop as defined in Clause 6.3.2. The SIP-3 interface between IS Proxies may be protected at the application layer using a shared SPK as defined in Clause 9 and the HTTP-3 interface between HTTP Proxies may be protected using TLS as defined in Clause 6.1.3.For interconnection communications with an MC gateway server (e.g. MC domain A to MC domain B in this example), HTTP and SIP messages are sent by an MC service server or a server in the common services core within the MC domain, towards the MC gateway server or HTTP proxy for processing, protection, and external routing to a partner MC domain.
For HTTP messages, the HTTP proxy applies topology hiding by replacing the internal to/from addresses in the HTTP message with the associated external HTTP routing addresses. The HTTP proxy determines the target HTTP proxy for MC domain B and choses the certificates appropriate for that TLS tunnel. The HTTP message is protected and sent towards MC domain B on the HTTP-3 interface.  The HTTP proxy in MC domain B receives the HTTP message where it is decrypted from the external TLS tunnel. The HTTP proxy in MC domain B then replaces any external HTTP routing addresses with internal HTTP addresses applicable to MC domain B and forwards the message to the appropriate server within MC domain B.
For SIP messages, the MC gateway server in MC domain A applies topology hiding by replacing the internal to/from SIP addresses (e.g. Public Service Identities) in the SIP header with the associated external SIP routing addresses and passes the SIP message to the MC gateway IS proxy. The IS proxy removes any internal SIP payload encryption, then based on the target MC domain (MC domain B) selects the appropriate inter-domain SPK to re-encrypt the SIP payload(s). The SIP message is then sent towards the MC gateway server in MC domain B over the SIP-3 interface where the MC gateway IS proxy in MC domain B receives the SIP message and decrypts it using the inter-domain SPK it has in common with MC domain A. The IS proxy in MC domain B may then re-encrypt the SIP payload(s) with an internal MC domain B SPK. The topology hiding function of the MC gateway server in MC domain B then replaces the external SIP routing addresses with internal SIP addresses applicable to MC domain B and forwards the message to the appropriate server within MC domain B.",TS 33.180,11.1.3,all_images/image_183.png,Interconnection security using MC gateway with HTTP and IS proxies
,TR 33.866,6.4.2,all_images/image_184.jpeg,Service consumer authorization for DCCF selected Service Producers
"This solution proposes to use existing SBA mechanism for confidentiality protection, integrity protection, and replay-protection on the new interfaces between 3GPP entities and the MFAF.
This solution also proposes a procedure for the confidentiality, integrity, and replay protection of the transferred data against the Messaging Framework in case that the collected data is not requested to be formatted/processed.
For the same type of data collection, the DCCF can manage an encryption key and an integrity key. The DCCF provides the keys to the data consumer and the data producer. The data producer will use the keys to encrypt the data and generating the MIC (Message Integrity Code), while the data consumer will use the key to decrypt the data and check the MIC. In such way, the data will not be revealed to the Messaging Framework and any modification of the data can be detected. In case a new Data Consumer subscribes to the same type of data where a notification procedure is already ongoing, then a key refresh procedure is carried out. In the following the term subscription ID is used, where the subscription ID includes information to identify the Data required (e.g. a set of Event ID(s) from Data Producer NF), information to identify the UE (single UE, group of UE(s) or any UE), optionally information to identify the data producer, and filtering information such as location area or time of day where data is required from.
Our solution is exemplified using the steps of the solution shown in Figure 6.5.2-1 based on the procedure shown in Figure 6.2.6.3.4-1 in TS 23.288 [4]. Our solution steps are marked as bold, as additional steps to this example procedure.
Figure 6.5.2.0-1: Protection of data sent via the messaging framework
1.	The data consumer-1 subscribes to data via the DCCF by invoking the Ndccf_DataManagement_Subscribe (Service_Operation, Data Specification, NF (or NF-Set) ID, ADRF Information, Data Consumer Notification Target Address (+ Notification Correlation ID)) service operation as specified in clause 8.2.2 in [4]. The data consumer may specify one or more notification endpoints and the NF or NF set to collect data from.
Service_Operation is the service operation to be used by the DCCF to request data (e.g. Namf_EventExposure_Subscribe or OAM Subscribe). Data Specification provides Service_Operation-specific required parameters (e.g. event IDs, UE-ID(s), target of event reporting) and optional input parameters used to retrieve the data. The data consumer may optionally include the Data Source NF Instance (or NF Set) ID and ADRF information indicating whether the data are to be stored in an ADRF and, optionally, an ADRF ID.
2.	If the NF instance or NF Set ID is not provided by the data consumer, the DCCF determines the NF instances that can provide data as described in clause 5A.2 and clause 6.2.2.2 in [4]. If the consumer requested storage of data in an ADRF, but the ADRF ID is not provided by the data consumer, or the collected data is to be stored in an ADRF according to configuration on the DCCF, the DCCF selects an ADRF to store the collected data.
3.	The DCCF determines the Data Source (e.g. AMF-1) that can provide the data and checks that the requested data is not already being collected.
If the requested data is not being collected yet, then the DCCF generates a data encryption key KE and a data integrity key KI. The DCCF will keep a mapping between the subscription (Identified by a Subscription ID) and the pair of keys.
4.	The DCCF sends an Nmfaf_3daDataManagement_ Configure (Data Consumer Information, MFAF Notification Information) to configure the MFAF to map notifications received from the Data Source to outgoing notifications sent to endpoints.
Data Consumer Information contains for each notification endpoint, the data consumer Notification Target Address (+ Data Consumer Notification Correlation ID to be used by the MFAF when sending notifications in step 8.
4a. The DCCF sends the subscription response to the Data Consumer-1. In the response, the DCCF provides key KE and key KI as well as a Subscription ID.
5.	The DCCF subscribes to data from the NF using the Nnf_EventExposureSubscribe (Data Specification, MFAF Notification Target Address (+ MFAF Notification Correlation ID)) service operation as specified in clause 5A.2 and clause 6.2.2.2 in [4], using the MFAF Notification Target Address (+ MFAF Notification Correlation ID) received in step 4. The DCCF adds the data consumer to the list of data consumers that are subscribed for these data.
The request also includes key KE and a data integrity key KI.
6.	The Data Source acknowledges the request with a Subscription ID.
7.	When new output data are available, the Data Source uses Nnf_EventExposure_Notify to send the data to the MFAF. The Notification includes the MFAF Notification Correlation ID.
The data source associates the data with a Sequence Number. The data source encrypts the data using KE and protects the integrity of the data by including a MIC (Message Integrity Code). The data source computes the MIC as HASH KI (data || Sequence Number).
8.	The MFAF uses Nmfaf_3caDataManagement_Notify to send the data to all notification endpoints indicated in step 4. Notifications are sent to the Notification Target Address(es) using the Data Consumer Notification Correlation ID(s) received in step 4. The MFAF may store the information in ADRF if requested by consumer or if required by DCCF configuration.
The message also includes the Sequence number received in step 7.
When Data Consumer-1 receives the data, it will check the data integrity and decrypt the data.
9.	Data Consumer-2 (e.g.: NWDAF-2) sends a request for the same Data via the DCCF by invoking the Ndccf_DataManagement_Subscribe. The message may indicate whether the requested data should be sent to Data Consumer-2, and/or to other Consumers such as Data Repository. The Notification Correlation ID of Consumer-2 is included for notifications sent to Data Consumer-2.
10.	The DCCF determines that the requested data is already being collected from a Data Source (e.g.: AMF-1).
10a. (If key refresh is needed) The DCCF initiates a key refresh procedure for the data as described in Figure 6.5.2.2-1.
10b-12. Same procedure as in step 4a-7 for Data Consumer-2.
13-14. Same procedure as in step8 for Data Consumer-1 and Data Consumer-2.
When the DCCF provides the key KE and key KI, it also maintains a timer for renewing the keys. When DCCF decides to renew the keys, it will send to the data consumer a message with the new keys associated with the Subscription ID mentioned in step 4a. When the DCCF sends the new keys to the data consumer, it put the Subscription ID mentioned in step 6 in the message.",TR 33.866,6.5.2.0,all_images/image_185.jpeg,Protection of data sent via the messaging framework
"The procedure depicted in Figure 6.7.2.2-1 allows a consumer to request analytics from NWDAF for anomalous NF behaviour and its root cause.
Figure 6.7.2.2-1: NF anomalous behaviour analytics provided by NWDAF using security logs obtained from NFs EventExposure APIs
1.	The OAM or operator's AF sends a request/subscription to the NWDAF for NF anomalous behaviour analytics using either the Nnwdaf_AnalyticsInfo_Request or Nnwdaf_AnalyticsSubscription_Subscribe service operation.
2.	If the request is authorized, and in order to provide the requested analytics, the NWDAF may subscribe to OAM services to retrieve resource usage and NF resources configuration of all targeted NF instances, following the procedure specified in clause 6.2.3.2 in TS 23.288 [4].
3a.	The NWDAF subscribes to NRF to receive notification on changes, e.g., on the load and status of NF instances registered in NRF, using Nnrf_NFManagement_NFStatusSubscribe service operation for all targeted NF instances. NF instances are identified by their NF id.
3b.	NRF notifies NWDAF of changes on the load and status of the requested NF instances by using Nnrf_NFManagement_NFStatusNotify service operation.
4a.	The NWDAF subscribes or requests the additional security specific log info (as specified in the table 6.7.2.3-1) for a particular NF by invoking the Nnf_EventExposure_Subscribe service operation.
4b.	The NF then notifies the NWDAF (e.g. with the complete log report) by invoking Nnf_EventExposure_Notify service operation.
5.	The NWDAF derives the relevant analytics using the inputs provided by the OAM, NRF, and the NF (as specified in the table 6.7.2.3-2)
6.	The NWDAF provides requested NF anomalous information along with the corresponding root cause (for instance a malicious NF trying to attack other NF for denial of service, or an erroneous NF unable to provide service to other NFs) using either the Nnwdaf_AnalyticsInfo_Request response or Nnwdaf_AnalyticsSubscription_Subscribe response, depending on the service used in step 1.",TR 33.866,6.7.2.2,all_images/image_186.jpeg,NF anomalous behaviour analytics provided by NWDAF using security logs obtained
"To protect the sensitive and private information of the user, a privacy framework is introduced By this, different privacy rules can be applied by different operators/vendors based upon specific policies and requirements, e.g. by local policy.
The privacy rules can be stored in the home network in
- 	UDM/UDR if privacy is configured per subscriber, or
-	NRF if privacy is generic for all the subscribers of one or several NFs.
User privacy policies and rules can be retrieved from UDM. NRF can also push this information to NFs.
Service requests related to User data need to be indicated, e.g. by an IE 'DataPurposeID'. The NF Service Consumer (i.e. requester NWDAF1 NF) needs to send this 'DataPurposeID' along with the request to the NF Service Producer (e.g. NWDAF2). Based on this IE, the NWDAF2 will process privacy related data accordingly to the specific policy or requirement valid in this operator network, before sending a service response to the requester NWDAF1.
Figure 6.8.2-1: Generic Procedure to preserve user privacy based upon the predefined policies
Step 0: If an operator configures the privacy rules in the NRF (generic for all subscribers), then the NRF can push the policy/rules to NF in the response of registration/heartbeat. A heartbeat message is sent by NFs every some seconds (i.e. 10-20 seconds). Therefore whenever the privacy rule is changed in the NRF, the NRF can push updated rules to the NFs.
Step 1: NWDAF1 sends a user data request to NWDAF 2 (Sending NWDAF Instance) with an additional IE DataPurposeID indicating the purpose.
NOTE 1: 	DataPurposeID specifies the purpose of the user data request corresponding to an analytics ID. For instance, the DataPurposeID can be 'Advertisement' corresponding to the user data request of analytics ID 'location'.
Step 2: NWDAF2 sends a request to retrieve the user privacy policies for a specific subscriber from the UDM/UDR. Or it can use the locally configured policies based upon the operator's or geographical requirements.
Step 3: UDM/UDR sends the privacy policies configured for the subscriber either by the operator or by the user or based upon the privacy local policy for a specific geographical region.
Note 2: 	Not addressed in the present document what is privacy local policy of a specific geographical region.
Step 4: NWDAF2, after receiving the policies, applies them to the requested user data for the DataPurposeID. For instance, because of the privacy policy it can either reject the request completely or it sends the data without or with anonymization. The latter preserves the sensitive information of the user. Policies received in Step 0 are also applied along with policy received in Step 3.
Note 3: 	Not addressed in the present document ""DataPurposeID"" in relation with privacy.
Step 5: NWDAF2 sends the processed data to NWDAF1 as a response to the initial request.",TR 33.866,6.8.2,all_images/image_188.jpeg,Generic Procedure to preserve user privacy based upon the predefined policies
,TR 33.866,6.10.2,all_images/image_189.jpeg,Service Consumer Authorization to receive data from Service Producers via DCCF
,TR 33.866,6.10.2,all_images/image_190.jpeg,Service Consumer Authorization to receive data from Service Producers via MFAF
"NF Service consumer (e.g. NWDAF) accesses the services of DCCF using the existing SBI mechanisms. NF Service Producer (or Data producer) when sending the data to the NF Service Consumer, may also send the data to ADRF for storage and archiving if requested/subscribed to by ADRF (e.g. based on a requested by the NF Service Consumer or the DCCF). Alternatively, the Messaging Framework may be configured by DCCF to forward a copy of the data to ADRF.
The NF Service Producer (Data Producer), when sending the data to the ADRF also appends its own NF type and its own NF Instance ID as metadata to the data which is sent for archiving. If NF Service Producer does not add this metadata, then DCCF may add this information before sending it to the ADRF.
The access token get request sent from DCCF to NRF to request the desired data on behalf of the NF Service Consumer contains the following information: NF Instance IDs of the NF Service Consumer (e.g. NWDAF) and the DCCF, NF Type (or NF Instance ID) of the NF Service Producers (i.e. ADRF and the Data Producer).
NRF after verifying the request, authorizes the NF Service Consumer to request the data and adds in the access token claims the NF Type (or the NF Instance ID) of the NF Service Producers (i.e. the ADRF and the Data Producer).
The ADRF when receiving the request from DCCF (based on a request from the NF Service Consumer) verifies the access token generated by ensuring that the NF Type (or NF Instance ID) matches that of ADRF, and the NF Type (or NF Instance ID) of the Data Producer matches the metadata information that was earlier appended by the Data Producer (or DCCF or MFAF) when archiving the data. Only after a successful verification, ADRF sends the data to the NF Service Consumer via DCCF (or MFAF).
The detailed procedures are depicted in Figure 6.11.2-1 (without MFAF) and Figure 6.Y.2-2 (with MFAF).
Procedure 1: Service Consumer Authorization to receive data from ADRF via DCCF (without MFAF)
Figure 6.11.2-1: Service Consumer Authorization to receive data from ADRF via DCCF(without MFAF)
Step 0. ADRF subscribes/requests data from data producer (directly or via DCCF).
Step 1. NF Service Producer (data producer) sends the data to ADRF (directly or via DCCF) and may add metadata information containing Source NF Type as its own NF Type and Source NF Instance ID as its own Instance ID.
Step 2. If, in step 1, the data is sent via DCCF and the data producer did not add its metadata, then DCCF when forwarding the data to ADRF, adds the metadata related to the data producer (i.e. NF type and NF Instance ID) prior to sending the data to ADRF for storage.
NOTE 1: 	Steps 1-2 ensure that the NF Service Producer information from which the data was collected is present in the ADRF. If the information is already present, Steps 1-2 are not needed, and the procedure defined in Clause 6.2.6.3.3 in TS 23.288 is followed.
Step 3. NF Service consumer (data consumer) sends request to DCCF to get historical data (as specified in clause 6.2.6.3.3, TS 23.288 [4]) with optionally also providing the NF Type (or NF Instance ID) of the target NF Service Producer (or data producer). The request also contains the access token to request services from DCCF and CCA of NF Service Consumer.
Step 4. DCCF, after verifying that the NF Service Consumer is authorized to access the services of DCCF, sends to NRF an access token request to collect historical data from data producer(s) including the information to identify the target NFs (NF Service Producer (i.e. ADRF) and data producer), the source NF (DCCF, NF Service Consumer) and the CCA provided by the NF Service Consumer
NOTE 2: Both ADRF and data producer info is needed in the access token request as target NFs, since DCCF is consuming ADRF services, and the data producer audience claim is required for the ADRF to verify if the data consumer and DCCF are authorized to receive the data belonging to a data producer,
Step 5. The NRF determines whether the DCCF and the NF Service Consumer are allowed to access the services provided by the identified NF Service Producers(s). The NRF also verifies if the NF Service Consumer has authorized the DCCF to request an access token on its behalf by verifying the audience included in its CCA. NRF, after verification, provides an access token containing ADRF NF Type (or NF Instance ID) and data producer NF Type (or NF Instance ID(s)) in the audience claims of the access token and the NF Service Consumer (i.e. the data consumer) and the DCCF in the subject claim of the access token.
Step 6. DCCF forwards the historical data request to ADRF along with the access token received.
Step 7. ADRF now authenticates the NF Service Consumer via the CCA provided and performs two verifications. First, it verifies the access token as mentioned in the TS 33.501 [8], ADRF then also verifies if the metadata info of the requested data (e.g. Source NF type (or NF Instance ID)) matches the claims info of the access token.
Step 8. ADRF sends the data to NF consumer via DCCF in case of successful verification.
Procedure 2: Service Consumer Authorization to receive data from ADRF via DCCF (with MFAF)
Figure 6.11.2-2: Service Consumer Authorization to receive data from ADRF via DCCF (with MFAF)
Step 0. ADRF subscribes/requests data from Data Producer (directly or via DCCF). If DCCF is involved, DCCF configures MFAF to forward the data to the ADRF and to add metadata information containing Source NF Type as the NF Type of the Data Producer and source NF Instance ID as NF Instance ID of the data producer (if the data producer does not append this metadata information).
Step 1.	NF Service Producer (data producer) sends the data to ADRF (directly or via DCCF) and may add metadata information containing Source NF Type as its own NF Type and Source NF Instance ID as its own Instance ID.
Step 2. If the data producer did not add its metadata, then MFAF when forwarding the data to ADRF, adds the metadata related to the data producer (i.e. NF type and NF Instance ID) (as instructed by the DCCF in step 0) prior to sending the data to ADRF for storage.
NOTE 1: 	Steps 1-2 ensure that the NF Service Producer information from which the data was collected is present in the ADRF. If the information is already present, Steps 1-2 are not needed, and the procedure defined in Clause 6.2.6.3.3 in TS 23.288 [4] is followed.
Step 3. NF Service consumer (data consumer) sends request to DCCF to get historical data (as specified in clause 6.2.6.3.3, TS 23.288) with optionally also providing the NF Type (or NF Instance ID) of the target NF Service Producer (or data producer). The request also contains the access token to request services from DCCF and CCA of NF Service Consumer.
Step 4. DCCF, after verifying that the NF Service Consumer is authorized to access the services of DCCF, sends to NRF an access token request to collect historical data from data producer(s) including the information to identify the target NFs (NF Service Producer (i.e. ADRF) and data producer), the source NF (DCCF, NF Service Consumer) and the CCA provided by the NF Service Consumer
Step 5. NRF, after verification, provides an access token containing ADRF NF Type (or NF Instance ID) and data producer NF Type (or NF Instance ID(s)) in the audience claims of the access token.
Step 6a/6b. DCCF forwards the historical data request to ADRF along with the access token received. DCCF also configures the MFAF to forward the data to the data consumer
NOTE: 	For communication between DCCF and MFAF, authorization token for enabling DCCF to access services of MFAF will also be included
Step 7. ADRF now performs two verifications. First, it checks if an audience claim is matching its own NF type (or NF Instance ID). Second, ADRF verifies if the Source NF type (or NF Instance ID) present in the metadata of the requested data matches an audience claim an of the access token.
Step 8. ADRF sends the data to NF consumer via MFAF in case of successful verification.",TR 33.866,6.11.2,all_images/image_191.jpeg,Service Consumer Authorization to receive data from ADRF via DCCF(without MFAF)
"NF Service consumer (e.g. NWDAF) accesses the services of DCCF using the existing SBI mechanisms. NF Service Producer (or Data producer) when sending the data to the NF Service Consumer, may also send the data to ADRF for storage and archiving if requested/subscribed to by ADRF (e.g. based on a requested by the NF Service Consumer or the DCCF). Alternatively, the Messaging Framework may be configured by DCCF to forward a copy of the data to ADRF.
The NF Service Producer (Data Producer), when sending the data to the ADRF also appends its own NF type and its own NF Instance ID as metadata to the data which is sent for archiving. If NF Service Producer does not add this metadata, then DCCF may add this information before sending it to the ADRF.
The access token get request sent from DCCF to NRF to request the desired data on behalf of the NF Service Consumer contains the following information: NF Instance IDs of the NF Service Consumer (e.g. NWDAF) and the DCCF, NF Type (or NF Instance ID) of the NF Service Producers (i.e. ADRF and the Data Producer).
NRF after verifying the request, authorizes the NF Service Consumer to request the data and adds in the access token claims the NF Type (or the NF Instance ID) of the NF Service Producers (i.e. the ADRF and the Data Producer).
The ADRF when receiving the request from DCCF (based on a request from the NF Service Consumer) verifies the access token generated by ensuring that the NF Type (or NF Instance ID) matches that of ADRF, and the NF Type (or NF Instance ID) of the Data Producer matches the metadata information that was earlier appended by the Data Producer (or DCCF or MFAF) when archiving the data. Only after a successful verification, ADRF sends the data to the NF Service Consumer via DCCF (or MFAF).
The detailed procedures are depicted in Figure 6.11.2-1 (without MFAF) and Figure 6.Y.2-2 (with MFAF).
Procedure 1: Service Consumer Authorization to receive data from ADRF via DCCF (without MFAF)
Figure 6.11.2-1: Service Consumer Authorization to receive data from ADRF via DCCF(without MFAF)
Step 0. ADRF subscribes/requests data from data producer (directly or via DCCF).
Step 1. NF Service Producer (data producer) sends the data to ADRF (directly or via DCCF) and may add metadata information containing Source NF Type as its own NF Type and Source NF Instance ID as its own Instance ID.
Step 2. If, in step 1, the data is sent via DCCF and the data producer did not add its metadata, then DCCF when forwarding the data to ADRF, adds the metadata related to the data producer (i.e. NF type and NF Instance ID) prior to sending the data to ADRF for storage.
NOTE 1: 	Steps 1-2 ensure that the NF Service Producer information from which the data was collected is present in the ADRF. If the information is already present, Steps 1-2 are not needed, and the procedure defined in Clause 6.2.6.3.3 in TS 23.288 is followed.
Step 3. NF Service consumer (data consumer) sends request to DCCF to get historical data (as specified in clause 6.2.6.3.3, TS 23.288 [4]) with optionally also providing the NF Type (or NF Instance ID) of the target NF Service Producer (or data producer). The request also contains the access token to request services from DCCF and CCA of NF Service Consumer.
Step 4. DCCF, after verifying that the NF Service Consumer is authorized to access the services of DCCF, sends to NRF an access token request to collect historical data from data producer(s) including the information to identify the target NFs (NF Service Producer (i.e. ADRF) and data producer), the source NF (DCCF, NF Service Consumer) and the CCA provided by the NF Service Consumer
NOTE 2: Both ADRF and data producer info is needed in the access token request as target NFs, since DCCF is consuming ADRF services, and the data producer audience claim is required for the ADRF to verify if the data consumer and DCCF are authorized to receive the data belonging to a data producer,
Step 5. The NRF determines whether the DCCF and the NF Service Consumer are allowed to access the services provided by the identified NF Service Producers(s). The NRF also verifies if the NF Service Consumer has authorized the DCCF to request an access token on its behalf by verifying the audience included in its CCA. NRF, after verification, provides an access token containing ADRF NF Type (or NF Instance ID) and data producer NF Type (or NF Instance ID(s)) in the audience claims of the access token and the NF Service Consumer (i.e. the data consumer) and the DCCF in the subject claim of the access token.
Step 6. DCCF forwards the historical data request to ADRF along with the access token received.
Step 7. ADRF now authenticates the NF Service Consumer via the CCA provided and performs two verifications. First, it verifies the access token as mentioned in the TS 33.501 [8], ADRF then also verifies if the metadata info of the requested data (e.g. Source NF type (or NF Instance ID)) matches the claims info of the access token.
Step 8. ADRF sends the data to NF consumer via DCCF in case of successful verification.
Procedure 2: Service Consumer Authorization to receive data from ADRF via DCCF (with MFAF)
Figure 6.11.2-2: Service Consumer Authorization to receive data from ADRF via DCCF (with MFAF)
Step 0. ADRF subscribes/requests data from Data Producer (directly or via DCCF). If DCCF is involved, DCCF configures MFAF to forward the data to the ADRF and to add metadata information containing Source NF Type as the NF Type of the Data Producer and source NF Instance ID as NF Instance ID of the data producer (if the data producer does not append this metadata information).
Step 1.	NF Service Producer (data producer) sends the data to ADRF (directly or via DCCF) and may add metadata information containing Source NF Type as its own NF Type and Source NF Instance ID as its own Instance ID.
Step 2. If the data producer did not add its metadata, then MFAF when forwarding the data to ADRF, adds the metadata related to the data producer (i.e. NF type and NF Instance ID) (as instructed by the DCCF in step 0) prior to sending the data to ADRF for storage.
NOTE 1: 	Steps 1-2 ensure that the NF Service Producer information from which the data was collected is present in the ADRF. If the information is already present, Steps 1-2 are not needed, and the procedure defined in Clause 6.2.6.3.3 in TS 23.288 [4] is followed.
Step 3. NF Service consumer (data consumer) sends request to DCCF to get historical data (as specified in clause 6.2.6.3.3, TS 23.288) with optionally also providing the NF Type (or NF Instance ID) of the target NF Service Producer (or data producer). The request also contains the access token to request services from DCCF and CCA of NF Service Consumer.
Step 4. DCCF, after verifying that the NF Service Consumer is authorized to access the services of DCCF, sends to NRF an access token request to collect historical data from data producer(s) including the information to identify the target NFs (NF Service Producer (i.e. ADRF) and data producer), the source NF (DCCF, NF Service Consumer) and the CCA provided by the NF Service Consumer
Step 5. NRF, after verification, provides an access token containing ADRF NF Type (or NF Instance ID) and data producer NF Type (or NF Instance ID(s)) in the audience claims of the access token.
Step 6a/6b. DCCF forwards the historical data request to ADRF along with the access token received. DCCF also configures the MFAF to forward the data to the data consumer
NOTE: 	For communication between DCCF and MFAF, authorization token for enabling DCCF to access services of MFAF will also be included
Step 7. ADRF now performs two verifications. First, it checks if an audience claim is matching its own NF type (or NF Instance ID). Second, ADRF verifies if the Source NF type (or NF Instance ID) present in the metadata of the requested data matches an audience claim an of the access token.
Step 8. ADRF sends the data to NF consumer via MFAF in case of successful verification.",TR 33.866,6.11.2,all_images/image_192.png,Service Consumer Authorization to receive data from ADRF via DCCF (with MFAF)
"The data consumer requests authorization from the NRF to invoke services of a DCCF and a data producer. After data consumer requests a token for the DCCF service request, the consumer requests another token for data collection request.
The NRF determines if the data consumer is authorized to use the service of the DCCF and the NRF sends a token for DDCF service. The NRF then determines if the data consumer is authorized to collect the requested data from the data producer, and then the NRF provides another access token to the data consumer. The data consumer uses these tokens for the service requests to the DCFF and data producer. The DCCF executes the service by verifying the token for DCCF service. Then the DCCF sends the data request by the token for data collection to the data producer. The data producer executes the service by verifying the token and sends the data to the data consumer via DCCF.
It is assumed that data consumer knows the data producer in advance.
The solution is shown in detail below:
Figure 6.12.2-1: Authorization of data consumer for services of DCCF and data producer
1.	The data consumer requests a token from the NRF for the DCCF service.
2.	The NRF checks if the data consumer is allowed to access DCCF. If the check was successful, NRF generates the token. The access token that the consumer receives from the NRF contains the information that the consumer is authorized to invoke DCCF services.
3.	The NRF sends the token for the DCCF service to the data consumer.
4.	The data consumer requests a token from the NRF for the data collection requests from the target data producer if possible. In the token request, the data consumer includes, besides the existing token request parameters, the following additional parameters: the data that the data consumer wants to collect, information about the data producer that is available to the data consumer, e.g., name of the data producer service or data producer NF instance ID if available to the data consumer.
5.	The NRF checks if the data consumer is allowed to consume the data. If the check was successful, NRF generates the token. The access token that the consumer receives from the NRF contains the information that which data the consumer is allowed to retrieve. Besides the existing parameters, the token contains the following additional information: the data that the data consumer wants to collect, both the data producer NF ID (if there exists) and the name of the data producer service.
6.	The NRF sends the token for data collection to the data consumer.
7.	The consumer sends the received token for the DCCF service to the DCCF. This request also includes the access token for data collection.
8.	The DCCF verifies the token and checks the authorization result. If the consumer is allowed to get services from the DCCF and collect data, then the DCCF coordinates the data collection request.
8a. DCCF requests an access token for itself from the NRF to get the service from data producer. NRF provides an access token for the service of data producer to the DCCF.
9.	The DCCF sends the request to the data producer to retrieve the service. This request includes the access token received by DCCF in step 8a and the access token for data collection, ensuring the data consumer is authorized to consume this data.
10.	The data producer verifies the access token, checks the tokens from the data consumer and execute the service.
11.	The data producer provides requested data to the DCCF.
12.	The DCCF forwards the provided data to the data consumer.
NOTE: 	In the case that a second Data Consumer comes a later stage for the same type of data, steps 1-12 are applied.",TR 33.866,6.12.2,all_images/image_193.jpeg,Authorization of data consumer for services of DCCF and data producer
"The following subclauses outline an overview of the security architecture for trusted and untrusted non-3GPP accesses to connect to 3GPP EPS. It outlines the needed security features to connect such a non-3GPP access to the 3GPP EPS. Non-3GPP access specific security is outside the scope of the present document.
Figure 4.1-1 gives an overview of the security architecture of a typical non-3GPP access while connected to the 3GPP EPC.
Figure 4.1-1: Security Architecture of Non-3GPP Access and 3GPP EPS
NOTE:	USIM applies in case of terminal with 3GPP access capabilities, cf. clause 6.1.
Five security feature groups are defined. Each of these feature groups accomplishes certain security objectives:
-	Network access security (I): the set of security features that provide users with secure access to services while terminated at 3GPP EPC. Radio Access protection is a non-3GPP access specific and outside the scope of the present document.
-	Network domain security (II): the set of security features that enable nodes to securely exchange signaling data, and protect against attacks on the wireline network.
-	Non-3GPP domain security (III): the set of security features are a non-3GPP access specific and outside the scope of the present document.
-	Application domain security (IV): the set of security features that enable applications in the user and in the provider domain to securely exchange messages.
-	User domain security (V): the set of security features that secure access to the mobile station. If the terminal does not support 3GPP access capabilities, 3GPP does not specify how user domain security is achieved.",TS 33.402,4.1,all_images/image_194.png,Security Architecture of Non-3GPP Access and 3GPP EPS
"The signalling sequence when the External AAA server performs the PAP procedures in a network based mobility system to authenticate and authorize the UE's access to a Private network over an Untrusted non-3GPP Acess network using S2b is illustrated in Figure 6.5.3-1. In this procedure, the External AAA Server supports the PAP procedure.
Figure 6.5.2-1: Authentication and authorization for the Private network access over S2b
(The External AAA Server performs PAP procedure)
NOTE: 	The parameters indicated with bold character denote support for ""the multiple authentication and authorization"", as specified in RFC 4739 [30].
1.	The UE and the ePDG exchange the first pair of IKE_SA_INIT messages, in which the ePDG and the UE negotiate cryptographic algorithms, exchange nonces and perform a Diffie-Hellman exchange. If the ePDG supports multiple authentication procedures, it indicates MULTIPLE_AUTH_SUPPORTED in step 1b.
2.	The UE sends the user identity (in the IDi payload) and the APN information (in the IDr payload) to the ePDG and begins negotiation of child security associations. The UE omits the AUTH parameter in order to indicate to the ePDG that it wants to use EAP over IKEv2. The user identity shall be compliant with the Network Access Identifier (NAI) format specified in 3GPP TS 23.003[8], containing the IMSI or the pseudonym as defined for EAP-AKA in RFC 4187 [7]). 
If the UE’s Remote IP address needs to be configured dynamically, then the UE shall send the configuration payload (CFG_REQUEST) within the IKE_AUTH request message to obtain a Remote IP Address. If the APN requires authentication and authorization with the External AAA Server and the ePDG indicated that multiple authentication procedures are supported in step 1b, then MULTIPLE_AUTH_SUPPORTED is included.
3.-11.	The steps 3 to 11 clause 8.2.2 apply here.
12.	The UE shall take its own copy of the MSK as input to generate the AUTH parameter to authenticate the first IKE_SA_INIT message. The AUTH parameter is sent to the ePDG. The UE includes a Notify payload ANOTHER_AUTH_FOLLOWS indicating to the ePDG that another authentication and authorization round will follow.
13.	The ePDG checks the correctness of the AUTH received from the UE and calculates the AUTH parameter which authenticates the second IKE_SA_INIT message. The AUTH parameter is sent to the UE.
NOTE: 	At this point the UE is authenticated from EPC point of view. PMIP/GTP signalling between ePDG and PDN GW could start anytime after this step but since an additional authentication with the external network was indicated in step 12, the ePDG needs to collect additional authentication parameters from the UE before initiating the PMIP binding update / GTP session creation procedure in Step 15.
14.	The UE sends the identity in the private network in IDi payload that is used for the next authentication and authorization with the External AAA Server and without an AUTH payload.
15. If the External AAA Server supports the PAP procedure, the ePDG sends an EAP-GTC request to the UE for the next authentication.
16. The UE returns an EAP-GTC response containing the user‘s password to the ePDG.
17. The ePDG includes the user-name and user-password as Additional Parameters in the PBU it sends to PGW as defined in 3GPP TS 29.275 [32]. The corresponding message in GTP for S2b is Create Session Request as defined in 3GPP TS 29.274 [31].
18. The PGW sends a AAA Access request message with user-name and user-password attributes which are copied from the PBU Additional Parameters to the external AAA server.
19. The external AAA server returns the Access accept to the PGW.
20. The PGW sends PBA (PMIP) /Create Session Response (GTP) to the ePDG with the Additional Parameters indicating authentication success.
21. The EAP-success message is sent to the UE over IKEv2.
22.-23. The PGW sends the Accounting request (Start) message to the External AAA Server and the External AAA Server returns the Accounting response (Start) message to the PGW if needed.
24.	The UE shall generate the AUTH parameter calculated by the SK_pi as a shared secret as specified in RFC 5996 [30] in order to authenticate the first IKE_SA_INIT message. The AUTH parameter is sent to the ePDG.
25.	The ePDG checks the correctness of the AUTH received from the WLAN UE and calculates the AUTH parameter which authenticates the second IKE_SA_INIT message. The ePDG shall send the assigned Remote IP address in the configuration payload (CFG_REPLY), if the WLAN UE requested a Remote IP address through the CFG_REQUEST. Then the AUTH parameter calculated by the SK_pr as a shared secret (see RFC 5996 [30]) is sent to the WLAN UE together with the configuration payload, security associations and the rest of the IKEv2 parameters and the IKEv2 negotiation terminates.",TS 33.402,6.5.2,all_images/image_196.jpeg,Authentication and authorization for the Private network access over S2b
"Figure 7.2.1.1-1 depicts the basic non-roaming architecture for HRPD-LTE Interworking.
Figure 7.2.1.1-1: Basic non-roaming architecture for HRPD-LTE Interworking. Interworking
reference points are highlighted.",TS 33.402,7.2.1.1,all_images/image_199.jpeg,Basic non-roaming architecture for HRPD-LTE Interworking. Interworking
"NOTE 1: Authentication data in this clause stands for EPS Authentication vector(s).
The purpose of this procedure is to provide the MME with one or more EPS authentication vectors (RAND, AUTN, XRES, KASME) from the user's HE (HSS) to perform user authentication. Each EPS authentication vector can be used to authenticate the UE.
NOTE 2: It is recommended that the MME fetch only one EPS authentication vector at a time as the need to perform AKA runs has been reduced in EPS through the use of a more elaborate key hierarchy. In particular, service requests can be authenticated using a stored KASME without the need to perform AKA. Furthermore, the sequence number management schemes in TS 33.102, Annex C [4], designed to avoid re-synchronisation problems caused by interleaving use of batches of authentication vectors, are only optional. Re-synchronisation problems in EPS can be avoided, independently of the sequence number management scheme, by immediately using an authentication vector retrieved from the HSS in an authentication procedure between UE and MME.
Figure 6.1.2-1: Distribution of authentication data from HE to MME
An EPS authentication vector is derived from the authentication vector defined in TS 33.102 [4] clause 6.3.2. To derive the key KASME in the HE, the KDF as specified in clause A.2 is used which shall contain following mandatory input parameters: CK, IK and SN identity.
If the Network Type equals E-UTRAN then the ""separation bit"" in the AMF field of AUTN shall be set to 1 to indicate to the UE that the authentication vector is only usable for AKA in an EPS context, if the ""separation bit"" is set to 0, the vector is usable in a non-EPS context only (e.g. GSM, UMTS). For authentication vectors with the ""separation bit"" set to 1, the secret keys CK and IK generated during AKA shall never leave the HSS.
The MME invokes the procedures by requesting authentication vectors from the HE (Home environment).
The authentication data request shall include the IMSI, the Serving Network identity i.e. MCC + MNC, and the Network Type (i.e. E-UTRAN). In the case of a synchronisation failure, the MME shall also include RAND and AUTS. In this case the HE checks the AUTS parameter before sending new authentication vectors to the MME (see TS 33.102 [4]).
Upon the receipt of the authentication data request from the MME, the HE may have pre-computed the required number of EPS authentication vectors and retrieve them from the HSS database or may compute them on demand.
NOTE 3:	For KASME the possibilities for pre-computation are restricted due to the PLMN-binding.
NOTE 4:	The HSS needs to ensure that the MME requesting the authentication data is entitled to use the SN id used to calculate KASME. The exact details of how to achieve this are not covered in this specification.
The HE sends an authentication response back to the MME that contains the requested information. If multiple EPS authentication vectors had been requested then they are ordered based on their sequence numbers. The MME shall be aware of the order of the EPS authentication vectors and shall use that the EPS authentication vectors in order.",TS 33.401,6.1.2,all_images/image_208.jpeg,Distribution of authentication data from HE to MME
"AS UP integrity protection activation shall be done as part of the DRB addition procedure using RRC Connection Reconfiguration procedure as described in this clause, see Figure 7.3.4 -1.
As defined in Clause 7.3.3, the MME may send the UP integrity protection policy to the eNB. If the MME does not send the UP integrity protection policy, the eNB may use locally configured UP integrity protection policy.
Figure 7.3.4-1: User plane (UP) integrity protection activation mechanism
1a.	This RRC Connection Reconfiguration procedure which is used to add DRBs shall be performed only after RRC security and UP ciphering have been activated as part of the AS security mode command procedure defined in Clause 7.2.4.5 and the UE indicates that it supports use of user plane integrity protection with EPC.
1b.	The eNB shall send the RRC Connection Reconfiguration message to the UE for UP security activation containing indication for the activation of UP integrity protection for each DRB according to the security policy.
The eNB shall select the NR integrity algorithm and indicate it in the RRC Connection Reconfiguration procedure to the UE. The selected NR integrity algorithm  corresponds to the EPS integrity algorithm which the eNB selected and indicated to the UE in the AS Security Mode Command procedure.
1c.	If UP integrity protection is activated for DRBs as indicated in the RRC Connection Reconfiguration message, and if the eNB does not have KUPint, the eNB shall generate KUPint and UP integrity protection for such DRBs shall start at the eNB.
2a.	UE shall verify the RRC Connection Reconfiguration message. If successful, if UP integrity protection is activated for DRBs as indicated in the RRC Connection Reconfiguration message, and if the UE does not have KUPint, the UE shall generate KUPint and UP integrity protection for such DRBs shall start at the UE.
2b.	If the UE successfully verifies integrity of the RRC Connection Reconfiguration message, the UE shall send the RRC Connection Reconfiguration Complete message to the eNB.
When the UE receives the RRC Connection Reconfiguration message then the UE shall use the EPS algorithm which corresponds to the NR algorithm indicated in the RRC Connection Reconfiguration message for UP integrity protection.
If UP integrity protection is not activated for DRBs, the eNB and the UE shall not integrity protect the traffic of such DRB and shall not put MAC-I into PDCP packet.",TS 33.401,7.3.4,all_images/image_212.png,User plane (UP) integrity protection activation mechanism
"The procedure for SRVCC handover from UTRAN/GERAN CS to E-UTRAN, as far as relevant for security, proceeds as described below.
The activation of NAS and AS security in E-UTRAN, and selection of the key set from the source system for the handover shall be according to following principles:
i)	The source MSC server enhanced for SRVCC shall select the key set most recently generated. This key set may have been generated by either a successful UMTS AKA run in UTRAN or from a UMTS security context mapped from an EPS security context during a previous visit to UTRAN. The UE and source MSC server enhanced for SRVCC may or may not have taken the key set into use. The MSC server enhanced for SRVCC shall transfer this key set to the MME in the CS to PS HO request.
ii)	Activation of AS security in the UE (for details cf. TS 36.331 [21]):
The CS to PS HO command received at the UE shall activate AS security in the UE.
The CS to PS HO Confirmation received at the eNB shall activate AS security in the eNB.
iii)	Activation of NAS security (for details cf. TS 24.301 [9]):
The CS to PS HO request received at the UE shall activate NAS security in the UE.
The Handover Notify received at the MME shall activate NAS security in the MME. In case the MME does not have the UE security capabilities stored from a previous visit, then the MME shall only accept TAU requests from this UE, and shall not send any messages to this UE, until the MME has successfully checked the UE security capabilities received in a TAU request from this UE.
iv)	Both AS and NAS ciphering and integrity protection algorithms shall be selected according to the policy of the target PLMN.
The above four principles consequentially always activate ciphering (potentially NULL ciphering) in E-UTRAN even if it was not active in the source system.
Figure 14.3.1-1: SRVCC handover from UTRAN/GERAN to E-UTRAN. Key derivations in the figure are only shown for UMTS subscribers.
Handover signalling in case of successful handover
Before attempting a handover for a UE, the source RNC/BSC may check if the UE is authenticated using UMTS AKA as described in clause 9.2.2.1 of the present document, and may avoid doing a SRVCC handover to E-UTRAN in case the UE is not authenticated using UMTS AKA and does not have an ongoing emergency call.
NOTE 1:	The numbering in the followingrefers to the signalling numbering in Figure 14.3.1-1.
1.	The source BSC/RNC sends HO required to the source MSC server enhanced for SRVCC.
2.	For UMTS and GSM subscribers, the source MSC server enhanced for SRVCC shall generate a NONCEMSC.
For UMTS subscribers, the source MSC server enhanced for SRVCC shall derive CK'PS and IK'PS from the NONCEMSC and the latest CKCS and IKCS using the key derivation function as specified in annex B.6 of TS 33.102 [2]. The source MSC server enhanced for SRVCC shall further set the KSI'PS equal to the KSICS associated with the latest key set as specified for SRVCC from UTRAN/GERAN to HSPA in TS 33.102 [2].
For GSM subscribers, the source MSC server enhanced for SRVCC shall derive GPRS Kc' from the NONCEMSC and the latest GSM Kc using the key derivation function as specified in annex B.7 of TS 33.102 [2] . The source MSC server enhanced for SRVCC shall further set the CKSN'PS equal to the CKSNCS associated with the latest key set as specified for SRVCC from UTRAN/GERAN to HSPA in TS 33.102 [2].
For UMTS subscribers, the MSC server enhanced for SRVCC shall transfer the CK'PS/IK'PS and the KSI'PS, to the target MME in the CS to PS handover request.
For GSM subscribers, the MSC server enhanced for SRVCC shall transfer the GPRS Kc' and the CKSN'PS, to the target MME in the CS to PS handover request.
NOTE 2: The MSC server enhanced for SRVCC does not include any authentication vectors in the CS to PS HO request, since this could result in that authentication vectors intended for use only in the CS domain would end up being used in a PS domain by accident.
NOTE 3: The MSC server enhanced for SRVCC does not include any UE security capability information in the CS to PS HO request, since the target MME either has this information available, or will retrieve the information from the old SGSN. Further, the MSC may not have access to the complete UE security capabilities.
If the MME receives a GPRS Kc' from the source MSC server enhanced for SRVCC in the CS to PS HO request, the MME shall reject the request.
3 and 4.	The MME shall discard any CK, IK, Kc, CKSN and KSI retrieved from the old SGSN in a context request procedure
The MME shall create a mapped EPS security context by setting the K'ASME of the mapped EPS security context equal to the concatenation CK'PS || IK'PS, where the CK'PS and IK'PS were received in the CS to PS handover request. The MME shall further associate the K'ASME with a KSISGSN. The value of the KSISGSN shall be the same as the value of the KSI'PS received in the CS to PS handover request.
NOTE 4:	The naming of the KSISGSN hints at that this identifier is somehow related to an SGSN. However, in this case it is related to the MSC server enhanced for SRVCC. Even though KSIMSC could have been a more appropriate name here, the name KSISGSN is kept to avoid introducing a new name for the same entity.
The MME shall derive KeNB by applying the KDF as defined in Annex A. 3 using the mapped key K'ASME and 232-1 as the value of the uplink NAS COUNT parameter. The uplink and downlink NAS COUNT values for the mapped EPS security context shall be set to start value (i.e. 0) in the MME.
If the MME does not have access to the UE EPS security capabilities the MME shall assume that the default set of EPS security algorithms defined in clause 9.2.2.1 of the present document is supported by the UE (and the MME shall set the UE EPS security capabilities in the mapped EPS security context according to this default set). The same considerations regarding security algorithm selection using the default set as noted in clause 9.2.2.1 of the present document applies here. If the security context information received from the old SGSN contains EPS security capabilities or the MME already have access to EPS security capabilities for the UE, the MME shall populate the mapped EPS security context with these EPS security capabilities instead of falling back to the default set of security algorithms.
If the MME received any authentication vectors from the old SGSN, the MME shall process these authentication vectors according to clause 6.1.6 of the present document.
5.	MME shall select the NAS security algorithms (including ciphering and integrity protection) which have the highest priority from its configured list and are also present in the UE EPS security capabilities. MME shall derive the NAS keys from K'ASME using the algorithm types and algorithm IDs as input to the NAS key derivation functions (see Annex A.7). MME generates NONCEMME. MME shall include KSISGSN, NONCEMMEand the selected NAS security algorithms in the NAS Security Transparent Container IE of Allocate resources message to the target eNB. MME shall further include KeNB and the UE EPS security capabilities from the mapped EPS security contextin the Allocate resources message to the target eNB.
6.	The target eNB shall select the AS algorithms (including ciphering for both RRC and UP, and integrity protection for RRC) which have the highest priority from its configured list and is also present in the UE EPS security capabilities. The target eNB creates a target to source transparent container that contains a handover command (the target to source transparent container is denoted ""E-UTRAN RRC container"" in Figure 14.3.1-1). The handover command incluesd the selected RRC, UP algorithms and the NAS Security Transparent Container IE, and the eNB sends the target to source transparent container in the Allocate resources Ack message towards the MME. The eNB shall derive the keys for RRC and UP protection from the received KeNB using the key derivation function defined in clause A.7.
NOTE  5:	The handover command in the target to source transparent container is not security protected by the target eNB.
7.	MME shall include the target to source transparent container received from the target eNB in the CS to PS HO Response message sent to source MSC server enhanced for SRVCC.
8.	Source MSC server enhanced for SRVCC shall include the NONCEMSC and the target to source transparent container in the relocation command sent to the BSC/RNC in the CS to PS HO command.
9.	The RNC/BSC shall include the NONCEMSC and the transparent container in the CS to PS HO command sent to the UE.
NOTE 6:	The CS to PS HO command is integrity protected and optionally ciphered in UTRAN. It is optionally ciphered in GERAN as specified by TS 33.102 [4].
10.	For UMTS subscribers the ME shall silently discard the NONCEMME received in received in the NAS Security Transparent Container. The ME shall further derive K'ASME, associate it with KSISGSN recived in the NAS Security Transparent Container IE and derive NAS keys and KeNB following the same key derivations as the MSC and MME performed in steps 2, 3 and 4. The ME shall also derive the RRC and UP keys as the eNB did in (see description for message 6 above). The UE sends a CS to PS HO Confirmation message to the target eNB. The ME shall set the uplink and downlink NAS COUNT values for the mapped EPS security context to start value (i.e. 0)
NOTE 7: Since the MME denies access to E-UTRAN for GSM subscribers, the UE never has to perform any key derivations for GSM subscribers..
The mapped EPS security context established as above shall become the current (cf. clause 3.1) EPS security context at AS and NAS level. The MME and ME shalloverwrite any existing current mapped EPS security context with the newly created one. If the current EPS security context is of type native, then it shall become the non-current native EPS security context. The MME and ME shall in this case also overwrite any existing non-current EPS security context with this current native EPS security context. The CS to PS HO Confirmation messages and all following AS messages in E-UTRAN shall be ciphered and integrity protected according to the policy of the target PLMN.
If the SRVCC handover is not completed successfully, the new mapped EPS security context cannot be used in the future. The MME and the ME shall in this case delete the new mapped EPS security context.
The text regarding subsequent NAS signalling in bullet B) in clause 9.2.2.1 of the present specification applies also after an SRVCC handover from GERAN/UTRAN to E-UTRAN.
In SRVCC handover from GERAN/UTRAN to E-UTRAN, the STARTPS and STARTCS values used in UTRAN shall be kept in the volatile memory of the ME, cf. also clause 6.8.11 of TS 33.102 [4].",TS 33.401,14.3.1,all_images/image_214.png,SRVCC handover from UTRAN/GERAN to E-UTRAN. Key derivations in the figure are
"The SMF may trigger a UUAA procedure during the PDU session establishment procedure with details described below, which considers only the security related (see TS 23.256 [3] for full details of the flows).
Figure 5.2.1.3-1: UUAA Procedure at PDU Session Establishment
1. The SMF determines whether UUAA is required as described in the clause 5.2.1.1 and if the UUAA result is not received from the AMF, if the UE provides a CAA-Level UAV ID indicating UAS services and optionally the Aviation Payload if provided by the UE for USS to authenticate the UAV in the PDU Session Establishment request. The SMF triggers a UUAA procedure after the determination in step 7 in the clause 5.2.1.1.
2. The SMF sends a message Nnef_Auth_Req to the UAS NF, including the GPSI and the CAA-Level UAV ID, and the transparent container if provided by the UE. The SMF may include other information in the request as in TS 23.256 [3].
3. The UAS NF resolves the USS address based on CAA-Level UAV ID or uses the provided USS address. Only authorized USS shall be used in order to ensure only legitimate entities can provide authorization for UAVs. The UAS NF sends an Authentication Request to the USS which includes the GPSI, the CAA-Level UAV ID, the UAS NF Routing information (e.g., a FQDN or IP address) which uniquely identifies the NF located in the 3GPP network that handles the UAV related messages exchanges with the corresponding external USS/UTM, and the transparent container. Other information may also be included in this message (see TS 23.256 [3]).
4. The USS and the UE exchange multiple Authentication messages:
NOTE 1:	Multiple round-trip messages (4a to 4f) may be needed as required by the authentication method used by the USS. The method used to authenticate the UE (e.g. whether over EAP or not) and the content of Authentication Messages (e.g. EAP packets) to support that method are out of scope of 3GPP. The USS determines the authentication method used.
4a. The USS replies to UAS NF with the Authentication Response message. It shall include the GPSI, a transparent container composed of an authentication message.
4b. The UAS NF sends the transparent container to the SMF.
4c. The SMF forwards the transparent container to the AMF, which then forwards to the UE over a NAS MM transport message.
4d. The UE responses the AMF with an Authentication message embedded in a transparent container over a NAS MM transport message. The AMF forwards to the SMF.
4e. The SMF sends a message Nnef_Auth_Req to the UAS NF, including the GPSI and the CAA-Level UAV ID, and the transparent container provided by the UE.
4f. The UAS NF sends an Authentication Request to the USS. The Authentication Request shall include the GPSI, the CAA-Level UAV ID and the transparent container.
NOTE 2:	Multiple round-trip messages (4a to 4f) may be needed as required by the authentication method used by USS. The method used to authenticate the UE and the content of Authentication Messages are out of scope of 3GPP.
5. The USS sends the UAS NF an Authentication Response message. The Authentication Response shall include the GPSI, the UUAA result (success/failure), the authorized CAA-level UAV ID, and a UUAA Authorization Payload that contains UAS security information if the USS has such information to send to the UAV.
NOTE 3:	The content of security information (e.g., key material to help establish security between UAV and USS/UTM) is not in 3GPP scope.
If UUAA successful, the UAS NF stores the UAV UEs' UUAA context, including the GPSI, USS Identifier (and the binding with the GPSI) and the CAA-level UAV ID (and the binding with the GPSI).
NOTE 4: The USS Identifier is used to ensure that a USS requesting a subsequent re-authentication or revocation is the same one that authenticated the UAV in the first place. The USS identifier is based on the security link on the interface between USS NF and USS (e.g. the identity mapped during link establishment or the identity in certificate).
6. The UAS NF sends the SMF an Authentication Response message, including the GPSI, the UUAA result (success/failure), the authorized CAA-level UAV ID, and the UUAA Authorization Payload received in step 5.
The SMF stores the results, together with the GPSI and the CAA-level UAV ID.
7. The SMF sends the UUAA result (success/failure), and the UUAA Authorization Payload received in step 5 to the UE. The message(s) used in step 7 and any further actions the UE and SMF take are given in TS 23.256 [3].
8. The UE on receiving the UUAA result as success, shall store the authorization information if received such as, CAA-level UAV ID, and UAS Security information.",TS 33.256,5.2.1.3,all_images/image_216.jpeg,UUAA Procedure at PDU Session Establishment 
"The overall conceptual view of LI architecture is shown in figure 5.2-1 below.
Figure 5.2-1: A high-level generic view of LI architecture
The functional entities of the architecture are described in more detail in clause 5.3 below. Details of the specific interfaces between these entities are described in clause 5.4.",TS 33.127,5.2,all_images/image_220.png,A high-level generic view of LI architecture
,TS 33.127,5.4,all_images/image_222.png,High-level architecture diagram with key point-to-point LI interfaces
,TS 33.127,5.6,all_images/image_223.png,Simplified virtualised LI system with provisioning infrastructure for a direct provisioned
,TS 33.127,5.6,all_images/image_224.png,Example simplified flow-diagram for OSS / BSS originated LI instantiation procedures
,TS 33.127,6.2,all_images/image_227.png,LI architecture showing LI at SMF/UPF
,TS 33.127,6.2,all_images/image_228.png,LI architecture for LI at SMSF
,TS 33.127,6.3,all_images/image_229.png,LI architecture for LI at MME
,TS 33.127,6.3,all_images/image_230.jpeg,LI architecture for LI at non-CUPS SGW/PGW
,TS 33.127,6.3,all_images/image_231.jpeg,LI architecture for LI at EPS CUPS SGW/PGW
,TS 33.127,6.3,all_images/image_232.png,LI architecture for LI at ePDG
,TS 33.127,7.2,all_images/image_234.png,LI architecture for LI at UDM
,TS 33.127,7.2,all_images/image_235.png,LI architecture for LI at HSS
,TS 33.127,7.3,all_images/image_236.png,LALS model for triggered location (POI/LTF option)
,TS 33.127,7.3,all_images/image_237.png,LALS Model for triggered location (MDF/LTF option)
,TS 33.127,7.4,all_images/image_239.jpeg,EPS/5GS-Anchored IMS High Level LI Architecture
,TS 33.127,7.4.7.4,all_images/image_241.png,VPLMN generic LI architecture for home-routed roaming
,TS 33.127,7.8,all_images/image_242.jpeg,LI architecture for NIDD using NEF showing LI at V-SMF
,TS 33.127,7.9,all_images/image_243.jpeg,LI architecture for NIDD using NEF showing LI at NEF
,TS 33.127,7.9,all_images/image_245.jpeg,5GS architecture for MSISDN-less MO SMS
,TS 33.127,7.11,all_images/image_246.jpeg,LI architecture for NIDD using SCEF showing LI at SCEF/IWK-SCEF
,TS 33.127,7.11,all_images/image_248.jpeg,EPS architecture for MSISDN-less MO SMS
"Complete self-evaluation of a 3GPP network product (e.g. eNodeB B from vendor Y)
This second example below is similar to the first one except that the vendor conducts all the phases of evaluation.
Figure 4.6.2.2-1: Complete self-evaluation of a 3GPP network product
 (e.g. eNodeB B from vendor Y)",TR 33.916,4.6.2.2,all_images/image_252.png,Complete self-evaluation of a 3GPP network product
"The usage and update of this set of documents during a SECAM evaluation is described in figure 7.2.2.3-1 below.
Figure 7.2.2.3-1: Overview of the SCAS instantiation documents evolution
 during a SECAM evaluation
Step1 is the initial production by the vendor of the required documentation and its update if required by step 2. It is outside of the scope of SECAM to describe this task.
Step 2 is the SCAS instantiation evaluation to check whether an SCAS instantiation written by a vendor is a correct instantiation of the SCAS of the network product class and whether it is a good basis for evaluating the network product.
Step 3 is about performing the SCT and BVT testing tasks as described in the present document. which will use this instantiation documentation as input. The evaluation does not start (neither SCT nor BVT) as long as steps 1 and 2 are not completed.
Further documentation is produced during step 3 . During step 3 for example, the SCT and BVT testers will describe the concrete test bed used for testing as well as ""instantiated test cases"" (i.e. the description of the concrete test case on the network product corresponding to the generic SCAS test case). At the end of step 3, the SCAS instantiation documentation as well as the SCT and BVT documentation is an output document provided to the operator. These documents are described in clauses 7.2.3 and 7.2.4.
After step 3, the SCAS instantiation documentation as well as the SCT and BVT documentation produced in step 3 are given to the operator for its final review and final security acceptance decision.",TR 33.916,7.2.2.3,all_images/image_253.png,Overview of the SCAS instantiation documents evolution
"The xIRIs generated at the LMISF-IRI shall be correlated using the correlation identifier field defined ETSI TS 103 221-2 [8]. This correlation identifier value can be independent of the correlation identifier value received in the xCC from the BBIFF-U/BBIFF over the LI_X3_LITE_S interface.
Furthermore, the xIRIs generated at the LMISF_IRI shall include the correlation identifier value used in the xCC generated at the LMISF-CC. Any intra-LMISF interactions required to associate the correlation identifier values used by the LMISF-IRI and LMISF-CC are outside the scope of the present document.
Each session-leg of an IMS session may have to be correlated separately. This is accomplished using the RTP/RTCP port numbers present in the SDP of IMS signaling message and the UDP port numbers present in the IMS voice media related RTP as illustrated in figure 7.10.4.8-1 below.
Figure 7.10.4.8-1: Correlation at the session-leg level (an illustration)
Figure 7.10.4.8-1 illustrates an example where an IMS session includes two session-legs.
Session-leg 1:
-	Source IP address: 192.0.2.10 and source port number: 24000 (RTP), 24001 (RTCP).
-	Destination IP address: 198.51.100.1 and destination port number: 32000 (RTP), 32001 (RTCP).
Session-leg 2:
- 	Source IP address: 192.0.2.10 and source port number: 26000 (RTP), 26001 (RTCP).
-	Destination IP address: 198.51.100.1 and destination port number: 36000 (RTP), 36001 (RTCP).
The IP address of the two end-points happen to be the same for the two session legs. The RTP port numbers present in the SDP of IMS signaling message and the UDP port numbers of the associated with the IMS voice-media related RTP happen to be the same for a session-leg.
Therefore, in general, multiple session-legs can be identified using the RTP port numbers present in the SDP of IMS signaling message and the UDP port numbers associated with the IMS voice-media related RTP.",TS 33.128,7.10.4.8,all_images/image_255.png,Correlation at the session-leg level (an illustration)
,TS 33.128,7.12.5.2,all_images/image_256.png,Media interception point options in the CC-POIs
,TS 33.128,7.12.5.2.2,all_images/image_257.png,Media interception on both sides of the IMS Media Function
,TS 33.204,4.2,all_images/image_259.jpeg,Example of Hub-and-Spoke SS7-Security Gateway Architecture
"The API invoker and the CAPIF core function shall follow the procedure in this subclause to secure and authenticate the onboarding of the API invoker to the CAPIF core function. The API invoker and the CAPIF core function shall establish a secure session using TLS. Security profiles for TLS implementation and usage shall follow the provisions given in TS 33.310 [2], Annex E .
With a secure session established, the API Invoker sends an Onboard API Invoker Request message to the CAPIF core function. The Onboard API Invoker Request message carries an onboard credential obtained during pre-provisioning of the onboard enrolment information, which may be an OAuth 2.0 [4] access token. When the OAuth 2.0 token based mechanism is used as the onboarding credential, the access token shall be encoded as JSON web token as specified in IETF RFC 7519 [6], shall include the JSON web signature as specified in IETF RFC 7515 [7], and shall be validated per OAuth 2.0 [4], IETF RFC 7519 [6] and IETF RFC 7515 [7]. Other credentials may also be used (e.g. message digest).
Figure 6.1-1 details the security information flow for the API invoker onboarding procedure. The OAuth 2.0 token based authentication credential is shown in this example.
Figure 6.1-1: Security procedure for API invoker onboarding
1.	As a prerequisite to the onboarding procedure, the API invoker obtains onboarding enrolment information from the API provider domain. The onboarding enrolment information is used to authenticate and establish a secure TLS communication with the CAPIF core function during the onboarding process. The enrolment information includes details of the CAPIF core function (Address, and Root CA certificate) and includes an onboarding credential (the OAuth 2.0 [4] access token).
NOTE 1:	The procedure used to obtain the enrolment information by the API invoker is out of scope of the present document.
2.	The API invoker and CAPIF core function shall establish a secure session based on TLS (Server side certificate authentication). The API invoker shall use the enrolment information obtained in step 1 to establish the TLS session with the CAPIF core function.
3.	After successful establishment of the TLS session, the API invoker shall send an Onboard API invoker request message to the CAPIF core function along with the enrolment credential (OAuth 2.0 [4] access token). The API invoker generates the key pair {Private Key, Public key} and provides the public key along with the Onboard API invoker request.
4.	The CAPIF core function shall validate the enrolment credential (OAuth 2.0 [4] access token). If validation of the credential (the OAuth 2.0 [4] access token in this example) is successful, the CAPIF core function shall generate an API invoker's profile as specified in TS 23.222 [3] which may contain the selected method for AEF authentication and authorization between the API Invoker and the AEF (see subclause 6.5.2). The CAPIF core function may generate API invoker's certificate on its own, for the assigned API invoker identity and public key. This certificate shall be used by the API invoker for subsequent authentication procedures with the CAPIF core function and may be used for establishing a secure connection and authentication with the API Exposing Function. The CAPIF core function may optionally generate an Onboard_Secret if the subscribed Service API uses Method 3 (as specified in clause 6.5.2.3 of the present document) for CAPIF-2e security. The Onboard_Secret value remains the same during the lifetime of the onboarding, and shall be bound to the CAPIF core function specific API Invoker ID.
NOTE 2:	When API invoker's client certificate is issued by the third party, then in Step 3 the API invoker can additionally include the certificate in Onboard API Invoker request message. If the CAPIF core function trusts the issuer of the API invoker's client certificate, then the CAPIF Core Function includes the provided certificate in the API invoker's profile, in step 4. It is up to the CAPIF domain policy to accept the client certificates issued by third party.
5.	The CAPIF core function shall respond with an Onboard API invoker response message. The response shall include the CAPIF core function assigned API invoker ID, AEF Authentication and authorization information (if generated in step 4), API invoker's certificate and the API invoker Onboard_Secret (if generated by the CAPIF core function).",TS 33.122,6.1,all_images/image_261.jpeg,Security procedure for API invoker onboarding 
"The API invoker and the API exposing function shall follow the procedure in this sub-clause to establish dedicated secure session using TLS connection based on Pre-Shared Key (PSK). CAPIF-1e authentication shall be used to bootstrap a Pre-Shared key for authenticating a TLS connection for CAPIF-2e. It is assumed that both the API invoker and the CAPIF core function are pre-provisioned with certificates. The TLS profile as specified in Annex E of TS 33.310 [2] shall be used.
Figure 6.5.2.1-1 details the message flow between the API invoker, the CAPIF core function and the API exposing function, to establish secure CAPIF-2e interface using a pre-shared key for authentication.
Figure 6.5.2.1-1: CAPIF-2e interface authentication and protection using TLS-PSK
1.	CAPIF-1e authentication and secure session is established as specified in subclause 6.3.1 of the present document. The CAPIF core function shall provide the validity timer value for the key AEFPSK.
2.	After successful establishment of TLS on CAPIF-1e, the API invoker and the CAPIF core function shall derive the key AEFPSK.
The Key AEFPSK shall be bound to an AEF and shall be derived as specified in Annex A. The API invoker and the CAPIF core function starts the validity timer for the key AEFPSK.
3. The API Invoker shall send Authentication Initiation Request to the AEF, including the CAPIF core function assigned API invoker ID.
Steps 1 and 2 of this procedure may be skipped if the API invoker is already in possession of a valid key AEFPSK. In this case, the API invoker begins the procedure at step 3.
NOTE: 	Void.
4. The AEF shall request for security information from the CAPIF Core Function to perform authentication and secure interface establishment with the API invoker, if the AEF does not have a valid key. The CAPIF Core Function provides the security information related to the chosen security method (TLS-PSK: AEFPSK) to the AEF over CAPIF-3 reference point. The CAPIF core function shall provide the remaining validity timer value for the key AEFPSK.
5. After fetching the relevant security information (AEFPSK) for the authentication, the AEF shall send Authentication Initiation Response message to API invoker to initiate the TLS session establishment. The AEF starts the validity timer based on the value received from the CAPIF core function in step 4.
6. The API Invoker and the AEF shall perform mutual authentication using the key AEFPSK and establish TLS session over the CAPIF-2e.
After successful establishment of TLS on CAPIF-2e reference point, the API exposing function shall authorize the API invoker's service API invocation request based on authorization information obtained from CAPIF core function as specified in subclause 8.16 of TS 23.222 [3].",TS 33.122,6.5.2.1,all_images/image_262.png,CAPIF-2e interface authentication and protection using TLS-PSK
"The API invoker and the API exposing function shall follow the procedure in this subclause to establish dedicated secure session over CAPIF-2e using TLS based on certificate based mutual authentication. It is assumed that both API invoker and API exposing function are pre-provisioned with certificates.
Figure 6.5.2.2-1 details the message flow between the API invoker, the CAPIF core function and the API exposing function related to this security method.
Figure 6.5.2.2-1: CAPIF-2e interface authentication and protection using certificate based mutual authentication
1. The API invoker shall send Authentication Initiation Request to the AEF, including API invoker ID.
2. The AEF shall request for security information from the CAPIF Core Function to perform authentication and secure interface establishment with the API invoker. The CAPIF Core Function provides the security information related to the chosen security method (TLS-PKI) to the AEF over CAPIF-3 reference point. CAPIF core function may return API invoker's root CA certificate for the AEF to validate the API invoker's certificate.
3. After fetching the relevant security information for the authentication, AEF shall send Authentication Initiation Response message to API invoker to initiate the TLS session establishment procedure.
4. Then the API Invoker and the AEF shall perform mutual authentication using certificates and establish TLS session over the CAPIF-2e. Certificate based authentication shall follow the profiles given in 3GPP TS 33.310 [2], clauses 6.1.3a and 6.1.4a. The structure of the PKI used for the certificate is out of scope of the present document.
After successful establishment of TLS on CAPIF-2e reference point, the API exposing function shall authorize the API invoker's service API invocation request based on authorization information obtained from CAPIF core function as specified in subclause 8.16 of TS 23.222 [3].",TS 33.122,6.5.2.2,all_images/image_263.jpeg,CAPIF-2e interface authentication and protection using certificate based mutual
"This method details establishment of secure channel over CAPIF-1e, CAPIF-2e reference points, and uses the OAuth 2.0 [4] token based mechanism to authorize and honour API invoker's northbound API invocations to the API exposing function. Figure 6.5.2.3-1 details security information flows between the API invoker, the CAPIF core function and the API exposing function. It is assumed that the API invoker, the CAPIF core function and the AEF are pre-provisioned with the appropriate credentials and related information to establish a secure session.
As per OAuth 2.0 [4], the CAPIF core function shall perform the functionality of the authorization server and provide the token endpoint, the API invoker shall perform the function of the client functionality, while the API exposing function shall perform the resource server functions. The API invoker client (client endpoint) shall be registered as a confidential client type with an authorization grant type of 'client credentials'. The authorization shall be previously arranged in the CAPIF core function. The access token shall follow the profile described in annex C.
NOTE: How the authorization is pre-arranged (pre-configured) with the CAPIF core function is out of scope of the present document
Figure 6.5.2.3-1: CAPIF-2e interface authentication and protection using Access Tokens
1. CAPIF-1e authentication and secure session establishment is performed as specified in subclause 6.3.1.
2. After successful establishment of TLS session over CAPIF-1e, as described in subclause 6.3.1 of the present document, the API invoker shall send an Access Token Request message to the CAPIF core function as per the OAuth 2.0 [4] specification.
3. The CAPIF core function shall verify the Access Token Request message per OAuth 2.0 [4] specification.
4. If the CAPIF core function successfully verifies the Access Token Request message, the CAPIF core function shall generate an access token specific to the API invoker and return it in an Access Token Response message.
Steps 1 to 4 of this procedure may be skipped if the API invoker is already in possession of a valid OAuth access token. In this case, the API invoker begins the procedure at step 5.
NOTE 1:	The API invoker may include the CAPIF core function assigned API invoker ID and the Onboard_Secret in the OAuth access token request message for the CAPIF core function to validate the access token request.
NOTE 2: Void.
5. On CAPIF-2e, the API invoker authenticates to the AEF by establishing a TLS session with the API exposing function based on the authentication and authorization method (i.e. Server (AEF) side certificate authentication or certificate-based mutual authentication) as indicated by CAPIF core function. The following procedure shall be performed prior to establishment of TLS session.
The API invoker shall send Authentication Initiation Request to the AEF, including API invoker ID.
The AEF shall request for security information from the CAPIF Core Function to perform authentication and secure interface establishment with the API invoker. The CAPIF Core Function provides the security information related to the chosen security method (TLS with OAuth token) to the AEF over CAPIF-3 reference point. The CAPIF core function may return API invoker's root CA certificate for the AEF to validate the API invoker's certificate.
After fetching the relevant security information for the authentication, the AEF shall send Authentication Initiation Response message to API invoker to initiate the TLS session establishment procedure.
6. With successful authentication to the AEF on CAPIF-2e, the API invoker shall initiate invocation of a 3GPP northbound API with the AEF. The access token received from the CAPIF core shall be sent along with the northbound API invocation request as per OAuth 2.0 [4].
7. The API exposing function shall validate the access token. The AEF verifies the integrity of the access token by verifying the CAPIF core function signature If validation of the access token is successful, the AEF shall verify the API invoker's Northbound API invocation request against the authorization claims in access token, ensuring that the API Invoker has access permission for the requested service API.
8. After successful verification of the access token and authorization claims of the API invoker, the requested northbound API shall be invoked and the appropriate response shall be returned to the API invoker.",TS 33.122,6.5.2.3,all_images/image_264.jpeg,CAPIF-2e interface authentication and protection using Access Tokens
"Pre-conditions:
1.	The API invoker has been onboarded successfully.
Figure 6.8-1: Security procedure for API invoker offboarding
0.	TLS session is established successfully between the CAPIF core function and the API invoker.
1.	An event occurs within the API invoker to trigger the offboarding action.
NOTE:	The definition of events that trigger offboarding is outside the scope of the present document.
2.	The API invoker shall send Offboard API invoker request message to the CAPIF core function, including the CAPIF core function specific API invoker ID which was assigned by the CAPIF core function during the onboarding procedure.
3.	The CAPIF core function shall verify the API invoker ID received in step 2 and check that the corresponding profile exists for this API invoker. With successful verification of the API invoker ID and its profile, the CAPIF core function shall cancel the enrolment of the API invoker and delete the API invoker profile. This includes deletion of API invoker certificate, service API authentication and authorization information, and onboard secret (if applicable). Depending on the operator policy, the CAPIF core function may retain the information of the offboarded API invoker.
4.	The CAPIF core function sends Offboard API invoker response message, indicating the successful offboarding of the API invoker.
5.	The API invoker shall delete the information, such as API invoker ID, Service API authentication / authorization information, API invoker certificate, Onboard_Secret (if applicable).
6.	The CAPIF core function shall tear down the TLS session with the API invoker.
7.	The CAPIF core function shall send Event notification message to the API exposing function to indicate that this API invoker is no longer valid.
8.	The API exposing function shall delete the security related information associated with this API invoker depending on the method that was used previously to authenticate the API invoker, e.g. AEFPSK (TLS-PSK method as described in subclause 6.5.2.1), root certificate to validate the API invoker certificate (PKI method as described in subclause 6.5.2.2), access token (OAuth 2.0 method as described in subclause 6.5.2.3 of the present document, respectively).
9.	The API exposing function shall tear down the TLS connection with the API invoker.
10.	The API exposing function shall return Event notification acknowledge message to indicate that the security related information associated with this API invoker is successfully deleted and thus the API invoker no longer an acknowledged user.",TS 33.122,6.8,all_images/image_265.jpeg,Security procedure for API invoker offboarding
"In case of GPL_ME, the GPL protocol entity is conceptually located either between the transport mechanism (which could e.g. be SMS, IP, IP/UDP) and the application, or included in the application.
In case of GPL_U, the GPL_U protocol entity is located within the targeted USIM or ISIM.
When receiving a GPL protected message, the recipient transfers the message to the GPL protocol entity How the recipient knows that the message is a GPL message is up to each transport mechanism to define. It could be through, e.g., a special application ID that is tagged onto the message, in which case a GPL application ID needs to be defined.
In GPL_ME, the message is delivered to the transport mechanism again after GPL processing is complete. This time around the GPL application ID and GPL related data has been removed, and what remains is a regular application data message (which is routed to the intended application using the transport layers normal dispatching mechanism). The processing model for GPL_ME is depicted in Figure 5.1-1.
In case of GPL_U, the GPL protected message is delivered to the targeted USIM or ISIM that will process the GPL message. The application data remain in the USIM or ISIM for use by the application defined therin.
Figure 5.1-1: The processing model for GPL_ME agnostic applications. Inbound processing to the right and outbound processing to the left.
The case when the GPL_ME protocol entity is logically located between the transport mechanism and the application is illustrated in Figure 5.1-1. In this case the application does not need to be aware of GPL, and any legacy application can use GPL without modifications. The other case is that the application is aware of GPL. The reason for this may be that the application needs to inform the GPL protocol entity about which security association to use (i.e., the application calls the GPL protocol entity directly, and the GPL protocol entity may either pass the GPL encapsulated message to the transport mechanism, or return it to the application).",TS 33.224,5.1,all_images/image_267.png,The processing model for GPL_ME agnostic applications. Inbound processing to the
"This clause describes the GAA and ID-FF / SAML v2.0 / ID-WSF architecture. The GAA system consists of UE, BSF, NAF, and HSS (and Zn-Proxy dependent on configuration) as described in TS 33.220 [1].
In the Liberty Alliance architecture the following system entities exist: Principal (shown as UE in the figures), IdP, DS, SP, and the roles WSC, and WSP. Typical Liberty Alliance network models are shown for ID-FF in Figure 4.2.-1 and for ID-WSF in 4.2.-2.
As SAML v2.0 [28] was specified with ID-FF 1.2 taken as an input, SAML v2.0 is a superset of ID-FF 1.2 and SAML v1.1 with some relatively small differences (mostly extensions). The related system entities are: UA, SP and IdP (User Agent, Service Provider and Identity Provider, respectively). For this strong similarity, no separate discussion on SAML v2.0 is given in this section unless necessary. However, as SAML v2.0 has formally superseded ID-FF 1.2, it is recommended that the solutions implementing the interworking functionality described in this TR are based on SAML v2.0, rather than ID-FF v1.2.
Figure 4.2-1: Liberty Alliance network model for ID-FF
For easy integration in current web deployment, some variants of ID-FF do not use the SOAP-based connection between IdP and SP (as shown e.g. in figure 4.2-1), but rely solely on HTTP-based connections originating in UE. Regarding SAML v2.0, the Web Browser SSO Profile [13] is used.
Regarding GAA/GBA interworking with Liberty ID-FF, in principle Liberty ID-FF Identity Provider (IdP) Specification [7] is the only specific ID-FF service that it is relevant for the discussion regarding authentication interworking.
Figure 4.2-2: General Liberty Alliance network model for ID-WSF
Regarding GAA/GBA interworking with Liberty ID-WSF, in principle Liberty ID-WSF Authentication Service (AS) Specification [8] is the only specific ID-WSF service that it is relevant for the discussion regarding authentication interworking. Liberty Alliance specifies the AS as part of the IdP in ID-WSF taking the authentication function in ID-WSF. This is in contrast to ID-FF, where the authentication function is not a separate service within IdP. First it is outlined, how the Liberty ID-WSF Authentication Service fits together with the GBA architecture, then the more complex scenario that includes a Single Sign On Service and an Authentication Service is described.
The typical Liberty ID-WSF attribute sharing infrastructure including WSC, WSPs and DS does usually not interwork with GAA/GBA. A WSC would request end user attributes from a WSP and all the required security aspects would be supported by the DS.
Liberty ID-WSF ""Authentication Service and Single Sign-On Service Specification"" [8] describes procedures so that:
1.	A user authenticates to an AS using SOAP-based interface;
2.	A user requests a security token to access a particular SP;
3.	A user presents the received security token to the SP.
This procedure is described in clause 4.3.5 and does not require any further interaction with WSCs, WSPs or DSs.  The Liberty ID-WSF Authentication Service may also be used by WSCs to be able to interact with a DS (e.g. when a Liberty ID-FF infrastructure is not available and a WSC needs to interact with a DS in order to discover user attributes). Here the DS would act as a SP that needs to authenticate the WSC. This would be an entity peer authentication rather than a GBA/GAA based end-user authentication. Thus the only potential for interworking between the ID-WSF Authentication Service and GAA/GBA is where a Liberty implementation of a WSC in a User Equipment (i.e. a Liberty User Agent or Device, LUAD-WSC) wants to get access to a SP (e.g. a DS or any other SP). Therefore, the roles and architecture elements relevant are described in figure 4.2-3.
Figure 4.2-3: Liberty Alliance network model for ID-WSF Authentication Service
The Liberty Alliance Architecture might also not only contain an Authentication Service (AS), but also a separate Single Sign On Service (SSOS) that interacts directly with an SP. The AS provides security tokens to the UE which may be used with all services offered in the domain of the same provider. The scenario with SSOS is necessary when either the communication between UE and SP may by some reason only be based on ID-FF protocols, or if the service is offered by some other provider. The network model for this scenario is depicted in 4.2-4:
Figure 4.2-4: Liberty Alliance network model for ID-WSF Authentication Service with Single Sign On Service
NOTE 1:	The dashed line indicates the authentication which is out of scope of Liberty Alliance ID-FF and ID-WSF specifications. The solid lines and boxes indicate Liberty Alliance reference points and elements.
The scenarios where the GBA architecture is combined with the ID-WSF AS have the following interworking elements:
- 	For the UE: UE comprises both GBA and LAP functionality and thus has Ub interface to BSF.
- 	For the AS: AS contains authentication functionality and thus has to interwork with GBA. Details depend on the actual collocation of elements and are given in the following sub-clauses.
The reference point between UE and AS is affected in this scenario, as can be seen e.g. in Figure 4.2-4. The reference point between UE and AS utilizes the Simple Authentication and Security Layer (SASL) protocol (RFC 2222 [17]) as authentication support layer according to Liberty Alliance specifications.
The UE-AS reference point may utilize digest authentication as a SASL mechanism (RFC 2831 [18]). This would be a specific implementation of the Ua protocol similar to TS 33.222 [2]. The protocols could use the shared secret of GBA (Ks_NAF) for authentication, e.g. digest-MD5 or other authentication methods within SASL
NOTE 2:	There are further interworking cases possible, but all require more new specifications or adaptations of existing specifications compared with the above-mentioned way. In particular, one case stands out where the AS acts as BSF. Then a version number information of the used AKA protocol must be transported within SASL, but this would no longer fall within the realm of GAA/GBA. There would be no Ub and Ua protocols as specified in TS 33.220 [1], but only a straight-forward use of e.g. digest AKA within SASL for authentication. All other features of GBA would not be used.
The Liberty-specific interfaces are secured using methods described in [14] and [6]. There are several possibilities for the UE interfaces towards Liberty entities e.g. pure HTTP-based or PAOS-based [20]. For ID-WSF, the reference points between the UE and the SP, respectively the UE and the IdP might also be SOAP-based.
For a mobile network operator deploying 3GPP GBA system and the Liberty ID-FF or ID-WSF, there are two alternative architectures possible. The Liberty Authentication function might be collocated with the NAF, or it might be collocated with the BSF and the SP collocated with the NAF. For ID-WSF, the reference points between the UE and the SP, respectively the UE and the IdP might also be SOAP based. These alternative architectures are discussed in the following sub-clauses.
In practice one or the other collocation scenario will be deployed, depending on the specifics of the operator’s network and on its business requirements. The following could be used as a guideline which collocation setting to use:
1)	If the operator wants to play the role of both, a BSF and an IdP, having both similar roles, it seems natural to collocate them (optimized network flows and optimized costs for the operator).
2)	If the operator wants to play the BSF role, but the IdP role will be played by somebody else (being that for example another organization inside the operator, or a 3rd Party), in this case it may not be possible to collocate IdP and BSF but still there is a possibility to reuse GBA-based strong authentication performed by the collocation of IdP and NAF.",TR 33.980,4.2,all_images/image_269.jpeg,Liberty Alliance network model for ID-WSF Authentication Service
"In this clause it is assumed that the GBA NAF contains a Liberty IdP as defined in [7]. The creation of the authentication and re-authentication credentials is handled by GBA.
NOTE:	When the UE contacts the IdP/NAF with a valid B-TID from an earlier bootstrapping run, then the NAF can have its local policy that can be stricter than the BSF policy, when to require a new bootstrapping run [1].
The GBA procedure is triggered by IdP/NAF as defined in TS 33.220 [1]. All [6] and [7] specific tasks are fulfilled by the IdP implementation in the NAF, this is transparent to the GBA function in the UE.
This clause also applies to the case where GAA interworks with Liberty Alliance ID-WSF. In this case the AS/NAF as part of IdP takes the role of the IdP/NAF in ID-FF. For the sake of brevity only IdP/NAF is mentioned in the following text.",TR 33.980,4.3,all_images/image_270.jpeg,Message flow for SSO with <lib:AuthnResponse> and conventional TLS with GBA
"In this clause it is assumed that the GBA NAF contains a Liberty IdP as defined in [7]. The creation of the authentication and re-authentication credentials is handled by GBA.
NOTE:	When the UE contacts the IdP/NAF with a valid B-TID from an earlier bootstrapping run, then the NAF can have its local policy that can be stricter than the BSF policy, when to require a new bootstrapping run [1].
The GBA procedure is triggered by IdP/NAF as defined in TS 33.220 [1]. All [6] and [7] specific tasks are fulfilled by the IdP implementation in the NAF, this is transparent to the GBA function in the UE.
This clause also applies to the case where GAA interworks with Liberty Alliance ID-WSF. In this case the AS/NAF as part of IdP takes the role of the IdP/NAF in ID-FF. For the sake of brevity only IdP/NAF is mentioned in the following text.",TR 33.980,4.3,all_images/image_271.jpeg,Message flow for SSO with Artefact transfer and usage of GBA
"In this clause it is assumed that the GBA NAF contains a Liberty IdP as defined in [7]. The creation of the authentication and re-authentication credentials is handled by GBA.
NOTE:	When the UE contacts the IdP/NAF with a valid B-TID from an earlier bootstrapping run, then the NAF can have its local policy that can be stricter than the BSF policy, when to require a new bootstrapping run [1].
The GBA procedure is triggered by IdP/NAF as defined in TS 33.220 [1]. All [6] and [7] specific tasks are fulfilled by the IdP implementation in the NAF, this is transparent to the GBA function in the UE.
This clause also applies to the case where GAA interworks with Liberty Alliance ID-WSF. In this case the AS/NAF as part of IdP takes the role of the IdP/NAF in ID-FF. For the sake of brevity only IdP/NAF is mentioned in the following text.",TR 33.980,4.3,all_images/image_272.jpeg,Message flow for ID-WSF AS and SSO with Response transfer and usage of GBA
"In this clause it is assumed that the GBA NAF contains a Liberty IdP as defined in [7]. The creation of the authentication and re-authentication credentials is handled by GBA.
NOTE:	When the UE contacts the IdP/NAF with a valid B-TID from an earlier bootstrapping run, then the NAF can have its local policy that can be stricter than the BSF policy, when to require a new bootstrapping run [1].
The GBA procedure is triggered by IdP/NAF as defined in TS 33.220 [1]. All [6] and [7] specific tasks are fulfilled by the IdP implementation in the NAF, this is transparent to the GBA function in the UE.
This clause also applies to the case where GAA interworks with Liberty Alliance ID-WSF. In this case the AS/NAF as part of IdP takes the role of the IdP/NAF in ID-FF. For the sake of brevity only IdP/NAF is mentioned in the following text.",TR 33.980,4.3,all_images/image_273.jpeg,Message flow for SSO with <samlp:Response> and TLS with GBA
"In this clause it is assumed that the GBA NAF contains a Liberty IdP as defined in [7]. The creation of the authentication and re-authentication credentials is handled by GBA.
NOTE:	When the UE contacts the IdP/NAF with a valid B-TID from an earlier bootstrapping run, then the NAF can have its local policy that can be stricter than the BSF policy, when to require a new bootstrapping run [1].
The GBA procedure is triggered by IdP/NAF as defined in TS 33.220 [1]. All [6] and [7] specific tasks are fulfilled by the IdP implementation in the NAF, this is transparent to the GBA function in the UE.
This clause also applies to the case where GAA interworks with Liberty Alliance ID-WSF. In this case the AS/NAF as part of IdP takes the role of the IdP/NAF in ID-FF. For the sake of brevity only IdP/NAF is mentioned in the following text.",TR 33.980,4.3,all_images/image_274.png,Message flow for SSO with <samlp:Response> and usage of PSK TLS with GBA
"In this clause it is assumed that the GBA NAF contains a Liberty IdP as defined in [7]. The creation of the authentication and re-authentication credentials is handled by GBA.
NOTE:	When the UE contacts the IdP/NAF with a valid B-TID from an earlier bootstrapping run, then the NAF can have its local policy that can be stricter than the BSF policy, when to require a new bootstrapping run [1].
The GBA procedure is triggered by IdP/NAF as defined in TS 33.220 [1]. All [6] and [7] specific tasks are fulfilled by the IdP implementation in the NAF, this is transparent to the GBA function in the UE.
This clause also applies to the case where GAA interworks with Liberty Alliance ID-WSF. In this case the AS/NAF as part of IdP takes the role of the IdP/NAF in ID-FF. For the sake of brevity only IdP/NAF is mentioned in the following text.",TR 33.980,4.3,all_images/image_275.jpeg,Message flow for SSO with Artefact resolution (SAML v2.0) and usage of GBA
"Figure 5.2.4-1 describes the VAL Authentication Framework using the OpenID Connect protocol. when using HTTPS It describes the steps by which a VAL UE authenticates to the SIM-S, resulting in a set of credentials delivered to the UE uniquely identifying the VAL service ID(s). The authentication framework supports extensible user authentication solutions based on the VAL service provider policy (shown as step 3). User authentication methods in support of step 3 (e.g. biometrics, secureID, etc.) are possible but not defined here.
Figure 5.2.4-1: OpenID Connect (OIDC) flow supporting VAL user authentication
Step 1:	VAL UE establishes a secure tunnel with the SIM-S.
Step 2:	VAL UE sends an OpenID Connect Authentication Request to the SIM-S. The request may contain an indication of authentication methods supported by the UE.
Step 3: User Authentication is performed between VAL UE and the SIM-S.
NOTE:	The primary credentials for user authentication (e.g. biometrics, secureID, OTP, username/password) are based on VAL service provider policy. The method chosen by the VAL service provider for authentication and authorization is neither defined nor limited by the present document, it depends on the Vertical services and authentication and authorization methods supported by it.
Step 4:	SIM-S sends an OpenID Connect Authentication Response to the UE containing an authorization code.
Step 5:	UE sends an OpenID Connect Token Request to the SIM-S, passing the authorization code.
Step 6:	SIM-S sends an OpenID Connect Token Response to the UE containing an ID token and an access token (each which uniquely identify the user of the VAL service or key management service). The ID token is consumed by the UE to personalize the VAL client for the VAL user, and the access token is used by the UE to communicate and authorize the identity of the VAL user to the VAL server(s) and the VAL services.",TS 33.434,5.2.4,all_images/image_276.jpeg,OpenID Connect (OIDC) flow supporting VAL user authentication
"Editor’s note: SCP security domains to be defined.
TS 23.501 [3] addresses the aspects of handling multiple SCPs in indirect communication without and with delegated discovery and introduced SCP domains, which comprises multiple SCPs. NF Service Consumers or/and SCPs need to request NRF to discover the next hop SCP to route a service request from the NF Service Consumer to a NF Service Producer via multiple SCPs. 23.502 describes in the SCP profile SCP domain registration details about interconnected SCPs to and thus also identifies SCPs that interconnect domains.
The primary purpose of SCP domains is to describe the connectivity topology within a network. All SCPs within an SCP domain can directly interconnect. One SCP can be part of multiple SCP domains. In fact, the primary purpose of intermediate SCPs in the path is to interconnect SCP domains, thus, there are boundaries between SCP domains at each SCP in the path.
PLMN-wide trust between NFs and SCPs is an option, but more restrictions could be desirable in complex networks with SCP domains, e.g. if SCPs are operated in different regions/provinces. There can be several technical domains within a PLMN, where equipment with different capabilities is deployed and signalling also varies in some respects, e.g., if equipment upgrade is performed in a stepwise manner. Such technical domains can be defined based on computer centre boundaries, based on operators of subnetworks, based on regions/provinces, etc.
Figure 5.2.1-1: Illustration of SCP domains connecting via dedicated SPCs
This key issue is to study whether there is a need of one or several SCP domains becoming regions of trust of finer granularity than PLMN and whether there is a necessity of trust and policing of communication within or among such domains, i.e. for the case that request messages traverse a boundary between trust domains.",TR 33.875,5.2.1,all_images/image_278.png,Illustration of SCP domains connecting via dedicated SPCs 
"The SCP requests services on behalf of the consumer in all indirect communication scenarios. The following procedure describes access token and service requests for Scenario D, and particularly how CCAs and access tokens are used to authorize the SCP to request services on behalf of the NF Consumer. For Scenario C, the same principles hold.
Figure 6.3.2.2-1: Service request of SCP on behalf of an NF Consumer
1.-4. Service request and access token request and response are performed as described in the previous clause, clause 6.3.2.1.
5.	The SCP sends a service request to the NF Service Producer. The service request contains the access token and optionally the CCA received in step 1. The access token contains the NF instance ID of the NF Service Consumer.
6.	The NF Service Producer validates the access token as described in TS 33.501 [2]. Because the network implements the procedures described in the previous clause, clause 6.3.2.1, the NRF has already verified that the SCP was authorized to request the access token on behalf of the NF Service Consumer. Hence the access token does not only authorize the consumer, but also implicitly authorizes the SCP to act on behalf of the NF Service Consumer.
7.-8. The remaining steps of the access token request and service request procedure are exactly as described in TS 33.501 [2].",TR 33.875,6.3.2.2,all_images/image_279.jpeg,Service request of SCP on behalf of an NF Consumer  
"Figure 6.6.2.1-1: With mutual authentication between NF and NRF at the transport layer. Discovery of the NF Service Producer:. 0. When a NF Service Consumer discover a NF Servcie Producer for a service, NRF provides information of target NF set and candidate target NF instance IDs belonging to the target NF set.. The NF set information in the discovery response from NRF to NF consumer needs to be end to end integrity protected, by e.g. TLS or solution to Key Issue #5, so that the SCP cannot modify the NF set information in the discovery response.. NF Service Consumer authorization:. 1-2. After mutual authentication between NF Service Consumer and NRF at the transport layer, the NF Service Consumer and NRF perform the ""Access token request before service access"" procedure. If the NF Service Consumer has already discovered the NF Service Producer, it can also perform the ""Access token request for a specific NF Service Producer/NF Service Producer instance"" procedure.. Service Request:. 4. Among the candidates NF instances list, the NF Service Consumer may select an NF instance for a Service Request. And the NF Service Consumer keep the list of candidate NF instances and NF set for verification of expected Service Response.. After acquiring an access token from the NRF, a NF Service Consumer may send a Service Request to the SCP.  The service request includes the access token and CCA of the NF Service Consumer.. The service request includes the 3gpp-Sbi-Routing-Binding header and/or 3gpp-Sbi-Discovery header in order to specify target NF Service Producer and/or target NF Set, so that the SCP is instructed to perform the NFp reselection within the scope of NF Set.. 5. An SCP forward a Service Request to the NF Service Producer. If needed, the SCP may reselect another NF Service Producer belonging to the same NF set.. Service Response:. 6-7. After receiving a Service Request, the NF Service Producer may verify the Service Request and may respond with a Service Response with CCA of the NF Service Producer. CCA of NF Service Producer includes NF instance ID of NF Service Producer and NF instance ID of NF Service Consumer.. 8-9. When receiving a Service Response, the NF Service Consumer may verify whether the NF instances ID of NF Service Producer which sends the Service Response is in the list of candidate NF instances for the Service Request.",TR 33.875,6.6.2.1,all_images/image_280.jpeg,With mutual authentication between NF and NRF at the transport layer
"Figure 6.6.2.2-1: for indirect communication with delegated discovery. 1.	The NF Service Consumer sends a service request to the SCP. The service request shall include NF service discovery factors such as target NF type and the NF Service Consumer's CCA as defined in clause 13.3.8.. 2.	The SCP may perform a NF discovery operation with the NRF using NF service discovery factors received in step 1.. 3. 	(same with step 3 in subclause 13.4.1.3.2 TS33.501.) The SCP sends an access token request (Nnrf_AccessToken_Get Request) to the NRF. The access token request includes parameters as defined in clause 13.4.1.1. The access token request may include the NF Service Consumer's CCA if received in Step 1.. 4.	(same with step 4 in subclause 13.4.1.3.2 TS33.501.) The NRF authenticates the NF Service Consumer using one of the methods described in clause 13.3.1.2. If NF Service Consumer authentication is successful and the NF Service Consumer is authorized based on the NRF policy, the NRF issues an access token as described in clause 13.4.1.1. The NRF uses the NF Service Consumer instance ID as the subject of the access token.. 5.	(same with step 5 in subclause 13.4.1.3.2 TS33.501.) The NRF sends the access token to the SCP in an access token response (Nnrf_AccessToken_Get Response).. 6.	(same with step 6 in subclause 13.4.1.3.2 TS33.501.) The SCP sends the service request to the NF Service Producer. The service request includes an access token (i.e., received in Step 1, received in Step 5, or previously cached), and may include the NF Service Consumer's CCA if received in Step 1.. 7.	(same with step 7 in subclause 13.4.1.3.2 TS33.501.) The NF Service Producer authenticates the NF Service Consumer by one of the methods described in clause 13.3.2.2 and if successful, it validates the access token as described in clause 13.4.1.1.. 8.	If the validation of the access token is successful, the NF Service Producer may respond with a Service Response with CCA of the NF Service Producer. CCA of NF Service Producer may include NF type and NF instance ID of NF Service Producer and NF instance ID of NF Service Consuer.. 9.	The SCP forwards the service response to the NF Service Consumer. The SCP may include the access token in the service response to NF Service Consumer for possible re-use in subsequent service requests.. 10.	When receiving a service response, the NF Service Consumer may verify whether the NF Service Producer belongs to the target NF type and authenticate NF Service Producer using CCA and X.509 certificate of the NF Service Producer.",TR 33.875,6.6.2.2,all_images/image_281.jpeg,for indirect communication with delegated discovery
,TR 33.874,6.1.2.1,all_images/image_283.jpeg,Number of UEs and PDU Sessions per network slice notification procedure
"The definitions of network product class and network product were documented in the TR 33.916 [2]. For implementing 3GPP defined functionalities in network products, some functionalities that relate to the supporting platform (e.g. hardware components, operating system, etc.) also need to be implemented. The platform provides execution environment for 3GPP defined functionalities. For physical network products, the platform and the 3GPP defined functionalities are tightly coupled, while for virtualised network products, the platform and the 3GPP defined functionalities are decoupled. The platform of virtualised network products composes of a hardware layer and a Virtualisation layer, and is common for 3GPP defined functionalities. Concept of 3GPP VNF is defined in TS 28.500 [5]. According to the concept in [5], a 3GPP VNF is 3GPP network function(s) that runs on a Network Function Virtualisation Infrastructure (NFVI), which is the platform of virtualised network products described above.
The realistic deployment scenarios are summarized in ETSI NFV-SEC 001 [6], based on which a 3GPP network operator can deploy 3GPP defined functionalities in three modes:
-	Mode 1. A network operator purchases 3GPP VNFs from its vendors and deploys it on a third party NFVI.
-	Mode 2. A network operator purchases 3GPP VNFs and the Virtualisation layer (e.g. hypervisor) from its vendors, and deploys them on a third party hardware layer.
-	Mode 3. A network operator purchases and deploys 3GPP VNFs, the Virtualisation layer and the hardware layer from its vendors.
NOTE: 	In order to implement virtualised product, some essential components besides 3GPP defined functions are also needed. Detailed description could be found in clause 5.
Each deployment mode requires the different composition of virtualised network products purchased and deployed by a network operator, which are subject to the testing and evaluation in SECAM scheme. Accordingly, the different composition of virtualised network products maps to three types of virtualised network product class as depicted in Figure 1:
-	Type 1: implement 3GPP defined functionalities only
-	Type 2: implement 3GPP defined functionalities and Virtualisation layer
-	Type 3: implement 3GPP defined functionalities, Virtualisation layer, and hardware layer
Figure 4.1.1-1: Three types of virtualised network product class
For type 2 and type 3, the.3GPP defined functionalities, the Virtualisation layer, and the hardware layer can be decoupled from each other and can be provided either by a vendor or by different vendors. In coupling scenario, the interface between components could be considered as internal interface.
Figure 4.1.1-2: Type2 in coupling scenarios
Figure 4.1.1-3: Type3 in coupling scenarios
For type 2 in the decoupling scenario as depicted in Figure 2, a network operator can purchase the 3GPP defined functionalities and the Virtualisation layer from the same or different vendors. So, it is required to assure the security of the decoupled 3GPP defined functionalities and the Virtualisation layer separately. Only decoupled 3GPP defined functionalities is in 3GPP scope. The security assurance evaluation about pure virtualisation layer is out of 3GPP scope.
For type 3 in the decoupling scenario as depicted in Figure 3, there are three decoupling ways. Like type 2 in the decoupling scenario, the security assurance requirements of the decoupled components need to be considered respectively. Only decoupled 3GPP defined functionalities in Figure 4.1.1-3 (1) and in Figure 4.1.1-3 (3) or coupled 3GPP defined functionality and virtualisation layer in Figure 4.1.1-3 (2) is in 3GPP scope. The security assurance evaluation about the others are out of 3GPP scope.
Note 1:	For decoupling scenarios supporting a 3GPP GVNP, it could be considered as coupling part which is in 3GPP scope and decoupled part which is out of 3GPP scope. Only coupling part in 3GPP scope will be considered in rest of the present document.
NOTE 2:	For the purpose of testing a 3GPP GVNP of type 1 or a 3GPP GVNP of type 2, NFVI for GVNP for type 1, or hardware for GVNP for type 2 are assumed to have gone through security assurance testing in the same rigorous manner that is similarly applied to the security assurance testing of any other 3GPP network product under consideration in SCAS.",TR 33.818,4.1.1,all_images/image_284.jpeg,Three types of virtualised network product class
"Complete self-evaluation of a 3GPP virtualised network product (e.g. vMME (MME VNF) + virtualised layer from vendor X)
This example below is similar to the SECAM defined Security assurance process in the figure 4.7.3.2-1 except that the vendor conducts all the phases of evaluation.
Figure 4.7.3.2-1: Complete self-evaluation of a 3GPP virtualised network product
 (e.g. vMME (MME VNF) + virtualised layer from vendor X)
Evaluation results are checked by operators and dispute on evaluation results is resolved by the SECAM Accreditation Body.",TR 33.818,4.7.3.2,all_images/image_288.jpeg,Complete self-evaluation of a 3GPP virtualised network product
"According to the scope of a SECAM SCAS in clause 4.1.2, a SCAS contains security requirements and associated test cases, and may contain environmental assumptions which will be validated during product deployment. So, like GNP in TR 33.916 [2], the countermeasures deemed relevant to threat mitigation will also take the form of either:
-	security requirements on the network product with associated test cases; or
-	operational environment security assumptions for a given product class.
For GVNP, the operational environment security assumptions among different product classes vary greatly, for example some sensitive 3GPP functions may need to be run from special security domain (See clause 5.2.1 of TR 33.848 [9]) or may need to implement hardware (See clause 4.9 in TR 33.916 [2]) with special security requirement that make it difficult, if not impossible to be realized in a GVNP implementation or the protection of certain data may require higher level of protection due to the extreme sensitive nature of the data (e.g. lawful interception target lists). It may also be necessary to consider such assumptions during testing so that stringent security requirements can be met. Any such consideration should be well-documented as part of both the testing environment so that the validation during product deployment can be carried out and duplicated.
The Security Requirements clauses within the pertinent TS contain the security requirements identified according to the threats (see figure 5.2.5.1-1).
Figure 5.2.5.1-1: Process for deriving security requirements in a SCAS document
The security requirements include security functional requirements and hardening requirements (see clause 5.2.1). Since SECAM tasks include Basic Vulnerability Testing, basic vulnerability testing requirements are also included in security requirements of a SCAS. The types of the security requirements are same as in TR 33.916 [2].
The three types of the levels of detail for security requirements in clause 5.2.3.1.1 of TR 33.916 [2] and the relationship between these levels are generic and are also applicable to describe the level of detail of security requirements for a GVNP.",TR 33.818,5.2.5.1,all_images/image_293.jpeg,Process for deriving security requirements in a SCAS document
"The open 5G ProSe Direct Discovery security procedure is described as follows.
Figure 6.1.3.1-1: Open 5G ProSe Direct Discovery security procedure
1.	The Announcing UE sends a Discovery Request message containing the ProSe Application ID to the 5G DDNMF in its HPLMN in order to be allowed to announce a code on its serving PLMN (either VPLMN or HPLMN).
2.	If the Announcing UE wants to send announcements in the VPLMN, it needs to be authorized from the VPLMN 5G DDNMF. The 5G DDNMF in the HPLMN requests authorization from the VPLMN 5G DDNMF by sending Announce Auth.() message.
3.	VPLMN 5G DDNMF responds with an Announce Auth. Ack () message, if authorization is granted. There are no changes to these messages for the purpose of protecting the transmitted code for open 5G ProSe Direct Discovery. If the Announcing UE is not roaming, these steps do not take place.
4.	The 5G DDNMF in HPLMN of the Announcing UE returns the ProSe Application Code that the Announcing UE can announce and a Discovery Key associated with it. The 5G DDNMF stores the Discovery Key with the ProSe Application Code. In addition, the 5G DDNMF provides the UE with a CURRENT_TIME parameter, which contains the current UTC-based time at the 5G DDNMF, a MAX_OFFSET parameter, and a Validity Timer. The UE sets a clock which is used for ProSe authentication (i.e. ProSe clock) to the value of CURRENT_TIME and the UE stores the MAX_OFFSET parameter, overwriting any previous values. The Announcing UE obtains a value for a UTC-based counter associated with a discovery slot based on UTC time. The counter is set to a value of UTC time in a granularity of seconds. The UE may obtain UTC time from any sources available, e.g. the RAN via SIB9, NITZ, NTP, GPS, via Ub interface (in GBA) (depending on which is available).
NOTE 1:	The UE may use unprotected time to obtain the UTC-based counter associated with a discovery slot. This means that the discovery message could be successfully replayed if a UE is fooled into using a time different to the current time. The MAX_OFFSET parameter is used to limit the ability of an attacker to successfully replay discovery messages or obtain correctly MICed discovery message for later use. This is achieved by using MAX_OFFSET as a maximum difference between the UTC-based counter associated with the discovery slot and the ProSe clock held by the UE.
NOTE 2:	A discovery slot is the time at which an Announcing UE sends the announcement.
5.	The Announcing UE starts announcing, if the difference between UTC-based counter provided by the system associated with the discovery slot and the UE's ProSe clock is not greater than the MAX_OFFSET and if the Validity Timer has not expired. For each discovery slot it uses to announce, the Announcing UE calculates a 32-bit Message Integrity Check (MIC) to include with the ProSe Application Code in the discovery message. Four least significant bits of UTC-based counter are transmitted along with the discovery message. The MIC is calculated as described in clause  A.6 using the Discovery Key and the UTC-based counter associated with the discovery slot.
6.	The Monitoring UE sends a Discovery Request message containing the ProSe Application ID to the 5G DDNMF in its HPLMN in order to get the Discovery Filters that it wants to listen for.
7.	The 5G DDNMF in the HPLMN of the Monitoring UE sends Monitor Req. message to the 5G DDNMF in the HPLMN of the Announcing UE.
8.	The 5G DDNMF in the HPLMN of the Announcing UE sends Monitor Resp. message to the 5G DDNMF in the HPLMN of the Monitoring UE.
9.	The 5G DDNMF returns the Discovery Filter containing either the ProSe Application Code(s), the ProSe Application Mask(s) or both along with the CURRENT_TIME and the MAX_OFFSET parameters. The Monitoring UE sets its ProSe clock to CURRENT_TIME and stores the MAX_OFFSET parameter, overwriting any previous values. The Monitoring UE obtains a value for a UTC-based counter associated with a discovery slot based on UTC time. The counter is set to a value of UTC time in a granularity of seconds. The Monitoring UE may obtain UTC time from any sources available, e.g. the RAN via SIB9, NITZ, NTP, GPS (depending on which is available).
10.	The Monitoring UE listens for a discovery message that satisfies its Discovery Filter, if the difference between UTC-based counter associated with that discovery slot and UE's ProSe clock is not greater than the MAX_OFFSET of the Monitoring UE's ProSe clock.
11.	On hearing such a discovery message, and if the UE has either not checked the MIC for the discovered ProSe App Code via Match Report previously or has checked a MIC for the ProSe App Code via Match Report and the associated Match Report refresh timer (see steps 14 and 15 for details of this timer) has expired, or as required based on the procedure specified in TS 23.304 [2], the Monitoring UE sends a Match Report message to the 5G DDNMF in the HPLMN of the Monitoring UE. The Match Report contains the UTC-based counter value with four least significant bits equal to four least significant bits received along with discovery message and nearest to the Monitoring UE's UTC-based counter associated with the discovery slot where it heard the announcement, and other discovery message parameters including the ProSe App Code and MIC. If a Match Report is not required, the Monitoring UE shall locally process the discovery message and the rest of the procedure is not performed.
12.	The 5G DDNMF in the HPLMN of the Monitoring UE passes the discovery message parameters including the ProSe Application Code and MIC and associated counter parameter to the 5G DDNMF in the HPLMN of the Announcing UE in the Match Report message.
13.	The 5G DDNMF in the HPLMN of the Announcing UE shall check the MIC is valid. The relevant Discovery Key is identified by the ProSe Application Code.
14.	The 5G DDNMF in the HPLMN of the Announcing UE shall acknowledge a successful check of the MIC to the 5G DDNMF in the HPLMN of the Monitoring UE via the Match Report Ack message. The 5G DDNMF in the HPLMN of the Announcing UE include a Match Report refresh timer in the Match Report Ack message. The Match Report refresh timer indicates how long the UE will wait before sending a new Match Report for the ProSe Application Code.
15.	The 5G DDNMF in the HPLMN of the Monitoring UE acknowledges the MIC check result to the Monitoring UE. The 5G DDNMF returns the parameter ProSe Application ID to the UE. It also provides the CURRENT_TIME parameter, by which the UE (re)sets its ProSe clock. The 5G DDNMF in the HPLMN of the Monitoring UE may optionally modify the received Match Report refresh timer based on local policy and then include the Match Report refresh timer in the message to the Monitoring UE.",TS 33.503,6.1.3.1,all_images/image_294.jpeg,Open 5G ProSe Direct Discovery security procedure
"The security procedure for restricted 5G ProSe Direct Discovery Model A is described as follows.
Figure 6.1.3.2.2.1-1: Security procedure for restricted 5G ProSe Direct Discovery Model A
NOTE 1: When the user-plane based security procedure for the UE-to-Network Relay is used, the 5G PKMF takes the role of the 5G DDNMF as described in clause 6.3.3.2 of the present document.
Steps 1-4 refer to an Announcing UE:
1.	Announcing UE sends a Discovery Request message containing the Restricted ProSe Application User ID (RPAUID) to the 5G DDNMF in its HPLMN in order to get the ProSe Code to announce and to get the associated security material. In addition, the Announcing UE shall include its PC5 UE security capability that contains the list of supported ciphering algorithms by the UE in the Discovery Request message.
For 5G ProSe UE-to-Network Relay discovery, the 5G ProSe UE-to-Network Relay plays the role of the Announcing UE and sends a Relay Discovery Key Request instead of a Discovery Request. The Relay Discovery Key Request message includes the Relay Service Code (RSC) and the 5G ProSe UE-to-Network Relay's PC5 security capability.
2.	The 5G DDNMF may check for the announce authorization with the ProSe Application Server.
For 5G ProSe UE-to-Network Relay discovery, the 5G DDNMF may check with the UDM whether the UE-to-Network relay is authorized to announce UE-to-Network relay discovery message.
3.	If the Announcing UE is roaming, the 5G DDNMFs in the HPLMN and VPLMN of the Announcing UE exchange Announce Auth.
4.	The 5G DDNMF in the HPLMN of the Announcing UE returns the ProSe Restricted Code and the corresponding Code-Sending Security Parameters, along with the CURRENT_TIME and MAX_OFFSET parameters. The Code-Sending Security Parameters provide the necessary information for the Announcing UE to protect the transmission of the ProSe Restricted Code and are stored with the ProSe Restricted Code. The Announcing UE takes the same actions with CURRENT_TIME and MAX_OFFSET as described for the Announcing UE in step 4 of clause 6.1.3.1 of the present document. The 5G DDNMF in the HPLMN of the Announcing UE shall include the chosen PC5 ciphering algorithm in the Discovery Response message. The 5G DDNMF determines the chosen PC5 ciphering algorithm based on the ProSe Restricted Code and the received PC5 UE security capability in step 1. The UE stores the chosen PC5 ciphering algorithm together with the ProSe Restricted Code.
In addition, the 5G DDNMF in the HPLMN of the Announcing UE may associate the ProSe Restricted Code with the PC5 security policies and include the PC5 security policies in the Discovery Response message.
For 5G ProSe UE-to-Network Relay discovery, a Relay Discovery Key Response is used instead of the Discovery Response, and the RSC is used instead of the ProSe Restricted Code.
NOTE 2:	5G DDNMF may get the PC5 security policies in different ways (e.g. from PCF, from ProSe Application Server, or based on local configuration).
Steps 5-10 refer to a Monitoring UE:
5.	The Monitoring UE sends a Discovery Request message containing the RPAUID and its PC5 UE security capability to the 5G DDNMF in its HPLMN in order to be allowed to monitor for one or more Restricted ProSe Application User IDs.
For 5G ProSe UE-to-Network Relay discovery, the 5G ProSe Remote UE plays the role of the Monitoring UE and sends a Relay Discovery Key Request instead of the Discovery Request. The Relay Discovery Key Request message includes the RSC and the 5G ProSe Remote UE's PC5 security capability. The Remote UE may provide a list of PLMNs in which the UE is authorized to use a 5G ProSe U2N Relay. in the Relay Discovery Key Request.
6.	The 5G DDNMF in the HPLMN of the Monitoring UE sends an authorization request to the ProSe Application Server. If, based on the permission settings, the RPAUID is allowed to discover at least one of the Target RPAUIDs contained in the Application Level Container, the ProSe Application Server returns an authorization response.
For 5G ProSe UE-to-Network Relay discovery, the 5G DDNMF of the Remote UE may check with the UDM whether the Remote UE is authorized to monitor UE-to-Network relay discovery.
7.	If the Discovery Request is authorized, the 5G DDNMF in the HPLMN of the Monitoring UE contacts the 5G DDNMF in the HPLMN of the Announcing UE by sending a Monitor Request message, as specified in clause 6.3 of TS 23.304 [2], including the PC5 UE security capability received in step 5.
For 5G ProSe UE-to-Network Relay Discovery, Relay Discovery Key Request and RSC are used instead of Discovery Request and RPAUID. The 5G DDNMF of the remote UE discovers 5G DDNMF(s) of the potential 5G ProSe UE-to-Network relay(s) supporting the RSC based on HPLMNs of the potential 5G ProSe UE-to-Network relay(s) mapping to the RSC.
NOTE 2a:	5G DDNMF may get the HPLMNs of the potential 5G ProSe UE-to-Network relays in different ways (e.g. from PCF, or based on local configuration).
8.	The 5G DDNMF in the HPLMN of the Announcing UE may exchange authorization messages with the ProSe Application Server.
For 5G ProSe UE-to-Network Relay discovery, this step is skipped.
9.	If the PC5 UE security capability in step 5 includes the chosen PC5 ciphering algorithm, the 5G DDNMF in the HPLMN of the Announcing UE responds to the 5G DDNMF in the HPLMN of the Monitoring UE with a Monitor Response message including the ProSe Restricted Code, the corresponding Code-Receiving Security Parameters, an optional Discovery User Integrity Key (DUIK), and the chosen PC5 ciphering algorithm (based on the information/keys stored in step 4). The Code-Receiving Security Parameters provide the information needed by the Monitoring UE to undo the protection applied by the Announcing UE. The DUIK shall be included as a separate parameter if the Code-Receiving Security Parameters indicate that the Monitoring UE use Match Reports for MIC checking. The 5G DDNMF in the HPLMN of the Monitoring UE stores the ProSe Restricted Code and the Discovery User Integrity Key (if it received one outside of the Code-Receiving Security Parameters).
For 5G ProSe UE-to-Network Relay discovery, a Relay Discovery Key Response is used instead of the Monitor Response, and the RSC is used instead of the ProSe Restricted Code.
The 5G DDNMF in the HPLMN of the Announcing UE may send the PC5 security policies associated with the ProSe Restricted Code to the 5G DDNMF in the HPLMN of the Monitoring UE.
NOTE 3:	For 5G ProSe Direct Discovery, there are two possible configurations for integrity checking, namely, MIC checked by the 5G DDNMF of the Monitoring UE, and MIC checked at the Monitoring UE side. Which configuration to use is decided by the 5G DDNMF, which assigns the monitored ProSe Restricted Code and signals the Monitoring UE in the Code-Receiving Security Parameters.
For 5G ProSe UE-to-Network Relay discovery, MIC checking is performed only at the Remote UE and the 5G DDNMF of the Remote UE does not need to configure integrity checking for UE-to-Network Relay discovery.
NOTE 4:	The chosen PC5 ciphering algorithm is associated with the ProSe Restricted Code.
10.	The 5G DDNMF in the HPLMN of the Monitoring UE returns the Discovery Filter and the Code-Receiving Security Parameters, along with the CURRENT_TIME and MAX_OFFSET parameters and the chosen PC5 ciphering algorithm. The Monitoring UE takes the same actions with CURRENT_TIME and MAX_OFFSET as described for the Monitoring UE in step 9 of clause 6.1.3.1 of the present document. The UE stores the Discovery Filter, Code-Receiving Security Parameters, and the chosen PC5 ciphering algorithm together with the ProSe Restricted Code.
For 5G ProSe UE-to-Network Relay discovery, a Relay Discovery Key Response is returned instead of the Discovery Response, and the RSC is included instead of the ProSe Restricted Code. The response message contains the discovery security materials as contained in step 9.
If the 5G DDNMF in the HPLMN of the Monitoring UE receives the PC5 security policies associated with the ProSe Restricted Code in step 9, the Monitoring UE's 5G DDNMF forwards the PC5 security policies to the Monitoring UE.
For 5G ProSe UE-to-Network Relay discovery, a Relay Discovery Key Response is used instead of the Discovery Response, and the RSC is used instead of the ProSe Restricted Code.
Steps 11 and 12 occur over PC5:
11.	The UE starts announcing, if the UTC-based counter provided by the system associated with the discovery slot is within the MAX_OFFSET of the Announcing UE's ProSe clock and if the Validity Timer has not expired. The UE forms the discovery message and protects it. The four least significant bits of UTC-based counter are transmitted along with the protected discovery message.
12.	The Monitoring UE listens for a discovery message that satisfies its Discovery Filter if the UTC-based counter associated with that discovery slot is within the MAX_OFFSET of the monitoring UE's ProSe clock. In order to find such a matching message, it processes the message. If the Monitoring UE was not asked to send Match Reports for MIC checking, it stops at this step from a security perspective. Otherwise, it proceeds to step 13.
NOTE 5:	The UE checking the integrity of the discovery message on its own does not prevent the UE from sending a Match Report due to requirements in TS 23.304 [2]. If such a Match Report is sent, then there is no security functionality involved.
Steps 13-16 refer to a Monitoring UE that has encountered a match:
NOTE 6:	For 5G ProSe UE-to-Network Relay discovery, the steps 13-16 are skipped.
13.	If the UE has either not had the 5G DDNMF check the MIC for the discovered ProSe Restricted Code previously or the 5G DDNMF has checked a MIC for the ProSe Restricted Code and the associated Match Report refresh timer (see step 15 for details of this timer) has expired, or as required based on the procedure specified in TS 23.304 [2], then the Monitoring UE sends a Match Report message to the 5G DDNMF in the HPLMN of the Monitoring UE. The Match Report contains the UTC-based counter value with four least significant bits equal to four least significant bits received along with discovery message and nearest to the Monitoring UE's UTC-based counter associated with the discovery slot where it heard the announcement, and other discovery message parameters including the ProSe Restricted Code and MIC. The 5G DDNMF checks the MIC.
14.	The 5G DDNMF in the HPLMN of the Monitoring UE may exchange an Auth Req/Auth Resp with the ProSe Application Server to ensure that Monitoring UE is authorized to discover the Announcing UE.
15.	The 5G DDNMF in the HPLMN of the Monitoring UE returns to the Monitoring UE an acknowledgement that the integrity check passed. It also provides the CURRENT_TIME parameter, by which the UE (re)sets its ProSe clock. The 5G DDNMF in the HPLMN of the Monitoring UE included the Match Report refresh timer in the message to the Monitoring UE. The Match Report refresh timer indicates how long the UE will wait before sending a new Match Report for the ProSe Restricted Code.
16.	The 5G DDNMF in the HPLMN of the Monitoring UE may send a Match Report Info message to the 5G DDNMF in the HPLMN of the Announcing UE.",TS 33.503,6.1.3.2.2.1,all_images/image_295.png,Security procedure for restricted 5G ProSe Direct Discovery Model A
"The security procedure for restricted 5G ProSe Direct Discovery Model B is described as follows.
Figure 6.1.3.2.2.2-1: Security procedure for restricted 5G ProSe Direct Discovery Model B
NOTE 1:	When the user-plane based security procedure for the UE-to-Network Relay is used, the 5G PKMF takes the role of the 5G DDNMF as described in clause 6.3.3.2 of the present document.
Steps 1-4 refer to a Discoveree UE:
1.	Discoveree UE sends a Discovery Request message containing the RPAUID to the 5G DDNMF in its HPLMN in order to get Discovery Query Filter(s) to monitor a query, the ProSe Response Code to announce and associated security materials. The command indicates that this is for ProSe Response (Model B) operation, i.e. for a Discoveree UE. In addition, the Discoveree UE shall include its PC5 UE security capability that contains the list of supported ciphering algorithms by the UE in the Discovery Request message.
For 5G ProSe UE-to-Network Relay discovery, the 5G ProSe UE-to-Network Relay plays the role of the Discoveree UE and sends a Relay Discovery Key Request instead of a Discovery Request. The Relay Discovery Key Request message includes the Relay Service Code (RSC) and the 5G ProSe UE-to-Network Relay's PC5 security capabilities.
2.	The 5G DDNMF may check for the announce authorization with the ProSe Application Server depending on 5G DDNMF configuration.
For 5G ProSe UE-to-Network Relay discovery, the 5G DDNMF may check with the UDM whether the UE-to-Network relay is authorized to announce UE-to-Network relay discovery.
3.	The 5G DDNMFs in the HPLMN and VPLMN of the Discoveree UE exchange Announce Auth. Messages. If the Discoveree UE is not roaming, these steps do not take place.
4.	The 5G DDNMF in the HPLMN of the Discoveree UE returns the ProSe Response Code and the Code-Sending Security Parameters, Discovery Query Filter(s), Code-Receiving Security Parameters corresponding to each discovery filter along with the CURRENT_TIME and MAX_OFFSET parameters and the chosen PC5 ciphering algorithm. The Code-Sending Security Parameters provide the necessary information for the Discoveree UE to protect the transmission of the ProSe Response Code and are stored with the ProSe Response Code. The Code-Receiving Security Parameters provide the information needed by the Discoveree UE to undo the protection applied to the ProSe Query Code by the Discoverer UE. The Code-Receiving Security Parameters indicate a Match Report will not be used for MIC checking. The UE stores each Discovery Filter with its associated Code-Receiving Security Parameters. The Discoveree UE takes the same actions with CURRENT_TIME and MAX_OFFSET as described for the Announcing UE in step 4 of clause 6.1.3.1 of the present document. The 5G DDNMF in the HPLMN of the Discoveree UE shall include the chosen PC5 ciphering algorithm in the Discovery Response message. The 5G DDNMF determines the chosen PC5 ciphering algorithm based on the ProSe Response Code and the received PC5 UE security capability in step 1. The UE stores the chosen PC5 ciphering algorithm together with the ProSe Response Code.
In addition, the 5G DDNMF in the HPLMN of the Discoveree UE may associate the ProSe Response Code with the PC5 security policies and include the PC5 security policies in the Discovery Response message.
For 5G ProSe UE-to-Network Relay discovery, a Relay Discovery Key Response is used instead of the Discovery Response, and the RSC is used instead of ProSe Query Code and ProSe Response Code.
NOTE 2:	5G DDNMF may get the PC5 security policies in different ways (e.g. from PCF, from ProSe Application Server, or based on local configuration).
Steps 5-10 refer to a Discoverer UE:
5.	The Discoverer UE sends a Discovery Request message containing the RPAUID and its PC5 UE security capability to the 5G DDNMF in its HPLMN in order to be allowed to discover one or more Restricted ProSe Application User IDs.
For 5G ProSe UE-to-Network Relay discovery, the 5G ProSe Remote UE plays the role of the Discoverer UE and sends a Relay Discovery Key Request instead of the Discovery Request. The Relay Discovery Key Request message includes the RSC and the 5G ProSe Remote UE's PC5 security capabilities. The Remote UE may provide a list of PLMNs in which the UE is authorized to use a 5G ProSe U2N Relay. in the Relay Discovery Key Request.
6.	The 5G DDNMF in the HPLMN of the Discoverer UE sends an authorization request to the ProSe Application Server. If the RPAUID is allowed to discover at least one of the Target RPAUIDs contained in the Application Level Container, the ProSe Application Server returns an authorization response.
For 5G ProSe UE-to-Network Relay discovery, the 5G DDNMF of the Remote UE may check with the UDM whether the Remote UE is authorized to monitor UE-to-Network relay discovery.
7.	If the Discovery Request is authorized, the 5G DDNMF in the HPLMN of the Discoverer UE contacts the 5G DDNMF in the HPLMN of the Discoveree UE by sending a Discovery Request message, as specified in clause 6.3 of TS 23.304 [2], including the PC5 UE security capability in step 5.
For 5G ProSe UE-to-Network Relay Discovery, Relay Discovery Key Request and RSC are used instead of Discovery Request and RPAUID. The 5G DDNMF of the remote UE discovers 5G DDNMF(s) of the potential 5G ProSe UE-to-Network relay(s) supporting the RSC based on HPLMNs of the potential 5G ProSe UE-to-Network relay(s) mapping to the RSC.
NOTE 2a:	5G DDNMF may get the HPLMNs of the potential 5G ProSe UE-to-Network relays in different ways (e.g. from PCF, or based on local configuration).
8.	The 5G DDNMF in the HPLMN of the Discoveree UE may exchange authorization messages with the ProSe Application Server.
For 5G ProSe UE-to-Network Relay discovery, this step is skipped.
9.	If the PC5 UE security capability in step 5 includes the chosen PC5 ciphering algorithm, the 5G DDNMF in the HPLMN of the Discoveree UE responds to the 5G DDNMF in the HPLMN of the Discoverer UE with a Discovery Response message including the ProSe Query Code(s) and their associated Code-Sending Security Parameters, ProSe Response Code and its associated Code-Receiving Security Parameters, an optional Discovery User Integrity Key (DUIK) for the ProSe Response Code, and a chosen PC5 ciphering algorithm. The Code-Receiving Security Parameters provide the information needed by the Discoverer UE to undo the protection applied by the Discoveree UE. The DUIK shall be included as a separate parameter if the Code-Receiving Security Parameters indicate that the Discoverer UE use Match Reports for MIC checking. The 5G DDNMF in the HPLMN of the Discoverer UE stores the ProSe Response Code and the Discovery User Integrity Key (if it received one outside of the Code-Receiving Security Parameters). The Code-Sending Security Parameters provide the information needed by the Discoverer UE to protect the ProSe Query Code.
The 5G DDNMF in the HPLMN of the Discoveree UE may send the PC5 security policies associated with the ProSe Response Code to the 5G DDNMF in the HPLMN of the Discoverer UE.
For 5G ProSe UE-to-Network Relay discovery, a Relay Discovery Key Response is used instead of the Discovery Response, and the RSC is used instead of ProSe Query Code and ProSe Response Code.
NOTE 3:	For 5G ProSe Direct Discovery, there are two possible configurations for integrity checking, namely, MIC checked by the 5G DDNMF of the Discoverer UE, and MIC checked at the Discoverer UE side; this is decided by the 5G DDNMF that assigns the ProSe Restricted Code, and signals the Discoverer UE in the Code-Receiving Security Parameters.
For 5G ProSe UE-to-Network Relay discovery, MIC checking is performed only at the Remote UE and the 5G DDNMF of the Remote UE does not need to configure integrity checking for UE-to-Network Relay discovery.
NOTE 4:	The chosen PC5 ciphering algorithm is associated with the ProSe Response Code.
10.	The 5G DDNMFs in the HPLMN and VPLMN of the Discoverer UE exchange Announce Auth. messages. If the Discoverer UE is not roaming, these steps do not take place.
11.	The 5G DDNMF in the HPLMN of the Discoverer UE returns the Discovery Response Filter and the Code-Receiving Security Parameters, the ProSe Query Code, the Code-Sending Security Parameters along with the CURRENT_TIME and MAX_OFFSET parameters and the chosen PC5 ciphering algorithm. The Discoverer UE takes the same actions with CURRENT_TIME and MAX_OFFSET as described for the Monitoring UE in step 9 of clause 6.1.3.1 of the present document. The UE stores the Discovery Response Filter and its Code-Receiving Security Parameters and the ProSe Query Code and its Code-Sending Security Parameters, and the chosen PC5 ciphering algorithm together with the ProSe Response Code.
If the 5G DDNMF in the HPLMN of the Discoverer UE receives the PC5 security policies associated with the ProSe Response Code in step 9, the Discoverer UE's 5G DDNMF forwards the PC5 security policies to the Discoverer UE.
For 5G ProSe UE-to-Network Relay discovery, a Relay Discovery Key Response is used instead of the Discovery Response, and the RSC is used instead of the ProSe Restricted Code.
Steps 12 to 15 occur over PC5:
12.	The Discoverer UE sends the ProSe Query Code and also listens for a response message if the UTC-based counter provided by the system associated with the discovery slot is within the MAX_OFFSET of the Discoverer UE's ProSe clock and if the Validity Timer has not expired. The Discoverer UE forms the discovery message and protects it. The four least significant bits of UTC-based counter are transmitted along with the protected discovery message.
13.	The Discoveree UE listens for a discovery message that satisfies its Discovery Filter if the UTC-based counter associated with that discovery slot is within the MAX_OFFSET of the Discoveree UE's ProSe clock. In order to find such a matching message, it processes the message.
NOTE 5:	Match Reports are not used for the MIC checking of ProSe Query Codes.
14.	The Discoveree UE sends the ProSe Response Code associated with the discovered ProSe Query Code. The Discoveree UE forms the discovery message and protects it. The four least significant bits of UTC-based counter are transmitted along with the protected discovery message.
15.	The Discoverer UE listens for a discovery message that satisfies its Discovery Filter. In order to find such a matching message, it processes the message. If the Discoverer UE was not asked to send Match Reports for MIC checking, it stops at this step from a security perspective. Otherwise, it proceeds to step 16.
NOTE 6:	The UE checking the integrity of the discovery message on its own does not prevent the UE from sending a Match Report due to requirements in TS 23.304 [2]. If such a Match Report is sent, then there is no security functionality involved.
NOTE 7:	The security keys in the Code-Sending Security Parameters of Discoverer UE and the security keys in the Code-Sending Security Parameters of Discoveree UE need to be generated independently and randomly.
Steps 16-19 refer to a Discoverer UE that has encountered a match:
NOTE 8:	For 5G ProSe UE-to-Network Relay discovery, the steps 16-19 are skipped.
16.	If the Discoverer UE has either not had the 5G DDNMF check the MIC for the discovered ProSe Response Code previously or the 5G DDNMF has checked a MIC for the ProSe Response Code and the associated Match Report refresh timer (see step 18 for details of this timer) has expired, or as required based on the procedure specified in TS 23.304 [2], then the Discoverer UE sends a Match Report message to the 5G DDNMF in the HPLMN of the Discoverer UE. The Match Report contains the UTC-based counter value with four least significant bits equal to four least significant bits received along with discovery message and nearest to the Discoverer UE's UTC-based counter associated with the discovery slot where it heard the announcement, and other discovery message parameters including the ProSe Response Code and MIC. The 5G DDNMF checks the MIC.
17.	The 5G DDNMF in the HPLMN of the Discoverer UE may exchange an Auth Req/Auth Resp with the ProSe Application Server to ensure that Discoverer UE is authorized to discover the Discoveree UE.
18.	The 5G DDNMF in the HPLMN of the Discoverer UE returns to the Discoverer UE an acknowledgement that the integrity check passed. It also provides the CURRENT_TIME parameter, by which the UE (re)sets its ProSe clock. The 5G DDNMF in the HPLMN of the Discoverer UE include the Match Report refresh timer in the message to the Discoverer UE. The Match Report refresh timer indicates how long the UE will wait before sending a new Match Report for the ProSe Response Code.
19.	The 5G DDNMF in the HPLMN of the Discoverer UE may send a Match Report Info message to the 5G DDNMF in the HPLMN of the Discoveree UE.",TS 33.503,6.1.3.2.2.2,all_images/image_296.png,Security procedure for restricted 5G ProSe Direct Discovery Model B
"Figure 6.3.3.2.2-1: PC5 security establishment procedure for 5G ProSe UE-to-Network relay communication over User Plane
The 5G ProSe Remote UE is provisioned with the discovery security materials (see clause 6.1.3.2) and Prose Remote User Key (UP-PRUK) when it is in coverage. These security materials are associated with an expiration time, after which they become invalid. If the UE does not have valid discovery security materials, the 5G ProSe Remote UE needs to connect to the 5G PKMF and obtain fresh ones to use the 5G ProSe UE-to-Network Relay services.
NOTE 1:	The procedure is described for the scenario that the 5G PKMF of the 5G ProSe Remote UE is different from the 5G PKMF of the 5G ProSe UE-to-Network Relay. If both the 5G ProSe Remote UE and the 5G ProSe UE-to-Network Relay are served by a single 5G PKMF, the 5G PKMF takes the role of the 5G PKMF of the 5G ProSe Remote UE and the 5G PKMF of the 5G ProSe UE-to-Network Relay and the inter-5G PKMF message exchanges are not needed.
NOTE 2:	Steps 0a, 0b, 1a, 1b are performed when the 5G ProSe Remote UE is in coverage.
0a.	The 5G ProSe Remote UE gets the 5G PKMF address from the 5G DDNMF of its HPLMN. Alternatively, the 5G ProSe Remote UE may be provisioned with the 5G PKMF address by PCF. If the 5G ProSe Remote UE is provisioned with the 5G PKMF address, the 5G ProSe Remote UE may access the 5G PKMF directly without requesting it from the 5G DDNMF. In case that the 5G ProSe Remote UE cannot access the 5G PKMF using the provisioned 5G PKMF address, the 5G ProSe Remote UE may request the 5G PMKF address to the 5G DDNMF.
0b.	The 5G ProSe Remote UE shall establish a secure connection with the 5G PKMF via PC8 reference point. Security for PC8 interface relies on Ua security if GBA specified in TS 33.220 [8] is used (see clause 5.2.3.4) or Ua* security if AKMA specified in TS 33.535 [5] is used (see clause 5.2.5.4). The 5G PKMF of the 5G ProSe Remote UE shall check whether the 5G ProSe Remote UE is authorized to receive UE-to-Network Relay service, and if the UE is authorized, the 5G PKMF of the 5G ProSe Remote UE provides the discovery security materials to the 5G ProSe Remote UE. If the 5G ProSe Remote UE provides a list of visited networks, the 5G PKMF of the 5G ProSe Remote UE shall request the discovery security materials from the 5G PKMFs of the potential 5G ProSe UE-to-Network Relays from which the 5G ProSe Remote UE gets the relay services based on the visited networks from the remote UE. If authorized visited networks are not provided by the 5G ProSe Remote UE, the 5G PKMF of the 5G ProSe Remote UE shall request the discovery security materials from the 5G PKMFs of the potential 5G ProSe UE-to-Network Relays based on the PLMNs of the potential 5G ProSe UE-to-Network Relays. The 5G PKMF of the 5G ProSe UE-to-Network Relay may include the PC5 security policies to the 5G ProSe Remote UE.
NOTE 2a:	5G PKMF may retrieve the PLMNs of the potential 5G ProSe UE-to-Network relays in different ways (e.g. from PCF, or based on local configuration).
NOTE 3:	The 5G PKMF may be locally configured with the UE's authorization information. Otherwise, the 5G PKMF interacts with the UDM of the UE to retrieve the UE's authorization information.
NOTE 4:	The 5G ProSe Remote UE is provisioned by PCF with a list of the potential visited networks for the 5G ProSe UE-to-Network Relay service (which is identified by RSC).
0c.	The 5G ProSe UE-to-Network Relay gets the 5G PKMF address from its HPLMN in the same way as described in step 0a.
0d.	The 5G ProSe UE-to-Network Relay shall establish a secure connection with the 5G PKMF via PC8 reference point as in step 0b. The 5G PKMF of the 5G ProSe UE-to-Network Relay shall check whether the 5G ProSe UE-to-Network Relay is authorized to provide 5G ProSe UE-to-Network Relay service, and if the UE is authorized, the 5G PKMF of the 5G ProSe UE-to-Network Relay provides the discovery security materials to the 5G ProSe UE-to-Network Relay. The 5G PKMF of the 5G ProSe UE-to-Network Relay may include the PC5 security policies to the 5G ProSe UE-to-Network Relay.
1a.	The 5G ProSe Remote UE sends a UP-PRUK Request message to its 5G PKMF. The message indicates that the 5G ProSe Remote UE is requesting a UP-PRUK from the 5G PKMF. If the 5G ProSe Remote UE already has a UP-PRUK from this 5G PKMF, the message shall also contain the UP-PRUK ID of the UP-PRUK.
UP-PRUK ID shall take the form of either the NAI format or the 64-bit string. If the UP-PRUK ID is in NAI format, i.e. username@realm, the realm part shall include Home Network Identifier (i.e. HPLMN ID). The username part shall include the 64-bit string.
1b.	The 5G PKMF checks whether the 5G ProSe Remote UE is authorized to receive UE-to-Network Relay services. This is done by using the 5G ProSe Remote UE's identity associated with the key used to establish the secure connection between the 5G ProSe Remote UE and 5G PKMF in step 0b. If the 5G ProSe Remote UE is authorized to receive the service, the 5G PKMF sends a UP-PRUK and UP-PRUK ID to the 5G ProSe Remote UE. If a UP-PRUK and UP-PRUK ID are included, the 5G ProSe Remote UE shall store these and delete any previously stored ones for this 5G PKMF.
2.	The discovery procedure is performed between the 5G ProSe Remote UE and the 5G ProSe UE-to-Network Relay using the discovery parameters and discovery security material as described in clause 6.1.3.2.
3.	The 5G ProSe Remote UE sends a Direct Communication Request (DCR) that contains the UP-PRUK ID or a SUCI if the Remote UE does not have a valid UP-PRUK, Relay Service Code (RSC) of the 5G ProSe UE-to-Network Relay service and KNRP freshness parameter 1 to the 5G ProSe UE-to-Network Relay. If the UP-PRUK ID is not in NAI format, the DCR message shall include the HPLMN ID of the 5G ProSe Remote UE. The PC5 security establishment procedure between the 5G ProSe Remote UE and the 5G ProSe UE-to-Network Relay including security parameters and security policy negotiation and protection of messages hereafter shall follow the one-to-one security establishment described in clause 6.2.3 of the present document. Only additional parameters required for the 5G ProSe Layer-3 UE-to-Network Relay scenario are described in this clause. The privacy and integrity protection of DCR are described in clause 6.3.5.
4a.	The 5G ProSe UE-to-Network Relay sends a Key Request message that contains UP-PRUK ID or SUCI, RSC and KNRP freshness parameter 1 to its 5G PKMF. The Key Request message shall also include the HPLMN ID of the 5G ProSe Remote UE if it is included in the DCR.
4b.	On receiving the Key Request message, the 5G PKMF of the 5G ProSe UE-to-Network Relay shall check if the 5G ProSe UE-to-Network Relay is authorized to provide relay service to the 5G ProSe Remote UE based on the 5G ProSe UE-to-Network Relay's identity associated with the key used to establish the secure PC8 connection and the received RSC.
NOTE 4a:	The 5G PKMF of the 5G ProSe UE-to-Network Relay needs to do the authorization of RSC based on its implementation.
If the 5G ProSe UE-to-Network Relay's authorization information is not locally available, the 5G PKMF shall request the authorization information from the UDM of the 5G ProSe UE-to-Network Relay (not shown in the figure) using Nudm_SDM_Get service as described in TS 23.502 [10]. If the 5G ProSe UE-to-Network Relay is authorized to provide the relay service based on ProSe Subscription data as specified in TS 23.502 [10], the 5G PKMF of the 5G ProSe UE-to-Network Relay sends the Key Request with the UP-PRUK ID or the SUCI to the 5G PKMF of the 5G ProSe Remote UE. The 5G PKMF of the 5G ProSe UE-to-Network Relay identifies the 5G PKMF address of the 5G ProSe Remote UE based on the UP-PRUK ID or HPLMN ID or SUCI of the 5G ProSe Remote UE if it is included in the Key Request message.
NOTE 4b:	The 5G PKMF of the 5G ProSe Remote UE needs to do the authorization of RSC based on its implementation.
4c.	On receiving the Key Request message from the 5G PKMF of the 5G ProSe UE-to-Network Relay, the 5G PKMF of the 5G ProSe Remote UE shall check if the 5G ProSe Remote UE is authorized to use the relay service. The relay service authorization check shall be based on the UP-PRUK ID and RSC included in the Key Request message or the SUPI of the Remote UE and the RSC included in the Key Request message. If a SUCI is included in the Key Request message, the 5G PKMF of the 5G ProSe Remote UE shall request the UDM of the 5G ProSe Remote UE to de-conceal the SUCI to gain the SUPI using Nudm_UEIdentifier_Deconceal service, and the UDM invokes SIDF to de-conceal SUCI to gain SUPI. If the 5G ProSe Remote UE's authorization information is not locally available, the 5G PKMF shall request the authorization information from the UDM of the 5G ProSe Remote UE (not shown in figure 6.3.3.2.2-1).
NOTE 5:	Privacy issues need to be considered while determining whether the SUPI is to be sent to the PKMF. For a privacy control, the UDM can authorize the PKMF based on its NF type or the service provider domain.
If a new UP-PRUK is required, the 5G PKMF shall perform the one of the following procedures (as shown in the step 4c in figure 6.3.3.2.2-1):
-	If the 5G PKMF of the 5G ProSe Remote UE supports the Zpn interface to the BSF of the 5G ProSe Remote UE, the 5G PKMF of the 5G ProSe Remote UE may request a GBA Push Info (GPI - see TS 33.223 [9]) for the 5G ProSe Remote UE from the BSF. When requesting the GPI, the 5G PKMF shall include a UP-PRUK ID in the P-TID field. On receiving the GPI, the 5G PKMF shall use Ks(_ext)_NAF as the UP-PRUK.
-	If the 5G PKMF of the 5G ProSe Remote UE supports the SBI interface to the BSF of the 5G ProSe Remote UE, the 5G PKMF may request the GPI via SBI interface as described in TS 33.223 [9]. On receiving the GPI, the 5G PKMF shall use Ks(_ext)_NAF as the UP-PRUK.
-	If the 5G PKMF of the 5G ProSe Remote UE supports the PC4a interface to the HSS of the UE, then the 5G PKMF of 5G ProSe Remote UE may request a GBA Authentication Vector (AV) for the 5G ProSe Remote UE from the HSS. On receiving the AV, the 5G PKMF locally forms the GPI including a UP-PRUK ID in the P-TID field. The 5G PKMF shall use Ks(_ext)_NAF as the UP-PRUK.
-	If the 5G PKMF of the 5G ProSe Remote UE is co-located or integrated with BSF functionality and supports the SBI interface to the UDM/HSS of the 5G ProSe Remote UE, the 5G PKMF may request the GBA AV via SBI interface as described in TS 33.220 [8]. On receiving the AV, the 5G PKMF locally forms the GPI including a UP-PRUK ID in the P-TID field. The 5G PKMF shall use Ks(_ext)_NAF as the UP-PRUK.
NOTE 6:	GPI is supported only when GBA is used.
4d.	The 5G PKMF of the 5G ProSe Remote UE shall generate KNRP freshness parameter 2 and derive KNRP using the UP-PRUK identified by UP-PRUK ID, RSC, KNRP freshness parameter 1 and KNRP freshness parameter 2 as specified in A.8. Then, the 5G PKMF of the 5G ProSe Remote UE sends a Key Response message that contains KNRP and KNRP freshness parameter 2 to the 5G PKMF of the 5G ProSe UE-to-Network Relay. This message shall include GPI if generated. The 5G PKMF of the 5G ProSe Remote UE shall also include the Remote User ID of the 5G ProSe Remote UE in the Key Response message to the 5G PKMF of the 5G ProSe UE-to-Network Relay. UP-PRUK ID is used as a Remote User ID in the present document.
4e.	The 5G PKMF of the 5G ProSe UE-to-Network Relay sends the Key Response message to the 5G ProSe UE-to-Network Relay, which includes Remote User ID, KNRP, KNRP freshness parameter 2,  the GPI if used to calculate a fresh UP-PRUK to the UE-to-Network Relay.
5a.	The 5G ProSe UE-to-Network Relay shall derive the session key (KNRP-SESS) from KNRP and then derive the confidentiality key (NRPEK) (if applicable) and integrity key (NRPIK) based on the PC5 security policies as specified in TS 33.536 [6]. The 5G ProSe UE-to-Network Relay shall store the Remote User ID received in step 4d. The establishment of KNRP ID and KNRP-sess ID are specified in TS 33.536 [6]. The 5G ProSe UE-to-Network Relay sends a Direct Security Mode Command message to the 5G ProSe Remote UE. This message shall also include the KNRP Freshness Parameter 2 in addition to the parameters specified in TS 33.536 [6] and shall be protected as specified in TS 33.536 [6].
5b.	If the 5G ProSe Remote UE receives the message containing the GPI, it processes the GPI as described in TS 33.223 [9]. The 5G ProSe Remote UE shall derive the UP-PRUK and obtain the UP-PRUK ID from the GPI.
The 5G ProSe Remote UE shall derive KNRP from its UP-PRUK, RSC, KNRP Freshness Parameter 1 and the received KNRP Freshness Parameter 2 as specified in A.8. It shall then derive the session key (KNRP-SESS) and the confidentiality key (NRPEK) (if applicable) and integrity key (NRPIK) based on the PC5 security policies in the same manner as the 5G ProSe UE-to-Network Relay and process the Direct Security Mode Command. Successful verification of the Direct Security Mode Command assures the 5G ProSe Remote UE that the 5G ProSe UE-to-Network Relay is authorized to provide the relay service.
Handling of synchronization failure (for details of synchronization failures - see TS 33.102 [11]) when UE processes the authentication challenge in the GPI is performed similarly to clause 6.7.3.2.1.2 in TS 33.303 [4]. The 5G ProSe Remote UE shall send Direct Security Mode Failure message and include RAND and AUTS in the message. The 5G ProSe UE-to-Network Relay shall send the key request message to the 5G PKMF of the 5G ProSe Remote UE via the 5G PKMF of the 5G ProSe UE-to-Network Relay upon receiving the Direct Security Mode Failure message from the 5G ProSe Remote UE. The key request message shall include the HPLMN ID of the 5G ProSe Remote UE, if provided in step 3, the UP-PRUK ID or the SUCI of the 5G ProSe Remote UE received in step 3, Relay Service Code and KNRP freshness parameter 1 together with the RAND and the AUTS received from the 5G ProSe Remote UE. If the 5G PKMF of the 5G ProSe Remote UE decides to retry GBA Push procedure, the 5G PKMF of the 5G ProSe Remote UE shall request GPI as described in step 4c.
5c.	The 5G ProSe Remote UE responds with a Direct Security Mode Complete message to the 5G ProSe UE-to-Network Relay as specified in TS 33.536 [6].
5d.	On receiving the Direct Security Mode Complete message, the 5G ProSe UE-to-Network Relay shall verify the Direct Security Mode Complete message. Successful verification of the Direct Security Mode Complete message assures the 5G ProSe UE-to-Network Relay that the 5G ProSe Remote UE is authorized to get the relay service.
5e.	After successful verification, the 5G ProSe UE-to-Network Relay responds a Direct Communication Accept message to the 5G ProSe Remote UE to complete the PC5 connection establishment procedure.
6.	The 5G ProSe Remote UE and 5G ProSe UE-to-Network Relay continues the rest of procedure for the relay service over the secure PC5 link such as establishing a new PDU session or modifying an existing PDU session for relaying, if needed etc.
7.	When the 5G ProSe Layer-3 UE-to-Network Relay sends a Remote UE Report to the SMF as specified in TS 23.304 [2], the 5G ProSe Layer-3 UE-to-Network Relay shall include Remote User ID stored in the 5G ProSe UE-to-Network Relay in step 5a. If the UP-PRUK ID used as Remote User ID is not in NAI format, the 5G ProSe Layer-3 UE-to-Network Relay shall include the HPLMN ID of the 5G ProSe Remote UE in the Remote UE Report.
8a. If the mapping of the Remote User ID and the 5G ProSe Remote UE's SUPI is not available in the SMF of the 5G ProSe UE-to-Network Relay, the SMF shall discover the 5G PKMF of the Relay UE using the HPLMN ID from Relay UE’s SUPI (based on the PDU session associated with the relay as specified in TS 23.304 [2]) and send a Resolve Remote User ID request towards the PKMF of the 5G ProSe UE-to-Network Relay in Npkmf_ResolveRemoteUserId_Get Request message, including the Remote User ID of the 5G ProSe Remote UE and the HPLMN ID of the 5G ProSe Remote UE if UP-PRUK ID used as Remote User ID is not in NAI format in the message.
8b. The 5G PKMF of the 5G ProSe UE-to-Network Relay forwards the Resolve Remote User ID request in Npkmf_ResolveRemoteUserId_Get Request message towards the 5G PKMF of the 5G ProSe Remote UE. The 5G PKMF of the 5G ProSe UE-to-Network Relay identifies the 5G PKMF address of the 5G ProSe Remote UE based on the UP-PRUK ID or HPLMN ID of the 5G ProSe Remote UE.
8c. The 5G PKMF of the 5G ProSe Remote UE shall send a Resolve Remote User ID response to the 5G PKMF of the 5G ProSe UE-to-Network Relay in Npkmf_ResolveRemoteUserId_Get Response message, including the SUPI of the 5G ProSe Remote UE in the message.
8d. The 5G PKMF of the 5G ProSe UE-to-Network Relay forwards the Npkmf_ResolveRemoteUserId_Get Response message including the SUPI to the SMF of the 5G ProSe UE-to-Network Relay.
The SMF of the 5G ProSe UE-to-Network Relay shall store the Remote User ID, the SUPI of the 5G ProSe Remote UE and the Remote UE info in the 5G ProSe Layer-3 UE-to-Network Relay's SM context for this PDU Session associated with the 5G ProSe UE-to-Network Relay. The SMF sends Remote UE Report Ack message to the 5G ProSe Layer-3 UE-to-Network Relay.
If the 5G ProSe Remote UE receives from the 5G ProSe UE-to-Network Relay a Direct Connection Reject due to UP-PRUK ID not found in the network, the 5G ProSe Remote UE shall not attempt to reconnect with the 5G ProSe UE-to-Network Relay using the UP-PRUK ID. The 5G ProSe Remote UE may attempt to connect with the 5G ProSe UE-to-Network Relay using its SUCI.
NOTE: The UP-PRUK ID not being found condition is detected by the 5G PKMF of the 5G ProSe Remote UE if it does not find a valid UP-PRUK that corresponds to the received UP-PRUK ID. The 5G ProSe UE-to-Network Relay is informed of this condition via the 5G PKMF of the 5G ProSe UE-to-Network Relay.",TS 33.503,6.3.3.2.2,all_images/image_297.jpeg,PC5 security establishment procedure for 5G ProSe UE-to-Network relay
"Figure 4.2.1-1 shows the EPS architecture of the extended user plane protection service for the case where the UE’s PDN connection terminates at the P-GW. Figure 4.2.1-2 shows the architecture of the extended user plane protection service for the case where the UE’s PDN connection terminates at the SCEF.
Figure 4.2.1-1: The architecture of the extended user plane protection service (P-GW Terminated PDN Connection Option)
Figure 4.2.1-2: The architecture of the extended user plane protection service (SCEF Terminated PDN Connection Option)
In an EPS network, the BEST service requires the following components:
-	Home Security Endpoint (HSE) – This is the termination point in the home network that performs the following functions:
-	Terminating the control plane for BEST between the UE and the HSE
-	Terminating the secure communication for BEST between the UE and the HSE and forwarding to and from the Data Network via the SGi  if UE-to-HSE security is selected.
-	Routing the user plane traffic for BEST between the UE and the Enterprise Application Server (EAS) via the SGi if UE-to-EAS security is selected.
-	Anchor for BEST Key agreement only service. Exposes an interface for EAS to obtain MNO provided pre-shared key.
-	End to Middle Key Server (EMKS) – This is an optional key server element that manages the key communication with the HSS (for quintets) and stores keys to reduce loading on the HSE and HSS. The EMKS has interfaces to the HSS (S6a) and the HSE (S6a).
The BEST service uses the following interfaces:
-	S6a between the HSS and the HSE
-	S6a between the HSS and EMKS
-	S6a between the EMKS and the HSE
-	BEST-C and BEST-U between the UE and the HSE
-	EAS-C and EAS-U between the HSE and the EAS.  Definition of this interface is out of scope.  Annex B describes a candidate interface based on Restful HTTP for the communication between the HSE and the EAS.
When the UE’s PDN connection terminates at the SCEF as shown in Figure 4.2.1-2:
The HSE may be implemented as part of the SCEF.
The EAS may be an SCS/AS and use a T8 interface to access exposed network capabilities as described in TS 23.682 [14].
-	EMSDP via the SCEF only supports non-IP PDU Type communication.",TS 33.163,4.2.1,all_images/image_299.jpeg,The architecture of the extended user plane protection service (P-GW Terminated PDN
"Figure 4.2.2-1 shows the 5GS architecture of the extended user plane protection service.
Figure 4.2.2-1: The architecture of the extended user plane protection service
In a 5GS network, the BEST service requires the following components:
-	Home Security Endpoint (HSE) – This is the termination point in the home network that performs the following functions:
-	Terminating the control plane for BEST between the UE and the HSE
-	Terminating the secure communication for BEST between the UE and the HSE and forwarding to and from the Data Network via the N3 if UE-to-HSE security is selected.
-	Routing the user plane traffic for BEST between the UE and the Enterprise Application Server (EAS) via the N3 if UE-to-EAS security is selected.
-	Anchor for BEST Key agreement only service. Exposes an interface for EAS to obtain MNO provided pre-shared key.
The BEST service uses the following interfaces:
-	SBA between the UDM and the HSE
-	BEST-C and BEST-U between the UE and the HSE
-	EAS-C and EAS-U between the HSE and the EAS.  Definition of this interface is out of scope.  Annex B describes a candidate interface based on Restful HTTP for the communication between the HSE and the EAS.",TS 33.163,4.2.2,all_images/image_301.jpeg,The architecture of the extended user plane protection service
"New keys are agreed either at the start of a BEST session or as required due to key aging or counter thresholds being met.  Key agreement can be based on the 3GPP AKA mechanism detailed in TS 33.102 [3], TS 33.401 [12], or TS 33.501 [16], respectively, or based on one of the following external key agreement methods: GBA [13], 5G GBA [13], Annex N, AKMA [17], or proprietary key agreement. For 3GPP AKA based key agreement, the AKA challenge is then transported between the HSE and the UE as part of the BEST service detailed in clause 4.3.2. The key hierarchy is shown in clause 4.6.2.2.
The EMDSP protocol has 7 Key IDs for each session ID. Each Key ID has a separate keyset consisting of an integrity Key (KE2Mint), an encryption key (KE2Menc), optionally an Intermediate Key (KIntermediate) and optionally an EAS PSK (KEAS_PSK). The Key IDs shall be set during the derivations of the keys as specified in clause 5.1.
The Intermediate Key (KIntermediate) is used together with a separate enterprise server identifier (EAS Id) to calculate the EAS PSK (KEAS_PSK).  There can be many KEAS_PSK derived from one KIntermediate.
The EAS PSK (KEAS_PSK) is used together with the Enterprise Key to calculate KE2Eint and KE2Eenc when BEST User plane security services are used in UE-to-EAS mode.
Figure 4.6.1.1-1 shows the generic key agreement process for EPS networks:
Figure 4.6.1.1-1: Generic BEST key agreement process for EPS networks
The Key agreement steps are:
1.	EMSDP Session Request (UE ID, BEST capabilities, Enterprise information serving network (cond)). The UE shall send the EMSDP Session Request (UE ID, BEST capabilities, Enterprise information, serving network (cond)) to set up a new BEST session. The BEST capabilities shall indicate that EPS key agreement is supported.
2.	Keys required? - the HSE shall check to see if there are valid keys with valid counter values available in the HSE for that UE then the following is checked:
-	If the HSE has a valid set of keys for the indicated session and the UE ID is valid for that session then the HSE may start the BEST session without re-negotiating the keys (step 8).
-	If the UE ID is valid for that HSE and the HSE does not have a valid set of keys for the indicated session or the HSE wishes to update the keys, then it shall first renegotiate the keys (steps 2 to 7) and then start the BEST session (step 8).
-	If the UE ID is not valid for that session ID or the UE does not support the level of service required by the HSE or the enterprise information is not valid for the HSE, then the HSE may reject the command.
3. Authentication-Information-Request over S6a interface – The HSE shall use the S6a interface to the HSS to request one or more authentication vectors using the UE IMSI.. For UEs the request shall indicate that EPS authentication vectors are requested. For legacy UEs supporting BEST, the request shall indicate that UMTS authentication vectors are requested
4. Authentication-Information-Answer over S6a interface – The HSS uses the S6a interface to the HSE to return the requested authentication vectors.
a. Authentication-Information-Request over the S6a interface between HSE and EMKS – Where an EMKS is used, the HSE shall use the S6a interface to the EMKS to request an authentication vector using the UE IMSI.
b. Authentication-Information-Request over the S6a interface between EMKS and HSE – The EMKS shall use the S6a interface to the HSS to request one or more authentication vectors using the UE IMSI.
c. Authentication-Information-Answer over the S6a interface between EMKS and HSE – The HSS shall use the S6a interface to the EMKS to return the requested authentication vectors.  These vectors may be stored on the EMKS for later use.
d. Authentication-Information-Answer over the S6a interface between HSE and EMKS – The EMKS uses the S6a interface to the HSE to return the requested authentication vector.
5. Calculate UE-to-HSE Keys -  See key derivation details in clause 5.
6. The HSE may optionally send  ""EAS Session Request"" to the EAS– In case BEST UP service is used in UE-to-EAS mode, the HSE shall use the HSE interface to the EAS to inform the EAS of the new UE-to-EAS session request and shall forward the  EAS PSK (KEAS_PSK)  to the EAS.  In case the BEST key agreement service is used, the HSE shall forward to the EAS, the EAS PSK (KEAS_PSK) and the key identifier for the Intermediate Pre Shared Key (KIntermediate).
7. The Enterprise Server sends a ""EAS Session Start"" to the HSE – The Enterprise Server shall respond by sending the ""UE-to-EAS Session Start"" message. In case BEST UP service is used, this message may contain an EAS container that includes an identifier for the Enterprise Key.
8. EMSDP Session Start message -  The HSE shall send a EMSDP Session Start (Key Agreement, Session Parameters, Request Validation, HSE ID(opt) , EAS container (opt)). The Session Parameters shall contain RAND and AUTN from the received authentication vectors. As described in TS 33.401 [12], clause 6.1.2, the ""separation bit"" in the AMF field of AUTN shall be set to 0 if UMTS authentication vectors have been received, and the ""separation bit"" in the AMF field of AUTN shall be set to 1 if EPS authentication vectors have been received. The Session Parameters shall indicate the selected key agreement (i.e. EPS key agreement).
9. EMSDP Session Start Confirmation - UE optionally, if requested in the Session Start Confirmation, responds with an EMSDP Session Start Confirmation message.
10.  EAS Session Start Confirmation - The HSE may optionally send EAS Session Start Confirmation.
11. Calculate UE Keys – See key derivation details in clause 5.
12. Calculate UE-to-EAS Keys – In case of the UE-to-EAS BEST UP service, the Enterprise server generates UE-to-EAS keys as per the key derivation details in clause 5.
Figure 4.6.1.1-2 shows the generic key agreement process for 5GS networks:
Figure 4.6.1.1-2: Generic BEST key agreement process for 5GS networks
The Key agreement steps are:
1.	EMSDP Session Request (UE ID, BEST capabilities, Enterprise information, serving network). The UE shall send the EMSDP Session Request (UE ID, BEST capabilities, Enterprise information, serving network) to set up a new BEST session. The BEST capabilities shall indicate that 5G key agreement is supported.
2.	Keys required? - the HSE shall check to see if there are valid keys with valid counter values available in the HSE for that UE then the following is checked:
-	If the EMSDP Session Request is sent with a valid Session ID (i.e., not 0) and there is a valid key set for that session, then the HSE may start the BEST session without re-negotiating the keys (step 8). In this case the received UE ID may be ignored.
-	If the EMSDP Session Request is sent without a valid Session ID or using a single byte Session ID set to 0 or the HSE wishes to update the keys, then it shall first renegotiate the keys (steps 2 to 7) and then start the BEST session (step 8).
-	If the UE does not support the level of service required by the HSE or the enterprise information is not valid for the HSE, then the HSE may reject the command.
3.	Nudm_UEAuthentication_GetBESTav Request over SBA interface – The HSE shall use the SBA interface to the UDM/ARPF to request an authentication vector using the UE SUCI. The service operation Nudm_UEAuthentication_GetBESTav Request has the same inputs as the service operation Nudm_UEAuthentication_Get Request.
4.	Nudm_UEAuthentication_GetBESTav Response over SBA interface – The UDM/ARPF uses the SBA interface to the HSE to return a BEST-adapted 5G HE authentication vector (if 5G AKA is the selected authentication method) or a transformed authentication vector (if EAP-AKA' is the selected authentication method).The service operation Nudm_UEAuthentication_GetBESTav Response has the same outputs as the service operation Nudm_UEAuthentication_Get Response, except that in the BEST-adapted 5G HE authentication vector the parameter KAUSF is replaced by KHSE (see clause 5.1.0a).
5.	Calculate UE-to-HSE Keys -  See key derivation details in clause 5.
6.	The HSE may optionally send  ""EAS Session Request"" to the EAS– In case BEST UP service is used in UE-to-EAS mode, the HSE shall use the HSE interface to the EAS to inform the EAS of the new UE-to-EAS session request and shall forward the  EAS PSK (KEAS_PSK)  to the EAS. In case the BEST key agreement service is used, the HSE shall forward to the EAS, the EAS PSK (KEAS_PSK) and the key identifier for the Intermediate Pre Shared Key (KIntermediate).
7.	The Enterprise Server sends a ""EAS Session Start"" to the HSE – The Enterprise Server shall respond by sending the ""UE-to-EAS Session Start"" message. In case BEST UP service is used, this message may contain an EAS container that includes an identifier for the Enterprise Key.
8.	EMSDP Session Start message -  The HSE shall send a EMSDP Session Start (Key Agreement, Session Parameters, Request Validation, HSE ID (opt), EAS container (opt)). The Session Parameters shall contain RAND and AUTN from the received authentication vectors. The ""separation bit"" in the AMF field of AUTN shall be set to 1. The Session Parameters shall indicate that 5G key agreement has been selected.
9.	EMSDP Session Start Confirmation - UE optionally, if requested in the Session Start Confirmation, responds with an EMSDP Session Start Confirmation message.
10.	EAS Session Start Confirmation - The HSE may optionally send EAS Session Start Confirmation.
11.	Calculate UE Keys – See key derivation details in clause 5.
12.	Calculate UE-to-EAS Keys – In case of the UE-to-EAS BEST UP service, the Enterprise server generates UE-to-EAS keys as per the key derivation details in clause 5.",TS 33.163,4.6.1.1,all_images/image_302.jpeg,Generic BEST key agreement process for 5GS networks
"For EPS networks the BEST key hierarchy is as depicted in Figure 4.6.2.2-1.
Figure 4.6.2.2-1: BEST Key Hierarchy for EPS networks and legacy UEs
For EPS networks the BEST key hierarchy is as depicted in Figure 4.6.2.2-2.
Figure 4.6.2.2-2: BEST Key Hierarchy for EPS networks and BEST UEs
For 5GS networks the BEST key hierarchy is as depicted in Figure 4.6.2.2-3.
Figure 4.6.2.2-3: BEST Key Hierarchy for 5GS networks
The derivation of the key KHSE is described in clause 5.1.0a.
For GBA and 5G GBA based key agreement, the BEST key hierarchy is as depicted in Figure 4.6.2.2-4.
Figure 4.6.2.2-4: BEST Key Hierarchy for GBA and 5G GBA based key agreement
For AKMA based key agreement, the BEST key hierarchy is as depicted in Figure 4.6.2.2-5.
Figure 4.6.2.2-5: BEST Key Hierarchy for AKMA based key agreement
For proprietary key agreement, the BEST key hierarchy is as depicted in Figure 4.6.2.2-6.
Figure 4.6.2.2-6: BEST Key Hierarchy for proprietary key agreement
The KIntermediate, KEAS_PSK and all of the keys derived from them are generated when indicated to do so in the BEST CP messaging.",TS 33.163,4.6.2.2,all_images/image_303.jpeg,BEST Key Hierarchy for EPS networks and legacy UEs
"For EPS networks the BEST key hierarchy is as depicted in Figure 4.6.2.2-1.
Figure 4.6.2.2-1: BEST Key Hierarchy for EPS networks and legacy UEs
For EPS networks the BEST key hierarchy is as depicted in Figure 4.6.2.2-2.
Figure 4.6.2.2-2: BEST Key Hierarchy for EPS networks and BEST UEs
For 5GS networks the BEST key hierarchy is as depicted in Figure 4.6.2.2-3.
Figure 4.6.2.2-3: BEST Key Hierarchy for 5GS networks
The derivation of the key KHSE is described in clause 5.1.0a.
For GBA and 5G GBA based key agreement, the BEST key hierarchy is as depicted in Figure 4.6.2.2-4.
Figure 4.6.2.2-4: BEST Key Hierarchy for GBA and 5G GBA based key agreement
For AKMA based key agreement, the BEST key hierarchy is as depicted in Figure 4.6.2.2-5.
Figure 4.6.2.2-5: BEST Key Hierarchy for AKMA based key agreement
For proprietary key agreement, the BEST key hierarchy is as depicted in Figure 4.6.2.2-6.
Figure 4.6.2.2-6: BEST Key Hierarchy for proprietary key agreement
The KIntermediate, KEAS_PSK and all of the keys derived from them are generated when indicated to do so in the BEST CP messaging.",TS 33.163,4.6.2.2,all_images/image_305.jpeg,BEST Key Hierarchy for 5GS networks
"This solution address Key Issue #1 Credentials owned by an external entity, in particular the case where the separate entity is deployed as a AAA server. It is assumed that the AAA server is some existing solution. Hence, no updates to the AAA server can be made.
The assumed architecture is described in TR 23.700-7 [3], clause 6.8.2.2. An illustration is provided here for convenience in Figure 6.1.1-1. The SNPN includes a complete 5GS SNPN network and the CdP is the Credential provider (AAA server in this case).
Figure 6.1.1-1: Access to SNPN services using credentials from Credential Provider (CdP) for authentication in the SNPN",TR 33.857,6.1.1,all_images/image_306.jpeg,Access to SNPN services using credentials from Credential Provider (CdP) for
"Figure 6.7.2-1: Derive KAUSF from MSK and RAND
Figure 6.7.2-2: Derive KAUSF from a new key exchange
Figure 6.7.2-3: Derive KAUSF from a new EAP authentication
1.	The UE sends to the SEAF a Registration Request message, including the SUCI which is constructed from the UE SUPI. The SUPI is of the type of NAI in the form of username@realm. The ""username"" is either ""anonymous"" or omitted if the subscriber identifier privacy is required by SNPN and the public key of the SNPN is not provisioned in the UE.
2.	The SEAF sends to the AUSF Nausf_UEAuthentication_Authenticate Request message, including the SUCI and the SN-name (the serving network name).
3.	The AUSF sends to the UDM the Nudm_UEAuthentication_Get Request, including the SUCI and the SN-name.
4.	The UDM de-conceals the SUCI to obtain the SUPI. If the SUCI is not constructed using the null-scheme, the UDM invokes the SIDF located within the UDM to de-conceal the SUCI.
The ""username"" portion of the SUPI could be a real username, ""anonymous"", or null (i.e., omitted). In any case, the UDM uses the SUPI to determine that the credentials of this UE is owned by an external entity and return the information that is needed by the AUSF to use the AAA-E to authenticate the UE.
NOTE 1: 	Whether such a SUCI calculation using non null scheme is needed at the UE is not addressed in the present document. The details on SUCI calculation, if needed, are not addressed in the present document.
5.	The UDM sends to the AUSF the Nudm_UEAuthentication_Get Response, which also includes the SUPI and any additional information that may assist AUSF to reach AAA-E.
6.	The AUSF uses SUPI, any assistant information from the UDM, and/or local information to determine that an AAA server needs to be invoked to authenticate the UE.
The AUSF sends an authentication request to the AAA server. The exact message format of this authentication request depends on the interface over which the request is sent. It could be a service based interface if there is an interworking function to external AAA-E, or an AAA interface (e.g., RADIUS or DIAMETER) which may go through an AAA proxy (AAA-P).
Note that SUPI is needed to route the request to the ultimate destination AAA-E since there may be additional AAA proxies in front of the AAA-E. SN-Name is needed to derive KSEAF.
7. An intermediate entity (e.g., AAA-P) forwards the authentication request to the AAA-E.
8. The AAA-E and the UE performs an EAP authentication that is selected by the AAA-E.
9. Upon the successful completion of EAP authentication, the AAA-E sends an Access Accept messages to the AAA-P, including EAP Success, SUPI, and MSK.
Note that SUPI is needed since the SUPI received by AUSF in step 5 may be anonymous.
10. The AAA-P forwards the Access Accept (or translates it to a service authentication response) to the AUSF, including EAP Success, SUPI, and MSK.
11-12. The AUSF performs additional steps to generate new keying materials to derive KAUSF.
In option 1 (see Figure 6.7.2-2), the AUSF generates some random data (namely RAND) and derive the KAUSF from both the RAND and the MSK.
In option 2 (see Figure 6.Y.2.2), a new key exchange (e.g., Diffie-Hellman) is executed between the AUSF and the UE to derive new key materials to be used for deriving KAUSF. The MSK received from the AAA-E can be used to authenticate the key exchange.
In option 3 (see Figure 6.7.2.2), a new EAP authentication is executed between the UE and the AUSF based on the MSK. For example, an EAP-TLS with PSK (preshared key) can be executed to derive a new MSK and a new EMSK. KAUSF is derived from the new EMSK.
13. The AUSF sends to the SEAF an EAP-Success message along with the SUPI and the KSEAF in a Nausf_UEAuthentication_Authenticate Response message. In option 1, the RAND is also included.
14. The SEAF forwards to the UE the EAP-Success message in an Authentication Result message or a Security Mode Command message, including ngKSI and ABBA. In option 1, the RAND is also included.
15. Upon receiving the EAP-Success message, the UE derives the KAUSF accordingly based on one of the three options in use.",TR 33.857,6.7.2,all_images/image_307.jpeg,Derive KAUSF from MSK and RAND
"Figure 6.7.2-1: Derive KAUSF from MSK and RAND
Figure 6.7.2-2: Derive KAUSF from a new key exchange
Figure 6.7.2-3: Derive KAUSF from a new EAP authentication
1.	The UE sends to the SEAF a Registration Request message, including the SUCI which is constructed from the UE SUPI. The SUPI is of the type of NAI in the form of username@realm. The ""username"" is either ""anonymous"" or omitted if the subscriber identifier privacy is required by SNPN and the public key of the SNPN is not provisioned in the UE.
2.	The SEAF sends to the AUSF Nausf_UEAuthentication_Authenticate Request message, including the SUCI and the SN-name (the serving network name).
3.	The AUSF sends to the UDM the Nudm_UEAuthentication_Get Request, including the SUCI and the SN-name.
4.	The UDM de-conceals the SUCI to obtain the SUPI. If the SUCI is not constructed using the null-scheme, the UDM invokes the SIDF located within the UDM to de-conceal the SUCI.
The ""username"" portion of the SUPI could be a real username, ""anonymous"", or null (i.e., omitted). In any case, the UDM uses the SUPI to determine that the credentials of this UE is owned by an external entity and return the information that is needed by the AUSF to use the AAA-E to authenticate the UE.
NOTE 1: 	Whether such a SUCI calculation using non null scheme is needed at the UE is not addressed in the present document. The details on SUCI calculation, if needed, are not addressed in the present document.
5.	The UDM sends to the AUSF the Nudm_UEAuthentication_Get Response, which also includes the SUPI and any additional information that may assist AUSF to reach AAA-E.
6.	The AUSF uses SUPI, any assistant information from the UDM, and/or local information to determine that an AAA server needs to be invoked to authenticate the UE.
The AUSF sends an authentication request to the AAA server. The exact message format of this authentication request depends on the interface over which the request is sent. It could be a service based interface if there is an interworking function to external AAA-E, or an AAA interface (e.g., RADIUS or DIAMETER) which may go through an AAA proxy (AAA-P).
Note that SUPI is needed to route the request to the ultimate destination AAA-E since there may be additional AAA proxies in front of the AAA-E. SN-Name is needed to derive KSEAF.
7. An intermediate entity (e.g., AAA-P) forwards the authentication request to the AAA-E.
8. The AAA-E and the UE performs an EAP authentication that is selected by the AAA-E.
9. Upon the successful completion of EAP authentication, the AAA-E sends an Access Accept messages to the AAA-P, including EAP Success, SUPI, and MSK.
Note that SUPI is needed since the SUPI received by AUSF in step 5 may be anonymous.
10. The AAA-P forwards the Access Accept (or translates it to a service authentication response) to the AUSF, including EAP Success, SUPI, and MSK.
11-12. The AUSF performs additional steps to generate new keying materials to derive KAUSF.
In option 1 (see Figure 6.7.2-2), the AUSF generates some random data (namely RAND) and derive the KAUSF from both the RAND and the MSK.
In option 2 (see Figure 6.Y.2.2), a new key exchange (e.g., Diffie-Hellman) is executed between the AUSF and the UE to derive new key materials to be used for deriving KAUSF. The MSK received from the AAA-E can be used to authenticate the key exchange.
In option 3 (see Figure 6.7.2.2), a new EAP authentication is executed between the UE and the AUSF based on the MSK. For example, an EAP-TLS with PSK (preshared key) can be executed to derive a new MSK and a new EMSK. KAUSF is derived from the new EMSK.
13. The AUSF sends to the SEAF an EAP-Success message along with the SUPI and the KSEAF in a Nausf_UEAuthentication_Authenticate Response message. In option 1, the RAND is also included.
14. The SEAF forwards to the UE the EAP-Success message in an Authentication Result message or a Security Mode Command message, including ngKSI and ABBA. In option 1, the RAND is also included.
15. Upon receiving the EAP-Success message, the UE derives the KAUSF accordingly based on one of the three options in use.",TR 33.857,6.7.2,all_images/image_309.jpeg,Derive KAUSF from a new EAP authentication
"Following pre-conditions are assumed:
-	The UE is provisioned with some default UE credentials and a unique UE identifier at the manufacturing time. The unique UE identifier is assumed to be unique within the DCS. It takes the form of a Network Access Identifier (NAI), which is composed of the user part and the realm part, which may identify the domain name of the DCS. UE is provisioned with set of roots of trust certificate information that UE will use to authenticate O-SNPN during the authentication.
-	The UE is not provisioned with subscription credentials that grant access to a SO-SNPN.
-	The Onboarding SNPN (O-SNPN) that is used by the UE in the onboarding process is not necessarily the same as the SO-SNPN (Subscription Owner SNPN) for which subscription credentials will be provisioned in the UE.
-	The O-SNPN operator has access to a Default Credential Server (DCS), which is used to verify that UE is subject to onboarding based on the UE identifier and the associated default UE credentials. The DCS is used for UE authentication/authorization in the O-SNPN during the establishment of a PDU Session for onboarding purposes. The DCS owner is out of the present document's scope and can be inside or outside of the O-SNPN, e.g., DCS can be owned by the device manufacturer, by an SNPN other than the O-SNPN, or by a 3rd party.
In some deployments, the DCS and the Provisioning Server can be the same entity. In deployments where the DCS and the Provisioning Server are different entities, it is expected that they communicate with each other for the purpose of UE authentication based on the default UE credentials via an interface that is outside of this solution's scope.
NOTE 1: 	Provisioning is out of scope of this solution.
The SO-SNPN owning the subscription (SO-SNPN) interacts with the Provisioning Server during the UE onboarding procedure and provides the corresponding UE's subscription credentials and UE's configuration data to be provisioned to the UE. The actual provisioning mechanisms are outside the scope of this solution.
Figure 6.14.2.0-1: UE Onboarding for Remote Provisioning Procedure
0.	UE pre-configuration: The UE is provisioned with default UE credentials that allow for successful UE authentication and a unique UE identifier. A configuration may also include information for selecting SNPN needed to access the provisioning server.
1.	Initial access to the Onboarding SNPN:
a.	Selection of SNPN: UE selects the O-SNPN based on the indication in SIB broadcasted by O-SNPN (e.g., ""Support for onboarding"" indicator). In this step, if the UE wants to initiate the UE onboarding, the UE either automatically discovers and selects the O-SNPN network based on the broadcasted information or presents a list of available ONs to the user for manual selection. The UE registers to O-SNPN for onboarding by including an indication in the Registration Request, indicating that the registration is for UE onboarding.
b.	Registration Procedure: During the registration procedure, the UE provides the UE-specific information, e.g. corresponding identity (encoded in SUPI format) to the network. The user may also provide the UE with additional information, such as an application identifier and/or Service Provider Identifier. An authentication using non-AKA (e.g. EAP-TLS) based method is performed. The SUPI is of the type of NAI in the form of username@realm. The ""username"" is either ""anonymous"" or UE identity can be omitted if the subscriber identifier privacy is required by SNPN. The UE performs the one-way authentication of O-SNPN based on O-SNPN's certificate.
2.	Configuration PDU session: UE obtains limited connectivity to the Provisioning Server. In the Configuration PDU Session Establishment Request, the UE includes DCS identity and optionally includes PS identity, SO-SNPN identity, or both. When the UE provides SO-SNPN identity, the SMF in the O-SNPN may decide to override the PS identity provided by the UE and send the new PS identity to the UE in the PDU Session Establishment Accept as PCO parameter. The PS identity received in the PDU Session Establishment Accept overrides any configured PS identity in the device. It is assumed that one and only one Configuration PDU session can be established, and connectivity of this PDU session is limited (cf. RLOS), so that the UE can only access a Provisioning Server.
3.	The PDU session establishment authentication/authorization is performed as described in TS 23.502 [6] clause 4.3.2.3 and in TS 33.501 [2] clause 11.1.2. Secondary authentication is triggered with the DCS by the SMF during PDU Session establishment. The SMF selects the DCS either based on the DCS identity sent from the UE to the SMF or based on the realm part of the UE identity. It is required that the secondary authentication performed between the UE and the DCS is an EAP authentication that supports mutual authentication
NOTE 2:	Clarification of, if the O-SNPN can perform mutual EAP authentication with DCS as part of secondary authentication, why such a EAP authentication cannot be performed as part of primary authentication in step 1 is not addressed in the present document.
4.	The UE discovers the Provisioning Server using the stored PS identity. At this point, the stored PS identity is either the PS identity pre-configured in the UE, or the PS identity entered manually by the user, or the PS identity received by the O-SNPN. If the UE still does not have a stored PS identity, then the UE uses a well-known FQDN to perform PS discovery. The UE provides the provisioning server with the unique UE identifier, optionally the identity of the selected SO-SNPN. The provisioning server discovers the DCS using DCS identity sent from the UE to PS or based on the realm part of the unique UE identity and authenticates the UE and make a secure connection for provisioning with the UE, based on the default UE credentials. Interface between DCS and PS is out of the scope of this solution.
NOTE 3: 	This solution assumes there is trust relationship between DCS and PS. Specifics of the interface between DCS and PS including the aspects of mutual authentication, encryption and integrity protection are out of the scope of this solution.
NOTE 4: 	When the Onboarding network is the same as SNPN owning the subscription of the UE, the Provisioning Server is owned by the Onboarding Network.
5.	Upon successful provisioning, the UE releases the Configuration PDU Session and deregisters from the O-SNPN.
6.	Upon a successful de-registration, the UE initiates a regular procedure, including a selection of a SO-SNPN, Registration using the provisioned credentials with the SO-SNPN owning the subscription, and PDU Session establishment(s). Depending on the provisioned subscription credentials, the UE may select an SNPN that is the same or different from the SNPN owning the credentials.",TR 33.857,6.14.2.0,all_images/image_312.jpeg,UE Onboarding for Remote Provisioning Procedure
"Figure 6.14.2.1-1 below shows the EAP-TLS Authentication Procedures over 5G Networks as described in TS 33.501 Annex B.2.1; the difference with respect to the EAP-TLS authentication procedure for one-way authentication is highlighted and described below.
Figure 6.14.2.1-1: Using EAP-TLS Authentication Procedures over 5G Networks for initial one-way authentication
Step 1: When the UE sends a registration request with Registration Type as Onboarding, the UE sends an anonymous SUCI described in clause B 2.1.2.2 of TS 33.501 [2].
Step 2: The AMF (SEAF) selects an AUSF and sends the Nausf_UEAuthentication_Authenticate Request message to the AUSF, including information to assist the AUSF in selecting the EAP-TLS authentication method for one-way authentication.
NOTE 1:	The information to assist the AUSF in selecting EAP-TLS for one-way authentication can be sent as an explicit parameter or can be encoded inside the realm part of the SUCI. Alternatively, the AMF (SEAF) can use a dedicated AUSF for onboarding.
Steps 3, 4, 5: are not required as the AUSF determines the authentication method.
It is required that the secondary authentication performed between the UE and the DCS is an EAP authentication that supports mutual authentication
Steps 6, 7, 8, 9: Same procedure as described in TS 33.501[2] Annex B.2.1.
Steps 10-11: The AUSF replies to the SEAF with EAP-Request/EAP-TLS in the Nausf_UEAuthentication_Authenticate Response, which may include a chain of TLS certificates leading to root of trust certificate authority.
Step 12: The UE authenticates the server with the received message from step 8.
NOTE 2: The underlying assumption is that the device is configured with a set of root-of-trust certificates at manufacturing time.
NOTE 3:	If the AUSF has a certificate issued by a root-of-trust authority, it includes a single certificate in step 10. Otherwise, the AUSF includes a chain of certificates that leads to the root-of-trust authority.
NOTE 4:	O-SNPN prepares a Certificate Signing Request (CSR) and submits it to the CA of their choice (trusted by business agreement) [7]. A CSR carries the list of hosts that should appear in the certificate, along with a public key and proof of possession of the corresponding private key (via a digital signature). CA then validates subscriber's identity (O-SNPN) using different procedures as per business agreement.
Extended Validation (EV) certificates [7] can be used to provide certificates to ON by subordinate CA's or CA's. EV Certificates cannot be obtained by individuals or rogue entities, or non-incorporated entities. When fraudulent certificate requests are submitted, CAs tend to maintain a list of domain names and refuse to issue certificates for them without manual confirmation. EV certificates can be used to provide certificates to ON by subordinate CA's or CA's.
To further ascertain the security of one-way authentication, O-SNPN with a business relationship with Intermediate CA and Registration Authority can use the following certificate extensions as per [7]. Signed Certificate Timestamps (SCT), Extended Key usage, and named constraint can also be used together for intermediate certificates to avoid arbitrary public certificates for fraudulent O-SNPN and provide a reliable authentication/verification mechanism of server certificates' one-way authentication.
To verify the TLS handshake integrity, the server sends cryptographic signatures of the exchanged data. The handshake proceeds only if the signatures can be verified. Any other result would imply a modification of the network traffic by a third party.
Steps 13-14: If the TLS server authentication is successful, the UE replies with EAP-Response/EAP-TLS in the Authentication Response message. The response message does not include the TLS Certificate, and TLS_certificate_verify message as the network authentication of the UE is not required.
With one-way authentication where only the UE authenticates the onboarding network, the key material for AS and NAS security is generated following the same procedure as described in TS 33.501[2] Annex B.2.1.",TR 33.857,6.14.2.1,all_images/image_313.png,Using EAP-TLS Authentication Procedures over 5G Networks for initial one-way
"Figure 6.19.2-1 shows a generalisation of the solution.
Figure 6.19.2-1: initial access and sharing of identity
1.	The UE sends a Registration Request including a SUCI to the network.
As an example the SUCI can be constructed in such way that the SUCI's Home Network Identifier HNI is set to a fixed predefined string, like ""onboarding"", which can be used by the 5GS to determine that the UE is requesting access without client authentication for onboarding purposes. The scheme output of the SUCI can be set to an empty string Alternatively also new registration type specified by SA2 could be utilized for the purpose of finding out that the UE is requesting unauthenticated access for onboarding purposes. In this case HNI and scheme output can be set to empty strings.
NOTE 1: 	Details can be defined during normative phase.
2.	AMF / SEAF forwards request to AUSF.
3.	Based on the received SUCI the AUSF concludes that the UE wants to execute unauthenticated access and selects a corresponding EAP-TLS method configured without client authentication. The selection of the EAP method might be carried out by the AUSF, or the AUSF might invoke the UDM for this (not shown in Figure 6.19.2-1)
NOTE 2: 	Decision of whether UDM needs to be involved can be taken during normative work.
4.	UE and AUSF execute EAP based authentication using the selected EAP-TLS method. This is following the procedure in TS 33.501 [2] described for EAP-TLS except that the selected EAP-TLS method without client authentication.
5.	Before the last step of the EAP procedure the AUSF calculates KAUSF and KSEAF as defined in TS 33.501 [2], i.e., The EMSK resulting from the executed EAP session is used as input for the derivation of KAUSF.
6.	The AUSF returns response message including EAP Success message, KSEAF and SUPI. The SUPI is set to a predefined constant value, which indicates to the SEAF that the UE has not been authenticated.
7.	AMF / SEAF finalizes the EAP session towards the UE.
8.	SEAF calculates the KAMF as specified in TS 33.501 [2] with the difference that not a real SUPI, but a reserved string is used as input to the key derivation function. The calculation of the remaining 5G keys is according to TS 33.501 [2].
9.	UE calculates all 5G keys according to the definitions in TS 33.501 [2], with the difference that not a real SUPI but the same reserved string also used by the SEAF is used as input to the key derivation function.
10.	UE and AMF establish security context as defined in TS 33.501 [2].
11.	AMF and UE exchange Identity Request/Response messages to obtain UE's (PEI) (as defined in TS 23.502 [6]), e.g., based on local configuration in AMF.
12.	AMF sends Equipment Identity Check Request to the EIR using PEI as input parameter.
13.	EIR checks, if PEI is on an Allowed-List of UEs, which are entitled for onboarding.
NOTE 3: 	The PEI based identity check might be optional for the O-SNPN. Therefore, it is up to the O-SNPN, if it wants to make use of this additional security mechanism. However, a UE, which wants to use unauthenticated access for onboarding needs to support Identity Request/Response message.
NOTE 4: 	The PEI of the onboarding UE has been added to the O-SNPNs Allowed-List prior to the onboarding. That is, the device owner, which is an entity or person trusted by the O-SNPN, has provided the PEI of the UE to the O-SNPN.
NOTE 5: 	The PEI sent from the UE to the AMF is not cryptographically protected. That is a malicious UE might simply send the PEI of another UE. However, since the authorization is done by the EIR using a positive list, an attacker might need to know or guess a valid PEI. Furthermore, the authorization using the PEI, is just used to avoid overload situations of the O-SNPN and is not used to derive any security association. The actual mutual authentication and authorization between UE and PVS will take place during the subsequent provisioning step, which is outside the scope of this solution.
14.	If UE's PEI was on the Allowed list, the AMF will reply with a positive response.
15. AMF confirms Registration
After the one-way authentication and optionally PEI based authorization has been executed, the UE can request a restricted PDU Session as studied in TR 23.007-7 [3] and currently standardized in TS 23.501 [4]. The actual provisioning of the Subscriber profile is executed subsequently and outside the scope of this solution.",TR 33.857,6.19.2,all_images/image_314.jpeg,initial access and sharing of identity
"This solution addresses Key issue #2 ""Provisioning of Credentials"".
The architecture of this solution is illustrated as Figure 6.20.1-1. It is assumed that the domain of the PS has trust relationship with the O-SNPN.
Figure 6.20.1-1: Architecture of control plane based provisioning: PS to AUSF",TR 33.857,6.20.1,all_images/image_315.jpeg,Architecture of control plane based provisioning: PS to AUSF
"This solution addresses Key issue #2 ""Provisioning of Credentials"".
The architecture of this solution is illustrated as Figure 6.21.1-1. It is assumed that the domain of the PS has trust relationship with the O-SNPN.
Figure 6.21.1-1: Architecture of control plane based provisioning: PS to UDM",TR 33.857,6.21.1,all_images/image_317.jpeg,Architecture of control plane based provisioning: PS to UDM
"The UE is identified by the DCS based on the onboarding SUCI, the DCS can deconceal the SUCI to a onboarding SUPI. The DCS can authenticate the UE based on the onboarding credentials and provision the MSK to the AUSF for setting up the security over the radio interface for AS and NAS per normal procedures. The DCS and UE derive a provisioning key which is used to protect the profile from the Provisioning Server.
Figure 6.22.2-1: Network access authentication with credentials owned by an entity separate from the SNPN
1.	The UE sends a Registration Request with the Onboarding SUCI of the DCS as UE identity to the AMF.
2.	The AMF detects based on the realm of the NAI that the Registration Request is not from a subscriber of the SNPN but for onboarding at a DCS. The AMF authorizes the request by verifying the realm of the NAI and whether the SNPN has an active agreement with this DCS. The AMF forwards the request to the AUSF which may be preconfigured for handling requests towards external DCS.
3.	The AUSF may perform authorization of the registration request by verifying the realm of the NAI and whether the SNPN has an active agreement with this DCS. The AUSF identifies the DCS and takes the role of an AAA-Proxy, sending a related AAA message to the corresponding AAA-Server. The AUSF sends an Authentication Request with the onboarding SUCI to the DCS.
NOTE 1:	In this solution the SBI-DIAMETER interworking functionality is collocated with the AUSF.
4.	The DCS deconceals the SUCI to a SUPI and verifies the authentication request based on the username. The DCS selects the subscriber profile based on the SUPI and performs an EAP based authentication with the UE, using the pre-shared onboarding credentials in the UE and in the DCS.
5.	After successful authentication, the DCS sends the result of the authentication, the onboarding SUPI, MSK, validity time and address of the Provisioning Server back in an authentication response to the AUSF.
6.	The AUSF verifies the response and derives the KAUSF from the MSK and the KSEAF according to TS 33.501. the UE is performing the same key derivation accordingly.
7.	The AUSF sends an authentication response to the AMF/SEAF including the authentication result from the DCS and the KSEAF, the onboarding SUPI, the validity time, i.e. time until the onboarding expires and the address of the Provisioning Server.
8. The AMF performs NAS SMC with the UE.
9. After a successful NAS SMC procedure, the AMF sends the Registration Accept including the address of the Provisioning Server.
10.	The UE performs a normal PDU Session Establishment procedure to gain IP connectivity.
11. The UE and the DCS derive a Provisioning Key KPro from the MSK in the same way.
12. The DCS provides the provisioning information Onboarding SUPI and Provisioning Key KPro to the Provisioning Server. The selection for the Provisioning Server may be performed based on the stored address in the DCS per onboarding SUPI.
NOTE 2: 	The solution introduces a new interface between the DCS and the PS.
13. The Provisioning Server selects the Profile based on the onboarding SUPI.
14. The UE establishes and IPSec SA with the Provisioning Server by using the KPro. All messages are now confidentiality and integrity protected by the IPsec tunnel.
15. The Provisioning Server provisions the new profile to the UE via the IPSec tunnel.
16. The Provisioning Server acknowledges the successful provisioning to the DCS.
17. The DCS deletes or deactivates the onboarding profile that relates to the onboarding SUPI. This prevents that if onboarding credentials are compromised, succeeding impersonation attacks from malicious UEs are prevented from being provisioned with the valid profile.
18. The UE deregisters from the Onboarding network and may also delete or deactivate the onboarding profile.
19: The UE select the NPN according to the provisioned profile and registers to the NPN according to the normal procedures in TS 23.501/TS 33.501.",TR 33.857,6.22.2,all_images/image_318.jpeg,Network access authentication with credentials owned by an entity separate from the
"Figure 7.7.2-1: User's consent for exposure of information to the Edge Applications
0.	 The user consent parameters are stored in UDM as subscription data.
As TS 23.558 [2] indicates that based on the request from EAS, the EES shares the UE information. The EES provides such information only if the user consent is available at the EES and the EAS is authorised to receive such information from the EES.
If there is no related user consent parameters in UE context, the EES invokes Nudm_SDM_Get Request service to retrieve related user consent parameters from the UDM. Otherwise, steps 1-6 can be skipped.
1)	The EES (enforcing entity) sends API invocation to NEF, requesting to obtain user consent for sharing user's sensitive information. The API invocation includes the Application ID or the subscription ID of the UE.
2)	Based on the local policy, the NEF determines the corresponding UDM for the consent check or consent retrieval.
3)	NEF sends the Nudm_SDM_Get Request message to the UDM. The message includes the API invocation with the Application ID or the subscription ID of the UE.
4)	The UDM retrieves user consent parameters based on the subscription ID of the UE or the application ID.
5)	The UDM sends Nudm_SDM_Get Response message to the NEF. The response message includes the user consent parameters.
6)	 Upon receiving the user consent parameters from the UDM, the NEF forwards the user consent parameters to the requesting EES.
NOTE: 	EES has to be operated by the same entity as the data providers.",TR 33.867,7.7.2,all_images/image_320.jpeg,User's consent for exposure of information to the Edge Applications
"Figure 6.2.2.2-1: UAV Authentication and Authorization procedure for EPS
1.	Attach and a PDN connection activation procedures are performed. As the UAV has a subscription indicating UAV capability the PCRF generates a PCC rule indicating UAV application and header enrichment policy.
2.	UAV sends UAS A&A request to the UAS AF.
3.	PGW detects the UAV application traffic and adds UAV subscription information.
NOTE: 	In case of end-to-end security between UAV and UAS AF, to enable the PGW to add UAV subscription information, a HTTP(S) proxy functionality in the PGW is integrated under the assumption that TLS is used for end-to-end security. The certificate of the UAS-AF needs to be provisioned to the PGW. The PGW terminates TLS for HTTPS-requests towards to the UAS-AF and then apply header-enrichment.
4.	UAS AF checks if the UAV has a valid aerial subscription based on the subscription information received from the PGW.
If the check is successful, the UAS AF based on the UTM/USS identity, looks up the corresponding UTM/USS URL and triggers a request towards the UTM/USS. If the check is unsuccessful a response is sent to the UAV rejecting the request. The UAS AF can include information to the UTM/USS needed for further interaction between UTM/USS using network APIs and EPS regarding the PDU session.
5.	UTM/USS performs authentication and authorization steps which are transparent to the network. In this communication, the UAS AF and PGW relay the traffic between UAV and UTM/USS.
6.	If the A&A in step 5 is successful, UTM/USS triggers a accept response to UAS AF acknowledging the request including an application specific information such as a security context to be used in the establishment of secure connection between UAV and UTM/USS. The transfer of this information is transparent to the network and the content of it is out of 3GPP scope.
If the A&A is un-successful, a response is sent to the UAV rejecting the request.
7.	The UAS AF sends the response to the UAV.
8.	UAV triggers a set-up of a secure connection to UTM/USS e.g. using the information received in step 7.",TR 33.854,6.2.2.2,all_images/image_322.jpeg,UAV Authentication and Authorization procedure for EPS
"The procedure for UAV Authentication and Authorization by USS/UTM during registration, is depicted in Figure 6.3.2.1-1. The same procedure may be used with a networked UAV-C.
Figure 6.3.2.1-1: Procedure for UAV authentication and authorization with USS/UTM during registration
Pre-condition: UAV is configured with a long-term UAV ID (e.g. serial number, CAA registration id) and credentials used for authentication by USS/UTM. The UAV ID and credentials are obtained by means outside of 3GPP scope
1. The UE sends a Registration Request message including its UE id, a UAV id and UAV communications capabilities. UE may provide a USS/UTM address if available.
NOTE 1: 	If the UAV id is subject to privacy protection, existing partial cyphering mechanisms may be used to protect it during initial Registration transmission.
2. If the UE is not already authenticated by the network, a primary authentication procedure is performed.
3. The AMF determines whether a UAV A&A by USS/UTM is required based on:
- 	Subscription information (i.e., whether the UE is authorized for UAS operations).
- 	If the UAV is undergoing A&A by USS/UTM procedure or UAV has previously performed such procedure successfully and the authorization was allowed and still valid.
4. AMF sends in the Registration Accept message a pending UAV A&A indication. UE refrains from establishing PDU Session dedicated to UAS communications until the successful completion of the following A&A steps. The Registration Accept message may include some other configuration information such as allowed UAS communication modes/types (e.g. network assisted, direct). The UE sends a Registration Complete if this is an initial Registration.
5. AMF triggers an API-based UAV A&A by USS/UTM procedure. UE is authenticated using UAV credentials (e.g. CAA-level UAV ID, certificate). During the procedure, the AMF provides the USS/UTM with a 3GPP UAV ID (e.g. GPSI as External id) and AMF may receive a CAA-level UAV id (e.g. a temporary Session id) from USS/UTM. The AMF stores the CAA-level UAV id in the UE context. The AMF may use the CAA-level UAV id to determine whether to perform UAV A&A as described in step 2. The AMF provides the CAA-level UAV id and to the UE in the following step.
NOTE 2: 	It is assumed that the AMF may communicate with the USS/UTM using an A&A proxy function (similar to NSSAAF). This proxy function provides USS/UTM discovery/address resolution, authentication messages routing and protocol translation capabilities. Authentication of USS/UTM is supported by the A&A proxy by means of provisioned aviation domain certificates. USS/UTM address may be obtained from a trusted resolution function that can resolve the USS/UTM address from the CAA-level UAV ID (if USS/UTM address was not provided by the UE in step 1).
6. Upon successful UAV A&A by USS/UTM, AMF initiates the UE Configuration Update procedure to deliver authorized UAS Configuration parameters to the UE. The UAS Configuration may include the following parameters to be used for UAS communication setup: the CAA-level UAV ID, S-NSSAI/DNN. The CAA-level UAV ID is used for remote or broadcast Remote ID.
7. The UE establishes a PDU Session using authorized UAS parameters as provided in step 6 (e.g. CAA-level UAV ID).
8. The UE receives a PDU Session Establishment Accept message authorizing UAS communications.
9. The UE exchanges UAS traffic with peer UAV-C.
NOTE 3: 	PDU Session establishment and UAS communications steps above may be subject to additional pairing with UAV-C authorization. Additional details for pairing authorization are assumed to be covered in solutions for KI#2.",TR 33.854,6.3.2.1,all_images/image_323.png,Procedure for UAV authentication and authorization with USS/UTM during
"The procedure for UAV authorization revocation by USS/UTM is depicted in Figure 6.3.2.2-1.
Figure 6.3.2.2-1: Procedure for USS/UTM triggered UAV authorization revocation
Pre-condition: UAV has been previously authorized by USS/UTM according to procedure 6.3.2.1.
1. The USS/UTM determines that the UAV authorization is to be revoked.
2. The USS/UTM sends an Authorization revocation request to the A&A Proxy providing the 3GPP UAV ID of the target UAV.
3. The Proxy A&A determines the AMF serving the UAV by requesting UDM providing the 3GPP UAV ID and forwards the request to the AMF.
4. The AMF checks if there are any active PDU session used for UAS communications (used with USS/UTM and/or UAV-C).
5. [Conditional] If above check is positive, the AMF initiates a PDU session release procedure for all applicable PDU sessions.
6. The AMF initiates a UCU procedure to revoke authorization information that was stored in the UE based on procedure 6.3.2.1 or initiate a DeRegistration procedure indicating the cause of deregistration.
7. The AMF sends an Authorization revocation response to the A&A Proxy confirming revocation of UAV authorization.
8. The A&A Proxy forwards the Authorization revocation response to the USS/UTM providing the 3GPP UAV ID and CAA-level UAV ID confirming revocation of authorization for the specified UAV.",TR 33.854,6.3.2.2,all_images/image_324.jpeg,Procedure for USS/UTM triggered UAV authorization revocation
"The procedure for UAV A&A by USS/UTM based on PDU secondary authentication is depicted in Figure 6.4.2.1-1. The same procedure may be used with a networked UAV-C.
Figure 6.4.2.1-1: Procedure for UAV authentication and authorization with USS/UTM PDU Session establishment
0. The UE has successfully completed a primary authentication and is registered with the network.
1. UE sends a PDU session establishment request message that may include the following parameters: a long-term UAV ID (CAA-level UAV ID) that is communicated to the USS/UTM. The UE may also provide a USS/UTM address. AMF sends corresponding request to SMF.
NOTE 1:	 It is assumed the UE has obtained prior to this procedure the CAA-level UAV ID from a CAA and has been configured with a USS/UTM address by means outside of 3GPP scope
2. The SMF determines whether the UE is allowed for UAS operations based on subscription information and local policies.
3. The SMF triggers an EAP-based authentication procedure towards the USS/UTM. SMF resolves the address of the USS/UTM based on provided CAA-level UAV ID or USS/UTM address (if provided). During the procedure, the SMF provides the USS/UTM with a 3GPP UAV ID (e.g. GPSI as External id) and receives from the USS/UTM a new assigned CAA-level UAV ID (e.g. a temporary Session id) upon successful authentication and authorization.
NOTE 2: 	Details of the authentication of the USS/UTM (or its address provided by the UE) by the network are not provided by this solution.
4. Upon successful authorization by USS/UTM, the SMF sends a PDU session establishment accept message that includes the new CAA-level UAV ID. The SMF provides the USS/UTM with IP address allocated for the PDU Session as specified for PDU secondary authentication by an external DN-AAA procedure (as per TS 23.502 clause 4.3.2.3).The SMF maintains the session with the USS/UTM for further updates of the PDU session that may be triggered by the USS/UTM (e.g. UAV authorization revocation triggered by USS/UTM as described in clause 6.3.2.2).
5. The UE may additionally establish a separate PDU Session dedicated for UAS communications. A separate PDU session is necessary if a separate DNN from the one used to communicate with USS/UTM is used for communication with a UAV-C (e.g. while the first PDU session is being used for network Remote ID and tracking functionality). The UE provides the CAA-level UAV ID obtained from successful authorization by USS/UTM.
6. The UE receives a PDU Session Establishment Accept message authorizing UAS communications.
NOTE 3: 	Additional details for pairing authorization performed over first or second PDU Session are assumed to be covered in solutions for KI#2
7. The UE exchanges UAS traffic with peer UAV-C.",TR 33.854,6.4.2.1,all_images/image_325.png,Procedure for UAV authentication and authorization with USS/UTM PDU Session
"The procedure for UAV A&A by UTM using API-based PDU secondary authentication is depicted in Figure 6.5.2.1-1. The same procedure may be used with a networked UAV-C.
Figure 6.5.2.1-1: Procedure for UAV authentication and authorization with USS/UTM during PDU session establishment (API-based authentication)
0. The UE has successfully completed a primary authentication and is registered with the network.
1. UE sends a PDU session establishment request message that may include the following parameters: a long-term UAV ID (CAA-level UAV ID), a DNN/S-NSSAI for communicating with USS/UTM. The UE may also provide a USS/UTM address. AMF selects SMF based on UE's subscription information and DNN/S-NSSAI values. S-NSSAI/DNN may be specifically used for UAS operations with well-known values or default values configured in the UE by the network. AMF sends corresponding request to SMF.
NOTE 1: 	It is assumed the UE has obtained prior to this procedure the CAA-level UAV ID from a CAA and has been configured with a USS/UTM address by means outside of 3GPP scope
2. The SMF determines whether the UE is allowed for UAS operations based on subscription information and local policies.
3. The SMF triggers an API-based authentication procedure towards the USS/UTM. The SMF communicates with the USS/UTM via a Proxy A&A function (e.g. NEF) that provides an authentication API functionality. SMF or the Proxy A&A is responsible for resolving the address of the USS/UTM based on provided CAA-level UAV ID or USS/UTM address (if provided). The Proxy A&A function may authenticate USS/UTM using provisioned aviation domain certificates. The USS/UTM address may be obtained from a trusted resolution function that resolves the USS/UTM address based on the UE provided CAA Level UAV ID (if USS/UTM address was not provided by UE in step 1). During the procedure, the SMF/Proxy A&A provides the USS/UTM with a 3GPP UAV ID (e.g. GPSI as an External id) and receives from the USS/UTM a new assigned CAA-level UAV ID and authorization token and/or key material upon successful authentication and authorization. Multiple round-trips may be exchanged between the UAV and USS/UTM via SMF/Proxy A&A based on the authentication method supported by USS/UTM. During this procedure, the Proxy A&A obtains information about UAV connectivity (e.g. serving SMF ID, PDU Session ID, UAV IP address) to enable further updates of the PDU session that may be triggered by the USS/UTM (e.g. UAV authorization revocation triggered by USS/UTM as described in clause 6.5.2.2).
NOTE 2: 	How the token and/or key material is generated by the USS/UTM is outside the scope of 3GPP. The USS/UTM can for example bind the token/key material to both 3GPP UAV ID and CAA UAV level ID.
4. Upon successful authorization by USS/UTM, the SMF sends a PDU session establishment accept message that includes the new CAA-level UAV ID and authorization token and/or key material from USS/UTM.
5. The UE may additionally establish a separate PDU Session dedicated for UAS communications or modify/reuse existing PDU Session used for UAV A&A with USS/UTM. A separate PDU session is necessary if a separate DNN from the one used to communicate with USS/UTM is used for communication with a UAV-C (e.g. while the first PDU session is being used from network Remote ID functionality). The UE provides the CAA-level UAV ID obtained following the successful authorization by USS/UTM. If a UAV-C identity is known to the UAV, it may provide it during the procedure (i.e., PDU Session establishment or modification) to request pairing authorization from USS/UTM. USS/UTM notifies of pairing authorization outcome (e.g. with authorized UAV-C IP address) to the SMF (e.g. via Proxy A&A function/UAS-NF). SMF performs the configuration of the PDU Session accordingly (e.g. ACL for enforcement of pairing with UAV-C authorization).
NOTE 3: 	If the UAV-C identity is not known to the UAV, then it is expected that the pairing may be initiated by the peer UAV-C. The UAV may be informed of pairing authorization during a network triggered PDU Session modification triggered when USS/UTM notifies the SMF of the pairing authorization outcome and/or by application layer signalling between USS/UTM and UAV (outside of 3GPP scope).
6. The UE receives a PDU Session Establishment Accept message authorizing UAS communications. The UE may receive a new CAA-level UAV ID and optionally key material from the USS/UTM as part of a successful pairing authorization. The security parameters above (token and/or key material) when provided by the USS/UTM to the UAV are transported in transparent containers (i.e., not processed by the intermediate entities).
7. The UE establishes a secure application layer communication with the USS/UTM using the authorization token and/or key material obtained previously to further obtain UAS communication configuration from USS/UTM or perform network Remote ID reporting. The USS/UTM checks the validity of the presented authorization token.
NOTE 4: 	The secure application layer communication between the UAV and USS/UTM is outside of the scope of 3GPP.
8. The UE exchanges UAS traffic with peer UAV-C. The UAV and UAV-C may setup a secure connection based on key material received from USS/UTM as described in above steps.",TR 33.854,6.5.2.1,all_images/image_326.png,Procedure for UAV authentication and authorization with USS/UTM during PDU
"Figure 6.7.2-1: UAS authentication and authorization (UAA) procedure
Step 1. As a precondition the UAV is registered with the USS/UTM by the UAS operator using any method outside the 3GPP scope. During this registration, the UAV is configured with the CAA-level UAV ID, the USS routing information (which may also be part of CAA-level UAV ID), and the required long-term credentials to enable UAS security. These are the credentials that are provisioned into the UAV to form the root of the UAS security. The credentials may include symmetric key(s) or public/private key pair (example. with certificates) depending on the implementation which is out of 3GPP scope.
Step 2a-b. The UAV sends registration request to AMF and a primary authentication is performed as specified in TS 33.501.
Step 2c. After a successful primary authentication, the AMF based on the UE (UAV) subscription information fetched from the UDM/UDR determines to trigger UAS authentication and authorization (UAA).
NOTE 1: 	The UAA can also be performed when an UAV requests a PDU session establishment for any UAS service (i.e., USS/UTM) by including the CAA-Level UAV ID in the PDU Session establishment Request message where the UAA related message exchange is performed involving the SMF.
Step 2d. AMF sends to UE (UAV) an UAS authentication Required Indicator or a pending UAA indication in the Registration Accept message.
Step 3a. AMF may optionally send an UAS ID request to the UAV over the NAS transport.
Step 3b. The UAV responds to AMF with a UAS ID response containing CAA-level UAV ID and optionally USS routing information (if routing information is not part of CAA-level UAV ID).
Step 3c. Based on the USS routing Information, the AMF sends a UAS Authentication request message (i.e., over a service-based interface) to the UFES. The GPSI can be used for external identification of UAV. The routing to a UFES and USS/UTM and external ID usage need to be aligned with SA2 agreements during the normative work.
NOTE 2: 	The new 3GPP UAS Network Function specified in SA2 TR 23.754 [3] conclusion is referred as UFES in this solution. The actual naming for the new 3GPP UAS Network Function which handles the UAS related operational message exchange between 5GS/EPS and USS/UTM can be defined during the normative phase.
Step 3d. The UFES forwards the received UAS authentication request message to the appropriate USS/UTM.
Step 3e. The USS/UTM performs authentication method specific message exchange with the UAV to enable mutual authentication. The authentication method used for UAA is up to USS/UTM and it is out of 3GPP scope.
Step 3f. The USS/UTM on performing a successful UAS authentication, verifies the preconfigured CAA Level UAV ID based on the stored UAV subscription, if required assign a new CAA Level UAV ID to the UAV. Further the USS/UTM assigns a UAS ID to uniquely identify the UAS formed by the UAV and associated UAV-C information based on UAS subscription. The method of UAS-ID assignment is out of 3GPP scope. Further the USS/UTM sgenerate a UAS root security context (based on a method out of 3GPP scope) from the long-term credential available as part of UAS subscription information in the USS/UTM to enable UAS security and an UAS root security identifier (e.g. bound to the security context)  is generated to uniquely identify the UAS root security context in the USS/UTM. To enable authorization of UAV for various UAS service following a UAS registration (example., flight authorization request, PDU session establishment for C2 and Pairing of UAV with UAV-C etc.), the USS/UTM generates an Authorization Token (Auth Token) (e.g. it can be bound to the UAS ID, UAV-CAA-Level ID, optional UAV-C ID). The USS/UTM also assigns a lifetime (a validity period or time duration) for the authorization token for it to be used by the 3GPP network to authorize the UAV for various subsequent UAS services. The USS/UTM after successful UAS authentication, locally stores the External ID of UAV (i.e., GPSI), CAA-level UAV ID, authentication status information, UAS ID, Auth Token, lifetime along with UAS Security Context and its identifier. The UAS root security context (e.g. a key) and its corresponding identifier forms the UAS security context. Optionally, if the UAV has no preconfigured UAV-C ID, the USS/UTM may also provide the UAV-C ID for the UAV along with the UAV authentication response.
Step 3g. In response to the successful UAS authentication, the USS/UTM sends the UAS authentication response message to the UFES. The UAS authentication response message includes an authentication result with Success Indication, GPSI, CAA Level UAV ID, UAS ID, UAS security context, Auth Token and lifetime.
Step 3h. The UFES receives the UAS authentication response message containing Success Indication, GPSI, CAA Level UAV ID, UAS ID, UAS security context, Auth Token and lifetime as part of the UAS information for the UAV. The UFES stores the received UAS information for the UAV and the parameters exactly stored at UFES will be defined during the normative phase. Further, the UFES forwards the received UAS authentication response message to the AMF.
Step 3i. The AMF receives the UAS authentication response message and locally stores the received authentication result with Success Indication, CAA Level UAV ID, UAS ID, Auth Token and lifetime as part of the UAS information for the UAV to enable subsequent UAS service authorization at the 3GPP network.
Step 3j. The AMF forwards the received UAS authentication response message to the UAV.
Step 3k. The UAV receives the UAV authentication response message and on receiving a 'Success Indication', the UAV generates the UAS Security context (UAS root security context and identifier) similar to the USS/UTM from the long-term credential preconfigured in the UAV. If the locally generated UAS security context and received UAS security context matches, then the UAV considers the UAS authentication as successful and locally stores the received CAA Level UAV ID, UAS ID, Auth Token, lifetime, UAS root security context and its identifier along with the most recently derived KUAS as part of UAS Security Context. The UAV uses the UAS root security context identifier to uniquely identify the UAS root security context. The UAS root security context can be used by the UAV and USS/UTM to set up secure connection.
Step 4. The AMF may trigger UE parameter update procedure as specified in TR 23.754 [3].
UAS Authentication and Authorization (UAA) Revocation:
Figure 6.7.2-2: UAS authentication and authorization (UAA) Revocation procedure
Step 1. The USS/UTM determines to revoke UAS authentication and authorization corresponding to an UAV identified with CAA Level UAV-ID and sends an UAA Revocation Notification with GPSI and CAA Level UAV ID to the corresponding UFES using a service operation message.
Step 2. The UFES fetches the serving AMF ID corresponding to the GPSI of the UAV from the UDM by invoking Nudm_UECM_Get Request/Response message based on TS 23.502 Clause 5.2.3.2.4.
Step 3. The UFES sends the received UAA Revocation Notification message to the AMF with the CAA level UAV ID.
Step 4a-b. The AMF on receiving the UAA Revocation Notification, if there is any related active PDU session corresponding to the UAV, initiates a PDU Session release based on TS 23.502 Clause 4.3.4.
Step 5. The AMF further enables the UAA revocation with the UE using the UE Configuration update procedure. The AMF sends CAA Level UAV ID along with the UAA Revocation indication to the UAV in the UE Configuration update command.
Step 6. The UAV on receiving the UAA Revocation indication, deletes all the UAS authorization and security information locally stored corresponding to its CAA Level UAV ID.
Step 7. The UAV further sends to AMF, a UE Configuration update complete message with a UAA Revocation acknowledgement along with the CAA Level UAV ID.
Step 8. The AMF on receiving the UAA Revocation acknowledgement and CAA Level UAV ID, deletes locally stored UAS authorization and security information corresponding to the UAV ID.
Step 9a. The AMF further sends an UAA Revocation acknowledgement message with Success Indication, GPSI and CAA Level UAV ID to the UFES.
Step 9b. The UFES removes UAV related information (if any) locally stored related to the UAV.
Step 10. The UFES further sends the received UAA Revocation acknowledgement message with the received Success Indication, GPSI and CAA Level UAV ID to the USS/UTM.
Step 11. The USS/UTM on receiving the UAA Revocation acknowledgement message with Success Indication, GPSI and CAA Level UAV ID, updates the UAS authentication status and related information locally stored for the UAV.
Applicability to EPS:
The UAS Authentication and Authorization procedure and revocation procedure described in this section can be applicable to EPS, with the adaptation of MME, SMF+PGW-C, UPF+PGW-U and HSS+UDM respectively as described in the steps below. UFES can act as a UAS NF or UAS control function in the 3GPP network which can be a standalone network function, or a service offered by the SCEF in the EPS instead of NEF in the 5GS. For the UAA revocation procedure, the MME, S-GW+PGW-C and HSS will be involved in EPS. The message name used in EPS procedure can be aligned with SA2 where required during the normative work. The steps related to UAA for an UAV in EPS scenario is described as follows:
Step 1. The precondition is applicable as described for 5GS case.
Step 2. The UAV sends Attach request to MME and an authentication and key agreement is performed. The UAV can send a CAA level UAV ID with USS Routing information, Flight path data and target UAV-C information if any during the attach request or after authentication in a NAS message.
Step 3. The MME, based on the subscription information, selects the Default APN for connectivity with the USS/UTM based on 23.754 [3]. The MME can send to SMF+PGW-C via SGW, a create session request which contains the CAA level UAV ID and flight path data and target UAV-C information if any and 3GPP UAV ID (i.e., an external identifier). The MME receives a create session response form SMG+PGW-C and an attach accept is provided to the UAV.
Step 4. The SMF+PGW-C sends a UAV authentication request to the UFES (or a UAS NF as mentioned in 23.754 [3]) with CAA level UAV ID and flight path data and target UAV-C information if any and 3GPP UAV ID.
Step 5. The UFES forwards the received UAS authentication request message to the appropriate USS/UTM.
Step 6. The USS/UTM performs authentication method specific message exchange with the UAV to enable mutual authentication. The authentication method used for UAA is up to USS/UTM and it is out of 3GPP scope. Then Step 3f and 3g (Figure 6.7.2-1) is similar as described for 5GS.
Step 7. In response to the successful UAS authentication, the USS/UTM sends the UAS authentication response message to the UFES. The UAS authentication response message includes an authentication result with Success Indication, 3GPP UAV ID, CAA Level UAV ID, UAS ID, UAS security context, Auth Token and lifetime.
Step 8. The UFES receives the UAS authentication response message and may store any received UAS information for the UAV. Further, the UFES forwards the received UAS authentication response message to the SMF+PGW-C.
Step 9. The SMF+PGW-C sends update bearer request with the information received in UAS authentication response message to the MME.
Step 10. The MME forwards the received UAS authentication response message to the UAV in a NAS message. The UAV receives the UAV authentication response message and then the process in UAV is same as described in step 3k (Figure 6.7.2-1) for 5GS and sends a response to MME.
Step 11. The MME further confirms to SMF+PGW-C with update bearer response. The MME/SMF+PGW-C locally stores the received authentication result with Success Indication, CAA Level UAV ID, UAS ID, Auth Token and lifetime as part of the UAS information for the UAV to enable subsequent UAS service authorization at the 3GPP network. The SMF+PGW-C can set the traffic filters to allow traffic between UAV and USS/UTM based on the authentication result
The UAA revocation in EPS for any UAV can be performed as follows:
Step 1. The USS/UTM determines to revoke UAS authentication and authorization corresponding to an UAV identified with CAA Level UAV-ID and sends an UAA Revocation Notification with 3GPP UAV ID (i.e., external identifier) and CAA Level UAV ID to the corresponding UFES.
Step 2. The UFES sends the received UAA Revocation Notification message to the SMF+PGW-C (the serving PGW can be identified based on TR 23.754 [3]).
Step 3. The SMF+PGW-C on receiving the UAA Revocation Notification, initiates a PDN connection release and during the PDN connection release procedure, it provides to UAV via the SGW and MME, the CAA level UAV ID and UAA Revocation indication based on the received UAA Revocation Notification message.
Step 4. The UAV on receiving the UAA Revocation indication, can delete all the UAS authorization and security information locally stored corresponding to its CAA Level UAV ID.
Step 5. The UAV further responds to MME, with a UAA Revocation acknowledgement along with the CAA Level UAV ID.
Step 6. The MME sends the received UAA Revocation acknowledgement and CAA Level UAV ID, to SMF+PGW-C, which can delete the locally stored UAV information.
Step 7. The SMF+PGW-C send the UAA Revocation acknowledgement along with the CAA Level UAV ID to the UFES.
Step 8. The UFES removes UAV related information (if any) locally stored related to the UAV. The UFES further sends the received UAA Revocation acknowledgement message with the received Success Indication, GPSI and CAA Level UAV ID to the USS/UTM.
Step 9. The USS/UTM on receiving the UAA Revocation acknowledgement message with Success Indication, GPSI and CAA Level UAV ID, updates the UAS authentication status and related information locally stored for the UAV.",TR 33.854,6.7.2,all_images/image_328.png,UAS authentication and authorization (UAA) procedure
"Figure 6.7.2-1: UAS authentication and authorization (UAA) procedure
Step 1. As a precondition the UAV is registered with the USS/UTM by the UAS operator using any method outside the 3GPP scope. During this registration, the UAV is configured with the CAA-level UAV ID, the USS routing information (which may also be part of CAA-level UAV ID), and the required long-term credentials to enable UAS security. These are the credentials that are provisioned into the UAV to form the root of the UAS security. The credentials may include symmetric key(s) or public/private key pair (example. with certificates) depending on the implementation which is out of 3GPP scope.
Step 2a-b. The UAV sends registration request to AMF and a primary authentication is performed as specified in TS 33.501.
Step 2c. After a successful primary authentication, the AMF based on the UE (UAV) subscription information fetched from the UDM/UDR determines to trigger UAS authentication and authorization (UAA).
NOTE 1: 	The UAA can also be performed when an UAV requests a PDU session establishment for any UAS service (i.e., USS/UTM) by including the CAA-Level UAV ID in the PDU Session establishment Request message where the UAA related message exchange is performed involving the SMF.
Step 2d. AMF sends to UE (UAV) an UAS authentication Required Indicator or a pending UAA indication in the Registration Accept message.
Step 3a. AMF may optionally send an UAS ID request to the UAV over the NAS transport.
Step 3b. The UAV responds to AMF with a UAS ID response containing CAA-level UAV ID and optionally USS routing information (if routing information is not part of CAA-level UAV ID).
Step 3c. Based on the USS routing Information, the AMF sends a UAS Authentication request message (i.e., over a service-based interface) to the UFES. The GPSI can be used for external identification of UAV. The routing to a UFES and USS/UTM and external ID usage need to be aligned with SA2 agreements during the normative work.
NOTE 2: 	The new 3GPP UAS Network Function specified in SA2 TR 23.754 [3] conclusion is referred as UFES in this solution. The actual naming for the new 3GPP UAS Network Function which handles the UAS related operational message exchange between 5GS/EPS and USS/UTM can be defined during the normative phase.
Step 3d. The UFES forwards the received UAS authentication request message to the appropriate USS/UTM.
Step 3e. The USS/UTM performs authentication method specific message exchange with the UAV to enable mutual authentication. The authentication method used for UAA is up to USS/UTM and it is out of 3GPP scope.
Step 3f. The USS/UTM on performing a successful UAS authentication, verifies the preconfigured CAA Level UAV ID based on the stored UAV subscription, if required assign a new CAA Level UAV ID to the UAV. Further the USS/UTM assigns a UAS ID to uniquely identify the UAS formed by the UAV and associated UAV-C information based on UAS subscription. The method of UAS-ID assignment is out of 3GPP scope. Further the USS/UTM sgenerate a UAS root security context (based on a method out of 3GPP scope) from the long-term credential available as part of UAS subscription information in the USS/UTM to enable UAS security and an UAS root security identifier (e.g. bound to the security context)  is generated to uniquely identify the UAS root security context in the USS/UTM. To enable authorization of UAV for various UAS service following a UAS registration (example., flight authorization request, PDU session establishment for C2 and Pairing of UAV with UAV-C etc.), the USS/UTM generates an Authorization Token (Auth Token) (e.g. it can be bound to the UAS ID, UAV-CAA-Level ID, optional UAV-C ID). The USS/UTM also assigns a lifetime (a validity period or time duration) for the authorization token for it to be used by the 3GPP network to authorize the UAV for various subsequent UAS services. The USS/UTM after successful UAS authentication, locally stores the External ID of UAV (i.e., GPSI), CAA-level UAV ID, authentication status information, UAS ID, Auth Token, lifetime along with UAS Security Context and its identifier. The UAS root security context (e.g. a key) and its corresponding identifier forms the UAS security context. Optionally, if the UAV has no preconfigured UAV-C ID, the USS/UTM may also provide the UAV-C ID for the UAV along with the UAV authentication response.
Step 3g. In response to the successful UAS authentication, the USS/UTM sends the UAS authentication response message to the UFES. The UAS authentication response message includes an authentication result with Success Indication, GPSI, CAA Level UAV ID, UAS ID, UAS security context, Auth Token and lifetime.
Step 3h. The UFES receives the UAS authentication response message containing Success Indication, GPSI, CAA Level UAV ID, UAS ID, UAS security context, Auth Token and lifetime as part of the UAS information for the UAV. The UFES stores the received UAS information for the UAV and the parameters exactly stored at UFES will be defined during the normative phase. Further, the UFES forwards the received UAS authentication response message to the AMF.
Step 3i. The AMF receives the UAS authentication response message and locally stores the received authentication result with Success Indication, CAA Level UAV ID, UAS ID, Auth Token and lifetime as part of the UAS information for the UAV to enable subsequent UAS service authorization at the 3GPP network.
Step 3j. The AMF forwards the received UAS authentication response message to the UAV.
Step 3k. The UAV receives the UAV authentication response message and on receiving a 'Success Indication', the UAV generates the UAS Security context (UAS root security context and identifier) similar to the USS/UTM from the long-term credential preconfigured in the UAV. If the locally generated UAS security context and received UAS security context matches, then the UAV considers the UAS authentication as successful and locally stores the received CAA Level UAV ID, UAS ID, Auth Token, lifetime, UAS root security context and its identifier along with the most recently derived KUAS as part of UAS Security Context. The UAV uses the UAS root security context identifier to uniquely identify the UAS root security context. The UAS root security context can be used by the UAV and USS/UTM to set up secure connection.
Step 4. The AMF may trigger UE parameter update procedure as specified in TR 23.754 [3].
UAS Authentication and Authorization (UAA) Revocation:
Figure 6.7.2-2: UAS authentication and authorization (UAA) Revocation procedure
Step 1. The USS/UTM determines to revoke UAS authentication and authorization corresponding to an UAV identified with CAA Level UAV-ID and sends an UAA Revocation Notification with GPSI and CAA Level UAV ID to the corresponding UFES using a service operation message.
Step 2. The UFES fetches the serving AMF ID corresponding to the GPSI of the UAV from the UDM by invoking Nudm_UECM_Get Request/Response message based on TS 23.502 Clause 5.2.3.2.4.
Step 3. The UFES sends the received UAA Revocation Notification message to the AMF with the CAA level UAV ID.
Step 4a-b. The AMF on receiving the UAA Revocation Notification, if there is any related active PDU session corresponding to the UAV, initiates a PDU Session release based on TS 23.502 Clause 4.3.4.
Step 5. The AMF further enables the UAA revocation with the UE using the UE Configuration update procedure. The AMF sends CAA Level UAV ID along with the UAA Revocation indication to the UAV in the UE Configuration update command.
Step 6. The UAV on receiving the UAA Revocation indication, deletes all the UAS authorization and security information locally stored corresponding to its CAA Level UAV ID.
Step 7. The UAV further sends to AMF, a UE Configuration update complete message with a UAA Revocation acknowledgement along with the CAA Level UAV ID.
Step 8. The AMF on receiving the UAA Revocation acknowledgement and CAA Level UAV ID, deletes locally stored UAS authorization and security information corresponding to the UAV ID.
Step 9a. The AMF further sends an UAA Revocation acknowledgement message with Success Indication, GPSI and CAA Level UAV ID to the UFES.
Step 9b. The UFES removes UAV related information (if any) locally stored related to the UAV.
Step 10. The UFES further sends the received UAA Revocation acknowledgement message with the received Success Indication, GPSI and CAA Level UAV ID to the USS/UTM.
Step 11. The USS/UTM on receiving the UAA Revocation acknowledgement message with Success Indication, GPSI and CAA Level UAV ID, updates the UAS authentication status and related information locally stored for the UAV.
Applicability to EPS:
The UAS Authentication and Authorization procedure and revocation procedure described in this section can be applicable to EPS, with the adaptation of MME, SMF+PGW-C, UPF+PGW-U and HSS+UDM respectively as described in the steps below. UFES can act as a UAS NF or UAS control function in the 3GPP network which can be a standalone network function, or a service offered by the SCEF in the EPS instead of NEF in the 5GS. For the UAA revocation procedure, the MME, S-GW+PGW-C and HSS will be involved in EPS. The message name used in EPS procedure can be aligned with SA2 where required during the normative work. The steps related to UAA for an UAV in EPS scenario is described as follows:
Step 1. The precondition is applicable as described for 5GS case.
Step 2. The UAV sends Attach request to MME and an authentication and key agreement is performed. The UAV can send a CAA level UAV ID with USS Routing information, Flight path data and target UAV-C information if any during the attach request or after authentication in a NAS message.
Step 3. The MME, based on the subscription information, selects the Default APN for connectivity with the USS/UTM based on 23.754 [3]. The MME can send to SMF+PGW-C via SGW, a create session request which contains the CAA level UAV ID and flight path data and target UAV-C information if any and 3GPP UAV ID (i.e., an external identifier). The MME receives a create session response form SMG+PGW-C and an attach accept is provided to the UAV.
Step 4. The SMF+PGW-C sends a UAV authentication request to the UFES (or a UAS NF as mentioned in 23.754 [3]) with CAA level UAV ID and flight path data and target UAV-C information if any and 3GPP UAV ID.
Step 5. The UFES forwards the received UAS authentication request message to the appropriate USS/UTM.
Step 6. The USS/UTM performs authentication method specific message exchange with the UAV to enable mutual authentication. The authentication method used for UAA is up to USS/UTM and it is out of 3GPP scope. Then Step 3f and 3g (Figure 6.7.2-1) is similar as described for 5GS.
Step 7. In response to the successful UAS authentication, the USS/UTM sends the UAS authentication response message to the UFES. The UAS authentication response message includes an authentication result with Success Indication, 3GPP UAV ID, CAA Level UAV ID, UAS ID, UAS security context, Auth Token and lifetime.
Step 8. The UFES receives the UAS authentication response message and may store any received UAS information for the UAV. Further, the UFES forwards the received UAS authentication response message to the SMF+PGW-C.
Step 9. The SMF+PGW-C sends update bearer request with the information received in UAS authentication response message to the MME.
Step 10. The MME forwards the received UAS authentication response message to the UAV in a NAS message. The UAV receives the UAV authentication response message and then the process in UAV is same as described in step 3k (Figure 6.7.2-1) for 5GS and sends a response to MME.
Step 11. The MME further confirms to SMF+PGW-C with update bearer response. The MME/SMF+PGW-C locally stores the received authentication result with Success Indication, CAA Level UAV ID, UAS ID, Auth Token and lifetime as part of the UAS information for the UAV to enable subsequent UAS service authorization at the 3GPP network. The SMF+PGW-C can set the traffic filters to allow traffic between UAV and USS/UTM based on the authentication result
The UAA revocation in EPS for any UAV can be performed as follows:
Step 1. The USS/UTM determines to revoke UAS authentication and authorization corresponding to an UAV identified with CAA Level UAV-ID and sends an UAA Revocation Notification with 3GPP UAV ID (i.e., external identifier) and CAA Level UAV ID to the corresponding UFES.
Step 2. The UFES sends the received UAA Revocation Notification message to the SMF+PGW-C (the serving PGW can be identified based on TR 23.754 [3]).
Step 3. The SMF+PGW-C on receiving the UAA Revocation Notification, initiates a PDN connection release and during the PDN connection release procedure, it provides to UAV via the SGW and MME, the CAA level UAV ID and UAA Revocation indication based on the received UAA Revocation Notification message.
Step 4. The UAV on receiving the UAA Revocation indication, can delete all the UAS authorization and security information locally stored corresponding to its CAA Level UAV ID.
Step 5. The UAV further responds to MME, with a UAA Revocation acknowledgement along with the CAA Level UAV ID.
Step 6. The MME sends the received UAA Revocation acknowledgement and CAA Level UAV ID, to SMF+PGW-C, which can delete the locally stored UAV information.
Step 7. The SMF+PGW-C send the UAA Revocation acknowledgement along with the CAA Level UAV ID to the UFES.
Step 8. The UFES removes UAV related information (if any) locally stored related to the UAV. The UFES further sends the received UAA Revocation acknowledgement message with the received Success Indication, GPSI and CAA Level UAV ID to the USS/UTM.
Step 9. The USS/UTM on receiving the UAA Revocation acknowledgement message with Success Indication, GPSI and CAA Level UAV ID, updates the UAS authentication status and related information locally stored for the UAV.",TR 33.854,6.7.2,all_images/image_329.jpeg,UAS authentication and authorization (UAA) Revocation procedure
"Figure 6.10.2.2-1 shows how the UAV can be authenticated and authorized by the USS/UTM to access the 3GPP network as a UAV, i.e. it is assumed in these flow that the authentication and authorization will happen.
Figure 6.10.2.2-1: Authentication and authorization of a UAV
The steps are as follows:
1. The UAV sends a Registration Request to the AMF requesting to register as UAV. The UE includes USS/UTM routing information in the Registration Request message.
NOTE 1: 	How the UE signals it is requesting to register as a UAV is left to stage 3 specification.
NOTE 2: 	The details of the how the USS/UTM is selected from USS/UTM routing information is left to the stage 3 specification. One possibility is a CAA-level UAV ID. If this is not supplied this ID can be requested during steps 6a and step 6b when authenticating and authorizing the UAV.
2. Primary authentication and NAS security establishment are performed.
3. The AMF sends the Registration Accept message to the UAV indicating that the UAV needs to be authorized by the USS/UTM.
NOTE 3: 	At this point the UAV has restricted access to PDU sessions.
4. Based on subscription information and local policies, the AMF requests UAV authentication and authorization from UFES including the USS/UTM routing information. The UFES is selected using the USS/UTM routing information.
5. The UFES triggers an authentication and authorization request including the CAA-level UAV ID if available from the USS/UTM. The correct USS/UTM is selected using the USS/UTM routing information and a USS/UTM will only be selected if it has been authorized to act as one. The UFES includes the 3GPP UAV ID in the request.
NOTE 4: 	Whether the 3GPP UAV ID is sent from the AMF or retrieved (from other network entities) using the SUPI is left to stage 3 specification.
6a. and 6b. There can be several round trips required for authentication of the UAV by the UTMs depending on the authentication method used by the USS/UTM and UAV. The authentication method and the content of messages used for authentication are out of scope of 3GPP. The content of the messages is carried in containers that are passed along and not processed by the entities between the UAV and USS/UTM.
7. On a successful authentication and authorization of the UAV, the USS/UTM stores the 3GPP UAV ID with the CAA-level UAV ID. The UTMS/USS informs the UFES that the UAV has been successfully authenticated and authorized by the USS/UTM. The USS/UTM includes authorization information for both the network and the UAV.
8. The UFES further informs the AMF that the UAV has been successfully authenticated and authorized by the USS/UTM. The UFES passes the received authorization information onto the AMF.
9. The AMF stores the network authorization information as part of the UE context. The network authorization information further contains the information whether USS/UTM authentication and authorization is required during future registrations and whether to allow UE to establish PDU session(s) dedicated for the UAS service with or without further USS/UTM authentication and authorization.
NOTE 5: The lifetime of the authorization, e.g. permanent till revocation or one time authorization, is left to the normative phase.
The AMF triggers a UE Configuration Update (UCU) procedure to inform the UE that the UAV authentication and authorization has been successful. The UCU procedure contains the UAV authorization information. Part of the contents of the UAV authorization information may be passed to the UAV without modification by any entities between USS/UTM and UAV. The UAV uses the UAV authorization information to check if it is authorized by the network to act as a UAV and also to receive any needed aviation information if any, e.g. a CAA-level UAV ID.
NOTE 6: 	Before step 9, the UE has restricted access to PDU sessions. After step 9, there are no restrictions, although a further authentication and authorization might be required during PDU session establishment.",TR 33.854,6.10.2.2,all_images/image_331.jpeg,Authentication and authorization of a UAV
"Figure 6.13.2.2-1 shows how the UAV can be authenticated and authorized by the USS/UTM when connected to EPS.
Figure 6.13.2.2-1: Authentication and authorization of a UAV connection to EPS
The steps are as follows:
1. The UAV sends an Attach Request to the MME. The UAV includes the Aviation Connectivity payload which contains the allocated CAA-Level UAV ID and flight/pairing information in the message.
2. The MME authenticates the UAV and establishes the security.
3. The MME determines the subscription is an aerial subscription and selects the SMF+PGW-C to establish the default bearer.
4. The MME sends a Create Session Request message to the SMF+PGW-C. The message includes the Aviation Connectivity payload.
5. The SMF+PGW-C responds with a Create Session Response. At this point the UAV is restricted from sending user plane traffic.
6. The MME sends an Attach Accept message to the UAV.
7. The UAV responds with an Attach Complete message to the MME.
8. The SMF+PGW-C requests a UAV authentication and authorization from the UFES and includes the Aviation Connectivity payload in the request.
9. The UFES forwards the information to the USS/UTM. Only authorized USS/UTMs will be used in order to ensure only legitimate entities can provide authorization for UAVs.
10a. and 10b. There can be several round trips required for authentication of the UAV by the USS/UTM depending on the authentication method used by the USS/UTM and UAV. The authentication method and the content of messages used for authentication are out of scope of 3GPP. The content of the messages is carried in containers that are passed along and not processed by the entities between the UAV and USS/UTM.
11. On a successful authentication and authorization of the UAV, the USS/UTM stores the 3GPP UAV ID with the CAA-level UAV ID. The USS/UTM informs the UFES that the UAV has been successfully authenticated and authorized by the USS/UTM. The USS/UTM includes authorization information for both the network and the UAV.
12. The UFES further informs the SMF+PGW-C that the UAV has been successfully authenticated and authorized by the USS/UTM. The UFES passes the received authorization information onto the SMF+PGW-C. The SMF+PGW-C stores the network authorization information as part of the UE context. The network authorization information further contains the information whether USS/UTM authentication and authorization is required during future registrations and whether to allow UE to establish PDN connections(s) dedicated for the UAS service with or without further USS/UTM authentication and authorization. The network part of the authorization data contains authorization information applicable to existing PDN connections, which influence SMF+PGW-C decisions for the traffic on these connections. For example, the information may indicate to disable all connectivity of the UAV except for the connectivity to USS/UTM.
13. The SMF+PGW-C sends the Update Bearer Request message to the MME and include the UAV authorization information. The MME responds with the Update Bearer Response message. The SMF+PGW-C also set the traffic filters to allow traffic based on the received authorization information.
14. The MME passes the UAV authorization information to the UAV to inform the UAV that the authorization was successful. The UAV authorization information contains any needed aviation information, e.g. a new CAA-level UAV ID.
15. If using different PDN connections for C2 traffic, the UAV triggers a PDN connection set-up procedure which may include a further UAV authentication and authorization.
16. C2 traffic can start to pass between UAV and UAVC.",TR 33.854,6.13.2.2,all_images/image_333.jpeg,Authentication and authorization of a UAV connection to EPS
"Figure 6.14.2.2-1 shows how the UAV can be authenticated and authorized by the USS/UTM to allow a connection with a paired UAVC. The flows assume that the UAV has already connected to 5GS and been authorized to act as a UAV (see for example solution #6.8).
Figure 6.14.2.2-1: Authentication and authorization of a connection between a UAV and UAVC
In the following steps, if multiple PDU sessions are established for UAV to USS/UTM and UAV to UAVC communications, respectively, the first PDU session established is for UAV to USS communications. In case of multiple PDU sessions, the UAV provides the information related to authorizing the pairing between the UAV and UAVC only during the establishment of the PDU session for UAV to UAVC communications.
The steps are as follows:
1. The UAV sends a PDU Session Establishment Request to the SMF with an indication that the PDU session is for UAV operation. The UAV also include the Aviation Connectivity payload which contains the allocated CAA-Level UAV ID and flight/pairing information.
2. The SMF obtains the SM information from the UDM.
3. The SMF requests a UAV authentication and authorization from the UFES and includes the Aviation Connectivity payload in the request.
4. The UFES forwards the information to the USS/UTM.
5a. and 5b. There can be several round trips required for authentication of the UAV by the USS/UTM depending on the authentication method used by the USS/UTM and UAV. The authentication method and the content of messages used for authentication are out of scope of 3GPP. The content of the messages is carried in containers that are passed along and not processed by the entities between the UAV and USS/UTM.
6. On a successful authentication and authorization of the UAV, the USS/UTM stores the 3GPP UAV ID with the CAA-level UAV ID. The UTMS/USS informs the UFES that the UAV has been successfully authenticated and authorized by the USS/UTM. The USS/UTM includes authorization information for both the network and the UAV.
7. The UFES further informs the SMF that the UAV has been successfully authenticated and authorized by the USS/UTM. The UFES passes the received authorization information onto the SMF. The SMF stores the network authorization information as part of the UE context. The network authorization information further contains the information whether USS/UTM authentication and authorization is required during future registrations and whether to allow UE to establish PDU session(s) dedicated for the UAS service with or without further USS/UTM authentication and authorization. The network part of the authorization data contains authorization information applicable to existing PDU sessions, which influence SMF decisions for the traffic of PDU sessions. For example, the information may indicate to disable all connectivity of the UAV except for the connectivity to USS/UTM.
8. The SMF triggers a PDU Session Establishment Accept message to the UE. The message procedure contains the UAV authorization information. Part of the contents of the UAV authorization information may be passed to the UAV without modification by any entities between USS/UTM and UAV. The UAV authorization information contains any needed aviation information, e.g. a new CAA-level UAV ID.
9. If multiple PDU sessions are used, then the UE triggers a PDU establishment for C2 traffic. This follows steps 1 to 8. In the case of C2 traffic, the USS/UTM provides the necessary information on the UAV-C to allow the network to set the traffic filters in the PDU session to allow connectivity to the UAV-C.
10. The SMF establishes the necessary flow(s) to enable the communication between the UAV and UAVC and C2 traffic can be sent between the UAV and UAVC.",TR 33.854,6.14.2.2,all_images/image_335.jpeg,Authentication and authorization of a connection between a UAV and UAVC
"The authorization of UAV and UAV-C pairing can be performed by the USS/UTM (after a successful primary authentication and during/after a successful UAS authentication) when a UAV initiates a PDU session establishment or when the UAV modifies the existing PDU session to set up C2 connection with the UAV-C for enabling the UAS service as shown in Figure 6.15.2-1. At this step, it is considered that UAV and UAV-C has already performed successful UAS registration with the USS/UTM (and has UAS authorization and security information provided by the USS/UTM). The UAV includes Pairing authorization request information containing UAV-C ID, Auth Token, UAS ID, Security context ID in addition to its CAA-level UAV ID in the PDU session establishment request message (or in PDU session modification request) to SMF along with the UAV operation request and SMF can send the UAV operation Request along with the received Pairing authorization request information to the UFES and the UFES forwards the same to the USS/UTM. UAV operation Request procedure can be based on agreements from SA2 23.754 [3]. The USS/UTM on receiving the Pairing authorization request information along with UAV operation request can perform the UAV and UAV-C pairing authorization and session security set up. Pairing authorization can also be referred C2 Association authorization. The solution considers that, the UAV-C information (i.e., a UAV-C ID) with which the UAV can form an UAS can be available in the USS and it can also be prepositioned to the UAV along with the CAA-level UAV ID provisioning (out of 3GPP scope) as a precondition.
UAV and UAV-C pairing authorization and session security set up procedure is described as follows.
As a precondition, the UAV and UAV-C is registered to the 3GPP network and both UAV and UAV-C has successfully performed UAS Authentication and authorization with the USS/UTM and established a PDU Session with the USS/UTM. Alternatively, the UAV-C may be connected to the USS/UTM over internet.
1. The UAV sends to the AMF, a PDU Session establishment Request with Pairing Authorization Request Information. Pairing Authorization Request Information includes UAV ID, Target UAV-C ID, UAS ID, UAV Authorization Token (the one received during successful UAA from USS/UTM), UAS Security Context Identifier (the one received during the successful UAA from USS/UTM to uniquely identify the UAS security context information established between UAV and USS/UTM).
2. The AMF on receiving the PDU Session establishment Request with Pairing Authorization Request Information, checks if the UAV-ID is authorized to request pairing authorization based on the locally stored UAS authentication and authorization results, authorization information (Token) and UAV-C ID (if available). If both the received Pairing authorization request information and locally stored information matches, the AMF considers the check as successful and perform step 3. If the AMF does not find any UAS authentication results or if the authentication result or authorization information locally stored does not match with the received authorization information, then the AMF triggers UAA as in Solution#7.
3. The AMF sends Nsmf_PDUSession_CreateSMContext Request to the SMF with the received Pairing Authorization Request Information which includes UAV ID, Target UAV-C ID, UAS ID, UAV Authorization Token, UAS Security Context Identifier and 3GPP UAV ID (i.e., GPSI).
Figure 6.15.2-1: UAV and UAV-C pairing authorization
4. The SMF sends the received Pairing Authorization Request to the UFES (in a service operation message) with UAV ID, Target UAV-C ID, UAS ID, UAV Authorization Token, UAS Security Context Identifier along with GPSI and UAV IP address (based on TR 23.754 [3]).
5. The UFES sends the received Pairing Authorization Request to the USS/UTM (in a service operation message) with UAV ID, Target UAV-C ID, UAS ID, UAV Authorization Token, UAS Security Context Identifier along with GPSI and UAV IP address.
6. The USS/UTM verifies the information received in the Pairing Authorization Request with the locally stored information and if the verification is successful, the USS/UTM determines to authorize pairing for the UAV.
Optionally Step 7-10 can be skipped and only step 10 is performed if the UAV-C is connected to the USS/UTM over internet.
7. The USS/UTM sends to the UAV-C identified with the UAV-C ID (via the 3GPP network or over internet) a Pairing Authorization Request, which includes UAV ID, UAV-C ID and UAS ID.
8. The UAV-C in response sends to USS/UTM, a Pairing Authorization Response message which includes UAV-C ID, UAS ID, UAV-C IP address, and UAV-C Authorization Token.
9. The USS/UTM verifies the information such as UAV-C ID, UAS ID, and UAV-C Authorization Token received in the Pairing Authorization Response message by checking with the locally stored information. If the received authorization information match with the locally stored information, the USS/UTM considers the UAV-C pairing authorization as successful.
10. The USS/UTM sends a Pairing Authorization Acknowledgement/Notification message to the UAV-C, which contains Pairing Success Indication, UAV ID, UAV-C ID, UAS ID, and Session Security Information (i.e., to set up session security), UAV IP address.
11. Further the USS/UTM sends a Pairing Authorization Response/Accept message to the UFES in response to receiving step 5. The Pairing Authorization Response contains Pairing Success indication, UAV ID, UAV-C ID, UAS ID, Session Security Information, GPSI, and UAV-C IP address.
12. The UFES sends the received Pairing Authorization Response to the SMF, which contains Pairing Success indication, UAV ID, UAV-C ID, UAS ID, Session Security Information, GPSI and UAV-C IP address.
13. The SMF locally stores the information received in the Pairing Authorization Response as part of pairing authorization status information. Further performs N4 session set up for the authorized pair of UAV and UAV-C.
14. The SMF sends Nsmf_PDUSession_CreateSMContext Response to the AMF with the received Pairing Authorization Response Information which includes Success Indication, UAV ID, UAV-C ID, UAS ID, and Session Security Information.
15. The AMF optionally stores the UAV ID and UAV-C ID along with the pairing authorization status and UAS ID.
16. The AMF sends a PDU Session Establishment Accept message to the UAV over the N1 interface and the PDU Session Establishment Accept message includes the received Authorization Response Information which includes Success Indication, UAV ID, UAV-C ID, UAS ID, and Session Security Information.
The UAV and UAV-C uses the received session security information to set up a secure connection between UAV and UAV-C for the C2 connection.
In case of modifying the existing PDU session during pairing authorization, the steps 1-3 and steps 14-16 will use PDU session modification related message (i.e., PDU session modification request/response message instead of PDU session initiation request/response and PDU session update SM context message instead of PDU session create SM context message accordingly.). The SMF performs the configuration of the PDU Session accordingly to enforce pairing based on the received UAV-C authorization Pairing Authorization Response.
Pairing Authorization Revocation:
Figure 6.15.2-2: UAV and UAV-C pairing authorization revocation
UAV and UAV-C pairing revocation is shown in Figure 6.15.2-2 and the steps involved in the pairing revocation is described as follows.
1. The USS/UTM when it determines to revoke UAV/UAV-C pairing (also known as C2 pairing or C2 association), the USS/UTM sends a Pairing Revocation Notification to the UFES with the GPSI, CAA Level UAV ID and UAV-C ID.
2. The UFES uses the Nudm_UECM_Get Request/Response service operation to fetch the serving SMF information corresponding to the GPSI. Further, the UFES sends the received Pairing Revocation Notification message to the serving SMF, which contains GPSI, CAA Level UAV ID, and UAV-C ID.
3. The SMF on receiving the Pairing Revocation Notification, checks if there is any active PDU Session corresponding to the indicated CAA level UAV ID with a UAV-C ID. If there is any active PDU Session, the SMF performs PDU Session release procedure for the associated PDU Session IDs using the existing procedure in TS 23.502 Clause 4.3.4.3. with the following adaptations.
4a. The SMF sends a PDU Session Release command to the AMF including the PDU Session ID along with a suitable cause value and a pairing revocation information containing CAA level UAV ID and UAV-C ID based on the received pairing revocation notification.
4b. The AMF forwards the PDU Session Release command to the UAV which includes PDU Session ID, with a suitable cause value, and a pairing revocation information containing CAA level UAV ID and UAV-C ID.
5. The UAV on receiving the PDU Session Release command with a pairing revocation information will delete the locally stored pairing authorization information (token, lifetime, identifiers or any related information) and associated security information for the UAV and UAV-C pairing indicated in the revocation information.
6. The UAV sends a PDU Session Release acknowledgement message to the AMF by including the Pairing Revocation Ack indication and CAA Level UAV ID.
7. The AMF deletes locally stored pairing information (such as pairing authorization information and paired UAV and UAV-C IDs if available) for the UAV corresponding to its CAA Level UAV ID. Further the AMF sends a PDU Session Release Acknowledgement message to the SMF with the GPSI, received Pairing Revocation Ack indication and CAA Level UAV ID.
8. The SMF on receiving the Pairing Revocation Ack indication deletes locally stored pairing information (such as pairing authorization information and paired UAV and UAV-C IDs) if available for the UAV corresponding to its CAA Level UAV ID.
9.	Further, the SMF sends a Pairing Revocation Acknowledgement to the UFES with the received GPSI, Success Indication, and CAA Level UAV ID.
10. The UFES forwards the received Pairing Revocation Acknowledgement to the USS/UTM with the received Success Indication, GPSI and CAA Level UAV ID.
Pairing Revocation related to UAV-Controller (UAV-C) Change:
NOTE 1:	SA2 Conclusion specifies that, 'For UAVC replacement, solution #27 may be taken in addition to improve KI#6.'. Therefore, the adaptation described in this section can be used for UAVC replacement when required.
1. The UAV is communicating with UAV-C1 after a successful pairing authorization.
2. The USS/UTM determines to change the UAV-C for a UAV (the determination aspects at USS/UTM are out of 3GPP scope) and sends to SMF via UFES a UAV Operation update message with 3GPP UAV ID, new authorization data (i.e., CAA level UAV ID, new UAV-C2 info (example., ID and IP address), session security information and new UAS ID if any), pairing authorization indication and Cause indicating UAV-C Change.
NOTE 2:	SA2 defines the content of UAV and UAVC pairing information, e.g. 3GPP UAV IDs and corresponding IP addresses and how the IP addresses of UAV and UAVC are available to the USS/UTM is up to SA2 as specified in Solution#27.
3. The SMF initiates PDU session modification procedure (via the serving AMF with the UAV) by sending to AMF, N1 SM container with PDU session Modification command along with the received Pairing authorization indication, new authorization data and a suitable cause value based on the received UAV-C change indication.
4. The AMF forwards the PDU session modification command message to the UAV along with the received Pairing authorization indication, new authorization data and a suitable cause value based on UAV-C change indication.
5. The UAV updates the pairing information based on the received new authorization data and sends a PDU Session Modification Command Ack to AMF. The AMF can update the locally stored pairing information if any (such as paired UAV and UAV-C information, authorization status based on new authorization data received) and forwards the received PDU Session Modification Command Ack to SMF. The SMF can also update the locally stored pairing information if any and updates N4 session of the UPF(s) that are involved by the PDU Session Modification for the new authorized pair of UAV and new UAV-C2 (based on UAV and UAV-C information received from USS/UTM).
6. The UAV communicates with the UAV-C2.
Applicability to EPS:
The UAV/UAV-C (i.e., C2) Pairing authorization and Revocation procedure described in this section can be applicable to EPS, with the adaptation of using MME, SMF+PGW-C, UPF+PGW-U and HSS+UDM respectively. 3GPP NF/UFES can act as a UAS NF or UAS control function in the 3GPP network which can be a standalone network function, or a service offered by the SCEF in the EPS. The message name used in EPS procedure can be aligned with SA2 where required during the normative work. The UAV and UAV-C pairing authorization when connected to EPS is described as follows.
1. The UAV sends to MME, a PDN connection Request with Pairing Authorization Request Information. Pairing Authorization Request Information includes UAV ID, Target UAV-C ID, UAS ID, UAV Authorization Token (the one received during successful UAA from USS/UTM), UAS Security Context Identifier (the one received during the successful UAA from USS/UTM to uniquely identify the UAS security context information established between UAV and USS/UTM).
2. The MME on receiving the PDN connectivity Request with Pairing Authorization Request Information, checks if the UAV-ID is authorized to request pairing authorization based on the locally stored UAS authentication and authorization results, authorization information (Token) and UAV-C ID (if available). If both the received Pairing authorization request information and locally stored information matches, the MME considers the check as successful and perform step 3. If the MME does not find any UAS authentication results or if the authentication result or authorization information locally stored does not match with the received authorization information, then the AMF triggers UAA as in Solution#7.
3. The MME sends Create Session Request to the SMF+PGW-C via S-GW with the received Pairing Authorization Request Information which includes UAV ID, Target UAV-C ID, UAS ID, UAV Authorization Token, UAS Security Context Identifier and 3GPP UAV ID (i.e., an external identifier).
4. The SMF+PGW-C sends the received Pairing Authorization Request to the UFES which contains UAV ID, Target UAV-C ID, UAS ID, UAV Authorization Token, UAS Security Context Identifier along with 3GPP UAV ID and UAV IP address (based on TR 23.754 [3]).
5. The UFES sends the received Pairing Authorization Request to the USS/UTM.
6-10. Steps 6-10 can be performed as described for 5GS.
11. Further the USS/UTM sends a Pairing Authorization Response/Accept message to the UFES in response to receiving step 5. The Pairing Authorization Response contains Pairing Success indication, UAV ID, UAV-C ID, UAS ID, Session Security Information, 3GPP UAV ID, and UAV-C IP address.
12. The UFES sends the received Pairing Authorization Response to the SMF+PGW-C.
13. The SMF+PGW-C locally stores the information received in the Pairing Authorization Response as part of pairing authorization status information. Further performs N4 session set up for the authorized pair of UAV and UAV-C.
14. The SMF+PGW-C sends Create Session Response to the MME via S-GW, with the received Pairing Authorization Response Information which includes Success Indication, UAV ID, UAV-C ID, UAS ID, and Session Security Information.
15. The MME optionally stores the UAV ID and UAV-C ID along with the pairing authorization status and UAS ID.
16. The MME sends a PDN Connection Accept message to the UAV over the NAS and the PDN Connection Accept message includes the received Authorization Response Information which includes Success Indication, UAV ID, UAV-C ID, UAS ID, and Session Security Information.
The UAV and UAV-C can use the received session security information to set up a secure connection between UAV and UAV-C for the C2 connection.
The UAV and UAV-C pairing revocation can be applicable to EPS as described below.
The USS/UTM when it determines to revoke UAV/UAV-C pairing (also known as C2 pairing or C2 association), the USS/UTM sends a Pairing Revocation Notification to the UFES with the 3GPP UAV ID (i.e., an external identifier), CAA Level UAV ID and UAV-C ID. The UFES sends the received Pairing Revocation Notification message to the SMF+PGW-C and a PDN connection disconnection and bearer deactivation can be initiated based on TR 23.754 [3] and TS 23.401 accordingly. The Delete Session/bearer Request can be sent by SMF+PGW-C to MME via S-GW with a suitable cause value and a pairing revocation information containing CAA level UAV ID and UAV-C ID based on the received pairing revocation notification. During bearer deactivation, the MME can send to the UAV, a suitable cause value and a pairing revocation information containing CAA level UAV ID and UAV-C ID. The UAV on receiving the pairing revocation information will delete the locally stored pairing authorization information and security information for the UAV and UAV-C pairing and releases all resources corresponding to the PDN connection. The UAV sends in response, a pairing revocation acknowledgement and CAA level UAV ID to the MME. The MME sends a PDN connection Release Acknowledgement (example., in a delete bearer response) to SMF+PGW-C via SGW with the external ID, Pairing Revocation Ack indication and CAA Level UAV ID. The SMF+PGW-C on receiving the Pairing Revocation Ack indication deletes locally stored pairing information (such as pairing authorization information and paired UAV and UAV-C IDs). Further, the SMF+PGW-C sends a Pairing Revocation Acknowledgement to the UFES with the received 3GPP UAV ID, Success Indication, and CAA Level UAV ID. The UFES forwards the received Pairing Revocation Acknowledgement to the USS/UTM with the received Success Indication, 3GPP UAV ID and CAA Level UAV ID. In case of UAV change, an authorization indication, new authorization data with cause as UAV change can be notified by the USS/UTM to the UFES. The PDN connection modification can be triggered by the SMF+PGW-C and the UAV can be notified with an authorization indication, new authorization data with cause as UAV change to allow the UAV to update the pairing authorization information during the PDN connection modification. The UAV updates the pairing information based on the received new authorization data and sends an acknowledgement back to MME. The MME forwards the received acknowledgement to SMF+PGW-C. The SMF+PGW-C can also update the locally stored pairing information if any (such as paired UAV and UAV-C information, authorization status based on new authorization data received) and updates session that are involved by the PDN connection Modification for the new authorized pair of UAV and new UAV-C2 (based on UAV and UAV-C information received from USS/UTM).",TR 33.854,6.15.2,all_images/image_338.jpeg,UAV and UAV-C pairing authorization revocation
"Figure 6.6.2-1: Authentication between the MBSTF and UE based AKMA
1)	UE generates the AKMA Anchor Key (KAKMA) and the A-KID from the KAUSF before initiating communication with an AKMA Application Function, i.e. MBSTF, as specified in TS 33.535 [5].
2)	The UE requests a PDU session establishment or modification to receive an MBS service. The procedure for UE	authorization is a part of UE join procedure and is described in TS 23.247 [x] clause 7.2.1.
3)	UE derive a key KMBS for authentication with the MBSTF .
4)	When UE try to join the multicast service, UE computes MAC-I and then UE sends a MBS service request to MBSTF. The service request include A-KID and MAC-I.
Note: 	How to derive the MAC-I is not addressed in the present document.
4-7) Upon receiving the request, the MBSTF discovers the AAnF, then AAnF generates KMBS and sends the KMBS to MBSF/MSF-C. The AAnF discovery and selection is specified in the TS 33.535[5] clause 6.7. The MBSTF computes the MAC-I using KMBS, and check if it is the same with the received MAC-I from UE. If so, it means that the UE is authenticated and authorized to use the service.
8) The MBSTF verifies the MAC-I using the KMBS, when the verification is succeed, and if the UE is authorized to perform the operation, then the MBSTF sends a service response to the UE.",TR 33.850,6.6.2,all_images/image_343.jpeg,Authentication between the MBSTF and UE based AKMA
"The communication optimized approach 1 is useful to decrease the communication overhead to roughly 2 SQRT(N) compared with the default approach. This approach is efficient and resilient since the update of the group key due to a device leaving the group only requires L – 1 + M messages instead of N that would be required when only point-to-point messages are involved. For instance, if N=64, M=8, L=8, then the key update only requires L-1=7 point-to-point messages for the update of the transport key associated to the set of the device that is leaving and the multicast distribution of the MGKM1 for the group key update. This MGKM1 message transports the group key protected with M different transport keys. The total number of messages is minimized when L=M=SQRT(N). Another choice might be M=1 so that there is a single transport key or M=N so that there are N transport keys.
The communication optimized approach 2 builds on communication optimized approach 1 and improves it by reducing the overhead of the multicast message used to update of the group key when the group key needs to be updated due to too long usage. This is so since the update of the group key needs to be protected with the MSK (i.e., EMSK(GK)) and sent a single time through the multicast channel instead of requiring MGKM1 that including M protected values of the group key. In practice, the communication optimized approach 2 provides limited benefits compared with communication optimized approach 1 when the GK is used to protect a reasonable amount of data, e.g., in the order of 2^24 calls to the underlying encryption algorithm (i.e., encrypt 2^28 bytes of data if a 128 bit encryption algorithm is used) as shown in Figure 6.9.2.1-2.
The following table provides a comparison in the number of messages required to update a transport key (TK) and the group key (GK) depending on the key update method (default or optimized ones) and configuration (number of transport keys and MSKs).
The trade-offs between default and optimized approaches can also be compared from a computational view. To this end, it is assumed that 256 users in the same area, e.g., at a concert, are willing to receive the MBS traffic. It is assumed M= 16 independent groups, each group with a different group key. For instance, 16 groups in a RAN, each group with L= 16 devices. In this case, if a device leaves the MBS session, only the group key in the affected multicast group needs to be updated. The overhead of updating the group key is now as low as in the communication optimized approach; however, this approach requires encrypting/protecting the MBS bulk traffic with M = 16 different group keys, one per group. Thus, the computational overhead is a factor M worse. Note that this configuration also involves transmitting the same MBS content M times in parallel.
Since M transport keys are used, an attacker that compromises a UE can only try to update the group key of up to L-1 devices. This limits the impact of such an attack, in particular, compared with a situation in which a single transport key is used to protect the update of the group key where N-1 would be affected.
Furthermore, the hash of the group key is included so that devices in other sets – that potentially might also receive this fake group key update -- can check the consistency by means of H, detect the group key update attack, and inform the RAN.
Although the overhead of the key update solutions depends on the configuration and MBS parameters, the following figures provide an indication of the performance trade-offs of the different key update approaches. The following assumptions are used:
1) 	an MBS group of 10.000 UEs;
2)	 a maximum number of MBS group membership changes between of 1 and 240 UEs;
3) 	a data rate of 384 kbps;
4)	 a transmission time of 24 hours, and
5)	 the trigger of an update of the GK when the GK has been used to protect between 2^20 and 2^32 bytes.
Figure 6.9.2.1-1: Number of point-to-point interactions required for group key update due to an MBS group membership change.
Both figures show the same data in linear and logarithmic scales, respectively. In red, Solution 9 in its ""default approach"". In purple, Solution 9 in its ""communication optimized approach 1"" with a single transport key. In blue, Solution 9 in its ""communication optimized approach 1"" with multiple transport keys. The performance of Solution 9 in its ""communication optimized approach 2"" is as in the blue line as well. The offset between the red and purple lines is due to the fact that the GK also needs to be updated due to long usage. Here it is assumed that a group key is used to protect by to 2^24 bytes. In the default approach, this key update needs to be done with unicast messages while in the optimized approaches this can be done through the multicast channel. The offset between the purple and blue lines equals 2 = log10(SQRT(10000)).
Figure 6.9.2.1-2: Total overhead of the group key update approaches
The figure shows the total overhead of the group key update approaches as a function of the MBS group membership changes and the maximum amount of data that can be protected with an MBS key before group key update. The total overhead is obtained by adding the number of protected keys that need to be sent altogether through unicast and multicast messages. In green, Solution 9 in its ""communication optimized approach 2"" with multiple transport keys; in blue, Solution 9 in its ""communication optimized approach 1"" with multiple transport keys; in purple, Solution 9 in its ""communication optimized approach ""1 with a single transport key; in red, ""default approach"" in Solution 9. The green line (communication optimized approach 2) shows the best performance in all cases. The performance of the blue line improves compared with the performance of the purple line when the number of MBS membership changes increases. For very few MBS member changes, the blue line outperforms the purple line when the group key is used to protect more than ~2^22 Bytes = 4 Mbytes. The performance of Solution #12 is equivalent to that of the purple line. The performance of Solution #11 is comparable to that in the red line. A difference of 1.5 - 2 in logarithmic scale (between two approaches) corresponds to a difference in overhead of a factor 35 – 100 in linear scale.",TR 33.850,6.9.2.1,all_images/image_344.jpeg,Number of point-to-point interactions required for group key update due to an MBS
"The communication optimized approach 1 is useful to decrease the communication overhead to roughly 2 SQRT(N) compared with the default approach. This approach is efficient and resilient since the update of the group key due to a device leaving the group only requires L – 1 + M messages instead of N that would be required when only point-to-point messages are involved. For instance, if N=64, M=8, L=8, then the key update only requires L-1=7 point-to-point messages for the update of the transport key associated to the set of the device that is leaving and the multicast distribution of the MGKM1 for the group key update. This MGKM1 message transports the group key protected with M different transport keys. The total number of messages is minimized when L=M=SQRT(N). Another choice might be M=1 so that there is a single transport key or M=N so that there are N transport keys.
The communication optimized approach 2 builds on communication optimized approach 1 and improves it by reducing the overhead of the multicast message used to update of the group key when the group key needs to be updated due to too long usage. This is so since the update of the group key needs to be protected with the MSK (i.e., EMSK(GK)) and sent a single time through the multicast channel instead of requiring MGKM1 that including M protected values of the group key. In practice, the communication optimized approach 2 provides limited benefits compared with communication optimized approach 1 when the GK is used to protect a reasonable amount of data, e.g., in the order of 2^24 calls to the underlying encryption algorithm (i.e., encrypt 2^28 bytes of data if a 128 bit encryption algorithm is used) as shown in Figure 6.9.2.1-2.
The following table provides a comparison in the number of messages required to update a transport key (TK) and the group key (GK) depending on the key update method (default or optimized ones) and configuration (number of transport keys and MSKs).
The trade-offs between default and optimized approaches can also be compared from a computational view. To this end, it is assumed that 256 users in the same area, e.g., at a concert, are willing to receive the MBS traffic. It is assumed M= 16 independent groups, each group with a different group key. For instance, 16 groups in a RAN, each group with L= 16 devices. In this case, if a device leaves the MBS session, only the group key in the affected multicast group needs to be updated. The overhead of updating the group key is now as low as in the communication optimized approach; however, this approach requires encrypting/protecting the MBS bulk traffic with M = 16 different group keys, one per group. Thus, the computational overhead is a factor M worse. Note that this configuration also involves transmitting the same MBS content M times in parallel.
Since M transport keys are used, an attacker that compromises a UE can only try to update the group key of up to L-1 devices. This limits the impact of such an attack, in particular, compared with a situation in which a single transport key is used to protect the update of the group key where N-1 would be affected.
Furthermore, the hash of the group key is included so that devices in other sets – that potentially might also receive this fake group key update -- can check the consistency by means of H, detect the group key update attack, and inform the RAN.
Although the overhead of the key update solutions depends on the configuration and MBS parameters, the following figures provide an indication of the performance trade-offs of the different key update approaches. The following assumptions are used:
1) 	an MBS group of 10.000 UEs;
2)	 a maximum number of MBS group membership changes between of 1 and 240 UEs;
3) 	a data rate of 384 kbps;
4)	 a transmission time of 24 hours, and
5)	 the trigger of an update of the GK when the GK has been used to protect between 2^20 and 2^32 bytes.
Figure 6.9.2.1-1: Number of point-to-point interactions required for group key update due to an MBS group membership change.
Both figures show the same data in linear and logarithmic scales, respectively. In red, Solution 9 in its ""default approach"". In purple, Solution 9 in its ""communication optimized approach 1"" with a single transport key. In blue, Solution 9 in its ""communication optimized approach 1"" with multiple transport keys. The performance of Solution 9 in its ""communication optimized approach 2"" is as in the blue line as well. The offset between the red and purple lines is due to the fact that the GK also needs to be updated due to long usage. Here it is assumed that a group key is used to protect by to 2^24 bytes. In the default approach, this key update needs to be done with unicast messages while in the optimized approaches this can be done through the multicast channel. The offset between the purple and blue lines equals 2 = log10(SQRT(10000)).
Figure 6.9.2.1-2: Total overhead of the group key update approaches
The figure shows the total overhead of the group key update approaches as a function of the MBS group membership changes and the maximum amount of data that can be protected with an MBS key before group key update. The total overhead is obtained by adding the number of protected keys that need to be sent altogether through unicast and multicast messages. In green, Solution 9 in its ""communication optimized approach 2"" with multiple transport keys; in blue, Solution 9 in its ""communication optimized approach 1"" with multiple transport keys; in purple, Solution 9 in its ""communication optimized approach ""1 with a single transport key; in red, ""default approach"" in Solution 9. The green line (communication optimized approach 2) shows the best performance in all cases. The performance of the blue line improves compared with the performance of the purple line when the number of MBS membership changes increases. For very few MBS member changes, the blue line outperforms the purple line when the group key is used to protect more than ~2^22 Bytes = 4 Mbytes. The performance of Solution #12 is equivalent to that of the purple line. The performance of Solution #11 is comparable to that in the red line. A difference of 1.5 - 2 in logarithmic scale (between two approaches) corresponds to a difference in overhead of a factor 35 – 100 in linear scale.",TR 33.850,6.9.2.1,all_images/image_346.jpeg,Total overhead of the group key update approaches 
"This solution addresses Key issue #3 to manage, distribute, and update the keys required to protect the MBS traffic in the context of transport layer solution #1.
This solution can be applied to service layer solutions, e.g., Solution #2 uses it.
This solution describes a default and two communication optimized approaches.
The communication optimized approaches allow updating the group key used to protect the MBS traffic in a group with N devices with around root square of N (SQRT(N)) unicast messages in contrast with the default approach that requires N unicast messages. This means that for the same key update signalling overhead, the communication optimized approach allows supporting MBS groups a quadratic factor larger compared with the default approach without increasing the computational or communication overhead to protect/transmit the MBS traffic.
The choice M~L~SQRT(N) minimizes the total message size required to distribute a new group key and the total number of required encryptions to update the group key. This is because L-1 unicast messages need to be sent to L-1 UEs and the MGKM message includes M = N/L (rounded upwards) protected group keys. Thus, the total overhead in terms of protected group keys is L-1+N/L. This is minimized when L~SQRT(N).
Using M>1 transport keys and including the hash of the group key makes the communication optimized solutions more resilient.
The communication overhead of the default approach is similar to the communication overhead of the rest of solutions of KI#3 in the present document in terms of the number of unicast messages required to distribute/update a group key.
Compared with communication optimized approach 1, the communication optimized approach 2 reduces the overhead in the multicast channel since the update of the group key due to too long usage only requires the transmission of a single protected group key value.
Overall, the communication optimized approaches with multiple transport keys offer the best performance even for very few MBS membership changes if a group key is used to protect at least 2^22 bytes of data before group key update. A symmetric key can be used to protect much more than 2^22 bytes in a secure way. For instance, in TS 33.501 [6] for the update of KgNB and other keys and triggered when the PDCP COUNTs are about to be re-used. PDCP COUNTs are 32 bit values according to TS 38.323 [10].
Performing the key update when a single UE has joined/left/been removed minimizes the security risk. The communication optimized approaches allow performing this key update at the cost of M-1 unicast messages while the default approach or the communication optimized approach with a single transport key require N-1 unicast messages. In contrast, if the key update procedure is only triggered when at least a minimum number C>1 of UEs have joined/left/been removed, the security risk increases because potentially several malicious devices still have access to the MBS keys. Note that for a given C and a group of size N divided into M subsets, the expected number of devices that require update equals L*M*(1 – binomial(N-M, C)/binomial(N,C)). This is shown in Figure 6.9.3-1 for N= 400 (blue), 1600 (red), 3600 (green), 6400 (black), and 10000 (purple). It is possible to observe that for C = 1 the number of devices that need to be updated equals SQRT(N)-1 and when C increases, the number of devices increases.
Figure 6.9.3-1: The communication optimized approaches with multiple transport keys
This figure shows the number of devices requiring key update as a function of C. C is the minimum number of UEs that have to leave/join/be compromised before the key update procedure is triggered. The default approach and the communication approach 1 with a single transport key require always N-1 unicast messages for any value of C.
Overall, the communication optimized approach 2 as applied to Solution#1 or Solution#11 (clause 6.9.2.3) offers the best performance independently of how often the group key is updated.
In the comparison an MBS application is used requiring the highest data rate in TS 22.261/TS 22.246. The performance of the different solutions is compared based on the required number of key updates due to (i) MBS group membership changes or (ii) key update because of a long usage of the group key. It is further assumed that the group key is updated as soon as key update condition is triggered.
Note 1: 	The key update scenarios used for comparative evaluations require justification.
NOTE 2: 	Further evaluation is not addressed in the present document.",TR 33.850,6.9.3,all_images/image_350.jpeg,The communication optimized approaches with multiple transport keys 
"Step 1: UE registers in the PLMN (see clause 4.2.2.2 of TS 23.502 [11]) and request the establishment of a PDU session (see clause 4.3.2.2 of TS 23.502 [11]). The UE also indicates its capability to receive multicast data over the radio. The AMF obtains information from the UDM whether the UE can join multicast sessions as part of the SMF Selection Subscription data. If so, for direct discovery, the AMF selects an SMF capable of handling multicast sessions based on locally configured data or a corresponding SMF capability stored in the NRF and also indicates the UE's capability to receive multicast data over the radio to the SMF.
Step 2: The content provider announces the availability of multicast using higher layers (e.g., application layer). The announcement includes at least the multicast address of a multicast group that UE can join.
Step 3: To join the multicast group session, steps 4 to 9 as described in TR 23.757 [2] are followed.
Figure 6.10.2.2-1: MBS Procedure for key generation and traffic protection
Step 4: SMF requests AMF to transfer a message to RAN node using Namf_N1N2Message Transfer service with multicast information along with multicast group token, TMGI, Rekeying token list, Rekying token id etc. Rekeying token list contains many pre-generated re-keying token and corresponding ids needed for this particular multicast group management.
NOTE 1: 	As an option, rekeying token id and rekeying token list sent during initial configuration from SMF to RAN, can be simplified by reducing the list to single key. This will avoid key management at RAN.
Step 5: N2 session request is sent to RAN with multicast related information received from SMF.
Step 6: Rekeying token list is stored in RAN for future purposes (in case of re-keying).
Step 7: RAN generates multicast key hierarchy (both encryption key and integrity key) needed for the traffic as shown in Figure 6.10.2.1-1.
Step 8: RAN shares in an integrity protected and encrypted RRC message, the multicast group token and MBS session ID TMGI to the respective UE. The multicast group token which plays the role of a group primary key should of sufficient length for e.g.128bits.
Step 9: UE which joins the session will generate the MBS related keys (both encryption KMTenc and integrity keys KMTint).
Step 10: UPF(MB-UPF) receives multicast PDUs, either directly from the content provider or via the MBSF-U that can manipulate the data.
Step 10a: UPF(MB-UPF) sends multicast PDUs in the N3/N9 tunnel associated to the multicast distribution session to the RAN. There is only one tunnel per multicast distribution session and RAN node, i.e., all associated PDU sessions share this tunnel.
Step 10b: RAN performs the encryption of traffic using encryption key KMTenc and integrity protection by KMTint. RAN selects PTM or PTP radio bearers to deliver the multicast PDUs to UEs that joined the multicast group.
Step 11a: RAN performs the transmission using selected bearer.
Step 11b: Receiving multicast UEs which are part of this MBS session (matching the MBS group ID) will decrypt the traffic using encryption keys and also verifies the integrity check of the packets received.
Figure 6.10.2.2-1 shows the MBS procedure for key generation and traffic protection
NOTE 2: 	Security policies for PTM and PTP needs to be the same. RAN may decide to switch between PTM and PTP for a UE, if the security policies for PTM and PTP is not the same (e.g. PTM is protected but PTP is not protected), then security may be breached.",TR 33.850,6.10.2.2,all_images/image_351.png,MBS Procedure for key generation and traffic protection
"In order to receive an MBS service, the UE establishes a secure connection with the MBS service function and obtains security materials.
Figure 6.12.2-1: Message flows for MBS key delivery and MBS traffic protection
0. The UE is registered to 5GS.
1. The UE requests a PDU session establishment or modification to receive an MBS service.
2. The UE establishes a secure connection with MBSTF based on GBA similar to MBMS [3] or AKMA [5]. In both scenarios, MBSTF is considered an AF and UE and MBSF-U communicate using Ua/Ua* protocol. Both the UE and MBSTF derive Multicast User Key (MUK) from the AF key (e.g., Ks_(int/ext)_NAF for GBA or KAF for AKMA). Over the secure connection, the UE and MBSTF performs authentication and key derivation as specified in TS 33.246 [3].
NOTE 1: 	The key management function is located in the MBSTF as in BM-SC [3].
3. The UE receives the Multicast Service Key (MSK) from the MBSF-U. The MSK is protected using the MUK and delivered using a unicast message over the secure connection.
4. The UE receives the Multicast Traffic Key (MTK) protected using MSK from the MBSTF. The MTK can be delivered either a unicast or a multicast message. The MTK is used as a root key to derive application/protocol specific keys to protect (e.g., encrypt or integrity protect) MBS service traffic.
5. Using the MTK received in step 4, the UE derives application/protocol specific keys and decrypts or verifies the MBS traffic.
The key hierarchy, rekeying and key usage for MBS traffic protection is illustrated in Figure 6.12.2-2 and Figure 6.12.2-3. The MUK derived either based on GBA or AKMA is used to protect MSKs, and each MSK is used to protect MTKs. MBSF-U decides to trigger the MSK/MTK update procedure based on the changes of authorization info or the key lifetime. MSK rekeying is done over unicast to each UE joined to the MBS PDU session, and MTK rekeying is done over unicast or multicast to UEs joined to the MBS session.
NOTE 2: 	When GBA is used, MUK derivation follows as specified in TS 33.220[8]. When AKMA is used, MUK is set to KAF based on AKMA key derivation.
Note 3: 	More details on the use of AKMA for MUK rekeying are not addressed in the present document.
Note 4: 	When AKMA is used, how MBSTF obtains the authorization information is not addressed in the present document.
Figure 6.12.2-2: Usage of MSK for a single session or a channel
Figure 6.12.2-3: Usage of MSK for multiple sessions or channels",TR 33.850,6.12.2,all_images/image_352.png,Message flows for MBS key delivery and MBS traffic protection
"In order to receive an MBS service, the UE establishes a secure connection with the MBS service function and obtains security materials.
Figure 6.12.2-1: Message flows for MBS key delivery and MBS traffic protection
0. The UE is registered to 5GS.
1. The UE requests a PDU session establishment or modification to receive an MBS service.
2. The UE establishes a secure connection with MBSTF based on GBA similar to MBMS [3] or AKMA [5]. In both scenarios, MBSTF is considered an AF and UE and MBSF-U communicate using Ua/Ua* protocol. Both the UE and MBSTF derive Multicast User Key (MUK) from the AF key (e.g., Ks_(int/ext)_NAF for GBA or KAF for AKMA). Over the secure connection, the UE and MBSTF performs authentication and key derivation as specified in TS 33.246 [3].
NOTE 1: 	The key management function is located in the MBSTF as in BM-SC [3].
3. The UE receives the Multicast Service Key (MSK) from the MBSF-U. The MSK is protected using the MUK and delivered using a unicast message over the secure connection.
4. The UE receives the Multicast Traffic Key (MTK) protected using MSK from the MBSTF. The MTK can be delivered either a unicast or a multicast message. The MTK is used as a root key to derive application/protocol specific keys to protect (e.g., encrypt or integrity protect) MBS service traffic.
5. Using the MTK received in step 4, the UE derives application/protocol specific keys and decrypts or verifies the MBS traffic.
The key hierarchy, rekeying and key usage for MBS traffic protection is illustrated in Figure 6.12.2-2 and Figure 6.12.2-3. The MUK derived either based on GBA or AKMA is used to protect MSKs, and each MSK is used to protect MTKs. MBSF-U decides to trigger the MSK/MTK update procedure based on the changes of authorization info or the key lifetime. MSK rekeying is done over unicast to each UE joined to the MBS PDU session, and MTK rekeying is done over unicast or multicast to UEs joined to the MBS session.
NOTE 2: 	When GBA is used, MUK derivation follows as specified in TS 33.220[8]. When AKMA is used, MUK is set to KAF based on AKMA key derivation.
Note 3: 	More details on the use of AKMA for MUK rekeying are not addressed in the present document.
Note 4: 	When AKMA is used, how MBSTF obtains the authorization information is not addressed in the present document.
Figure 6.12.2-2: Usage of MSK for a single session or a channel
Figure 6.12.2-3: Usage of MSK for multiple sessions or channels",TR 33.850,6.12.2,all_images/image_353.jpeg,Usage of MSK for a single session or a channel
"Figure 6.14.2-1: The procedure of key delivery of KMBS
The procedure is described as follows:
Step 0a: UE initiates the Primary Authentication and establishes the KAUSF with AUSF in HPLMN.
Step 0b: Service announcement procedure, following the current Clause 7.1.1 in TS 23.247 [9].
Step 1. MB-SMF generates KMBS and KID for the specific MB service.
Step 2. To join the multicast group, the UE sends the PDU Session Modification Request (MBS Session ID). MBS Session ID indicates the multicast group that UE wants to join.
Step 3.0. AMF sends MBS Key Request to AUSF to ask for the encryption key.
Step 3.1. AUSF generates a KMBS-UE using KAUSF and TMGI.
Note 1: It is not addressed in the present document how AUSF knows TMGI.
Step 3.2. UE generates a KMBS-UE and using KAUSF and TMGI.
Step 3.3. AUSF send the KMBS-UE to AMF.
Step 4. By using Nsmf_MBSSession_Create request (MBS Session ID), SMF interacts with MB SMF to retrieve multicast QoS flow information of the indicated MBS session.
Step 5. MB-SMF sends the KMBS and KID to SMF using Nsmf_MBSSession_Create response.
Step 6. SMF responds to AMF through Nsmf_PDUSession_UpdateSMContext response(N2 SM information (PDU Session ID, MBS Session ID, MB-SMF ID, multicast QoS flow information, updated PDU Session information, mapping between unicast QoS flow and multicast QoS flow information), N1 SM container (PDU Session Modification Command, KMBS and KID)
Step 7. AMF send the PDU session modification command (EKMBS-UE(KMBS)) to UE, including the encrypted KMBS and KID.
Step 8. UE decrypt the EKMBS-UE(KMBS) and gets the KMBS
KMBS is used for the future protection of the MBS traffic.
Note 2: 	It is not addressed whether the KMBS will be used as the root key or the session key.
NOTE 3: 	The UE leaving group procedure will be handled separately.
Note 4: 	Whether other keys (e.g. Kamf) can be used is not addressed here.
Note 5: 	What algorithms should be used is not addressed here.",TR 33.850,6.14.2,all_images/image_354.jpeg,The procedure of key delivery of KMBS
"The network configures a special DNN for exchange of secure user plane signalling messages. The UE initiates an PDU session establishment procedure to establish a separate PDU session exclusively for the user plane signalling messages and the network enables integrity protection for the PDU session. The user plane signalling messages means, for example DNS message exchanges over the UP, which requires integrity protection. Even though, the integrity protection of a PDU session is not activated due to UE capability limitations or serving network policy for a PDU session, protection of sensitive protocol message (for example, DNS exchanges) can be achieved using the dedicated PDU sessions which serves low data rate signalling exchanges, as shown in Figure 6.1.3-1.
The UE identifies/decides to send particular IP packet (UP signalling messages) over the established PDU session, based on at least one of the following	Traffic Filtering information:
-	application layer protocol (for example: DNS).
-	Transport layer port numbers.
-	Destination IP address and/or source IP address.
Figure 6.1.3-1: Dedicated PDU for UP Signalling message IP",TR 33.853,6.1.3,all_images/image_355.jpeg,Dedicated PDU for UP Signalling message IP
"Existing attacks on UP-IP require a man-in-the-middle (MitM) relay that is located between UE and eNB. The MitM relay receives packets from the UE/eNB, modifies them, and forwards them towards eNB/UE. Thus, techniques that defeat MitM relay attacks defeat also attacks on UP-IP. The ""Zero-overhead user plane integrity protection on the link layer"" solution does this -- it defeats MitM relay attacks -- by replacing the CRC associated to each transport block in L2 by a cryptographic CRC denoted CRC' and linked to the transport block identity itself. By doing this, an attacker cannot receive a packet, process and modify it, and forward it in a later transport block since this changes the transport block identity used, and thus, the verification of the cryptographic CRC fails.
This solution addresses the key issue #3: ""UE support of UP IP at the full uplink data rate"" and key issue #5: ""Optionality of integrity protection in UP DRB"".
Key issue #3 is addressed since it provides protection against attacks on UP IP even at full uplink data rate. Key issue #5 is addressed since this protection is applied to all UP DRBs.
The proposal is to use a cryptographic CRC instead of the regular CRC in Transport Blocks on the user plane.
This solution reduces the overhead of integrity protection to ZERO.
The effective user data throughput remains the same as without the integrity protection.
The error behaviour of the Link layer remains exactly the same as without the proposed integrity protection.
This solution requires the addition of the computation of a MAC over or the encryption of 128 bits per CRC in a Transport Block so per 6.144 bits, which is a reduction of about a factor 50 in the amount of computations required for the UP IP of a PDCP packet. It can therefore be used at full uplink data rates and is a solution to key issue 3.
With this solution, all Transport Blocks independent of the data rate can be integrity protected, so automatically, all PDCP packets become integrity protected and the integrity protection does not have to be a serving network operator-dependent policy anymore, which solves the UP IP optionality KI#5.
Some background
-	A Transport Block is defined as the basic data unit exchanged between L1 and . An equivalent term for Transport Block is "" PDU"".
-	Each Transport Block has a CRC over the total TB. Most TBs, including User Data TBs, have a 24-bit CRC.
-	Transport Blocks are subdivided in Code Blocks if larger than 6144 bit. Each CB has its own 24-bit CRC.
-	A Resource Block pair is the unit for the scheduling of resources by the base station.
-	One Resource Block consists of 12 successive OFDM sub-carriers in frequency and one slot of 0.5 millisecond in time
72 or 84 OFDM symbols per RB of 1 to 10-bit each.
-	A Resource Block pair consists of the two successive RBs in the two successive slots of a subframe of 1 millisecond.
-	If a Transport Block is larger than a Resource Block pair, more RB pairs are added in the frequency direction.
Each TB is limited to a subframe of 1 millisecond.
-	TBs with an incorrect CRC are discarded by the receiver and a retransmission is requested (Hybrid Automatic Repeat-Request (HARQ)).
-	An LTE frame consists of 10 subframes.
Figure 6.4.1-1: LTE packet structure relating PDCP packets to Transport Blocks",TR 33.853,6.4.1,all_images/image_356.png,LTE packet structure relating PDCP packets to Transport Blocks
"5G NR PDCP PDUs is formatted as mentioned in TS 38.323 [a] clause 6.2.2. Hence, each PDCP data PDU will be composed of PDCP SN, data payload and an optional 4B MAC-i payload. As per spec, data unit that is ciphered is the data part of the PDCP Data PDU except the SDAP header if included in the PDCP SDU, and the MAC-I.
Figure 6.9.3-1: PDCP data PDU format (refer to TS38.331)
In a new implementation, it is possible to add padding bytes to data part(The data part includes the IP header and will be encrypted). These padding bytes and the Padding Size LI can be part of the cipher payload. One example of such an implementation is as follows:
-	One of the ""R"" bits in the PDCP header can be used to indicate if Padding is included.
-	One of the ""R"" bits in the PDCP header can be used to indicate the whole length of the PDU.
-	Padding Size is added at the octet ""N-4"". It can range from 0 - 255 octets. The first half is used to indicate how many bits is added before the data part, and the second half is used to indicate how many bits is added after the data part.
-	Non-Zero Initialized Padding Bytes (based on Padding Size) are added after the data part of the PDCP PDU.
-	Transmit PDCP entity can determine ""randomly"" a value from 0 - 255 bytes of padding.
In some implementations, padding size could be limited to a maximum of ""x"" % of the original PDCP PDU to avoid wasting bandwidth. Padding could be configured by the network in RRC Signalling.
Figure 6.9.3-2: New PDCP data PDU format
With this mechanism, the attacker could not know where to put the offset since all the data part is encrypted and the destination address is not in the first few bits anymore. However, the attack could still try [the length of the padding] times to verify where exactly the true data part. So the solution could be enhanced with adding the limitation of validation times. Thus even if the attacker does not corrupt the padding, they'll just end up corrupting the SDU itself unless they guess exactly the right offset.",TR 33.853,6.9.3,all_images/image_357.jpeg,PDCP data PDU format (refer to TS38.331)
"Introducing user plane integrity protection (UP IP) to EPS means that there will be a need to deal with legacy (CN and RAN) nodes that do not support UP IP and upgraded nodes that do support UP IP. As described in Key Issue #7, there is a need to ensure that a legacy RAN node does not configure a bearer that requires UP IP as it cannot support UP IP. While the key issue focuses on interworking, it is similarly true during mobility in EPS.
This solution provides a method of ensuring that the bearer that requires UP IP is not handed over from a ng-RAN node to an eNB that does not support UP IP. The solution works by the target eNB providing an indication that it supports UP IP as part of its response to a request for a handover initiated by an ng-RAN node connected to 5GS. If the source ng-RAN node gets no indication that the target eNB supports UP IP, then the source ng-RAN node does not proceed with a handover procedure for the UE that has bearers that require UP IP.
Whether the UP IP support indication is signalled in the target to source transparent container or on a hop by hop basis will depend on the rest of the solution, e.g. it could be necessary to know that the intervening nodes on the handover signalling path support UP IP in EPS but this can be already be known due to other aspects of a chosen solution.
NOTE:	In 5GS, this solution is not needed because all NG-RAN nodes connected to 5GC (including the ones that do not support UP IP) are aware of the UP IP policy and ensure that bearers that require UP IP are not used without UP IP. As not all eNBs will be aware of UP IP functionality, target eNB connected to EPC may establish bearers that require UP IP (or accept Handover request that contains bearers requiring UP IP) even if it does not support UP IP. This means some solution beyond what is done in 5G is needed.
Figure 6.18.3-1 provides the flows for the solution.
Figure 6.18.3-1: Restricting handovers to RAN nodes that don't support UP IP
The steps proceed as follows:
0. UE is connected to an ng-RAN node
1. ng-RAN node decides a handover to an eNB is needed
2. ng-RAN node initiates the handover preparation (via AMF and MME) to the eNB
3. eNB responds to handover preparation (via MME and AMF) and if it supports UP IP the eNB includes an indication of its support for UP IP. The indication can be carried hop by hop or end to end manner.
NOTE:	This solution does not address how the target RAN node decides UP IP. Instead, this solution addresses the issue of the 5GS to EPS handover with the target eNB that does not support UP IP so that the source NG-RAN node does not transfer bearers that require UP IP to such target eNB.
4. (4b) If no UP IP support indication is received by the ng-RAN node and the handover includes bearers that require UP IP, then the ng-RAN node cancels the handover in the AMF, target MME and target eNB as in clause 4.11.1.2.3 of TS 23.502. (4a) Otherwise it can continue with the handover.
A similar solution could also apply to S1 handovers in EPS (e.g. see clause 5.5.2.5.2 of TS 23.401 [b]).",TR 33.853,6.18.3,all_images/image_359.jpeg,Restricting handovers to RAN nodes that don't support UP IP
"The source eNB has received a UP IP policy from the MME per radio bearer established with the UE. The source eNB includes the UP IP activation status in the Source to Target Transparent Container to the target ng-eNB/gNB.
The target AMF/SMF ignores any UP IP policy received from the source MME.
The PGW-C+SMF provides a UP IP policy as described in TS 23.501 [12]. The SMF responds to the target AMF including a UP IP policy per PDU session to be handovered to 5GS which the AMF forwards to the target ng-eNB/gNB.
A target ng-eNB/gNB which supports UP IP is able to activate UP IP according to the received UP IP policy and the ""UE capability indicating UP IP support over eUTRA when connected to 5GC"" received from the source MME via target AMF.
NOTE:	If the UP IP indication reuses 1 bit of EPS security capability, the protection of UE EPS security capability in interworking from EPS to 5GS can be reused for protection of indication of UE support UP IP in E-UTRA.
Figure 6.21.3.1.1-1: Interworking handover from EPS to 5GS
Step 1: The source eNB includes the UP IP activation status in the Source to Target Transparent Container in Handover Required message to the source MME.
Step 2: The source MME forwards the Source to Target Transparent Container together with the ""UE capability indicating UP IP support over eUTRA when connected to 5GC"" to the target AMF.
Step 2b: The target AMF invokes the Nsmf_PDUSession_CreateSMContext Request service operation with the SMF. The target AMF/SMF ignores any UP IP policy received from the source MME. The SMF provides a UP IP policy per PDU session as described in TS 23.501 [12].
Step 2c: The SMF responds with the Nsmf_PDUSession_CreateSMContext Response to the target AMF including a UP IP policy per PDU session to be handovered to 5GS.
Step 3: The target AMF forwards the Source to Target Transparent Container together with the ""UE capability indicating UP IP support over eUTRA when connected to 5GC"" and the UP IP policy per radio bearer to the target ng-eNB/gNB.
Step 4: The target ng-eNB/gNB prepares the Target to Source Transparent Container to the source eNB. Confirmation of valid ""UE capability to support UP IP over E-UTRA when connected to 5GC"" and valid activation status included in the Source to Target Transparent container is made at the target ng-eNB/gNB when the core network includes the stored ""UE capability to support UP IP over E-UTRA when connected to 5GC"" and the UP IP policy via the target AMF to the target ng-eNB/gNB. If the target ng-eNB/gNB becomes aware that there is a mismatch between the ""UE capability to support UP IP over E-UTRA when connected to 5GC"" and the UP IP policy received from the source eNB in the Source to Target Transparent container and the ones stored and received from the core network, then the target ng-eNB/gNB takes the ""UE capability to support UP IP over E-UTRA when connected to 5GC"" and the UP IP activation status stored and received from the core network into use.
The target ng-eNB/gNB activates UP IP for the radio bearers to be handovered to the target ng-eNB/gNB. The target ng-eNB/gNB sends the Handover Request Acknowledgement message including the Target to Source Transparent Container to the target MME.
Step 5: The target AMF forwards the parameters received in Handover Request Acknowledge message to the source MME in the Forward Relocation Response message.
Step 6: The source MME forwards the parameters received in Forward Relocation Response message to the source eNB in the Handover Command message.
Step 7: The source eNB initiates Handover Command procedure with the UE.
Step 8: The UE confirms by sending a Handover Complete message to the target eNB.
Step 9: The target ng-eNB/gNB notifies the target AMF that the handover procedure is completed by sending a Handover Notify message.
Step 10. The UE initiates a Registration procedure with the target AMF including the ""UE capability indicating UP IP support over eUTRA when connected to 5GC"" in the Registration Request message.
Step 11: If the target AMF identifies a mismatch with the previously stored UE capability and becomes aware that the target ng-eNB/gNB doesn't know the ""UE capability indicating UP IP support over eUTRA when connected to 5GC"" after an interworking handover from EPS, the target AMF sends the ""UE capability indicating UP IP support over eUTRA when connected to 5GC"" to the target ng-eNB/gNB in the UE Context Modification Request message.
Step 12: If the target ng-eNB identifies a mismatch between the stored capabilities and the received capabilities then the target ng-eNB may activate UP IP for the DRB(s) established with the UE.
Step 13: The target ng-eNB/gNB responds to the target AMF by sending a UE Context Modification Response message when the RRC Reconfiguration procedure is completed.",TR 33.853,6.21.3.1.1,all_images/image_360.png,Interworking handover from EPS to 5GS
"The source ng-eNB/gNB has received a UP IP policy from the AMF per radio bearer established with the UE. The source ng-eNB/gNB includes the UP IP activation status in the Source to Target Transparent Container to the target eNB.
A target eNB which supports UP IP is able to activate UP IP according to the UP IP policy and the ""UE capability indicating UP IP support over eUTRA when connected to EPS"" received from the source AMF via the target MME.
NOTE:	If the UP IP indication reuses 1 bit of EPS security capability, the protection of UE EPS security capability in interworking handover from 5GS to EPS can be reused for protection of indication of UE support UP IP in E-UTRA.
Figure 6.24.3.1.1-1: Interworking handover from 5GS to EPS
Step 1: The source ng-eNB/gNB includes the UP IP activation status per radio bearer established with the UE, in the Source to Target Transparent Container in Handover Required message to the source AMF.
Step 2a: The source AMF sends Nsmf_PDUSession_ContextRequest to the SMF.
Step 2b: The SMF provides UP IP policy and responds with Nsmf_PDUSession_ContextResponse including the UP IP policy to the source AMF.
Step 2c: The source AMF forwards the Source to Target Transparent Container received from the source ng-eNB/gNB to the target MME. The source AMF includes also the ""UE capability indicating UP IP support over eUTRA when connected to EPS"" and forwards the UP IP policy per PDU session received from the SMF to the target MME.
Step 3: The target MME forwards the Source to Target Transparent Container together with the ""UE capability indicating UP IP support over eUTRA when connected to EPS"" and the UP IP policy per PDU session received from the SMF via source AMF to the target eNB.
Step 4: The target eNB sends the Handover Request Acknowledgement message to the target MME. The target eNB prepares the Target to Source Transparent Container to the source ng-eNB/gNB. Confirmation of valid ""UE capability to support UP IP over E-UTRA when connected to EPS"" and valid UP IP activation status included in the Source to Target Transparent container is made at the target eNB when the core network includes the stored ""UE capability to support UP IP over E-UTRA when connected to EPS"" and the UP IP policy via the target MME to the target eNB. If the target eNB becomes aware that there is a mismatch between the ""UE capability to support UP IP over E-UTRA when connected to EPS"" and the UP IP activation status received from the source ng-eNB/gNB in the Source to Target Transparent container and the ones received from the core network, then the target eNB takes the ""UE capability to support UP IP over E-UTRA when connected to EPS"" and the UP IP policy received from the core network into use.
The target eNB indicates UP IP to be activated for the radio bearers to be handovered to the target eNB.
Step 5: The target MME forwards the parameters received in Handover Request Acknowledge message to the source AMF in the Forward Relocation Response message.
Step 6: The source AMF forwards the parameters received in Forward Relocation Response message to the source ng-eNB/gNB in the Handover Command message.
Step 7: The source ng-eNB/gNB initiates Handover Command procedure with the UE.
Step 8: The UE confirms by sending a Handover Complete message to the target eNB.
Step 9: The target eNB notifies the target MME that the handover procedure is completed by sending a Handover Notify message.
Step 10. The UE initiates a Tracking Area Update procedure with the target MME including the ""UE capability indicating UP IP support over eUTRA when connected to EPS"" in the Tracking Area Update Request message to the target MME.
Step 11: If the target MME identifies a mismatch with the previously stored UE capability and the one received from the UE and becomes aware that the target eNB doesn't know the ""UE capability indicating UP IP support over eUTRA when connected to EPS"", the target MME sends the ""UE capability indicating UP IP support over eUTRA when connected to EPS"" in the Context Modification Request message.
Step 12: If the target eNB identifies a mismatch in the stored capability and the received one from target MME, then the target eNB may activate UP IP for the radio bearers established with the UE by initiating an RRC Reconfiguration procedure.
Step 13: The target eNB responds to the target MME by sending a UE Context Modification Response message.",TR 33.853,6.24.3.1.1,all_images/image_362.png,Interworking handover from 5GS to EPS
"In the proposed solution the PCF provisions the UE with necessary policies and parameters to use 5G ProSe services, as part of the UE ProSe Policy information as defined in TS 23.503 [17] clause 4.2.2. PCF provisions the authorization policy and parameters for 5G UE-to-Network Relay Discovery and Communication and the related discovery security materials are provisioned by 5GDDNMF.
Figure 6.1.2-1: Procedural call flow for key management in 5G ProSe
Step 1: The remote UE seeking access via UE-to-Network relay, REAR (Remote Access via Relay) sends a UE policy provisioning request to the AMF. The request may include the Remote UE capability i.e., ProSe UE capability, PC5 capability.
AMF sends Npcf_UEpolicycontrol_update request over Service based interface to discover the corresponding PCF and requests for the required ProSe authorization policy.
PCF sends back Npcf_UEpolicycontrol_update response with the required ProSe authorization policy. AMF delivers the ProSe related policies to the Remote UE.
The UE-to-Network relay gets authenticated and authorized by the network to support as a relay for ProSe communication.
Step 2: The Remote UE sends a key request message to the remote AMF, where the message includes the ProSe Remote access indication and 5G-GUTI if already assigned or the SUCI. This solution is based on single hop relay i.e., one UE-to-Network relay between Remote UE and the core network. The proposed solution also works for multiple hop relay communication.
The ProSe Remote access indication is set to 1, which indicates that there is only single hop UE-to-Network relay in between.
If SUCI is included in the Key request, the AMF may forward the Key request to the AUSF instance for primary authentication and AUSF may initiate primary authentication and perform required operations.
If 5G-GUTI is included and AMF succeed to verify UE and retrieve the UE context from 5G-GUTI, AMF may proceed to step 3. Otherwise, AMF may forward the Key request to the AUSF for primary authentication.
Step 3: In order to authorize the UE requesting for keys for remote access, the AMF retrieves the UE details or subscription data from UDM.
Step 4: The AMF forwards the Key request to the AUSF instance which is capable of authentication, authorization and key derivation for the ProSe UE-to-Network relay communication.
Step 5: The AUSF generates the REAR Key for Remote UE communication via UE-to-Network relay. The REAR key will be used for deriving the ProSe key KNR_ProSe.
Input to the Key Derivation Function for deriving the REAR key is as follows:
REAR Key = KDF (Latest KAUSF, SUPI of the Remote UE, Relay UE ID bound to SUPI of relay/TempID of relay, other possible parameters)
The generated key is 256 bits long out of which, the 128 bits MSB of the key is the REAR Key and the other 128 bits is the REAR Key ID. The purpose of the REAR Key ID is to identify the REAR key.
Note 1:	The input parameters to derive the keys are not addressed in the present document.
Step 6-9: AUSF sends the generated REAR key and Relay UE ID/TempID of Relay which is bound to UE-to-Network relays SUPI in the key response message to the Remote AMF. The remote AMF includes the REAR key in the security context of the remote UE. Step 10: Remote UE discovers the relay UE using any of Model A or Model B methods. The discovery message needs to include the relay UE ID provided by the AUSF.
Step 11: After the discovery of the UE-to-Network relay, the Remote UE sends the Direct communication request to the discovered relay for establishing a secure PC5 unicast link. The message should include Relay Service Code or ServiceID, 5G-GUTI of the Remote UE.
Step 12: On receiving the Direct Communication request, the UE-to-Network relay sends a key request message to the relay AMF along with the Relay Service Code or ServiceID, 5G-GUTI of the Remote UE received from the remote UE.
Step 13-16: Relay AMF authorizes the relay UE and retrieves the ProSe security context if the key request includes 5G-GUTI. The AMF authorizes the remote UE by checking with the UDM and acquires the REAR key through the security context. A restricted security context (only ProSe related security context) transfer is performed between remote AMF and relay AMF to avoid the reallocation of AMF.
Note 2:	Further details on restricted security context transfer are not addressed in the present document.
Step 17-18: If the security context retrieval fails, the relay AMF sends a reject message to the remote AMF with an indication to re-try the key request using SUCI. This request is forwarded to the remote UE.
Step 19-24: The Remote UE sends a direct communication request to the relay using the SUCI parameter. Relay UE sends the relay key request to the relay AMF sends, relay AMF authorizes the UE and forwards the key request to the AUSF. The AUSF retrieves the Authentication Vectors from the UDM and triggers primary authentication of remote UE.
Step 25-26: The REAR key is generated at the AUSF same as in step 5. The remote UE and relay AMF acquire the REAR key from the key response message received from AUSF. The relay AMF authorizes the remote UE by checking with the UDM.
Step 27-29: The Relay AMF now generates the KNR_ProSe key. The input to the KDF for generating the ProSe key is as follows:
KNR_ProSe = KDF (REAR key, 5G-GUTI, Relay Service Code or ServiceID, KNR_ProSe freshness parameter, other possible parameters). KNR_ProSe freshness parameter can be any nonce or counter or random number. KNR_ProSe is used as a root key. The Relay UE derives PC5 session key Krelay-sess from KNR-ProSe, and confidentiality and integrity keys from Krelay-sess, in a similar way as KNRP-sess is derived from KNRP, and confidentiality and integrity keys from KNRP-sess in TS 33.536 [8].
Step 30: The Relay AMF sends the KNR_ProSe and freshness parameter in the key response message to the UE-to-Network relay.
Step 31-32: The UE-to-Network relay stores the received KNR_ProSe and sends the freshness parameter to the Remote UE in the Direct Security Mode command message.
Step 33: The remote UE generates the ProSe key to be used for Remote access via Relay same as defined in step 29. Remote UE sends the Direct Security mode complete message to the UE-to-Network relay. Further communication between Remote UE and Network takes place securely via the UE-to-Network relay.
Note 3:	The privacy protection of Remote UE is not addressed in the present document when its 5G-GUTI is used in DCR.",TR 33.847,6.1.2,all_images/image_367.png,Procedural call flow for key management in 5G ProSe
"This solution does not address the discovery key generation and key delivery protocol used in the discovery procedure, which is up to the conclusion of key issue #2.
The security procedure for Model A restricted discovery is described as follows:
Steps 1-4 refer to an Announcing UE.
1)	Announcing UE sends a Discovery Request message containing the RPAUID to the DDNMF in its HPLMN in order to get the ProSe Code to announce and to get the associated security material.
2)	The DDNMF may check for the announced authorization with the ProSe Application Server.
3)	If the Announcing UE is roaming, the DDNMFs in the HPLMN and VPLMN of the Announcing UE exchange Announce Auth.
4)	The DDNMF in the HPLMN of the Announcing UE returns the ProSe Code and the corresponding Code-Sending Security Parameters, along with the CURRENT_TIME and MAX_OFFSET parameters. The Code-Sending Security Parameters provide the necessary information for the Announcing UE to protect the transmission of the ProSe Code and are stored with the ProSe Code. The Announcing UE takes the same actions with CURRENT_TIME and MAX_OFFSET as described for the Announcing UE in step 4 of subclause 6.3.2 of the present document.
Steps 5-10 refer to a Monitoring UE
5)	The Monitoring UE sends a Discovery Request message containing the RPAUID to the DDNMF in its HPLMN in order to be allowed to monitor for one or more Restricted ProSe Application User IDs.
6)	The DDNMF in the HPLMN of the Monitoring UE sends an authorization request to the ProSe Application Server. If, based on the permission settings, the RPAUID is allowed to discover at least one of the Target RPAUIDs contained in the Application Level Container, the ProSe Application Server returns an authorization response.
7)	If the Discovery Request is authorized, and the PLMN ID in the Target RPAUID indicates a different PLMN, the DDNMF in the HPLMN of the Monitoring UE contacts the indicated PLMN's DDNMF i.e. the DDNMF in the HPLMN of the Announcing UE, by sending a Monitor Request message.
8)	The DDNMF in the HPLMN of the Monitoring UE may exchange authorization messages with the ProSe Application Server.
9)	The DDNMF in the HPLMN of the Announcing UE responds to the DDNMF in the HPLMN of the Monitoring UE with a Monitor Response message including the ProSe Code, the corresponding Code-Receiving Security Parameters, and an optional Discovery User Integrity Key (DUIK). The Code-Receiving Security Parameters provide the information needed by the Monitoring UE to undo the protection applied by the announcing UE. The DUIK be included as a separate parameter if the Code-Receiving Security Parameters indicate that the Monitoring UE uses Match Reports for MIC checking. The DDNMF in the HPLMN of the Monitoring UE stores the ProSe Code and the Discovery User Integrity Key (if it received one outside of the Code-Receiving Security Parameters).
NOTE 1:	There are two configurations possible for integrity checking, namely, MIC checked by the DDNMF, and MIC checked at the UE side. Which of the configuration is used is decided by the DDNMF that assigned the ProSe Code being monitored, and signalled to the Monitoring UE in the Code-Receiving Security Parameters.
10)	The DDNMF in the HPLMN of the Monitoring UE returns the Discovery Filter and the Code-Receiving Security Parameters, along with the CURRENT_TIME and MAX_OFFSET parameters. The Monitoring UE takes the same actions with CURRENT_TIME and MAX_OFFSET as described for the Monitoring UE in step 9 of subclause 6.3.2 of the present document. The UE stores the Discovery Filter and Code-Receiving Security Parameters.
Steps 11 and 12 occur over PC5.
11)	The UE starts announcing, if the UTC-based counter provided by the system associated with the discovery slot is within the MAX_OFFSET of the announcing UE's ProSe clock and if the Validity Timer has not expired. The UE forms the discovery message and protects it. The four least significant bits of the UTC-based counter are transmitted along with the protected discovery message.
12)	The Monitoring UE listens for a discovery message that satisfies its Discovery Filter, if the UTC-based counter associated with that discovery slot is within the MAX_OFFSET of the monitoring UE's ProSe clock. In order to find such a matching message, it processes the message. If the Monitoring UE was not asked to send Match Reports for MIC checking, it stops at this step from a security perspective. Otherwise, it proceeds to step 13.
NOTE 2:	The UE checking the integrity of the discovery message on its own does not prevent the UE from sending a Match Report due to requirements in TS 23.303 [5]. If such a Match Report is sent, then there is no security functionality involved.
Steps 13-16 refer to a Monitoring UE that has encountered a match.
31)	If the UE has either not had the DDNMF check the MIC for the discovered ProSe Code previously or the DDNMF has checked a MIC for the ProSe Code and the associated Match Report refresh timer (see step 15 for details of this timer) has expired, then the Monitoring UE sends a Match Report message to the DDNMF in the HPLMN of the monitoring UE. The Match Report contains the UTC-based counter value with four least significant bits equal to four least significant bits received along with discovery message and nearest to the monitoring UE's UTC-based counter associated with the discovery slot where it heard the announcement, and other discovery message parameters including the ProSe Code and MIC. The DDNMF checks the MIC.
14)	The DDNMF in the HPLMN of the Monitoring UE may exchange an Auth Req/Auth Resp with the ProSe App Server to ensure that Monitoring UE is authorized to discover the Announcing UE.
15)	The DDNMF in the HPLMN of the monitoring UE returns to the Monitoring UE an acknowledgment that the integrity check passed. It also provides the CURRENT_TIME parameter, by which the UE (re)sets its ProSe clock. The DDNMF in the HPLMN of the Monitoring UE includes the Match Report refresh timer in the message to the Monitoring UE. The Match Report refresh timer indicates how long the UE will wait before sending a new Match Report for the ProSe Code.
16)	The DDNMF in the HPLMN of the Monitoring UE may send a Match Report Info message to the DDNMF in the HPLMN of the Announcing UE.
Figure 6.4.2.1-1: Model A restricted discovery security procedure",TR 33.847,6.4.2.1,all_images/image_369.png,Model A restricted discovery security procedure
"This solution does not address the discovery key generation and key delivery protocol used in the discovery procedure, which is up to the conclusion of key issue #2.
The security procedure for Model B restricted discovery is described as follows:
Steps 1-4 refer to a Discoveree UE.
1)	Discoveree UE sends a Discovery Request message containing the RPAUID to the DDNMF in its HPLMN in order to get Discovery Query Filter(s) to monitor a query, the ProSe Response Code to announce and associated security materials. The command indicates that this is for ProSe Response (Model B) operation, i.e. for a Discoveree UE.
2)	The DDNMF may check for the announced authorization with the ProSe Application Server depending on DDNMF configuration.
3)	The DDNMFs in the HPLMN and VPLMN of the Discoveree UE exchange Announce Auth. messages. If the Discoveree UE is not roaming, these steps do not take place.
4)	The DDNMF in the HPLMN of the Discoveree UE returns the ProSe Response Code and the Code-Sending Security Parameters, Discovery Query Filter(s) and their Code-Receiving Security Parameters corresponding to each discovery filter along with the CURRENT_TIME and MAX_OFFSET parameters. The Code-Sending Security Parameters provide the necessary information for the Discoveree UE to protect the transmission of the ProSe Response Code and are stored with the ProSe Response Code. The Code-Receiving Security Parameters provide the information needed by the Discoveree UE to undo the protection applied to the ProSe Query Code by the Discoverer UE. The Code-Receiving Security Parameters indicate a Match Report will not be used for MIC checking. The UE stores each Discovery Filter with its associated Code-Receiving Security Parameters. The Discoveree UE takes the same actions with CURRENT_TIME and MAX_OFFSET as described for the Announcing UE in step 4 of subclause 6.3.2 of the present document.
Steps 5-10 refer to a Discoverer UE
5)	The Discoverer UE sends a Discovery Request message containing the RPAUID to the DDNMF in its HPLMN in order to be allowed to discover one or more Restricted ProSe Application User IDs.
6)	The DDNMF in the HPLMN of the Discoverer UE sends an authorization request to the ProSe Application Server. If the RPAUID is allowed to discover at least one of the Target RPAUIDs contained in the Application Level Container, the ProSe Application Server returns an authorization response.
7)	If the Discovery Request is authorized, and the PLMN ID in the Target RPAUID indicates a different PLMN, the DDNMF in the HPLMN of the Discoverer UE contacts the indicated PLMN's DDNMF i.e. the DDNMF in the HPLMN of the Discoveree UE, by sending a Discovery Request message.
8)	The DDNMF in the HPLMN of the Discoveree UE may exchange authorization messages with the ProSe Application Server.
9)	The DDNMF in the HPLMN of the Discoveree UE responds to the DDNMF in the HPLMN of the Discoverer UE with a Discovery Response message including the ProSe Query Code(s) and their associated Code-Sending Security Parameters, ProSe Response Code and its associated Code-Receiving Security Parameters, and an optional Discovery User Integrity Key (DUIK) for the ProSe Response Code. The Code-Receiving Security Parameters provide the information needed by the Discoverer UE to undo the protection applied by the Discoveree UE. The DUIK be included as a separate parameter if the Code-Receiving Security Parameters indicate that the Discoverer UE uses Match Reports for MIC checking. The DDNMF in the HPLMN of the Discoverer UE stores the ProSe Response Code and the Discovery User Integrity Key (if it received one outside of the Code-Receiving Security Parameters). The Code-Sending Security Parameters provide the information needed by the Discoverer UE to protect the ProSe Query Code.
NOTE 1:	There are two configurations possible for integrity checking, namely, MIC checked by the DDNMF, and MIC checked at the UE side; this is decided by the DDNMF that assigned the ProSe Code being monitored, and signalled to the Monitoring UE in the Code-Receiving Security Parameters.
10)	 The DDNMFs in the HPLMN and VPLMN of the Discoverer UE exchange Announce Auth. messages. If the Discoverer UE is not roaming, these steps do not take place.
11)	 The DDNMF in the HPLMN of the Discoverer UE returns the Discovery Response Filter and the Code-Receiving Security Parameters, the ProSe Query Code and the Code-Sending Security Parameters along with the CURRENT_TIME and MAX_OFFSET parameters. The Discoverer UE takes the same actions with CURRENT_TIME and MAX_OFFSET as described for the Monitoring UE in step 9 of subclause 6.3.2 of the present document. The UE stores the Discovery Response Filter and its Code-Receiving Security Parameters and the ProSe Query Code and its Code-Sending Security Parameters.
Steps 12 to 15 occur over PC5.
12)	 The Discoverer UE sends the ProSe Query Code and also listens for a response message, if the UTC-based counter provided by the system associated with the discovery slot is within the MAX_OFFSET of the announcing UE's ProSe clock and if the Validity Timer has not expired. The Discoverer UE forms the discovery message and protects it. The four least significant bits of UTC-based counter are transmitted along with the protected discovery message.
13) The Discoveree UE listens for a discovery message that satisfies its Discovery Filter, if the UTC-based counter associated with that discovery slot is within the MAX_OFFSET of the Discoverer UE's ProSe clock. In order to find such a matching message, it processes the message.
NOTE 2:	Match Reports are not used for the MIC checking of ProSe Query Codes.
14) The Discoveree sends the ProSe Response Code associated with the discovered ProSe Query Code. The Discoveree UE forms the discovery message and protects it. The four least significant bits of UTC-based counter are transmitted along with the protected discovery message.
15) The Discoverer UE listens for a discovery message that satisfies its Discovery Filter. In order to find such a matching message, it processes the message. If the Discoverer UE was not asked to send Match Reports for MIC checking, it stops at this step from a security perspective. Otherwise, it proceeds to step 16.
NOTE 3:	The UE checking the integrity of the discovery message on its own does not prevent the UE from sending a Match Report due to requirements in TS 23.303 [5]. If such a Match Report is sent, then there is no security functionality involved.
NOTE 4:	The security keys in the Code-Sending Security Parameters of discover UE and the security keys in the Code-Sending Security Parameters of discoveree UE need to be generated independently and randomly. This ensures that the impersonation of the discoveree UE is not feasible when the discoverer UEs make use of match reports.
Steps 16-19 refer to a Discoverer UE that has encountered a match.
16) If the Discoverer UE has either not had the DDNMF check the MIC for the discovered ProSe Response Code previously or the DDNMF has checked a MIC for the ProSe Response Code and the associated Match Report refresh timer (see step 18 for details of this timer) has expired, then the Discoverer UE sends a Match Report message to the DDNMF in the HPLMN of the Discoverer UE. The Match Report contains the UTC-based counter value with four least significant bits equal to four least significant bits received along with discovery message and nearest to the monitoring UE's UTC-based counter associated with the discovery slot where it heard the announcement, and other discovery message parameters including the ProSe Response Code and MIC. The DDNMF checks the MIC.
17) The DDNMF in the HPLMN of the Discoverer UE may exchange an Auth Req/Auth Resp with the ProSe App Server to ensure that Discoverer UE is authorized to discover the Discoveree UE.
18) The DDNMF in the HPLMN of the Discoverer UE returns to the Discoverer UE an acknowledgement that the integrity check passed. It also provides the CURRENT_TIME parameter, by which the UE (re)sets its ProSe clock. The DDNMF in the HPLMN of the Discoverer UE includes the Match Report refresh timer in the message to the Discoverer UE. The Match Report refresh timer indicates how long the UE will wait before sending a new Match Report for the ProSe Response Code.
19) The DDNMF in the HPLMN of the Discoverer UE may send a Match Report Info message to the DDNMF in the HPLMN of the Discoveree UE.
Figure 6.4.2.2-1: Model B restricted discovery security procedure",TR 33.847,6.4.2.2,all_images/image_370.png,Model B restricted discovery security procedure
"The Remote UE needs to retrieve the address to the 5G PKMF(s) in its HPLMN from the network when it wants to act as a Remote UE.
Figure 6.6.2-1: Procedures for key management in ProSe UE-to-Network Relay
Step 1) The Remote UE gets authenticated and authorized by the network to act as a Remote UE. The Remote UE mutually authenticates with and registers in the 5GC. The network provides the 5G PKMF address and the Relay Service Code to the Remote UE. The Remote UE establishes a PDU session with the network.
NOTE 1:	PCF provisions the Relay Service Code to the Remote UE.
Step 2) The Remote UE retrieves a discovery key for the discovery of a UE-to-network relay from the network as e.g. is described in solution #35.
Step 3) The Remote UE establishes a secure connection with the 5G PKMF. As this connection is established in the user plane, the same mechanism as used to protect the PC3 interface can be re-used. Either solution #5 or solution #11 can be used for securing the connection.
Step 4) The Remote UE sends a Key request message for PC5 communication with a UE-to-network relay to the 5G PKMF. The Remote UE includes the Relay Service Code and the Remote UE ID in the Key request message.
Note 2:	It is not addressed in the present document whether the Remote UE ID consists of one or more of the following parameters: ProSe application id, ProSe application user id and/or GPSI of the Remote UE.
Step 5) The 5G PKMF generates a KPC5 key and provides the KPC5 key and a KPC5 key ID in the Key response message to the Remote UE to be used for PC5 communication with a UE-to-network relay.
Step 6) The UE-to-network relay gets authenticated and authorized by the network to act as a UE-to-network relay.
Step 7) The UE-to-network relay retrieves a discovery key for UE-to-network relay discovery from the network as e.g. described in solution #35.
Note 3:	For step 6) and step 7), if UE-to-network relay and the Remote UE support the same application they will connect to the same 5G PKMF. Different relays do not need to be connected to the same 5G PKMF, it depends on the application. This needs to be further clarified in the solution. Also, it needs to be clarified how all the potential relay candidates get authorized.
Step 8) UE-to-network relay discovery is taken place on the PC5 interface using either model A or model B discovery.
Step 9) When the Remote UE and the UE-to-network relay have discovered each other, the Remote UE sends a Direct Communication Request on the PC5 interface. The Remote UE generates a Nonce_1. The Remote UE includes the KPC5 key ID received from the 5G PKMF together with Relay Service Code, the Remote UE ID, Nonce_1 and its HPLMN ID. The Remote UE's HPLMN ID is used by the UE-to-network relay's 5G PKMF to determine the 5G PKMF in the Remote UE's HPLMN. In this message flow, the Remote UE and the UE-to-network relay belong to the same HPLMN. The KPC5 key ID indicates the KPC5 key which the Remote UE wants to use to get relay connectivity. The Remote UE derives a temporary key KPC5-TEMP key from KPC5 key and Nonce_1 and calculates a message authentication code (MACPC5-TEMP) over the included ProSe parameters using the KPC5-TEMP key and includes the message authentication code (MACPC5-TEMP) in the Direct Communication Request. Additional input parameters could be used in the calculation of the MACPC5-TEMP. This needs to be determined in the normative work.
Step 10) The UE-to-network relay establishes a secure connection with the 5G PKMF. As this connection is established in the user plane, the same mechanism as used to protect the PC3 interface can be re-used. Either solution #5 or solution #11 can be used for securing the connection.
Step 11) The UE-to-network relay sends a Key request message for PC5 communication with a Remote UE to the 5G PKMF, identified by the Remote UE's HPLMN ID received on the PC5 interface. The Key request message includes the KPC5 key ID, the HPLMN ID of Remote UE, the Relay Service Code, Nonce_1, the Remote UE ID, the UE-to-network relay ID, and the MACPC5.
Step 12) The 5G PKMF authenticates the Remote UE by verifying the message authentication code (MACPC5) using the KPC5 key identified by the KPC5 key ID and the Nonce-1. The 5G PKMF needs to check that the Nonce-1 is not replayed. The 5G PKMF checks the context of the Remote UE to confirm whether it can connect to the network via the selected ProSe UE-to-network Relay for the given Relay Service Code. The 5G PKMF checks if the Remote UE and the UE-to-network relay are allowed to communicate by checking the Remote UE ID and the UE-to-network relay ID. The 5G PKMF may contact UDM to retrieve subscription data if it is not already stored in the 5G PKMF.
Step 13) If the 5G PKMF confirms the Remote UE can connect to the network via the selected ProSe UE-to- network Relay, the 5G PKMF generates a new freshness parameter (i.e. KPC5-COM freshness parameter). The 5G PKMF generates a new key KPC5-COM from at least the KPC5 key, Nonce_1, Relay Service Code, and the new KPC5-COM freshness parameter. The generation of the KPC5-COM key can be done in a similar way as described in Annex A.7 in TS 33.303 [6] if PRUK is replaced by KPC5 key.
Step 14) The 5G PKMF sends the KPC5-COM key, Remote UE ID and the KPC5-COM freshness parameter to the UE-to-network relay in the Key response message.
Step 14a) The UE-to-network Relay generates a Nonce_2. The UE-to-network Relay generates the KSESS key for PC5 communication from the KPC5-COM key received from the 5G PKMF and the Nonce_2.
Step 15) The UE-to-network Relay initiates a Direct Security Mode Command integrity protected with the KSESS-IK key generated from the KSESS key. The UE-to-network Relay calculates a MAC over the parameters included in the Direct Security Mode Complete message.
The UE-to-network Relay includes the KPC5-COM key ID, KPC5-COM freshness parameter together with calculated MAC and the Nonce_2 in the Direct Security Mode Complete message.
Step 16) The Remote UE derives the KPC5-COM key in the same way as the 5G PKMF in step 13 using the KPC5-COM freshness parameter and then generates the KSESS key from the KPC5-COM key and Nonce_2.
Step 17-18) The Remote UE processes the Direct Security Mode Command by verifying the MAC using a KSESS-IK key generated from the KSESS key. If this verification is successful, the Remote UE responds with a Direct Security Mode Complete message and the Remote UE and UE-to-network relay can start to exchange user data.",TR 33.847,6.6.2,all_images/image_371.png,Procedures for key management in ProSe UE-to-Network Relay
"Figure 6.8.2.1-1: Security protection via UE-to-UE Relay using asymmetric cryptography
The connection establishment procedure is based on TR 23.752 [2], Clause 6.9. However, the security procedure below is not limited to one connection establishment procedure defined in TR 23.752 [2].
The security procedure details are as following:
0. UE-to-UE Relay registers with the network and specifies its UE-to-UE Relay capabilities. UE-to-UE Relay is provisioned from the network with relay policy parameters and with a unique Relay identifier (RID). The assumption in this solution is source UE and target UE are presumed already authenticated.
1. The target UE determines the destination Layer-2 ID for signalling reception for PC5 unicast link establishment as specified in TS 23.287 [9] clause 5.6.1.4. The destination Layer-2 ID is configured with the target UEs as specified in TS 23.287 [9] clause 5.1.2.1.
2. On the source UE, the application layer provides information to the ProSe layer for PC5 unicast communication (e.g. broadcast Layer-2 ID, ProSe Application ID, UE's Application Layer ID, target UE's Application Layer ID, relay applicable indication), as specified in TS 23.287 [9] clause 6.3.3.1. ProSe layer triggers the peer UE discovery mechanism by sending a broadcast Direct Communication Request message. The message is sent using the source Layer-2 ID and broadcast Layer-2 ID as the destination, and includes other parameters related to the application offered. Source UE should also include 2 IEs, which are the list of source UE's supported algorithms and the source UE's public key.
3. The UE-to-UE Relay receives the broadcast Direct Communication Request message and verifies if it is configured to relay this application, i.e. it compares the announced ProSe Application ID with its provisioned relay policy/parameters and, if it matches, the UE-to-UE Relay assigns itself a Relay-Layer-2 ID (e.g. R-L2 ID-a) for source UE (i.e. related to source UE's L2 ID). The UE-to-UE Relay proceeds in forwarding the broadcast Direct Communication Request message, which includes a list of source UE's supported algorithms and the source UE's public key, received from the source UE.
4. Target UE is interested in the announced application thus, target UE will check whether it could support the security algorithms in the list of source UE's supported algorithms, if yes, then it sends the Direct Communication Accept message to source UE, including the chosen algorithm, and also target UE's public key.
5. UE-to-UE Relay forwarded the Direct Communication Accept message to source UE.
6. An ""extended"" unicast link is established between source UE and target UE, via the UE-to-UE Relay. The extended link is secured end to end using source UE's and target UE's public key, while the routing information will be left in the clear.
Note 1:	It is not addressed in the present document how to bind the public key with a specific UE and how to revoke public keys.
Note 2:	It is not addressed in the present document whether and (if yes, then)how to protect the privacy of the routing information.
Note 3:	It is not addressed in the present document on how to make sure the DCA message can be trusted.
Note 4:	Public/private keys provisioning into the peer UEs is not addressed in the present document
Note 5:	The solution is under the assumption that only a single (ProSe) application is supported.",TR 33.847,6.8.2.1,all_images/image_372.jpeg,Security protection via UE-to-UE Relay using asymmetric cryptography
"The procedure for Authorization and security with UE-to-Network relay using Remote UE network primary authentication is depicted in Figure 6.10.2.1-1.
Figure 6.10.2.1-1: Procedure for Authorization and security with UE-to-Network relay using Remote UE network primary authentication
0. The Relay UE is registered and authorized to operate as a UE-to-Network relay.
1. The Remote UE sends a Direct Communication request message to the Relay UE. The Remote UE includes its SUCI in the message to request the UE-to-Network relay service. The Remote UE also provides its security capabilities and security policy as in TS 33.536[8]. If the Remote UE is reconnecting to the same Relay UE and is already authenticated and authorized for relay communication via that Relay UE, it includes the Krelay ID (instead of SUCI) established during the previous connection using this procedure. If the Relay UE has the Krelay and Krelay ID it skips steps 2 to 12, otherwise the Relay UE rejects the connection request.
NOTE 1:	Krelay and Krelay ID are reused during reconnection in the same way as KNRP and KNRP ID in TS 33.536[8]. In case of reconnection with the relay, privacy protection of Krelay ID procedure reuses the same mechanism used for KNRP ID as described in TS 33.536 [8], clause 5.3.3.2.
2. The Relay UE sends a NAS Relay Authorization request message to its serving AMF. The Relay UE includes the Remote UE's SUCI in the message.
3. The Relay UE's AMF checks that the Relay UE is authorized to act as a Relay based on subscription information obtained during Relay UE's registration
4-8. The Relay UE's AMF initiates Remote UE authentication with Remote UE's AUSF according to existing primary authentication procedures. The authentication messages are exchanged transparently via the Relay UE. Authentication messages between AMF and AUSF and AMF and Relay UE include an indication that it is for a relayed authentication i.e. to authenticate Remote UE via Relay UE. The UDM does not need to be aware that the authentication is for a Remote UE as the AMF verifies (in subsequent step 10) with UDM that Remote UE is authorized to use UE-to-Network relaying.
9. Upon successful authentication of the network, the Remote UE derives a PC5 link root key Krelay and its Krelay ID from KAMF
NOTE 2:	Krelay and its Krelay ID can be considered as equivalent to KNRP and KNRP ID in TS 33.536[8].
10. Upon successful authentication of the Remote UE, Relay UE's AMF checks with Remote UE's UDM that Remote UE is authorized to use UE-to-Network relaying. Upon successful authorization check, Relay UE's AMF registers with Remote UE's UDM as its Relay's AMF, providing the Relay UE identity (SUPI or GPSI).
11. Relay UE's AMF derives a PC5 link root key Krelay and its Krelay ID from KAMF as performed by Remote UE in step 9.
12. Relay UE's AMF sends a NAS Relay Authorization response message to the Relay UE. The Relay UE's AMF includes the PC5 link root key Krelay and its Krelay ID in the message. The AMF may include the Remote UE identity (e.g., GPSI). The Relay UE stores the key and its id, Remote UE identity and associates them with the PC5 link with Remote UE.
13. The Relay UE initiates PC5 link security establishment with Remote UE based on PC5 link root key Krelay. The Relay UE derives PC5 session key Krelay-sess from Krelay, and confidentiality and integrity keys from Krelay-sess the same way KNRP-sess is derived from KNRP, and confidentiality and integrity keys from KNRP-sess in TS 33.536[8]. The Relay UE integrity protects the Direct Security Mode Command and includes parameters as in TS 33.536[8]. The Relay UE includes the Krelay ID to indicate that the PC5 security establishment should be based on Remote UE's primary authentication run.
14. The Remote UE checks that the received Krelay ID matches the one derived in step 9. If the provided key id matches, then the Remote UE proceeds with PC5 session, confidentiality, and integrity keys derivation using Krelay as the PC5 link root key as performed by the Relay UE. The Remote UE performs security checks of the Direct Security Mode Command message as in TS 33.536[8].
15. The Remote UE sends integrity and confidentiality protected Direct Security Mode Complete message to Relay UE as in TS 33.536[8].
16. Procedure continues as per L3 relay setup procedure as defined in TR 23.752 [2] (e.g., in step 3-4 in solution#6, and if N3IWF is used with solution#23 subsequent steps 5-6).",TR 33.847,6.10.2.1,all_images/image_373.jpeg,Procedure for Authorization and security with UE-to-Network relay using Remote
"The procedure for Authorization and security with UE-to-Network relay using the 5G native security context of the Remote UE is depicted in Figure 6.10.2.2-1.
Figure 6.10.2.2-1: Procedure for Authorization and security with UE-to-Network relay using 5G native security context of Remote UE
0. The Remote UE has registered with the network and established a 5G native security context with a source AMF. The Relay UE is registered and authorized to operate as a relay.
1. The Remote UE performs a discovery procedure with a Relay UE and decides to connect with the Relay UE using its 5G native security context.
2. If the Remote UE is aware of the PLMN ID of the Relay UE's serving PLMN, the Remote UE verifies that its 5G native security context was established with the Relay UE's serving PLMN before sending its 5G-GUTI to the Relay UE. If the PLMN ID of the Relay UE's serving PLMN and the PLMN ID part in its 5G-GUTI are different or if the current 5G-GUTI was used in a prior DCR with another Relay, the Remote UE sends its SUCI instead (as described in clause 6.10.2.1, step 1). If the Remote UE is not aware of the PLMN ID of the Relay UE's serving PLMN, the Remote UE may choose to send no identifier (i.e. neither SUCI nor 5G-GUTI). If a 5G-GUTI is sent, the Remote UE sends a DCR message to the Relay UE including Remote UE's core network identity (e.g., 5G-GUTI), ngKSI identifying the KAMF being used, the Remote UE's NAS security capabilities, and current UL NAS COUNT. These parameters may be included in a message integrity protected using Remote UE's 5G native security context.
NOTE 1:	Remote UE has the option to use the knowledge of Relay PLMN ID to select a Relay (e.g., select Relay 1 with the same PLMN over Relay 2 with different PLMN). This option of PLMN ID based selection of Relay is to be confirmed .
3. If the request includes a 5G-GUTI, the Relay UE checks whether the PLMN ID of its serving PLMN and in Remote UE's 5G-GUTI are equal. If they are not equal, the Relay UE sends an Identity Request message to the Remote UE including Relay UE's serving PLMN ID, to obtain the Remote UE's identifier (SUCI or 5G-GUTI). If the Remote UE provides a SUCI in the Identity Response, Relay UE proceeds with the procedure as described in clause 6.10.2.1, from step 2. Otherwise, the Relay UE sends the Remote UE's 5G-GUTI and integrity protected message from Remote UE to its serving AMF (target AMF) in a NAS request message.
4. The target AMF checks that Relay UE is authorized to act as a relay.
5. The target AMF identifies the source AMF serving the Remote UE using the provided 5G-GUTI. If the source and target AMFs are different, the target AMF sends a request message to the source AMF to obtain security parameters for the Remote UE. The target AMF includes the integrity protected message from Remote UE and Remote UE's identity received from the Relay UE. The target AMF indicates that the access type and reason for the request are for relay access. If the source and target AMFs are the same (i.e., Remote UE has registered with target AMF), the target AMF retrieves the Remote UE's context directly from its local storage instead.
6. [option 1] The source AMF locates the Remote UE's security context using the received Remote UE's 5G-GUTI. The source AMF checks the integrity protection of the message from the Remote UE using the Remote UE's security context. If the security checks are successful, the source AMF derives a Krelay and Krelay ID from KAMF identified by the ngKSI. [option 2] Alternatively, the source AMF may generate a new 5G security context. The derivation of the new KAMF is specified in TS 33.501 [14] (Annex A.13). The source AMF sends a response message to the target AMF that includes the Remote UE SUPI. The message may include a Krelay and Krelay ID, a new 5G security context to be used for Remote UE with a KAMF change indication or current Remote UE's 5G security context, and Remote UE's context.
NOTE 2:	In the first option, the Remote UE's registration remains with Remote UE's (source) AMF which provides Relay UE's (target) AMF with Krelay and Krelay ID (and SUPI). In the second option, the Remote UE context is transferred to the Relay UE's AMF, with a KAMF change (using the same mechanisms as in TS 33.501[14], clause 6.9.2.3.3). In that case, the target AMF derives Krelay and Krelay ID. Source AMF uses its local policy to determine whether to transfer the Remote UE context and perform horizontal key derivation. If the Remote UE's 5G security context is moved from the source AMF to the target AMF, then if the Remote UE has simultaneously access to the 3GPP network then this connection with the source AMF (of Remote UE) will be dropped. Following the context transfer, source and target AMF registration update with UDM is handled according to existing AMF change mechanisms (see TS 23.502, clause 4.2.2.2.2).
NOTE 3:	Whether Option 2 (with Remote UE context transfer to Relay's AMF) can be used is to be confirmed.
7. The target AMF checks from Remote UE's context (e.g., obtained from source AMF or locally) or with Remote UE's UDM (e.g., using SUPI provided by source AMF) for authorization to use the Relay UE. If not provided by the source AMF, the target AMF derives a Krelay and Krelay ID using Remote UE's security context.
8. The target AMF sends a NAS response message to the Relay UE that includes the Remote UE id (e.g., GPSI), Krelay and Krelay ID. [Option 2] The message may include a KAMF change flag and new ngKSI if a new security context was generated by source AMF in the previous step.
9. The Relay UE sends a Direct Security Mode Command message to the Remote UE that includes Krelay ID and, if provided by the target AMF, KAMF change flag and new ngKSI. The message is integrity protected using a security key derived from Krelay.
10. If the KAMF change flag is set, the Remote UE derives a new KAMF from the KAMF indicated by the value of ngKSI. The Remote UE derives a Krelay and Krelay ID from the existing KAMF or the newly derived KAMF. The Remote UE verifies the DSMC message security using security derived from Krelay. A successful security verification indicates to the Remote UE that the Relay UE is authorized to provide the relay service for Remote UE. The new KAMF is derived the same way as described for NAS SMC procedure when KAMF change flag is set as described in TS 33.501 [14] clause 6.7.2 step 2a and Annex A.13. If the verification of the DSMC message is unsuccessful, the Remote UE replies with a Direct Security Mode Reject message. In that case, Remote UE discards the new security context if it was derived, continues the use of the existing security context, and the Relay UE aborts the link establishment procedure.
Note 3a:	When there is a KAMF change (option 2), how to deal with desynchronization of K_AMF is not addressed in the present document.
11. If the security verification is successful, the Remote UE sends a Direct Security Mode Complete message to the Relay UE with security protection (integrity, confidentiality) using security keys derived from Krelay. The Relay UE verifies the Direct Security Mode Complete message security using security derived from Krelay. A successful security verification indicates to the Relay UE that the Remote UE is authorized to use the relay service provided by Relay UE.
12. [Option 2] If a new KAMF derivation was indicated (in step 9), the Relay UE sends a NAS complete message to inform the AMF of the key establishment result. If the Relay indicates a successful KAMF derivation then AMF registers with Remote UE's UDM causing UDM to deregister source AMF and removal or Remote UE context (as per TS 23.502, clause 4.2.2.2.2). If the KAMF derivation fails (e.g., verification of DSMC fails) then the PC5 link setup is aborted and the Remote UE discards the new security context if it was derived and continues the use of the existing security context.
13. The Remote UE receives a DCA message completing the successful PC5 link establishment.
NOTE 4: The purpose of the 5G GUTI reallocation is to preserve the privacy of the subscription temporary identifier. In the above procedure using the first option (i.e., Remote UE context remains with source AMF), the Remote UE transmits its 5G-GUTI only once (in the DCR). In that case, 5G-GUTI re-allocation by source AMF over Uu is performed as per TS 33.501 [14], clause 6.12.3. If the Remote UE has already a prior connection with the Relay it can send the Krelay ID (see clause 6.10.2.1 step 1) instead of 5G-GUTI. An attacker cannot track the Remote UE using the 5G-GUTI during communication with the Relay UE. Therefore, 5G-GUTI re-assignment is not necessary for this procedure for these scenarios. For 5G-GUTI reallocation when option 2 is used, the Remote UE triggering a connection via a Relay using DCR is considered to be similar to the case of ""Service Request message triggered from the UE not triggered by the network"" in TS 33.501 [14] clause 6.12.3. In that case, it is left to implementation (i.e., not required) to re-assign a 5G-GUTI. For Registration Update (option 2), the Remote UE is considered to be in a ""connected"" state and Relay UE's AMF is aware of Remote UE whereabouts as long as a PC5 link between the Remote UE and the Relay UE is up. Therefore, it is not necessary for the Remote UE to perform either mobility or periodic Registration Update procedures for the Relay UE's AMF to keep track of the Remote UE.
Note 5:	How 5G-GUTI reallocation and Registration Update is performed when Remote UE is transferred to Relay's AMF (option 2) is not addressed in the present document.",TR 33.847,6.10.2.2,all_images/image_374.jpeg,Procedure for Authorization and security with UE-to-Network relay using 5G native
"The Key Hierarchy for the PC5 unicast link with the UE-to-Network relay is shown in Figure 6.10.2.3-1. Details for Krelay and Krelay ID derivation are described next.
Overall, the keys Krelay, Krelay-sess, Krelay-enc, Krelay-int serve a similar function respectively as KNRP, KNRP-sess, NRPEK, and NRPIK in TS 33.536 [8] clause 5.3.3.1.2.1.
The key derived for access via UE-to-Network relay is Krelay, which is used by UE-to-Network relay and Remote UE to derive Krelay-sess.
Krelay-sess is derived from Krelay using nonces exchanged during the PC5 link establishment similarly to how KNRP-sess is derived from KNRP in Annex A.3 of TS 33.536 [8].
Figure 6.10.2.3-1: Key Hierarchy for PC5 unicast link with UE to Network relay
When deriving the key Krelay from KAMF and the uplink NAS COUNT in the UE and the AMF the following parameters are used to form the input S to the KDF.
-	FC = 0xXX
-	P0 = Uplink NAS COUNT
-	L0 = length of uplink NAS COUNT (i.e. 0x00 0x04)
-	P1 = Access type distinguisher
-	L1 = length of Access type distinguisher (i.e. 0x00 0x01)
The access type distinguisher is set to the value for non-3GPP (0x02) (see Annex A.9 in TS 33.501 [14]).
The input key KEY is KAMF.
When deriving the Krelay ID from KAMF, the following parameters are used to form the input S to the KDF:
-	FC = 0xYY;
-	P0 = ""R-KID"";
-	L0 = length of ""R-KID""; (i.e. 0x00 0x05)
-	P1 = SUPI;
-	L1 = length of SUPI.
The input key KEY is KAMF.
SUPI has the same value as parameter P0 in Annex A.7.0 of TS 33.501 [14].",TR 33.847,6.10.2.3,all_images/image_375.jpeg,Key Hierarchy for PC5 unicast link with UE to Network relay
"Figure 6.12.2-1 illustrates the IP address/prefix change procedure between the Source UE (UE1), the Target UE (UE2), and the UE-to-UE Relay. The Link Identifier Update procedure defined in TS 23.287 [9] is reused between UE1 and the UE-to-UE Relay and a new procedure is defined between the UE-to-UE Relay and UE2 (i.e., Target UE(s)).
This solution applies to Layer-3 based Solution #10 and Solution #32 described in TR 23.752 [2]. Since Solution #10 and Solution #32 described in TR 23.752 [2] are similar, this proposed solution applies to both of them. The main difference between Solution #10 and Solution #32 described in TR 23.752 [2] is the proposed method of IP address/prefix allocation. In Solution #10, the UE-to-UE Relay allocates the IP address/prefix to the UE. In Solution #32, a link-local IP address that is assigned by the UE itself is used and sent to the UE-to-UE Relay. Differences in the procedure detailed below are explained when needed.
As defined for the Layer-3 based Solution #10 and Solution #32 described in TR 23.752 [2], each UE uses the same IP address with all its peer UEs which are connected to the same UE-to-UE Relay. UE1's IP address is thus not associated or linked to UE2's IP address thus UE2's IP address cannot indirectly be used to track UE1 after the Link Identifier Update procedure is run between UE1 and the UE-to-UE Relay. For this reason, UE2 does not need to change its IP address at the same time as UE1. UE2 however needs to be informed of UE1's new IP address since IP communication is used between UE1 and UE2.
For simplicity, Figure 6.12.2-1 and the detailed text below focus on the change of IP addresses/prefixes. However, it is understood that other identifiers that are updated and exchanged during the Link Identifier Update procedure as specified in TS 23.287 [9] are also included in this proposed procedure. For example, Layer-2 IDs (source/destination) and security information IEs are changed on the PC5 unicast link between UE1 and the UE-to-UE Relay although not shown in Figure 6.12.2-1.
Figure 6.12.2-1: Privacy handling for Layer-3 based UE-to-UE Relay
0) A PC5 unicast link is established between UE1 and the UE-to-UE Relay. Another PC5 unicast link is established between the UE-to-UE Relay and UE2. The Relay maintains a mapping table that includes its PC5 peer UEs' user info, their IP addresses/prefixes, and associated PC5 unicast links. Both Source/Target UEs learn their peer UE's IP addresses/prefixes via the Relay UE using DNS. IP data is exchanged between UE1 and UE2 via the UE-to-UE Relay over the PC5 unicast links. The UE-to-UE Relay handles the routing of IP packets to another PC5 unicast link based on the destination IP address/prefix.
1) UE1 is informed (e.g., via the application layer, timer expiration) that its IP address/prefix, Layer-2 ID, and possibly other identifiers (e.g., Application ID) need to be changed. UE1 triggers the Link Identifier Update procedure, as defined in TS 23.287 [9], with some changes added for the support of UE-to-UE Relay.
2) UE1 sends a Link Identifier Update Request message to the UE-to-UE Relay over the PC5 unicast link, which includes a ""new IP address needed"" indication and its peer UE info (i.e., UE2 IP address, UE2 User Info), in addition to the usual parameters sent on the Link Identifier Update request message, e.g., Layer-2 ID and security info.
a)	The ""new IP address needed"" indication is used when the UE-to-UE Relay assigns the IP address/prefix to its peer UEs, as defined in sol#10. If the UE uses a link-local IP address, as defined in sol#32, a new link-local IP address is self-allocated on UE1 and sent to the UE-to-UE Relay using the Link Identifier Update Request message.
3) UE-to-UE Relay assigns a new IP address/prefix to UE1 and saves it locally, while still preserving UE1's current IP address/prefix. UE-to-UE Relay fetches UE2's entry from its local table based on the peer UE info specified on the Link Identifier Update Request message. UE-to-UE Relay sends a new PC5 Relay Update Request message to UE2 (including UE1's old IP address/prefix, UE1's User Info, and UE1's new IP address/prefix) to inform UE2 about UE1's new IP address/prefix.
4) UE2 saves UE1's new IP address/prefix. UE2 sends a new PC5 Relay Update Response message to UE-to-UE Relay including all parameters received on the PC5 Relay Update Request message to ACK them.
At this point, UE2 still sends/receives IP data using UE1's old IP address/prefix until an IP packet using UE1's new IP address/prefix is received. At that point, UE2 starts using UE1's new IP address/prefix and forgets UE1's old IP address/prefix.
5) UE-to-UE Relay sends a Link Identifier Update Response message to UE1 including UE1's new IP address/prefix (and UE-to-UE relay new info e.g., new IP address/prefix, new Layer-2 ID, new security info).
6) UE1 saves its new IP address/prefix and UE-to-UE Relay new IP address/prefix and other new info. UE1 sends back a Link Identifier Update ACK message to the UE-to-UE Relay including all parameters received on the Link Identifier Update Response message. UE1 may start using its new IP address/prefix. The new Layer-2 IDs associated with the PC5 unicast link (i.e., for UE1 and UE-to-UE Relay, as well as new security info) are also used at that point. Once UE1 has received data using UE1's new IP address/prefix, the old IP address/prefix may be released or deleted.
Note:	Whether IP address change for privacy is always needed is not addressed in the present document.",TR 33.847,6.12.2,all_images/image_376.png,Privacy handling for Layer-3 based UE-to-UE Relay
"Figure 6.13.2.1-1: Secondary authentication procedure for a Remote UE (after PC5 link setup)
During the Registration procedure, Authorization and provisioning are performed for the ProSe UE-to-NW relay(0a) and Remote UE(0b). When the Remote UE is not in the coverage, the Remote UE may use its preconfigured policy and parameter for PC5 discovery and communication to establish a PC5 connection with a UE-to-Network Relay.
1.	The ProSe 5G UE-to-Network Relay may establish a PDU session for relaying with default PDU session parameters received in step 0 or pre-configured in the UE-to-NW relay, e.g. S-NSSAI, DNN, SSC mode, or PDU Session Type.
2.	Based on the Authorization and provisioning in step 0, the Remote UE performs the discovery of a ProSe 5G UE-to-Network Relay. As part of the discovery procedure, the Remote UE learns about the connectivity service the ProSe UE-to-Network Relay provides.
3.	The Remote UE selects a ProSe 5G UE-to-Network Relay and establishes a connection for One-to-one ProSe Direct Communication. When requesting UE-to-Network relaying over PC5, the Remote UE provides its Remote User ID (e.g. SUCI) to the 5G ProSe UE-to-Network Relay UE, which then triggers a Remote UE authorization procedure to validate if the Remote UE is authorized to access the network over the UE-to-Network Relay UE.
If there is no PDU session satisfying the requirements of the PC5 connection with the remote UE, e.g. S-NSSAI, DNN, QoS, UP security activation status, the ProSe 5G UE-to-Network Relay initiates a new PDU session establishment or modification procedure for relaying.
NOTE 1: The secondary authentication of the UE-to-Network Relay UE takes part in the general PDU session establishment.
NOTE 2:	How the Remote UE is authorized to access the network over the UE-to-Network Relay UE is not part of this solution but it is assumed that the AMF can get the Remote UE's SUPI during the authorization / authentication procedure using any solutions for KI#4 (e.g. Sol#10).
4.	For IP PDU Session Type and IP traffic over the PC5 reference point, the IPv6 prefix or IPv4 address is allocated for the remote UE. From this point the uplink and downlink relaying can start.
5.	The ProSe 5G UE-to-Network Relay sends a Remote UE Report (Remote User ID, IP info) message to the SMF for the PDU session associated with the relay. The SMF receives the Remote UE's SUPI from the AMF, obtained during step 3.
6.	When the SMF received Remote UE Report the SMF may retrieve subscription data of the Remote UE from the UDM and, based on the local configuration of the SMF, may perform Secondary authentication/authorization for the Remote UE. The SMF sends PDU Session Authentication Command message to the 5G ProSe UE-to-Network Relay including Remote User ID.
NOTE 3: The local configuration of the SMF is set by the operator. If it indicates that secondary A&A is not required, the SMF does not perform secondary authentication/authorization for the Remote UE.
NOTE 4: As described in clause 4.3.2.3 of TS 23.502, secondary authentication can be supported in the case of a local breakout scenario. Similarly, the secondary authentication procedure for the remote UE can be performed even if remote UE's HPLMN is different from that of relay UE as long as there is a secure connection between relay UE's PLMN and the DN-AAA where the remote UE needs to perform the secondary authentication.
7.	The 5G ProSe UE-to-Network Relay sends an EAP message to the Remote UE via PC5 signalling. The Remote UE sends an EAP message to the 5G ProSe UE-to-Network Relay via PC5 signalling.
NOTE 5: When a PDU session being shared by multiple UEs is revoked or changed due to any reason, how to handle this is not introduced in this solution.
8.	The 5G ProSe UE-to-Network Relay sends PDU Session Authentication Complete message to the SMF including Remote User ID and EAP message received from the Remote UE.
9.	The SMF sends an EAP message to the DN-AAA.
10.	The DN AAA server and the UE should exchange EAP messages, as required by the EAP method.
11. If the authentication/authorization success, the DN-AAA sends EAP-Success to the SMF.
12.	If the authentication/authorization fails, the DN-AAA sends EAP-Failure to the SMF. The SMF sends a NAS message (e.g. PDU Session Modification, Remote UE Release Command) to the 5G ProSe UE-to-Network Relay. The NAS message includes Remote User ID to indicate the Remote UE and the 5G ProSe UE-to-Network Relay releases the PC5 link with the Remote UE.
NOTE 6:	It is possible to perform a secondary authentication procedure in parallel when multiple Remote UEs are connected to the 5G ProSe UE-to-Network Relay almost at the same time.
NOTE 7:	The DN-AAA does not know whether a UE is connected via 5G ProSe UE-to-Network Relay or connected directly to the network.
NOTE 8: The solution assumes that the used EAP method provides the necessary security (e.g., for user id privacy protection).",TR 33.847,6.13.2.1,all_images/image_377.png,Secondary authentication procedure for a Remote UE (after PC5 link setup)
"Figure 6.13.2.2-1: Secondary authentication procedure for a Remote UE (before PC5 link setup)
During the Registration procedure, Authorization and provisioning are performed for the ProSe UE-to-NW relay(0a) and Remote UE(0b). When the Remote UE is not in the coverage, the Remote UE may use its preconfigured policy and parameter for PC5 discovery and communication to establish a PC5 connection with a UE-to-Network Relay.
1.	The ProSe 5G UE-to-Network Relay may establish a PDU session for relaying with default PDU session parameters received in step 0 or pre-configured in the UE-to-NW relay, e.g. S-NSSAI, DNN, SSC mode, or PDU Session Type.
2.	Based on the Authorization and provisioning in step 0, the Remote UE performs the discovery of a ProSe 5G UE-to-Network Relay. As part of the discovery
3.	Remote UE establishes PC5 connection towards the 5G ProSe UE-to-Network Relay UE. When requesting UE-to-Network relaying over PC5, the Remote UE provides its Remote User ID (e.g. SUCI) to the 5G ProSe UE-to-Network Relay UE, which then triggers a Remote UE authorization procedure to validate if the Remote UE is authorized to access the network over the UE-to-Network Relay UE.
NOTE 1: The secondary authentication of the UE-to-Network Relay UE takes part in the general PDU session establishment.
NOTE 2:	How the Remote UE is authorized to access the network over the UE-to-Network Relay UE is not part of this solution but it is assumed that the AMF can get the Remote UE's SUPI during the authorization / authentication procedure using any solutions for KI#4 (e.g. Sol#10).
4.	The 5G ProSe UE-to-Network Relay UE sends PDU Session Establishment or PDU Session Modification Request to the SMF and provides the Remote UE ID of the Remote UE. The SMF receives the Remote UE's SUPI from the AMF, obtained during step 3.
5.	When the SMF received Remote User ID the SMF may retrieve the subscription data of the Remote UE from the UDM and, based on the local configuration of the SMF, may perform Secondary authentication/authorization for the Remote UE. The SMF sends PDU Session Authentication Command message to the 5G ProSe UE-to-Network Relay including Remote User ID.
NOTE 3: The local configuration of the SMF is set by the operator. If it indicates that secondary A&A is not required, the SMF does not perform secondary authentication/authorization for the Remote UE.
NOTE 4: As described in clause 4.3.2.3 of TS 23.502, secondary authentication can be supported in the case of a local breakout scenario. Similarly, the secondary authentication procedure for the remote UE can be performed even if remote UE's HPLMN is different from that of relay UE as long as there is a secure connection between relay UE's PLMN and the DN-AAA where the remote UE needs to perform the secondary authentication.6.	The 5G ProSe UE-to-Network Relay sends an EAP message to the Remote UE via PC5 signalling. The Remote UE sends an EAP message to the 5G ProSe UE-to-Network Relay via PC5 signalling.
NOTE 5: When a PDU session being shared by multiple UEs is revoked or changed due to any reason, how to handle this is not introduced in this solution.
7.	The 5G ProSe UE-to-Network Relay sends PDU Session Authentication Complete message to the SMF including Remote User ID and EAP message received from the Remote UE.
8.	The SMF sends an EAP message to the DN-AAA.
9.	The DN AAA server and the UE should exchange EAP messages, as required by the EAP method.
10. If the authentication/authorization success, the DN-AAA sends EAP-Success to the SMF.
11.	The SMF sends PDU Session Establishment Accept or PDU Session Modification Command to accept Remote UE's request.
12.	The 5G ProSe UE-to-Network Relay UE sends a PC5 connection accept message to the Remote UE.
13.	The ProSe 5G UE-to-Network Relay sends a Remote UE Report (Remote User ID, IP info) message to the SMF for the PDU session associated with the relay.
14.	If the authentication/authorization fails, the DN-AAA sends EAP-Failure to the SMF.
15.	The SMF sends PDU Session Establishment Reject or PDU Session Modification Command to the 5G ProSe UE-to-Network Relay UE to reject Remote UE's request.
16.	The 5G ProSe UE-to-Network Relay UE rejects PC5 connection establishment.
NOTE 6:	It is possible to perform a secondary authentication procedure in parallel when multiple Remote UEs are connected to the 5G ProSe UE-to-Network Relay almost at the same time.
NOTE 7:	The DN-AAA does not know whether a UE is connected via 5G ProSe UE-to-Network Relay or connected directly to the network.
NOTE 8:	The solution assumes that the used EAP method provides the necessary security (e.g., for user id privacy protection).",TR 33.847,6.13.2.2,all_images/image_378.jpeg,Secondary authentication procedure for a Remote UE (before PC5 link setup)
,TR 33.847,6.15.2,all_images/image_379.png,Procedures for key management in ProSe UE-to-Network Relay based on primary
"Figure 6.18.2-1: Authorization and secure PC5 link establishment procedure for UE-to-network relay
NOTE 1:	In this solution, the remote UE needs to be provisioned with the discovery security materials and Remote User Key when it is in coverage. Also, those security materials are associated with an expiration time, after which they become invalid. When the security materials become invalid the Remote UE needs to be in coverage to obtain fresh ones to be able to connect via relay.
0a. The Remote UE gets the discovery parameters and ProSe Key management function (PKMF) address from the 5G DDNMF.
NOTE 2:	The Remote UE may get multiple PKMF addresses for different PLMNs. If the Remote UE receives multiple PKMF addresses, it will contact each of the PKMFs separately. The remote UE may contact those PKMFs directly or via the PKMF of its home PLMN.
0b. The Remote UE is authorized to receive UE-to-network relay service and gets the discovery security material from the PKMF
0c. The UE-to-network relay gets the discovery parameters and ProSe Key management function (PKMF) address from the 5G DDNMF.
0d. The UE-to-network relay is authorized to act as a relay and gets the discovery security material from the PKMF.
The remote UE and relay UE communicate with the PKMF via PC8 reference point (like in LTE Prose [6]). Security for PC8 interface relies on Ua security if GBA [12] is used or Ua* when AKMA [7] is used.
NOTE 3:	For commercial services, the PKMF is located in the operator's network. For Public Safety use cases, the PKMF can be managed by the Public Safety service provider.
1a. The Remote UE sends a Prose Remote User Key (PRUK) Request message to the PKMF of the UE-to-network relay.
1b. The ProSe Key Management Function checks that the Remote UE is authorized to receive UE-to-network Relay service. This is done by using the Remote UE's identity that is bound to the keys that established the secure connection between the Remote UE and PKMF in step 0b. If the Remote UE is authorized to receive the service, the PKMF sends a PRUK and PRUK ID to the Remote UE.
2. The discovery procedure is performed between the Remote UE and the UE-to-network Relay using the discovery parameters and discovery security material.
NOTE 4:	The details on the discovery security material will be determined in the normative phase based on the solutions and conclusions of KI #1 and KI #2.
3. The Remote UE sends a Direct Communication Request that contains the PRUK ID, Relay Service Code (RSC) of the UE-to-network relay service and KNRP freshness parameter 1.
4a. The UE-to-network relay sends a Key Request message that contains PRUK ID, RSC and KNRP freshness parameter 1 to the PKMF.
4b. On receiving the Key Request message, the PKMF checks that the UE-to-network relay is authorized to act as a relay to the Remote UE. This is done by using the relay's identity that is bound to the keys that established the secure connection between the relay and PKMF in step 0d. If the UE-to-network relay is authorized to provide the relay service, the PKMF generates KNRP freshness parameter 2 and derives KNRP using PRUK identified by PRUK ID, KNRP freshness parameter 1 and KNRP freshness parameter 2. Then, the PKMF sends a Key Response message that contains KNRP and KNRP freshness parameter 2 to the UE-to-network relay.
5a. The UE-to-network relay sends a Direct Security Mode Command message to the Remote UE (see clause 6.5.2.2). This message contains the KNRP Freshness Parameter 2 and is protected based on the session key (KNRP-SESS) derived from KNRP. The Direct Security Mode Command message is integrity protected using the integrity protection key (KNRPIK) derived from the session key (KNRP-SESS).
NOTE 5:	The details on the security negotiation other than key derivation and its use would be based on the solutions for KI #12.
5b. The Remote UE derives KNRP from its PRUK, RSC, KNRP Freshness Parameter 1 and the received KNRP Freshness Parameter 2. It then derives the session key (KNRP-SESS) in the same manner as the UE-to-network relay and processes the Direct Security Mode Command. The Remote UE further derives the integrity protection key (KNRPIK) and encryption key (KNRPEK) from the session key (KNRP-SESS). Then, the Remote UE checks the integrity of the Direct Security Mode Command message. If the integrity check is successful, the Remote UE is assured that the UE-to-network relay is authorized to provide the relay service.
5c. The Remote UE responds with a Direct Security Mode Complete message to the UE-to-network relay. The Direct Security Mode Complete message is ciphered and integrity protected.
5d. On receiving and processing the Direct Security Mode Complete message, the UE-to-network relay checks the integrity of the Direct Security Mode Complete message. If the integrity check is successful, the UE-to-network relay is assured that the Remote UE is authorized to get the relay service.
6. The remote UE and UE-to-network relay continues the rest of the procedure for the relay service over the secure PC5 link.
NOTE 6:	The rest of the procedure is determined depending on the UE-to-network relay types (i.e., L2 or L3 relay).",TR 33.847,6.18.2,all_images/image_380.jpeg,Authorization and secure PC5 link establishment procedure for UE-to-network relay
"Figure 6.20.2-1: Secure PC5 link establishment procedure for UE-to-network relay
NOTE 1:	 In this solution, the remote UEs and relay UE are assumed to be provisioned with the discovery security materials when they are in coverage. Also, those security materials are associated with an expiration time, after which they become invalid. When the security materials become invalid the Remote UE needs to be in coverage to obtain fresh ones to be able to connect via relay.
Note 2:	The detail of discovery security materials is not addressed in the present document.
NOTE 3:	This solution assumes a peer UE discovery mechanism (e.g., DNS based).
0. The Remote UEs and the UE-to-UE (U2U) relay get the discovery parameters and Prose Key management function (PKMF) address from the 5G DDNMF and the discovery security material from the PKMF respectively. Furthermore, the Remote UEs can be provisioned with the security materials for end-to-end security setup by the PKMF. For example, the security materials for end-to-end security setup include the Prose Service Code (PSC) and an associated key. The service code may be used as a key ID when IKEv2 PSK based authentication is used.
1. Remote UE 1 performs the discovery procedure and PC5 unicast link setup procedure with the UE-to-UE relay.
a. The Remote UE performs the discovery of a U2U relay.
b. The Remote UE sends a Direct Communication Request that includes Relay Service Code (RSC) and Nonce1.
c. Authentication and key agreement may be performed between the remote UE and U2U relay. As a result of successful authentication, KNRP is derived.
d. The U2U relay generates Nonce2 and derives KNRP-SESS using KNRP, Nonce1, and Nonce2. The U2U relay sends a Direct Security Mode Command that contains Nonce 2 to the Remote UE. The Direct Security Mode Command is integrity protected based on KNRP-SESS.
e. The Remote UE derives KNRP-SESS using KNRP, Nonce1, and Nonce2 and checks the integrity of the Direct Security Mode Command. If the verification is successful, the Remote UE sends a Direct Security Mode Complete to the U2U relay. From this point, all PC5 unicast traffic between the Remote UE and the U2U relay can be protected based on the KNRP-SESS.
Note 4:	How to support flexibility between remote UE1 and relay UE, and between Relay and Remote UE 2 are not addressed in the present document.
NOTE 5:	For commercial services, the PKMF is located in the operator's network. For Public Safety use cases, the PKMF can be managed by the Public Safety service provider.
2. Remote UE 2 performs the discovery procedure and PC5 unicast link setup procedure with the UE-to-UE relay in the same manner as Remote UE 1.
3. Remote UE 1 and Remote UE 2 can establish an end-to-end IPsec connection via U2U relay. To establish an end-to-end IPsec connection, Remote UE1 and Remote UE2 may perform IKEv2 authentication using the keying materials provisioned in step 0.
NOTE 6:	Whether the end-to-end IPsec is needed is configured at the remote UEs by the PKMF.",TR 33.847,6.20.2,all_images/image_382.jpeg,Secure PC5 link establishment procedure for UE-to-network relay
"The procedure for PC5 link establishment with L3 UE-to-Network relay to use an S-NSSAI subject to NSSAA is depicted in Figure 6.24.2-1.
Figure 6.24.2.1-1: Procedure for PC5 link establishment with L3 UE-to-Network relay to use an S-NSSAI subject to NSSAA
0. Remote UE is provisioned with authorization parameters to act as Remote UE. Relay UE is provisioned with authorization parameters to act as a Relay UE. Relay has registered for the S-NSSAI(s) associated with the services that are provided by the relay, including for the S-NSSAIs that are subject to NSSAA.
1. Remote UE and Relay perform a discovery procedure.
2. The Remote UE determines from the configuration provided in step 0 that the relay service code/type discovered in step 1 is associated with an S-NSSAI that is subject to NSSAA (e.g., based on an indication parameter for the S-NSSAI). Based on this determination, the Remote UE sends a DCR message including the RSC, a Remote UE's identity (e.g.,), and NSSAA capabilities.
3. Upon receiving the DCR message, the Relay may determine that a network-controlled authorization based NSSAA for Remote UE is required to provide Remote UE access to the slice. The determination may be based on any of the following conditions:
- Relay has performed NSSAA for the S-NSSAI (e.g., as performed in step 0). For example, during the NSSAA procedure, S-NSSAI is marked with an indication that it is subject to NSSAA.
- Based on configuration from step 0, the service provided (i.e., RSC) is associated with a particular S-NSSAI that is subject to NSSAA (e.g., based on an indication parameter for the S-NSSAI) or an indication that network-controlled authorization is required to use the relay service.
4. Upon receiving the DCR message including a Remote UE identity (e.g., SUCI), the relay decides to trigger a network-controlled authorization of Remote UE. The relay sends a NAS request message that includes the Remote UE id, the S-NSSAI, and Remote UE's NSSAA capabilities.
NOTE 2:	If the Remote UE has a 5G native context established with the Relay UE's serving PLMN, it provides its 5G-GUTI (instead of SUCI) and the primary authentication steps below may be skipped as described in solution #10.
5. The AMF checks that the relay is authorized to act as a relay and is authorized to provide access to the S-NSSAI (e.g., S-NSSAI is part of Relay's UE Allowed NSSAI). Upon successful check, the AMF decides to trigger a primary authentication of Remote UE via the relay.
6. The Remote UE performs a primary authentication procedure via the relay. Authentication messages are transported over NAS messages between the AMF and Relay. The NAS messages include an indication (e.g., Remote UE's GPSI, Remote User Id, or any id provided by Remote UE in message 2) that the authentication messages are for the Remote UE. The relay forwards those messages transparently between Remote UE and AMF.
7. Upon successful authentication procedure, the AMF checks with Remote UE's UDM that Remote UE is authorized to use the relay and has S-NSSAI as part of its subscription. If S-NSSAI is subject to NSSAA, AMF verifies that Remote UE supports NSSAA from the capabilities received from the Relay. AMF registers with Remote UE's UDM (including information about serving Relay) to handle further UDM subscription notifications or to handle revocation/re-authentication requests for Remote UE from AAA-S.
Following successful subscription-based authorization checks, AMF generates key material to authorize and enable secure communication between the Relay and Remote UE. The generated key material is derived from the key material generated during the primary authentication with the Remote UE. Upon successful authentication procedure, the Remote UE generates key material for securing communication with relay the same way as AMF.
8. Upon successful completion of the authentication procedure, the AMF sends a NAS response message that includes the Remote UE id (e.g., GPSI), the generated key material, the S-NSSAI, NSSAA status which indicates whether NSSAA is to be performed, ongoing or successful (e.g., if initiated or performed successfully from a previous registration). If primary authentication or subscription-based authorization check fails, the NAS message indicates a failure cause (e.g., S-NSSAI not authorized).
NOTE 3:	Remote UE may have performed successfully or initiated NSSAA for the S-NSSAI from a previous Registration with Relay UE's AMF or another AMF. In that case, the Relay UE's AMF may retrieve the current NSSAA status from the Remote UE context (as described in sol#10).
9. The relay establishes the PC5 link security with the Remote UE using the key material generated from step 7. This step is skipped in case of failure indication in message 8.
10. The relay may send an ack message to confirm the PC5 link security establishment to the AMF. AMF may trigger the NSSAA procedure upon receiving this message illustrated in Figure 6.24.2.2-1.
11. The relay sends a DCA message including indication for NSSAA status (e.g., pending, required, successful) and S-NSSAI to Remote UE. In case of failure indication in message 8, the relay sends a reject message to the Remote UE including the failure cause.
12. If NSSAA is required, an NSSAA procedure for Remote UE via Relay may be triggered by Relay as illustrated in Figure 6.24.2.2-1.
13. Upon successful completion of the NSSAA procedure, the relay sends a PC5 message (e.g., a PC5 Link Modification Request) that includes a successful NSSAA indication, the authorized S-NSSAI. If the NSSAA procedure fails, the relay may release the PC5 link indicating the failure cause.
In the above procedure, the NSSAA procedure is triggered after the relay sends the DCA message to the Remote UE. Alternatively, the NSSAA procedure may be triggered during the PC5 link establishment (e.g., NSSAA triggered after successful completion of DSMC procedure and before sending DCA to Remote UE). Upon successful NSSAA procedure, the relay sends a DCA message that includes a successful NSSAA indication and the authorized S-NSSAI. If the NSSAA fails, the relay may send a PC5 reject message indicating the failure cause.
Upon successful NSSAA procedure, the relay may send a NAS message (e.g., PDU Session Modification, Establishment request, or Remote UE Report) to the SMF to provide connectivity to the Remote UE. The message may include the Remote UE User id and Remote UE addressing info (e.g., IP or MAC address) and other PDU Session parameters (e.g., S-NSSAI, DNN). The SMF receives the message from AMF which includes the Remote UE's SUPI, obtained by AMF during primary authentication of Remote UE (see step 6 above). Using Remote UE SUPI, AMF can verify that Remote UE is authorized to access the selected DNN according to existing procedures (see TS 23.502 [10], clause 4.3.2.2.1) before sending the request message to SMF.",TR 33.847,6.24.2.1,all_images/image_383.png,Procedure for PC5 link establishment with L3 UE-to-Network relay to use an S-
"The procedure for NSSAA of Remote UE connecting via L3 UE-to-Network relay is depicted in Figure 6.24.2.2-1.
Figure 6.24.2.2-1: Procedure for NSSAA of Remote UE connecting via L3 UE-to-Network relay
1. The relay UE or the AMF may decide to trigger an NSSAA procedure for the Remote UE according to conditions as described in Figure 6.24.2.1-1 (i.e., successful completion of network controlled authorization procedure, confirmation of PC5 link security establishment from Relay). If the procedure is triggered by AMF steps 2 and 3 are skipped. If the procedure is triggered by Relay step 8 is skipped.
2. The Relay sends a NAS request message to the AMF that includes the Remote UE id (e.g., SUPI, GPSI) and S-NSSAI.
3. The AMF checks that the relay is authorized to act as a relay and is authorized to provide access to the S-NSSAI (e.g., S-NSSAI is part of Relay's UE Allowed NSSAI) and that NSSAA is to be performed for Remote UE to use S-NSSAI (e.g., based on NSSAA status associated with S-NSSAI/Remote UE stored in Relay UE context). Upon successful check, the AMF decides to trigger a primary authentication of Remote UE via the relay.
4. The Remote UE performs an NSSAA procedure via the relay. Authentication messages are transported over NAS messages between the AMF and Relay. The NAS messages include an indication (e.g., Remote UE's GPSI) to inform the Relay that authentication messages are for the Remote UE. The relay forwards those messages transparently between Remote UE and AMF. AMF may receive authorization information from AAA-S for the Remote UE to use the S-NSSAI (e.g., a time limit).
5. Upon successful completion of the NSSAA procedure, the AMF updates the S-NSSAI status information associated with Remote UE in Relay UE context (e.g., mark S-NSSAI as Allowed for Remote UE).
6. The AMF sends a NAS message to the relay indicating the result of the NSSAA procedure, including an identity of the Remote UE, S-NSSAI and optionally authorization information associated with S-NSSAI (as provided by the AAA-S).
7. On the condition of successful NSSAA, the relay stores S-NSSAI authorization information for Remote UE.
8. The relay sends a NAS message to acknowledge message 6 from AMF.
The Relay UE proceeds with the rest of the PC5 link setup with relay using S-NSSAI subject to NSSAA as illustrated in Figure 6.24.2.1-1.",TR 33.847,6.24.2.2,all_images/image_384.jpeg,Procedure for NSSAA of Remote UE connecting via L3 UE-to-Network relay 
"The procedure for AAA-S triggered Authorization Revocation to use S-NSSAI for Remote UE in Figure 6.24.2.3-1.
Figure 6.24.2.3-1: Procedure for AAA-S triggered Authorization Revocation to use S-NSSAI for Remote UE
0. Remote UE is connected to the Relay UE and authorized to use an S-NSSAI subject to NSSAA.
1. NSSAAF receives an authorization revocation request from AAA-S. The request includes the GPSI of the Remote UE.
NOTE:	Existing protection mechanisms for communications between NSSAAF and AAA-S as per TS 33.501 [14] are assumed (e.g., for the privacy of GPSI, S-NSSAI).
2. NSSAAF requests UDM to get the ID of the AMF serving the Remote UE. NSSAAF receives AMF ID and Relay UE GPSI (UDM has obtained info about Relay UE and its AMF prior, see clause 6.24.2.1, step 7).
3. NSSAAF notifies AMF about the S-NSSAI authorization revocation for Remote UE, providing both Remote UE and Relay UE's GPSI.
4. AMF locates the Relay UE context and removes the association of Remote UE with S-NSSAI in the Relay UE context. If no other S-NSSAI is used for Remote UE via the Relay UE, the AMF removes the Remote UE information from the Relay UE context. AMF de-registers from the Remote UE's UDM if Remote UE info is removed from the Relay UE context.
5. AMF sends a NAS command message to the Relay including the Remote UE ID (e.g., GPSI) and S-NSSAI to revoke authorization of Remote UE to use S-NSSAI.
6. The Relay UE discards S-NSSAI authorization information associated with Remote UE including Krelay/Krelay ID.
7. The Relay UE initiates a Link Release procedure and provides Remote UE with the appropriate link release cause.
8. The Relay UE sends a response to the AMF to ack the command.
The re-authentication/authorization procedure is similar to the authorization revocation procedure above. The differences are as follows:
-Upon receiving a re-authentication request from AAA-S via NSSAAF for the Remote UE, the AMF triggers NSSAA of Remote UE via Relay procedure as illustrated in clause 6.24.2.2.
-If NSSAA fails, Figure 6.24.2.3-1 steps 4 – 8 are performed.",TR 33.847,6.24.2.3,all_images/image_385.jpeg,Procedure for AAA-S triggered Authorization Revocation to use S-NSSAI for
"The procedure for AAA-S triggered Authorization Revocation to use S-NSSAI for Remote UE in Figure 6.24.2.3-1.
Figure 6.24.2.3-1: Procedure for AAA-S triggered Authorization Revocation to use S-NSSAI for Remote UE
0. Remote UE is connected to the Relay UE and authorized to use an S-NSSAI subject to NSSAA.
1. NSSAAF receives an authorization revocation request from AAA-S. The request includes the GPSI of the Remote UE.
NOTE:	Existing protection mechanisms for communications between NSSAAF and AAA-S as per TS 33.501 [14] are assumed (e.g., for the privacy of GPSI, S-NSSAI).
2. NSSAAF requests UDM to get the ID of the AMF serving the Remote UE. NSSAAF receives AMF ID and Relay UE GPSI (UDM has obtained info about Relay UE and its AMF prior, see clause 6.24.2.1, step 7).
3. NSSAAF notifies AMF about the S-NSSAI authorization revocation for Remote UE, providing both Remote UE and Relay UE's GPSI.
4. AMF locates the Relay UE context and removes the association of Remote UE with S-NSSAI in the Relay UE context. If no other S-NSSAI is used for Remote UE via the Relay UE, the AMF removes the Remote UE information from the Relay UE context. AMF de-registers from the Remote UE's UDM if Remote UE info is removed from the Relay UE context.
5. AMF sends a NAS command message to the Relay including the Remote UE ID (e.g., GPSI) and S-NSSAI to revoke authorization of Remote UE to use S-NSSAI.
6. The Relay UE discards S-NSSAI authorization information associated with Remote UE including Krelay/Krelay ID.
7. The Relay UE initiates a Link Release procedure and provides Remote UE with the appropriate link release cause.
8. The Relay UE sends a response to the AMF to ack the command.
The re-authentication/authorization procedure is similar to the authorization revocation procedure above. The differences are as follows:
-Upon receiving a re-authentication request from AAA-S via NSSAAF for the Remote UE, the AMF triggers NSSAA of Remote UE via Relay procedure as illustrated in clause 6.24.2.2.
-If NSSAA fails, Figure 6.24.2.3-1 steps 4 – 8 are performed.",TR 33.847,6.24.2.3,all_images/image_386.jpeg,Procedure for AAA-S triggered Authorization Revocation to use S-NSSAI for Relay
"The procedure for PC5 link establishment with L3 UE-to-Network relay to use a PDU Session subject to secondary A&A is depicted in Figure 6.25.2.1-1.
Figure 6.25.2.1-1: Procedure for PC5 link establishment with L3 UE-to-Network relay to use a PDU Session subject to secondary A&A
0. Remote UE is provisioned with authorization parameters to act as Remote UE. Relay UE is provisioned with authorization parameters to act as a Relay UE.
1. The Relay may perform a PDU Session with secondary A&A by DN-AAA. It is assumed that the Relay is provisioned with credentials used during this procedure.
2. The Remote UE and Relay UE perform a discovery procedure whereby the Remote UE may discover the connectivity service provided by the Relay (e.g., based on a broadcasted service code).
3. The Remote UE may determine from the configuration in step 0 that the service code is associated with a DN that requires secondary A&A. Based on this determination, the Remote UE sends a DCR message including its identity (e.g., SUCI).
4. Upon receiving the DCR message, the Relay may determine that a network controlled authorization is needed before trying to fulfil the Remote UE PC5 connection request. The determination may be based on any of the following conditions:
- an existing PDU session that can satisfy the Remote UE connectivity requirements (e.g., as established in step 1) is marked with an indication that secondary A&A is required
- from the configuration in step 0, the service code is associated with a DN that is marked with a parameter indicating that it requires network controlled authorization.
If the network controlled authorization is not required the Relay may proceed according to the procedure described in 23.752 [2], clause 6.6.
5. On the condition that the DCR message includes a SUCI, the relay triggers a network-controlled authorization of Remote UE, as described in sol#10. Alternatively, the relay may send an identity request message to the Remote UE to obtain the Remote UE identity (e.g., SUCI) before triggering the network-controlled authorization procedure of Remote UE if the procedure is required as per step 4. If the Remote UE fails to provide its identity required for network-controlled authorization, the relay rejects the connection request and provides in the rejection message a cause indicating that a required identity parameter (e.g., SUCI) is missing.
6. Upon successful network-controlled authorization of Remote UE procedure the Relay initiates a Direct Security Mode Command procedure with Remote UE to establish the security of the PC5 link. The security of the PC5 link may be established as described in sol#10.
7. Upon successful security establishment, the relay sends a DCA message that may include an indication that a PDU Session with secondary A&A is pending. The relay may allocate an IP address or IPv6 prefix to the Remote UE. The relay may configure a traffic filter (e.g., as a default filter for IP or non-IP traffic) for the PC5 link to prevent any data traffic until successful completion of subsequent PDU Session secondary A&A (next step). Based on the indication in the DCA message, the Remote UE may refrain from sending any data traffic over the PC5 link until successful completion of subsequent PDU Session secondary A&A.
8. The relay triggers a PDU Session secondary A&A over relay procedure (e.g., as described in Figure 6.25.2.2-1).
9. Upon successful PDU Session with secondary A&A over relay procedure, the relay sends a PC5 message (e.g., a PC5 Link Modification Request) that includes a successful indication, that may include an EAP success message (received from SMF in step 8). The relay may configure the link to allow data traffic between the Remote UE and the network/DN (e.g., remove the filter configured in step 7). If the PDU Session with secondary A&A fails, the relay may release the PC5 link indicating the failure cause. The reject message may include the EAP failure message (received from SMF in step 8).
In the above procedure, the PDU Session secondary A&A procedure is triggered after the relay sends the DCA message to the Remote UE. Alternatively, the relay may trigger the PDU Session secondary A&A during the link establishment procedure (e.g., trigger PDU Session secondary A&A after successful completion of DSMC procedure and before sending DCA to Remote UE). In this case, secure PC5-S messages may be used to carry EAP authentication messages for the PDU Session secondary A&A to/from the Remote UE. Upon successful PDU Session with secondary A&A of Remote UE, the relay sends a DCA message that includes a successful secondary A&A indication. The message may include an EAP success message (received from SMF in step 8). If the PDU Session with secondary A&A fails, the relay sends a PC5 reject message indicating the failure cause. The reject message may include the EAP failure message (received from SMF).",TR 33.847,6.25.2.1,all_images/image_387.jpeg,Procedure for PC5 link establishment with L3 UE-to-Network relay to use a PDU
"The procedure for PDU Session secondary A&A of Remote UE via L3 UE-to-Network relay is depicted in Figure 6.25.2.2-1.
Figure 6.25.2.2-1: Procedure for PDU Session secondary A&A of Remote UE via L3 UE-to-Network relay
1. The relay UE decides to trigger a PDU Session secondary A&A for the Remote UE according to conditions, as described in Figure 6.25.2.1-1.
2. The Relay sends a NAS message (e.g., PDU Session Modification or Establishment request or Remote UE Report) to the SMF. The message may include the Remote UE User id and Remote UE addressing info (e.g., IP or MAC address) and other PDU Session parameters (e.g., S-NSSAI, DNN). The SMF receives the message from AMF which includes the Remote UE's SUPI, obtained by AMF during a controlled authorization of Remote UE procedure as described in sol#10.
NOTE 1:	In the case of Home Routed roaming, the SMF in the call flow is the H-SMF (and the V-SMF is not shown for simplicity). SMF selection by AMF is performed as per TS 23.502 [10], clause 4.3.2.2.3 (e.g., using PLMN ID of the SUPI, S-NSSAI, etc.).
3. The SMF determines based on Remote UE's subscription information (i.e., Secondary authentication indication as per TS 23.502 [10], Table 5.2.3.3.1) that the requested DN is subject to secondary A&A and triggers a PDU Session secondary A&A of Remote UE via Relay.
4. The Remote UE performs a PDU Session secondary A&A via the Relay. Authentication messages are transported over NAS messages between the SMF and Relay. The NAS messages include an identity of the Remote UE (e.g., GPSI, Remote User Id) to indicate to the Relay that authentication messages are for the Remote UE. The relay forwards those messages transparently and securely between Remote UE and SMF. The SMF maintains an N4 session with DN-AAA for all UEs sharing the PDU Session as long as the PDU Session is not released. DN-AAA may allocate and assign an IP address/IPv6 prefix for the Remote UE during the procedure. The DN-AAA may authorize QoS parameter (e.g., session AMBR) for the Remote UE using the shared PDU Session.
NOTE 2: Details on support for DN-AAA allocation of address/IPv6 prefix and DN-AAA authorized QoS parameters for a shared PDU Session will be determined during the normative phase. The architectural aspects will be coordinated with SA WG2.
5. Upon successful PDU Session secondary A&A via the Relay procedure, the SMF stores the Remote UE information in the Relay Session Management context including Remote UE identity (e.g., SUPI or GPSI), individual authorization information (e.g., assigned IP, QoS parameters) received from DN-AAA.
6. The SMF sends a NAS message (e.g., PDU Session Modification or Establishment response or Remote UE Report ack) to the relay indicating the result of the PDU Session secondary A&A, including an identity of the Remote UE (e.g., GPSI, Remote User Id), an EAP success or failure message. In the case of successful secondary A&A, the message may include addressing and QoS authorization info for the relay to respectively apply and enforce.
7. In the case of successful secondary A&A, the relay stores any received authorization info associated with the Remote UE. The Relay UE proceeds with the rest of the PC5 link setup with Remote UE as described in Figure 6.25.2.1-1.",TR 33.847,6.25.2.2,all_images/image_388.jpeg,Procedure for PDU Session secondary A&A of Remote UE via L3 UE-to-Network
"The procedure for DN-AAA triggered PDU Session Authorization Revocation for Remote UE is depicted in Figure 6.25.2.3-1.
Figure 6.25.2.3-1: procedure for DN-AAA triggered PDU Session Authorization Revocation for Remote UE
0. The Remote UE is connected to the Relay UE and authorized to use PDU Session subject to secondary A&A.
1. The SMF receives an authorization revocation request from DN-AAA via UPF. The request includes the GPSI of the Remote UE and addressing info (e.g., IP/MAC address).
2. The SMF identifies the PDU Session/Relay UE SM context and removes Remote UE information from Relay UE SM context and may release any address allocated for the Remote UE. SMF configures the UPF to drop any remaining packets associated with the Remote UE. The SMF retains the N4 session with the DN-AAA to continue serving other UEs (including Relay UE) that are still sharing the PDU Session.
3. The SMF sends a NAS command message to release the connection with the Remote UE whose authorization has been revoked. The message includes the Remote UE identity (e.g., Remote User Id, GPSI), Remote UE addressing info, and an indication of the reason for the release.
4. The Relay UE initiates a PC5 link release procedure with the Remote UE.
5. The Relay acknowledges the NAS command message.
NOTE:	If DN-AAA revokes Relay UE authorization for the PDU Session the SMF may release the PDU Session as specified in sub-clause 4.3.4 of TS 23.502 [10] and the Relay UE initiates a Link Release procedure with all Remote UE(s) sharing the released PDU Session.",TR 33.847,6.25.2.3,all_images/image_389.jpeg,procedure for DN-AAA triggered PDU Session Authorization Revocation for
"The procedure for DN-AAA triggered PDU Session Re-Authentication/Authorization for Remote UE is depicted in Figure 6.25.2.4-1.
Figure 6.25.2.4-1: Procedure for DN-AAA triggered PDU Session Re-Authentication/Authorization for Remote UE
0. The Remote UE is connected to the Relay UE and authorized to use a PDU Session subject to secondary A&A.
1. The SMF receives a re-authentication/authorization request from DN-AAA via UPF. The request includes the GPSI of the Remote UE and addressing info (e.g., IP/MAC address).
2. The SMF identifies the PDU Session/Relay UE SM context and retrieves the Remote UE information from Relay UE SM context based on the provided information.
3. The SMF initiates a procedure of PDU Session secondary A&A of Remote UE via Relay procedure as described in clause 6.25.2.2, step 4.
4. If new authorization information is provided by DN-AAA the SMF updates the Remote UE info in the Relay UE SM context accordingly.
5. The SMF sends a NAS message (e.g., PDU Session Modification Command) to the relay indicating the result of the PDU Session secondary re-authentication/re-authorization, including Remote UE Id (e.g., GPSI, Remote User Id), an EAP success or failure message. In the case of successful secondary re-A&A, the message may include new authorization information associated with the Remote UE connection.
6. In case of successful secondary re-A&A of Remote UE, the Relay UE updates any authorization info associated with the Remote UE with new info received from SMF. The relay sends a PC5 message (e.g., a PC5 Link Modification Request) that includes an EAP success message. In case of a failed re-A&A procedure, the relay initiates a PC5 link release procedure with Remote UE.
7. The Relay acknowledges the NAS command message from SMF.",TR 33.847,6.25.2.4,all_images/image_390.jpeg,Procedure for DN-AAA triggered PDU Session Re-Authentication/Authorization for
"Mitigating security conflict between policies using open discovery match report procedures is described as follows:
Figure 6.27.2.1-1: Check the conflict between policies using open discovery match report
The Announcing UE sends a Discovery Request message containing the ProSe Application ID to the DDNMF in its HPLMN (A-DDNMF) to get permission to announce on its serving PLMN. The A-DDNMF returns the ProSe App Code, Discovery Key and other discovery parameters in the Discovery Response message. This step reuses the procedures as specified in TS 33.303 [6].
The Announcing UE starts announcing with a Message Integrity Check (MIC) calculated by using the Discovery Key as described in TS 33.303 [6].
The Monitoring UE sends a Discovery Request message containing the ProSe Application ID to the DDNMF in its HPLMN (M-DDNMF) to get the parameters for monitoring. The DDNMF returns the Discovery Filter containing the ProSe App Code(s) and/or the ProSe App Mask(s) with other discovery parameters in the Discovery Response message. The M-DDNMF and A-DDNMF exchange Monitor Req/Resp messages if the ProSe Application ID indicates a different PLMN. This step reuses the procedures as specified in TS 33.303 [6].
The Monitoring UE listens for a discovery message that satisfies its Discovery Filter. On hearing the discovery message, and if the UE needs to check the MIC for the discovered ProSe App Code, the Monitoring UE sends a Match Report message to the M-DDNMF. The Match Report includes the ProSe App Code and MIC.
The M-DDNMF gets the Monitoring UE's ProSe one-to-one communication security policies of the service related to the ProSe App Code from PCF and passes the policies to the A-DDNMF in the Match Report message. The one-to-one communication security policies are used to establish security during one-to-one communication establishment.
The A-DDNMF checks the MIC is valid. The A-DDNMF also gets the security policies of the Announcing UE for direct one-to-one communication service related to the ProSe App Code from PCF and checks if the security policies of the Monitoring UE and the policies of the Announcing UE are not in conflict. If the MIC check passes and the security policies are not in conflict with each other, the A-DDNMF acknowledges a successful check of the MIC to the M-DDNMF in the Match Report Ack message, otherwise, it acknowledges the check failure.
The M-DDNMF acknowledges the Monitoring UE to continue the subsequent procedures if passing the checks in step 6. Otherwise, the M-DDNMF indicates the Monitoring UE to stop the procedure.",TR 33.847,6.27.2.1,all_images/image_391.png,Check the conflict between policies using open discovery match report
"The security procedure for restricted discovery is described as follows:
Figure 6.28.2-1: Check the conflict between policies using restricted discovery procedure
Steps 1-3 show the discovery request procedures of Announcing/Discoveree UE:
The Announcing/Discoveree UE sends a Discovery Request message including its PRAUID to the DDNMF in its HPLMN (A-DDNMF) to get the discovery parameters and the associated security material for announcing. The Announcing/Discoveree UE may include its ProSe one-to-one communication security policies of the service related to the RPAUID. The one-to-one communication security policies are used to establish security during one-to-one communication establishment.
The DDNMF may check for the announced authorization with the ProSe Application Server. The A-DDNMF further exchanges the announced authorization with the DDNMF of VPLMN if the Announcing/Discoveree UE is roaming. The A-DDNMF obtains the Announcing/Discoveree UE's ProSe one-to-one communication security policies of the service related to the RPAUID from PCF if not received in step 1.
The A-DDNMF returns the discovery parameters and the associated security materials.
Steps 4-8 show the discovery request procedures of Monitoring/Discoverer UE:
The Monitoring/Discoverer UE sends a Discovery Request message including its RPAUID to the DDNMF in its HPLMN (M-DDNMF) to get the discovery parameters and security materials for monitoring. The Monitoring/Discoverer UE may include its ProSe one-to-one communication security policies of the service related to its RPAUID.
The M-DDNMF sends an authorization request to the ProSe Application Server and gets an authorization response if the RPAUID is allowed to discover at least one of the Target RPAUID(s). The authorization response includes the above Target RPAUID(s). The M-DDNMF obtains the Monitoring/Discoverer UE's ProSe one-to-one communication security policies of the service related to the RPAUID from PCF if not received in step 4.
If the Discovery Request is authorized, and the PLMN ID in the Target RPAUID indicates a different PLMN, the M-DDNMF sends a Monitor Request to the indicated PLMN's DDNMF i.e. the A-DDNMF. The Monitor Request includes the security policies got from either step 4 or 5. The A-DDNMF may exchange authorization messages with the ProSe Application Server.
The A-DDNMF first checks if the security policies provided by the DDNMF of the Monitoring/Discoverer UE and the security policies of the Announcing/Discoveree UE are not in conflict, the A-DDNMF responds to the M-DDNMF with a Monitor Response message including the discovery parameters and the associated security materials if the Monitoring/Discoverer UE's security policies and the Announcing/Discoveree UE's security policies are not in conflict with each other. The A-DDNMF rejects the monitor request if the security policies between the Announcing/Discoveree UE are in conflict with the security policies of the Monitoring/Discoverer UE. If the Discovery Request is authorized, and the PLMN ID in the Target RPAUID indicates the same PLMN, then the M-DDNMF does the confliction check locally.
For Model B scenario, the DDNMFs in the HPLMN and VPLMN of the Discoverer UE exchange Announce Authorization messages if the Discoverer UE is roaming.
The M-DDNMF returns the discovery parameters and the associated security materials to the Monitoring/Discoverer UE. If the A-DDNMF rejects the Monitor Request, the M-DDNMF aborts the discovery procedure and inform the Monitoring/Discoverer UE.
The Monitoring/Discoverer UE and the Announcing/Discoveree UE continue the subsequent procedures if M-DDNMF informs to continue the discovery procedures, i.e. Model A or Model B discovery, the match report procedures (if applicable) and establishment of ProSe one-to-one communication.
NOTE:	This solution requires network coverage to work.",TR 33.847,6.28.2,all_images/image_392.png,Check the conflict between policies using restricted discovery procedure
"The UE-to-network relay security flow based on primary authentication is described as follows:
1.	The Remote UE generates a freshness parameter Nonce_1 for the one-to-one communication and sends a Direct Communication Request to the Relay UE. In addition to the one-to-one communication parameters, the message may contain the following parameters:
-	a Relay Service Code that the Remote UE would like to access.
-	a 5GPRUK ID (if the Remote UE has a 5GPRUK for this relay connection).
-	a 5G-GUTI (if the Remote UE has a 5G security context) or a SUCI (if the Remote UE does not have a 5G security context). In the case of 5G-GUTI, 5GPRUK ID, GUTI, Relay Service Code and Nonce_1 should be integrity protected with KNASint.
NOTE 1:	 5GPRUK and 5GPRUK ID are equivalent to PRUK and PRUK ID in TS 33.303 [6], respectively.
2.	The Relay UE sends a NAS Relay Key Request to its serving AMF. The message includes the parameters received from the Remote UE, i.e. 5GPRUK ID and/or SUCI/GUTI, Relay Service Code and Nonce_1. In case a 5G-GUTI is included, these parameters are integrity protected with KNASint by the Remote UE.
3.	The AMF of the Relay UE checks whether the Relay UE is authorized to be a Relay UE according to the Relay Service Code. The relay service authorization information is stored in the UDM of the Relay UE.
In the case that the Direct Communication Request message of the Remote UE contains a 5G-GUTI and the AMF of the Remote UE and the AMF of the Relay UE are the same, the AMF should retrieve the SUPI and current 5G security context of the Remote UE, and then check the integrity protection of the parameters of Direct Communication Request message as received in the NAS Relay Key Request message.
In the case that the Direct Communication Request message of the Remote UE contains a 5G-GUTI and the AMF of the Remote UE and the AMF of the Relay UE are not the same, the AMF should send the Direct Communication Request message of the Remote UE to the AMF of the Remote UE according to the 5G-GUTI. The AMF of the Remote UE should check the integrity protection of the message, and then check if the Remote UE is authorized to be a Remote UE. If these checks are passed, the AMF of the Remote UE should transfer the current security context of the Remote UE to the AMF of the Relay UE as defined in clause 6.9.3 of TS 33.501 [14].
Note 2:	When there is a K_AMF change during UE security context transfer, how to deal with desynchronization of K_AMF is not addressed in the present document.
Note 3:	How 5G-GUTI reallocation and Registration Update is performed when Remote UE is transferred to Relay's AMF is not addressed in the present document.
4.	The AMF of the Relay UE sends a Relay Key Request to the AUSF of the Remote UE. The message includes Remote UE's SUCI or SUPI, Relay Service Code, Nonce_1 and the 5GPRUK ID (if it exists).
5-7.	In the case of a SUCI in the Relay Key Request, the AUSF performs a primary authentication procedure defined in TS 33.501 [14] to the remote UE through the Relay UE.
8.	The AUSF of the Remote UE checks whether the Remote UE is authorized to be a Remote UE according to Remote UE's SUPI and Relay Service Code. The relay service authorization information is stored in the UDM of the Remote UE.
9-10.	In the case of a 5GPRUK ID in the Relay Key Request, the AUSF of the Remote UE retrieves the 5GPRUK from the UDM using the Remote UE's SUPI and the 5GPRUK ID.
11.	If there is no 5GPRUK ID in the Relay Key Request or the 5GPRUK ID needs refreshing, a new 5GPRUK will be generated. The AUSF of the Remote UE derives 5GPRUK using Kausf and some other parameters, generates a corresponding 5GPRUK ID. The AUSF of the Remote UE should generate a 5GPRUK_Info from which the Remote UE can derive 5GPRUK and obtain 5GPRUK ID.
NOTE 4:	 The detailed structure of 5GPRUK_Info will be defined in the normative phase.
12.	In the case that a new 5GPRUK is generated, the AUSF of the Remote UE stores the newly generated 5GPRUK and 5GPRUK ID in the UDM.
13.	The AUSF of the Remote UE generates a new random number as the 5GKD Freshness Parameter, and then generates a new 5GKD using 5GPRUK, 5GKD Freshness Parameter, Nonce_1, Relay Service Code, etc.
NOTE 5:	 5GKD is equivalent to KD in TS 33.303 [6].
14-15.	The AUSF of the Remote UE sends 5GKD, 5GKD Freshness and 5GPRUK_Info to the AMF of the Relay UE, and then further passes them to the Relay UE.
16.	The Relay UE sends a Direct Security Mode Command to the Remote UE. In addition to one-to-one communication parameters, the message includes 5GKD Freshness Parameter and 5GPRUK_Info (if it exists).
NOTE 6:	 In Remote UE and Relay UE, 5GKD is equivalent to KNRP.
17.	In the case that there is a 5GPRUK_Info in the message, the Remote UE derives the 5GPRUK and obtains the 5GPRUK ID using the information in 5GPRUK_Info. The Remote UE stores the 5GPRUK and 5GPRUK ID. The Remote UE further derives the 5GKD and performs other procedures.
18.	The Remote UE sends Direct Security Mode Complete message to Relay UE.
Figure 6.30.2-1: UE-to-Network Relay security flow based on primary authentication",TR 33.847,6.30.2,all_images/image_394.jpeg,UE-to-Network Relay security flow based on primary authentication
"When the source UE or the UE-to-UE relay registers in the 3GPP network and is authorized to use a specific service, then the core network provides a token stating what kind of relaying service it can use or serve. The token has an expiration time and is signed with a private key of the core network. The core network also provides the public key to the source UE or the UE-to-UE relay used for verifying the token from other parties.
Note 1:	How the core network provides the public key to the source UE and the UE-to-UE relay is not addressed in the present document.
Figure 6.31.2-1 illustrates the high-level procedure of the proposed solution.
Figure 6.31.2-1: High-level procedure of mutual verification between Source UE and UE-to-UE relay
Step 0: The source UE and the UE-to-UE relay register and are authorized in the 3GPP network. The network provides one authorization token to the source UE and a second token to the UE-to-UE relay stating what kind of relaying service it can use/provide and other policies (e.g. to what kinds of remote UE the relay will provide service, what kinds of relay the UE can use, etc.). The authorization token has an expiration time and is signed with the private key of the CN. The CN also provides the public key to the source UE and the UE-to-UE relay used for verifying the token from other parties. The authorization token could be generated by a CN NF or by the Application Server.
NOTE 2:	The information included in the token (e.g. UE ID, indication if the UE can act as relay UE or remote UE, expiration time, etc.) is left for the normative work
note 3:	It is not addressed in the present document which NF generates the authorization token (e.g. UDM, PCF or ProSe Application Server).
note 4:	How the authorization token is provided to the source UE and the UE-to-UE relay is not addressed in the present document.
Step1: The source UE and the UE-to-UE relay do the relay discovery and selection, e.g. using Discovery procedures using either Model A or Model B as defined in TS 33.303 and TS 23.303 or similar.
Step 2: The source UE sends a Direct Communication Request message to the UE-to-UE relay.
Step 3: Authentication and key agreement may be performed.
Note 5:	The authentication and key agreement is not addressed in the present document.
Step 4: The UE-to-UE relay sends Direct Security Mode Command message to the source UE.
Step 5: The source UE sends Direct Security Mode Complete message to the UE-to-UE relay.
The source UE can include its authorization token-1 in the Direct Security Mode Complete message, but the source UE could also include the authorization token-1 in a new signalling procedure as shown in step 7/7a. When the UE-to-UE relay receives the authorization token-1 from the source UE, it can verify the authorization token-1. For the verification of the authorization token, the receiving side can use the public key to verify the authorization token and check the policies/claims in the authorization token and decide if it should continue the procedure.
Step 5a: As an option, if the UE-to-UE relay is in 3GPP coverage then the 3GPP network could verify the authorization token on behalf of the UE-to-UE relay.
Step 6: If the verification of the authorization token-1 received from the source UE is successful in the UE-to-UE relay, then the UE-to-UE relay includes its authorization token-2 in the Direct Security Mode Response message to the source UE. For the verification of the authorization token-2, the receiving side can use the public key to verify the token and check the policies/claims in the token and decide if it should continue the procedure.
Step 7 and 7a: The source UE could also include the authorization token-1 in separate signalling procedures as shown in step 7/7a to the UE-to-UE relay. When the UE-to-UE relay receives the authorization token-1 from the source UE, it can verify the authorization token-1. For the verification of the authorization token, the receiving side can use the public key to verify the authorization token and check the policies/claims in the authorization token and decide if it should continue the procedure. If the verification of the authorization token-1 received from the source UE is successful in the UE-to-UE relay, then the UE-to-UE relay includes its authorization token-2 in a new signalling procedure to the source UE. For the verification of the authorization token-2, the receiving side can use the public key to verify the token and check the policies/claims in the token and decide if it should continue the procedure.
As an option, if the UE-to-UE relay is in 3GPP coverage then the 3GPP network could verify the authorization token on behalf of the UE-to-UE relay.
Step 8: If the mutual verification of the tokens fails either the UE-to-UE relay or the source UE may release the PC5 link.
Authorization token is generated by the ProSe Application Server:
The ProSe Application Server can be a candidate for generating the authorization token. In that case, the UE accesses the application server via the user plane for application level authorization. The application server generates (maybe with collaboration with PCF, UDM via NEF) and signs the token and gives it to the UE as well as the key for verifying tokens from other UEs. In this case, the application server will maintain the public/private key by itself.
Note 6:	How the authorization token is provided to the source UE and the UE-to-UE relay is not addressed in the present document.
Figure 6.31.2-2 illustrates the high-level procedure of the proposed solution.
Figure 6.31.2-2: Authorization token generated by ProSe application server
In the Authorization Token Request message, the Source UE or UE-to-UE Relay could add an indication that the authorization token is required, so that the ProSe Application Server will generate the token for the UE. In the response, the ProSe Application Server can provide the public key for verifying token, if the ProSe Application Server has the public key for token verification.
When the ProSe Application Server generates the authorization token, it digitally signs the token, so that the token cannot be modified or forged by the attacker. The token generator can use a private key to sign the token and the token can be verified by the corresponding public key.
The public/private keys could be provided by the ProSe application server, or from a centralized entity like a CA.",TR 33.847,6.31.2,all_images/image_395.png,High-level procedure of mutual verification between Source UE and UE-to-UE relay
"The procedure for updating relay service codes and user info ID to mitigate privacy issues is depicted in Figure 6.32.2-1.
Figure 6.32.2-1: Procedural call flow for updating relay service codes to mitigate privacy issues
Step 0: Remote UE gets authorized by its PCF for relay discovery and connection setup, and is provisioned with a set of Relay Service Codes each associated with a set of PDU session parameters (S-NSSAI, DNN, etc.), and also with a User Info ID for UE-to-Network relay discovery. Furthermore, the Remote UE gets provisioned with long term security material for ProSe discovery (e.g. root discovery key such as PSDK as defined in TS 33.303 [6]) and for relay connections (e.g. root relay connection key, such as PRUK as defined in TS 33.303 [6]), possibly with security material to allow direct communication over PC5 (e.g. the long term credentials in TS 33.536 [6] that form the root of the security of the PC5 unicast link to derive KNRP).
Similarly, UE-to-Network Relay gets authorized by its PCF for relay discovery and connection setup and is provisioned with its supported Relay Service Codes, and security material for discovery (e.g. discovery key), and also with a User Info ID for UE-to-Network relay discovery. In ALTERNATIVE 1 of this solution, the UE-to-Network relay does get provisioned with a set of PDU session parameters (S-NSSAI, DNN, etc.) for each Relay Service Code. In ALTERNATIVE 2 of this solution, the UE-to-Network relay does not get provisioned with a set of PDU session parameters (S-NSSAI, DNN, etc.) for each Relay Service Code. In both alternatives of this solution, the UE-to-Network relay should further be provisioned with a set of spare Relay Service Code values.
NOTE 3:	For step 0 the Remote UE and the UE-to-Network relay are assumed to be in coverage. For subsequent steps 1 through 10, the Remote UE can be out of coverage, and the UE-to-Network relay is assumed to be in coverage.
Step 1: Remote UE discovers the UE-to-Network Relay through model A or B UE-to-Network relay discovery procedure by using one (or more) of the Relay Service Codes provisioned to the Remote UE. In this solution, the UE-to-Network relay should provide next to its identity (i.e. User Info ID), a fresh nonce N_Relay to the Remote UE during discovery.
For this solution, it is assumed that for security protection of the discovery messages a solution that meets the requirements for restricted discovery in KI#1 is used, whereby a DUSK/DUCK can be used to protect the Relay Service Code and User Info ID from being sent in the clear. This implies that only UE-to-Network relays that have the respective key to decrypt the discovery message from the Remote UE can decrypt the Relay Service Code and the Discoverer Info (i.e. User Info ID of the Remote UE). For further privacy protection in line with KI#11, the Remote UE needs to frequently change its layer-2 identifier used for model B solicitation messages, preferably using a different layer-2 identifier for each subsequent solicitation message. The Remote UE should also randomly pause between sending two subsequent messages and frequently change the keys to protect the messages, and if possible also interchange with soliciting other Relay Service Codes.
Step 2: Remote UE sends a Direct Communication Request to the selected relay to establish a secure PC5 unicast link for relaying. The Remote UE selects a different layer-2 ID for the Direct Communication Request from the layer-2 ID that was used in previous model B solicitation messages. In this solution, the Direct Communication Request message includes at least:
-	an identifier to identify the Remote UE (i.e. ID_Remote) such as SUCI or 5G GUTI,
-	an encrypted value or set of encrypted values representing the Relay Service Code (RSC) together with the identity of the discovered selected UE-to-Network relay (i.e. ID_Relay), and possibly other data/identities that require protection.
NOTE 4:	The details of which fields require end-to-end protection between the Remote UE and 5GC, or for which hop-by-hop is sufficient can be decided during normative phase. Whether the User Info ID of the Remote UE will be included in the Direct Communication Request message will be decided in normative phase, in alignment with SA2.
-	the nonce N_Relay received from the UE-to-Network relay,
-	a fresh nonce N_Remote generated by the Remote UE,
-	a Message Authentication Code for integrity protection of each of these parameters.
The Relay Service Code and the identity of the selected UE-to-Network relay are encrypted (together) to prevent an eavesdropper to link these identities to the Remote UE, and to ensure that only the UE-to-Network relay that is selected by the Remote UE will receive:
-	 in case of ALTERNATIVE 1: the decrypted Relay Service Code in order to retrieve the PDU session parameters
-	in case of ALTERNATIVE 2: the PDU session parameters from the network.
The keys K_enc and K_int are used to ensure the confidentiality and integrity of the message. These keys can be derived from the latest KAUSF of the Remote UE by using the key derivation function in TS 33.220 [12] and a unique distinguishing FC identifier. These keys could also be derived from the long term security material for relay connection as received in step 0a (e.g. PRUK). To ensure replay protection, other inputs to the key derivation function can include nonces N_Relay and N_Remote. Another input can be a counter so that the receiving party, i.e., the AUSF, can check that a malicious node is not replaying messages from the remote UE.
NOTE 5:	The selection of which key to use, and further details on the key derivation are left for the normative phase, as they depend on which solution(s) are chosen for key issues #4 and #9. See also NOTE 1.
NOTE 6:	In case PRUK is used to derive K_enc and K_int, the PRUK ID needs to be included as part of the Direct Communication Request message, and assuming PRUK ID is unique for each Remote UE the PRUK ID may be used as ID_Remote, instead of using the SUCI/5G-GUTI of the Remote UE.
The Message Authentication Code may be calculated as follows:
MAC (K_int, ID_Remote | N_Relay | N_Remote | ENCRYPT(K_enc, RSC | ID_Relay))
where ""|"" indicates concatenation.
Step 3a: Upon receiving the Direct Communication request, the UE-to-Network relay verifies the presence of its nonce N_Relay, and verifies its freshness.
Step 3b: If the nonce is valid, fresh and not repeated in a short timeframe, the UE-to-Network relay issues a NAS Relay Authorization Request/Key Request to its AMF. In this solution, the UE-to-Network relay includes ID_Remote, the encrypted value of the Relay Service Code together with the identity of the selected UE-to-Network relay (e.g. ENCRYPT(RSC | ID_Relay)), the nonces and the Message Authentication Code received in step 2 in the NAS Relay Authorization Request/Key Request.
Step 4a: The UE-to-Network relay's AMF selects the AUSF/UDM/PKMF based on ID_Remote (e.g. SUCI/5G-GUTI of the Remote UE) and then together with the AUSF/UDM/PKMF derive K_enc and K_int based on ID_Remote and the received nonces, and then decrypt and verify the integrity of the message fields. To this end, the AMF may need to send the information received in the NAS Relay Authorization Request/Key Request to the respective AUSF, which after verifying the integrity and decrypting the value, returns the decrypted RSC and ID_Relay to the AMF. Subsequently, the AMF can verify if the ID_Relay matches the identity of the UE-to-Network Relay from which the message was received. Otherwise, the AMF breaks off the procedure if these do not match.
Step 4b: The UE-to-Network relay's AMF together with the selected AUSF/UDM/PKMF authenticate the Remote UE and verify if the Remote UE and the selected Relay UE are authorized to set up a relay connection for the given Relay Service Code (RSC) and generate the respective key material for the remote UE and selected UE-to-Network relay. Details of this procedure can be found in the respective solution for key issues #4 and #9.
Step 5: In this solution, after it has been verified that the relay connection is authorized for the respective relay service code in step 4, the UE-to-Network relay's AMF performs the following additional steps:
a)	AMF selects the PCF based on ID_Remote and requests the PCF to provide a different value serving as an alias for the original Relay Service Code [See NOTE 2] for the Remote UE to be used instead of the Relay Service Code value that was used during discovery and connection setup. There are two options here:
-	Option 1: the alias value is chosen to be one of the values in the set of spare Relay Service Code values that are already provisioned to UE-to-Network relays in step 0b. In this case, all UE-to-Network relays that are already provisioned with this spare Relay Service Code value can be discovered and used by the Remote UE without any update procedures of the UE-to-Network relays involved, and without affecting the discovery and connection setup of other Remote UEs that are still using the original Relay Service Code.
-	Option 2: the alias value is chosen to be a new value for the respective Relay Service Code. In this case, all involved UE-to-Network relays using the respective Relay Service Code need to be provided with the new alias for the respective Relay Service Code. The provisioning procedure as described in step 0b (in this case initiated by the network, e.g. through UE configuration update procedure) can be used for providing the alias to the UE-to-Network relays, which can add the provided alias to a list of aliases for the respective Relay Service Code.
The PCF should encrypt this Relay Service Code alias for the Remote UE in a manner that it cannot be decrypted by the UE-to-Network relay (e.g. using a key derived from the latest KAUSF of the Remote UE as in Step 2).
The PCF may also determine a new User Info ID for the Remote UE and include it as well in its response to the AMF, whereby the new User Info ID should also be encrypted in a manner that it cannot be decrypted by the UE-to-Network relay.
[Not shown in figure] Assuming the security context of the Remote UE has not been transferred to the UE-to-Network Relay's AMF, the UE-to-Network relay's AMF may contact the Remote UE's AMF, which should prepare a fresh 5G-GUTI for the Remote UE to use for subsequent discovery and connection setup over PC5 for further privacy protection. The Remote UE's AMF may encrypt the fresh 5G-GUTI using the latest Kamf for the Remote UE.
The following step only gets executed in case of ALTERNATIVE 2:
a)	AMF retrieves from the PCF the PDU session parameters associated with the requested Relay Service Code (to be returned to the UE-to-Network relay).
Step 6: In case of ALTERNATIVE 1: The UE-to-Network relay's AMF adds the decrypted Relay Service Code and the encrypted and integrity protected new Relay Service Code alias and User Info ID received from the PCF for the Remote UE (as received in step 5a) and, if received from the Remote UE's AMF, a fresh 5G-GUTI to the NAS Relay Authorization Response/Key Response message to be sent back to the UE-to-Network Relay
In case of ALTERNATIVE 2: The UE-to-Network relay's AMF adds the PDU session parameters for the requested Relay Service Code (as received in step 5b) and the encrypted and integrity protected new Relay Service Code alias and User Info ID received from the PCF for the Remote UE (as received in step 5a) and, if received from the Remote UE's AMF, a fresh 5G-GUTI to the NAS Relay Authorization Response/Key Response message to be sent back to the UE-to-Network Relay.
Step 7a/b: UE-to-Network relay uses the information received in step 6 to complete the secure link setup between the Remote UE and the UE-to-Network relay. In this solution, the UE-to-Network relay adds the encrypted Relay Service Code alias and User Info ID received for the Remote UE) to the Direct Security Mode Command as an additional parameter.
Step 8: In this solution, the Remote UE updates its list of relay service codes and the aliases based on the encrypted Relay Service Code alias it received in the Direct Security Mode command, and updates its User Info ID with the new value received. The Remote UE will use the received alias for the Relay Service Code and User Info ID in subsequent discovery and/or Direct Communication setup requests.
Step 9: During or after secure connection setup over PC5 is completed, the UE-to-Network relay configures/initiates the PDU session used for relaying with the PDU session parameters (received in step 6) related to the Relay Service Code.
Step 10: The UE-to-Network relay can now start relaying data from the Remote UE to the network via the selected UE-to-Network relay. During the time the Remote UE is connected to the UE-to-Network relay, the Remote UE and UE-to-Network relay need to regularly run the Link Identifier Update procedure as defined in TS 33.536 [8] to change the L2 identifiers of the UEs involved in the PC5 unicast link
NOTE 7:	In order to allow Remote UEs that have not been updated with a new Relay Service Code/alias to discover the UE-to-Network relay, the UE-to-Network relay needs to respond to both the original Relay Service Code(s) and the new alias(es) in Model B discovery. In case of Model A discovery, the UE-to-Network relay can broadcast both the original Relay Service Code(s) and the spare Relay Service Code value(s)/alias(es). At some point in time, the UE-to-Network relays and other Remote UEs may need to be updated as well (e.g. to renew the authorization policies for relay service codes or after all spare relay service code values have been used). This can be done independently using the authorization and provisioning procedure as described in steps 0a and 0b.",TR 33.847,6.32.2,all_images/image_396.png,Procedural call flow for updating relay service codes to mitigate privacy issues
"When the commercial applications are dependent on the VPLMNs (Visiting PLMNs), i.e. the Remote UE only connects to the relays (i.e. UE-to-network relays) that are being served by some specific PLMNs, the Remote UE sends key request to the 5GDDNMF of its HPLMN and provides a list of VPLMN ID's, then its 5GDDMNF (5GDDNMF of the Remote UE) will contact the 5GDDMNFs of the VPLMNs identified by the VPLMN ID's to get the discovery keys. The UE-to-network relay gets the discovery key in the same way as the Remote UE.
A 5G PKMF is an NF located in a UE-to-network relay's HPLMN which can handle the management of discovery keys for discovering a UE-to-network relay.
The procedures are shown below:
Figure 6.35.2.1-1: Discovery key provisioning (Commercial applications are dependent on the VPLMNs)
Step 0: The Remote UE connects to the network and gets authorized to be a Remote UE. The Remote UE also gets the address of the 5GDDNMF of its HPLMN.
NOTE 1:	Whether the Remote UE ID consists of one or more of the following parameters: ProSe application id, ProSe application user id and/or GPSI of the Remote UE is for SA2 to decide.
NOTE 2:	The Remote UE will be provisioned with a list of VPLMN IDs by the PCF, from which the Remote UE can obtain discovery keys.
Step 1: The Remote UE establishes a secure connection with its 5GDDNMF of the Remote UE of its HPLMN. The Remote UE ID is authenticated and authorized by the 5GDDNMF of the Remote UE. As this connection is established in the user plane, the same mechanism as used to protect the PC3 interface can be re-used. Either solution #5 or solution #11 can be used for securing the connection.
NOTE 3:	The VPLMN 5G DDNMF needs to trust that the HPLMN 5G DDNMF has performed the authorization of the Remote UE to use this relay service.
Step 2: The Remote UE sends the key request to its 5GDDNMF of its HPLMN to get the discovery key. The key request includes at least the following information: the list of VPLMN IDs that the Remote UE will potentially visit (note that the list of VPLMN IDs can also include its HPLMN ID), the Remote UE ID, ProSe application ID and Relay service code(s).
Step 3: The 5GDDNMF of the HPLMN of the Remote UE checks if the Remote UE can consume or provide relay service in those VPLMNs.
Step 4: If the check in step 3 is successful, then the 5GDDNMF in the HPLMN of the Remote UE sends the key request to the 5GDDNMF of every VPLMN in the list.
Step 5: For every VPLMN in the VPLMN list, its 5GDDNMF receives the key request sent by the 5GDDNMF of the HPLMN of the Remote UE. The 5GDDNMF checks if the Remote UE can consume or provide relay service in the VPLMN. If the check is successful, the 5GDDNMF will generate the discovery key corresponding to the relay service code and its PLMN ID. If the key management is done by another NF (network function) or a PKMF, the 5GDDNMF will contact that NF or PKMF to get the discovery key.
NOTE 4:	When and how often the discovery keys need to be generated is left for normative work.
Step 6: For every VPLMN in the VPLMN list, its 5GDDNMF sends the key response to the 5GDDNMF of the HPLMN of the Remote UE. The key response message includes at least the following information: PLMN ID, Remote UE ID, ProSe application ID, Relay service code, Discovery key.
Step 7: After receiving the key response from other 5GDDNMF, the 5GDDNMF of the HPLMN of the Remote UE sends the key response to the Remote UE. The key response message includes at least the following information: VPLMN IDs, Remote UE ID, ProSe application ID, Relay service code(s), Discovery keys.",TR 33.847,6.35.2.1,all_images/image_397.png,Discovery key provisioning (Commercial applications are dependent on the
"In this scenario, the procedure for the Remote UE is the same as clause 6.35.2.1. The PLMN list sent in step 1 in clause 6.35.2.1 indicates HPLMNs of the UE-to-network relays that the Remote UE wants to discover. When a 5GDDNMF receives the key request, it checks if the Remote UE can discover the relay belonging to the corresponding PLMN.
In this scenario, the procedure for the UE-to-network relay is simpler than clause 6.35.2.1. The 5GDDNMF of the UE-to-network relay does not need to contact 5GDDNMFs in other PLMNs. The 5G PKMF is an NF located in UE-to-network relay's HPLMN. The procedure is shown below.
Figure 6.35.2.2-1: Discovery key provisioning (Commercial applications are dependent on the HPLMN of the Relays)
Step 0: The UE-to-network relay connects to the network and gets authorized to be a relay. The UE-to-network relay also gets the address of the 5GDNNMF of its HPLMN and the Relay Service Code.
NOTE 1:	Whether the Remote UE ID consists of one or more of the following parameters: ProSe application id, ProSe application user id and/or GPSI of the UE-to-network relay is for SA2 to decide.
Step 1: The UE-to-network relay establishes a secure connection with its 5GDDNMF of the UE-to-network relay of its HPLMN. The UE-to-network relay ID is authenticated and authorized by the 5GDDNMF of the UE-to-network relay. As this connection is established in the user plane, the same mechanism as used to protect the PC3 interface can be re-used. Either solution #5 or solution #11 can be used for securing the connection.
Step 2: The UE-to-network relay sends the key request to its 5GDDNMF of its HPLMN to get the discovery key. The key request includes at least the following information: optionally its own HPLMN ID, UE-to-network relay ID, ProSe application ID and Relay service code.
Step 3: The 5GDDNMF of the HPLMN of the UE-to-network relay checks if the UE-to-network relay can consume or provide relay service in this PLMN.
Step 4: If the check in step 3 is successful, then the 5GDDNMF will generate the discovery key corresponding to the relay service code and its PLMN ID. If the key management is done by another NF (network function) i.e. 5G PKMF, the 5GDDNMF will contact that NF to get the discovery key.
NOTE 2:	When and how often the discovery keys need to be generated is left for normative work.
Step 5: The 5GDDNMF sends the key response to the UE-to-network relay. The key response message includes at least the following information: optionally the PLMN ID, UE ID, ProSe application ID, Relay service code, Discovery key.
NOTE 3:	The PLMN ID in step 2 and step 5 is optional since the 5GDDNMF knows its own PLMN ID.",TR 33.847,6.35.2.2,all_images/image_398.png,Discovery key provisioning (Commercial applications are dependent on the HPLMN
"Group member discovery is a type of restricted discovery and is expected to be supported in coverage and out of coverage. Group member discovery uses provisioned keys to support integrity, confidentiality and non-trackability of the discovery messages. A discovery root key from which other keys can be derived is used to secure over the air discovery and communications. This root key can be provisioned by the 5G DDNMF and/or by the 5G PKMF – this clarification is left for the normative stage.
The solution follows that of TS 33.303 [2], where for both public safety discovery scenarios – group member discovery and relay discovery – the same solution is provided: a Public Safety Discovery Key (PSDK) is provisioned as the root key that is used for the protection of the Public Safety Discovery messages, and is associated with one or more Application Layer Group IDs or respectively Relay Service Codes (RSCs). Both of these identifiers are defined in TS 23.303 [5].
The procedures are shown below for Group Member Discovery.
Figure 6.37.2.1-1: Discovery key provisioning for group member discovery, public safety case
Step 0: The UE connects to the network and obtains authorization from the PCF/ProSe App Server to perform Group Member discovery. The UE also gets the address of the 5GDDNMF of its HPLMN and/or of the 5G PKMF. Besides the security policy, the following additional parameters are sent to the UE: a set of one or more (ProSe) Layer-2 Group ID, User Info, Application Layer Group ID and their validity times.
NOTE 1:	This step is briefly described in TS 23.304 [3].
Step 1: The UE establishes a secure connection with the 5GDDNMF or the 5G PKMF of its HPLMN. The UE ID is authenticated and authorized by the 5GDDNMF or the 5G PKMF.
NOTE 2:	As this connection is established on the user plane, the same mechanism as used to protect the PC3 interface can be re-used. Either solution #5 or solution #11 can be used for securing the connection.
Step 2: The UE sends a discovery key request to the 5GDDNMF or the 5G PKMF of its HPLMN. In the key request includes at least the following information: UE ID, set of one or more Application Layer Group IDs and their validity times.
Step 3: The 5GDDNMF or the 5G PKMF checks whether the UE is authorized for group member discovery.
Step 4: If the check in step 3 is successful, then the 5GDDNMF or the 5G PKMF generates one or more Public Safety Discovery Keys (PSDK1… PSDKn) corresponding to the Application Layer Group ID and its PLMN ID. More than one PSDK may be generated, but the overall validity time should match the validity times of the corresponding set of Application Layer Group IDs of Step 2. The Expiry Time of the PSDK needs to be set such that the keys for later periods have a longer expiration period. PSDKs that have not expired can be used for discovery in out of coverage cases.
NOTE 3:	When and how often the discovery keys need to be generated is left for normative work.
NOTE 4:	Could you please rephrase the sentence in order to avoid the use of must (highlighted within the text) or any other wording which would imply a requirement (i.e. ""has to"", ""have to"" and ""required to"")?
The security keys in the Code-Sending Security Parameters of discoverer UE and the security keys in the Code-Sending Security Parameters of discoveree UE needs to be generated from two different PSDKs to avoid impersonation attacks in certain discovery configurations.
Step 5: The 5GDDNMF or the 5G PKMF sends the key response to the UE. The key response message includes at least the following information: UE ID, PSDK identifier(s), PSDK(s), validity time(s).",TR 33.847,6.37.2.1,all_images/image_399.png,"Discovery key provisioning for group member discovery, public safety case"
"The procedures are similar to the ones for Group Member Discovery. For Relay discovery, the procedures for the relay discovery are identical, with the following exceptions:
-	The UE is now the Remote UE or the UE-to-network Relay.
-	Instead of the parameter Application Layer Group ID, the Relay Service Code is used.
-	Instead of Layer-2 Group ID, the Destination Layer-2 ID is used.
NOTE:	In Step 5, the 5G DDNMF or 5G PKMF can provision the UE with a subset of keys derived from a PSDK instead of with the PSDK itself. For instance, instead of distributing a PSDK to a UE, the UE is only provisioned with the DUCK and/or DUSK and/or DUIK, derived from the PSDK.
Figure 6.37.2.2-1: Discovery key provisioning for relay discovery, public safety case
6.37.3	Evaluation
The solution addresses key issues #1, and partially key issues #2, and #4 in the following way. Authorization for the UE to act as a group member, or UE-to-network relay, or Remote UE is provided by the PCF/ProSe App Server. The PCF/ProSe App Server provisions both policy as well as a group member and relay discovery parameters, along with their validity times. In addition, this solution describes how the UE obtains discovery keying material to support Group Member Discovery, in coverage and out of coverage. Lastly, the solution describes how the Remote UE and the UE-to-network Relay retrieve the discovery keying material for the corresponding Relay Service Code(s). This solution is intended for Public Safety services.
The following observations are made:
The UE is provisioned by the PCF/ProSe App Server with the address of the 5G DDNMF and/or the 5G PKMF.
This solution has no impact on the RAN or the network nodes AMF, AUSF.
In this solution, the 5G DDNMF, or another NF – the 5G PKMF (located in the UE's HPLMN or external to it), handles the management of discovery keys for discovering a group member UE or a UE-to-network Relay.
The 5G DDNMF is defined in TS 23.304 [16] in the architecture, with reference points and services provided.
The NF - 5G PKMF is not defined, which manages discovery keys, in the architecture for the Group member discovery and UE-to-network relay scenarios as proposed in this solution, but SA2 did not define the PKMF in LTE either.
In LTE, the PKMF is only used for Public Safety. This solution proposes to reuse the logic of the 5G DDNMF (or the ProSe Function in LTE) or the 5G PKMF which is part of the PLMN.
Note that the security material for relay discovery is not provisioned by the PCF/ProSe App Server, but by the 5G DDNMF or 5G PKMF.
Key issue #1 requires that ""The entity which receives a restricted discovery message on the PC5 interface needs to be able to verify the source authenticity."" Source authenticity means that the receiver can verify that a message originates from a (specific) sending UE. In coverage use cases, if the primary key PSDK is delivered to the UEs, source authenticity cannot be guaranteed The reason is that the receiving UE can impersonate the sending UEs since the receiving UEs always have access to the DUIK (since it is generated from the PSDK) used to compute the MIC. In this situation there is a risk of device impersonation when:
-	the MIC of the restricted discovery message is computed from a common DUIK to support multiple receiving devices; and
-	one or more of those receiving devices (remote UEs) fall under the control of malicious parties.
This solution allows provisioning a device performing relay discovery without the DUIK. This allows for an ""asymmetric"" configuration in which only a sending UE (e.g., a single device or a single type of device, e.g., announcing UEs) is provisioned with the DUIK while the rest of receiving devices (e.g., monitoring UEs) do not have access to the DUIK. The receiving UEs can rely on match reports to verify the integrity of the discovery messages. This configuration ensures that a sending UE cannot be impersonated by a receiving UE, and thus, allows for source authenticity as required in KI #1. This configuration is only applicable to relay and remote UEs that are in coverage.",TR 33.847,6.37.2.2,all_images/image_400.png,"Discovery key provisioning for relay discovery, public safety case"
"The assumption is that the 5G ProSe remote UE and U2N relay have already been authorized by the network to act as remote UE and U2N relay respectively during their registration, and have discovered each other.
Figure 6.41.2.3-1: Protection of 5G ProSe Indirect Network Communication via L3 U2N Relay
1.	The Remote UE selects the L3 U2N Relay to establish a connection for indirect network communication. The Remote UE sends a Direct Communication Request message to initiate the PC5 link establishment procedure.
2.	The U2N Relay sends a Relay Key Request (including the Relay Service Code) to the network for the authorization of the U2N relay and remote UE according to the RSC, as well as the generation of the PC5 link root key (e.g. 5G_KNRP) and its relevant parameters (e.g. 5GPRUK ID, 5G_KNRP Freshness, 5GPRUK_Info, etc.).
3.	The U2N Relay sends a Direct Security Mode Command to the Remote UE, including the relevant parameters for deriving the PC5 link root key, and derives the session keys for PC5 signalling protection, i.e. the Direct Security Mode Command is protected.
4.	The Remote UE derives the PC5 link root key based on the parameters received from the U2N relay, and then derives the session keys for PC5 signalling protection.
5.	The Remote UE sends Direct Security Mode Complete message to U2N Relay, which is protected by the session keys. By this step, the signalling security of the PC5 link is established.
6.	As per TS 23.304 [16], if there is no PDU Session associated with the RSC or a new PDU Session for relaying is needed, the U2N Relay initiates a new PDU session establishment procedure for relaying before completing the PC5 connection establishment.
7.	As per TS 33.501 [14] and TS 23.502 [10], the SMF sets the UP security policies for the PDU session for relaying requested by the U2N Relay, and provides the UP security policies to the NG-RAN.
8.	The NG-RAN activates Uu UP security protection based on the UP security policies received from the core network.
9.	The NG-RAN indicates the Uu UP security activation status to the relay UE using RRC Connection Reconfiguration procedure, according to TS 33.501 [14]. Meanwhile, the NG-RAN sends N2 PDU Session Response to the AMF.
10.	The U2N relay activates its Uu UP security based on the security activation indication received from the NG-RAN. From this step on, the Uu UP security in Figure 6.Y.2.1-1 is protected based on the UP security policies set for the relayed service.
11.	The U2N relay further activates its PC5 UP security based on its Uu UP security activation status for alignment.
12.	The U2N relay sends the Direct Communication Accept message to the Remote UE to accept the PC5 connection establishment, which includes the PC5 UP security activation indication. The whole message is protected with PC5 signalling security, hence the PC5 UP security activation indication sent from the relay is protected. Meanwhile, the U2N relay sends the Remote UE Report to its SMF.
13.	The Remote UE activates its PC5 UP security according to the PC5 UP security activation indication received from the U2N relay. From this step on, the PC5 UP security in Figure 6.41.2.1-1 is protected based on the UP security policies set for the relayed service.
14.	The service data relayed between the Remote UE and network over the PC5 link and Uu link are now sent with protection based on the UP security policies set by the core network.
With the above procedure, the integrity, confidentiality and anti-replay protection between the Remote UE and the 3GPP network can be supported through consistent enforcement of UP security policies between the Remote UE and the network for the relayed service, as well as the aligned security protection for Uu signalling and PC5 signalling.",TR 33.847,6.41.2.3,all_images/image_401.jpeg,Protection of 5G ProSe Indirect Network Communication via L3 U2N Relay
"Figure 6.1.2-1: Authentication/Authorization framework for 5GMSGS client and MSGin5G server
Step 1:	SIM-C establishes a secure tunnel with the SIM-S. In this step the SIM-C provides the 5GMSGS UE identifier in case to associate the SIM-C with the 5GMSGS client.
Step 2:	SIM-C sends an OpenID Connect Authentication Request to the SIM-S. The request contains an indication of authentication methods supported by the UE.
NOTE 1:	This solution works only if OpenID Connect protocol is supported by the system.
Step 3: User Authentication is performed between the SIM-C and the SIM-S. On receiving OpenID Connect Authentication Request, SIM-S provides HTML page to the SIM-C.
Step 4:	SIM-C authenticates itself by giving username and password.
NOTE 2:	The primary credentials for user authentication (e.g., username/password) are based on MSGin5G service provider policy. The method chosen by the service provider is neither defined nor limited to the example (username/password) provided in this solution.
Step 5: SIM-S verifies the username and password and authenticates the UE.
Step 6: SIM-S sends an OpenID Connect Authentication Response to SIM-C containing an authorization code (AuthCode).
Step 7: SIM-C sends an OpenID Connect Token Request to the SIM-S, passing the AuthCode.
Step 8: SIM-S sends an OpenID Connect Token Response to the UE containing an access token (each uniquely identifies the user of the MSGin5G service). The access token is used by the 5GMSGS UE client to authorize the communication between the 5GMSGS UE client and the MSGin5G server. The access token and ID-token format is the same as the format defined in TS 33.434, Annex A.2.1 and A.2.2.
Step 9: 5GMSGS UE client gets the access token from the SIM-C.
Step 10: As a procedure for SEAL key management, key material for establishing the IPsec tunnel is acquired by both MSGin5G server and 5GMSGS Client. The key material here could be the credentials for IKEv2 mutual authentication (for example Root certificate of CA or shared secret).
A secure IPSec tunnel is established between 5GMSGS UE client and MSGin5G Server.
Step 11: The 5GMSGS UE client initiates application registration procedure with the MSGin5G server, including the access token obtained from SIM-S at step 6 required for the 5GMSGS Client to register to the MSGin5G Server.
The request also includes a 5GMSGS Client Profile for the 5GMSGS Client initiating the registration request. The 5GMSGS client profile includes UE ID, 5GMSGS Client ports, 5GMSGS Client ID, 5GMSGS Client capabilities.
Step 12: The authorization check for the application registration request is performed by verification of the access token issued by the SIM-S. The MSGin5G server obtains the access token validation service from the SIM-S.
Step 13: MSGin5G server sends the application accept or reject response based on the result of access token validation.
NOTE 3: 	Whether SEAL supports handling 5GMSGS identifiers is not addressed in the present document.",TR 33.862,6.1.2,all_images/image_402.jpeg,Authentication/Authorization framework for 5GMSGS client and MSGin5G server
"Figure 6.2.2-1: Authentication/Authorization framework for 5GMSGS UE client and MSGin5G server using secondary authentication
1. The UE registers to the network and perform the primary authentication procedure.
2. When the UE triggers the MSGin5G service it sends the PDU session establishment request to the AMF to set up the PDU session for the MSGF.
3-6. The following steps 3, 4, 5, 6 are the same as in clause 11.1.2 of TS 33.501 [5]. The secondary authentication procedure is performed. The SMF should trigger EAP Authentication procedure and perform the role of the EAP Authenticator. The MSGF is the EAP server (AAA) of the DN.
7-8. After the successful completion of the secondary authentication procedure, the MSGF sends EAP Success message to the SMF including the registration response.
9. The SMF sends a Namf_Communication_N1N2MessageTransfer to the AMF with the EAP success message.
10. The AMF forwards PDU Session Establishment Response message along with EAP Success to the UE.",TR 33.862,6.2.2,all_images/image_403.jpeg,Authentication/Authorization framework for 5GMSGS UE client and MSGin5G server
"Figure 6.5.2-1: Authentication and Authorization between 5GMSGS UE and MSGin5G Server
Step 1-2: The UE performs the procedures (for example, Initial Registration procedure) as defined in TS 23.502 [10] to get the 5GC network access. At the end of the network access authentication procedure (Primary authentication and key agreement TS 33.501 [5], clause 6.1), the UE and the AMF are in possession of the key KAMF derived from KSEAF.
The UE and AMF performs the capability exchange procedure and agree upon the method of authentication for MSGin5G service during PDU session establishment.
Step 3: Then the UE initiates the Initial service provisioning procedure with the SEAL server.
Step 4: SEAL server sends a key request to the designated AMF. The AMF/SEAF derives the KMSG from the KSEAF/KAMF. The SEAL server identifies the AMF using the 5G-GUTI which has the GAUMI which uniquely identifies one AMF.
Step 5a-5b: The UE derives the KMSG key for MSGin5G service, whenever there is a trigger to get MSG service. Based on the UE's capability to support MSGin5G service, the SEAF/AMF derives the KMSG. Key derivation step is skipped, if the UE and AMF holds a valid KMSG.
Step 6: After key material (KMSG) is generated, the SEAF/AMF sends the generated KMSG and ngKSI to the SEAL server together with UE ID and/or SUPI and/or MSGin5G service ID of the 5GMSGS client in the key response. The SEAL server stores the latest information sent by the SEAF/AMF.
Step 7: Once KMSG is established, PSK is generated from KMSG.
Step 8-10: SEAL server sends the initial service provisioning response to the 5GMSGS client. On receiving the initial service provisioning response, the 5GMSGS client derives the KMSG-PSK. On successful initial service provisioning procedure, the 5GMSGS client and SEAL server establishes a TLS session using pre-shared key KMSG-PSK.
Step 11-14: On successful TLS session establishment the 5GMSGS client sends a trigger message to the SEAL client to trigger an access token request. Accordingly, SEAL client sends an application token request to the SEAL server. SEAL server provides the SEAL client with an access token. The acquired access token is shared with 5GMSGS client.
Step 15: Before sending the access token for authorization to the MSGin5G server, the 5GMSGS client establishes a secure channel using certificates.
Step 16: The 5GMSGS client sends the access token in an application registration request to the MSGin5G server along with the MSGin5G service ID.
Step 17-19: SEAL server validates the received access token and the MSGin5G server validates the service request by validating the MSGin5G service ID. On successful verification MSGin5G server sends the application registration response.",TR 33.862,6.5.2,all_images/image_405.jpeg,Authentication and Authorization between 5GMSGS UE and MSGin5G Server
"Figure 6.6.2-1: Procedure for authentication and authorization between legacy UE and MSGin5G server
Step 1-2: The UE performs the procedures (for example, Initial Registration procedure) as defined in TS 23.502 [10] to get the 5GC network access. At the end of the network access authentication procedure (Primary authentication and key agreement in TS 33.501 [5], clause 6.1), the UE and the AMF are in possession of the key KAMF derived from KSEAF.
The UE and AMF performs the capability exchange procedure and agree upon the method of authentication for MSGin5G service during the PDU session establishment.
Step 3: The UE initiates the Initial service provisioning procedure with the SMSF.
Step 4: SMSF sends a key request to the designated AMF. The AMF/SEAF derives the KMSG from the KSEAF/KAMF. The SMSF identifies the AMF using the 5G-GUTI which has the GAUMI which uniquely identifies one AMF.
Step 5a-5b: The UE derives the KMSG key whenever there is trigger to get MSG service. Based on the UE's capability to support MSGin5G service, the SEAF/AMF derives the KMSG. Key derivation step is skipped, if the UE or AMF holds a valid KMSG.
Step 6: After key material (KMSG) is generated, the SEAF/AMF sends the generated KMSG and ngKSI to the SMSF together with UE ID and/or SUPI and/or MSGin5G Service ID of the UE in the key response. The SMSF stores the latest information sent by the SEAF/AMF.
Step 7: Once KMSG is derived, PSK is generated from KMSG.
Step 8-10: SMSF sends the initial service provisioning response to the UE. On receiving the initial service provisioning response, the UE derives the KMSG-PSK. On successful initial service provisioning procedure, the UE and SMSF establishes a TLS session using pre-shared key KMSG-PSK.
Step 11-12: On successful TLS session establishment the UE sends an application token request to the SMSF. SMSF provides the access token to the UE.
Step 13: The legacy UE establishes a secure connection with the Legacy 3GPP message gateway. The legacy UE registers with the MSGin5G server via legacy 3GPP message gateway. The communication between legacy UE and the gateway is out of scope of the study.
Step 14: Before sending the access token for authorization to the MSGin5G server, the gateway establishes a secure channel using certificates.
Step 15: The gateway sends the access token in an application registration request to the MSGin5G server along with the MSGin5G service ID.
Step 16-18: SMSF validates the received access token and the MSGin5G server validates the service request by validating the MSGin5G service ID. On successful verification MSGin5G server sends the application registration response.
NOTE: 	This solution can be modified to focus on the authentication between the legacy 3GPP Message Gateway and MSGin5G Server.",TR 33.862,6.6.2,all_images/image_406.jpeg,Procedure for authentication and authorization between legacy UE and MSGin5G
"Figure 6.7.2-1: Procedure for authentication and authorization between Non-3GPP UE and MSGin5G server
UE here refers to the non-3GPP UE or the non-3GPP gateway. Based on SA6specification TR 23.700-24 [2], the Service ID in non-3GPP UE is translated as the MSGin5G service ID.
Detailed procedure is provided below:
Step 1-2: The UE initiates the initial registration procedure as defined in TS 23.502 [10] to get the 5G Core network access. At the end of the network access authentication procedure (Primary authentication and key agreement (TS 33.501 [5], clause 6.1)), the UE and the AMF are in possession of the key KAMF. The UE and AMF perform the capability exchange procedure and agree upon the method of authentication for MSGin5G service during the PDU session establishment.
Step 3: Then the UE initiates the Initial service provisioning procedure with the N3IWF which acts as the key management server. The MSGin5G service Key KMSG is derived from KAMF.
Step 4: N3IWF sends a key request to the designated AMF.
Step 5a-6: AMF derives the MSGin5G service key (KMSG) from KAMF/KSEAF. The AMF sends back the derived KMSG in the key response.
Step 7-9: N3IWF derives the pre-shared key KMSG-PSK from KMSG and sends the initial service provisioning response to the UE. On receiving the initial service provisioning response, the UE derives the KMSG-PSK.
Step 10: On successful initial service provisioning procedure the UE and N3IWF establishes a TLS session using pre-shared key KMSG-PSK.
Step 11-12: On successful TLS session establishment the UE sends an application token request to the N3IWF. N3IWF provides the UE with an access token.
Step 13: The non-3gpp UE establishes a secure connection with the Non-GPP message gateway. The non-3gpp UE registers with the MSGin5G server via Non-3GPP message gateway. The communication between non-3gpp UE and the gateway is out of scope of the study.
Step 14: Before sending the access token for authorization to the MSGin5G server, the non-3gpp gateway establishes a secure channel using certificates.
Step 15: The gateway sends the access token in an application registration request to the MSGin5G server along with the MSGin5G service ID.
Step 16-18: N3IWF validates the received access token and the MSGin5G server validates the service request by validating the MSGin5G service ID. On successful verification MSGin5G server sends the application registration response.
NOTE: 	This solution can be modified to focus on the authentication between the non-3GPP Message Gateway and MSGin5G Server.",TR 33.862,6.7.2,all_images/image_407.jpeg,Procedure for authentication and authorization between Non-3GPP UE and MSGin5G
"Figure 6.9.2-1: Transport security protection for MSGin5G-1 based on AKMA
Pre-requisite: MSGin5G UE has executed primary authentication successfully with 5GC and has generated KAKMA based on AKMA procedure as specified in [10].
Step 1: MSGin5G UE sends the Application session establishment request to the MSGin5G Server, with A-KID.
Step 2: MSGin5G Server communicates with the 5G core network to obtain K5GMSG according to AKMA procedures. K5GMSG is the KAF in AKMA procedures.
Step 3: MSGin5G Server responds to the MSGin5G UE by sending the Application session establishment response.
Step 4: The MSGin5G UE and the 5G MSG Server establish the TLS security tunnel based on the key K5GMSG. The MSGin5G-1 interface is protected by TLS.",TR 33.862,6.9.2,all_images/image_408.jpeg,Transport security protection for MSGin5G-1 based on AKMA
,TR 33.924,4.4.2,all_images/image_409.png,Scenario 1: Use of GBA push challenge
,TR 33.924,4.4.2,all_images/image_410.png,Scenario 2: Use of push request to trigger GBA session
,TR 33.924,4.4.2,all_images/image_411.png,Scenario 3: linking of AA and BA sessions via session ID transferred from AA to BA
,TR 33.924,4.4.2,all_images/image_412.jpeg,Detailed flow of operations for scenario1 (GBA push)
,TR 33.924,4.4.2,all_images/image_413.png,Detailed flow of operations for scenario 2 and 3 (push message from OP/NAF or BA to
,TR 33.924,4.4.2,all_images/image_416.png,Scenario 3: Use of local link to trigger GBA session 
,TR 33.924,4.4.2,all_images/image_417.png,Scenario 4: User initiates GBA authentication 
,TR 33.924,4.4.2,all_images/image_419.png,"Detailed flow of operations for scenario 2, 3 and 4 (push message from OP/NAF or"
"The initiation of the primary authentication is shown in Figure 6.1.2-1.
Figure 6.1.2-1: Initiation of authentication procedure and selection of authentication method
The SEAF may initiate an authentication with the UE during any procedure establishing a signalling connection with the UE, according to the SEAF's policy. The UE shall use SUCI or 5G-GUTI in the Registration Request.
The SEAF shall invoke the Nausf_UEAuthentication service by sending a Nausf_UEAuthentication_Authenticate Request message to the AUSF whenever the SEAF wishes to initiate an authentication.
The Nausf_UEAuthentication_Authenticate Request message shall contain either:
-	SUCI, as defined in the current specification, or
-	SUPI, as defined in TS 23.501 [2].
The SEAF shall include the SUPI in the Nausf_UEAuthentication_Authenticate Request message in case the SEAF has a valid 5G-GUTI and re-authenticates the UE. Otherwise the SUCI is included in Nausf_UEAuthentication_Authenticate Request. SUPI/SUCI structure is part of stage 3 protocol design.
The Nausf_UEAuthentication_Authenticate Request shall furthermore contain:
-	the serving network name, as defined in sub-clause 6.1.1.4 of the present document.
NOTE 2:	The local policy for the selection of the authentication method does not need to be on a per-UE basis, but can be the same for all UEs.
The Nausf_UEAuthentication_Authenticate Request may furthermore contain:
-	Disaster Roaming service indication, as specified in TS 23.502[8] clause 4.2.2.2.
Upon receiving the Nausf_UEAuthentication_Authenticate Request message, the AUSF shall check that the requesting SEAF in the serving network is entitled to use the serving network name in the Nausf_UEAuthentication_Authenticate Request by comparing the serving network name with the expected serving network name. The AUSF shall store the received serving network name temporarily. If the serving network is not authorized to use the serving network name, the AUSF shall respond with ""serving network not authorized"" in the Nausf_UEAuthentication_Authenticate Response.
NOTE 2:	The AUSF and the UDM may be configured with Disaster Condition via OAM based on operator policy and the request by the government agencies.
For the Disaster Roaming, the AUSF shall check the local configuration and, if allowed, the AUSF sends Nudm_UEAuthentication_Get Request to the UDM.
The Nudm_UEAuthentication_Get Request sent from AUSF to UDM includes the following information:
-	SUCI or SUPI;
-	the serving network name;
-	if received from SEAF, Disaster Roaming service indication;
Upon reception of the Nudm_UEAuthentication_Get Request, the UDM shall invoke SIDF if a SUCI is received. SIDF shall de-conceal SUCI to gain SUPI before UDM can process the request.
Based on SUPI, the UDM/ARPF shall choose the authentication method.
NOTE 3:	The Nudm_UEAuthentication_Get Response in reply to the Nudm_UEAuthentication_Get Request and the Nausf_UEAuthentication_Authenticate Response message in reply to the Nausf_UEAuthentication_Authenticate Request message are described as part of the authentication procedures in clause 6.1.3.
For the Disaster Roaming, the UDM shall check the local configuration and, if allowed, the UDM proceeds with the chosen authentication method.",TS 33.501,6.1.2,all_images/image_420.jpeg,Initiation of authentication procedure and selection of authentication method
,TS 33.501,6.2.2,all_images/image_423.jpeg,Key distribution and key derivation scheme for 5G for network nodes
,TS 33.501,6.2.2,all_images/image_424.jpeg,Key distribution and key derivation scheme for 5G for the UE
"The general principle of key handling for KNG-RAN*/NH at handovers is depicted in Figure 6.9.2.1.1-1.
Figure 6.9.2.1.1-1: Model for the handover key chaining
The following is an outline of the key handling model to clarify the intended structure of the key derivations. The detailed specification is provided in sub-clauses 6.9.2.2 and 6.9.2.3.
Whenever an initial AS security context needs to be established between UE and gNB/ng-eNB, AMF and the UE shall derive a KgNB and a Next Hop parameter (NH). The KgNB and the NH are derived from the KAMF. A NH Chaining Counter (NCC) is associated with each KgNB and NH parameter. Every KgNB is associated with the NCC corresponding to the NH value from which it was derived. At initial setup, the KgNB is derived directly from KAMF, and is then considered to be associated with a virtual NH parameter with NCC value equal to zero. At initial setup, the derived NH value is associated with the NCC value one.
NOTE 1:	At the UE, the NH derivation associated with NCC=1 could be delayed until the first handover performing vertical key derivation.
NOTE 1a:	In N2 handover, when the KgNB is updated either due to KAMF change or synchronising the AS security context with the NAS security context, the KgNB is derived as specified in clauses 6.9.2.3.3 and 6.9.2.3.4 of the present document. In inter-RAT handover, the KgNB is derived as specified in clause 8.4 of the present document. In UE context modification, the KgNB is derived as specified in clause 6.9.2.2.
Whether the AMF sends the KgNB key or the {NH, NCC} pair to the serving gNB/ng-eNB is described in detail in sub-clauses 6.9.2.2 and 6.9.2.3. The AMF shall not send the NH value to gNB/ng-eNB at the initial connection setup. The gNB/ng-eNB shall initialize the NCC value to zero after receiving NGAP Initial Context Setup Request message.
NOTE 2:	Since the AMF does not send the NH value to gNB/ng-eNB at the initial connection setup, the NH value associated with the NCC value one cannot be used in the next Xn handover or the next intra-gNB/intra-ng-eNB-CU handover, for the next Xn handover or the next intra-gNB-CU/intra-ng-eNB handover the horizontal key derivation (see Figure 6.9.2.1.1-1) will apply.
NOTE 3:	One of the rules specified for the AMF in sub-clause 6.9.2.3.3 of the present document states that the AMF always computes a fresh {NH, NCC} pair that is given to the target gNB/ng-eNB. An implication of this is that the first {NH, NCC} pair will never be used to derive a KgNB. It only serves as an initial value for the NH chain.
The UE and the gNB/ng-eNB use the KgNB to secure the communication between each other. On handovers and at transitions from RRC_INACTIVE to RRC_CONNECTED states (defined in clause 6.8.2.1), the basis for the KgNB that will be used between the UE and the target gNB/ng-eNB, called KNG-RAN*, is derived from either the currently active KgNB or from the NH parameter. If KNG-RAN* is derived from the currently active KgNB this is referred to as a horizontal key derivation (see Figure 6.9.2.1.1-1) and if the KNG-RAN* is derived from the NH parameter the derivation is referred to as a vertical key derivation (see Figure 6.9.2.1.1-1).
As NH parameters are only computable by the UE and the AMF, it is arranged so that NH parameters are provided to gNB/ng-eNBs from the AMF in such a way that forward security can be achieved.
On handovers with vertical key derivation the NH is further bound to the target PCI and its frequency ARFCN-DL before it is taken into use as the KgNB in the target gNB/ng-eNB. On handovers with horizontal key derivation the currently active KgNB is further bound to the target PCI and its frequency ARFCN-DL before it is taken into use as the KgNB in the target gNB/ng-eNB.",TS 33.501,6.9.2.1.1,all_images/image_426.jpeg,Model for the handover key chaining
"The security procedure for the case where the UE registers with VPLMN AMF is described below in figure 6.14.2.1-1:
Figure 6.14.2.1-1: Procedure for providing list of preferred PLMN/access technology combinations during registration in VPLMN
1)	The UE initiates registration by sending Registration Request message to the VPLMN AMF.
2-3)	The VPLMN AMF executes the registration procedure as defined in sub-clause 4.2.2.2.2 of 3GPP TS 23.502 [8]. As part of the registration procedure, the VPLMN AMF executes primary authentication of the UE and then initiates the NAS SMC procedure, after the authentication is successful.
4-5) The VPLMN AMF invokes the Nudm_UECM_Registration message to the UDM and registers access with the UDM as per step 14a in sub-clause 4.2.2.2.2 of 3GPP TS 23.502[8].
6)	The VPLMN AMF invokes Nudm_SDM_Get service operation message to the UDM to get amongst other information the Access and Mobility Subscription data for the UE (see step 14b in sub-clause 4.2.2.2.2 of 3GPP TS 23.502 [8]).
7)	The UDM decides to send the Steering of Roaming Information, and obtains a list of preferred PLMN/access technology combinations and optional additional SoR information (e.g. SOR-CMCI and the ""Store the SOR-CMCI in the ME"" indicator), or a secured packet list as described in TS 23.122 [53].
NOTE 1: Additional SoR information (e.g. SOR-CMCI and the ""Store the SOR-CMCI in the ME"" indicator) can only be added when the AMF supports SoR transparent container.
If the UDM determines that the UE is configured to not expect to receive Steering of Roaming Information at initial registration and if the UDM determines that no change of the ""Operator Controlled PLMN Selector with Access Technology"" list stored in the UE is needed, then the UDM may not piggyback Steering of Roaming Information at all in the Nudm_SDM_Get response and hence the following steps are omitted.
8-9)	The UDM shall invoke Nausf_SoRProtection service operation message to the AUSF to get SoR-MAC-IAUSF and CounterSoR as specified in sub-clause 14.1.3 of this document. The UDM shall select the AUSF that holds the latest KAUSF of the UE.
If the HPLMN decides that the UE is to acknowledge the successful security check of the received Steering of Roaming  Information, then the UDM shall set accordingly the ACK Indication included in the Nausf_SoRProtection service operation message to signal that it also needs the expected SoR-XMAC-IUE, as specified in sub-clause 14.1.3 of this document.
NOTE 2:	At reception of Nausf_SoRProtection_Protect request from the UDM, if the SoR header is not included in the request, the AUSF constructs the SOR header, as described in clause 9.11.3.51 of TS 24.501 [35], based on the information received from the UDM, i.e. ACK Indication and list of preferred PLMN/access technology combinations or secured packet (if provided); otherwise, if the SoR header is contained in the request, the AUSF uses the received SoR header in the calculation of SoR-MAC-IAUSF..
The details of the CounterSoR are specified in sub-clause 6.14.2.3 of this document.  The inclusion of the Steering List  and the SoR header in the calculation of SoR-MAC-IAUSF allows the UE to verify that the received Steering of Roaming Information is not tampered with or removed by the VPLMN. The expected SoR-XMAC-IUE allows the UDM to verify that the UE received the Steering of Roaming Information.
10)	The UDM responds to the Nudm_SDM_Get service operation to the VPLMN AMF, which shall include the SoR transparent container as specified in clause 6.1.6.3.2 of TS 29.503 [93] if the VPLMN AMF support SoR transparent container, or shall include individual IEs comprising the ACK Indication, the list of preferred PLMN/access technology combinations or secured packet (if provided), SoR-MAC-IAUSF and CounterSoR within the Access and Mobility Subscription data. If the UDM requests an acknowledgement, it shall temporarily store the expected SoR-XMAC-IUE.
11)	If the SoR transparent container is received from the UDM, the VPLMN AMF shall include the received SoR transparent container in the Registration Accept message and send it to the UE. If the individual IEs are received from the UDM, the VPLMN AMF shall construct the SOR header based on the ACK Indication and the list of preferred PLMN/access technology combinations or  secured packet (if provided) received from the UDM and include it in the SOR transparent container as specified in clause 9.11.3.51 of TS 24.501 [35]. The vPLMN shall also include SoR-MAC-IAUSFand CounterSoR(both also received from the UDM) in the constructed SoR transparent container, and convey the constructed SoR transparent container  to the UE in the Registration Accept message.
12)	 On receiving the Registration Accept message with the SoR transparent container from the AMF the UE shall calculate the SoR-MAC-IAUSF in the same way as the AUSF (as specified in Annex A.17) on the SoR transparent container, including the CounterSoR and the SoR header, and verifies whether it matches the SoR-MAC-IAUSF value received in the Registration Accept message. Based on the SoR-MAC-IAUSF verification outcome, the behaviour of the UE is specified in TS 23.122 [53].
13) If the UDM has requested an acknowledgement from the UE and the UE verified that the SoR transparent container received in step 12 has been provided by the HPLMN, then the UE shall send the Registration Complete message to the serving AMF. The UE shall generate the SoR-MAC-IUE as specified in Annex A.18 and includes the generated SoR-MAC-IUE in a SOR transparent container in the Registration Complete message.
14)	The AMF sends a Nudm_SDM_Info request message to the UDM. If a transparent container with the SoR-MAC-IUE was received in the Registration Complete message, then if the AMF supports SoR transparent container, the AMF shall include the received SoR transparent container in SoR transparent container in the Nudm_SDM_Info request message, otherwise, the AMF shall include the SoR-MAC-IUE  in the received SoR transparent container in the Nudm_SDM_Info request message.
15)	If the HPLMN indicated that the UE is to acknowledge the successful security check of the received Steering of Roaming  Information in step 10, then the UDM shall compare the received SoR-MAC-IUE with the expected SoR-XMAC-IUE that the UDM stored temporarily in step 10.",TS 33.501,6.14.2.1,all_images/image_428.jpeg,Procedure for providing list of preferred PLMN/access technology combinations
"Figure 8.4.2-1: Handover from EPS to 5GS over N26
NOTE 1:	This procedure is based on clause 4.11.1.2.2 in TS 23.502 [8] and only includes steps and description that are relevant to security.
As the UE is connected to the EPS, the source MME has a current EPS security context for the UE. The current EPS security context may be a mapped EPS security context resulting from a previous mobility from 5GC, or a native EPS security context resulting from a primary authentication with the EPS.
1.	The source eNB sends a Handover Required message to the source MME, including UE's identity .
NOTE 2:	The source MME checks whether the UE's security capabilities and access rights are valid in order to decide whether it can initiate handover to 5GS.
2.	The source MME selects the target AMF and sends a Forward Relocation Request to the selected target AMF. The source MME includes UE's EPS security context including KASME, eKSI, UE EPS security capabilities, selected EPS NAS algorithm identifiers, uplink and downlink EPS NAS COUNTs, {NH, NCC} pair, in this message. If the source MME has the UE NR security capabilities stored, then it will forward the UE NR security capabilities as well to the target AMF.
3.	The target AMF shall construct a mapped 5G security context from the EPS security context received from the source MME. The target AMF shall derive a mapped KAMF' key from the received KASME and the NH value in the EPS security context received from the source MME as described in clause 8.6.2.
If the target AMF receives the UE 5G security capabilities, then the target AMF shall select the 5G NAS security algorithms (to be used in the target AMF for encryption and integrity protection) which have the highest priority from its configured list.
If the target AMF does not receive the UE 5G security capabilities from the source MME, then the target AMF shall assume that the following default set of 5G security algorithms are supported by the UE (and shall set the UE 5G security capabilities in the mapped 5G NAS security context according to this default set):
a.	NEA0, 128-NEA1 and 128-NEA2 for NAS signalling ciphering, RRC signalling ciphering and UP ciphering;
b.	128-NIA1 and 128-NIA2 for NAS signalling integrity protection, RRC signalling integrity protection and UP integrity protection.
The target AMF then derives the complete mapped 5G security context. The target AMF shall derive the 5G NAS keys (i.e., KNASenc and KNASint) from the new KAMF' with the selected 5G NAS security algorithm identifiers as input, to be used in AMF as described in clause A.8. The uplink and downlink 5G NAS COUNTs associated with the derived 5G NAS keys are set to the value as described in clause 8.6. 2. The ngKSI for the newly derived KAMF' key is defined such as the value is taken from the eKSI of the KASME key (i.e. included in the received EPS security context) and the type is set to indicate a mapped security context. The target AMF shall store the EPS NAS security algorithms received from the source MME in the mapped 5G security context. Similar to N2-Handover defined in Clause 6.9.2.3.3, the target AMF shall also set the NCC to zero and shall further derive the temporary KgNB using the mapped KAMF' key and the uplink NAS COUNT value of 232-1 as specified in Annex A.9.
The target AMF associates this mapped 5G Security context with ngKSI.
NOTE 3:	The target AMF derives a temporary KgNB using the mapped KAMF' instead of using the {NH, NCC} pair received from the MME. The uplink NAS COUNT value for the initial KgNB derivation is set to 232-1. The reason for choosing such a value is to avoid any possibility that the value may be used to derive the same KgNB again.
The target AMF shall create a NAS Container to signal the necessary security parameters to the UE. The NAS Container shall include a NAS MAC, the selected 5G NAS security algorithms, the ngKSI associated with the derived KAMF' and the NCC value associated with the NH parameter used in the derivation of the KAMF'.  The target AMF shall calculate the NAS MAC as described in clause 6.9.2.3.3. with the COUNT parameter set to the maximal value of 232-1.
The target AMF shall increment the downlink NAS COUNT by one after creating a NAS Container.
4.	The target AMF requests the target gNB/ng-eNB to establish the bearer(s) by sending the Handover Request message.
The target AMF sends the NAS Container created in step 3 along with, the {NCC=0, NH=derived temporary KgNB}, the New Security Context Indicator (NSCI), and the UE security capabilities in the Handover Request message to the target gNB/ng-eNB. The target AMF shall further set the NCC to one and shall further compute a NH as specified in Annex A.10. The target AMF shall further store the {NCC=1, NH} pair.
5.	The target gNB/ng-eNB shall selects the 5G AS security algorithms from the list in the UE security capabilities
The target gNB/ng-eNB shall compute the KgNB to be used with the UE by performing the key derivation defined in Annex A.11 with the {NCC, NH} pair received in the Handover Request message and the target PCI and its frequency ARFCN-DL. The target gNB/ng-eNB shall associate the NCC value received from AMF with the KgNB.The target gNB /ng-eNB shall then derive the 5G AS security context, by deriving the 5G AS keys (KRRCint, KRRCenc, KUPint, and KUPenc) from the KgNB and the selected 5G AS security algorithm identifiers as described in Annex A.8 for gNB and in Annex A.7 in TS 33.401[10].
The target gNB/ng-eNB sends a Handover Request Ack message to the target AMF. Included in the Handover Request Ack message is the Target to Source Container, which contains the selected 5G AS algorithms, the keySetChangeIndicator, the NCC value from the received {NH, NCC} pair, and the NAS Container received from the target AMF. If the target gNB/ng-eNB had received the NSCI, it shall set the keySetChangeIndicator field to true, otherwise it shall set the keySetChangeIndicator field to false.
6.	The target AMF sends the Forward Relocation Response message to the source MME. The required security parameters obtained from gNB/ng-eNB in step 5 as the Target to Source Container are forwarded to the source MME.
7.	The source MME sends the Handover Command to the source eNB. The source eNB commands the UE to handover to the target 5G network by sending the Handover Command. This message includes all the security related parameters in the NAS Container obtained from the target AMF in step 6.
8.	The UE derives a mapped KAMF' key from the KASME in the same way the AMF did in step 3. It shall also derive the 5G NAS keys and KgNB corresponding to the AMF and the target gNB/ng-eNB in step 3 and step 5. The UE shall further set the selected EPS NAS security algorithms in the 5G security context to the NAS security algorithms used with the source MME. It associates this mapped 5G security context with the ngKSI included in the NAS Container. The UE shall verify the NAS MAC in the NAS Container.
If verification of the NAS MAC fails, the UE shall abort the handover procedure. Furthermore, the UE shall discard the new NAS security context if it was derived and continue to use the existing NAS and AS security contexts.
NOTE 4: 	Void.
The mapped 5G security context shall become the current 5G security context.
9.	The UE sends the Handover Complete message to the target gNB/ng-eNB. This shall be ciphered and integrity protected by the AS keys in the current 5G security context.
10.	The target gNB/ng-eNB notifies the target AMF with a Handover Notify message.
If the UE has a native 5G security context established during the previous visit to 5GS, then the UE shall provide the associated the 5G GUTI as an additional GUTI in the Registration Request following the handover procedure. The UE shall use the mapped 5G security context to protect the subsequent Registration Request message over 3GPP access. The target AMF shall validate the integrity of the Registration Request message using the mapped security context. Upon successful validation, the target AMF shall send a context request message to the old AMF and shall include the additional GUTI and an indication that the UE is validated. Upon receiving the context request message with the indication that the UE is validated, the old AMF shall skip the integrity check and transfer the native 5G security context to the target AMF.The AMF shall retrieve the native security context using the 5G GUTI. If the AMF determines to activate the native security context, the AMF shall perform a NAS SMC procedure.
NOTE 5: It is up to AMF when to activate the native 5G security context.
If the handover is not completed successfully, the new mapped 5G security context cannot be used in the future. In this case, the AMF shall delete the new mapped 5G security context.
If the AMF has no native 5G security context available when the UE performs the Registration Request (protected by the mapped 5G security context) following the handover procedure, then the AMF via the SEAF should run a primary authentication depending on local operator policy.
The handling of security contexts in the case of multiple active NAS connections in the same PLMN’s serving network is given in clasue 6.4.2.2.",TS 33.501,8.4.2,all_images/image_432.jpeg,Handover from EPS to 5GS over N26
"NOTE:	This procedure is based on clause 4.11.1.3.2 in TS 23.502 [8] and only includes steps and descriptions that are relevant to security.
Figure 8.5.2-1: Idle mode mobility from 5G to 4G
1.	The UE initiates the TAU procedure by sending a TAU Request to the MME with a mapped EPS GUTI derived from the 5G GUTI and its EPS security capabilities. The mapped EPS GUTI contains the information of the AMF that has the latest UE context in the 5G network.
The UE integrity protects the TAU Request message using the current 5G NAS security context identified by the 5G GUTI used to derive the mapped EPS GUTI. More precisely, the UE shall compute the NAS MAC for the TAU request as it is done for a 5G NAS message over a 3GPP access. The NAS Uplink COUNT for integrity protection of the TAU request shall use the same value as the 5G NAS Uplink COUNT. Consequently, this results in an increase of the stored NAS Uplink COUNT value in the NAS COUNT pair associated with the 3GPP access. The corresponding ngKSI value of the 5G Security context is included in the eKSI parameter of the TAU Request message.
2.	Upon receipt of the TAU Request, the MME obtains the AMF address from the mapped EPS GUTI value.
3.	The MME forwards the complete TAU Request message including the eKSI, NAS-MAC and mapped EPS GUTI in the Context Request message.
4.	The AMF shall use the eKSI value field to identify the 5G NAS security context and use it to verify the TAU Request message as if it was a 5G NAS message received over 3GPP access.
5.	If the verification is successful, the AMF shall derive a mapped EPS NAS security context as described in clause 8.6.1. The AMF shall set the EPS NAS algorithms to the ones indicated earlier to the UE in a NAS SMC as described in clause 6.7.2.
The AMF shall include the mapped EPS NAS security context in the Context Response message it sends to the MME. The AMF shall never transfer 5G security parameters to an entity outside the 5G system.
6.	The UE shall derive a mapped EPS NAS security context as described in clause 8.6.1. The UE shall select the EPS algorithms using the ones received in an earlier NAS SMC from the AMF as described in clause 6.7.2. The UE shall immediately activate the mapped EPS security context and be ready to use it for the processing of the TAU Accept message in step 7.
7.	The MME compares the UE security algorithms to its configured list after it receives the Context Response message. If an algorithm change is required, the MME shall select the NAS algorithm which has the highest priority from its configured list and is also present in the UE 5G security capabilities and initiate an NAS SMC to the UE. Otherwise, step 8~10 shall be skipped.
8 - 10.	The MME and the UE performs an NAS SMC to derive new NAS keys with the new algorithms as described in Clause 7.2.8.1.2 of TS 33.401[10].
11.	The MME completes the procedure with a TAU Accept message.
After successful completion of the TAU procedure, the UE shall delete any mapped 5G security context. After deleting the mapped 5G security context, if the UE has a full non-current native 5G NAS security context then the UE shall make the non-current native 5G NAS security context the current one.
8.5.3	Initial Attach Procedure
NOTE:	This procedure is based on clause 4.11.1.5.2 in TS 23.502 [8].
The Initial Attach procedure shall use the security mechanism for the TAU procedure in clause 8.5.2.",TS 33.501,8.5.2,all_images/image_433.jpeg,Idle mode mobility from 5G to 4G
"Figure 11.1.2-1: Initial EAP Authentication with an external AAA server
This procedure concerns both roaming and non-roaming scenarios. In the non-roaming case, the V-SMF is not involved. In the HR roaming case, the V-SMF shall proxy the signalling between the AMF in the VPLMN and the H-SMF in the HPLMN. In the LBO roaming case, only one SMF in VPLMN is involved.
The following procedure is based on sub-clauses 4.2.2.2.2, 4.3.2.2.1 and 4.3.2.3 in TS 23.502 [8].
NOTE 1:	Steps 1-6 are borrowed from clause 4.2.2.2.2 and 4.3.2.2.1 TS 23.502 [8] and are for information only. Steps 7 to 15are related to authentication and are normative text.
1-3. The NG-UE registers with the network performing primary authentication with the AUSF/ARPF based on its network access credentials and establishes a NAS security context with the AMF.
4. The UE initiates establishment of a new PDU Session by sending a NAS message containing a PDU Session Establishment Request within the N1 SM container, slice information (identified by S-NSSAI) , PDU session ID and the PDN it would like to connect to (identified by DNN).
The PDU Session Establishment Request may contain SM PDU DN Request Container IE containing information for the PDU session authorization by the external DN.
5a. The AMF selects a V-SMF and sends either Nsmf_PDUSession_CreateSMContext Request or Nsmf_PDUSession_UpdateSMContext Request with the N1 SM container as one of its payload. It also forwards SUPI PDU Session ID, the received S-NSSAI, and the DNN.
5b. The V-SMF sends an Nsmf_PDUSession_CreateSMContext Responseor Nsmf_PDUSession_UpdateSMContext Response correspondingly to the AMF.
In case of a single SMF being involved in the PDU session setup, e.g. non-roaming or local breakout, that single SMF takes the role of both V-SMF and H-SMF. In this case, steps 6 and 17 are skipped.
6. The V-SMF sends an Nsmf_PDUSession_Create Request to the H-SMF.
7. The H-SMF obtains subscription data from the UDM for the given SUPI obtained from the AMF in step 5. The SMF checks the subscription data whether the secondary authentication is required and whether the UE request is allowed according to the user subscription and local policies. If not allowed, the H-SMF will reject UE's request via SM-NAS signalling and skip rest of the procedure. If secondary authentication is required, the SMF may also check whether the UE has been authenticated and/or authorized by the same DN, as indicated DNN in step 5, or the same AAA server in a previous PDU session establishment. The SMF may skip steps 8 to 15 if positive.
Note 2:	The information on a successful authentication/authorization between a UE and an SMF may be saved in SMF and/or UDM.
8. The H-SMF shall trigger EAP Authentication to obtain authorization from an external DN-AAA server. If there is no existing N4 session, the H-SMF selects a UPF and establishes an N4 Session with it. The H-SMF notifies the DN-AAA server with the GPSI, if available, and the IP address(es) of the UE allocated to the PDU Session if the PDU session is of IP PDU type or the MAC address if the PDU session is of Ethernet PDU type.
9. The H-SMF may send an EAP Request/Identity message to the UE.
10. The UE may send an EAP Response/Identity message contained within t a NAS message. The DN-specific identity shall comply with Network Access Identifier (NAI) format.
To avoid the additional round-trip in steps 9 and 10, the secondary authentication DN-specific identity may be sent by the UE in step 4. In this case, H-SMF forms an EAP Response/Identity message that contains the identity.
11. If there is no existing N4 session, the H-SMF selects a UPF and establishes an N4 Session with it.
12. The DN-specific identity, if provided by the UE, is forwarded to the UPF. The H-SMF identifies the DN AAA server based on the DN-specific identity provided by the UE and on local configuration.
The UPF shall forward the DN-specific identity within an EAP Response/Identity message to the DN AAA Server.
13. The DN AAA server and the UE shall exchange EAP messages, as required by the EAP method. In addition, it may send additional authorization information as defined in TS 23.501 clause 5.6.6.
14. After the successful completion of the authentication procedure, DN AAA server shall send EAP Success message to the H-SMF.
15. This completes the authentication procedure at the SMF. The SMF may save the DN-specific ID and DNN (or DN's AAA server ID if available) in a list for successful authentication/authorization between UE and an SMF. Alternatively, the SMF may update the list in UDM.
If the authorization is successful, PDU Session Establishment proceeds further starting at step 7a of Figure 4.3.2.2.1-1 in TS 23.502 [8].
16a-16b. The SMF initiates a N4 Session Modification procedure with the selected UPF as in steps 10a and 10b of Fig 4.3.2.2.1-1 in TS 23.502 [8].
17. The H-SMF sends an Nsmf_PDUSession_Create Response to the V-SMF. This message shall include EAP Success to be sent to the UE to V-SMF.
18. The V-SMF sends Namf_Communication_N1N2MessageTransfer to the AMF as in step 11 of Figure 4.3.2.2.1-1 in TS 23.502 [8]. This message shall include EAP Success to be sent to the UE within the NAS SM PDU Session Establishment Accept message.
19. The AMF forwards NAS SM PDU Session Establishment Accept message along with EAP Success to the UE as described in steps 12 and step 13 of Figure 4.3.2.2.1-1 in TS 23.502 [8].
The UE-requested PDU Session Establishment authentication/authorization by a DN-AAA server proceeds further as described in sub-clause 4.3.2.3 in TS 23.502 [8].",TS 33.501,11.1.2,all_images/image_434.png,Initial EAP Authentication with an external AAA server
"Figure 11.1.3-1: EAP Re-Authentication with an external AAA server
This procedure concerns both roaming and non-roaming scenarios. In the non-roaming and LBO roaming cases, only one SMF is involved. In the HR roaming case, the V-SMF shall proxy the signalling between the AMF in the VPLMN and the H-SMF in the HPLMN.
1-3	Secondary Authentication has been established according to procedures specified in clause 11.1.2, Initial EAP Authentication with an external AAA server.
Secondary Re-authentication may either be initiated by SMF or the external DN/AAA server. If Re-authentication is initiated by SMF, the procedure proceeds with step 4 (skipping steps 4a and 4b). If Re-authentication is initiated by the external DN/AAA server, the procedure proceeds with the alternative steps 4a and 4b.
4.	The SMF decides to initiate Secondary Re-Authentication.
4a. The DN AAA server decides to initiate Secondary Re-Authentication.
4b. The DN AAA shall send a Secondary Re-Authentication request to UPF, and the UPF forwards it to SMF. The Secondary Re-authentication request contains the GPSI, if available, and the IP/MAC address of the UE allocated to the PDU Session and the MAC address if the PDU session is of Ethernet PDU type.
5.	The SMF shall send an EAP Request/Identity message to the UE.
6.	The UE shall respond with an EAP Response/Identity message (with Fast-Reauth Identity).
7.	The SMF forwards the EAP Response/Identity to UPF, selected during initial authentication, over N4 interface.
This establishes an end-to-end connection between the SMF and the external DN-AAA server for EAP exchange.
8.	The UPF shall forward the EAP Response/Identity message to the DN AAA Server.
9.	The DN AAA server and the UE shall exchange EAP messages as required by the EAP method.
10.	After the completion of the authentication procedure, DN AAA server either sends EAP Success or EAP Failure message to the SMF.
11.	This completes the Re-authentication procedure at the SMF.
12-13.	If the authentication is successful, EAP-Success shall be sent to UE.
12-14.	If authentication is not successful, the SMF notifies failure to UPF. Upon completion of a N4 Session Modification procedure with the selected UPF, SMF sends EAP-Failure to UE via AMF.",TS 33.501,11.1.3,all_images/image_435.jpeg,EAP Re-Authentication with an external AAA server
"The complete service request is two-step process including requesting an access token by NF Service Consumer (Step 1, i.e. 1a or 1b), and then verification of the access token by NF Service Producer (Step 2).
Step 1: Access token request
Pre-requisite:
- The NF Service consumer (OAuth2.0 client) is registered with the vNRF (Authorization Server in the vPLMN).
- The hNRF and NF Service Producer share the required credentials. Additionally, the NF Service Producer (OAuth2.0 resource server) is registered with the hNRF (Authorization Server in the hPLMN) with optionally ""additional scope"" information per NF type.
- The two NRFs are implicitly authenticated via N32 mutual authentication of SEPPs.
NOTE: 	vSEPP to hSEPP communication is secured via N32. Only transitive trust between vNRF and hNRF can be achieved: The vNRF and vSEPP mutually authenticate, the vSEPP and hSEPP mutually authenticate, and the hSEPP and hNRF mutually authenticate. Hence, vNRF and hNRF can only implicitly authenticate each other.
- The NRF in the serving PLMN (vNRF) has authenticated the NF Service Consumer.
For SNPNs with Credentials Holder using AUSF and UDM for primary authentication, the NF Service Consumer and the vNRF are located in the SNPN while the hNRF is located in the Credentials Holder.
1a. Access token request for accessing services of NF Service Producers of a specific NF type
The following procedure describes how the NF Service Consumer obtains an access token for NF Service Producers of a specific NF type for use in the roaming scenario.
Figure 13.4.1.2.2-1: NF Service Consumer obtaining access token before NF Service access (roaming)
1.	The NF Service Consumer shall invoke Nnrf_AccessToken_Get Request (NF Instance Id of the NF Service Consumer, the requested ""scope"" including the  expected NF Service Name (s) and optionally ""additional scope"" information (i.e. requested resources and requested actions (service operations) on the resources), NF Type of the expected NF Service Producer instance, NF type of the NF Service Consumer, home and serving PLMN IDs, optionally list of NSSAIs or list of NSI IDs for the expected NF Service Producer instances, optionally NF Set ID and/or the NF Service Set ID of the expected NF Service Producer) from NRF in the same PLMN.
For SNPNs with Credentials Holder using AUSF and UDM for primary authentication, the SNPN ID of the serving SNPN is included instead of the serving PLMN ID and the SNPN ID or the PLMN ID of the Credentials Holder is included instead of the home PLMN ID.
2.	The NRF in serving PLMN shall identify the NRF in home PLMN (hNRF) based on the home PLMN ID, and request an access token from hNRF as described in clause 4.17.5 of TS 23.502 [8]. The vNRF shall forward the parameters it obtained from the NF Service Consumer, including NF Service Consumer type, to the hNRF.
3.	The hNRF checks whether the NF Service Consumer is authorized to access the requested service(s). If the NF Service Consumer is authorized, the hNRF shall generate an access token with appropriate claims included as defined in clause 13.4.1.1. The hNRF shall digitally sign the generated access token based on a shared secret or private key as described in RFC 7515 [45]. If the NF service consumer is not authorized, the hNRF shall not issue an access token to the NF Service Consumer.
The claims in the token shall include the NF Instance Id of NRF (issuer), NF Instance Id of the NF Service Consumer appended with its PLMN ID (subject), NF type of the NF Service Producer appended with its PLMN ID (audience), expected services name(s), (scope) and expiration time (expiration), and optionally ""additional scope"" information (allowed resources and allowed actions (service operations) on the resources). The claims may include a list of NSSAIs or NSI IDs for the expected NF Service Producer instances. The claims may include the NF Set ID and/or the NF Service Set ID of the expected NF Service Producer instances.
For SNPNs with Credentials Holder using AUSF and UDM for primary authentication, the SNPN ID of the serving SNPN is included instead of the NF Service Consumer's PLMN ID and the SNPN ID or the PLMN ID of the Credentials Holder is included instead of the NF Service Producer's PLMN ID.
4.	If the authorization is successful, the access token shall be included in Nnrf_AccessToken_Get Response message to the vNRF. Otherwise it shall reply based on Oauth 2.0 error response defined in RFC 6749 [43].
5.	The vNRF shall forward the Nnrf_AccessToken_Get Response or error message to the NF Service Consumer. The NF Service Consumer may store the received token(s). Stored tokens may be re-used for accessing service(s) from NF Service Producer NF type listed in claims (scope, audience) during their validity time. The other parameters (e.g., the expiration time, allowed scope) sent by NRF in addition to the access token are described in TS 29.510 [68].
1b. Obtain access token for accessing services of a specific NF Service Producer instance / NF Service Producer service instance
The following steps describes how the NF Service Consumer obtains an access token before service access to a specific NF Service Producer instance / NF Service Producer service instance.
1. The NF Service Consumer shall request an access token from the NRF for a specific NF Service Producer instance / NF Service Producer service instance. The request shall include the NF Instance Id of the requested NF Service Producer, appended with its PLMN ID, the expected NF service name and NF Instance Id of the NF Service Consumer, appended with its PLMN ID.
For SNPNs with Credentials Holder using AUSF and UDM for primary authentication, the SNPN ID of the serving SNPN is included instead of the NF Service Consumer's PLMN ID and the SNPN ID or the PLMN ID of the Credentials Holder is included instead of the NF Service Producer's PLMN ID.
2. The NRF in the visiting PLMN shall forward the request to the NRF in the home PLMN.
3. The NRF in the home PLMN checks whether the NF Service Consumer is authorized to use the requested NF Service Producer instance/NF Service Producer service instance and shall then proceed to generate an access token with the appropriate claims included. If the NF Service Consumer is not authorized, the NRF in the home PLMN shall not issue an access token to the NF Service Consumer.
The claims in the token shall include the NF Instance Id of NRF (issuer), NF Instance Id of the NF Service Consumer appended with its PLMN ID (subject), NF Instance Id of the requested NF Service Producer appended with its PLMN ID (audience), expected service name(s) (scope) and expiration time (expiration).
For SNPNs with Credentials Holder using AUSF and UDM for primary authentication, the SNPN ID of the serving SNPN is included instead of the NF Service Consumer's PLMN ID and the SNPN ID or the PLMN ID of the Credentials Holder is included instead of the NF Service Producer's PLMN ID.
4. The token shall be included in the Nnrf_AccessToken_Get response sent to the NRF in the visiting PLMN.
5. The NRF in the visiting PLMN shall forward the Nnrf_AccessToken_Get response message to the NF Service Consumer. The NF Service Consumer may store the received token(s). Stored tokens may be re-used for accessing service(s) from NF Instance Id or several NF Instance Id(s) of the requested NF Service Producer listed in claims (scope, audience) during their validity time.
Step 2: Service access request based on token verification
In addition to the steps described in the non-roaming scenario in 13.4.1.1, the NF Service Producer shall verify that the PLMN-ID (or SNPN ID) contained in the API request is equal to the one inside the access token.
Figure 13.4.1.2.2-2: NF Service Consumer requesting service access with an access token in roaming case
The NF Service Producer shall check that the home PLMN ID of audience claim in the access token matches its own PLMN identity.
For SNPNs with Credentials Holder using AUSF and UDM for primary authentication, the NF Service Producer verifies the SNPN ID of the serving SNPN contained in the API request instead of the PLMN-ID, and the SNPN ID or the PLMN ID of the Credentials Holder instead of the home PLMN ID.
The pSEPP shall check that the serving PLMN ID of subject claim in the access token matches the remote PLMN ID. If PRINS is used, this can be achieved by the pSEPP checking the PLMN ID of the serving network in the access token against the PLMN ID(s) in the N32-f context.
If the peer network is an SNPN, the pSEPP shall check that the SNPN ID of the NF Service Consumer in the access token matches the SNPN ID of the peer network.",TS 33.501,13.4.1.2.2,all_images/image_438.png,NF Service Consumer obtaining access token before NF Service access
"The complete service request is two-step process including requesting an access token by NF Service Consumer (Step 1, i.e. 1a or 1b), and then verification of the access token by NF Service Producer (Step 2).
Step 1: Access token request
Pre-requisite:
- The NF Service consumer (OAuth2.0 client) is registered with the vNRF (Authorization Server in the vPLMN).
- The hNRF and NF Service Producer share the required credentials. Additionally, the NF Service Producer (OAuth2.0 resource server) is registered with the hNRF (Authorization Server in the hPLMN) with optionally ""additional scope"" information per NF type.
- The two NRFs are implicitly authenticated via N32 mutual authentication of SEPPs.
NOTE: 	vSEPP to hSEPP communication is secured via N32. Only transitive trust between vNRF and hNRF can be achieved: The vNRF and vSEPP mutually authenticate, the vSEPP and hSEPP mutually authenticate, and the hSEPP and hNRF mutually authenticate. Hence, vNRF and hNRF can only implicitly authenticate each other.
- The NRF in the serving PLMN (vNRF) has authenticated the NF Service Consumer.
For SNPNs with Credentials Holder using AUSF and UDM for primary authentication, the NF Service Consumer and the vNRF are located in the SNPN while the hNRF is located in the Credentials Holder.
1a. Access token request for accessing services of NF Service Producers of a specific NF type
The following procedure describes how the NF Service Consumer obtains an access token for NF Service Producers of a specific NF type for use in the roaming scenario.
Figure 13.4.1.2.2-1: NF Service Consumer obtaining access token before NF Service access (roaming)
1.	The NF Service Consumer shall invoke Nnrf_AccessToken_Get Request (NF Instance Id of the NF Service Consumer, the requested ""scope"" including the  expected NF Service Name (s) and optionally ""additional scope"" information (i.e. requested resources and requested actions (service operations) on the resources), NF Type of the expected NF Service Producer instance, NF type of the NF Service Consumer, home and serving PLMN IDs, optionally list of NSSAIs or list of NSI IDs for the expected NF Service Producer instances, optionally NF Set ID and/or the NF Service Set ID of the expected NF Service Producer) from NRF in the same PLMN.
For SNPNs with Credentials Holder using AUSF and UDM for primary authentication, the SNPN ID of the serving SNPN is included instead of the serving PLMN ID and the SNPN ID or the PLMN ID of the Credentials Holder is included instead of the home PLMN ID.
2.	The NRF in serving PLMN shall identify the NRF in home PLMN (hNRF) based on the home PLMN ID, and request an access token from hNRF as described in clause 4.17.5 of TS 23.502 [8]. The vNRF shall forward the parameters it obtained from the NF Service Consumer, including NF Service Consumer type, to the hNRF.
3.	The hNRF checks whether the NF Service Consumer is authorized to access the requested service(s). If the NF Service Consumer is authorized, the hNRF shall generate an access token with appropriate claims included as defined in clause 13.4.1.1. The hNRF shall digitally sign the generated access token based on a shared secret or private key as described in RFC 7515 [45]. If the NF service consumer is not authorized, the hNRF shall not issue an access token to the NF Service Consumer.
The claims in the token shall include the NF Instance Id of NRF (issuer), NF Instance Id of the NF Service Consumer appended with its PLMN ID (subject), NF type of the NF Service Producer appended with its PLMN ID (audience), expected services name(s), (scope) and expiration time (expiration), and optionally ""additional scope"" information (allowed resources and allowed actions (service operations) on the resources). The claims may include a list of NSSAIs or NSI IDs for the expected NF Service Producer instances. The claims may include the NF Set ID and/or the NF Service Set ID of the expected NF Service Producer instances.
For SNPNs with Credentials Holder using AUSF and UDM for primary authentication, the SNPN ID of the serving SNPN is included instead of the NF Service Consumer's PLMN ID and the SNPN ID or the PLMN ID of the Credentials Holder is included instead of the NF Service Producer's PLMN ID.
4.	If the authorization is successful, the access token shall be included in Nnrf_AccessToken_Get Response message to the vNRF. Otherwise it shall reply based on Oauth 2.0 error response defined in RFC 6749 [43].
5.	The vNRF shall forward the Nnrf_AccessToken_Get Response or error message to the NF Service Consumer. The NF Service Consumer may store the received token(s). Stored tokens may be re-used for accessing service(s) from NF Service Producer NF type listed in claims (scope, audience) during their validity time. The other parameters (e.g., the expiration time, allowed scope) sent by NRF in addition to the access token are described in TS 29.510 [68].
1b. Obtain access token for accessing services of a specific NF Service Producer instance / NF Service Producer service instance
The following steps describes how the NF Service Consumer obtains an access token before service access to a specific NF Service Producer instance / NF Service Producer service instance.
1. The NF Service Consumer shall request an access token from the NRF for a specific NF Service Producer instance / NF Service Producer service instance. The request shall include the NF Instance Id of the requested NF Service Producer, appended with its PLMN ID, the expected NF service name and NF Instance Id of the NF Service Consumer, appended with its PLMN ID.
For SNPNs with Credentials Holder using AUSF and UDM for primary authentication, the SNPN ID of the serving SNPN is included instead of the NF Service Consumer's PLMN ID and the SNPN ID or the PLMN ID of the Credentials Holder is included instead of the NF Service Producer's PLMN ID.
2. The NRF in the visiting PLMN shall forward the request to the NRF in the home PLMN.
3. The NRF in the home PLMN checks whether the NF Service Consumer is authorized to use the requested NF Service Producer instance/NF Service Producer service instance and shall then proceed to generate an access token with the appropriate claims included. If the NF Service Consumer is not authorized, the NRF in the home PLMN shall not issue an access token to the NF Service Consumer.
The claims in the token shall include the NF Instance Id of NRF (issuer), NF Instance Id of the NF Service Consumer appended with its PLMN ID (subject), NF Instance Id of the requested NF Service Producer appended with its PLMN ID (audience), expected service name(s) (scope) and expiration time (expiration).
For SNPNs with Credentials Holder using AUSF and UDM for primary authentication, the SNPN ID of the serving SNPN is included instead of the NF Service Consumer's PLMN ID and the SNPN ID or the PLMN ID of the Credentials Holder is included instead of the NF Service Producer's PLMN ID.
4. The token shall be included in the Nnrf_AccessToken_Get response sent to the NRF in the visiting PLMN.
5. The NRF in the visiting PLMN shall forward the Nnrf_AccessToken_Get response message to the NF Service Consumer. The NF Service Consumer may store the received token(s). Stored tokens may be re-used for accessing service(s) from NF Instance Id or several NF Instance Id(s) of the requested NF Service Producer listed in claims (scope, audience) during their validity time.
Step 2: Service access request based on token verification
In addition to the steps described in the non-roaming scenario in 13.4.1.1, the NF Service Producer shall verify that the PLMN-ID (or SNPN ID) contained in the API request is equal to the one inside the access token.
Figure 13.4.1.2.2-2: NF Service Consumer requesting service access with an access token in roaming case
The NF Service Producer shall check that the home PLMN ID of audience claim in the access token matches its own PLMN identity.
For SNPNs with Credentials Holder using AUSF and UDM for primary authentication, the NF Service Producer verifies the SNPN ID of the serving SNPN contained in the API request instead of the PLMN-ID, and the SNPN ID or the PLMN ID of the Credentials Holder instead of the home PLMN ID.
The pSEPP shall check that the serving PLMN ID of subject claim in the access token matches the remote PLMN ID. If PRINS is used, this can be achieved by the pSEPP checking the PLMN ID of the serving network in the access token against the PLMN ID(s) in the N32-f context.
If the peer network is an SNPN, the pSEPP shall check that the SNPN ID of the NF Service Consumer in the access token matches the SNPN ID of the peer network.",TS 33.501,13.4.1.2.2,all_images/image_439.png,NF Service Consumer requesting service access with an access token in roaming
"This clause covers the scenario where the NF Service Consumer and the NRF are connected over a mutually authenticated TLS connection.
Figure 13.4.1.3.1.1-1: Authorization and service invocation procedure, for indirect communication without delegated discovery, with mutual authentication between NF and NRF at the transport layer
Discovery of the NF Service Producer:
0.	Optionally, the NF Service Consumer may discover the NF Service Producer before requesting authorization to invoke the services of the NF Service Producer. E.g. if the NF Service Consumer has not yet discovered the NF Service Producer, then it may run the discovery procedure.
NF Service Consumer authorization:
1-2.
After mutual authentication between NF Service Consumer and NRF at the transport layer, the NF Service Consumer and NRF perform the ""Access token request before service access"" procedure as described in clause 13.4.1.1. If the NF Service Consumer has already discovered the NF Service Producer, it can also perform the ""Access token request for a specific NF Service Producer/NF Service Producer instance"" procedure as described in clause 13.4.1.1.
Service request:
The NF Service Consumer, SCP, NRF and NF Service Producer perform the procedure ""Indirect Communication without delegated discovery Procedure"" described in clause 4.17.11 of TS 23.502 [8]. The following steps describe how the access token received from steps 1 and 2 is used in this procedure.
3.	If no cached data is available, the NF Service Consumer discovers the NF Service Producer via the SCP.
4.	The NF Service Consumer sends a service request for the specific service to the SCP. The service request includes the access token as received in step 2, and may include the NF Service Consumer CCA as defined in clause 13.3.8.
If the CCA is included, the NF type of the expected audience in the CCA shall contain ""NF Service Producer"".
If the NF Service Consumer allows reselection of a target NF Service Producer by the SCP, the expected audience in the CCA shall also contain NF type ""NRF"".
NOTE:	In the same deployment, the NF Service Consumer can delegate the reselection of the target NF Service Producer to the SCP for some requests, and not for other requests.
5.	The SCP selects a NF Service Producer instance, performs the API root modifications and forwards the received request to the selected NF Service Producer instance. The request contains the access token and may contain the NF Service Consumer CCA if received in step 4.
6.	To authorize the access, the NF Service Producer authenticates the service consumer NF using one of the methods described in clause 13.3.2.2 and if successful, it validates the access token as described in clause 13.4.1.1 by verifying the signature and checking if the requested service is part of the token's scope.
7.   If the checks in step 6 are successful, the NF Service Producer processes the service request and provides a service response.
8.	The SCP performs reverse API root modifications and forwards the service response.",TS 33.501,13.4.1.3.1.1,all_images/image_440.jpeg,"Authorization and service invocation procedure, for indirect communication"
"This clause covers the scenario where the NF Service Consumer use the SCP to discover and select the NF Service Producer instance that can process the service request.
Figure 13.4.1.3.2-1: Authorization and service invocation procedure, for indirect communication with delegated discovery
1.	The NF Service Consumer sends a service request to the SCP. The service request may include the NF Service Consumer's CCA as defined in clause 13.3.8.The NF Service Consumer may include an access token in the service request if it has received an access token in a previous service response. If a previously received access token has expired, the NF Service Consumer may include discovery parameters as specified in TS 29.500 [74] clause 5.2.3.2.7 in the service request.
If the CCA is included, the NF type of the expected audience in CCA shall contain ""NRF"" and ""NF Service Producer"".
2.	The SCP may perform a service discovery with the NRF. If NF Service Consumer has included an access token in step 1, or if the SCP has a cached granted access token, then SCP may reuse the access token and proceeds to step 6.
3. 	The SCP sends an access token request (Nnrf_AccessToken_Get Request) to the NRF. The access token request includes parameters as defined in clause 13.4.1.1. The access token request may include the NF Service Consumer's CCA if received in Step 1.
4.	The NRF authenticates the NF Service Consumer using one of the methods described in clause 13.3.1.2. If NF Service Consumer authentication is successful and the NF Service Consumer is authorized based on the NRF policy, the NRF issues an access token as described in clause 13.4.1.1. The NRF uses the NF Service Consumer instance ID as the subject of the access token.
5.	The NRF sends the access token to the SCP in an access token response (Nnrf_AccessToken_Get Response).
6.	The SCP sends the service request to the NF Service Producer. The service request includes an access token (i.e., received in Step 1, received in Step 5, or previously cached), and may include the NF Service Consumer's CCA if received in Step 1.
7.	The NF Service Producer authenticates the NF Service Consumer by one of the methods described in clause 13.3.2.2 and if successful, it validates the access token as described in clause 13.4.1.1.
8.	If the validation of the access token is successful, the NF Service Producer sends the service response to the SCP.
9.	The SCP forwards the service response to the NF Service Consumer. The SCP may include the access token in the service response to NF Service Consumer for possible re-use in subsequent service requests.",TS 33.501,13.4.1.3.2,all_images/image_442.jpeg,"Authorization and service invocation procedure, for indirect communication with"
"Before the Initial AMF re-routes the Registration Request (RR) message and the 5G NAS security context, the Initial AMF performs horizontal Kamf derivation of the current Kamf-0 and generates a new Kamf-1 key which is then routed via RAN to the Target AMF together with an indication of horizontal KAMF derivation (i.e. keyAmfHDerivationInd). The current Kamf-0 is not rerouted via RAN to the Target AMF. This would ensure that the Target AMF has no access to the Kamf-0 key used in the Initial AMF/old AMF.
The Initial AMF forwards the RR message, the 5G NAS security context including the Kamf-1 and the keyAmfHDerivationInd indicator unprotected to the Target AMF via RAN.
The new generated Kamf-1 key could be seen as a one-time key for the purpose of the AMF re-allocation. It is worth noting that Kamf-1 is practically useless to a legitimate RAN node since it is a NAS key that has not been put into use by any AMF in the network. The Target AMF would then be mandated to establish a new further key Kamf-2 with the UE, which is not available to the Initial AMF and the RAN.
Because the Target AMF has received the keyAmfHDerivationInd indicator, the Target AMF needs to run a NAS SMC procedure with the UE, to take the new Kamf-1 key into use with the UE. The Target AMF is also mandated to initiate a new primary authentication with the UE to derive a new Kamf-2 when it has received the RR message from the RAN. The new primary authentication procedure is protected by the Kamf-1. This step would ensure that the Initial AMF has no access to the new Kamf-2 key (i.e. the Kamf key used in the Target AMF and the UE).
As the target AMF can determine that a NAS re-route via RAN has taken place, the target AMF needs to restrict the use of the Kamf-1 only for the purpose of sending protected NAS Security Mode Command and Authentication Challenge/Request to the UE, and for receiving protected NAS Security Mode Complete and Authentication Response from the UE.
The Target AMF needs to run a new NAS SMC procedure with the UE to take the new Kamf-2 into use with the UE. The initial AMF needs to indicate to the UE to include the complete Registration Request message in the NAS Security Mode Complete message by setting the flag ""request initial NAS flag"" in the NAS Security Mode Command message. The UE includes the complete Registration Request message (sent in step 1) in the NAS Security Mode Complete message to the target AMF. This means that the target AMF can take the Registration Request message received in NAS Security Mode Complete message into use and drop the Registration Request message rerouted via RAN.
Figure 6.2.2-1: AMF re-allocation with NAS message and 5G NAS security context re-route via RAN
Figure 6.2.2-1 shows the solution steps:
Step 1:	The UE prepares a Registration Request message including a SUCI or a 5G-GUTI and slicing information which could potentially cause an AMF re-allocation such as Requested NSSAI. If the UE has a 5G NAS security context (Registration with 5G-GUTI) it includes a protected NAS container in the Registration Request message.
Step 2:	The RAN forwards the RR message to an Initial AMF.
Step 3a and 3b: These steps may only take place if UE has indicated its 5G-GUTI in the Registration Request message and there is connectivity between the initial AMF and the old AMF (cases 2.a.i and 2.b.i in clause 4.3). The Initial AMF contacts the old AMF and requests the 5G NAS security context from the old AMF. The old AMF may perform horizontal Kamf derivation of the Kamf key.
If there is no connectivity between the initial AMF and the old AMF (cases 2.a.ii and 2.b.ii in clause 4.3) and the UE has indicated its 5G-GUTI in the Registration Request message, then steps 3a and 3b are skipped and the initial AMF requests the UE identity SUCI from the UE in step 4 and then initiates primary authentication in step 5.
Step 4: The initial AMF may request UE identity SUCI from the UE.
Step 5:	The Initial AMF may initiate a new primary authentication. This step is optional. This step is needed if the UE has indicated its SUCI in the Registration Request message
Step 6:	The Initial AMF may initiate a NAS SMC. This step takes place if a prior primary authentication has taken place or if the old AMF has performed horizontal Kamf derivation of the Kamf key. If the old AMF has performed horizontal Kamf derivation of the Kamf key, then the initial AMF needs to include the keyAmfHDerivationInd indicator in NAS Security Mode Command. The Initial AMF may include the request to the UE to include the complete Registration Request message by setting the flag ""request initial NAS flag"" if the old AMF has performed horizontal Kamf derivation of the Kamf key or the Registration Request included the UE SUCI.
Step 7:	The UE includes the complete RR message sent in step 1 in the NAS Security Mode Complete message.
Step 8:	If the Initial AMF needs UE's subscription information to decide whether to reroute the Registration Request and UE's slice selection subscription information was not provided by old AMF, the AMF selects a UDM as described in TS 23.501 [2], clause 6.3.8. the Initial AMF sends Nudm_SDM_Get to UDM.
Step 9:	The UDM responds to Initial AMF with a Nudm_SDM_GetResponse. The AMF gets the Slice Selection Subscription data including Subscribed S-NSSAIs. The UDM responds with slice selection data to Initial AMF.
Step 10: If there is a need for slice selection, (see clause 5.15.5.2.1 of TS 23.501 [2]), e.g. the Initial AMF cannot serve all the S-NSSAI(s) from the Requested NSSAI permitted by the subscription information, the Initial AMF invokes the Nnssf_NSSelection_Get service operation from the NSSF by including Requested NSSAI.
Step 11: The NSSF performs the steps specified in point (B) in clause 5.15.5.2.1 of TS 23.501 [2]. The NSSF responds to Nnssf_NSSelection_Get to the Initial AMF.
Step 12: The Initial AMF decides to reroute the Registration Request message to a Target AMF via RAN. The Initial AMF optionally performs horizontal Kamf derivation of Kamf-0 to generate a new Kamf-1. The decision of the initial AMF to perform horizontal key derivation is subject to the old AMF performing horizontal key derivation. If the old AMF has performed horizontal key derivation the initial AMF does not perform one. If the Old AMF has not performed any horizontal key derivation the initial AMF performs a horizontal key derivation based on local configuration. This step would ensure that target AMF has no access to the Kamf-0 key used in Initial AMF.
Note: 	Backward security is not addressed here.
Step 13: The Initial AMF forwards the Registration Request message to the RAN. The initial AMF includes the 5G NAS security context including the uplink/downlink NAS COUNTs if no horizontal Kamf derivation took place in initial AMF in step 12. The initial AMF includes the new Kamf-1 and the keyAmfHDerivationInd indicator only if the initial AMF performed horizontal Kamf derivation in step 12.
Step 14: The RAN forwards the Registration Request message and the other parameters received in step 13 to the target AMF.
Step 15.	After receiving the Registration Request,
If SUCI is included in the Registration Request, the target AMF skips step 15 (as no additional information about established PDU sessions etc. is stored in the old AMF).
If a 5G-GUTI is included in the Registration Request and the target AMF has received a 5G NAS security context and potentially a keyAmfHDerivationInd indicator, then:
-	If there is no connectivity between the target AMF and old AMF (cases 2.a.ii and 2.b.ii in clause 4.3) , the target AMF skips step 15 (and any additional information about established PDU sessions etc. stored in the old AMF cannot be retrieved by the target AMF).
-	If there is connectivity between the target AMF and the old AMF(cases 2.a.i and 2.b.i in clause 4.3), the target AMF can fetch any additional information about established PDU sessions etc. stored in the old AMF. If the old AMF provides a 5G NAS security context to the target AMF, then the target AMF discards the 5G NAS security context provided by the old AMF.
Step 16: If the target AMF has received the keyAmfHDerivationInd indicator, then the target AMF needs to run a NAS SMC procedure with the UE, to take the new Kamf-1 key into use with the UE.
Step 17: The target AMF needs to initiate a new primary authentication with the UE to generate a new Kamf-2. The new primary authentication procedure is protected by the Kamf-1. This step would ensure that the Initial AMF has no access to the new Kamf-2 key generated between target AMF and the UE.
Target AMF determines that a NAS re-route via RAN has taken place and the target AMF uses the Kamf-1 only for the purpose of sending protected NAS Security Mode Command and Authentication Challenge/Request to the UE, and for receiving protected NAS Security Mode Complete and Authentication Response from the UE.
Step 18a-b: The target AMF needs to run a new NAS SMC procedure with the UE to take the new Kamf-2 into use with the UE. The target AMF needs to include the request to the UE to include the complete Registration Request message in the NAS Security Mode Complete message by setting the flag ""request initial NAS flag"" in the NAS Security Mode Command message. The UE includes the complete Registration Request message (sent in step 1) in the NAS Security Mode Complete message to the target AMF. This means that the target AMF can take the Registration Request message received in NAS Security Mode Complete message into use and drop the Registration Request message rerouted via RAN.",TR 33.864,6.2.2,all_images/image_446.png,AMF re-allocation with NAS message and 5G NAS security context re-route via RAN 
"The solution enables NAS security availability in the Target AMF during an AMF re-allocation and reroute (via RAN) as shown in Figure 6.4.2-1. The solution uses the AUSF involved in the authentication procedure of the UE to act as a common NF (i.e. an instance of existing NF that can be trusted and accessible to all AMFs in the serving network) to generate/store a security key in the network after a successful UE primary authentication and enable providing of AMF key when required for the Target AMF which cannot communicate with an initial AMF and/or source AMF directly. The AUSF in the home network is considered to be a trusted NF in the core network, as it will be involved during the primary authentication of the UE. Further the AUSF in the home network can provide AMF Re-allocation Security Service to the requester NF (i.e. initial AMF) by Nausf_AMFRealloc_SecurityContext service operation and can provide Key service to the requester NF (i.e. re-allocated Target AMF) by Nausf_Key service operation accordingly. The new AUSF service operation related required and optional inputs and outputs with be described during the normative phase.
The AUSF can assist to ensure NAS security context availability for the reallocated AMF. The primary authentication is run similar to TS 33.501  [3] and the AUSF stores the Kseaf before sending the Nausf_UEAuthentication_Authenticate response message to the AMF/SEAF following a successful primary authentication (i.e. as in TS 33.501 [3] clause 6.1.3.2.0 where the AUSF at step 4 generates Kseaf, at step 5 removes Kseaf from 5G AV to send 5G SE AV and finally at step 12 if authentication is successful sends Kseaf to SEAF). The message flow for enabling NAS Security for AMF re-allocation with NAS re-route via RAN using AUSF is shown in Figure 6.4.2-1.
Figure 6.4.2-1: Enabling NAS Security for AMF re-allocation with NAS re-route via RAN using AUSF
Case 1- Initial Registration:
The steps involved in the solution shown in Figure 6.4.2-1 is described as follows.
Step 1-3.	The UE sends the Registration Request to the initial AMF and the procedure can follow similar to TS 23.502 [2] clause 4.2.2.2.2 and clause 4.2.2.2.3. Where at this step, the UE and network authentication would have been successfully completed and following a successful primary authentication, the NAS security between the UE and the initial AMF would also have been successfully setup.
NOTE 1:	The UE indicates in the Registration Request the support for AMF Reallocation. The indication can be similar to the indication used in solution 1 and 3 of the present document.
Step 4.	The initial AMF determines to reroute the NAS message to the Target AMF via NG-RAN (as the initial AMF is not the appropriate AMF to serve the UE based on TS 23.502 [2] clause 4.2.2.2.3). To facilitate NAS security context provisioning to the Target AMF for the corresponding UE's ongoing registration procedure, the solution considers using AUSF that can connect with both AMFs to assist indirect AMF re-allocation procedure. If the Initial AMF determines to reroute via RAN, then to facilitate security context provisioning to the target AMF, the initial AMF/SEAF sends an AMFRealloc_Security Context Request message (over a new service-operation message) to the AUSF which includes Target AMF information (example, AMF Set ID), AMF_Reroute_Security Required indication, SUPI and SUCI.
Step 5.	On receiving AMFRealloc_SecurityContext Request message, the AUSF locally stores the SUCI along with SUPI. Based on the SUPI identifies the locally stored security context. Further the AUSF generates the new security anchor key and reroute security context (NAS_Sec_ID). NAS_Sec_ID is the hash code of security anchor key, SUPI and Target AMF information, which enables AUSF to authenticate the Target AMF for fetching any specific security context at a later point of time.
NOTE 2:	The rerouted RR and related information via RAN need not be protected unless any of the related information contains sensitive data (e.g., SUPI or Security key etc., in such a case an additional fetching of reroute security context from the AUSF can be allowed). As this solution does not send any sensitive data along the rerouted information, the solution does not introduce any additional protection to the rerouted RR.
NOTE 3:	if complete registration request (i.e. the one received in step 1 of initial UE message when the UE has NAS security or the one received in NAS Security mode complete message) needs to be rerouted via RAN in clear text and if it has any potential security threats, then based on MNO's local policy additional reroute security context can be fetched from the AUSF (in steps 4-6) and the complete registration request can be confidentiality and integrity protected while rerouting via RAN. The reallocated AMF can retrieve the reroute security context from the AUSF (in steps 9-11) to verify and decrypt the protected complete registration request. The method of requesting and applying the reroute security can be followed as in solution 12, but the usage of reroute security context is exclusively for the protection of complete registration request rerouted via RAN and this can be used as applicable to both initial registration and mobility registration update scenarios.
Step 6.	The AUSF sends NAS_Sec_ID to the initial AMF/SEAF in the AMFRealloc_Security Context Response message.
Step 7a.	The initial AMF sends the reroute NAS message along with NAS_Sec_ID and routing information (i.e. can contain for example address/FQDN/AUSF identification information) to the target AMF via RAN. The additional information includes the Target AMF information as specified in step 7(B) TS 23.502 [2] clause 4.2.2.2.3.
Step 7b.	The NG-RAN forwards the received reroute NAS message to the appropriate Target AMF as specified in step 7(B) TS 23.502 [2] clause 4.2.2.2.3.
Step 8.	After receiving the reroute NAS message with NAS_Sec_ID, the Target AMF/SEAF based on NAS_Sec_ID determines to fetch the corresponding security context from the AUSF to handle the received rerouted NAS message. The routing information in the SUCI and/or routing information can be used to select the right AUSF.
Step 9.	The Target AMF/SEAF sends the Key_Request message to the AUSF with the SUCI, NAS_Sec_ID, and Target AMF information (example, such as AMF Set ID).
Step 10.	The AUSF on receiving the NAS_Sec_ID, SUCI and AMF information, fetches the SUCI-SUPI pair and related information and further verifies the NAS_Sec_ID to authenticate the Target AMF to provide the security information. If the NAS_Sec_ID validation is successful, the AUSF determines to provide the new security context (anchor key Kseaf) for the Target AMF/SEAF.
Step 11. The AUSF sends to Target AMF/SEAF the Key_Response message containing SUPI, NAS_Sec_ID, Kseaf, N-NSCI (to indicate the Target AMF that the Kamf is derived from the new anchor key) and a special ABBA parameter (to indicate Slice specific security feature defined for 5G). The SEAF derives the Kamf from the received Kseaf, assigns a slice specific ABBA based on received N-NSCI and provides ABBA and Kamf to AMF. The AUSF deletes the NAS_Sec_ID and SUCI after step 11.
Step 12.	The Target AMF initiates a NAS security mode command with the UE to align the new NAS security context with the UE. The Target AMF locally stores the received SUPI, Reroute Security context such as NAS_Sec_ID, N-NSCI, Kamf, and the special ABBA parameter along with the ngKSI.
Step 13.	The Target AMF selects the NAS security algorithms (integrity and ciphering algorithms) based on the UE security capabilities and sends a NAS security mode command message to the UE which contains the New NAS Security Context Indicator (N-NSCI), and the special ABBA parameter value (example. 0x0001 to indicate the slice specific feature supported in 5GS to meet slice isolation requirements).
Step 14.	The UE on receiving the N-NSCI in the NAS Security mode command message, uses an anchor key newly derived (as indicated with a special ABBA) to derive a Kamf similar to the one available in the Target AMF. The UE uses the received special ABBA value and N-NSCI received in the Kamf generation.
Step 15.	The UE after a successful validation of the NAS Security mode command, sends a NAS security mode complete message to the Target AMF.
After a successful NAS Security mode command procedure between the target AMF and UE, the rest of the procedure executes similar to the existing 5G System.
Case 2- Registration Mobility Update Procedure:
Figure 6.4.2-2: Enabling NAS Security during Registration Mobility Update Scenario for indirect AMF reroute
This clause describes the simple adaptations required for steps shown in Figure 6.4.2-2 to address indirect AMF-reallocation based security aspects handling during registration mobility update procedure.
Step 1. If the Registration Request contains 5G-GUTI, the initial AMF performs the following accordingly for various scenarios mentioned in clause 4.3 'Architecture and security assumptions', of the present document,
Case 1-2.a.i)	Initial AMF based on TS 33.501 [3] clause 6.9.3, fetches SUPI and security context from the old AMF by providing the 5G-GUTI and the registration request. Further the initial AMF decides whether to reroute the Registration Request according to TS 23.502 [2] clause 4.2.2.2.3 step 2 (TS 23.502 [2] clause 4.2.2.2.3 step 2-6b as applicable). If the initial AMF determines to perform RAN reroute due to indirect AMF reallocation (based on TS 23.502 [2] clause 4.2.2.2.3 step 7B), then the initial AMF decides to ignore the security context fetched from the old AMF after step 6 (initial AMF sends to old AMF Namf_Communication_RegistrationStatusUpdate (failure cause). Perform steps 4 to 15 as in Figure 6.4.2-2, with the following minimal changes related to 5G-GUTI storage and handling at the AUSF.
-	In step 4, the initial AMF/SEAF sends 5G-GUTI and SUPI (instead of SUCI) to the AUSF in AMFRealloc_SecurityContext Request message.
-	In step 5, on receiving AMFRealloc_SecurityContext Request message, the AUSF based on the SUPI identifies the locally stored security context and stores the 5G-GUTI along with the SUPI.
-	In step 6.	The AUSF sends NAS_Sec_ID to the initial AMF/SEAF in the AMFRealloc_Security Context Response message.
-	In step 8.	the Target AMF based on the received NAS_Sec_ID, it determines to fetch the corresponding security context from the AUSF to handle the received rerouted NAS message. The routing information can be used to select the right AUSF instance which holds the UE security context.
-	In step 9, the target AMF/SEAF sends 5G-GUTI in the Key_Request to the AUSF.
-	In step 10, the AUSF based on the received 5G-GUTI and NAS_Sec_ID, fetches the corresponding SUPI along with reroute security information to verify the NAS_Sec_ID.
Case 2-2.a.ii)	As the initial AMF lack N14 with old AMF, the UE cannot be identified by means of a temporary identity (5G-GUTI) and so the AMF performs Subscription identification procedure with UE and continues with primary authentication. After a successful primary authentication, the initial AMF performs steps 4 to 15 same as in Figure 6.4.2-1.
Case 3-2.b.i)	The initial AMF having N14 with old AMF will act similar to Case 1-2.a.i. As the scenario is related to indirect AMF reroute, the target AMF based on local policy and received NAS_Sec_ID determines to fetch and use security context related to NAS_Sec_ID. If required, the target AMF can fetch UE context from the old AMF but may not use security context from old AMF. As the initial AMF already fetches and uses the UE context from old AMF, there is a possibility that old AMF can delete the security context (based on TS 33.501  [3] clause 6.9.3), and so the target AMF may not fetch any security context from the old AMF. Further the case 2.b.i may not be feasible according to the vertical slice isolation requirement, which may need to be aligned with the clause 4.3 accordingly.
Case 4-2.b.ii)	As the initial AMF lack N14 with old AMF, the UE cannot be identified by means of a temporary identity (5G-GUTI) and so the AMF performs Subscription identification procedure with UE and continues with primary authentication. After a successful primary authentication, the initial AMF performs steps 4 to 15 same as in Figure 6.4.2-1. On receiving the reroute NAS message with NAS_Sec_ID, the target AMF based on local policy determines to use the security context related to the received NAS_Sec_ID. As an alternative, the target AMF based on local policy determine either to use the security context related to NAS_Sec_ID fetched from AUSF or related to 5G-GUTI fetched from old AMF (where UE context will be fetched).",TR 33.864,6.4.2,all_images/image_447.jpeg,Enabling NAS Security for AMF re-allocation with NAS re-route via RAN using AUSF
"The solution enables NAS security availability in the Target AMF during an AMF re-allocation and reroute (via RAN) as shown in Figure 6.4.2-1. The solution uses the AUSF involved in the authentication procedure of the UE to act as a common NF (i.e. an instance of existing NF that can be trusted and accessible to all AMFs in the serving network) to generate/store a security key in the network after a successful UE primary authentication and enable providing of AMF key when required for the Target AMF which cannot communicate with an initial AMF and/or source AMF directly. The AUSF in the home network is considered to be a trusted NF in the core network, as it will be involved during the primary authentication of the UE. Further the AUSF in the home network can provide AMF Re-allocation Security Service to the requester NF (i.e. initial AMF) by Nausf_AMFRealloc_SecurityContext service operation and can provide Key service to the requester NF (i.e. re-allocated Target AMF) by Nausf_Key service operation accordingly. The new AUSF service operation related required and optional inputs and outputs with be described during the normative phase.
The AUSF can assist to ensure NAS security context availability for the reallocated AMF. The primary authentication is run similar to TS 33.501  [3] and the AUSF stores the Kseaf before sending the Nausf_UEAuthentication_Authenticate response message to the AMF/SEAF following a successful primary authentication (i.e. as in TS 33.501 [3] clause 6.1.3.2.0 where the AUSF at step 4 generates Kseaf, at step 5 removes Kseaf from 5G AV to send 5G SE AV and finally at step 12 if authentication is successful sends Kseaf to SEAF). The message flow for enabling NAS Security for AMF re-allocation with NAS re-route via RAN using AUSF is shown in Figure 6.4.2-1.
Figure 6.4.2-1: Enabling NAS Security for AMF re-allocation with NAS re-route via RAN using AUSF
Case 1- Initial Registration:
The steps involved in the solution shown in Figure 6.4.2-1 is described as follows.
Step 1-3.	The UE sends the Registration Request to the initial AMF and the procedure can follow similar to TS 23.502 [2] clause 4.2.2.2.2 and clause 4.2.2.2.3. Where at this step, the UE and network authentication would have been successfully completed and following a successful primary authentication, the NAS security between the UE and the initial AMF would also have been successfully setup.
NOTE 1:	The UE indicates in the Registration Request the support for AMF Reallocation. The indication can be similar to the indication used in solution 1 and 3 of the present document.
Step 4.	The initial AMF determines to reroute the NAS message to the Target AMF via NG-RAN (as the initial AMF is not the appropriate AMF to serve the UE based on TS 23.502 [2] clause 4.2.2.2.3). To facilitate NAS security context provisioning to the Target AMF for the corresponding UE's ongoing registration procedure, the solution considers using AUSF that can connect with both AMFs to assist indirect AMF re-allocation procedure. If the Initial AMF determines to reroute via RAN, then to facilitate security context provisioning to the target AMF, the initial AMF/SEAF sends an AMFRealloc_Security Context Request message (over a new service-operation message) to the AUSF which includes Target AMF information (example, AMF Set ID), AMF_Reroute_Security Required indication, SUPI and SUCI.
Step 5.	On receiving AMFRealloc_SecurityContext Request message, the AUSF locally stores the SUCI along with SUPI. Based on the SUPI identifies the locally stored security context. Further the AUSF generates the new security anchor key and reroute security context (NAS_Sec_ID). NAS_Sec_ID is the hash code of security anchor key, SUPI and Target AMF information, which enables AUSF to authenticate the Target AMF for fetching any specific security context at a later point of time.
NOTE 2:	The rerouted RR and related information via RAN need not be protected unless any of the related information contains sensitive data (e.g., SUPI or Security key etc., in such a case an additional fetching of reroute security context from the AUSF can be allowed). As this solution does not send any sensitive data along the rerouted information, the solution does not introduce any additional protection to the rerouted RR.
NOTE 3:	if complete registration request (i.e. the one received in step 1 of initial UE message when the UE has NAS security or the one received in NAS Security mode complete message) needs to be rerouted via RAN in clear text and if it has any potential security threats, then based on MNO's local policy additional reroute security context can be fetched from the AUSF (in steps 4-6) and the complete registration request can be confidentiality and integrity protected while rerouting via RAN. The reallocated AMF can retrieve the reroute security context from the AUSF (in steps 9-11) to verify and decrypt the protected complete registration request. The method of requesting and applying the reroute security can be followed as in solution 12, but the usage of reroute security context is exclusively for the protection of complete registration request rerouted via RAN and this can be used as applicable to both initial registration and mobility registration update scenarios.
Step 6.	The AUSF sends NAS_Sec_ID to the initial AMF/SEAF in the AMFRealloc_Security Context Response message.
Step 7a.	The initial AMF sends the reroute NAS message along with NAS_Sec_ID and routing information (i.e. can contain for example address/FQDN/AUSF identification information) to the target AMF via RAN. The additional information includes the Target AMF information as specified in step 7(B) TS 23.502 [2] clause 4.2.2.2.3.
Step 7b.	The NG-RAN forwards the received reroute NAS message to the appropriate Target AMF as specified in step 7(B) TS 23.502 [2] clause 4.2.2.2.3.
Step 8.	After receiving the reroute NAS message with NAS_Sec_ID, the Target AMF/SEAF based on NAS_Sec_ID determines to fetch the corresponding security context from the AUSF to handle the received rerouted NAS message. The routing information in the SUCI and/or routing information can be used to select the right AUSF.
Step 9.	The Target AMF/SEAF sends the Key_Request message to the AUSF with the SUCI, NAS_Sec_ID, and Target AMF information (example, such as AMF Set ID).
Step 10.	The AUSF on receiving the NAS_Sec_ID, SUCI and AMF information, fetches the SUCI-SUPI pair and related information and further verifies the NAS_Sec_ID to authenticate the Target AMF to provide the security information. If the NAS_Sec_ID validation is successful, the AUSF determines to provide the new security context (anchor key Kseaf) for the Target AMF/SEAF.
Step 11. The AUSF sends to Target AMF/SEAF the Key_Response message containing SUPI, NAS_Sec_ID, Kseaf, N-NSCI (to indicate the Target AMF that the Kamf is derived from the new anchor key) and a special ABBA parameter (to indicate Slice specific security feature defined for 5G). The SEAF derives the Kamf from the received Kseaf, assigns a slice specific ABBA based on received N-NSCI and provides ABBA and Kamf to AMF. The AUSF deletes the NAS_Sec_ID and SUCI after step 11.
Step 12.	The Target AMF initiates a NAS security mode command with the UE to align the new NAS security context with the UE. The Target AMF locally stores the received SUPI, Reroute Security context such as NAS_Sec_ID, N-NSCI, Kamf, and the special ABBA parameter along with the ngKSI.
Step 13.	The Target AMF selects the NAS security algorithms (integrity and ciphering algorithms) based on the UE security capabilities and sends a NAS security mode command message to the UE which contains the New NAS Security Context Indicator (N-NSCI), and the special ABBA parameter value (example. 0x0001 to indicate the slice specific feature supported in 5GS to meet slice isolation requirements).
Step 14.	The UE on receiving the N-NSCI in the NAS Security mode command message, uses an anchor key newly derived (as indicated with a special ABBA) to derive a Kamf similar to the one available in the Target AMF. The UE uses the received special ABBA value and N-NSCI received in the Kamf generation.
Step 15.	The UE after a successful validation of the NAS Security mode command, sends a NAS security mode complete message to the Target AMF.
After a successful NAS Security mode command procedure between the target AMF and UE, the rest of the procedure executes similar to the existing 5G System.
Case 2- Registration Mobility Update Procedure:
Figure 6.4.2-2: Enabling NAS Security during Registration Mobility Update Scenario for indirect AMF reroute
This clause describes the simple adaptations required for steps shown in Figure 6.4.2-2 to address indirect AMF-reallocation based security aspects handling during registration mobility update procedure.
Step 1. If the Registration Request contains 5G-GUTI, the initial AMF performs the following accordingly for various scenarios mentioned in clause 4.3 'Architecture and security assumptions', of the present document,
Case 1-2.a.i)	Initial AMF based on TS 33.501 [3] clause 6.9.3, fetches SUPI and security context from the old AMF by providing the 5G-GUTI and the registration request. Further the initial AMF decides whether to reroute the Registration Request according to TS 23.502 [2] clause 4.2.2.2.3 step 2 (TS 23.502 [2] clause 4.2.2.2.3 step 2-6b as applicable). If the initial AMF determines to perform RAN reroute due to indirect AMF reallocation (based on TS 23.502 [2] clause 4.2.2.2.3 step 7B), then the initial AMF decides to ignore the security context fetched from the old AMF after step 6 (initial AMF sends to old AMF Namf_Communication_RegistrationStatusUpdate (failure cause). Perform steps 4 to 15 as in Figure 6.4.2-2, with the following minimal changes related to 5G-GUTI storage and handling at the AUSF.
-	In step 4, the initial AMF/SEAF sends 5G-GUTI and SUPI (instead of SUCI) to the AUSF in AMFRealloc_SecurityContext Request message.
-	In step 5, on receiving AMFRealloc_SecurityContext Request message, the AUSF based on the SUPI identifies the locally stored security context and stores the 5G-GUTI along with the SUPI.
-	In step 6.	The AUSF sends NAS_Sec_ID to the initial AMF/SEAF in the AMFRealloc_Security Context Response message.
-	In step 8.	the Target AMF based on the received NAS_Sec_ID, it determines to fetch the corresponding security context from the AUSF to handle the received rerouted NAS message. The routing information can be used to select the right AUSF instance which holds the UE security context.
-	In step 9, the target AMF/SEAF sends 5G-GUTI in the Key_Request to the AUSF.
-	In step 10, the AUSF based on the received 5G-GUTI and NAS_Sec_ID, fetches the corresponding SUPI along with reroute security information to verify the NAS_Sec_ID.
Case 2-2.a.ii)	As the initial AMF lack N14 with old AMF, the UE cannot be identified by means of a temporary identity (5G-GUTI) and so the AMF performs Subscription identification procedure with UE and continues with primary authentication. After a successful primary authentication, the initial AMF performs steps 4 to 15 same as in Figure 6.4.2-1.
Case 3-2.b.i)	The initial AMF having N14 with old AMF will act similar to Case 1-2.a.i. As the scenario is related to indirect AMF reroute, the target AMF based on local policy and received NAS_Sec_ID determines to fetch and use security context related to NAS_Sec_ID. If required, the target AMF can fetch UE context from the old AMF but may not use security context from old AMF. As the initial AMF already fetches and uses the UE context from old AMF, there is a possibility that old AMF can delete the security context (based on TS 33.501  [3] clause 6.9.3), and so the target AMF may not fetch any security context from the old AMF. Further the case 2.b.i may not be feasible according to the vertical slice isolation requirement, which may need to be aligned with the clause 4.3 accordingly.
Case 4-2.b.ii)	As the initial AMF lack N14 with old AMF, the UE cannot be identified by means of a temporary identity (5G-GUTI) and so the AMF performs Subscription identification procedure with UE and continues with primary authentication. After a successful primary authentication, the initial AMF performs steps 4 to 15 same as in Figure 6.4.2-1. On receiving the reroute NAS message with NAS_Sec_ID, the target AMF based on local policy determines to use the security context related to the received NAS_Sec_ID. As an alternative, the target AMF based on local policy determine either to use the security context related to NAS_Sec_ID fetched from AUSF or related to 5G-GUTI fetched from old AMF (where UE context will be fetched).",TR 33.864,6.4.2,all_images/image_448.jpeg,Enabling NAS Security during Registration Mobility Update Scenario for indirect AMF
"The solution is based on the principle of verifying the initial AMF's capability and the UE's subscription information (i.e. slice subscription data), before the UE's security context can be provisioned to the initial AMF during the primary authentication to prevent system availability issues described in Key Issue#1. The Figure 6.6.2-1 describes the AMF capability and slice isolation requirement-based UE Security handling during primary authentication as follows. The essential adaptations required over initiation of primary authentication and authentication procedure is described here in Figure 6.6.2-1 and the rest follows similar to clause 6.1.2 and clause 6.1.3 of TS 33.501  [3].
Figure 6.6.2-1: AMF Serving Capability based Security handling during primary authentication
Step 1.	The UE sends the Registration Request with SUCI or 5G-GUTI to the initial AMF.
Step 2a-b.	The initial AMF sends authentication request to the SEAF with SUCI by including the AMF Slice serving Capability set as 'unknown' (example: unknown can be represented with a value set to '0'). The AMF can set the AMF serving capability as unknown based on SUCI and if there is no slice related information (example. slice selection information or reroute due to slicing information) available for the UE. The AMF sends AMF slice serving capability as unknown if it has no available information which can enable the network to select the appropriate slice.
The SEAF further sends a Nausf_UEAuthentication_Authenticate Request message to the AUSF, which can contain SUCI, SNN and AMF Slice Serving Capability.
Step 3.	The AUSF stores the received SNN and SUCI temporarily in its local memory. The AUSF sends to the UDM a Nudm_UEAuthentication_Get Request containing, SUCI, and SNN.
Step 4.	The UDM/UDR performs SUCI deconcealment and authentication method selection as in TS 33.501 [3] clause 6.1.2. Further the UDM, determines, if there is any slice isolation required based on the available subscription information (ex., slice selection subscription data). If a slice isolation requirement information is available, then the UDM determines to provide the related information to the AUSF.
Step 5.	The UDM sends a Nudm_UEAuthentication_Get Response to the AUSF, which contains an AV (i.e. EAP-AKA' AV/5G HE AV as in TS 33.501 [3]based on authentication method), SUPI and Slice Isolation Required indication.
Step 6.	The AUSF performs method specific message exchange with the UE to perform primary authentication as in 33.501 [3] clause 6.1.3 (steps 3-8/9 for EAP-AKA' or 3-11 for 5G AKA). The solution proposes no changes to the challenge request/response message exchanges involved in the primary authentication.
Step 7a.	The AUSF if finds that the RES* verification (if 5G AKA) or Authentication challenge verification (EAP-AKA') is successful, then the 5G network considers the primary authentication as successful.
Step 7b.	Post successful authentication verification at the AUSF, if an AMF slice serving capability unknown was received from AMF/SEAF in step 2, then the AUSF determines to hold the UE security context until an acknowledgement is received from the initial AMF/SEAF that it is capable to serve the UE. As an alternative option 1, the AUSF can provide security context as in the existing system in addition to sending AMF serving capability check Required Indication and Slice Isolation Required Indication.
Step 8.	The AUSF sends to AMF/SEAF, a Nausf_UEAuthentication_Authenticate Request message which includes authentication result as success, SUPI and an AMF serving capability Check Required indication and Slice Isolation Required Indication (if received from UDM). As an alternative option 1, the Anchor Key is also provided.
Step 9a-b.	The AMF/SEAF on receiving an AMF serving capability Check Required indication and Slice Isolation Required Indication (if received), the AMF determines to check its serving capability and it performs steps 3a-6b (as applicable) of clause 4.2.2.2.3 Registration with AMF re-allocation as specified in TS 23.502 [2]. The initial AMF based on local policy and subscription information if decides to reroute via RAN (based on TS 23.502 [2] clause 4.2.2.2.3 step 7B), then performs step 10a-15. Also, the AMF determines not to use the received security context (if received as in alternative option 1). Else if the AMF finds that it is capable to serve the UE (i.e. a reroute via RAN is not needed), and if no security context is received in addition to AMF serving capability check required indication, then the AMF/SEAF can perform step 10a'-10b' to fetch UE security context and then to continue with NAS SMC as in existing system. Else if, the AMF finds that it is capable to serve the UE (i.e. a reroute via RAN is not needed), and if a security context is received as in alternative option 1, then the AMF continue with NAS SMC as in existing system.
Step 10a.	The AMF/SEAF, if determines to perform Reroute via RAN, then it sends SUPI, AMF Serving Capability Result set as '0', AMF reroute security required indication and target AMF information in an AUSF service operation message to the AUSF. As an alternative, in addition the AMF/SEAF can also send the ABBA (i.e. ABBA previous used in authentication message exchange with UE) to AUSF in this step.
Step 10b. The AUSF on receiving an AMF Serving Capability Result set as '0' (as in step 10a) with AMF reroute security required indication, determines that it need to provide the security to new Target AMF. Further as a reroute security context is requested, the AUSF derives an AMF authentication token (AMF_AUTN) using hash of AUSF key, SUPI and RAND. AUSF locally stores the AMF_AUTN along with the SUPI, SUCI, Kausf, ABBA (if received) and Kseaf (if available). The AUSF further sends AMF_AUTN in AUSF service operation message to the AMF/SEAF.
If No Reroute via RAN determined at AMF (then only steps 10a' and 10b' are applicable):
Step 10a'. The AMF if determines that it is capable to serve the UE (i.e. no reroute via RAN), sends SUPI and AMF Serving Capability Result set as '1' to the AUSF.
Step 10b'. The AUSF on receiving SUPI and AMF Serving Capability Result set as '1' determines to provide the UE Security context to AMF/SEAF and then AUSF can send SUPI, Authentication Result and Anchor Key to the AMF/SEAF as in the existing system.
Step 11a.	The initial AMF based on local policy and subscription information if decides to reroute via RAN (based on TS 23.502 [2] clause 4.2.2.2.3 step 7B) at step 9b, it further sends the Reroute NAS message to the NG-RAN, which contains the initial UE message, Routing Information (to select the AUSF instance holding the UE context), and AMF_AUTN. As an alternative, in addition the initial AMF can also send the ngKSI (i.e. ABBA previous used in authentication message exchange with UE) in the Reroute NAS message.
Step 11b.	The NG-RAN forwards the received Reroute NAS message to the Target AMF with initial UE message, reroute due to slicing, AMF_AUTN, ngKSI (if received) and Routing Information.
Step 12.	The Target AMF on receiving the Reroute NAS message with AMF_AUTN will attempt to contact the right AUSF (either directly or via co-located SEAF) based on the routing Information. The Target AMF sends to appropriate AUSF, the Nausf_UEAuthentication_Authenticate Request containing the SUCI, SNN, and the received AMF_AUTN (to authenticate itself with AUSF to fetch the UE security context). The target AMF if received a ngKSI, then that ngKSI can be used to identify the partial native security context created with the successful primary authentication.
Step 13.	The AUSF verifies the received AMF_AUTN based on the UE authentication information locally stored. If the Target AMF provided AMF_AUTN matches with the locally stored AMF_AUTN for a SUCI, then the AUSF considers the AMF_AUTN verification (i.e. Reallocated AMF authentication) as successful and determines to provide the anchor key.
Step 14.	The AUSF sends to SEAF of the Target AMF, the Nausf_UEAuthentication_Authenticate Response containing authentication result, SUPI and Kseaf (the anchor key). Further the SEAF sends the ABBA parameters, authentication result as success, and Kamf key to the Target AMF as in the existing system. As an alternative, if the AUSF in addition received ABBA in step 11a, the AUSF sends the ABBA received to SEAF and the SEAF is required to use the received ABBA.
NOTE 1:	The ABBA parameter usage can be same as in the existing system. TS 33.501  [3]specified the ABBA parameter value as '0x0000'. The UE uses the ABBA parameter provided by the SEAF in the calculation of KAMF as specified in TS 33.501 [3] clause A.7.1 ABBA parameter values.
NOTE 2:	For EAP-AKA', perform step 11 as specified in TS 33.501  [3] clause 6.1.3.1. For 5G AKA, perform step 12 as specified in TS 33.501 [3] clause 6.1.3.2.0.
Step 15.	The Target AMF on receiving the Kamf and authentication result can trigger the NAS Security mode command (NAS SMC) procedure with UE when required to activate the UE NAS security context as in TS 33.501 [3].
Adaptations for Registration Mobility Update:
This clause describes the simple adaptations required to address security handling in AMF-reallocation during registration mobility update procedure as shown in Figure 6.6.2-2.
Figure 6.6.2-2: Security context handling during registration mobility update
Step 1. If the Registration Request contains 5G-GUTI (pointing to an old AMF), the initial AMF performs the following accordingly for various scenarios mentioned in clause 4.3 'Architecture and security assumptions', of the present document:
Case 1-2.a.i) N14 interface exists only between Initial AMF and Old AMF:
Step 2a-b. The Initial AMF based on TS 33.501 [3] clause 6.9.3, fetches SUPI and security context from the old AMF by providing the 5G-GUTI and the registration request. Further SUPI and subscription information (fetched from UDM as shown in 2b.3) can be used to decide whether to reroute the Registration Request according to TS 23.502 [2] clause 4.2.2.2.3 step 2. If a reroute is required, the initial AMF, if fetched the UE context (as in TS 23.502 [2] clause 5.2.2.2.2) from the old AMF, it can use the slice information to perform (2b.4) Nnssf_NSSelection service operation based on TS 23.502 [2] 4.2.2.2.3 step 4a-b. Also, for the case, where the current 5G security context is fetched, the AMF may decipher the NAS container with the same security context, and get the initial NAS message and so if there is any Requested NSSAI provided by UE, it can also be used in Nnssf_NSSelection service operation (even though it is an optional IE according to TS TS 23.502 [2] clause 5.2.16.2.1). If an indirect AMF allocation and reroute via RAN is required, the initial AMF does not send any NAS message to the UE (i.e. it does not use current/new 5G security context fetched from old AMF), in turn can perform reroute via RAN.
NOTE 3:	According to TS 33.501 [3] clause 6.9.3 for the case where source/old AMF sends new 5G security context to Initial AMF, it states, 'The source AMF subsequently deletes the 5G security context which it holds.'
Step 2c.1 If another AMF is selected, the initial AMF sends a reject indication to the old AMF and the old AMF continues as if the Namf_Communication_UEContextTransfer had never been received.
Step 2c.2. Target AMF discovery can be based on TS 23.502 [2] clause 4.2.2.2.3 steps 6a-b.
Step 3-4. The initial AMF performs reroute via RAN as in TS 23.502 [2] clause 4.2.2.2.3 step 7B.
Step 5a-b. The Target AMF on receiving the initial NAS message with 5G-GUTI finds that it is not able to identify the related old AMF and considers that it cannot identify the UE with 5G-GUTI and so initiates identity request procedure with UE and get SUCI.
Step 6. The target AMF initiates primary authentication by sending authentication request with SUCI (without AMF slice serving capability IE, because the target AMF is aware that this is reroute due to slicing received in Reroute NAS message as in TS 23.502 [2] clause 4.2.2.2.3 step 7B).
The target AMF will not include any AMF slice serving capability IE as unknown, so, the AUSF soon after successful response verification will provide Anchor key to the AMF/SEAF as in existing system. If the UDM provides a Slice Isolation Required Indication during step 5 as in Figure 6.6.2-1, the AUSF also sends the received Slice Isolation Required Indication to the AMF/SEAF along with the authentication result, SUPI and anchor key. Alternatively, if the AUSF does not receive any AMF slice serving capability unknown indication from the AMF, the AUSF can skip sending Slice Isolation Required indication to the AMF (if received from the UDM). The Target AMF checks the SUPI and subscription information and then accordingly performs NAS SMC with the UE.
Case 2-2.a.ii)	No N14 exists between Initial AMF and old AMF and also no N14 exists between target AMF and old AMF: As the initial AMF lack N14 with old AMF, the UE cannot be identified by means of a temporary identity (5G-GUTI) and so the initial AMF performs Subscription identification procedure (as shown in step 2.b-1) with UE and continues with primary authentication (as shown in step 2b.2) with the adaptations described in Figure 6.6.2-1 steps 2a-13.
Case 3-2.b.i)	N14 exists between Initial AMF and old AMF and also between target AMF and old AMF: The initial AMF having N14 with old AMF will act similar to Case 2-2.a.i steps 1-4.
Step 5-6. The Target AMF on receiving the initial NAS message with 5G-GUTI finds it can contact the corresponding old AMF. Based on local policy and reroute due to slicing indication received in reroute NAS message, the target AMF may fetch security context from old AMF (or) determines not to fetch security context from old AMF and perform Identity request/response procedure and primary authentication accordingly (as in case 2.a.i).
If the target AMF fetches security context from old AMF, either based on local policy the target AMF may use current/new security context fetched from old AMF or the target may determine to perform primary authentication with SUPI (as in case 2.a.i, but SUPI is used instead of SUCI).
NOTE 4:	Further the case 2.b.i may not be feasible according to the vertical slice isolation requirement and it may need to be aligned with the clause 4.3.
Case 4-2.b.ii)	N14 exists only between target AMF and old AMF: As the initial AMF lack N14 with old AMF, the UE cannot be identified by means of a temporary identity (5G-GUTI) and so the AMF performs Subscription identification procedure (as shown in 2b.1) with UE and continues with primary authentication (as shown in 2b.2) based on the adaptations described in Figure 6.6.2-1 steps 2a-13. The target AMF on receiving the reroute NAS message (i.e. Registration Request with 5G-GUTI), based on local policy, received authentication information (AMF_AUTN) and reroute due to slicing indication, determine to fetch security context related to an authentication information received in the reroute NAS message from the AUSF.",TR 33.864,6.6.2,all_images/image_450.jpeg,AMF Serving Capability based Security handling during primary authentication
"The solution is based on the principle of verifying the initial AMF's capability and the UE's subscription information (i.e. slice subscription data), before the UE's security context can be provisioned to the initial AMF during the primary authentication to prevent system availability issues described in Key Issue#1. The Figure 6.6.2-1 describes the AMF capability and slice isolation requirement-based UE Security handling during primary authentication as follows. The essential adaptations required over initiation of primary authentication and authentication procedure is described here in Figure 6.6.2-1 and the rest follows similar to clause 6.1.2 and clause 6.1.3 of TS 33.501  [3].
Figure 6.6.2-1: AMF Serving Capability based Security handling during primary authentication
Step 1.	The UE sends the Registration Request with SUCI or 5G-GUTI to the initial AMF.
Step 2a-b.	The initial AMF sends authentication request to the SEAF with SUCI by including the AMF Slice serving Capability set as 'unknown' (example: unknown can be represented with a value set to '0'). The AMF can set the AMF serving capability as unknown based on SUCI and if there is no slice related information (example. slice selection information or reroute due to slicing information) available for the UE. The AMF sends AMF slice serving capability as unknown if it has no available information which can enable the network to select the appropriate slice.
The SEAF further sends a Nausf_UEAuthentication_Authenticate Request message to the AUSF, which can contain SUCI, SNN and AMF Slice Serving Capability.
Step 3.	The AUSF stores the received SNN and SUCI temporarily in its local memory. The AUSF sends to the UDM a Nudm_UEAuthentication_Get Request containing, SUCI, and SNN.
Step 4.	The UDM/UDR performs SUCI deconcealment and authentication method selection as in TS 33.501 [3] clause 6.1.2. Further the UDM, determines, if there is any slice isolation required based on the available subscription information (ex., slice selection subscription data). If a slice isolation requirement information is available, then the UDM determines to provide the related information to the AUSF.
Step 5.	The UDM sends a Nudm_UEAuthentication_Get Response to the AUSF, which contains an AV (i.e. EAP-AKA' AV/5G HE AV as in TS 33.501 [3]based on authentication method), SUPI and Slice Isolation Required indication.
Step 6.	The AUSF performs method specific message exchange with the UE to perform primary authentication as in 33.501 [3] clause 6.1.3 (steps 3-8/9 for EAP-AKA' or 3-11 for 5G AKA). The solution proposes no changes to the challenge request/response message exchanges involved in the primary authentication.
Step 7a.	The AUSF if finds that the RES* verification (if 5G AKA) or Authentication challenge verification (EAP-AKA') is successful, then the 5G network considers the primary authentication as successful.
Step 7b.	Post successful authentication verification at the AUSF, if an AMF slice serving capability unknown was received from AMF/SEAF in step 2, then the AUSF determines to hold the UE security context until an acknowledgement is received from the initial AMF/SEAF that it is capable to serve the UE. As an alternative option 1, the AUSF can provide security context as in the existing system in addition to sending AMF serving capability check Required Indication and Slice Isolation Required Indication.
Step 8.	The AUSF sends to AMF/SEAF, a Nausf_UEAuthentication_Authenticate Request message which includes authentication result as success, SUPI and an AMF serving capability Check Required indication and Slice Isolation Required Indication (if received from UDM). As an alternative option 1, the Anchor Key is also provided.
Step 9a-b.	The AMF/SEAF on receiving an AMF serving capability Check Required indication and Slice Isolation Required Indication (if received), the AMF determines to check its serving capability and it performs steps 3a-6b (as applicable) of clause 4.2.2.2.3 Registration with AMF re-allocation as specified in TS 23.502 [2]. The initial AMF based on local policy and subscription information if decides to reroute via RAN (based on TS 23.502 [2] clause 4.2.2.2.3 step 7B), then performs step 10a-15. Also, the AMF determines not to use the received security context (if received as in alternative option 1). Else if the AMF finds that it is capable to serve the UE (i.e. a reroute via RAN is not needed), and if no security context is received in addition to AMF serving capability check required indication, then the AMF/SEAF can perform step 10a'-10b' to fetch UE security context and then to continue with NAS SMC as in existing system. Else if, the AMF finds that it is capable to serve the UE (i.e. a reroute via RAN is not needed), and if a security context is received as in alternative option 1, then the AMF continue with NAS SMC as in existing system.
Step 10a.	The AMF/SEAF, if determines to perform Reroute via RAN, then it sends SUPI, AMF Serving Capability Result set as '0', AMF reroute security required indication and target AMF information in an AUSF service operation message to the AUSF. As an alternative, in addition the AMF/SEAF can also send the ABBA (i.e. ABBA previous used in authentication message exchange with UE) to AUSF in this step.
Step 10b. The AUSF on receiving an AMF Serving Capability Result set as '0' (as in step 10a) with AMF reroute security required indication, determines that it need to provide the security to new Target AMF. Further as a reroute security context is requested, the AUSF derives an AMF authentication token (AMF_AUTN) using hash of AUSF key, SUPI and RAND. AUSF locally stores the AMF_AUTN along with the SUPI, SUCI, Kausf, ABBA (if received) and Kseaf (if available). The AUSF further sends AMF_AUTN in AUSF service operation message to the AMF/SEAF.
If No Reroute via RAN determined at AMF (then only steps 10a' and 10b' are applicable):
Step 10a'. The AMF if determines that it is capable to serve the UE (i.e. no reroute via RAN), sends SUPI and AMF Serving Capability Result set as '1' to the AUSF.
Step 10b'. The AUSF on receiving SUPI and AMF Serving Capability Result set as '1' determines to provide the UE Security context to AMF/SEAF and then AUSF can send SUPI, Authentication Result and Anchor Key to the AMF/SEAF as in the existing system.
Step 11a.	The initial AMF based on local policy and subscription information if decides to reroute via RAN (based on TS 23.502 [2] clause 4.2.2.2.3 step 7B) at step 9b, it further sends the Reroute NAS message to the NG-RAN, which contains the initial UE message, Routing Information (to select the AUSF instance holding the UE context), and AMF_AUTN. As an alternative, in addition the initial AMF can also send the ngKSI (i.e. ABBA previous used in authentication message exchange with UE) in the Reroute NAS message.
Step 11b.	The NG-RAN forwards the received Reroute NAS message to the Target AMF with initial UE message, reroute due to slicing, AMF_AUTN, ngKSI (if received) and Routing Information.
Step 12.	The Target AMF on receiving the Reroute NAS message with AMF_AUTN will attempt to contact the right AUSF (either directly or via co-located SEAF) based on the routing Information. The Target AMF sends to appropriate AUSF, the Nausf_UEAuthentication_Authenticate Request containing the SUCI, SNN, and the received AMF_AUTN (to authenticate itself with AUSF to fetch the UE security context). The target AMF if received a ngKSI, then that ngKSI can be used to identify the partial native security context created with the successful primary authentication.
Step 13.	The AUSF verifies the received AMF_AUTN based on the UE authentication information locally stored. If the Target AMF provided AMF_AUTN matches with the locally stored AMF_AUTN for a SUCI, then the AUSF considers the AMF_AUTN verification (i.e. Reallocated AMF authentication) as successful and determines to provide the anchor key.
Step 14.	The AUSF sends to SEAF of the Target AMF, the Nausf_UEAuthentication_Authenticate Response containing authentication result, SUPI and Kseaf (the anchor key). Further the SEAF sends the ABBA parameters, authentication result as success, and Kamf key to the Target AMF as in the existing system. As an alternative, if the AUSF in addition received ABBA in step 11a, the AUSF sends the ABBA received to SEAF and the SEAF is required to use the received ABBA.
NOTE 1:	The ABBA parameter usage can be same as in the existing system. TS 33.501  [3]specified the ABBA parameter value as '0x0000'. The UE uses the ABBA parameter provided by the SEAF in the calculation of KAMF as specified in TS 33.501 [3] clause A.7.1 ABBA parameter values.
NOTE 2:	For EAP-AKA', perform step 11 as specified in TS 33.501  [3] clause 6.1.3.1. For 5G AKA, perform step 12 as specified in TS 33.501 [3] clause 6.1.3.2.0.
Step 15.	The Target AMF on receiving the Kamf and authentication result can trigger the NAS Security mode command (NAS SMC) procedure with UE when required to activate the UE NAS security context as in TS 33.501 [3].
Adaptations for Registration Mobility Update:
This clause describes the simple adaptations required to address security handling in AMF-reallocation during registration mobility update procedure as shown in Figure 6.6.2-2.
Figure 6.6.2-2: Security context handling during registration mobility update
Step 1. If the Registration Request contains 5G-GUTI (pointing to an old AMF), the initial AMF performs the following accordingly for various scenarios mentioned in clause 4.3 'Architecture and security assumptions', of the present document:
Case 1-2.a.i) N14 interface exists only between Initial AMF and Old AMF:
Step 2a-b. The Initial AMF based on TS 33.501 [3] clause 6.9.3, fetches SUPI and security context from the old AMF by providing the 5G-GUTI and the registration request. Further SUPI and subscription information (fetched from UDM as shown in 2b.3) can be used to decide whether to reroute the Registration Request according to TS 23.502 [2] clause 4.2.2.2.3 step 2. If a reroute is required, the initial AMF, if fetched the UE context (as in TS 23.502 [2] clause 5.2.2.2.2) from the old AMF, it can use the slice information to perform (2b.4) Nnssf_NSSelection service operation based on TS 23.502 [2] 4.2.2.2.3 step 4a-b. Also, for the case, where the current 5G security context is fetched, the AMF may decipher the NAS container with the same security context, and get the initial NAS message and so if there is any Requested NSSAI provided by UE, it can also be used in Nnssf_NSSelection service operation (even though it is an optional IE according to TS TS 23.502 [2] clause 5.2.16.2.1). If an indirect AMF allocation and reroute via RAN is required, the initial AMF does not send any NAS message to the UE (i.e. it does not use current/new 5G security context fetched from old AMF), in turn can perform reroute via RAN.
NOTE 3:	According to TS 33.501 [3] clause 6.9.3 for the case where source/old AMF sends new 5G security context to Initial AMF, it states, 'The source AMF subsequently deletes the 5G security context which it holds.'
Step 2c.1 If another AMF is selected, the initial AMF sends a reject indication to the old AMF and the old AMF continues as if the Namf_Communication_UEContextTransfer had never been received.
Step 2c.2. Target AMF discovery can be based on TS 23.502 [2] clause 4.2.2.2.3 steps 6a-b.
Step 3-4. The initial AMF performs reroute via RAN as in TS 23.502 [2] clause 4.2.2.2.3 step 7B.
Step 5a-b. The Target AMF on receiving the initial NAS message with 5G-GUTI finds that it is not able to identify the related old AMF and considers that it cannot identify the UE with 5G-GUTI and so initiates identity request procedure with UE and get SUCI.
Step 6. The target AMF initiates primary authentication by sending authentication request with SUCI (without AMF slice serving capability IE, because the target AMF is aware that this is reroute due to slicing received in Reroute NAS message as in TS 23.502 [2] clause 4.2.2.2.3 step 7B).
The target AMF will not include any AMF slice serving capability IE as unknown, so, the AUSF soon after successful response verification will provide Anchor key to the AMF/SEAF as in existing system. If the UDM provides a Slice Isolation Required Indication during step 5 as in Figure 6.6.2-1, the AUSF also sends the received Slice Isolation Required Indication to the AMF/SEAF along with the authentication result, SUPI and anchor key. Alternatively, if the AUSF does not receive any AMF slice serving capability unknown indication from the AMF, the AUSF can skip sending Slice Isolation Required indication to the AMF (if received from the UDM). The Target AMF checks the SUPI and subscription information and then accordingly performs NAS SMC with the UE.
Case 2-2.a.ii)	No N14 exists between Initial AMF and old AMF and also no N14 exists between target AMF and old AMF: As the initial AMF lack N14 with old AMF, the UE cannot be identified by means of a temporary identity (5G-GUTI) and so the initial AMF performs Subscription identification procedure (as shown in step 2.b-1) with UE and continues with primary authentication (as shown in step 2b.2) with the adaptations described in Figure 6.6.2-1 steps 2a-13.
Case 3-2.b.i)	N14 exists between Initial AMF and old AMF and also between target AMF and old AMF: The initial AMF having N14 with old AMF will act similar to Case 2-2.a.i steps 1-4.
Step 5-6. The Target AMF on receiving the initial NAS message with 5G-GUTI finds it can contact the corresponding old AMF. Based on local policy and reroute due to slicing indication received in reroute NAS message, the target AMF may fetch security context from old AMF (or) determines not to fetch security context from old AMF and perform Identity request/response procedure and primary authentication accordingly (as in case 2.a.i).
If the target AMF fetches security context from old AMF, either based on local policy the target AMF may use current/new security context fetched from old AMF or the target may determine to perform primary authentication with SUPI (as in case 2.a.i, but SUPI is used instead of SUCI).
NOTE 4:	Further the case 2.b.i may not be feasible according to the vertical slice isolation requirement and it may need to be aligned with the clause 4.3.
Case 4-2.b.ii)	N14 exists only between target AMF and old AMF: As the initial AMF lack N14 with old AMF, the UE cannot be identified by means of a temporary identity (5G-GUTI) and so the AMF performs Subscription identification procedure (as shown in 2b.1) with UE and continues with primary authentication (as shown in 2b.2) based on the adaptations described in Figure 6.6.2-1 steps 2a-13. The target AMF on receiving the reroute NAS message (i.e. Registration Request with 5G-GUTI), based on local policy, received authentication information (AMF_AUTN) and reroute due to slicing indication, determine to fetch security context related to an authentication information received in the reroute NAS message from the AUSF.",TR 33.864,6.6.2,all_images/image_451.jpeg,Security context handling during registration mobility update
"The solution is based on the principle of enabling the initial AMF to verify the UE's slice subscription data soon after response verification during the primary authentication to determine if an AMF is capable to serve a UE or not, before the UE's security context can be provisioned to the initial AMF to prevent system availability issues described in Key Issue#1 of the present document. The Figure 6.7.2-1 describes the UE slice subscription data-based AMF serving capability verification and UE Security handling/provisioning to AMF/SEAF during primary authentication as follows. The essential adaptations required over initiation of primary authentication and authentication procedure is described here in Figure 6.7.2-1 and the rest follows similar to clause 6.1.2 and clause 6.1.3 of TS 33.501 [3].
Figure 6.7.2-1: AMF Serving Capability based Security Context handling during primary authentication
The solution uses the existing service operations for the adaptations required.
Step 1. The UE sends the Registration Request with SUCI or 5G-GUTI to the initial AMF.
Step 2a-b. The initial AMF sends authentication request to the SEAF by including the Slice Selection Information Not Available indication (if the AMF received a Registration Request with SUCI/ 5G-GUTI (i.e. during initial registration with SUCI /when the UE and old AMF could not be identified with 5G-GUTI). The SEAF further sends a Nausf_UEAuthentication_Authenticate Request message to the AUSF. The Slice Selection Information Not Available can indicate that the initial AMF has no available information which can enable the network to select the appropriate slice.
Step 3. The AUSF on receiving the Slice Selection Information Not Available Indication determines that the network (i.e., AMF) needs further information to verify the serving capability for the corresponding UE. The AUSF sends to the UDM a Nudm_UEAuthentication_Get Request containing, SUCI, and SNN.
Step 4. The UDM/UDR performs SUCI de-concealment and authentication method selection as in TS 33.501 clause 6.1.2.
Step 5. The UDM sends a Nudm_UEAuthentication_Get Response to the AUSF, which contains an AV (i.e. EAP-AKA' AV/5G HE AV as in 33.501 based on authentication method), and SUPI.
Step 6. The AUSF performs method specific message exchange with the UE to perform primary authentication (i.e. as in TS 33.501 clause 6.1.3 steps 3-8/9 for EAP-AKA' or 3-11 for 5G AKA). The solution proposes no changes to the challenge request/response message exchanges involved in the primary authentication.
Step 7. The AUSF if finds that the RES* verification (if 5G AKA) or Authentication challenge verification (EAP-AKA') is successful, then the network considers the primary authentication as successful. If a Slice Selection Information Not Available was received in step 2a from AMF/SEAF, then the AUSF determines to hold the UE security context temporarily until the AMF/SEAF informs the AUSF about its serving capability.
Step 8. The AUSF can send to the AMF/SEAF, the authentication result as success, SUPI, and AMF serving Capability Check Required indication.
Step 9a-9b. The initial AMF on receiving the SUPI along with AMF serving Capability Check Required indication, determines to check if a reroute is required or not based on TS 23.502 [2] as shown in step 9a-b.
Step 9c. If the AMF decides to perform an indirect AMF reroute, then it determines to facilitate the UE security context provisioning to the newly selected target AMF.
If the AMF determines to perform indirect AMF reroute via RAN, then sets the AMF service capability result as '0'.
Else, if the AMF determines to perform direct AMF reroute/ if it is capable to serve the UE based on the UE subscription information/slice subscription data, then sets the AMF service capability result as '1'.
Step 10. The AMF/SEAF sends to AUSF, the SUPI, AMF Reroute Security Required Indication, AMF service capability result, Target AMF Information, and optionally SUCI. As an alternative, in addition the AMF/SEAF can also send the ABBA to AUSF in this step.
Alternatively, if No Reroute via RAN is determined, then AMF/SEAF sends to AUSF the SUPI, AMF service capability result set to '1'.
Step 11. The AUSF on receiving a AMF service capability result set as '0', and Reroute Security Required Indication, it determines to store the UE security context to facilitate the security provisioning to the Target AMF at a later point of time when required (i.e. after reallocation). The AUSF derives an authentication information AMF_AUTN from the UE context available in the AUSF (for the Target AMF using the hash of AUSF, SUPI, RAND, SNN and the target AMF information).
Alternatively, for no Reroute via RAN case, the AUSF on receiving from AMF/SEAF, AMF service capability result with '1', provides the Anchor key, SUPI and authentication result to the initial AMF and the initial AMF can setup NAS Security similar to the existing system.
Step 12. The AUSF sends to the AMF/SEAF, the SUPI, AMF_AUTN, AUSF locally stores the AMF_AUTN along with the SUPI with SUCI, Kausf, ABBA (if received), Kseaf and corresponding SNN. The SEAF forwards the received SUPI, authentication result as success, SUPI, AMF_AUTN, to the initial AMF.
Step 13a.	The AMF sends a reroute NAS message to the NG-RAN with initial UE message, reroute due slicing, Routing Information (to indicate the AUSF holding the context) and AMF_AUTN. As an alternative, in addition the initial AMF can send the ngKSI in the Reroute NAS message.
Step 13b.	The NG-RAN forwards the received Reroute NAS message to the Target AMF with initial UE message, reroute due slicing, Routing Information, ngKSI (if received) and AMF_AUTN.
Step 14.	The Target AMF on receiving the Reroute NAS message with reroute due slicing, Routing Information and AMF_AUTN will attempt to contact the right AUSF based on the Routing Information. The Target AMF sends to appropriate AUSF, the Nausf_UEAuthentication_Authenticate Request containing the SUCI, SNN, and the received AMF_AUTN (to authenticate itself with AUSF to fetch the UE security context). The target AMF if received a ngKSI, then that ngKSI can be used to identify the partial native security context created after the successful primary authentication.
Step 15.	The AUSF verifies the received AMF_AUTN and SNN based on the UE authentication information locally stored. If the Target AMF provided AMF_AUTN matches with the locally stored AMF_AUTN for a SUCI and/or SUPI, then the AUSF considers the AMF_AUTN verification as successful.
Step 16.	The AUSF sends to SEAF of the Target AMF, the authentication result, SUPI and Kseaf (the anchor key) as in the existing system and the rest follows similar to the existing procedures. Further the SEAF sends the ABBA parameters, authentication result as success, and Kamf key to the Target AMF. As an alternative, if the AUSF in addition received ABBA in step 10, the AUSF sends the ABBA received to SEAF and the SEAF is required to use the received ABBA.
NOTE 1:	The ABBA parameter usage should be same as in the existing system. TS 33.501 [3] specified the ABBA parameter value as '0x0000'. The UE uses the ABBA parameter provided by the SEAF in the calculation of KAMF as specified in TS 33.501  [3] clause A.7.1 ABBA parameter values.
NOTE 2:	For EAP-AKA', perform step 11 as specified in TS 33.501  [3] clause 6.1.3.1. For 5G AKA, perform step 12 as specified in TS 33.501  [3] clause 6.1.3.2.0.
Step 17.	The Target AMF on receiving the Kamf and authentication result can trigger the NAS Security mode command (NAS SMC) procedure with UE when required to activate the UE NAS security context as in TS 33.501  [3].
Adaptations for Registration Mobility Update:
This clause describes the simple adaptations required to address security handling in AMF-reallocation during registration mobility update procedure as shown in Figure 6.7.2-2.
Figure 6.7.2-2: Security context handling during registration mobility update
NOTE 3:	According to TS 33.501 [3] clause 6.9.3 for the case where source/old AMF sends new 5G security context to Initial AMF, it states, 'The source AMF subsequently deletes the 5G security context which it holds.'
Step 1. If the Registration Request contains 5G-GUTI (pointing to an old AMF), the initial AMF performs the following accordingly for various scenarios mentioned in clause 4.3 'Architecture and security assumptions', of the present document:
Case 1-2.a.i) N14 interface exists only between Initial AMF and Old AMF:
Step 2a-b. The Initial AMF based on TS 33.501 [3] clause 6.9.3, fetches SUPI and security context from the old AMF by providing the 5G-GUTI and the registration request. Further SUPI and subscription information (fetched from UDM as shown in 2b.3) can be used to decide whether to reroute the Registration Request according to TS 23.502 [2] clause 4.2.2.2.3 step 2. If a reroute is required, the initial AMF, if fetched the UE context (as in TS 23.502 [2] clause 5.2.2.2.2) from the old AMF, it can use the slice information to perform (2b.4) Nnssf_NSSelection service operation based on TS 23.502 [2] clause 4.2.2.2.3 step 4a-b. Also, for the case, where the current 5G security context is fetched, the AMF may decipher the NAS container with the same security context, and get the initial NAS message and so if there is any Requested NSSAI provided by UE, it can also be used in Nnssf_NSSelection service operation (even though it is an optional IE according to TS 23.502 [2] clause 5.2.16.2.1). If an indirect AMF allocation and reroute via RAN is required, the initial AMF does not send any NAS message to the UE (i.e. it does not use current/new 5G security context fetched from old AMF), in turn can perform reroute via RAN.
Step 2c.1. If another AMF is selected, the initial AMF sends a reject indication to the old AMF and the old AMF continues as if the Namf_Communication_UEContextTransfer had never been received.
Step 2c.2. Target AMF discovery can be based on TS 23.502 [2] clause 4.2.2.2.3 steps 6a-b.
Step 3-4. The initial AMF performs reroute via RAN as in TS 23.502 [2] clause 4.2.2.2.3 step 7B.
Step 5a-b. The Target AMF on receiving the initial NAS message with 5G-GUTI finds that it is not able to identify the related old AMF and considers that it cannot identify the UE with 5G-GUTI and so initiates identity request procedure with UE and get SUCI.
Step 6. The target AMF initiates primary authentication by sending authentication request with SUCI (without Slice Selection Information Not Available Indication, because the target AMF is aware that this is reroute due to slicing as received in Reroute NAS message as in TS 23.502 [2] clause 4.2.2.2.3 step 7B).
The target AMF will not include any Slice Selection Information Not Available Indication, so the AUSF soon after successful response verification will provide Anchor key to the AMF/SEAF as in existing system.
Case 2-2.a.ii)	No N14 exists between Initial AMF and old AMF and also no N14 exists between target AMF and old AMF: As the initial AMF lack N14 with old AMF, the UE cannot be identified by means of a temporary identity (5G-GUTI) and so the initial AMF performs Subscription identification procedure (as shown in step 2b.1) with UE and continues with primary authentication (as shown in step 2b.2) with the adaptations described in Figure 6.6.2-1 steps 2a-17 as applicable.
Case 3-2.b.i)	N14 exists between Initial AMF and old AMF and also between target AMF and old AMF: The initial AMF having N14 with old AMF will act similar to Case 2-2.a.i steps 1-4.
Step 5-6. The Target AMF on receiving the initial NAS message with 5G-GUTI finds it can contact the corresponding old AMF. Based on local policy and reroute due to slicing indication received in reroute NAS message, the target AMF may fetch security context from old AMF (or) determines not to fetch security context from old AMF and perform Identity request/response procedure and primary authentication accordingly (as in case 2.a.i).
If the target AMF fetches security context from old AMF, either based on local policy the target AMF may use current/new security context fetched from old AMF or the target may determine to perform primary authentication with SUPI (as in case 2.a.i, but SUPI is used instead of SUCI).
NOTE 4: Further the case 2.b.i may not be feasible according to the vertical slice isolation requirement and it may need to be aligned with the clause 4.3.
Case 4-2.b.ii)	N14 exists only between target AMF and old AMF: As the initial AMF lack N14 with old AMF, the UE cannot be identified by means of a temporary identity (5G-GUTI) and so the AMF performs Subscription identification procedure (as shown in 2b.1) with UE and continues with primary authentication (as shown in 2b.2) based on the adaptations described in Figure 6.6.2-1 steps 2a-13. The target AMF on receiving the reroute NAS message (i.e. Registration Request with 5G-GUTI), based on local policy, received authentication information (AMF_AUTN) and reroute due to slicing indication, determine to fetch and use security context related to an authentication information received in the reroute NAS message from the AUSF and if required can fetch UE context from the old AMF.",TR 33.864,6.7.2,all_images/image_452.jpeg,AMF Serving Capability based Security Context handling during primary
"The initial AMF protects the security context (or the horizontally derived security context) using the public key of the target AMF set provided by the NSSF. Then the initial AMF sends both the Registration Request (RR) and the protected NAS security context container (including the security context along with the keyAmfHDerivationInd indicator if needed and potentially UL/DL NAS COUNTs) to the target AMF via RAN. In this solution, the following things are assumed.
-	The NSSF has the public key of the target AMF set, and the target AMF has the corresponding private key.
-	The target AMF has information that can verify the digital signature of NSSF.
Figure 6.10.2-1: AMF re-allocation with 5G NAS security context re-route via RAN based on asymmetric cryptography
Figure 6.10.2-1 shows the solution steps:
1.	The UE prepares a Registration Request message including a SUCI or 5G-GUTI and slicing information which could potentially cause an AMF re-allocation such as Requested NSSAI. If the UE has a 5G NAS security context (Registration with 5G-GUTI) it includes a protected NAS container in the Registration Request message.
2.	Steps 2-6b of TS 23.502 [2], clause 4.2.2.2.3 are followed.
3.	If there is a need for slice selection, (see clause 5.15.5.2.1 of TS 23.501 [2]), e.g. the initial AMF cannot serve all the S-NSSAI(s) from the Requested NSSAI permitted by the subscription information, the initial AMF invokes the Nnssf_NSSelection_Get service operation from the NSSF by including the Requested NSSAI.
4.	The NSSF performs the steps 4b specified in clause 4.2.2.2.3 of TS 23.502 [2]. In addition, the NSSF performs the following:
-	The NSSF selects the public key of the target AMF set (PK.tAMF) and generates a token. The NSSF includes the token and PK.tAMF in the response to the initial AMF.
The token consists of claims and digital signature of NSSF on them. The claims may include the following: the NF Instance Id of NSSF (issuer), NF Instance ID of the initial AMF (subject), the target AMF set ID (audience), and expiration time (expiration).
5.	The initial AMF optionally performs horizontal Kamf derivation of Kamf-0 to generate a new Kamf-1. This step would ensure that the target AMF has no access to the Kamf-0 key used by the initial AMF. If the Initial AMF performs horizontal Kamf derivation then the initial AMF resets the corresponding uplink and downlink NAS COUNTs.
6.	The initial AMF prepares the NAS security context container which consists of the security context (including Kamf-0 or Kamf-1), the keyAmfHDerivationInd indicator (optional), and other parameters (optional, e.g. UL/DL NAS COUNTs).
The initial AMF generates its own ephemeral key pair, ePK.iAMF (ephemeral public key) and eSK.iAMF (ephemeral private key). The initial AMF uses PK.tAMF and eSK.iAMF to create the ephemeral encryption key and ephemeral MAC key.
The initial AMF generates the protected NAS security context container by performing the followings: 1) to encrypt the NAS security context container using the ephemeral encryption key, 2) to apply MAC function to the ciphertext value, 3) to collect ciphertext and MAC-tag.
The above process is the same as the ECIES scheme specified in Annex C.3.2 of TS 33.501 [3].
7.	The initial AMF forwards the complete Registration Request message, the protected NAS security context container, ephemeral public key of the initial AMF (ePK.iAMF), and the token to the RAN.
8.	The RAN forwards the complete Registration Request message, the protected NAS security context container, ePK.iAMF, and the token to the target AMF.
9.	The target AMF verifies the token. The target AMF verifies the digital signature of NSSF in the token. The target AMF verifies the claims included in the token.
The target AMF use the private key associated with PK.tAMF and the ephemeral public key of the initial AMF to create the ephemeral encryption key and ephemeral MAC key.
The target AMF decrypts the ciphertext in the protected NAS security context container using the ephemeral encryption key. The target AMF verifies the MAC-tag in the protected NAS security context container using the ephemeral MAC key.
The above process is the same as the ECIES scheme specified in Annex C.3.3 of TS 33.501 [3].
10. After decrypting the security context,
-	If SUCI is included in the Registration Request, the target AMF skips step 10 (as no additional information about established PDU sessions etc. is stored in the old AMF).
-	If a 5G-GUTI is included in the Registration Request and the target AMF has received a 5G NAS security context and potentially a keyAmfHDerivationInd indicator, then:
-	If there is no connectivity between the target AMF and old AMF (cases 2.a.ii and 2.b.ii in clause 4.3), the target AMF skips step 10 (as any additional information about established PDU sessions etc. stored in the old AMF cannot be retrieved by the target AMF).
- If there is connectivity between the target AMF and the old AMF (cases 2.a.i and 2.b.i in clause 4.3), the target AMF can fetch any additional information about established PDU sessions etc. stored in the old AMF.
11.	If the target AMF has received the keyAmfHDerivationInd indicator, then the target AMF runs a NAS SMC procedure with the UE, to take the new Kamf-1 key into use with the UE.
12.	The target AMF needs to initiate a new primary authentication with the UE to generate a new Kamf-2. The new primary authentication procedure is protected by the Kamf-1. This step would ensure that the initial AMF has no access to the new Kamf-2 key generated between target AMF and the UE.
The target AMF determines that a NAS re-route via RAN has taken place and the target AMF uses the Kamf-1 only for the purpose of sending protected NAS Security Mode Command and Authentication Challenge/Request to the UE, and for receiving protected NAS Security Mode Complete and Authentication Response from the UE.
13-14. The target AMF needs to run a new NAS SMC procedure with the UE to take the new Kamf-2 into use with the UE. The target AMF needs to include the request to the UE to include the complete Registration Request message in the NAS Security Mode Complete message by setting the flag ""request initial NAS flag"" in the NAS Security Mode Command message. The UE includes the complete Registration Request message (sent in step 1) in the NAS Security Mode Complete message to the target AMF. This means that the target AMF can take the Registration Request message received in NAS Security Mode Complete message into use and drop the Registration Request message rerouted via RAN.",TR 33.864,6.10.2,all_images/image_455.jpeg,AMF re-allocation with 5G NAS security context re-route via RAN based on
"The present document studies the security enhancements on the support for Edge Computing in the 5G Core network defined in TS 23.548 [3], and application architecture for enabling Edge Applications defined in TS 23.558 [2].
For the EC supported in 5GC, please refer to TS 23.548 [3].
For the application architecture for enabling Edge Applications, a new architecture is defined in TS 23.558 [2] as shown in the figure,
Figure 4-1: Architecture for enabling edge applications - reference points representation
Within this architecture, the Edge Enabler Client (EEC) deployed in the UE retrieves the Edge configuration information from the Edge Configuration Server (ECS), The Edge configuration information includes the information for the EEC to connect to the EES (e.g. EDN service area); and the information for establishing a connection with EESs (such as URI). Based on the Edge configuration information, EEC could also acquire the required EAS information from the discovered EES. ECS enables other authorized EES to access their services. Meanwhile, EES enables other authorized EAS to access their services. The ECS, EES and EAS acts as AFs for consuming network services directly from the 3GPP 5G Core Network entities over the service based architecture specified in 3GPP TS 23.501 [14].
For more details on enabling Edge Applications, please refer to TS 23.558 [2].",TR 33.839,4,all_images/image_458.jpeg,Architecture for enabling edge applications - reference points representation
"In the solutions for the EAS discovery procedure in TR 23.748 [3], the following DNS based solution is proposed. The solution requires a new Functionality, an enhanced DNS Forwarder here referred to as ""LDNSR"". LDNSR supports Edge AS Discovery using DNS using knowledge of the 5GC connectivity of the UE.. Figure 5.9.1-1: Options for the EAS discovery using LDNSR for PDU session breakout. New function LDNSR is introduced for EAS discovery, and the interaction between SMF and LDNSR is also introduced. The SMF may provide knowledge of the 5GC connectivity of the UE to LDNSR, the information about the knowledge of the 5GC connectivity of the UE is sensitive material which should be security protected.. In the above solution, a DNS request is sent to query the Edge Server's address. If the DNS destination address is modified by the attacker, DNS request will be sent to the compromised DNS server, then the wrong Edge Server address may be allocated. This attack may make UE connected to a far Edge Server and ruin the advantage of the MEC, even worse, the compromised DNS server may lead UE to connect to a compromised Edge Server.",TR 33.839,5.9.1,all_images/image_459.jpeg,Options for the EAS discovery using LDNSR for PDU session breakout
"Figure-6.2.2.1-1: Authentication between the EEC and ECS based on primary authentication
The authentication procedure details are as following:
Step 0: UE performs primary authentication with the network. Then KAUSF is shared between UE and AUSF in Home network. UE performs PDU session establishment procedure as defined in TS 23.502.
Step 1: UE generates a credential Kedge and Kedge ID using KAUSF and SUPI, and stored securely. The method to derive generate Kedge and Kedge ID is in 6.2.2.2.
Step 2: AUSF generates a credential Kedge and Kedge ID using KAUSF and SUPI, and stored securely.
Step 3: UE computes MACEEC using the Kedge and EEC ID (defined in TS 23.558 [2]). The method to generate MACEEC is in 6.2.2.3.
Step 4: UE sends Application Registration request (EEC ID, MACEEC, Kedge ID) to ECS. Whether this message is send using NAS or user plane is based on SA2's decision.
Step 5: ECS sends Authentication verification (EEC ID, MACEEC, Kedge ID) to NEF for verification.
Step 6: NEF discovers the AUSF based on Kedge ID, and sends Authentication verification (EEC ID, MACEEC, Kedge ID) to AUSF for MACEEC verification.
Note 1: 	How to discover the AUSF is not addressed here.
Step 7: AUSF retrieves Kedge using Kedge ID, and verify MACEEC using the (Kedge and EEC ID).
Step 8: If verification in AUSF succeed, then AUSF sends Authentication verification response(success) back to NEF, otherwise, AUSF sends Authentication verification response(fail) to NEF.
Step 9: NEF sends Authentication verification response(success/fail) from AUSF to ECS.
Step 10: Based on the verification results, ECS decides whether to accept or reject the authentication request, and sends Authentication Request accept/rejection to EEC in the UE.
Note 2: 	How the AUSF can be aware of each specific Kedge per UE is not addressed here.",TR 33.839,6.2.2.1,all_images/image_460.jpeg,Authentication between the EEC and ECS based on primary authentication
"6.3.2.1	Authentication and Authorization procedure between EEC and ECS/EES
Figure 6.3.2-1: Authentication/Authorization framework for Edge Enabler Client and Servers
Step 1: The UE performs the procedures as defined in TS 23.502 [5] to get the 5GC network access.
Step 1A: At the end of the network access authentication procedure (Primary authentication and key agreement TS 33.501, clause 6.1)), the UE and the AUSF are in possession of the key KAUSF.
Step 2A-2C: The UE and the AUSF derives the AKMA key as specified in TS 33.535 [6]. The AUSF provides the AKMA key to the AAnF as specified in TS 33.535 [6].
Step 2D-2J: The UE initiates the Initial provisioning procedure with the ECS and includes AKMA Key ID. ECS is Application Function (AF) for the AAnF as specified in TS 33.535 [6]. The ECS contacts the AAnF (using AKMA key ID) to obtain the corresponding key KECS (KAF) of the UE, if it does not hold a valid KECS of the UE or the AKMA Key ID provided by the UE is different from the previous AKMA Key ID. The AAnF provides the derived key (KAF) to the ECS for the Edge Computing service. The KECS is the AKMA Application Key (KAF) and derived as specified in TS 33.535 [6] by both the UE and the ECS.
The key KECS is used by the ECS to derive the key KECS-PSK. The KECS-PSK is derived as defined in clause 6.3.2.1 of the present document, which is used as the PSK to establish TLS between the EEC and the ECS. Once the KECS-PSK is derived, the ECS includes the CounterECS used to derive the KECS-PSK, to the UE in the initial provisioning response message. On receiving the initial provisioning response message, the UE derives KECS-PSK, as derived by the AUSF using the received CounterECS value.
Step 2K: EEC establish the TLS session with the ECS, to secure the communication. TLS is used to provide integrity protection, replay protection and confidentiality protection for EDGE-4 interface. Mutual authentication is performed between the EEC and the ECS using TLS, based on pre-shared keys (KECS-PSK) following RFC 4279 [18] for TLS 1.2 and RFC 8446 [19] for TLS 1.3.
Step 2L-2M: Once TLS session is created successfully, the EEC initiates the service provisioning procedure with the ECS (as specified in clause 8.3 in TS 23.558 [2]) over the established TLS. If the UE is authorised to access the EES, then the ECS generates (as detailed in clause 6.3.2.2 of the present document) and provide the access token and ID token to the UE over the established TLS session. Additionally, the ECS may provide EES root CA certificate to the EEC, which is used to validate the EES's certificate.
Step 3: The UE performs EEC registration (as specified in clause 8.4.2 in TS 23.558 [2]) and discovery (as specified in clause 8.5 in TS 23.558 [2]) with the EES.
Step 3A: Before sending the access token and ID token to the EES, the UE and the EES establish a secure TLS connection using EES server certificate. Edge Configuration Server may provide EES root CA certificate during the initial provisioning procedure (Step 2M) to the EEC to validate the EES's certificate. TLS provides integrity protection, replay protection, and confidentiality protection over the EDGE-1 interface. It is required to protect and to provide the access token to an authentic EES.
Step 3C-3E: The UE initiates EEC registration procedure with the EES, including the access token and ID token obtained from the ECS in Step 2J. The access token and ID token included in registration request provides authentication and the authorization check for the EEC registration request by verifying of the access token and ID token issued by the ECS to the UE. The EES obtains the token validation service from the ECS.
Step 3F-3I: When the UE initiates EAS discovery procedure with the EES by including the same access token and ID token obtained from the ECS in Step 2M, if it is valid. Again the EES obtains the access token validation service from the ECS. The EES also optionally requests and obtains the token(s) from the ECS for the UE to grant access to the EAS(s). Then in response to the request, the EES optionally includes the EAS access grant token(s), with relevant information like validity time, to the UE.
If the obtained tokens from the ECS (in Step 2M) is not valid (due to time limitation), then the EEC requests ECS for a new access token as shown in figure 6.3.2-1. The token request message includes the necessary parameters to identify the EEC security context and parameters for authenticity verification. After verification of the authenticity, the ECS provides new tokens to the EEC, in response to the request.
NOTE :	The authentication and authorization between AC and EAS is out of scope of the present document. For completeness, steps 4A-4F only detail a possible procedure to be used in application layer.
Steps 4A-4F: The UE obtains service from EAS, by producing the access token and ID token obtained from the EES, over the secure TLS connection. The UE also obtains security policy and the relevant tokens from the EES in Step 3I. Before sending the access token and ID token to the EAS, the UE and the EAS establish a secure channel using EAS server certificate. It is required to protect and to provide the access token and ID token to an authentic EAS. The EAS obtains the token validation service from the ECS via EES. After successful validation of the tokens, the UE obtains the Edge Computing service from the EAS.
6.3.2.2	KECS-PSK derivation
KECS-PSK generation is performed using the key derivation function (KDF) specified in Annex B.2.0 of TS 33.220 [8]. When deriving a KECS-PSK from KECS, the following parameters, KECS and CounterECS are used to form the input S to the KDF.
To generate the KECS-PSK, the ECS use a counter, called a CounterECS. The EEC and the ECS associates a 16-bit counter, CounterECS, with the key KECS. The ECS initializes the CounterECS to 0x00 0x01 when the KECS is derived. The EEC and the ECS maintains the CounterECS for lifetime of the KECS. The ECS sets the CounterECS to 0x00 0x02 after the first derived KECS-PSK, and monotonically increment it for each additional derived KECS-PSK.
The CounterECS is incremented by the ECS for every new computation of the KECS-PSK. The CounterECS is used as freshness input into KECS-PSK derivations, to mitigate the replay attack. The ECS sends the value of the CounterECS (used to generate the KECS-PSK) to the EEC. The EES accepts CounterECS value that is greater than stored CounterECS value. The ECS suspends the Initial provisioning procedure, if the CounterECS associated with the KECS is about to wrap around. When a fresh KECS is generated, the CounterECS at the ECS is reset to 0x00 0x01 and the ECS resumes the Initial provisioning procedure.
6.3.2.3	Access token generation
The access token is opaque to EEC and is consumed by the EES. The access token shall be encoded as a JSON Web Token as defined in IETF RFC 7519 [30]. The access token shall include the JSON web digital signature profile as defined in IETF RFC 7515 [29]. The access tokens shall convey the standards-based claims as defined in IETF RFC 7662 [31].
NOTE: 	Additional claims to be conveyed by access token is up to the EDGE service requirement.
6.3.2.4	ID token
The ID Token can be a JSON Web Token (JWT) and contain the standard claims as defined in by the OpenID Connect 1.0 specification [32] and are required for EDGE service implementation.
NOTE: 	Additional claims to be conveyed by ID token is up to the EDGE service requirement.",TR 33.839,6.3.2,all_images/image_461.png,Authentication/Authorization framework for Edge Enabler Client and Servers
"Figure 6.4.2-1: Secondary Authentication Based Authentication/Authorization framework for Edge Enabler Client and Servers
The procedure includes the following steps:
Step 0: UE pre-configuration: If the ECS deployed by MNO is contracted with one or more ECSP(s), the ECS provides EES configuration information of MNO owned, and ECSP owned EESs via MNO ECS as described in clause 8.3.3.2 in 23.558 [2]. If a non-MNO ECSP deploys the ECS, the ECS endpoint address may be configured with the EEC. An EEC that is aware of multiple ECSP's ECS endpoint addresses may perform the service provisioning procedure per ECS ECSP multiple times. As part of provisioning EEC may have installed ECS's TLS certificates.
Step 1: Primary Authentication: In this step, UE performs primary authentication with the network.
Step 2a, 2b: PDU session: As a result of UE initiating the service provisioning procedure with the ECS (as specified in clause 8.3 in TS 23.558 [2]), UE establishes a PDU session. This PDU Session may be established either to a well-known or pre-configured S-NSSAI or DNN, or the 5GC derives the S-NSSAI by using the registration for UE to network in step 1. Based on this information, the AMF selects an SMF, which in turn selects a PSA that provides a data connection to the Edge Cloud Service Provider's (Edge Data Network's) AAA Server. SMF continues secondary authentication as per clause 11.1.2 in 33.501[7]. ECS may act as DN-AAA Server.
Step 3a, 3b: After successful UE-requested PDU Session Establishment authentication/authorization by an EDN-AAA server, the device discovers and connects to a ECS server address (that was preconfigured in the UE in step 0 or is derived from the application identifier and/or Service Provider Identifier provided by the user in step 1) for provisioning EEC with ECS. The UE performs EEC registration (as specified in clause 8.4.2 in TS 23.558 [2]) and Discovery (as specified in clause 8.5 in TS 23.558 [2]) with the EES.
EEC establish the TLS session with the ECS, to secure the communication. TLS is used to provide integrity protection, replay protection and confidentiality protection for EDGE-4 interface. Certificate-based Mutual authentication is performed between the EEC and the ECS using TLS, following RFC 5246 [25] for TLS 1.2 and RFC 8446 [19] for TLS 1.3 After successfully establishing the secure session over EDGE-4 as in step 2, the Edge Enabling Client should send an Initial Provisioning request with Access Token Request message to the Edge Configuration Server as per the OAuth 2.0 specification. The Edge Configuration Server should verify the Access Token Request message per OAuth 2.0 specification. If the Edge Configuration Server successfully verifies the Access Token Request message, the Edge Configuration Server should generate an access token specific to the Edge Enabling Client and return it in an Initial Provisioning Response (Access Token Response) message.
Step 4.a: On EDGE-1, the Edge Enabling Client authenticates to the Edge Enabling Server by establishing a TLS session with the Edge Enabling Server based on the Server (Edge Enabling Server) side certificate authentication or certificate-based mutual authentication) as indicated by Edge Configuration Server. Edge Configuration Server may provide Edge Enabling Client's root CA certificate during the registration response (as specified in clause 8.4 in TS 23.558[2]) to the Edge Enabling Server to validate the Edge Enabling Client's certificate. TLS provides integrity protection, replay protection, and confidentiality protection over the EDGE-1 interface. It is required to protect and to provide the access token to an authentic EES.
Step 4.b: The UE initiates the EEC registration procedure with the EES, including the access token obtained from the ECS in Step 3.b. The authorization check for the EEC registration request is performed by verifying the access token issued by the ECS to the UE. The EES obtains the access token validation service from the ECS. In another option, the access token validation service by the ECS could be replaced by an authorization service by the ECS that does not require a token to be issued by the ECS to the UE but details are not in scope of this solution.
Step 5: EEC requests a service (e.g. Discovery) with access token obtained in step 4. The Edge Enabling Server should validate the access token. The Edge Enabling Server verifies the integrity of the access token by verifying the Edge Configuration Server signature. If validation of the access token is successful, the Edge Enabling Server should verify the Edge Enabling Client's Service request against the authorization claims in the access token, ensuring that the Edge Enabling Client has access permission for the requested service.
e.g. When the UE initiates the EAS discovery procedure with the EES by including the same access token obtained from the ECS in Step 3.b if it is valid. Again, the EES obtains the access token validation service from the ECS. The EES also optionally requests and obtains the access token(s) from the ECS for the UE to grant access to the EAS(s). In response to the request, the EES optionally includes the EAS access grant token(s), with relevant information like validity time, to the UE.
If the obtained access token from the ECS (in Step 3.b) is not valid, then the EEC requests ECS for a new access token, as shown in figure 6.3.X-1. The access token request message includes the necessary parameters to identify the EEC security context and parameters for authenticity verification. After verifying the authenticity, the ECS provides a new access token to the EEC in response to the request.
NOTE:	The authentication and authorization between AC and EAS is out of scope of the present document. Step 6 is only a possible procedure to be used in application layer for completeness.
Step 6: The UE obtains service from EAS by producing the access token obtained from the EES over the secure TLS connection. The UE also obtains security policy and the relevant access token from the EES in Step 5. Before sending the access token to the EAS, the UE and the EAS establish a secure channel using the EAS server certificate. It is required to protect and to provide the access token to an authentic EAS. The EAS obtains the access token validation service from the ECS via EES. After successful validation of the access token, the UE obtains the Edge Computing service from the EAS.",TR 33.839,6.4.2,all_images/image_462.jpeg,Secondary Authentication Based Authentication/Authorization framework for Edge
"Figure 6.5.2-1: Authentication and Authorization between the EEC and the EES
For this solution implement, there is a prerequisite: both the UE and the EES support the secondary authentication.
The procedure assumes that the Edge Configuration Server is deployed by the MNO. In this case, the EES is the authentication server in the Edge Data Network.
1. The UE registers in the operator network and perform the primary authentication procedure. After primary authentication, the UE has the information of Edge Configuration Server.
Note 1: 	How the ECS is involved in the primary authentication is to be clarified.
2 When the UE triggers the edge service it sends the PDU session establishment request to the AMF to setup the PDU session for the services provided by Edge Data Network. The SMF should trigger EAP Authentication procedure and perform the role of the EAP Authenticator.
3-4. The steps 3, 4, are the same as steps 5a-5b in clause 11.1.2 of TS 33.501[7].
5. The secondary authentication procedure is required to perform if the SMF check the UE has not been authenticated and authorized by the EES. The EES is the authentication server (AAA) of the Edge Data Network.
Note 2: 	How to make SMF aware that it should communicate with EES for secondary authentication is to be clarified.
6. This step is the same as steps 8-15 in clause 11.1.2 of TS 33.501[7].
7. After the successful completion of the secondary authentication procedure, the EES sends EAP Success message to the SMF including the registration response.
8. The SMF sends a Namf_Communication_N1N2MessageTransfer to the AMF with the received information.
9. The AMF forwards NAS SM PDU Session Establishment Response message including EAP Success.",TR 33.839,6.5.2,all_images/image_463.jpeg,Authentication and Authorization between the EEC and the EES
"Figure 6.9.2-1: Authentication/Authorization between Edge Enabler Client and ECS
Pre-conditions:
-	The EEC and ECS have shared A-KID and KAF via AKMA (as specified in TS 33.535 [1]).
-	The ECS or the 5GC is configured with the edge computing related profile for the EEC.
-	The ECS and the 5GC share an UE identifier (i.e. GPSI) to identify the EEC.
-	The ECS stores the association between EEC ID and UE identifier. This association is pre-configured in the ECS by the ECS administrator.
Step 1: UE initiates the service provisioning procedure with EEC ID included (as specified in clause 8.3 in TS 23.558 [2]).
Step 2: The ECS retrieves GPSI from EEC ID according to the preconfigured association.
Step 3: In order to prove the authenticity of the UE's GPSI, the ECS sends an association check request to UDM (if the ECS is located out of 5GC, the request should be sent via NEF), including the GPSI and A-KID.
Step 4: In order to verify the association of GPSI and A-KID, the UDM first contacts the AUSF to obtain the corresponding SUPI of the A-KID. Afterwards, the UDM verifies the association of the GPSI and A-KID according to the association between SUPI and GPSI.
Step 5: The UDM sends the association verification response back to the ECS.
Step 6: On successful verification, the ECS retrieves the edge computing related profile for the EEC either from the 5GC or from its local database. Afterwards, the ECS can determine the EEC's authorization based on EEC's profile.
Step 7: The ECS sends the provisioning response back to EEC.",TR 33.839,6.9.2,all_images/image_465.png,Authentication/Authorization between Edge Enabler Client and ECS
"Figure 6.10.2-1: Authentication and Authorization between the Edge Enabler Client and the Edge Configuration Server
The procedure assumes that the Edge Configuration Server is deployed by the MNO. 
The authentication between the Edge Enabler Client and the Edge Configuration Server reuses the 5G primary authentication procedure in the PLMN. The UE can obtain information to access the Edge Configuration Server via the registration accept message. The Authorization information of the Edge Enabler Client is retrieved from the UDM in the 5GC.
1. The UE sends a Registration Request with edge computing service capability.
2. The UE and the 5G core network preform the primary authentication procedure as described in clause 6.1.2 of TS 33.501[7].
3. The AMF sends UE the Registration Accept message with suitable ECS address information.
4. The Edge Enabler Client sends service provisioning request to the ECS.
5. The ECS verifies the binding between the EEC ID and the GPSI. Then the ECS obtains service authorization of the Edge Enabler Client from the UDM via the NEF. The UDM stores an indicator whether the user is allowed to use edge computing service and the allowed ECS list. The indicator can be used as the service authorization information for the EEC. The subscription expiration time and the binding between the EEC ID and the GPSI may also be stored in the UDM. When the ECS sends request, the GPSI is included in the request message.
Note: 	It is not addressed here how the ECS verifies the binding between EEC ID and GPSI, and how the UDM stores the binding between EEC ID and GPSI.
6. The UDM will check whether the user has been authorized to access to the ECS for edge computing service with GPSI corresponding to the EEC ID. If the user is authorized, the UDM responses with the service authorization response message to the ECS via the NEF.
7. The ECS sends service provisioning response to the Edge Enabler Client.",TR 33.839,6.10.2,all_images/image_466.jpeg,Authentication and Authorization between the Edge Enabler Client and the Edge
"Figure 6.12.2-1: Authentication/Authorization framework for EES with ECS
Step 1-2: The Edge Enabling Server and Edge Configuration Server should establish a secure session based on TLS (Server-side certificate authentication). The Edge Enabling Server should use the credential information obtained in step 1 to establish the TLS session with the Edge Configuration Server.
Step 3: After the successful establishment of the TLS session, the Edge Enabling Server should send an Edge Enabler Server Registration message to the Edge Configuration Server along with the credential (OAuth access token) and EES Profile. The Edge Enabling Server generates the key pair {Private Key, Public key} and provides the public key along with the Onboard Edge Enabling Server request.
Step 4: The Edge Configuration Server should validate the enrolment credential (OAuth token). After successful verification of credentials (OAuth Token), Edge Configuration Server may generate Edge Enabling Server's certificate on its own, for the assigned Edge Enabling Server identity and public key. For subsequent authentication procedures with the Edge Configuration Server, the Edge Enabling server may use this certificate to establish a secure connection and authentication with the Edge configuration Server. When the third party issues edge Enabling Server's client certificate, then in Step 3, the Edge Enabling Server can include the certificate in the Onboard Edge Enabling Server request message. If the Edge Configuration Server trusts the issuer of the Edge Enabling Server's client certificate, then the Edge Configuration Server includes the provided certificate in the Edge Enabling Server's profile in step 4. It is up to the Edge Computing Service Provider domain policy to accept the third party's client certificates.
Step 5: The Edge Configuration Server should respond with a Registration response message. The response should include the Edge Configuration Server assigned Edge Enabling Server Registration ID, Edge Enabling Server Authentication and authorization information (if generated in step 4), Edge Enabling Server's certificate.",TR 33.839,6.12.2,all_images/image_467.jpeg,Authentication/Authorization framework for EES with ECS
"Figure 6.16.2-1: EEC authentication and authorization framework with ECS and EES
It is assumed that AKMA, TLS, and OAuth is supported by the UE, ECS, and EES.
Step 1-3. UE with EEC functionality registers in the 5G network, and retrieves ECS information (i.e. ECS Id and AKMA capability) from 5GC. The AKMA capability indicates the ECS support to use AKMA.
There are two options for the authentication and data protection between EEC and ECS.
Option A (The EDGE-4 is deployed based on the UP connection):
Step 4-6. The UE determines to use AKMA based on the received AKMA capability, AKMA defined in the TS 33.535 [6] is reused here to negotiate the pre-shared key KECS between UE and ECS. Here the A-KID sent from the UE is authenticated by the ECS based on the AKMA mechanism.
Step 7a. EEC and ECS establish the TLS security tunnel based on the pre-shared key KECS. The authentication is fulfilled based on the TLS.
Option B (The EDGE-4 is deployed based on the CP connection):
Step 7b. The protection between EEC and ECS relies on the NAS and SBI interface protection. The authentication is implicitly performed as the primary authentication.
NOTE 1: 	CP connection option between EEC and ECS is not addressed in the present document.
NOTE 2: 	The following EDGE-4 data could be protected based on Option A or Option B according to its connection option.
Step 8. EEC sends the Provisioning request message to the ECS, including its EEC ID, application info.
Step 9. ECS determines the EES info (including EES Id, AKMA capability), and generate the Oauth token with the following claims, i.e. EEC ID, ECS ID, EEC info, the authorized services.
NOTE 3: 	Whether the EEC ID could use the edge service can be authorized based on the local policy. The token for consuming the ECS service may not be needed.
Step 10. ECS sends the token and EES info back to the EEC via the Provisioning response message.
Step 11. Similar with step 4-6, pre-shared key KEES is negotiated between EEC and EES.
Step 12. EEC and EES establish the TLS security tunnel based on the pre-shared key KEES. The authentication is fulfilled based on the TLS.
Step 13. EES sends the EEC registration/ discovery request message to the EES, including the token.
Step 14. EES authorizes the EEC based on the verification of the token.
Step 15. If the verification successes, the EES sends the EEC registration/ discovery response message back to the EEC.",TR 33.839,6.16.2,all_images/image_468.jpeg,EEC authentication and authorization framework with ECS and EES
"Figure 6.18.2-1: Authentication and Authorization with the Edge Data Network
1.	The UE performs normal primary authentication and registration to the network. The UE is MEC capable and may indicate this in the MEC capabilities to the AMF during the registration procedure.
2.	The UE establishes a PDU Session for IP connectivity (Additional information IE in UL NAS transport message with request type PDU Session Establishment request includes EEC ID). If the UE is MEC capable, then the UE and the AMF derive a key KProxy for authentication with the ECS from the AMF key KAMF. AMF pushes the EEC ID and KProxy to the Proxy AA network function in one of the options. Proxy AA network function maintains a mapping of EEC ID and KProxy.
Note: In case of Option 2, Proxy AA can identify the serving AMF by identifying ""Allocated AMF for the registered UE"" field in the ""UE context in AMF data"" as per TS 23.502 [5] 5.2.3.3.1.
Note 1: 	It is not addressed in the present document how proxy AA gets UE context.
Note 2: 	Whether the Kamf can be used to derive the Kecs in case ECS is deployed by the home network is not addressed in the present document.
Note 3: 	It is not addressed in the present document how this solution works if the EEC ID is not unique across different UEs.
3.	The UE sends an Application Registration Request with a MAC-IProxy to the ECS. The MAC-IProxy is computed similarly as, e.g. the SoR-MAC-IAUSF, as defined in Annex A.17 of TS 33.501. The MAC-IProxy is based on the Application Registration Request's payload, which forms the input Application Registration Request Data, and the key KProxy to the KDF.
4.	a. The UE is not authenticated at the ECS, and the ECS sends a Verify Request including the Application Registration Request with the MAC-IProxy to the Proxy AA through NEF, which then either verifies by retrieving context its own stored mapping (step 2 option 1) or it sends a key request to AMF by selecting serving AMF based on UE ID the serving AMF and forwards the message to this AMF.
4. b. The AMF replies with KProxy to Proxy AA, which then stores this in its database. Proxy AA verifies the MAC-IProxy of the Application Registration Request, i.e. it computes with the key KProxy the MAC-I over the Application Registration Request payload the UE and compares the result with the MAC-IProxy included in the message. If both are identical, the message can be authenticated to be sent by the UE.
4. c. Proxy AA Devices KECS from KProxy.
4.d. The Proxy AA sends a Key Response to the ECS, including the result of the authentication and the KECS.
5.	Based on the authentication result, the ECS decides whether to accept or to reject the Application Registration Request from the UE. The ECS sends the Application Registration Response message to the UE, including the authentication result, and protects the message with a MAC-IECS based on the received key KECS in a similar way as the UE protected the payload of the message.
6.	The UE derives KECS from KProxy and verifies the MAC-IECS. The rest of the procedure will proceed from step 10 of solution 6.7 in 33.839.",TR 33.839,6.18.2,all_images/image_469.jpeg,Authentication and Authorization with the Edge Data Network
"This subclause contains the message flows for the protection of a model A restricted discovery. The flows show how a particular discovery is protected. The exact details of the actual protection to be applied to a discovery message are given in subclause 6.1.3.4.3. The message flows apply when both the UEs are roaming or when one or both are in their HPLMN. If either of the UEs is not roaming some steps in the flows are omitted as detailed in the flows.
The flows are broken down into 4 boxed stages to better relate to the procedures given in TS 23.303 [2]. The first, second and fourth stage correspond to subclause 5.3.3.4A, 5.3.3.5A and 5.3.4.2A of TS 23.303 [2] respectively. The interaction between the ProSe Function(s) and HSS is omitted for simplicity.
Figure 6.1.3.4.2.1-1: Flows for securing model A restricted discovery
Steps 1-4 refer to an Announcing UE.
1. Announcing UE sends a Discovery Request message containing the RPAUID to the ProSe Function in its HPLMN in order to get the ProSe Code to announce and to get the associated security material. The command indicates that this is for announce (Model A) operation, i.e. for an Announcing UE.
2. The ProSe Function may check for the announce authorization with the ProSe Application Server depending on ProSe Function configuration.
3. The ProSe Functions in the HPLMN and VPLMN of the Announcing UE exchange Announce Auth. messages. If the Announcing UE is not roaming, these steps do not take place.
4. The ProSe Function in the HPLMN of the Announcing UE returns the ProSe Code and the corresponding Code-Sending Security Parameters, along with the CURRENT_TIME and MAX_OFFSET parameters. The Code-Sending Security Parameters provide the necessary information for the Announcing UE to protect the transmission of the ProSe Code (see subclause 6.1.3.4.3.2) and are stored with the ProSe Code. The Announcing UE takes the same actions with CURRENT_TIME and MAX_OFFSET as described for the Announcing UE in step 4 of subclause 6.1.3.3.1 of the current specification.
Steps 5-10 refer to a Monitoring UE
5. The Monitoring UE sends a Discovery Request message containing the RPAUID to the ProSe Function in its HPLMN in order to be allowed to monitor for one or more Restricted ProSe Application IDs.
6. The ProSe Function in the HPLMN of the Monitoring UE sends an authorization request to the ProSe Application Server. If, based on the permission settings, the RPAUID is allowed to discover at least one of the Target RPAUIDs contained in the Application Level Container, the ProSe Application Server returns an authorization response.
7. If the Discovery Request is authorized, the ProSe Function in the HPLMN of the Monitoring UE contacts the ProSe Function in the HPLMN of the Announcing UE, by sending a Monitor Request message, as specified in clause 5.3.3 of TS 23.303 [2].
8. The ProSe Function in the HPLMN of the Monitoring UE may exchange authorization messages with the ProSe Application Server.
9. The ProSe Function in the HPLMN of the Announcing UE responds to the ProSe Function in the HPLMN of the Monitoring UE with a Monitor Response message including the ProSe Code, the corresponding Code-Receiving Security Parameters (see subclause 6.1.3.4.3.3) and an optional Discovery User Integrity Key (DUIK). The Code-Receiving Security Parameters provide the information needed by the Monitoring UE to undo the protection applied by the announcing UE. The DUIK shall be included as a separate parameter if the Code-Receiving Security Parameters indicate that the Monitoring UE shall use Match Reports for MIC checking. The ProSe Function in the HPLMN of the Monitoring UE stores the ProSe Code and the Discovery User Integrity Key (if it received one outside of the Code-Receiving Security Parameters).
NOTE 1:	There are two configurations possible for integrity checking, namely, MIC checked by the ProSe Function, and MIC checked at the UE side. Which of the configuration is used is decided by the ProSe Function that assigned the ProSe Code being monitored, and signalled to the Monitoring UE in the Code-Receiving Security Parameters.
10. The ProSe Function in the HPLMN of the Monitoring UE returns the Discovery Filter and the Code-Receiving Security Parameters, along with the CURRENT_TIME and MAX_OFFSET parameters. The Monitoring UE takes the same actions with CURRENT_TIME and MAX_OFFSET as described for the Monitoring UE in step 9 of subclause 6.1.3.3.1 of the current specification. The UE stores the Discovery Filter and Code-Receiving Security Parameters.
Steps 11 and 12 occur over PC5.
11. The UE starts announcing, if the UTC-based counter provided by the system associated with the discovery slot is within the MAX_OFFSET of the announcing UE's ProSe clock and if the Validity Timer has not expired. The UE forms the discovery message and protects it as described in 6.1.3.4.3.2. The four least significant bits of UTC-based counter are transmitted along with the protected discovery message.
12. The Monitoring UE listens for a discovery message that satisfies its Discovery Filter, if the UTC-based counter associated with that discovery slot is within the MAX_OFFSET of the monitoring UE's ProSe clock. In order to find such a matching message, it processes the message as described in 6.1.3.4.3.3.  If the Monitoring UE was not asked to send Match Reports for MIC checking, it stops at this step from a security perspective. Otherwise it proceeds to step 13.
NOTE 2:	The UE checking the integrity of the discovery message on its own does not prevent the UE from sending a Match Report due to requirements in TS 23. 303 [2]. If such a Match Report is sent, then there is no security functionality involved.
Steps 13-16 refer to a Monitoring UE that has encountered a match.
13. If the UE has either not had the ProSe Function check the MIC for the discovered ProSe Code previously or the ProSe Function has checked a MIC for the ProSe Code and the associated Match Report refresh timer (see step 15 for details of this timer) has expired, then the Monitoring UE sends a Match Report message to the ProSe Function in the HPLMN of the monitoring UE. The Match Report contains the UTC-based counter value with four least significant bits equal to four least significant bits received along with discovery message and nearest to the monitoring UE’s UTC-based counter associated with the discovery slot where it heard the announcement, and other discovery message parameters including the ProSe Code and MIC. The ProSe Function checks the MIC.
14. The ProSe Function in the HPLMN of the Monitoring UE may exchange an Auth Req/Auth Resp with the ProSe App Server to ensure that Monitoring UE is authorised to discover the Announcing UE.
15. The ProSe Function in the HPLMN of the monitoring UE returns to the Monitoring UE an acknowledgement that the integrity check passed. It also provides the CURRENT_TIME parameter, by which the UE (re)sets its ProSe clock. The ProSe Function in the HPLMN of the Monitoring UE shall include the Match Report refresh timer in the message to the Monitoring UE. The Match Report refresh timer indicates how long the UE will wait before sending a new Match Report for the ProSe Code.
16. The Prose Function in the HPLMN of the Monitoring UE may send a Match Report Info message to the ProSe Function in the HPLMN of the Announcing UE.",TS 33.303,6.1.3.4.2.1,all_images/image_474.png,Flows for securing model A restricted discovery
"This subclause contains the message flows for the protection of a model B restricted discovery. The flows show how a particular discovery is protected. The exact details of the actual protection to be applied to a discovery message are given in subclause 6.1.3.4.3. The message flows apply when both the UEs are roaming or when one or both are in their HPLMN. If either of the UEs is not roaming some steps in the flows are omitted as detailed in the flows.
The flows are broken down into 4 boxed stages to better to relate to the procedures given in TS 23.303 [2]. The first, second and fourth stage correspond to subclause 5.3.3A.3, 5.3.3A.5 and 5.3.4A.2 of TS 23.303 [2] respectively. The interaction between the ProSe Function(s) and HSS is omitted for simplicity.
Figure 6.1.3.4.2.2-1: Flows for securing model B restricted discovery
Steps 1-4 refer to a Discoveree UE.
1. Discoveree UE sends a Discovery Request message containing the RPAUID to the ProSe Function in its HPLMN in order to get the ProSe Code to announce and associated security material. The command indicates that this is for ProSe Response (Model B) operation, i.e. for a Discoveree UE.
2. The ProSe Function may check for the announce authorization with the ProSe Application Server depending on ProSe Function configuration.
3. The ProSe Functions in the HPLMN and VPLMN of the Discoveree UE exchange Announce Auth. messages. If the Discoveree UE is not roaming, these steps do not take place.
4. The ProSe Function in the HPLMN of the Discoveree UE returns the ProSe Response Code and the Code-Sending Security Parameters, Discovery Query Filter(s) and their Code-Receiving Security Parameters corresponding to each discovery filter along with the CURRENT_TIME and MAX_OFFSET parameters. The Code-Sending Security Parameters provide the necessary information for the Discoveree UE to protect the transmission of the ProSe Response Code (see subclause 6.1.3.4.3.2) and are stored with the ProSe Response Code. The Code-Receiving Security Parameters provide the information needed by the Discoveree UE to undo the protection applied to the ProSe Query Code by the Discoverer UE (see subclause 6.1.3.4.3.3). The Code-Receiving Security Parameters shall indicate a Match Report will not be used for MIC checking. The UE stores each Discovery Filter with its associated Code-Receiving Security Parameters. The Discoveree UE takes the same actions with CURRENT_TIME and MAX_OFFSET as described for the Announcing UE in step 4 of subclause 6.1.3.3.1 of the current specification.
Steps 5-10 refer to a Discoverer UE
5. The Discoverer UE sends a Discovery Request message containing the RPAUID to the ProSe Function in its HPLMN in order to be allowed to discover one or more Restricted ProSe Application IDs.
6. The ProSe Function in the HPLMN of the Discoverer UE sends an authorization request to the ProSe Application Server. If, based on the permission settings, the RPAUID is allowed to discover at least one of the Target RPAUIDs contained in the Application Level Container, the ProSe Application Server returns an authorization response.
7. If the Discovery Request is authorized, the ProSe Function in the HPLMN of the Discoverer UE contacts ProSe Function in the HPLMN of the Discoveree UE, by sending a Discovery Request message, as specified in clause 5.3.3A of TS 23.303 [2].
8. The ProSe Function in the HPLMN of the Discoveree UE may exchange authorization messages with the ProSe Application Server.
9. The ProSe Function in the HPLMN of the Discoveree UE responds to the ProSe Function in the HPLMN of the Discoverer UE with a Discovery Response message including the ProSe Query Code(s) and their associated Code-Sending Security Parameters, ProSe Response Code and its associated Code-Receiving Security Parameters (see subclause 6.1.3.4.3.3), and an optional Discovery User Integrity Key (DUIK) for the ProSe Response Code. The Code-Receiving Security Parameters provide the information needed by the Discoverer UE to undo the protection applied by the Discoveree UE. The DUIK shall be included as a separate parameter if the Code-Receiving Security Parameters indicate that the Discoverer UE shall use Match Reports for MIC checking. The ProSe Function in the HPLMN of the Discoverer UE stores the ProSe Response Code and the Discovery User Integrity Key (if it received one outside of the Code-Receiving Security Parameters). The Code-Sending Security Parameters provide the information needed by the Discoverer UE to protect the ProSe Query Code (see subclause 6.1.3.4.3.2)
NOTE 1: There are two configurations possible for integrity checking, namely, MIC checked by the ProSe Function, and MIC checked at the UE side; this is decided by the ProSe Function that assigned the ProSe Code being monitored, and signalled to the Monitoring UE in the Code-Receiving Security Parameters.
10. The ProSe Functions in the HPLMN and VPLMN of the Discoverer UE exchange Announce Auth. messages. If the Discoverer UE is not roaming, these steps do not take place.
11. The ProSe Function in the HPLMN of the Discoverer UE returns the Discovery Response Filter and the Code-Receiving Security Parameters, the ProSe Query Code and the Code-Sending Security Parameters along with the CURRENT_TIME and MAX_OFFSET parameters. The Discoverer UE takes the same actions with CURRENT_TIME and MAX_OFFSET as described for the Monitoring UE in step 9 of subclause 6.1.3.3.1 of the current specification. The UE stores the Discovery Response Filter and its Code-Receiving Security Parameters and the ProSe Query Code and its Code-Sending Security Parameters.
Steps 12 to 14 occur over PC5.
12. The Discoverer UE sends the ProSe Query Code and also listens for a response message, if the UTC-based counter provided by the system associated with the discovery slot is within the MAX_OFFSET of the announcing UE's ProSe clock and if the Validity Timer has not expired. The Discoverer UE forms the discovery message and protects it as described in 6.1.3.4.3.2. The four least significant bits of UTC-based counter are transmitted along with the protected discovery message.
13a. The Discoveree UE listens for a discovery message that satisfies its Discovery Filter, if the UTC-based counter associated with that discovery slot is within the MAX_OFFSET of the Discoverer UE's ProSe clock. In order to find such a matching message, it processes the message as described in 6.1.3.4.3.3.
NOTE 1a: Match Reports are not used for the MIC checking of ProSe Query Codes.
13b. The Discoveree sends the ProSe Response Code associated with the discovered ProSe Query Code. The Discoveree UE forms the discovery message and protects it as described in 6.1.3.4.3.2. The four least significant bits of UTC-based counter are transmitted along with the protected discovery message.
14. The Discoverer UE listens for a discovery message that satisfies its Discovery Filter. In order to find such a matching message, it processes the message as described in 6.1.3.4.3.3.  If the Discoverer UE was not asked to send Match Reports for MIC checking, it stops at this step from a security perspective. Otherwise it proceeds to step 15.
NOTE 2: The UE checking the integrity of the discovery message on its own does not prevent the UE from sending a Match Report due to requirements in TS 23. 303 [2]. If such a Match Report is sent, then there is no security functionality involved.
Steps 15-18 refer to a Discoverer UE that has encountered a match.
15. If the Discoverer UE has either not had the ProSe Function check the MIC for the discovered ProSe Response Code previously or the ProSe Function has checked a MIC for the ProSe Response Code and the associated Match Report refresh timer (see step 17 for details of this timer) has expired, then the Discoverer UE sends a Match Report message to the ProSe Function in the HPLMN of the Discoverer UE. The Match Report contains the UTC-based counter value with four least significant bits equal to four least significant bits received along with discovery message and nearest to the monitoring UE’s UTC-based counter associated with the discovery slot where it heard the announcement, and other discovery message parameters including the ProSe Response Code and MIC. The ProSe Function checks the MIC.
16. The ProSe Function in the HPLMN of the Discoverer UE may exchange an Auth Req/Auth Resp with the ProSe App Server to ensure that Discoverer UE is authorised to discover the Discoveree UE.
17. The ProSe Function in the HPLMN of the Discoverer UE returns to the Discoverer UE an acknowledgement that the integrity check passed. It also provides the CURRENT_TIME parameter, by which the UE (re)sets its ProSe clock. The ProSe Function in the HPLMN of the Discoverer UE shall include the Match Report refresh timer in the message to the Discoverer UE. The Match Report refresh timer indicates how long the UE will wait before sending a new Match Report for the ProSe Response Code.
18. The Prose Function in the HPLMN of the Discoverer UE may send a Match Report Info message to the ProSe Function in the HPLMN of the Discoveree UE.",TS 33.303,6.1.3.4.2.2,all_images/image_475.png,Flows for securing model B restricted discovery
"The ProSe Function of two UEs may belong to different PLMNs and, according to the current version of TS 23.303 [2], the application server is the entity which discloses the EPUID of a particular target UE to a ProSe Function so that it can request to the Prose Function managing that target UE the sending of its location information for a particular period of time.
The risk is that it would take just one Proximity Request from the UE for the ProSe Function to actually keep a record of [ALUID_B, EPUID_B, PFID_B] mapping and have the capability to later send a proximity request (step 4 of Proximity Request procedure in clause 5.5.5 of TS 23.303 [2]) although the UE didn't actually send a proximity request at all (step 4 of Proximity Request procedure in clause 5.5.5 of TS 23.303 [2]). This could lead to massive surveillance of users by other PLMNs that may be very difficult to detect by the PLMN which serves particular ProSe UEs.
Figure 6.3.1.1-1: extract from 3GPP TS 23.303 [2], Proximity request procedure (clause 5.5.5)",TS 33.303,6.3.1.1,all_images/image_478.jpeg,"extract from 3GPP TS 23.303 [2], Proximity request procedure (clause 5.5.5)"
"Figure 6.5.3.3-1: Overview of security establishment of ProSe Direct One-to-one communications
Figure 6.5.3.3-1 provides a high level overview of security establishment. In this flow, authentication and key establishment happens during steps 1 to 3 with the requirement that UE_2 must know KD at the end of step 2. Step 2 may involve several messages, and these messages depend on the type of Long term key(s). More details on this are provided in subclause 6.5.4. The actual establishment of a security context happens during steps 1, 3 and 4. More details on this are provided in subclause 6.5.5.
The integrity and confidentiality protection is applied at the PDCP layer. The details of this are given in subclause 6.5.6.",TS 33.303,6.5.3.3,all_images/image_480.jpeg,Overview of security establishment of ProSe Direct One-to-one communications
"Due to the asymmetric nature of the keying for relays, there are three rekeying cases that need to be considered. Firstly there is the rekeying that only changes KD-Sess but not KD. Secondly there is the rekeying that is initiated by the Remote UE that changes KD and finally rekeying that is initiated by the relay that changes KD. Each of these is described in turn.
Rekeying without changing KD happens exactly as described in subclause 6.5.5.3. The Remote UE includes its PRUK ID as the Long Term ID in the Direct Rekey Request messages, whereas the relay does not include a Long Term Key ID.
A rekeying that changes KD that is triggered by the Remote UE is shown in figure 6.7.3.2.1.3-1. The steps follow subclause 6.5.5.3 and only message contents that are specific to this use are included
Figure 6.7.3.2.1.3-1: Rekeying KD when rekeying was initiated by the Remote UE
1; The Remote UE send a Direct Rekey Request including its PRUK ID to the Relay.
2a, 2b, 2c, 3a and 3b. The content and handling of these messages are the same as messages in the Attach flow (subclause 6. 7.3.2.1.1) except the security contexts are handled as in subclause 6.5.5.3.
A rekeying that changes KD that is initiated by the relay proceeds as follows. The relay sends a Direct Key Request that does not contain a Long Term ID. Instead of responding to this message, the Remote UE sends its own Direct Rekey Request and the procedure continues as for the rekeying that changes KD that is triggered by the Remote UE.",TS 33.303,6.7.3.2.1.3,all_images/image_485.jpeg,Rekeying KD when rekeying was initiated by the Remote UE
"The architecture proposed by this solution is similar to the existing one in EPC. The 3GPP AAA server fetches authentication vectors over Diameter interface SWx. However, since HSS is not present it is proposed that an AAA-IWF is deployed to relay authentication vectors requests and perform related protocol conversion between Diameter SWx and SBA services towards the UDM/ARPF in the 5GC. The AAA-IWF can be realized by the NSSAAF and use existing N59 reference point with the UDM/ARPF.
Additionally, this solution can also support SUPI privacy. This requires the 3GPP AAA to use updated SWx or new diameter interface, called SWx' here, that includes the SUCI instead of an IMSI as UE ID.
The assumed architecture is described in Figure 6.2.2.1-1.
Figure 6.2.2.1-1: NSWO access authentication using credentials retrieved from UDM/ARPF",TR 33.881,6.2.2.1,all_images/image_487.jpeg,NSWO access authentication using credentials retrieved from UDM/ARPF
"The architecture proposed by this solution supports co-existence with EPC. The 3GPP AAA server requests authentication vectors from the HSS over SWx.
If the HSS supports the authentication vector generation function for this user, then the HSS can provide the authentication vectors to the 3GPP AAA server as currently defined.
However, if the authentication vector generation function for this user has been moved to the UDM/ARPF, the HSS requests the authentication vectors from the UDM/ARPF using UDICOM NU1 reference point.
The architecture is described in Figure 6.3.2.1-1.
Figure 6.3.2.1-1: NSWO access authentication in 5GC via HSS
In scenarios where the Home Network supports a mixture of LTE only users, 5G users supporting interworking with EPC and 5G only users, an SLF/DRA can assist in routing the authentication vector requests towards the HSS (for LTE only users, 5G users supporting interworking with EPC) or towards UDM/ARPF (for 5G only users) via an AAA-IWF realized by the NSSAAF as described in solution 6.2.
This alternative architecture is described in Figure 6.3.2.1-2.
Figure 6.3.2.1-2: NSWO authentication in 5GC via SLF/DRA
Additionally, this solution can also support SUPI privacy. This requires the 3GPP AAA to use updated SWx or new diameter interface, called SWx' here, that includes the SUCI instead of an IMSI as UE ID. The SLF/DRA also assists in routing new or updated Diameter SWx' requests towards the UDM/ARPF via the AAA-IWF/NSSAAF as described in the next clause.",TR 33.881,6.3.2.1,all_images/image_489.jpeg,NSWO access authentication in 5GC via HSS
"Figure 6.3.2.2-1: Non-3GPP Access authentication using credentials retrieved from UDM/ARPF via HSS
Steps 0 to 4 are the same as described for solution 6.2.
NOTE 1:	In case NAI received from step4 does not contain a SUCI (i.e. contains an IMSI), the 3GPP AAA server retrieves IMSI from the NAI and authentication vectors from the HSS via SWx (steps 11b-13b) as in existing EPC procedure.
5. The 3GPP AAA Server receives the EAP Response/Identity message that contains the subscriber identity that is SUCI in NAI format. The 3GPP AAA decides to fetch authentication vectors from the UDM (referring step 6a) or from the HSS (referring step 6b to step 13b) based on local policy.
6a. The 3GPP AAA Server retrieves the authentication vectors from the UDM/ARPF via AAA-IWF with an updated Diameter MAR SWx' request which includes SUCI and the access network identity received in step 4 in the request message, as defined in solution 6.2. An SLF/DRA assists in routing updated Diameter SWx' requests towards the UDM/ARPF via the AAA-IWF/NSSAAF. The flows continue with step14.
6b. The 3GPP AAA Server sends an IMSI retrieval request with SUCI received from step 4 via a new Diameter command over SWx'. An SLF/DRA assists in routing the new Diameter SWx' request towards the UDM/ARPF via the AAA-IWF/NSSAAF.
NOTE 2:	In case NAI received from step4 contains a SUCI protected with Null Scheme, the 3GPP AAA server may retrieve IMSI from the SUCI by itself and skip step 6b to step10b.
7b. The AAA-IWF/NSSAAF discovers and selects an UDM e.g. based on the routing identifier of the SUCI and sends SUCI Deconcealment Request using a new Nudm service, e.g. Nudm_SUCIDeconcealment_Get, to the UDM.
8b. The UDM de-conceals the SUPI from the SUCI.
9b. The UDM sends the SUCI Deconcealment Response to the AAA-IWF/NSSAAF with the SUPI.
10b. The AAA-IWF/NSSAAF converts SUPI into IMSI and sends the IMSI retrieval Response to the 3GPP AAA server over SWx'.
11b. The 3GPP AAA Server sends an Auth Vector request with IMSI and the access network identity received from step 4. The request is routed to the HSS via SWx as currently specified. In the presence of multiple HSS instances in the Home Network of the user, an SLF/DRA will assist in routing the SWx request to the HSS where the user is defined.
In scenarios where the Home Network supports a mixture of LTE only users, 5G users supporting interworking with EPC and 5G only users, the SLF/DRA can also assist in routing the authentication vector requests towards the HSS (for LTE only users, 5G users supporting interworking with EPC) or towards UDM/ARPF (for 5G only users) via an AAA-IWF realized by the NSSAAF as described in solution 6.2.
12b. If the HSS supports the authentication vector generation function for this user, then the HSS provides the authentication vectors to the 3GPP AAA server as currently defined. If the authentication vector generation function for this user has been moved to the UDM/ARPF, the HSS requests the authentication vectors from the UDM/ARPF using UDICOM NU1 reference point as currently specified.
13b. The HSS sends the Auth Vector Response to the 3GPP AAA server over Diameter SWx.
Steps 14 to 17 are the same as described for solution 6.2.",TR 33.881,6.3.2.2,all_images/image_491.jpeg,Non-3GPP Access authentication using credentials retrieved from UDM/ARPF via
,TS 33.107,13,all_images/image_492.jpeg,3GPP UMTS HNB Architecture Basis for Lawful Interception
,TS 33.107,13,all_images/image_493.jpeg,3GPP HeNBs Architecture Basis for Lawful Interception
,TS 33.107,17.2,all_images/image_494.jpeg,ProSe One To Many Communications Intercept configuration
"Figure 17.2.2.1-1 shows the transfer of IRI relating to the one to many communications from the ProSe Function and ProSe Key Management Function to the DF2 and to the LEMF. If a target UE interacts with the ProSe Function or ProSe Key Management Function relating to one-to-many communications, a One-To-Many IRI event, is generated and sent via the Delivery Function 2 to the LEMF.
If an event involving an target occurs, the ProSe Function or ProSe Key Management Function shall send the relevant data to the DF2 for formatting and delivery to the LEMF.
Figure 17.2.2.1-1: Provision of Intercept Product for Public Safety One-To-Many Communications
NOTE:	There is signalling between the non-target ProSe UEs and the ProSe Function and PKMF, which is not shown in figure 17.2.2.1-1. This signalling is not relevant to the interception of the target UE.",TS 33.107,17.2.2.1,all_images/image_495.jpeg,Provision of Intercept Product for Public Safety One-To-Many Communications
"The Enhanced Location for IRI refers to a capability providing LCS-based location information when specific user service events related to the target of interception occur. An example of such service events are the events of IMS session initiation and termination.
Figure 19.3.1-1 depicts the architecture of Enhanced Location acquisition and delivery for the case when the LTF is associated with an IRI ICE.
Figure 19.3.1-1: LALS Model for Enhanced Location for IRI (ICE/LTF option)
Figure 19.3.1-2 depicts the architecture of Enhanced Location acquisition and delivery for the case when the LTF is associated with a DF2.
Figure 19.3.1-2: LALS Model for Enhanced Location for IRI (DF/LTF option)",TS 33.107,19.3.1,all_images/image_496.jpeg,LALS Model for Enhanced Location for IRI (ICE/LTF option)
"The Enhanced Location for IRI refers to a capability providing LCS-based location information when specific user service events related to the target of interception occur. An example of such service events are the events of IMS session initiation and termination.
Figure 19.3.1-1 depicts the architecture of Enhanced Location acquisition and delivery for the case when the LTF is associated with an IRI ICE.
Figure 19.3.1-1: LALS Model for Enhanced Location for IRI (ICE/LTF option)
Figure 19.3.1-2 depicts the architecture of Enhanced Location acquisition and delivery for the case when the LTF is associated with a DF2.
Figure 19.3.1-2: LALS Model for Enhanced Location for IRI (DF/LTF option)",TS 33.107,19.3.1,all_images/image_497.jpeg,LALS Model for Enhanced Location for IRI (DF/LTF option)
"Regarding the work split in clause 4.2, this key issue belongs to the group #(B) illustrated in Figure 4.2-1, i.e., security of backhaul-link between child-node and parent-node.. TR 38.874 [2] discusses recovery from backhaul-RLF in clauses 9.7.12 to 9.7.15. One possible option described in clause 9.7.14 is:. ""-	Option 2: The IAB-node DU explicitly alerts child IAB-nodes about the upstream RLF. Child IAB-nodes receiving this alert can forward the alert further downstream. Each IAB-node receiving such alert initiates BH-RLF recovery as discussed above."". A simplified illustration of backhaul-RLF recovery is shown in Figure 5.2.3.1-1. The RLF occurs between the IAB-donor and the IAB-node#1. This causes backhaul connectivity loss for the parent-node IAB-node#1. This also causes upstream backhaul connectivity loss for child-nodes IAB-node#2 and IAB-node#n. For the sake of example, the parent IAB-node#1 cannot recover the backhaul-link via the IAB-node#3 because of a big mountain between them. Therefore, the parent IAB-node#1 informs the child IAB-node#2 about the upstream backhaul connectivity loss so that the child IAB-node#2 can itself seek means to recover. The child IAB-node#2 identifies that the Path1 is lost. Therefore, it recovers using Path2 via the IAB-node#3.. Figure 5.2.3.1-1: A simplified illustration of backhaul-RLF recovery. This backhaul-RLF recovery is likely achieved by some form of control message between the parent-node and the child-node via a new adaptation layer called the BAP (Backhaul Adaptation Protocol), or via lower layer mechanism like MAC control element.. Even though this backhaul-RLF recovery is a rare event, it is very crucial to protect any form of control messages between the parent-node and the child-node. This is explained further in the threats below.. Note:	Reference for the recovery messages is not addressed in the present document.",TR 33.824,5.2.3.1,all_images/image_500.jpeg,A simplified illustration of backhaul-RLF recovery
"LPP is used point-to-point between a location server (E-SMLC, LMF or SLP) and a target device (UE or SET) in order to position the target device using position-related measurements obtained by one or more reference sources. Figure 4.1.1-1 shows the configuration as applied to the control- and user-plane location solutions for E-UTRAN and NG-RAN (as defined in TS 36.305 [2], TS 38.305 [40], TS 23.273 [42] and TS 23.271 [3]).
NB-IoT is a non-backward compatible variant of E-UTRAN supporting a reduced set of functionalities. In this specification, procedures and messages specified for the UE equally apply to the UE in NB-IoT.
Figure 4.1.1-1: LPP Configuration for Control- and User-Plane Positioning in E-UTRAN or NG-RAN",TS 37.355,4.1.1,all_images/image_501.jpeg,LPP Configuration for Control- and User-Plane Positioning in E-UTRAN or NG-RAN
,TS 37.355,6.5.2.2,all_images/image_503.jpeg,Exemplary calculation of some GNSS Acquisition Assistance fields.
"For the purposes of the present document, the following symbols apply:
	Percentage of the mean transmitted power emitted outside the occupied bandwidth on the assigned channel
BWChannel	Channel bandwidth (for E-UTRA and NR)
BWConfig	Transmission bandwidth configuration (for E-UTRA), where BWConfig = NRB x 180 kHz in the uplink and BWConfig = 15 kHz + NRB x 180 kHz in the downlink. Transmission bandwidth configuration (for NR), where BWConfig = NRB x SCS x 12.
BWRF	Base Station RF Bandwidth, where BWRF = FBW RF,high – FBW RF,low
BWRF,max	Maximum Base Station RF Bandwidth
DwPTS	Downlink part of the special subframe (for E-UTRA TDD operation)
f	Frequency
f	Separation between the Base Station RF Bandwidth edge frequency and the nominal -3dB point of the measuring filter closest to the carrier frequency
fmax	The largest value of f used for defining the requirement
ΔfOBUE	Maximum offset of the operating band unwanted emissions mask from the downlink operating band edge
ΔfOOB	Maximum offset of the out-of-band boundary from the uplink operating band edge
FC	Carrier centre frequency
Ffilter	Filter centre frequency
f_offset	Separation between the Base Station RF Bandwidth edge frequency and the centre of the measuring filter
f_offsetmax	The maximum value of f_offset used for defining the requirement
Fblock,high	Upper sub-block edge, where Fblock,high = FC,block,high + Foffset, RAT
Fblock,low	Lower sub-block edge, where Fblock,low = FC,block,low - Foffset, RAT
FBW RF,high	Upper Base Station RF Bandwidth edge, where FBW RF,high  = FC,high + Foffset, RAT
FBW RF,low	Lower Base Station RF Bandwidth edge, where FBW RF,low  = FC,low - Foffset, RAT
FC band, high	Center frequency of the highest transmitted/received carrier in a band.
FC band, low	Center frequency of the lowest transmitted/received carrier in a band.
FC,block, high	Centre frequency of the highest transmitted/received carrier in a sub-block.
FC,block, low	Centre frequency of the lowest transmitted/received carrier in a sub-block.
FC,high	Centre frequency of the highest transmitted/received carrier.
FC,low	Centre frequency of the lowest transmitted/received carrier.
Foffset, RAT	Frequency offset from the centre frequency of the highest transmitted/received carrier to the upper Base Station RF Bandwidth edge, sub-block edge or Inter-RF Bandwidth edge, or from the centre frequency of the lowest transmitted/received to the lower Base Station RF Bandwidth edge, sub-block edge or Inter-RF Bandwidth edge for a specific RAT.
FDL_low	The lowest frequency of the downlink operating band
FDL_high	The highest frequency of the downlink operating band
FUL_low	The lowest frequency of the uplink operating band
FUL_high	The highest frequency of the uplink operating band
GBChannel	Minimum guard band defined in subclause 5.3.3 of TS 38.104 [17]
PEM,N	Declared emission level for channel N
PEM,B32,B75,B76,ind	Declared emission level in Band 32, Band 75 and Band 76, ind=a, b, c
PEM,B32,ind	Declared emission level in Band 32, ind= d, e
PEM,B50,B74,B75,ind	Declared emission level for Band 50, Band 74 and Band 75, ind=a,b
Pmax	Maximum total output power
Pmax,RAT	Maximum RAT output power
Pmax,c	Maximum carrier output power
PRated,c	Rated carrier output power
PREFSENS	Reference Sensitivity power level
Wgap	Sub-block gap or Inter RF Bandwidth gap size
Figure 3.2-1: Illustration of Base Station RF Bandwidth related symbols and definitions for Multi-Standard Radio.
Figure 3.2-2: Illustration of Base Station RF Bandwidth related symbols and definitions for non-contiguous Multi-Standard Radio.
Figure 3.2-3: Illustration of Radio Bandwidth related symbols and definitions for Multi-band Multi-standard Radio (Dual-band Base Station)",TS 37.104,3.2,all_images/image_504.jpeg,Illustration of Base Station RF Bandwidth related symbols and definitions for Multi-
"For the purposes of the present document, the following symbols apply:
	Percentage of the mean transmitted power emitted outside the occupied bandwidth on the assigned channel
BWChannel	Channel bandwidth (for E-UTRA and NR)
BWConfig	Transmission bandwidth configuration (for E-UTRA), where BWConfig = NRB x 180 kHz in the uplink and BWConfig = 15 kHz + NRB x 180 kHz in the downlink. Transmission bandwidth configuration (for NR), where BWConfig = NRB x SCS x 12.
BWRF	Base Station RF Bandwidth, where BWRF = FBW RF,high – FBW RF,low
BWRF,max	Maximum Base Station RF Bandwidth
DwPTS	Downlink part of the special subframe (for E-UTRA TDD operation)
f	Frequency
f	Separation between the Base Station RF Bandwidth edge frequency and the nominal -3dB point of the measuring filter closest to the carrier frequency
fmax	The largest value of f used for defining the requirement
ΔfOBUE	Maximum offset of the operating band unwanted emissions mask from the downlink operating band edge
ΔfOOB	Maximum offset of the out-of-band boundary from the uplink operating band edge
FC	Carrier centre frequency
Ffilter	Filter centre frequency
f_offset	Separation between the Base Station RF Bandwidth edge frequency and the centre of the measuring filter
f_offsetmax	The maximum value of f_offset used for defining the requirement
Fblock,high	Upper sub-block edge, where Fblock,high = FC,block,high + Foffset, RAT
Fblock,low	Lower sub-block edge, where Fblock,low = FC,block,low - Foffset, RAT
FBW RF,high	Upper Base Station RF Bandwidth edge, where FBW RF,high  = FC,high + Foffset, RAT
FBW RF,low	Lower Base Station RF Bandwidth edge, where FBW RF,low  = FC,low - Foffset, RAT
FC band, high	Center frequency of the highest transmitted/received carrier in a band.
FC band, low	Center frequency of the lowest transmitted/received carrier in a band.
FC,block, high	Centre frequency of the highest transmitted/received carrier in a sub-block.
FC,block, low	Centre frequency of the lowest transmitted/received carrier in a sub-block.
FC,high	Centre frequency of the highest transmitted/received carrier.
FC,low	Centre frequency of the lowest transmitted/received carrier.
Foffset, RAT	Frequency offset from the centre frequency of the highest transmitted/received carrier to the upper Base Station RF Bandwidth edge, sub-block edge or Inter-RF Bandwidth edge, or from the centre frequency of the lowest transmitted/received to the lower Base Station RF Bandwidth edge, sub-block edge or Inter-RF Bandwidth edge for a specific RAT.
FDL_low	The lowest frequency of the downlink operating band
FDL_high	The highest frequency of the downlink operating band
FUL_low	The lowest frequency of the uplink operating band
FUL_high	The highest frequency of the uplink operating band
GBChannel	Minimum guard band defined in subclause 5.3.3 of TS 38.104 [17]
PEM,N	Declared emission level for channel N
PEM,B32,B75,B76,ind	Declared emission level in Band 32, Band 75 and Band 76, ind=a, b, c
PEM,B32,ind	Declared emission level in Band 32, ind= d, e
PEM,B50,B74,B75,ind	Declared emission level for Band 50, Band 74 and Band 75, ind=a,b
Pmax	Maximum total output power
Pmax,RAT	Maximum RAT output power
Pmax,c	Maximum carrier output power
PRated,c	Rated carrier output power
PREFSENS	Reference Sensitivity power level
Wgap	Sub-block gap or Inter RF Bandwidth gap size
Figure 3.2-1: Illustration of Base Station RF Bandwidth related symbols and definitions for Multi-Standard Radio.
Figure 3.2-2: Illustration of Base Station RF Bandwidth related symbols and definitions for non-contiguous Multi-Standard Radio.
Figure 3.2-3: Illustration of Radio Bandwidth related symbols and definitions for Multi-band Multi-standard Radio (Dual-band Base Station)",TS 37.104,3.2,all_images/image_506.jpeg,Illustration of Radio Bandwidth related symbols and definitions for Multi-band Multi-
"The transmitter transient period is the time period during which the transmitter is changing from the OFF period to the ON period or vice versa. The transmitter transient period is illustrated in Figure 6.4.2-1 and Figure 6.4.2-2.
Figure 6.4.2-1: Illustration of the relations of transmitter ON period, transmitter OFF period and transmitter transient period (for E-UTRA/UTRA)
Figure 6.4.2-2: Illustration of the relations of transmitter ON period, transmitter OFF period and transmitter transient period (for NR)",TS 37.104,6.4.2,all_images/image_507.jpeg,"Illustration of the relations of transmitter ON period, transmitter OFF period and"
"The assumption of the two-stage MIMO OTA method is that the measured far field antenna pattern of the multiple antennas can fully capture the mutual coupling of the multiple antenna arrays and their influence. Thus to do the two-stage MIMO OTA test, the antenna patterns of the antenna array needs to be measured accurately in the first stage. In order to accurately measure the antenna pattern of the intact device, the chipset needs to support amplitude and relative phase measurements of the antennas.
Stage 1: Test multiple antennas system in a traditional anechoic chamber. The chamber for antenna pattern measurement is set up as described in Annex A.2 in [4], where the DUT is put into a chamber and each antenna element’s far zone pattern is measured. Section B.4.3 gives description on how to measure each antenna element’s pattern using non-intrusive method. The influence of human body loss can be measured by attaching the DUT to a SAM head and or hand when doing the antenna pattern measurements. The DUT is placed against a SAM phantom, and the characteristics of the SAM phantom are specified in Annex A.1 of [4]. The chamber is equipped with a positioner, which makes it possible to perform full 3-D far zone pattern measurements for both Tx and Rx radiated performance. The measurement antenna should be able to measure two orthogonal polarizations (typically linear theta () and phi () polarizations as shown in Figure 6.3.1.3.1-1).
Figure 6.3.1.3.1-1: The coordinate system used in the measurements
Stage 2: Combine the antenna patterns measured in stage 1 into MIMO channel model, emulate the MIMO channel model with the measured antenna patterns incorporated in the commercial channel emulator and perform the OTA test in conducted approach.
The MIMO OTA method based on the above mentioned two-stage method is illustrated in Figure 6.3.1.3.1-2. The integrated channel model with both MIMO antenna effect and the multipath channel effect can be emulated with a commercial MIMO channel emulator. The BS emulator is connected to the MIMO channel emulator and then to the MIMO device’s temporary antenna ports via approved RF cables. These ports are the standard ones provided for conducted conformance tests. By controlling the power settings of the channel emulator and also the integrated channel model, the end-to-end throughput with the MIMO antenna radiation influence can be measured.
There are two different approaches to combine the antenna patterns with MIMO channel model.
a)	Apply antenna patterns to Ray-based channel models. Ray-based models are capable to support arbitrary antenna patterns under predefined channel modes in a natural way as described above. If Ray-based model like SCM model is specified to be used for MIMO OTA test, then the channel emulator needs to be able to support SCM channel model emulation and support loading measured antenna patterns.
b)	Apply antenna patterns to correlation-based channel models. MIMO channel model. With a correlation matrix calculation method for arbitrary antenna patterns under multipath channel conditions, the correlation matrix and the antenna imbalance can be calculated and then emulated by the channel emulator.
c)	This method can be used to measure the following figure of merit:
1)	Throughput
2)	TRP and TRS
3)	CQI, BLER
4)	Antenna efficiency and MEG
5)	Antenna correlation, MIMO channel capacity.
The coupling between the UE antenna and internal spurious emission of the UE might be characterized during the antenna pattern measurement stage inside the chamber by lowering down the signal power and is for further research.
Figure 6.3.1.3.1-2: Proposed two-stage test methodology for MIMO OTA test",TR 37.976,6.3.1.3.1,all_images/image_508.jpeg,Proposed two-stage test methodology for MIMO OTA test
"The test set-up uses an anechoic chamber. In case of an RX diversity measurement the signal from the base station emulator is routed via a two-channel fading to two antennas in the chamber. For an RX MIMO measurement, the two signals from the base station emulator can undergo a 2x2 channel fading simulation before reaching the antennas in the chamber, or can be routed directly to the probe antennas with some chosen polarization.
Figure 6.3.1.4.1-1 is a sketch of the chamber set-up. For obtaining various angles of arrival (AoA) at the EUT, two antennas A1 and A2 can be rotated in a vertical plane and can be put to angles θ1 and θ2. The UE is placed on a turntable rotating around the vertical axis by some angle φ. In addition, the UE may be tilted by some additional rotation around the horizontal axis, not shown in the figure. By this arrangement the two antennas A1 and A2 can send the signals from the base station emulator to any position on the unit sphere around the UE, thus creating arbirtrary AoA.
As an alternative to moving the antennas by mechanically rotating them it is possible to arrange the antennas in a horizontal plane and to move one antenna with respect to the other in order to vary the angle difference between the two. In that case the positioner rotating the UE will be designed in a more complex way.
Typically, the antennas are dual-polarised ones. In the usual configuration each antenna is sending its signal in one polarization only. Tests are made for the various combinations of antenna polarizations in order to generate either co-polarized or cross-polarized signals. As a special case it is also possible to test with one antenna where each polarization is transmitting one MIMO data stream. This will lead to identical AoAs for the two data streams.
If one wants to extend this method to 3D AoA, a third antenna outside the plane can be used.
The figure does not show an additional antenna used for the uplink communication. This antenna may be placed in the vicinity of the UE, for example in the φ positioner. It is common practise to use circularly polarized antennas for this purpose, and to use a limiting amplifier in the path towards the BSE in order to get a good and constant UL level.
Figure 6.3.1.4.1-1: 2 Channel Method, antenna arrangement in anechoic chamber
A test point is described by:
1)	Signal from BSE, e.g. frequency, MCS, data rate, MIMO mode, …
2)	Fading characteristics (if applicable) and antenna polarisations
3)	Antenna positions
4)	UE position elevation, azimuth
The detailed settings for the various parameters describing a test point are for further study.
The measurement then uses the quantities  and PMI for a quick evaluation of the channel characteristics for each given test point. More precisely, the DL power will be changed until a change in the returned channel information is observed.
In case the required figure of merit is some other quantity such as throughput, some mapping from the channel information onto the figure of merit can be made. This mapping of course depends on the signal settings on the BSE and possibly on other parameters. The mapping can be derived in a series of measurements where changes to the channel parameters lead to different channel information values and to different corresponding values of the figure of merit. It is also possible but more time-consuming to measure the figure of merit for each test point.
The OTA performance can better be described by taking statistical evaluations into account. If, for example, for each test point a relative throughput value is obtained as function of subcarrier power, one can plot the results for different points in a histogram and to obtain some CCDF indicating the conditions for getting at least a given TP value.",TR 37.976,6.3.1.4.1,all_images/image_509.png,"2 Channel Method, antenna arrangement in anechoic chamber"
"In order to calibrate the reverberation chamber a broadband antenna can be used to measure the losses in the chamber with a network analyzer. This takes < 10 minutes. CTIA RCSG is working on a standard methodology for reverberation chamber calibration.
There are no active electronics in the measurement path that needs to be calibrated.
Reflections in turntables, cables, doors, etc, do not degrade accuracy. Reflections increase the richness of the channel in the reverberation chamber.
Existing studies show that low standard deviation (good accuracy) can be achieved by measuring the DUT in sufficient number of different positions and calculate the average of the values. Some analysis (see relevant references in [2]) show a typical standard deviation less than 0.5 dB at about 800 MHz, in a reverberation chamber with a size of 1.2m x1.75m x 1.8m and continuous mode stirring. At higher frequencies or with a chamber of larger dimensions the standard deviation decreases and accuracy increases.
The following figure presents an example for an HSDPA receive diversity test configuration in a reverberation chamber.
For these tests we emulate an HSDPA call with a Node B emulator. The latter is connected to one of the 3 BS wall-mounted antennas through a switch. A fourth antenna allows measuring the DL received signal in the chamber with a spectrum analyzer.
Figure 6.3.2.1.1-1: Test bench configuration for testing in reverberation chamber
In order to create a Rayleigh fading environment, we’ve got 3 types of parameters that can be set using a tool on a computer plugged to the chamber:
-	Antenna among the 3, installed at the top of the cavity with different polarizations, is chosen
-	Turning the platform that holds the DUT
-	The 2 metallic stirrers near the walls can be moved on their axes",TR 37.976,6.3.2.1.1,all_images/image_510.jpeg,Test bench configuration for testing in reverberation chamber
"1.28 Mcps UTRA TDD option (TD-SCDMA) and E-UTRA TDD can have multiple uplink and downlink configurations, with TD-SCDMA having UL:DL=5:2, 4:3, 3:4, 2:5 and 1:6 configurations and E-UTRA TDD having UL:DL=3:1, 2:2, 1:3 configurations with 5 ms periodicity. However, due to the mix of bandwidths and technologies sharing common radio resources in MSR, it is difficult for TD-SCDMA and E-UTRA TDD sharing the common RF in arbitrary UL:DL configurations manner. According to the UL:DL configurations with TD-SCDMA and E-UTRA TDD defined in [3] and [2] , the interference will be unacceptable if the TD-SCDMA and E-UTRA TDD in 10 ms periodicity co-exist in the same geographical region with co-located and co-sited Base Stations. Furthermore, one UL:DL configuration of E-UTRA TDD with 5 ms periodicity can co-exist with one unique associated UL:DL configuration of TD-SCDMA if they are co-sited or co-located.
Figure 5.3.1-1: Alignment of TD-SCDMA and E-UTRA TDD
Figure 5.3.1-1 shows that the UL:DL=5:2, 3:4 and 2:5 configurations of TD-SCDMA can coexist with UL:DL= 3:1, 2:2 and 1:3 configurations of E-UTRA TDD respectively. Consider minimizing the interference between the TD-SCDMA and E-UTRA TDD, UL and DL alignment of TD-SCDMA and E-UTRA TDD with 5ms periodicity will be assumed in the initial work stage of MSR; For E-UTRA TDD with 10 ms periodicity and TD-SCDMA deployment scenarios, it might be very difficult to define the RF requirements for the TD-SCDMA and E-UTRA TDD co-existence in MSR mode and this case is left aside at this stage.
For minimizing the interference between the TD-SCDMA and E-UTRA TDD the UL and DL alignment of TD-SCDMA and E-UTRA TDD with 5 ms periodicity shall be assumed. The operating band outlined in Table 5.3-1 shall be considered for the MSR combination of TD-SCDMA and E-UTRA TDD.",TR 37.900,5.3.1,all_images/image_511.png,Alignment of TD-SCDMA and E-UTRA TDD
"For Band Category 2, there is a range of existing operator scenarios that are supported by today’s GSM specification. These include scenarios where a GSM carrier needs to be placed as close as 200 kHz from the RF bandwidth edge. In order to support these scenarios, the following principles are used for deriving a requirement:
1.	Foffset, RAT =200 kHz for GSM (see subclause 5.2.2). The number supports scenarios with two operators deploying GSM with a carrier spacing (centre-to-centre) of 400 kHz. Based on the existing operator scenarios and the GSM modulation spectrum, this is the smallest known carrier spacing possible to deploy.
2.	The baseline level for the UEM in BC2 is the BC1 mask (Table 6.6.1.5-1), which in turn was based on the UTRA spectrum emission mask (derived for a 43 dBm carrier). Hence the UEM chosen is fundamentally generic for BC1 and BC2 and will be applicable for all multi-RAT combinations that include a UTRA or E-UTRA signal (with the exception expressed in point 4), or both. The mask is not applicable for single-RAT GSM transmission.
3.	When a GSM carrier is operated with Foffset, GSM =200 kHz from the RF bandwidth edge, a modification will be needed from the UTRA mask level as shown in Figure 6.6.1.4.2-1. The reason is that the GSM modulation spectrum will exceed the UTRA mask levels for the first ~150 kHz outside the RF bandwidth edge. The modified part of the mask will have the shape of the 8PSK mask (TS45.005 [5] Clause 4.2.1 case a2) for 8PSK and Figure A.2b) in this frequency range, derived for 43 dBm GSM carrier. Since the UEM is based on a fixed 43 dBm carrier power, giving a mask that is independent of the carrier power, the UEM for BC2 in the 0 to 150 kHz frequency range will be more strict than the existing GSM spectrum mask for GSM carriers with an output power exceeding 43 dBm.
4.	When an E-UTRA carrier of 1.4 or 3 MHz channel bandwidth is operated adjacent to the RF bandwidth edge a modified level is also needed for E-UTRA requirements derived with Foffset, E-UTRA=BWChannel/2. The same modification as derived for GSM will be applied for this scenario.
5.	The requirements for Spectrum due to the modulation and wide band noise and intra BTS intermodulation of existing GSM multi-carrier BTS will be applied to MSR Base Station of BC2 for GSM single RAT operation.
Figure 6.6.1.4.2-1: UEM for BC2 in a GSM scenario with Foffset, RAT =200 kHz, based on the UTRA mask (red) and a modified level based on an 8PSK GSM mask (blue addition)",TR 37.900,6.6.1.4.2,all_images/image_512.jpeg,"UEM for BC2 in a GSM scenario with Foffset, RAT =200 kHz, based on the UTRA mask"
"The transmitter transient period is the time period during which the transmitter unit is changing from the OFF period to the ON period or vice versa. The transmitter transient period is illustrated in figure 6.4.3.1-1.
Figure 6.4.3.1-1: Illustration of the relations of transmitter ON period,
transmitter OFF period and transmitter transient period
This requirement applies at each TAB connector supporting transmission in the operating band.",TS 37.105,6.4.3.1,all_images/image_513.jpeg,"Illustration of the relations of transmitter ON period,"
"Traditionally when calculating the MU for the conducted tests it was sufficient to analyse a single test method, while for OTA tests the chamber is an integral part of the test environment and it is important to derive MU based on multiple chamber types and test methodologies. As such a framework has been developed to estimate MU's for different test methods and compare them equally.
The following 11 points have been agreed as a framework for developing OTA test:
1)	Multiple test methods may exist for each requirement.
2)	Each test method will require its own test procedure.
3)	A single conformance requirement applies for each core requirement, regardless of test procedure.
4)	Common maximum accepted test system uncertainty applies for all test methods addressing the same test requirement. Test methods producing significantly worse uncertainty than others at comparable cost should not impact the common maximum accepted test system uncertainty assessment.
5)	Common test tolerances apply for all test methods addressing the same test requirement.
6)	A common way of establishing the uncertainty result from all test methods' individual budgets is established.
7)	A common method of making an uncertainty budget (not a common uncertainty budget) is established.
8)	Establish budget format examples for each addressed test method in the form of lists of uncertainty contributions. Contributions that may be negligible with some BS and substantial with others should be in this list. For each combination of measurement method and test parameter, develop a list with measurement uncertainties.
9)	Describe potential OTA test methods relevant for testing radiated requirements (e.g. directional, TRP, or co-location requirements). The description requires information about the applicable test range architectures and test procedures. Addressing each item in each uncertainty budget with respect to the expected distribution of the errors, the mechanism creating the error and how it interacts with properties of the BS.
10)	Providing example uncertainty budgets will be useful in order to demonstrate the way a budget should be defined and how calculating its resulting measurement uncertainty is done, but the figures used in the examples will clearly be only examples and not applicable in general.
11)	Each test instance may require an individual uncertainty budget applicable for the combination of the test facility, the BS and the test procedure and property tested. Here, the tester demonstrates that the uncertainty requirement is fulfilled during the conformance testing.
The linking of core requirements via OTA test methods to conformance requirements is depicted in figure 5.1-2.
Figure 5.1-2: Examples of OTA core requirement to test requirement mapping
For TRP requirements the OTA conformance testing framework also considers additional aspects of the TRP measurements as detailed in clause 6.3. Depending on the TRP measurement procedure those additional aspects are, e.g. TRP sampling grids, additional MU contributors, TRP summation error, or ΔTRP correction factor, if applicable.",TR 37.941,5.1,all_images/image_516.png,Examples of OTA core requirement to test requirement mapping
"For each frequency, the reference angular steps  and  in degrees, are calculated as in [9]:
,
where D and Dcyl are defined further down in this clause. This implies a maximum angular step of 15 °. The upper limit for these reference angular steps of 15 ° ensures a low TRP summation error when is large compared to the BS dimensions.
The reference steps can be derived as follows. Consider two short vertical current elements separated a distance L along the z-axis. The EIRP pattern of this source is
Here, the element factor is  and  is the array factor contribution. To calculate the TRP value correctly, an angular sampling of  is required, see figure 6.3.4.2-1. But a single  is enough since the pattern is -independent (omni-directional).
Any current flowing on a line between the points  will correspond to source separations less than or equal to L. Hence its EIRP pattern will correspond to the same angular resolution, i.e., the average value will be correctly predicted using the same angular step.
Figure 6.3.4.2-1: The average EIRP when using different angular steps  and the EIRP pattern of two short vertical current elements separated a distance L=4, 8, 12, 16, and 32 wavelengths, respectively. The dashed lines depict the reference angular step  radians for the used source separations
To proceed to more general sources two observations are useful:
1)	A rotation of a source will not change the required  resolution, but the  resolution must be set equal to the  resolution.
2)	If the source distribution is stretched along the z-direction, the -resolution will not change.
Based on these two observations and the angular resolution of the line source of length L, the following can be deduced.
1)	If the line source is tilted 90 ° down to the xy-plane, and then arbitrarily rotated around the z-axis, a flat disc of diameter L is generated. Based on observation 1, the angular resolution is .
2)	If the disc is stretched a distance h along the z-axis (current elements are translated parallel to the z-axis), then the  is unchanged, whereas the vertical angular resolution increases to  to encompass the largest possible source separation within the cylinder.
The final shape of the source enclosure is hence a cylinder of diameter L and height h, and the angular steps required to get an accurate EIRP average (TRP value) are
, .
Here, D is the diameter of the source enclosure, i.e., the diameter of the smallest sphere enclosing all radiation sources, and Dcyl is the diameter of the smallest z-directed circular cylinder that encloses all sources.
Other methods for determining the reference angular steps are not precluded.
NOTE:	When sampling with the reference angular step, fine details of the radiation pattern are maybe not captured but the estimated TRP value is still accurate.
The spherical and cylindrical diameters are calculated as:
The radiation source can be the antenna array or even the whole BS, depending on the emissions to consider. This is further explained in clause 6.3.2.
Some basic definitions and relations are given here for readability.
Figure 6.3.4.2-2: The dimensions of a radiation source are depth (d), width (w) and height (h)
Optionally, for the specific case of a Uniform Linear Array (ULA) system, the array spatial pattern could be defined as in the following equation.
Where spatial frequency  is defined as following:
Similar to Nyquist sampling in the time domain signal, the Rayleigh resolution for spatial domain signal to avoid the aliasing can be derived as:
where d is the separation distance between antenna elements and m is the number of antenna elements. If BS is mounted along the y-z plane as shown in figure 6.3.4.2-3, based on the above considerations on the Rayleigh resolution for spatial domain signal, then subinterval in the φ and θ in degrees angle is calculated as:
Where Dy is length of radiating part of the BS along y-axis, Dz is length of radiated part of the BS along the z-axis and  is wavelength for the measured frequency. Arcsine is in radians.
Figure 6.3.4.2-3: Spherical coordinate for OTA conformance testing of BS
In the NR coexistence study, it was assumed that antenna configuration for wide area BS is 8x16 supporting two orthogonal polarizations. If BS mounted along y/z plane with antenna configuration 16x8 where 16 columns are assumed along the y-axis and 8 rows are assumed along the z-axis. Antenna elements are uniformly distributed with separation distance λ/2, therefore aperture size Dy ≈ 8λ and Dz ≈ 4λ. The uniform sampling in the spherical coordinate for this approach is demonstrated in the figure 6.3.4.2-4.
Figure 6.3.4.2-4: Uniform sampling in the spherical coordinate, red crosses denotes the sampling points
For a wanted signal, the reference angular steps are approximately equal to the beamwidth (in degrees) of the main beam.
where BeWφ and BeWθ are the beamwidth of the wanted signal in the φ-axis and θ-axis, respectively;  FNBWφ and FNBWθ are the first null beamwidth of the wanted signal in the φ-axis and θ-axis, respectively.
Using beamwidth of the wanted signal, the reference angular steps for each frequency within the downlink operating band including ΔfOBUE can be expressed as follows:
where λo is the wavelength of the wanted signal, and BeWφ and BeWθ are the beamwidth in the φ-axis and θ-axis, respectively.
For the OTA BS radiated transmit power requirement, beamwidths at five different directions is declared by manufacturers. The declared beamwidth may be used to set BeWφ and BeWθ in the above equations provided the same beam is applied to test in-band TRP requirements. If the The numerical singularity at of a test beam is not declared, then the beamwidth can be obtained through measurements following the same procedure as the BS radiated transmit power requirement prior to TRP measurements.
In addition, the beamwidth of the wanted signal can be used to determine the physical dimensions of a radiation source as follows:
and for the ULA case:",TR 37.941,6.3.4.2,all_images/image_518.png,The average EIRP when using different angular steps Δθ and the EIRP pattern of
"Compared to the TX spurious emissions the OBUE emissions and ACLR are likely to experience the similar beamforming pattern as for the wanted signal. Due to this reason, it is easily predictable where the maximum of the emissions is going to be, hence the possibility to enhance the measurement method to achieve better accuracy. Here we choose to apply the pattern multiplication method [10].
In this method, at least two cuts (default) shall be used, an optional third cut can be added if needed. The alignment of the cuts must be along the symmetry planes of the antenna array. Note that theta reference steps apply to the vertical cuts and phi reference steps to the horizontal cuts.
The first mandatory cut is a horizontal cut passing through the peak direction of the main beam.
The second mandatory is a vertical cut passing through the peak direction of the main beam.
Using the data from these two mandatory cuts, a conditional pattern multiplication can be used.
The third optional cut is a vertical cut orthogonal to the first and the second cut.
Once the number and the orientation of the cuts are decided, the total EIRP is measured on the orthogonal cuts and the TRP is then calculated as follows: First the contributions from each cut is calculated as:
where P is the number of sampling points. The final contribution for all cuts is calculated as:
where N is the number of cuts. Note that when orthogonal cuts are measured, the intersection points are measured multiple times and the repeated values can be removed from the samples before averaging.
Figure 6.3.4.5-1: Example of orthogonal cuts geometry when the main lobe points along the x-axis. Two mandatory cuts grid (left) and the optional added third cut (right). The first two cuts are generated by rotating the BS around its z-axis and y-axis, respectively, and the optional third cut is generated by rotating the BS around its x-axis
Two cuts cut data gives a conservative TRP estimate (an overestimation of the real TRP). Through pattern multiplication a less conservative estimate is obtained, based on the calculation of the antenna array factor as a product of two terms, corresponding to the two cuts.
The following conditions for being able to apply pattern multiplication method are mandatory:
i.	The vertical cut (and the main beam) is in the -plane
ii.	The frequency of the emission is within the downlink operating band.
iii.	The bandwidth of the emission is the same as the bandwidth of the in-band modulated signal
iv.	The emission appears/disappears when the TX power is turned on/off.
v.	The antenna arrays of the BS
1.	Have rectangular grids of antenna element positions
2.	Have symmetry planes that are vertical and horizontal.
3.	Have parallel antenna planes
The antenna array is here assumed to be placed in the yz-plane. The pattern multiplication is performed in uv-coordinates and the data in the two cuts are denoted EIRPcut1(φ) at and a vertical cut with data EIRPcut2() at . The data is split in two parts corresponding to the forward and backward hemisphere. The uv-coordinates are the projections of the angular directions onto the antenna plane, here the yz-plane. Using the spherical coordinates as depicted in figure 6.3.4.2-2 the u and v coordinates are defined as:
Note that only the data on the coordinate axes are measured, and hence only the dataEIPRcut1(u) for  (the horizontal cut) and EIRPcut2(v) for  (the vertical cut) are known. Moreover, only the points in the circular disc  , a.k.a. the visible region, contribute to the TRP.
The pattern multiplication is used to calculate power density values outside the two cardinal cuts as:
In Figure 6.3.4.5-2, the case where  is illustrated.
Figure 6.3.4.5-2: Example of pattern multiplication
The pattern multiplication is applied separately for the forward (fwd) and backward (bwd) hemisphere. The TRP is then calculated as
NOTE:	The numerical singularity at  must be treated with care, e.g. by changing the coordinate system to polar as in [10].",TR 37.941,6.3.4.5,all_images/image_519.jpeg,Example of orthogonal cuts geometry when the main lobe points along the x-axis.
"Similar as Rayleigh sampling approach, BS is placed on the yz plane in the spherical coordinate and normal vector of BS is pointing along the x-axis as shown in figure 6.3.4.2-2. The angle φ and θ represent azimuth and elevation respectively, u and v represent the projection of normalized wave vector on y-axis and z-axis.
According to the relationship between the normalized wave vector and spherical coordinate, the wave vector can be represented as following:
TRP is defined in the spherical coordinate as following:
As TRP is defined in the wave vector coordinate, therefore TRP definition should be revised accordingly in the corresponding coordinate. For the TRP definition in normalized wave vector space, according to the 2D Jacobian transformation, the above equation could be adjusted as following, namely:
Based on the above two equations, then we could get
where relationship between (θ,φ) and (u,v )is demonstrated in the equation before. Similar as discrete sampling process, the above equation is approximated in the far-field region as the sum of the total EIRP at a number of discrete directions as follows:
The above considerations could be applied for both polarization.
Uniform sampling in the wave vector coordinate as shown in figure 6.3.4.6-1:
-	Rayleigh resolution in y-axis:
-	Rayleigh resolution in z-axis:
Where Dy is length of radiating parts of BS along y-axis, Dz is length of radiating parts of BS along the z-axis.
Based on the uniform sampling grid on the yz plane, we could get the sampling point (, ). In addition, according to the transformation between (,) and (φ, θ), then azimuth and elevation (φm,n, θn) in the spherical coordinate could be derived correspondingly as shown in figure 6.3.4.6-2. Based on the (φm,n, θn) in the spherical coordinate, EIRP on the spherical coordinate could be measured.
Figure 6.3.4.6-1: Sampling grid in the wave vector space
Figure 6.3.4.6-2: Sampling grid in the spherical coordinate",TR 37.941,6.3.4.6,all_images/image_522.png,Sampling grid in the wave vector space
"This method measures the EIRP in an anechoic chamber with the separation between the manufacturer declared coordinate system reference point of the BS and the phase centre of the receiving antenna of no less than 2D2/λ, where D is the largest dimension of the antenna of BS and λ is the wavelength. The measurement system setup is as depicted in figure 7.2.1-1 for TX requirements, and in figure 7.2.1-2 for RX requirements.
Figure 7.2.1-1: IAC measurement system setup for TX requirements
Figure 7.2.1-2: IAC measurement system setup for RX requirements
Figure 7.2.1-3: IAC measurement system setup for OTA dynamic range
Figure 7.2.1-4: IAC measurement system setup for adjacent channel selectivity, general blocking, narrowband blocking and in-channel selectivity
Figure 7.2.1-5: IAC measurement system setup for OTA receiver intermodulation
(a)	General set-up (top view)
(Positioner is not described here)
Figure 7.2.1-6: IAC measurement system setup for co-location requirements",TR 37.941,7.2.1,all_images/image_524.jpeg,IAC measurement system setup for TX requirements
"This method measures the EIRP in an anechoic chamber with the separation between the manufacturer declared coordinate system reference point of the BS and the phase centre of the receiving antenna of no less than 2D2/λ, where D is the largest dimension of the antenna of BS and λ is the wavelength. The measurement system setup is as depicted in figure 7.2.1-1 for TX requirements, and in figure 7.2.1-2 for RX requirements.
Figure 7.2.1-1: IAC measurement system setup for TX requirements
Figure 7.2.1-2: IAC measurement system setup for RX requirements
Figure 7.2.1-3: IAC measurement system setup for OTA dynamic range
Figure 7.2.1-4: IAC measurement system setup for adjacent channel selectivity, general blocking, narrowband blocking and in-channel selectivity
Figure 7.2.1-5: IAC measurement system setup for OTA receiver intermodulation
(a)	General set-up (top view)
(Positioner is not described here)
Figure 7.2.1-6: IAC measurement system setup for co-location requirements",TR 37.941,7.2.1,all_images/image_526.png,IAC measurement system setup for OTA dynamic range
"In case of TX requirements measurement, the Compact Antenna Test Range (CATR) uses the BS which radiates a wavefront to a range antenna reflector which will then collimate the radiated spherical wavefront into a feed antenna. The sufficient separation between the BS and the receiver (feed antenna shown in figure 7.3.1-1) so that the emanating spherical wave reaches nearly plane phase fronts from transmitter to receiver. The BS transmits a wavefront that will illuminate the range antenna reflector, which will then reflect the transmitted energy into the feed antenna. The range feed antenna is connected to a vector network analyzer or other equivalent test equipment.
Since the space within the CATR is limited and RF interference needs to be minimized, test equipment is placed outside the shielded anechoic chamber. The usage of up/down converters in the chamber for FR2 minimize the length of RF cables and waveguides. If up/down converter is used together with standard test equipment (e.g., spectrum/signal analyzer or signal generator) the complete system including test equipment and up/down converter should be seen as a composite standard test quipment when measurement uncertianty is evaluated.
Figure 7.3.1-1: CATR measurement system setup, TX requirements
In case of RX requirements, the CATR uses the feed antenna which radiates a spherical wavefront to a range reflector antenna which will then collimate the radiated spherical wavefront to the BS. There is sufficient separation between the BS and the transmitter (feed antenna shown in figure 7.3.1-2) so that the emanating spherical wave reaches nearly plane phase fronts from transmitter to receiver. The feed antenna transmits a wavefront that will illuminate the range antenna reflector, which will then reflect the transmitted energy towards the BS.
Figure 7.3.1-2: CATR measurement system setup, RX requirements
Figure 7.3.1-3: CATR measurement system setup, RX OTA dynamic range, ACS, general blocking and narrowband blocking
Figure 7.3.1-4: CATR measurement system setup, OTA RX IMD
Figure 7.3.1-5: CATR measurement system setup for OTA ICS
Figure 7.3.1-6: CATR measurement system setup for TAE",TR 37.941,7.3.1,all_images/image_527.jpeg,"CATR measurement system setup, TX requirements"
"In case of TX requirements measurement, the Compact Antenna Test Range (CATR) uses the BS which radiates a wavefront to a range antenna reflector which will then collimate the radiated spherical wavefront into a feed antenna. The sufficient separation between the BS and the receiver (feed antenna shown in figure 7.3.1-1) so that the emanating spherical wave reaches nearly plane phase fronts from transmitter to receiver. The BS transmits a wavefront that will illuminate the range antenna reflector, which will then reflect the transmitted energy into the feed antenna. The range feed antenna is connected to a vector network analyzer or other equivalent test equipment.
Since the space within the CATR is limited and RF interference needs to be minimized, test equipment is placed outside the shielded anechoic chamber. The usage of up/down converters in the chamber for FR2 minimize the length of RF cables and waveguides. If up/down converter is used together with standard test equipment (e.g., spectrum/signal analyzer or signal generator) the complete system including test equipment and up/down converter should be seen as a composite standard test quipment when measurement uncertianty is evaluated.
Figure 7.3.1-1: CATR measurement system setup, TX requirements
In case of RX requirements, the CATR uses the feed antenna which radiates a spherical wavefront to a range reflector antenna which will then collimate the radiated spherical wavefront to the BS. There is sufficient separation between the BS and the transmitter (feed antenna shown in figure 7.3.1-2) so that the emanating spherical wave reaches nearly plane phase fronts from transmitter to receiver. The feed antenna transmits a wavefront that will illuminate the range antenna reflector, which will then reflect the transmitted energy towards the BS.
Figure 7.3.1-2: CATR measurement system setup, RX requirements
Figure 7.3.1-3: CATR measurement system setup, RX OTA dynamic range, ACS, general blocking and narrowband blocking
Figure 7.3.1-4: CATR measurement system setup, OTA RX IMD
Figure 7.3.1-5: CATR measurement system setup for OTA ICS
Figure 7.3.1-6: CATR measurement system setup for TAE",TR 37.941,7.3.1,all_images/image_529.png,"CATR measurement system setup, RX requirements"
"In case of TX requirements measurement, the Compact Antenna Test Range (CATR) uses the BS which radiates a wavefront to a range antenna reflector which will then collimate the radiated spherical wavefront into a feed antenna. The sufficient separation between the BS and the receiver (feed antenna shown in figure 7.3.1-1) so that the emanating spherical wave reaches nearly plane phase fronts from transmitter to receiver. The BS transmits a wavefront that will illuminate the range antenna reflector, which will then reflect the transmitted energy into the feed antenna. The range feed antenna is connected to a vector network analyzer or other equivalent test equipment.
Since the space within the CATR is limited and RF interference needs to be minimized, test equipment is placed outside the shielded anechoic chamber. The usage of up/down converters in the chamber for FR2 minimize the length of RF cables and waveguides. If up/down converter is used together with standard test equipment (e.g., spectrum/signal analyzer or signal generator) the complete system including test equipment and up/down converter should be seen as a composite standard test quipment when measurement uncertianty is evaluated.
Figure 7.3.1-1: CATR measurement system setup, TX requirements
In case of RX requirements, the CATR uses the feed antenna which radiates a spherical wavefront to a range reflector antenna which will then collimate the radiated spherical wavefront to the BS. There is sufficient separation between the BS and the transmitter (feed antenna shown in figure 7.3.1-2) so that the emanating spherical wave reaches nearly plane phase fronts from transmitter to receiver. The feed antenna transmits a wavefront that will illuminate the range antenna reflector, which will then reflect the transmitted energy towards the BS.
Figure 7.3.1-2: CATR measurement system setup, RX requirements
Figure 7.3.1-3: CATR measurement system setup, RX OTA dynamic range, ACS, general blocking and narrowband blocking
Figure 7.3.1-4: CATR measurement system setup, OTA RX IMD
Figure 7.3.1-5: CATR measurement system setup for OTA ICS
Figure 7.3.1-6: CATR measurement system setup for TAE",TR 37.941,7.3.1,all_images/image_531.jpeg,CATR measurement system setup for OTA ICS
"A reverberation chamber (RC) is an electrically large shielded metal enclosure that employs one or several ""stirring"" methods to randomize the fields, such as moving paddles, turntables, etc. In this way, a large number of uncorrelated samples is obtained. The volume in the room where the field is well-stirred is the working volume. Here the E-field, averaged over an entire stirring cycle, is independent of the location in the room, i.e. the field is spatially uniform.
For a proper analysis of the measured data a sufficient number of uncorrelated samples is required. The number of effectively uncorrelated (independent) samples produced by a given mode-stirring sequence can be determined by correlation-matrix-based approaches or, in some cases, by an alternative single-autocorrelation calculation.
The correlation matrix approach utilizes an N × N matrix of complex correlation coefficients representing the pairwise spatial correlation between all N measured samples [26]. With σ the covariance matrix, the Pearson correlation coefficients are then calculated pairwise between the observations as
,
where i represents the row index and j the column index for i = 1, …, N and j = 1, …, N. The threshold  defined below is applied to the magnitude squared of the correlation coefficients by setting rij to zero if | rij |2 ≤ rlim. The number of effectively uncorrelated samples in the stirring sequence is then given by
.
Alternatively, for a chamber with a single repeating stirring sequence, such as a rotational mode stirrer, the auto-correlation function is used to calculate the offset between statistically uncorrelated samples using the following expression as in IEC 61000-4-21 [11]:
where the modulus operator mod(x,y) is the remainder of x/y, here performing a circular shift of the measurement samples over a distance k. The symbols ⟨x⟩ and σ = ""std"" (x) denote the average value and standard deviation. The threshold value for uncorrelated samples, rlim, is defined as in IEC 61000-4-21 [11]:
Use of this threshold gives 95% confidence that there will be at least Nind effectively spatially uncorrelated samples in the chamber measurement. The distance between uncorrelated samples is calculated as the minimum k-value satisfying . The number of uncorrelated samples is calculated as:
When properly designed, this facility can be used for non-directional antenna measurements, such as TRP. In fact, a well-stirred RC is capable of measuring TRP in a reliable way, regardless of the directivity pattern of the emission or frequency range. When measuring TRP of sources with a directive pattern, special care must be taken to characterize the working volume of the chamber.
The purpose of the chamber characterization is to ensure that the effect of a non-uniform field distribution in the chamber has a negligible influence on the measurement result when the BS is placed in the working volume. Lack of chamber uniformity is a major contributor to measurement uncertainty in reverberation chambers and should be handled with care.
The uniformity test can be quite time consuming and the test can be performed separate from the BS measurement. Due to the non-negligible size of BS equipment the BS can have a significant influence on the uniformity. To take this effect into account, either the BS itself must be present in the room during characterization or an absorber with dimensions equal or larger than the BS must be placed at the BS's location in the room.
The characterization procedure consists of placing a reference transmitter antenna (REF TX ant) at different locations and with different orientations in the room and measuring the Power Transfer Function (PTF) between the REF TX and chamber's RX antenna, see figure 7.8.1-1. The actual mode of RC operation shall be used, including stirrer movement, BS movement, diversity antenna usage, etc. The directivity of the REF TX ant will influence the spatial uniformity of the room, a more directive REF TX ant is better at detecting parts of the room that are less-well stirred. Therefore, the REF TX ant chosen for the uniformity test should excite the chamber in a similar way as the BS.
Figure 7.8.1-1:	Setup for characterization of a reverberation chamber
The working volume shall be at least half a wavelength from the chamber walls and other electromagnetic reflective objects according to [12]. According to IEC 61000-4-21 [11] this distance may be restricted to 0.75 m below 100 MHz. The number of positions and orientations to use depends on the chamber size and the directivity of the REF TX ant. Measurements made at positions and orientations at the edges of the working volume are used to characterize the chamber and derive certain components of uncertainty.
The exact number of positions and orientations remain for further study, but at least (3) uncorrelated locations should be used and (6) uncorrelated orientations per position when directive spurs are to be detected.
Different test equipment set ups can be used for the acquisition of the PTF between REF TX and RX. Such as devices capable of directly extracting the PTF, like a Vector Network Analyzer (VNA) or a set up with separate transmitter and receiver test equipment, such as a Signal Generator (SG) and Spectrum/signal Analyzer (SA) configuration. In the latter case the operator should account for the losses in the set up originating from cables, mismatch, etc.
When using a VNA, the REF TX ant and the measurement receive antenna (RX) are connected to the test equipment. For each location/orientation n of the REF TX ant, RC sample, and desired frequency f, the power transfer function
is measured. Here, the brackets denote average value over the entire stirring sequence. The explicit dependence on RC sample and frequency is not written out here.
In case of using an SG and SA the PTF is calculated as follows:
with Ur the received voltage, 50 Ω being the reference impedance of the SA, Pt the transmit power of the signal source, Ls the losses in in the cables.
At least 250 uncorrelated samples shall be used per position/orientation. Using a lower number is not compatible with the underlying analysis on measurement uncertainty, see IEC 61000-4-21 [11] and publication in [13].
The following tests are performed and shall be verified for each frequency:
a)	Uniformity of transfer function: For each location/orientation evaluate Pn. The standard deviation of these average values shall be below the assumed measurement uncertainty level for A6-7 uncertainty contributor, as described in annex A.6.
b)	Dynamic range: The dynamic range of each Pn shall be at least 20 dB.
c)	Uncorrelated samples: At least 250 uncorrelated samples shall be used.
It is important to note that spatial uniformity (and number of uncorrelated samples) in an RC is harder to achieve for more directive antenna patterns. As such, the measurement uncertainty of a sub-optimally configured room will be higher and additional measures to randomize the fields should be considered. Optimization of the BS position in the chamber and positional stirring are good starting points.",TR 37.941,7.8.1,all_images/image_537.png,Setup for characterization of a reverberation chamber
"Calibration shall be done to ensure that the SNR at the measurement equipment input is appropriate and the reception signal level at the measurement equipment is within the dynamic range of measurement equipment.
1)	Calibration system configuration
For TX requirements: connect the reference antenna and the receiving antenna to the measurement RF out port and RF in port of the network analyzer, respectively, as shown in figure 8.2-1. The amplifier may be installed between C and D if required.
Figure 8.2-1: Indoor Anechoic Chamber calibration system setup for TX requirements
For RX requirements: Connect the reference antenna and the transmitting antenna to RF in port and RF out port of the network analyzer, respectively, as shown in figure 8.2-2.
Figure 8.2-2: Indoor Anechoic Chamber calibration system setup for RX requirements
2)	Install the reference antenna with its beam peak direction and the height of its phase centre aligned with the receiving antenna, or transmitting antenna (in case of transmitter or receiver requirement, respectively).
3)	Set the centre frequency of the network analyzer to the carrier centre frequency of the tested signal and measure LFE→D, which is equivalent to 20log|S21| (dB) obtained by the network analyzer:
-	LFE→D: Pathloss between E and D in figure 8.2-1 (for Tx requirements) and 8.2-2 (for Rx requirements).
4)	Measure the cable loss, LFE→F between the reference antenna connector and the network analyzer connector:
-	LFE→F: Cable loss between E and F in figure 15.1-1.
5)	Calculate the calibration value between A and D with the following formulas:
-	Lcal, A→D = LFE→D + GREF_ANT, F→A - LFE→F.
-	Lcal, A→D: Calibration value between A and D in figure 8.2-1 (for Tx requirements) and 8.2-2 (for Rx requirements).
-	GREF_ANT, A→F: Antenna gain of the reference antenna.",TR 37.941,8.2,all_images/image_538.jpeg,Indoor Anechoic Chamber calibration system setup for TX requirements
"Calibration shall be done to ensure that the SNR at the measurement equipment input is appropriate and the reception signal level at the measurement equipment is within the dynamic range of measurement equipment.
1)	Calibration system configuration
For TX requirements: connect the reference antenna and the receiving antenna to the measurement RF out port and RF in port of the network analyzer, respectively, as shown in figure 8.2-1. The amplifier may be installed between C and D if required.
Figure 8.2-1: Indoor Anechoic Chamber calibration system setup for TX requirements
For RX requirements: Connect the reference antenna and the transmitting antenna to RF in port and RF out port of the network analyzer, respectively, as shown in figure 8.2-2.
Figure 8.2-2: Indoor Anechoic Chamber calibration system setup for RX requirements
2)	Install the reference antenna with its beam peak direction and the height of its phase centre aligned with the receiving antenna, or transmitting antenna (in case of transmitter or receiver requirement, respectively).
3)	Set the centre frequency of the network analyzer to the carrier centre frequency of the tested signal and measure LFE→D, which is equivalent to 20log|S21| (dB) obtained by the network analyzer:
-	LFE→D: Pathloss between E and D in figure 8.2-1 (for Tx requirements) and 8.2-2 (for Rx requirements).
4)	Measure the cable loss, LFE→F between the reference antenna connector and the network analyzer connector:
-	LFE→F: Cable loss between E and F in figure 15.1-1.
5)	Calculate the calibration value between A and D with the following formulas:
-	Lcal, A→D = LFE→D + GREF_ANT, F→A - LFE→F.
-	Lcal, A→D: Calibration value between A and D in figure 8.2-1 (for Tx requirements) and 8.2-2 (for Rx requirements).
-	GREF_ANT, A→F: Antenna gain of the reference antenna.",TR 37.941,8.2,all_images/image_539.jpeg,Indoor Anechoic Chamber calibration system setup for RX requirements
"The calibration measurement is done by using a reference antenna (SGH used in figure 8.3-1 or 8.3-2) with known efficiency or gain values. In the calibration measurement the reference antenna is measured in the same place as the BS, and the attenuation of the complete transmission path (C↔A, as in figure 8.3-1 or 8.3-2) from the BS to the measurement receiver is calibrated out. Figures 8.3-1 and 8.3-2 presents a setup of a typical compact antenna test range for TX and RX requirements, respectively.
Figure 8.3-1: CATR calibration system setup, TX requirements
Figure 8.3-2: CATR calibration system setup, RX requirements
1)	Path loss calibration C→A:
a)	Measure SGH (or other calibrated reference antenna) reflection coefficient separately at the antenna's connector with a network analyser (or equivalent measurement equipment) to obtain ΓSGH.
b)	Measure cable loss from point C to input of SGH, call this LC↔SGH which is the equivalent of 20log|S21| from the use of a network analyser.
c)	Calculate the combined total path loss from C→A by using the following expression:
LSGHcal = LC,SGH + 10log(1 - |ΓSGH|2) - GSGH,
where 10log(1 - |ΓSGH|2) is the compensation for SGH connector return loss, GSGH is the known gain of the reference SGH.
2)	Connect SGH and C↔A cable.
3)	To remove polarization(s) mismatch between range antenna (labelled as feeder antenna in diagram) and SGH use positions to position the SGH in the boresight of range antenna.
4)	Measure path loss C→B with network analyzer LC→B = 20log|S21|.
5)	Calculate the test path loss compensation factor. This is the total path loss between A↔B using the results from step 1c and 4. L =  LSGHcal  - LC→B.
Where ΓSGH is the reflection coefficient (or mismatch) seen at the SGH connector (S11 with a network analyzer).
The CATR test setup and calibration for FR2 are expected to be similar to those of FR1, although the test chamber dimensions and associated MU values will scale due to the shorter wavelengths and larger relative array apertures. However, it is noted that in order to achieve the test instrument uncertainties that were assumed, calibration of the spectrum analyzer may be needed.",TR 37.941,8.3,all_images/image_540.jpeg,"CATR calibration system setup, TX requirements"
"The calibration measurement is done by using a reference antenna (SGH used in figure 8.3-1 or 8.3-2) with known efficiency or gain values. In the calibration measurement the reference antenna is measured in the same place as the BS, and the attenuation of the complete transmission path (C↔A, as in figure 8.3-1 or 8.3-2) from the BS to the measurement receiver is calibrated out. Figures 8.3-1 and 8.3-2 presents a setup of a typical compact antenna test range for TX and RX requirements, respectively.
Figure 8.3-1: CATR calibration system setup, TX requirements
Figure 8.3-2: CATR calibration system setup, RX requirements
1)	Path loss calibration C→A:
a)	Measure SGH (or other calibrated reference antenna) reflection coefficient separately at the antenna's connector with a network analyser (or equivalent measurement equipment) to obtain ΓSGH.
b)	Measure cable loss from point C to input of SGH, call this LC↔SGH which is the equivalent of 20log|S21| from the use of a network analyser.
c)	Calculate the combined total path loss from C→A by using the following expression:
LSGHcal = LC,SGH + 10log(1 - |ΓSGH|2) - GSGH,
where 10log(1 - |ΓSGH|2) is the compensation for SGH connector return loss, GSGH is the known gain of the reference SGH.
2)	Connect SGH and C↔A cable.
3)	To remove polarization(s) mismatch between range antenna (labelled as feeder antenna in diagram) and SGH use positions to position the SGH in the boresight of range antenna.
4)	Measure path loss C→B with network analyzer LC→B = 20log|S21|.
5)	Calculate the test path loss compensation factor. This is the total path loss between A↔B using the results from step 1c and 4. L =  LSGHcal  - LC→B.
Where ΓSGH is the reflection coefficient (or mismatch) seen at the SGH connector (S11 with a network analyzer).
The CATR test setup and calibration for FR2 are expected to be similar to those of FR1, although the test chamber dimensions and associated MU values will scale due to the shorter wavelengths and larger relative array apertures. However, it is noted that in order to achieve the test instrument uncertainties that were assumed, calibration of the spectrum analyzer may be needed.",TR 37.941,8.3,all_images/image_541.jpeg,"CATR calibration system setup, RX requirements"
"The general principle is to use PM to monitor generated signal power level from SG and mixer for up converted signal or amplifier output when it’s used.  With using PM reading, continuously adjust signal level of stimulus signal level during OTA reference sensitivity measurement. Attenuator maybe required before PM to ensure signal level to PM is in PM dynamic range. If this is done correctly, PM MU can be used instead of MU of SG and mixer.
For the OTA reference sensitivity, the calibration is divided into two steps as visualised for the calibration of power splitter/switch (S) in Figure 8.3.1.2-1 and calibration of complete test range in Figure 8.3.1.2-2.
Figure 8.3.1.2-1: Characterization of power splitter/switch (S)
In Figure 8.3.1.2-2, the characterization of the test range path loss is performed. This stage is part of regular calibration procedure in an OTA test environment.
Figure 8.3.1.2-2: Characterization of test range path loss
The complete calibration stage can be described by following steps:
1.	Measure the transmission loss from G to P with a VNA, as visualised in Figure 8.3.1.2-1.
2.	Measure the transmission loss from G to B with a VNA, as visualized in Figure 8.3.1.2-2.
The corresponding measurement stage setup for receiver requirements is visualised in Figure 8.3.1.2-3
Figure 8.3.1.2-3: Measurement setup for receiver requirement measurement using a Power Meter
In the measurement stage, the calibration antenna is replaced with the EUT. The EIS level, required to meet specified link quality is calculated as:
(dBm)
The signal generator can be combined with frequency converters, mixers, RF filters, amplifiers. Signal level after all these components hence form a composite test equipment should be monitored then signal level continuosly adjusted using a PM during measurement. This technique can be used to reduce the MU of the sensitivity measurement. In all cases, it must be ensured that the generated signal is clean.",TR 37.941,8.3.1.2,all_images/image_542.jpeg,Characterization of test range path loss
"For FR2-2 inband TRP and ACLR-relative measurement, Figure 8.3.2-1 shows specific power measurement equipment setup with continuous calibration during measurement. This setup with procedure described in this section allows to have better accuracy measurement with use of power sensor accuracy value.
Figure 8.3.2-1: Power measurement equipment setup with calibration for TRP
Following condition should met to use method described in this section.
-	Calibration purpose signal should always be available to power sensor and spectrum analyser by either switching or splitter. Calibration should always be done with each signal measurement.
-	Calibration purpose signal level needs to be in range of power sensor measurable range with good accuracy. And difference from actual signal level to calibration signal level needs to be inside of the same attenuator setting (no attenuator switching) of spectrum analyser.
-	Prepare calibration purpose signal to have the same bandwidth as of carrier bandwidth for measurement.
Following is calibration and measurement procedure to do relative measurement with calibration signal to actual signal (by power sensor and spectrum analyzer) on each physical point for TRP. Please note that, procedure described here needs to be done on each physical measurement point for each individual measurement.
The calibration and measurement procedure are as follows:
1.	Prepare calibration purpose signal which has the same signal bandwidth as channel bandwidth for measurement.
2.	Measure calibration purpose signal power by power sensor (signal path A to B in Figure 8.3.2-1). Signal level should be measurable range by power sensor with good accuracy.
3.	Switch signal path to spectrum analyzer then measure signal level (signal path A to D) and calibrate reading by comparing reading from power sensor. At this time, make sure that calibration signal level is in high end of dynamic range of analyzer which doesn’t require changing attenuator level inside analyser for actual measurement in next step.
4.	Switch calibration signal to actual signal from DUT (receiver antenna) for actual measurement (signal path C to D) and measure signal level. Measured signal level should be within measurable range by analyzer with no attenuator change in analyzer from previous step.
5.	For the case of relative ACLR measurement, repeat step 1 through 4 above for lower adjacent channel, target channel, and higher adjacent channel. This calibration and measurement process should be done at every physical measuring point of TRP.
For those measurements which has measurement bandwidth defined in requirements, absolute ACLR, OBUE, spurious emissions, method and procedure described in this section is not applicable. It’s not feasible and practically possible to perform and repeat these steps at each frequency point of measurement BW during total measurement frequency range. It would be hundreds or thousands of calibration measurements needs to be done on each physical point of TRP measurement.",TR 37.941,8.3.2,all_images/image_544.jpeg,Power measurement equipment setup with calibration for TRP
"The calibration measurement is done by using a reference antenna with known efficiency or gain values (e.g. SGH). In the calibration measurement the reference antenna is measured in the same place as the BS, and the attenuation of the complete transmission path (C↔A, see figure 8.6-1) from the BS to the measurement receiver is calibrated out.
Figure 8.6-1: Path loss calibration in PWS, TX requirements
Figure 8.6-2: Path loss calibration in PWS, RX requirements
1)	Path loss calibration E→A:
a)	Measure SGH (or other calibrated reference antenna) reflection coefficient separately at the antenna's connector with a network analyzer (or equivalent measurement equipment) to obtain ΓSGH.
b)	Measure cable loss from point E to input of SGH, call this LE↔SGH which is the equivalent of 20log|S21| from the use of a network analyzer.
c)	Calculate the combined total path loss from E→A by using the following expression:
LSGHcal = LE,SGH + 10log(1 - |ΓSGH|2) - GSGH, where 10log(1 - |ΓSGH|2) is the compensation for SGH connector return loss, GSGH is the known gain of the reference SGH.
2)	Connect SGH and D↔E cable.
3)	Measure path loss C→E with network analyzer LC→E = 20log|S21|.
4)	Calculate the test path loss compensation factor. This is the total path loss between C↔A using the results from step 1c and 3. L =  LSGHcal  - LC→E.
Where ΓSGH is the reflection coefficient (or mismatch) seen at the SGH connector (S11 with a network analyzer).",TR 37.941,8.6,all_images/image_545.png,"Path loss calibration in PWS, TX requirements"
"To correctly determine the TRP of the BS a calibration step to account for losses in cables, antennas, etc. is required. A reference PTF is determined at each frequency of interest by using a relevant reference TX antenna (REF TX ant). The chamber should be set up identically to the actual set up of the TRP measurement, which means the BS has to be in the chamber, the same stirring procedure has to be used, etc.
A minimum Nref = 1 reference measurement is required, but it is noted that more measurements can be used to estimate the reference PTF and that this will lead to a reduction of the uncertainty by a factor . The radiation efficiency, η, of the reference antenna can be assumed to be the value declared by the manufacturer or can be determined in a separate antenna efficiency measurement.
The mismatch efficiency at the TX antenna port is calculated as  where  is obtained in a separate measurement.
(a)						(b)					(c)
Figure 8.8-1: The procedure for TRP measurements uses three consecutive setups: (a) Reference measurement, (b) ambient noise measurement (b), and (c) TRP measurement. The blue dots indicate the measurement planes
Calibration procedure:
1)	Place the BS and the REF TX ant in the working volume of the RC. Turn off BS power and BS controls. See figure 8.8-1 (a). If more positions are used to determine the reference PTF the REF TX ant should be placed at uncorrelated positions within the test volume.
2)	Set the stirrers and turntables in the mode of operation used in the chamber characterization.
3)	Set the sampling rate as in the chamber characterization.
4)	Connect the REF TX ant and the RX antenna with a calibrated Network analyser (NA).
5)	Measure the scattering parameters or received power over a complete stirring cycle for each frequency of interest and for each position and orientation.
6)	Calculate the reference transfer function, P, see subclause 7.8.1.
7)	Calculate the mis-match efficiency, Mt, see subclause 8.8.
8) 	Apply declared radiation efficiency, h, see subclause 8.8.",TR 37.941,8.8,all_images/image_547.jpeg,The procedure for TRP measurements uses three consecutive setups: (a) Reference
"The general principle is to add an additional calibration stage in which a PM characterizes the absolute power measured by the SA. If this is done correctly, considering PM dynamic range capabilities and that a clean signal with low emissions is measured, an MU related to the PM can be used instead of the MU associated to the SA.
The usage of PM as power measurement equipment for TRP test case assumes the following conditions need to be met:
a.	The measured signal power level needs to be strong enough to fall within the dynamic range of the power meter when considering the overall path loss in the OTA system.
b.	The measured signal needs to be sufficiently clean from spurious emissions like harmonics, images, LO-leakage, etc to maintain expected MU. In order to ensure a noise level which does not affect the expected MU, the minimum SNR must be >10dB to ensure no impact to MU.
c.	The wideband noise level (including unfiltered components in point b. above) must be significantly lower than the measured carrier power level. To reduce wideband noise level, the use of band pass filter before power sensor is assumed.
Application of this technique include radiated transmit power and other requirements where the measured signal falls within the dynamic range of the PM. The RC calibration can be divided in several stages:
1.	Test range calibration
2.	Validation of test range ambient noise level
3.	Absolute power level calibration
The third stage is new, while the two first are slightly modified compared to previous description in TR 37.941.
The test range calibration stage, validation of ambient noise level stage and absolute power calibration stage is visualized in Figure 8.8.1-1.
Figure 8.8.1-1: Test range calibration (top-left), validation of ambient noise (top-right) in an RC and absolute power level calibration (bottom)
The Spectrum Analyzer (SA) is connected in idle mode to present the proper signal scattering characteristics, and the EUT is also in the chamber to present relevant spatial scattering properties. Stirrers are assumed to operate in the same sequence as in the chamber characterization described in TR 37.941, subclause 7.8.1.
An RF power divider (denoted S) is used to divide the received signal to feed both an SA and a PM with the signal transmitted by the calibration antenna, here denoted reference antenna (Ref Tx). The complete transmission path from A to B is characterized in the calibration stage.
In the test range calibration stage, the transmission loss from A to C is obtained. The test range calibration procedure is as follows:
1.	Measure the transmission loss from D to C with a VNA.
2.	Get the radiation efficiency  of the Ref Tx antenna.
3.	Measure the reflection coefficient  at the input D of the Ref Tx antenna.
4.	Calculate the loss from A to C as:
(Linear units)
The path loss, including the Rx antenna gain, is captured between A and C with the calibration stage. LAC will be used in the measurement stage to be able to retrieve a calibrated TRP value.
In the validation of ambient noise stage, the SA is used to secure the noise floor level within the chamber. This stage is defined to check that external leakage and internal noise is under control. In TR 37.941, subclause 11.2.5 it is recommended to have at least 20 dB SNR.
In the absolute power calibration (bottom picture in Figure 8.8.1-1) the mode stirrer is fixed at a power optimal position where the PM receives a signal within its dynamic range. Since the dynamic range of the PM is limited, an Attenuator (ATT) may be required. The attenuator setting, used in the absolute calibration stage must be equal to the setting used in the test range calibration stage. It is important to set the attenuation properly to ensure the PM and the SA operate within their dynamic ranges. The difference between PM power level and SA power level is calculated in logarithmical scale as:
(dB)
The difference should be characterized for each configuration of the BS over frequency (e.g., Top, Middle and Bottom channel within an operating band) as the absolute level may vary over the band.
The TRP measurement stage for a RC is visualised in Figure 8.8.1-2.
Figure 8.8.1-2: TRP measurement
The attenuator setting, used in the measurement stage, must be equal to the setting used in the test range calibration stage.
In the measurement stage, the calibration antenna is terminated and the Equipment Under Test (EUT) is activated. In an RC the TRP is measured as an average of many power samples measured for different stirrer positions.
In the TRP measurement the mode stirrers are moving and  is measured using the SA. The measured power is then corrected using the PM absolute offset D in logarithmical scale as:
(dBm)
The TRP level is then calculated as:
(Linear scale)
Here,  denotes average value (in linear scale) of all power samples.",TR 37.941,8.8.1,all_images/image_550.jpeg,"Test range calibration (top-left), validation of ambient noise (top-right) in an RC and"
"Clause 14 captures MU and TT values derivation for the OTA out-of-band blocking requirement in Normal test conditions.
The OTA out-of-band blocking requirement requires both a wanted in-band signal and an interferer out-of-band signal to be transmitted with the chamber. The wanted signal is defined in the far field, the interferer is defined as a field strength, due to the large range for frequencies it will not always be in the far field.
Hence any acceptable measurement chamber for the OTA sensitivity requirement measurements (as described in clauses 7.2 to 7.6) is also suitable for the OTA out-of-band blocking requirement, it may be necessary that the interfering signal is transmitted from a separate antenna due to the large frequency range of the interferer.
Figure 14.1-1: General blocking test set-up using a different antenna
In the worst case the wanted and interfering signal are transmitted from separate test antennas, hence they each may have a different uncertainty associated with the OTA chamber. This differs from the in-band interference measurements where the wanted signal and the interferer are added together outside the chamber and applied to the same test antenna and hence have a common OTA chamber uncertainty.
The uncertainty of the interferer is analysed in this clause using a General Chamber assumption (see 7.7.3). The requirement may be tested in any suitable chamber (e.g. IAC, CATR) that is capable of measuring EIS accurately and also applying the out-of-band interferer. For interferer frequencies where it can be applied from a common antenna (like the in-band requirements) this is acceptable but it is expected the MU will be lower so will not influence the final MU value. The chosen chamber must of course be specified to handle the frequency of both the interferer and the wanted signal. The complete out-of-band blocking test may be completed using multiple chambers for different frequency ranges if necessary.
The distance between the test object and test antenna injecting the interferer signal is adjusted when necessary to ensure specified interferer signal level to be received.",TR 37.941,14.1,all_images/image_552.jpeg,General blocking test set-up using a different antenna
"Calibration of the OTA measurement systems is assumed to be the same for FR1 and FR2 frequencies, unless otherwise stated.",TR 37.941,8.1,all_images/image_553.jpeg,Comparison between BS architectures for EMC testing
"The Secondary Node Modification procedure may be initiated either by the MN or by the SN and be used to modify, establish or release bearer contexts, to transfer bearer contexts to and from the SN or to modify other properties of the UE context within the same SN. It may also be used to transfer an NR RRC message from the SN to the UE via the MN and the response from the UE via MN to the SN (e.g. when SRB3 is not used). In case of CPA or inter-SN CPC, this procedure is used to modify CPA or inter-SN CPC configuration within the same candidate SN. In case of CPA or inter-SN CPC, this procedure may also be triggered by the candidate SN to add some prepared PSCells from the suggested list or cancel part of the prepared PSCells. In case of intra-SN CPC, this procedure is used to configure, modify or release intra-SN CPC configuration. This procedure may be initiated by the MN or SN to request the SN or MN to deactivate or activate the SCG.
The Secondary Node modification procedure does not necessarily need to involve signalling towards the UE.
MN initiated SN Modification
Figure 10.3.1-1: SN Modification procedure - MN initiated
The MN uses the procedure to initiate configuration changes of the SCG within the same SN, e.g. the addition, modification or release of SCG bearer(s) and the SCG RLC bearer of split bearer(s), as well as configuration changes for SN terminated MCG bearers. Bearer termination point change is realized by adding the new bearer configuration and releasing the old bearer configuration within a single MN initiated SN Modification procedure for the respective E-RAB. The MN uses this procedure to perform handover within the same MN while keeping the SN. The MN also uses the procedure to query the current SCG configuration, e.g. when delta configuration is applied in an MN initiated SN change. The MN also uses the procedure to provide the S-RLF related information to the SN. The MN also uses this procedure to activate or deactivate the SCG. The MN may not use the procedure to initiate the addition, modification or release of SCG SCells. The SN may reject the request, except if it concerns the release of SN terminated bearer(s) or the SCG RLC bearer of MN terminated bearer(s), or if it is used to perform handover within the same MN while keeping the SN. Figure 10.3.1-1 shows an example signalling flow for an MN initiated SN Modification procedure.
1.	The MN sends the SgNB Modification Request message, which may contain bearer context related or other UE context related information, data forwarding address information (if applicable) and the requested SCG configuration information, including the UE capability coordination result to be used as basis for the reconfiguration by the SN. The MN may request the SCG to be activated or deactivated. In case a security key update in the SN is required, a new SgNB Security Key is included. In case of SCG RLC re-establishment for E-RABs configured with an MN terminated bearer with an SCG RLC bearer for which no bearer type change is performed, the MN provides a new UL GTP tunnel endpoint to the SN. The SN shall continue sending UL PDCP PDUs to the MN with the previous UL GTP tunnel endpoint until it re-establishes the RLC and use the new UL GTP tunnel endpoint after re-establishment. In case of PDCP re-establishment for E-RABs configured with an SN terminated bearer with an MCG RLC bearer for which no bearer type change is performed, the MN provides a new DL GTP tunnel endpoint to the SN. The SN shall continue sending DL PDCP PDUs to the MN with the previous DL GTP tunnel endpoint until it performs PDCP re-establishment and use the new DL GTP tunnel endpoint starting with the PDCP re-establishment.
2.	The SN responds with the SgNB Modification Request Acknowledge message, which may contain SCG radio resource configuration information within a NR RRC configuration message and data forwarding address information (if applicable). If the MN requested the SCG to be activated or deactivated, the SN indicates whether the SCG is activated or deactivated. In case of a security key update (with or without PSCell change), for E-RABs configured with the MN terminated bearer option that require X2-U resources between the MN and the SN, for which no bearer type change is performed, the SN provides a new DL GTP tunnel endpoint to the MN. The MN shall continue sending DL PDCP PDUs to the SN with the previous DL GTP tunnel endpoint until it performs PDCP re-establishment or PDCP data recovery, and use the new DL GTP tunnel endpoint starting with the PDCP re-establishment or data recovery. In case of a security key update (with or without PSCell change), for E-RABs configured with the SN terminated bearer option that require X2-U resources between the MN and the SN, for which no bearer type change is performed, the SN provides a new UL GTP tunnel endpoint to the MN. The MN shall continue sending UL PDCP PDUs to the SN with the previous UL GTP tunnel endpoint until it re-establishes the RLC and use the new UL GTP tunnel endpoint after re-establishment.
NOTE 00:	In case SN includes the indication of full RRC configuration in SgNB Modification Request Acknowledge message to MN e.g. comprehension failure upon intra-CU inter-DU change, MN performs release and add of the NR SCG part of the configuration but does not release SN terminated radio bearers towards the UE.
3-5.	The MN initiates the RRC connection reconfiguration procedure, including the NR RRC configuration message. The UE applies the new configuration, synchronizes to the MN (if instructed, in case of intra-MN handover) and replies with RRCConnectionReconfigurationComplete, including a NR RRC response message, if needed. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
6.	Upon successful completion of the reconfiguration, the success of the procedure is indicated in the SgNB Reconfiguration Complete message.
7.	If instructed, the UE performs synchronisation towards the PSCell of the SN as described in SgNB addition procedure. Otherwise, the UE may perform UL transmission after having applied the new configuration.
8.	If PDCP termination point is changed for bearers using RLC AM, and when RRC full configuration is not used, the SN Status Transfer takes place between the MN and the SN (Figure 10.3.1-1 depicts the case where a bearer context is transferred from the MN to the SN).
NOTE 0:	The SN may not be aware that a SN terminated bearer requested to be released is reconfigured to a MN terminated bearer. The SN Status for the released SN terminated bearers with RLC AM may also be transferred to the MN.
9.	If applicable, data forwarding between MN and the SN takes place (Figure 10.3.1-1 depicts the case where a bearer context is transferred from the MN to the SN).
10.	The SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE over the NR radio for the E-RABs to be released and for the E-RABs for which the S1 UL GTP Tunnel endpoint was requested to be modified.
NOTE 1:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN is not defined. The SN may send the report when the transmission of the related bearer is stopped.
11.	If applicable, a path update is performed.
SN initiated SN Modification with MN involvement
Figure 10.3.1-2: SN Modification procedure - SN initiated with MN involvement
The SN uses the procedure to perform configuration changes of the SCG within the same SN, e.g. to trigger the release of SCG bearer(s) and the SCG RLC bearer of split bearer(s) (upon which the MN may release the bearer or maintain current bearer type or reconfigure it to an MCG bearer, either MN terminated or SN terminated), to trigger the release of SCG resources (e.g., release SCG lower layer resources but keep SN), and to trigger PSCell change (e.g. when a new security key is required or when the MN needs to perform PDCP data recovery). The MN cannot reject the release request of SCG bearer and the SCG RLC bearer of a split bearer and the release request of SCG resources. The SN also uses this procedure to activate or deactivate the SCG. The MN shall either accept modification of all of the requested SCG bearer(s) and the SCG RLC bearer of split bearer(s) and the request of activation or deactivation of the SCG, or fail the procedure. Figure 10.3.1-2 shows an example signalling flow for an SN initiated SgNB Modification procedure, with MN involvement.
1.	The SN sends the SgNB Modification Required message including a NR RRC configuration message, which may contain bearer context related, other UE context related information and the new SCG radio resource configuration. The SN may request the SCG to be activated or deactivated. For bearer release or modification, a corresponding E-RAB list is included in the SgNB Modification Required message. In case of change of security key, the PDCP Change Indication indicates that a S-KgNB update is required. In case the MN needs to perform PDCP data recovery, the PDCP Change Indication indicates that PDCP data recovery is required. In case SN decides to trigger SCG release, the E-RABs to be modified list includes all the E-RABs of the UE with SCG resource indicated as not present for each E-RAB.
The SN can decide whether the change of security key is required.
NOTE 1a:	In case SN includes the indication of full RRC configuration in SgNB Modification Required message to MN e.g. comprehension failure upon intra-CU inter-DU change, MN performs release and add of the NR SCG part of the configuration but does not release SN terminated radio bearers towards the UE.
NOTE 1b:	In case that a MN initiated conditional reconfiguration (e.g. CHO or MN initiated inter-SN CPC) is prepared, and if any execution of a prepared SN initiated intra-SN CPC procedure or reconfiguration of the SCG, the SN notifies to the MN via the SgNB Modification Required message. In this case, the steps 2 and 3 are skipped.
NOTE 1c:	In case of SN initiated inter-SN CPC and in case that a candidate SN triggered the SN Initiated SN Modification procedure to include some more prepared PSCells (within the candidate cells suggested by the source SN in SN initiated inter-SN CPC) or to remove some prepared PSCells, the MN may decide to trigger the step 2 towards the source SN.
2/3.	The MN initiated SN Modification procedure may be triggered by the SN Modification Required message (e.g. to provide information such as data forwarding addresses, new SN security key, measurement gap, etc...)
NOTE 2:	If only SN security key is provided in step 2, the MN does not need to wait for the reception of step 3 to initiate the RRC connection reconfiguration procedure.
4.	The MN sends the RRCConnectionReconfiguration message including a NR RRC configuration message to the UE including the new SCG radio resource configuration.
5.	The UE applies the new configuration and sends the RRCConnectionReconfigurationComplete message, including an encoded NR RRC response message, if needed. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
6.	Upon successful completion of the reconfiguration, the success of the procedure is indicated in the SgNB Modification Confirm message containing the encoded NR RRC response message, if received from the UE.
7.	If instructed, the UE performs synchronisation towards the PSCell of the SN as described in SN addition procedure. Otherwise, the UE may perform UL transmission after having applied the new configuration.
8.	If PDCP termination point is changed for bearers using RLC AM, and when RRC full configuration is not used, the SN Status Transfer takes place between the MN and the SN (Figure 10.3.1-2 depicts the case where a bearer context is transferred from the SN to the MN).
NOTE 2a:	The SN may not be aware that a SN terminated bearer requesting to release is reconfigured to a MN terminated bearer. The SN Status for the released SN terminated bearers with RLC AM may also be transferred to the MN.
9.	If applicable, data forwarding between MN and the SN takes place (Figure 10.3.1-2 depicts the case where a bearer context is transferred from the SN to the MN).
10.	The SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE over the NR radio for the E-RABs to be released.
NOTE 3:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN is not defined. The SN may send the report when the transmission of the related bearer is stopped.
11.	If applicable, a path update is performed.
SN initiated SN Modification without MN involvement
Figure 10.3.1-3: SN modification - SN initiated without MN involvement
The SN initiated modification without MN involved procedure is used to modify the configuration within SN in case no coordination with MN is required, including the addition/modification/release of SCG SCell and PSCell change (e.g. when the security key does not need to be changed and the MN does not need to be involved in PDCP recovery). The SN may initiate the procedure to configure, modify or release intra-SN CPC configuration within the same SN. Figure 10.3.1-3 shows an example signalling flow for SN initiated SN modification procedure, without MN involvement. The SN can decide whether the Random Access procedure is required.
1.	The SN sends the RRCReconfiguration message to the UE through SRB3. The UE applies the new configuration. In case the UE is unable to comply with (part of) the configuration included in the RRCReconfiguration message, it performs the reconfiguration failure procedure.
2.	If instructed, the UE performs synchronisation towards the PSCell of the SN.
3.	The UE replies with the RRCReconfigurationComplete message.
SN initiated Conditional SN Modification without MN involvement (SRB3 is used)
Figure 10.3.1-3a: SN Modification - SN-initiated without MN involvement and SRB3 is used to configure intra-SN CPC.
The SN initiates the procedure when it needs to transfer an NR RRC message to the UE and SRB3 is used to configure intra-SN CPC.
1.	The SN sends the RRCReconfiguration message including CPC configuration to the UE through SRB3.
2.	The UE applies the new configuration. In case the UE is unable to comply with (part of) the configuration included in the RRCReconfiguration message, it performs the reconfiguration failure procedure. The UE starts evaluating the CPC execution conditions for the candidate PSCell(s). The UE maintains connection with the source PSCell and replies with the RRCReconfigurationComplete message to the SN via SRB3.
3.	If at least one CPC candidate PSCell satisfies the corresponding CPC execution condition, the UE detaches from the source PSCell, applies the stored configuration corresponding to the selected candidate PSCell and synchronises to the candidate PSCell.
4.	The UE completes the CPC execution procedure by sending an RRCReconfigurationComplete message to the new PSCell.
Transfer of an NR RRC message to/from the UE (when SRB3 is not used)
Figure 10.3.1-4: Transfer of an NR RRC message to/from the UE
The SN initiates the procedure when it needs to transfer an NR RRC message to the UE and SRB3 is not used.
1.	The SN initiates the procedure by sending the SgNB Modification Required to the MN.
2.	The MN forwards the NR RRC message to the UE in the RRCConnectionReconfiguration message.
3.	The UE applies the new configuration and replies with the RRCConnectionReconfigurationComplete message. In case the UE is unable to comply with (part of) the configuration included in the NR RRC message, it performs the reconfiguration failure procedure.
4.	The MN forwards the NR RRC response message, if received from the UE, to the SN in the SgNB Modification Confirm message.
5.	If instructed, the UE performs synchronisation towards the PSCell of the SN as described in SgNB Addition procedure. Otherwise the UE may perform UL transmission after having applied the new configuration.
SN initiated Conditional SN Modification without MN involvement (SRB3 is not used)
Figure 10.3.1-5: SN Modification - SN-initiated without MN involvement and SRB3 is not used to configure intra-SN CPC
The SN initiates the procedure when it needs to transfer an NR RRC message to the UE and SRB3 is not used to configure intra-SN CPC.
1.	The SN initiates the procedure by sending the SgNB Modification Required to the MN including the SN RRC reconfiguration message with CPC configuration.
2.	The MN forwards the SN RRC reconfiguration message to the UE including it in the RRCConnectionReconfiguration message.
3.	The UE replies with the RRCConnectionReconfigurationComplete message by including the SN RRC reconfiguration complete message. In case the UE is unable to comply with (part of) the configuration included in the SN RRC reconfiguration message, it performs the reconfiguration failure procedure. The UE maintains connection with source PSCell after receiving CPC configuration, and starts evaluating the CPC execution conditions for the candidate PSCell(s).
4.	The MN forwards the SN RRC response message, if received from the UE, to the SN by including it in the SgNB Modification Confirm message.
5.	If at least one CPC candidate PSCell satisfies the corresponding CPC execution condition, the UE completes the CPC execution procedure by an ULInformationTransferMRDC message to the MN which includes an embedded RRCReconfigurationComplete message to the selected target PSCell.
6.	The RRCReconfigurationComplete message is forwarded to the SN embedded in RRC Transfer message.
7.	The UE detaches from the source PSCell, applies the stored corresponding configuration and synchronises to the selected candidate PSCell.",TS 37.340,10.3.1,all_images/image_561.jpeg,SN Modification procedure - MN initiated
"The Secondary Node Modification procedure may be initiated either by the MN or by the SN and be used to modify, establish or release bearer contexts, to transfer bearer contexts to and from the SN or to modify other properties of the UE context within the same SN. It may also be used to transfer an NR RRC message from the SN to the UE via the MN and the response from the UE via MN to the SN (e.g. when SRB3 is not used). In case of CPA or inter-SN CPC, this procedure is used to modify CPA or inter-SN CPC configuration within the same candidate SN. In case of CPA or inter-SN CPC, this procedure may also be triggered by the candidate SN to add some prepared PSCells from the suggested list or cancel part of the prepared PSCells. In case of intra-SN CPC, this procedure is used to configure, modify or release intra-SN CPC configuration. This procedure may be initiated by the MN or SN to request the SN or MN to deactivate or activate the SCG.
The Secondary Node modification procedure does not necessarily need to involve signalling towards the UE.
MN initiated SN Modification
Figure 10.3.1-1: SN Modification procedure - MN initiated
The MN uses the procedure to initiate configuration changes of the SCG within the same SN, e.g. the addition, modification or release of SCG bearer(s) and the SCG RLC bearer of split bearer(s), as well as configuration changes for SN terminated MCG bearers. Bearer termination point change is realized by adding the new bearer configuration and releasing the old bearer configuration within a single MN initiated SN Modification procedure for the respective E-RAB. The MN uses this procedure to perform handover within the same MN while keeping the SN. The MN also uses the procedure to query the current SCG configuration, e.g. when delta configuration is applied in an MN initiated SN change. The MN also uses the procedure to provide the S-RLF related information to the SN. The MN also uses this procedure to activate or deactivate the SCG. The MN may not use the procedure to initiate the addition, modification or release of SCG SCells. The SN may reject the request, except if it concerns the release of SN terminated bearer(s) or the SCG RLC bearer of MN terminated bearer(s), or if it is used to perform handover within the same MN while keeping the SN. Figure 10.3.1-1 shows an example signalling flow for an MN initiated SN Modification procedure.
1.	The MN sends the SgNB Modification Request message, which may contain bearer context related or other UE context related information, data forwarding address information (if applicable) and the requested SCG configuration information, including the UE capability coordination result to be used as basis for the reconfiguration by the SN. The MN may request the SCG to be activated or deactivated. In case a security key update in the SN is required, a new SgNB Security Key is included. In case of SCG RLC re-establishment for E-RABs configured with an MN terminated bearer with an SCG RLC bearer for which no bearer type change is performed, the MN provides a new UL GTP tunnel endpoint to the SN. The SN shall continue sending UL PDCP PDUs to the MN with the previous UL GTP tunnel endpoint until it re-establishes the RLC and use the new UL GTP tunnel endpoint after re-establishment. In case of PDCP re-establishment for E-RABs configured with an SN terminated bearer with an MCG RLC bearer for which no bearer type change is performed, the MN provides a new DL GTP tunnel endpoint to the SN. The SN shall continue sending DL PDCP PDUs to the MN with the previous DL GTP tunnel endpoint until it performs PDCP re-establishment and use the new DL GTP tunnel endpoint starting with the PDCP re-establishment.
2.	The SN responds with the SgNB Modification Request Acknowledge message, which may contain SCG radio resource configuration information within a NR RRC configuration message and data forwarding address information (if applicable). If the MN requested the SCG to be activated or deactivated, the SN indicates whether the SCG is activated or deactivated. In case of a security key update (with or without PSCell change), for E-RABs configured with the MN terminated bearer option that require X2-U resources between the MN and the SN, for which no bearer type change is performed, the SN provides a new DL GTP tunnel endpoint to the MN. The MN shall continue sending DL PDCP PDUs to the SN with the previous DL GTP tunnel endpoint until it performs PDCP re-establishment or PDCP data recovery, and use the new DL GTP tunnel endpoint starting with the PDCP re-establishment or data recovery. In case of a security key update (with or without PSCell change), for E-RABs configured with the SN terminated bearer option that require X2-U resources between the MN and the SN, for which no bearer type change is performed, the SN provides a new UL GTP tunnel endpoint to the MN. The MN shall continue sending UL PDCP PDUs to the SN with the previous UL GTP tunnel endpoint until it re-establishes the RLC and use the new UL GTP tunnel endpoint after re-establishment.
NOTE 00:	In case SN includes the indication of full RRC configuration in SgNB Modification Request Acknowledge message to MN e.g. comprehension failure upon intra-CU inter-DU change, MN performs release and add of the NR SCG part of the configuration but does not release SN terminated radio bearers towards the UE.
3-5.	The MN initiates the RRC connection reconfiguration procedure, including the NR RRC configuration message. The UE applies the new configuration, synchronizes to the MN (if instructed, in case of intra-MN handover) and replies with RRCConnectionReconfigurationComplete, including a NR RRC response message, if needed. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
6.	Upon successful completion of the reconfiguration, the success of the procedure is indicated in the SgNB Reconfiguration Complete message.
7.	If instructed, the UE performs synchronisation towards the PSCell of the SN as described in SgNB addition procedure. Otherwise, the UE may perform UL transmission after having applied the new configuration.
8.	If PDCP termination point is changed for bearers using RLC AM, and when RRC full configuration is not used, the SN Status Transfer takes place between the MN and the SN (Figure 10.3.1-1 depicts the case where a bearer context is transferred from the MN to the SN).
NOTE 0:	The SN may not be aware that a SN terminated bearer requested to be released is reconfigured to a MN terminated bearer. The SN Status for the released SN terminated bearers with RLC AM may also be transferred to the MN.
9.	If applicable, data forwarding between MN and the SN takes place (Figure 10.3.1-1 depicts the case where a bearer context is transferred from the MN to the SN).
10.	The SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE over the NR radio for the E-RABs to be released and for the E-RABs for which the S1 UL GTP Tunnel endpoint was requested to be modified.
NOTE 1:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN is not defined. The SN may send the report when the transmission of the related bearer is stopped.
11.	If applicable, a path update is performed.
SN initiated SN Modification with MN involvement
Figure 10.3.1-2: SN Modification procedure - SN initiated with MN involvement
The SN uses the procedure to perform configuration changes of the SCG within the same SN, e.g. to trigger the release of SCG bearer(s) and the SCG RLC bearer of split bearer(s) (upon which the MN may release the bearer or maintain current bearer type or reconfigure it to an MCG bearer, either MN terminated or SN terminated), to trigger the release of SCG resources (e.g., release SCG lower layer resources but keep SN), and to trigger PSCell change (e.g. when a new security key is required or when the MN needs to perform PDCP data recovery). The MN cannot reject the release request of SCG bearer and the SCG RLC bearer of a split bearer and the release request of SCG resources. The SN also uses this procedure to activate or deactivate the SCG. The MN shall either accept modification of all of the requested SCG bearer(s) and the SCG RLC bearer of split bearer(s) and the request of activation or deactivation of the SCG, or fail the procedure. Figure 10.3.1-2 shows an example signalling flow for an SN initiated SgNB Modification procedure, with MN involvement.
1.	The SN sends the SgNB Modification Required message including a NR RRC configuration message, which may contain bearer context related, other UE context related information and the new SCG radio resource configuration. The SN may request the SCG to be activated or deactivated. For bearer release or modification, a corresponding E-RAB list is included in the SgNB Modification Required message. In case of change of security key, the PDCP Change Indication indicates that a S-KgNB update is required. In case the MN needs to perform PDCP data recovery, the PDCP Change Indication indicates that PDCP data recovery is required. In case SN decides to trigger SCG release, the E-RABs to be modified list includes all the E-RABs of the UE with SCG resource indicated as not present for each E-RAB.
The SN can decide whether the change of security key is required.
NOTE 1a:	In case SN includes the indication of full RRC configuration in SgNB Modification Required message to MN e.g. comprehension failure upon intra-CU inter-DU change, MN performs release and add of the NR SCG part of the configuration but does not release SN terminated radio bearers towards the UE.
NOTE 1b:	In case that a MN initiated conditional reconfiguration (e.g. CHO or MN initiated inter-SN CPC) is prepared, and if any execution of a prepared SN initiated intra-SN CPC procedure or reconfiguration of the SCG, the SN notifies to the MN via the SgNB Modification Required message. In this case, the steps 2 and 3 are skipped.
NOTE 1c:	In case of SN initiated inter-SN CPC and in case that a candidate SN triggered the SN Initiated SN Modification procedure to include some more prepared PSCells (within the candidate cells suggested by the source SN in SN initiated inter-SN CPC) or to remove some prepared PSCells, the MN may decide to trigger the step 2 towards the source SN.
2/3.	The MN initiated SN Modification procedure may be triggered by the SN Modification Required message (e.g. to provide information such as data forwarding addresses, new SN security key, measurement gap, etc...)
NOTE 2:	If only SN security key is provided in step 2, the MN does not need to wait for the reception of step 3 to initiate the RRC connection reconfiguration procedure.
4.	The MN sends the RRCConnectionReconfiguration message including a NR RRC configuration message to the UE including the new SCG radio resource configuration.
5.	The UE applies the new configuration and sends the RRCConnectionReconfigurationComplete message, including an encoded NR RRC response message, if needed. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
6.	Upon successful completion of the reconfiguration, the success of the procedure is indicated in the SgNB Modification Confirm message containing the encoded NR RRC response message, if received from the UE.
7.	If instructed, the UE performs synchronisation towards the PSCell of the SN as described in SN addition procedure. Otherwise, the UE may perform UL transmission after having applied the new configuration.
8.	If PDCP termination point is changed for bearers using RLC AM, and when RRC full configuration is not used, the SN Status Transfer takes place between the MN and the SN (Figure 10.3.1-2 depicts the case where a bearer context is transferred from the SN to the MN).
NOTE 2a:	The SN may not be aware that a SN terminated bearer requesting to release is reconfigured to a MN terminated bearer. The SN Status for the released SN terminated bearers with RLC AM may also be transferred to the MN.
9.	If applicable, data forwarding between MN and the SN takes place (Figure 10.3.1-2 depicts the case where a bearer context is transferred from the SN to the MN).
10.	The SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE over the NR radio for the E-RABs to be released.
NOTE 3:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN is not defined. The SN may send the report when the transmission of the related bearer is stopped.
11.	If applicable, a path update is performed.
SN initiated SN Modification without MN involvement
Figure 10.3.1-3: SN modification - SN initiated without MN involvement
The SN initiated modification without MN involved procedure is used to modify the configuration within SN in case no coordination with MN is required, including the addition/modification/release of SCG SCell and PSCell change (e.g. when the security key does not need to be changed and the MN does not need to be involved in PDCP recovery). The SN may initiate the procedure to configure, modify or release intra-SN CPC configuration within the same SN. Figure 10.3.1-3 shows an example signalling flow for SN initiated SN modification procedure, without MN involvement. The SN can decide whether the Random Access procedure is required.
1.	The SN sends the RRCReconfiguration message to the UE through SRB3. The UE applies the new configuration. In case the UE is unable to comply with (part of) the configuration included in the RRCReconfiguration message, it performs the reconfiguration failure procedure.
2.	If instructed, the UE performs synchronisation towards the PSCell of the SN.
3.	The UE replies with the RRCReconfigurationComplete message.
SN initiated Conditional SN Modification without MN involvement (SRB3 is used)
Figure 10.3.1-3a: SN Modification - SN-initiated without MN involvement and SRB3 is used to configure intra-SN CPC.
The SN initiates the procedure when it needs to transfer an NR RRC message to the UE and SRB3 is used to configure intra-SN CPC.
1.	The SN sends the RRCReconfiguration message including CPC configuration to the UE through SRB3.
2.	The UE applies the new configuration. In case the UE is unable to comply with (part of) the configuration included in the RRCReconfiguration message, it performs the reconfiguration failure procedure. The UE starts evaluating the CPC execution conditions for the candidate PSCell(s). The UE maintains connection with the source PSCell and replies with the RRCReconfigurationComplete message to the SN via SRB3.
3.	If at least one CPC candidate PSCell satisfies the corresponding CPC execution condition, the UE detaches from the source PSCell, applies the stored configuration corresponding to the selected candidate PSCell and synchronises to the candidate PSCell.
4.	The UE completes the CPC execution procedure by sending an RRCReconfigurationComplete message to the new PSCell.
Transfer of an NR RRC message to/from the UE (when SRB3 is not used)
Figure 10.3.1-4: Transfer of an NR RRC message to/from the UE
The SN initiates the procedure when it needs to transfer an NR RRC message to the UE and SRB3 is not used.
1.	The SN initiates the procedure by sending the SgNB Modification Required to the MN.
2.	The MN forwards the NR RRC message to the UE in the RRCConnectionReconfiguration message.
3.	The UE applies the new configuration and replies with the RRCConnectionReconfigurationComplete message. In case the UE is unable to comply with (part of) the configuration included in the NR RRC message, it performs the reconfiguration failure procedure.
4.	The MN forwards the NR RRC response message, if received from the UE, to the SN in the SgNB Modification Confirm message.
5.	If instructed, the UE performs synchronisation towards the PSCell of the SN as described in SgNB Addition procedure. Otherwise the UE may perform UL transmission after having applied the new configuration.
SN initiated Conditional SN Modification without MN involvement (SRB3 is not used)
Figure 10.3.1-5: SN Modification - SN-initiated without MN involvement and SRB3 is not used to configure intra-SN CPC
The SN initiates the procedure when it needs to transfer an NR RRC message to the UE and SRB3 is not used to configure intra-SN CPC.
1.	The SN initiates the procedure by sending the SgNB Modification Required to the MN including the SN RRC reconfiguration message with CPC configuration.
2.	The MN forwards the SN RRC reconfiguration message to the UE including it in the RRCConnectionReconfiguration message.
3.	The UE replies with the RRCConnectionReconfigurationComplete message by including the SN RRC reconfiguration complete message. In case the UE is unable to comply with (part of) the configuration included in the SN RRC reconfiguration message, it performs the reconfiguration failure procedure. The UE maintains connection with source PSCell after receiving CPC configuration, and starts evaluating the CPC execution conditions for the candidate PSCell(s).
4.	The MN forwards the SN RRC response message, if received from the UE, to the SN by including it in the SgNB Modification Confirm message.
5.	If at least one CPC candidate PSCell satisfies the corresponding CPC execution condition, the UE completes the CPC execution procedure by an ULInformationTransferMRDC message to the MN which includes an embedded RRCReconfigurationComplete message to the selected target PSCell.
6.	The RRCReconfigurationComplete message is forwarded to the SN embedded in RRC Transfer message.
7.	The UE detaches from the source PSCell, applies the stored corresponding configuration and synchronises to the selected candidate PSCell.",TS 37.340,10.3.1,all_images/image_562.jpeg,SN Modification procedure - SN initiated with MN involvement
"The Secondary Node Modification procedure may be initiated either by the MN or by the SN and be used to modify, establish or release bearer contexts, to transfer bearer contexts to and from the SN or to modify other properties of the UE context within the same SN. It may also be used to transfer an NR RRC message from the SN to the UE via the MN and the response from the UE via MN to the SN (e.g. when SRB3 is not used). In case of CPA or inter-SN CPC, this procedure is used to modify CPA or inter-SN CPC configuration within the same candidate SN. In case of CPA or inter-SN CPC, this procedure may also be triggered by the candidate SN to add some prepared PSCells from the suggested list or cancel part of the prepared PSCells. In case of intra-SN CPC, this procedure is used to configure, modify or release intra-SN CPC configuration. This procedure may be initiated by the MN or SN to request the SN or MN to deactivate or activate the SCG.
The Secondary Node modification procedure does not necessarily need to involve signalling towards the UE.
MN initiated SN Modification
Figure 10.3.1-1: SN Modification procedure - MN initiated
The MN uses the procedure to initiate configuration changes of the SCG within the same SN, e.g. the addition, modification or release of SCG bearer(s) and the SCG RLC bearer of split bearer(s), as well as configuration changes for SN terminated MCG bearers. Bearer termination point change is realized by adding the new bearer configuration and releasing the old bearer configuration within a single MN initiated SN Modification procedure for the respective E-RAB. The MN uses this procedure to perform handover within the same MN while keeping the SN. The MN also uses the procedure to query the current SCG configuration, e.g. when delta configuration is applied in an MN initiated SN change. The MN also uses the procedure to provide the S-RLF related information to the SN. The MN also uses this procedure to activate or deactivate the SCG. The MN may not use the procedure to initiate the addition, modification or release of SCG SCells. The SN may reject the request, except if it concerns the release of SN terminated bearer(s) or the SCG RLC bearer of MN terminated bearer(s), or if it is used to perform handover within the same MN while keeping the SN. Figure 10.3.1-1 shows an example signalling flow for an MN initiated SN Modification procedure.
1.	The MN sends the SgNB Modification Request message, which may contain bearer context related or other UE context related information, data forwarding address information (if applicable) and the requested SCG configuration information, including the UE capability coordination result to be used as basis for the reconfiguration by the SN. The MN may request the SCG to be activated or deactivated. In case a security key update in the SN is required, a new SgNB Security Key is included. In case of SCG RLC re-establishment for E-RABs configured with an MN terminated bearer with an SCG RLC bearer for which no bearer type change is performed, the MN provides a new UL GTP tunnel endpoint to the SN. The SN shall continue sending UL PDCP PDUs to the MN with the previous UL GTP tunnel endpoint until it re-establishes the RLC and use the new UL GTP tunnel endpoint after re-establishment. In case of PDCP re-establishment for E-RABs configured with an SN terminated bearer with an MCG RLC bearer for which no bearer type change is performed, the MN provides a new DL GTP tunnel endpoint to the SN. The SN shall continue sending DL PDCP PDUs to the MN with the previous DL GTP tunnel endpoint until it performs PDCP re-establishment and use the new DL GTP tunnel endpoint starting with the PDCP re-establishment.
2.	The SN responds with the SgNB Modification Request Acknowledge message, which may contain SCG radio resource configuration information within a NR RRC configuration message and data forwarding address information (if applicable). If the MN requested the SCG to be activated or deactivated, the SN indicates whether the SCG is activated or deactivated. In case of a security key update (with or without PSCell change), for E-RABs configured with the MN terminated bearer option that require X2-U resources between the MN and the SN, for which no bearer type change is performed, the SN provides a new DL GTP tunnel endpoint to the MN. The MN shall continue sending DL PDCP PDUs to the SN with the previous DL GTP tunnel endpoint until it performs PDCP re-establishment or PDCP data recovery, and use the new DL GTP tunnel endpoint starting with the PDCP re-establishment or data recovery. In case of a security key update (with or without PSCell change), for E-RABs configured with the SN terminated bearer option that require X2-U resources between the MN and the SN, for which no bearer type change is performed, the SN provides a new UL GTP tunnel endpoint to the MN. The MN shall continue sending UL PDCP PDUs to the SN with the previous UL GTP tunnel endpoint until it re-establishes the RLC and use the new UL GTP tunnel endpoint after re-establishment.
NOTE 00:	In case SN includes the indication of full RRC configuration in SgNB Modification Request Acknowledge message to MN e.g. comprehension failure upon intra-CU inter-DU change, MN performs release and add of the NR SCG part of the configuration but does not release SN terminated radio bearers towards the UE.
3-5.	The MN initiates the RRC connection reconfiguration procedure, including the NR RRC configuration message. The UE applies the new configuration, synchronizes to the MN (if instructed, in case of intra-MN handover) and replies with RRCConnectionReconfigurationComplete, including a NR RRC response message, if needed. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
6.	Upon successful completion of the reconfiguration, the success of the procedure is indicated in the SgNB Reconfiguration Complete message.
7.	If instructed, the UE performs synchronisation towards the PSCell of the SN as described in SgNB addition procedure. Otherwise, the UE may perform UL transmission after having applied the new configuration.
8.	If PDCP termination point is changed for bearers using RLC AM, and when RRC full configuration is not used, the SN Status Transfer takes place between the MN and the SN (Figure 10.3.1-1 depicts the case where a bearer context is transferred from the MN to the SN).
NOTE 0:	The SN may not be aware that a SN terminated bearer requested to be released is reconfigured to a MN terminated bearer. The SN Status for the released SN terminated bearers with RLC AM may also be transferred to the MN.
9.	If applicable, data forwarding between MN and the SN takes place (Figure 10.3.1-1 depicts the case where a bearer context is transferred from the MN to the SN).
10.	The SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE over the NR radio for the E-RABs to be released and for the E-RABs for which the S1 UL GTP Tunnel endpoint was requested to be modified.
NOTE 1:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN is not defined. The SN may send the report when the transmission of the related bearer is stopped.
11.	If applicable, a path update is performed.
SN initiated SN Modification with MN involvement
Figure 10.3.1-2: SN Modification procedure - SN initiated with MN involvement
The SN uses the procedure to perform configuration changes of the SCG within the same SN, e.g. to trigger the release of SCG bearer(s) and the SCG RLC bearer of split bearer(s) (upon which the MN may release the bearer or maintain current bearer type or reconfigure it to an MCG bearer, either MN terminated or SN terminated), to trigger the release of SCG resources (e.g., release SCG lower layer resources but keep SN), and to trigger PSCell change (e.g. when a new security key is required or when the MN needs to perform PDCP data recovery). The MN cannot reject the release request of SCG bearer and the SCG RLC bearer of a split bearer and the release request of SCG resources. The SN also uses this procedure to activate or deactivate the SCG. The MN shall either accept modification of all of the requested SCG bearer(s) and the SCG RLC bearer of split bearer(s) and the request of activation or deactivation of the SCG, or fail the procedure. Figure 10.3.1-2 shows an example signalling flow for an SN initiated SgNB Modification procedure, with MN involvement.
1.	The SN sends the SgNB Modification Required message including a NR RRC configuration message, which may contain bearer context related, other UE context related information and the new SCG radio resource configuration. The SN may request the SCG to be activated or deactivated. For bearer release or modification, a corresponding E-RAB list is included in the SgNB Modification Required message. In case of change of security key, the PDCP Change Indication indicates that a S-KgNB update is required. In case the MN needs to perform PDCP data recovery, the PDCP Change Indication indicates that PDCP data recovery is required. In case SN decides to trigger SCG release, the E-RABs to be modified list includes all the E-RABs of the UE with SCG resource indicated as not present for each E-RAB.
The SN can decide whether the change of security key is required.
NOTE 1a:	In case SN includes the indication of full RRC configuration in SgNB Modification Required message to MN e.g. comprehension failure upon intra-CU inter-DU change, MN performs release and add of the NR SCG part of the configuration but does not release SN terminated radio bearers towards the UE.
NOTE 1b:	In case that a MN initiated conditional reconfiguration (e.g. CHO or MN initiated inter-SN CPC) is prepared, and if any execution of a prepared SN initiated intra-SN CPC procedure or reconfiguration of the SCG, the SN notifies to the MN via the SgNB Modification Required message. In this case, the steps 2 and 3 are skipped.
NOTE 1c:	In case of SN initiated inter-SN CPC and in case that a candidate SN triggered the SN Initiated SN Modification procedure to include some more prepared PSCells (within the candidate cells suggested by the source SN in SN initiated inter-SN CPC) or to remove some prepared PSCells, the MN may decide to trigger the step 2 towards the source SN.
2/3.	The MN initiated SN Modification procedure may be triggered by the SN Modification Required message (e.g. to provide information such as data forwarding addresses, new SN security key, measurement gap, etc...)
NOTE 2:	If only SN security key is provided in step 2, the MN does not need to wait for the reception of step 3 to initiate the RRC connection reconfiguration procedure.
4.	The MN sends the RRCConnectionReconfiguration message including a NR RRC configuration message to the UE including the new SCG radio resource configuration.
5.	The UE applies the new configuration and sends the RRCConnectionReconfigurationComplete message, including an encoded NR RRC response message, if needed. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
6.	Upon successful completion of the reconfiguration, the success of the procedure is indicated in the SgNB Modification Confirm message containing the encoded NR RRC response message, if received from the UE.
7.	If instructed, the UE performs synchronisation towards the PSCell of the SN as described in SN addition procedure. Otherwise, the UE may perform UL transmission after having applied the new configuration.
8.	If PDCP termination point is changed for bearers using RLC AM, and when RRC full configuration is not used, the SN Status Transfer takes place between the MN and the SN (Figure 10.3.1-2 depicts the case where a bearer context is transferred from the SN to the MN).
NOTE 2a:	The SN may not be aware that a SN terminated bearer requesting to release is reconfigured to a MN terminated bearer. The SN Status for the released SN terminated bearers with RLC AM may also be transferred to the MN.
9.	If applicable, data forwarding between MN and the SN takes place (Figure 10.3.1-2 depicts the case where a bearer context is transferred from the SN to the MN).
10.	The SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE over the NR radio for the E-RABs to be released.
NOTE 3:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN is not defined. The SN may send the report when the transmission of the related bearer is stopped.
11.	If applicable, a path update is performed.
SN initiated SN Modification without MN involvement
Figure 10.3.1-3: SN modification - SN initiated without MN involvement
The SN initiated modification without MN involved procedure is used to modify the configuration within SN in case no coordination with MN is required, including the addition/modification/release of SCG SCell and PSCell change (e.g. when the security key does not need to be changed and the MN does not need to be involved in PDCP recovery). The SN may initiate the procedure to configure, modify or release intra-SN CPC configuration within the same SN. Figure 10.3.1-3 shows an example signalling flow for SN initiated SN modification procedure, without MN involvement. The SN can decide whether the Random Access procedure is required.
1.	The SN sends the RRCReconfiguration message to the UE through SRB3. The UE applies the new configuration. In case the UE is unable to comply with (part of) the configuration included in the RRCReconfiguration message, it performs the reconfiguration failure procedure.
2.	If instructed, the UE performs synchronisation towards the PSCell of the SN.
3.	The UE replies with the RRCReconfigurationComplete message.
SN initiated Conditional SN Modification without MN involvement (SRB3 is used)
Figure 10.3.1-3a: SN Modification - SN-initiated without MN involvement and SRB3 is used to configure intra-SN CPC.
The SN initiates the procedure when it needs to transfer an NR RRC message to the UE and SRB3 is used to configure intra-SN CPC.
1.	The SN sends the RRCReconfiguration message including CPC configuration to the UE through SRB3.
2.	The UE applies the new configuration. In case the UE is unable to comply with (part of) the configuration included in the RRCReconfiguration message, it performs the reconfiguration failure procedure. The UE starts evaluating the CPC execution conditions for the candidate PSCell(s). The UE maintains connection with the source PSCell and replies with the RRCReconfigurationComplete message to the SN via SRB3.
3.	If at least one CPC candidate PSCell satisfies the corresponding CPC execution condition, the UE detaches from the source PSCell, applies the stored configuration corresponding to the selected candidate PSCell and synchronises to the candidate PSCell.
4.	The UE completes the CPC execution procedure by sending an RRCReconfigurationComplete message to the new PSCell.
Transfer of an NR RRC message to/from the UE (when SRB3 is not used)
Figure 10.3.1-4: Transfer of an NR RRC message to/from the UE
The SN initiates the procedure when it needs to transfer an NR RRC message to the UE and SRB3 is not used.
1.	The SN initiates the procedure by sending the SgNB Modification Required to the MN.
2.	The MN forwards the NR RRC message to the UE in the RRCConnectionReconfiguration message.
3.	The UE applies the new configuration and replies with the RRCConnectionReconfigurationComplete message. In case the UE is unable to comply with (part of) the configuration included in the NR RRC message, it performs the reconfiguration failure procedure.
4.	The MN forwards the NR RRC response message, if received from the UE, to the SN in the SgNB Modification Confirm message.
5.	If instructed, the UE performs synchronisation towards the PSCell of the SN as described in SgNB Addition procedure. Otherwise the UE may perform UL transmission after having applied the new configuration.
SN initiated Conditional SN Modification without MN involvement (SRB3 is not used)
Figure 10.3.1-5: SN Modification - SN-initiated without MN involvement and SRB3 is not used to configure intra-SN CPC
The SN initiates the procedure when it needs to transfer an NR RRC message to the UE and SRB3 is not used to configure intra-SN CPC.
1.	The SN initiates the procedure by sending the SgNB Modification Required to the MN including the SN RRC reconfiguration message with CPC configuration.
2.	The MN forwards the SN RRC reconfiguration message to the UE including it in the RRCConnectionReconfiguration message.
3.	The UE replies with the RRCConnectionReconfigurationComplete message by including the SN RRC reconfiguration complete message. In case the UE is unable to comply with (part of) the configuration included in the SN RRC reconfiguration message, it performs the reconfiguration failure procedure. The UE maintains connection with source PSCell after receiving CPC configuration, and starts evaluating the CPC execution conditions for the candidate PSCell(s).
4.	The MN forwards the SN RRC response message, if received from the UE, to the SN by including it in the SgNB Modification Confirm message.
5.	If at least one CPC candidate PSCell satisfies the corresponding CPC execution condition, the UE completes the CPC execution procedure by an ULInformationTransferMRDC message to the MN which includes an embedded RRCReconfigurationComplete message to the selected target PSCell.
6.	The RRCReconfigurationComplete message is forwarded to the SN embedded in RRC Transfer message.
7.	The UE detaches from the source PSCell, applies the stored corresponding configuration and synchronises to the selected candidate PSCell.",TS 37.340,10.3.1,all_images/image_563.jpeg,Transfer of an NR RRC message to/from the UE
"The Secondary Node Release procedure may be initiated either by the MN or by the SN and is used to initiate the release of the UE context at the SN. The recipient node of this request can reject it, e.g., if a SN change procedure is triggered by the SN.
In case of CPA or inter-SN CPC, this procedure may be initiated either by the MN or the candidate SN, and it is used to cancel all the prepared PSCells at the candidate SN and initiate the release of related UE context at the candidate SN.
It does not necessarily need to involve signalling towards the UE, e.g., in case of the RRC connection re-establishment due to Radio Link Failure in MN.
MN initiated SN Release
Figure 10.4.1-1: SN Release procedure – MN initiated
Figure 10.4.1-1 shows an example signalling flow for the MN initiated Secondary Node Release procedure when SN Release is confirmed by SN.
1.	The MN initiates the procedure by sending the SgNB Release Request message. If applicable, the MN provides data forwarding addresses to the SN.
2.	The SN confirms SN Release by sending the SgNB Release Request Acknowledge message. If appropriate, the SN may reject SN Release, e.g. if the SN change procedure is triggered by the SN.
NOTE 0:	If CPA or inter-SN CPC is configured, upon reception of the SgNB Release Request Acknowledge message the MN cancels all CPAC with the target candidate SN(s).
3/4.	If required, the MN indicates in the RRCConnectionReconfiguration message towards the UE that the UE shall release the entire SCG configuration. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
NOTE 1:	If data forwarding is applied, timely coordination between steps 1 and 2 may minimize gaps in service provision, this is however regarded to be an implementation matter.
5.	For bearers using RLC AM, the SN sends the SN Status Transfer message.
6.	Data forwarding from the SN to the MN may start.
7.	The SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE over the NR radio for the related E-RABs.
NOTE 2:	If data forwarding is applied, the order the SN sends the Secondary RAT Data Usage Report message and starts data forwarding with MN is not defined i.e., step 7 can take place before step 6. The SN does not need to wait for the end of data forwarding to send the Secondary RAT Data Usage Report message.
8.	If applicable, the path update procedure is initiated.
9.	Upon reception of the UE Context Release message, the SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.
SN initiated SN Release
Figure 10.4.1-2: SN Release procedure – SN initiated
Figure 10.4.1-2 shows an example signalling flow for the SN initiated Secondary Node Release procedure.
1.	The SN initiates the procedure by sending the SgNB Release Required message which may contain inter-node message to support delta configuration.
2.	If applicable, the MN provides data forwarding addresses to the SN in the SgNB Release Confirm message. The SN may start data forwarding and stop providing user data to the UE as early as it receives the SgNB Release Confirm message.
NOTE 2a:	If CPA or inter-SN CPC is configured, upon reception of the SgNB Release Required message the MN cancels all CPAC with the target candidate SN(s).
3/4.	If required, the MN indicates in the RRCConnectionReconfiguration message towards the UE that the UE shall release the entire SCG configuration. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
NOTE 3:	If data forwarding is applied, timely coordination between steps 2 and 3 may minimize gaps in service provision. This is however regarded to be an implementation matter.
5.	For bearers using RLC AM, the SN sends the SN Status Transfer message.
6.	Data forwarding from the SN to the MN may start.
7.	The SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE over the NR radio for the related E-RABs.
NOTE 4:	If data forwarding is applied, the order the SN sends the Secondary RAT Data Usage Report message and starts data forwarding with MN is not defined i.e., step 7 can take place before step 6. The SN does not need to wait for the end of data forwarding to send the Secondary RAT Data Usage Report message.
8.	If applicable, the path update procedure is initiated.
9.	Upon reception of the UE Context Release message, the SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.",TS 37.340,10.4.1,all_images/image_566.jpeg,SN Release procedure – MN initiated
"The Secondary Node Release procedure may be initiated either by the MN or by the SN and is used to initiate the release of the UE context at the SN. The recipient node of this request can reject it, e.g., if a SN change procedure is triggered by the SN.
In case of CPA or inter-SN CPC, this procedure may be initiated either by the MN or the candidate SN, and it is used to cancel all the prepared PSCells at the candidate SN and initiate the release of related UE context at the candidate SN.
It does not necessarily need to involve signalling towards the UE, e.g., in case of the RRC connection re-establishment due to Radio Link Failure in MN.
MN initiated SN Release
Figure 10.4.1-1: SN Release procedure – MN initiated
Figure 10.4.1-1 shows an example signalling flow for the MN initiated Secondary Node Release procedure when SN Release is confirmed by SN.
1.	The MN initiates the procedure by sending the SgNB Release Request message. If applicable, the MN provides data forwarding addresses to the SN.
2.	The SN confirms SN Release by sending the SgNB Release Request Acknowledge message. If appropriate, the SN may reject SN Release, e.g. if the SN change procedure is triggered by the SN.
NOTE 0:	If CPA or inter-SN CPC is configured, upon reception of the SgNB Release Request Acknowledge message the MN cancels all CPAC with the target candidate SN(s).
3/4.	If required, the MN indicates in the RRCConnectionReconfiguration message towards the UE that the UE shall release the entire SCG configuration. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
NOTE 1:	If data forwarding is applied, timely coordination between steps 1 and 2 may minimize gaps in service provision, this is however regarded to be an implementation matter.
5.	For bearers using RLC AM, the SN sends the SN Status Transfer message.
6.	Data forwarding from the SN to the MN may start.
7.	The SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE over the NR radio for the related E-RABs.
NOTE 2:	If data forwarding is applied, the order the SN sends the Secondary RAT Data Usage Report message and starts data forwarding with MN is not defined i.e., step 7 can take place before step 6. The SN does not need to wait for the end of data forwarding to send the Secondary RAT Data Usage Report message.
8.	If applicable, the path update procedure is initiated.
9.	Upon reception of the UE Context Release message, the SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.
SN initiated SN Release
Figure 10.4.1-2: SN Release procedure – SN initiated
Figure 10.4.1-2 shows an example signalling flow for the SN initiated Secondary Node Release procedure.
1.	The SN initiates the procedure by sending the SgNB Release Required message which may contain inter-node message to support delta configuration.
2.	If applicable, the MN provides data forwarding addresses to the SN in the SgNB Release Confirm message. The SN may start data forwarding and stop providing user data to the UE as early as it receives the SgNB Release Confirm message.
NOTE 2a:	If CPA or inter-SN CPC is configured, upon reception of the SgNB Release Required message the MN cancels all CPAC with the target candidate SN(s).
3/4.	If required, the MN indicates in the RRCConnectionReconfiguration message towards the UE that the UE shall release the entire SCG configuration. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
NOTE 3:	If data forwarding is applied, timely coordination between steps 2 and 3 may minimize gaps in service provision. This is however regarded to be an implementation matter.
5.	For bearers using RLC AM, the SN sends the SN Status Transfer message.
6.	Data forwarding from the SN to the MN may start.
7.	The SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE over the NR radio for the related E-RABs.
NOTE 4:	If data forwarding is applied, the order the SN sends the Secondary RAT Data Usage Report message and starts data forwarding with MN is not defined i.e., step 7 can take place before step 6. The SN does not need to wait for the end of data forwarding to send the Secondary RAT Data Usage Report message.
8.	If applicable, the path update procedure is initiated.
9.	Upon reception of the UE Context Release message, the SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.",TS 37.340,10.4.1,all_images/image_567.jpeg,SN Release procedure – SN initiated
"The Secondary Node Change procedure is initiated either by MN or SN and used to transfer a UE context from a source SN to a target SN and to change the SCG configuration in UE from one SN to another. In case of inter-SN CPC, the Conditional Secondary Node Change procedure initiated either by the MN or SN is also used for inter-SN CPC configuration and inter-SN CPC execution.
NOTE 1:	Inter-RAT SN change procedure with single RRC reconfiguration is not supported in this version of the protocol (i.e. no transition from EN-DC to DC).
The Secondary Node Change procedure always involves signalling over MCG SRB towards the UE.
MN initiated SN Change
Figure 10.5.1-1: SN Change – MN initiated
Figure 10.5.1-1 shows an example signalling flow for the MN initiated Secondary Node Change:
1/2.	The MN initiates the SN change by requesting the target SN to allocate resources for the UE by means of the SgNB Addition procedure. The MN may include measurement results related to the target SN. If forwarding is needed, the target SN provides forwarding addresses to the MN. The target SN includes the indication of the full or delta RRC configuration.
NOTE 2:	The MN may trigger the MN-initiated SN Modification procedure (to the source SN) to retrieve the current SCG configuration before step 1.
NOTE 2a:	In case the target SN includes the indication of the full RRC configuration, the MN performs release of the SN terminated radio bearer configuration and release and add of the NR SCG configuration part towards the UE.
3.	If the allocation of target SN resources was successful, the MN initiates the release of the source SN resources including a Cause indicating SCG mobility. The Source SN may reject the release. If data forwarding is needed the MN provides data forwarding addresses to the source SN. If direct data forwarding is used for SN terminated bearers, the MN provides data forwarding addresses as received from the target SN to source SN. Reception of the SgNB Release Request message triggers the source SN to stop providing user data to the UE and, if applicable, to start data forwarding.
4/5.	The MN triggers the UE to apply the new configuration. The MN indicates to the UE the new configuration in the RRCConnectionReconfiguration message including the NR RRC configuration message generated by the target SN. The UE applies the new configuration and sends the RRCConnectionReconfigurationComplete message, including the encoded NR RRC response message for the target SN, if needed. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
6.	If the RRC connection reconfiguration procedure was successful, the MN informs the target SN via SgNBReconfigurationComplete message with the encoded NR RRC response message for the target SN, if received from the UE.
7.	If configured with bearers requiring SCG radio resources, the UE synchronizes to the target SN.
8.	For SN terminated bearers using RLC AM, the source SN sends the SN Status Transfer message, which the MN sends then to the target SN, if needed.
9.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the SgNB Release Request message from the MN.
10.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE over the NR radio for the related E-RABs.
NOTE 3:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN is not defined. The SN may send the report when the transmission of the related bearer is stopped.
11-15.	If applicable, a path update is triggered by the MN.
16.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.
SN initiated SN Change
Figure 10.5.1-2: SN Change – SN initiated
Figure 10.5.1-2 shows an example signalling flow for the Secondary Node Change initiated by the SN:
1.	The source SN initiates the SN change procedure by sending SgNB Change Required message which contains target SN ID information and may include the SCG configuration (to support delta configuration) and measurement results related to the target SN.
2/3.	The MN requests the target SN to allocate resources for the UE by means of the SgNB Addition procedure, including the measurement results related to the target SN received from the source SN. If forwarding is needed, the target SN provides forwarding addresses to the MN. The target SN includes the indication of the full or delta RRC configuration.
NOTE 3a:	In case the target SN includes the indication of the full RRC configuration, the MN performs release of the SN terminated radio bearer configuration and release and add of the NR SCG configuration part towards the UE.
4/5.	The MN triggers the UE to apply the new configuration. The MN indicates the new configuration to the UE in the RRCConnectionReconfiguration message including the NR RRC configuration message generated by the target SN. The UE applies the new configuration and sends the RRCConnectionReconfigurationComplete message, including the encoded NR RRC response message for the target SN, if needed. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
6.	If the allocation of target SN resources was successful, the MN confirms the release of the source SN resources. If data forwarding is needed the MN provides data forwarding addresses to the source SN. If direct data forwarding is used for SN terminated bearers, the MN provides data forwarding addresses as received from the target SN to source SN. Reception of the SgNB Change Confirm message triggers the source SN to stop providing user data to the UE and, if applicable, to start data forwarding.
7.	If the RRC connection reconfiguration procedure was successful, the MN informs the target SN via SgNB Reconfiguration Complete message with the encoded NR RRC response message for the target SN, if received from the UE.
8.	The UE synchronizes to the target SN.
9.	For SN terminated bearers using RLC AM, the source SN sends the SN Status Transfer message, which the MN sends then to the target SN, if needed.
10.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the SgNB Change Confirm message from the MN.
11.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE over the NR radio for the related E-RABs.
NOTE 4:	The order the source SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN/target SN is not defined. The SgNB may send the report when the transmission of the related bearer is stopped.
12-16.	If applicable, a path update is triggered by the MN.
17.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.
MN initiated conditional SN Change
The MN initiated conditional inter-SN change procedure is used for inter-SN CPC configuration and inter-SN CPC execution.
Figure 10.5.1-3: Conditional SN Change – MN initiated
Figure 10.5.1-3 shows an example signalling flow for the MN initiated Conditional Secondary Node Change:
1/2.	The MN initiates the conditional SN change by requesting the candidate SN(s) to allocate resources for the UE by means of the SgNB Addition procedure, indicating that the request is for CPAC. The MN also provides the candidate cells recommended by MN via the latest measurement results for the candidate SN(s) to choose and configure the SCG cell(s), and provides the upper limit for the number of PSCells that can be prepared by the candidate SN. From the measurement results indicated by the MN, the candidate SN decides the list of PSCell(s) to prepare (considering the maximum number indicated by the MN) and, for each prepared PSCell, the candidate SN decides other SCG SCells and provides the new corresponding SCG radio resource configuration to the MN in an NR RRCReconfiguration** message contained in the SgNB Addition Request Acknowledge message with the prepared PSCell ID(s). If forwarding is needed, the candidate SN provides forwarding addresses to the MN. The candidate SN includes the indication of the full or delta RRC configuration. The candidate SN can either accept or reject each of the candidate cells listed within the measurement results indicated by the MN, i.e. it cannot configure any alternative candidates.
NOTE 5:	The MN may trigger the MN-initiated SN Modification procedure (to the source SN) to retrieve the current SCG configuration before step 1.
NOTE 5a:	In case the candidate SN includes the indication of the full RRC configuration, the MN performs release of the SN terminated radio bearer configuration and release and add of the NR SCG configuration part towards the UE in the conditional configuration.
3.	The MN sends to the UE an RRCConnectionReconfiguration message including the CPC configuration, i.e. a list of RRCConnectionReconfiguration* messages and associated execution conditions, in which each RRCConnectionReconfiguration* message contains the SCG configuration in the RRCReconfiguration** message received from the candidate SN in step 2 and possibly an MCG configuration. Besides, the RRCConnectionReconfiguration message can also include an updated MCG configuration, e.g., to configure the required conditional measurements.
4.	The UE applies the RRCConnectionReconfiguration message received in step 3, stores the CPC configuration and replies to the MN with an RRCConnectionReconfigurationComplete message. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
4a.	Upon receiving the RRCConnectionReconfigurationComplete message from the UE, the MN triggers the Data Forwarding Address Indication procedure to the source SN to inform that the CPC has been configured, the source SN, if applicable, together with the Early Status Transfer procedure, starts early data forwarding. The PDCP SDU forwarding may take place during early data forwarding.
NOTE 5b:	Separate Data Forwarding Address Indication procedures may be invoked to provide different forwarding addresses of the prepared candidate target SNs. In this case, it is up to the MN and the source SN implementations to make sure that the EARLY STATUS TRANSFER message(s) from the source SN, if any, is forwarded to the right target destination. The Data Forwarding Address Indication procedure may further be invoked to indicate to the source SN to stop already initiated early data forwarding for some SN-terminated bearers if they are no longer subject to data forwarding due to the modification or cancellation of the prepared conditional SN change procedures.
NOTE 5c:	For the early transmission of MN terminated split/SCG bearers, the MN forwards the PDCP PDU to the candidate SN(s).
5.	The UE starts evaluating the execution conditions. If the execution condition of one candidate PSCell is satisfied, the UE applies RRCConnectionReconfiguration* message corresponding to the selected candidate PSCell, and sends an RRCConnectionReconfigurationComplete* message, including an NR RRCReconfigurationComplete** message for the selected candidate PSCell, and information enabling the MN to identify the SN of the selected candidate PSCell.
6a-6b.	The MN triggers the MeNB initiated SgNB Release procedure to inform the source SN to stop providing user data to the UE, and, if applicable, the address of the SN of the selected candidate PSCell to start data forwarding.
7a-7c.	If the RRC connection reconfiguration procedure was successful, the MN informs the SN of the selected candidate PSCell via SgNB Reconfiguration Complete message, including the SN RRCReconfigurationComplete** message. The MN sends the SgNB Release Request message(s) to cancel CPC in the other candidate SN(s), if configured. The other candidate SN(s) acknowledges the release request.
8.	The UE synchronizes to the PSCell indicated in the RRCConnectionReconfiguration* message applied in step 5.
9a-9b.	For SN terminated bearers using RLC AM, the source SN sends the SN Status Transfer message, which the MN sends to the SN of the selected candidate PSCell, if needed.
10.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the early data forwarding address in step 4a.
11.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE over the NR radio for the related E-RABs.
NOTE 6:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN is not defined. The SN may send the report when the transmission of the related bearer is stopped.
12-16.	If applicable, a path update is triggered by the MN.
17.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.
SN initiated conditional SN Change
The SN initiated conditional SN change procedure is used for inter-SN CPC configuration and inter-SN CPC execution.
The SN initiated conditional SN change procedure may also be initiated by the source SN, to modify the existing SN initiated inter-SN CPC configuration, or to trigger the release of the candidate SN by cancellation of all the prepared PSCells at the candidate SN and releasing the CPC related UE context at the candidate SN.
NOTE 6a0:	To modify or release an existing intra-SN CPC configuration, the source SN triggers an SN initiated Conditional SN Modification (with or without SRB3) without MN involvement, as specified in 10.3.
Figure 10.5.1-4: Conditional SN Change – SN initiated
Figure 10.5.1-4 shows an example signalling flow for the Conditional Secondary Node Change initiated by the SN:
1.	The source SN initiates the conditional SN change procedure by sending SgNB Change Required message which contains a CPC initiation indication. The message also contains candidate SN ID(s) information and may include the SCG configuration (to support delta configuration), and contains the measurement results related to the candidate SN(s). The message also includes a list of proposed PSCell candidates recommended by the source SN, including execution conditions, the upper limit for the number of PSCells that can be prepared by each candidate SN, and may also include the SCG measurement configurations for CPC (e.g. measurement ID(s) to be used for CPC).
2/3.	The MN requests each candidate SN to allocate resources for the UE by means of the SgNB Addition procedure(s) , indicating the request is for CPAC, and the measurements results related to the candidate SN and indicating a list of proposed PSCell candidates received from the source SN, but not including execution conditions. Within the list of PSCells suggested by the source SN, the candidate SN decides the list of PSCell(s) to prepare (considering the maximum number indicated by the MN) and, for each prepared PSCell, the candidate SN decides SCG SCells and provides the new corresponding SCG radio resource configuration to the MN in an NR RRCReconfiguration** message contained in the SgNB Addition Request Acknowledge message. If data forwarding is needed, the candidate SN provides data forwarding addresses to the MN. The candidate SN includes the indication of full or delta RRC configuration, and the list of prepared PSCell IDs to the MN. The candidate SN can either accept or reject each of the candidate cells suggested by the source SN, i.e. it cannot configure any alternative candidates.
NOTE 6a:	In case the candidate SN includes the indication of the full RRC configuration, the MN performs release of the SN terminated radio bearer configuration and release and add of the NR SCG configuration part towards the UE in the conditional configuration.
4/5.	The MN may indicate the candidate PSCells accepted by each candidate SN to the source SN via SgNB Modification Request message before it configures the UE e.g., when not all candidate PSCells were accepted by the candidate SN(s). If the MN does not send such indication, step 4 and 5 are skipped. If requested,the source SN sends an SgNB Modification Request Acknowledge message and if needed, provides an updated measurement configurations and/or the execution conditions for CPC to the MN.
6.	The MN sends to the UE an RRCConnectionReconfiguration message including the CPC configuration, i.e. a list of RRCConnectionReconfiguration* messages and associated execution conditions, in which each RRCConnectionReconfiguration* message contains the SCG configuration in the RRCReconfiguration** message received from the candidate SN in step 3 and possibly an MCG configuration. Besides, the RRCConnectionReconfiguration message can also include an updated MCG configuration, as well as the NR RRCReconfiguration*** message generated by the source SN, e.g., to configure the required conditional measurements.
7.	The UE applies the RRCConnectionReconfiguration message received in step 6, stores the CPC configuration and replies to the MN with an RRCConnectionReconfigurationComplete message, which can include an NR RRCReconfigurationComplete*** message. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
8.	If an NR RRC response message is included, the MN informs the source SN with the NR RRCReconfigurationComplete*** message via SgNB Change Confirm message. If step 4 and 5 are skipped, the MN will indicate the candidate PSCells accepted by each candidate SN to the source SN in the SgNB Change Confirm message.
The MN sends the SgNB Change Confirm message towards the source SN to indicate that CPC is prepared, and in such case the source SN continues providing user data to the UE. If early data forwarding is applied, the MN informs the source SN the data forwarding addresses as received from the candidate SN(s), the source SN, if applicable, together with the Early Status Transfer procedure, starts early data forwarding. The PDCP SDU forwarding may take place during early data forwarding. In case multiple candidate SNs are prepared, the MN includes a list of Target SgNB ID and list of data forwarding addresses to the source SN.
NOTE 6b:	The Data Forwarding Address Indication procedure may further be invoked to indicate to the source SN to stop already initiated early data forwarding for some PDCP SDUs if they are no longer subject to data forwarding due to the modification or cancellation of the prepared conditional PSCell change.
NOTE 6c:	For the early transmission of MN terminated split/SCG bearers, the MN forwards the PDCP PDU to the candidate SN(s).
9a-9d.	The source SN may send the SgNB Modification Required message to trigger an update of CPC execution condition and/or corresponding SCG measurement configuration for CPC. In such case in step 9b, the MN reconfigures the UE and in step 9c the UE responds with RRCConnectionReconfigurationComplete, similarly as in steps 6 and 7.
10.	The UE starts evaluating the execution conditions. If the execution condition of one candidate PSCell is satisfied, the UE applies the RRCConnectionReconfiguration* message corresponding to the selected candidate PSCell, and sends an RRCConnectionReconfigurationComplete* message, including the NR RRCReconfigurationComplete** message for the selected candidate PSCell, and information enabling the MN to identify the SN of the selected candidate PSCell.
11a-11b.	The MN triggers the MeNB initiated SgNB Release procedure to inform source SN to stop providing user data to the UE, and provide the address of the SN of the selected candidate PSCell and if applicable, start late data forwarding.
12a-12c.	If the RRC connection reconfiguration procedure was successful, the MN informs the SN of the selected candidate PSCell via SgNB Reconfiguration Complete message, including the SN RRCReconfigurationComplete** message. The MN sends the SgNB Release Request message(s) to cancel CPC in the other candidate SN(s), if configured. The other candidate SN(s) acknowledges the release request.
13.	The UE synchronizes to the PSCell indicated in the RRCConnectionReconfiguration* message applied in step 10.
14a-14b.	For SN terminated bearers using RLC AM, the source SN sends the SN Status Transfer message, which the MN sends then to the SN of the selected candidate PSCell, if needed.
15.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the early data forwarding message from the MN.
16.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE over the NR radio for the related E-RABs.
NOTE 7:	The order the source SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN/target SN is not defined. The SgNB may send the report when the transmission of the related bearer is stopped.
17-21.	If applicable, a path update is triggered by the MN.
22.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.",TS 37.340,10.5.1,all_images/image_570.jpeg,Conditional SN Change – MN initiated
"The Secondary Node Change procedure is initiated either by MN or SN and used to transfer a UE context from a source SN to a target SN and to change the SCG configuration in UE from one SN to another. In case of inter-SN CPC, the Conditional Secondary Node Change procedure initiated either by the MN or SN is also used for inter-SN CPC configuration and inter-SN CPC execution.
NOTE 1:	Inter-RAT SN change procedure with single RRC reconfiguration is not supported in this version of the protocol (i.e. no transition from EN-DC to DC).
The Secondary Node Change procedure always involves signalling over MCG SRB towards the UE.
MN initiated SN Change
Figure 10.5.1-1: SN Change – MN initiated
Figure 10.5.1-1 shows an example signalling flow for the MN initiated Secondary Node Change:
1/2.	The MN initiates the SN change by requesting the target SN to allocate resources for the UE by means of the SgNB Addition procedure. The MN may include measurement results related to the target SN. If forwarding is needed, the target SN provides forwarding addresses to the MN. The target SN includes the indication of the full or delta RRC configuration.
NOTE 2:	The MN may trigger the MN-initiated SN Modification procedure (to the source SN) to retrieve the current SCG configuration before step 1.
NOTE 2a:	In case the target SN includes the indication of the full RRC configuration, the MN performs release of the SN terminated radio bearer configuration and release and add of the NR SCG configuration part towards the UE.
3.	If the allocation of target SN resources was successful, the MN initiates the release of the source SN resources including a Cause indicating SCG mobility. The Source SN may reject the release. If data forwarding is needed the MN provides data forwarding addresses to the source SN. If direct data forwarding is used for SN terminated bearers, the MN provides data forwarding addresses as received from the target SN to source SN. Reception of the SgNB Release Request message triggers the source SN to stop providing user data to the UE and, if applicable, to start data forwarding.
4/5.	The MN triggers the UE to apply the new configuration. The MN indicates to the UE the new configuration in the RRCConnectionReconfiguration message including the NR RRC configuration message generated by the target SN. The UE applies the new configuration and sends the RRCConnectionReconfigurationComplete message, including the encoded NR RRC response message for the target SN, if needed. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
6.	If the RRC connection reconfiguration procedure was successful, the MN informs the target SN via SgNBReconfigurationComplete message with the encoded NR RRC response message for the target SN, if received from the UE.
7.	If configured with bearers requiring SCG radio resources, the UE synchronizes to the target SN.
8.	For SN terminated bearers using RLC AM, the source SN sends the SN Status Transfer message, which the MN sends then to the target SN, if needed.
9.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the SgNB Release Request message from the MN.
10.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE over the NR radio for the related E-RABs.
NOTE 3:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN is not defined. The SN may send the report when the transmission of the related bearer is stopped.
11-15.	If applicable, a path update is triggered by the MN.
16.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.
SN initiated SN Change
Figure 10.5.1-2: SN Change – SN initiated
Figure 10.5.1-2 shows an example signalling flow for the Secondary Node Change initiated by the SN:
1.	The source SN initiates the SN change procedure by sending SgNB Change Required message which contains target SN ID information and may include the SCG configuration (to support delta configuration) and measurement results related to the target SN.
2/3.	The MN requests the target SN to allocate resources for the UE by means of the SgNB Addition procedure, including the measurement results related to the target SN received from the source SN. If forwarding is needed, the target SN provides forwarding addresses to the MN. The target SN includes the indication of the full or delta RRC configuration.
NOTE 3a:	In case the target SN includes the indication of the full RRC configuration, the MN performs release of the SN terminated radio bearer configuration and release and add of the NR SCG configuration part towards the UE.
4/5.	The MN triggers the UE to apply the new configuration. The MN indicates the new configuration to the UE in the RRCConnectionReconfiguration message including the NR RRC configuration message generated by the target SN. The UE applies the new configuration and sends the RRCConnectionReconfigurationComplete message, including the encoded NR RRC response message for the target SN, if needed. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
6.	If the allocation of target SN resources was successful, the MN confirms the release of the source SN resources. If data forwarding is needed the MN provides data forwarding addresses to the source SN. If direct data forwarding is used for SN terminated bearers, the MN provides data forwarding addresses as received from the target SN to source SN. Reception of the SgNB Change Confirm message triggers the source SN to stop providing user data to the UE and, if applicable, to start data forwarding.
7.	If the RRC connection reconfiguration procedure was successful, the MN informs the target SN via SgNB Reconfiguration Complete message with the encoded NR RRC response message for the target SN, if received from the UE.
8.	The UE synchronizes to the target SN.
9.	For SN terminated bearers using RLC AM, the source SN sends the SN Status Transfer message, which the MN sends then to the target SN, if needed.
10.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the SgNB Change Confirm message from the MN.
11.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE over the NR radio for the related E-RABs.
NOTE 4:	The order the source SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN/target SN is not defined. The SgNB may send the report when the transmission of the related bearer is stopped.
12-16.	If applicable, a path update is triggered by the MN.
17.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.
MN initiated conditional SN Change
The MN initiated conditional inter-SN change procedure is used for inter-SN CPC configuration and inter-SN CPC execution.
Figure 10.5.1-3: Conditional SN Change – MN initiated
Figure 10.5.1-3 shows an example signalling flow for the MN initiated Conditional Secondary Node Change:
1/2.	The MN initiates the conditional SN change by requesting the candidate SN(s) to allocate resources for the UE by means of the SgNB Addition procedure, indicating that the request is for CPAC. The MN also provides the candidate cells recommended by MN via the latest measurement results for the candidate SN(s) to choose and configure the SCG cell(s), and provides the upper limit for the number of PSCells that can be prepared by the candidate SN. From the measurement results indicated by the MN, the candidate SN decides the list of PSCell(s) to prepare (considering the maximum number indicated by the MN) and, for each prepared PSCell, the candidate SN decides other SCG SCells and provides the new corresponding SCG radio resource configuration to the MN in an NR RRCReconfiguration** message contained in the SgNB Addition Request Acknowledge message with the prepared PSCell ID(s). If forwarding is needed, the candidate SN provides forwarding addresses to the MN. The candidate SN includes the indication of the full or delta RRC configuration. The candidate SN can either accept or reject each of the candidate cells listed within the measurement results indicated by the MN, i.e. it cannot configure any alternative candidates.
NOTE 5:	The MN may trigger the MN-initiated SN Modification procedure (to the source SN) to retrieve the current SCG configuration before step 1.
NOTE 5a:	In case the candidate SN includes the indication of the full RRC configuration, the MN performs release of the SN terminated radio bearer configuration and release and add of the NR SCG configuration part towards the UE in the conditional configuration.
3.	The MN sends to the UE an RRCConnectionReconfiguration message including the CPC configuration, i.e. a list of RRCConnectionReconfiguration* messages and associated execution conditions, in which each RRCConnectionReconfiguration* message contains the SCG configuration in the RRCReconfiguration** message received from the candidate SN in step 2 and possibly an MCG configuration. Besides, the RRCConnectionReconfiguration message can also include an updated MCG configuration, e.g., to configure the required conditional measurements.
4.	The UE applies the RRCConnectionReconfiguration message received in step 3, stores the CPC configuration and replies to the MN with an RRCConnectionReconfigurationComplete message. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
4a.	Upon receiving the RRCConnectionReconfigurationComplete message from the UE, the MN triggers the Data Forwarding Address Indication procedure to the source SN to inform that the CPC has been configured, the source SN, if applicable, together with the Early Status Transfer procedure, starts early data forwarding. The PDCP SDU forwarding may take place during early data forwarding.
NOTE 5b:	Separate Data Forwarding Address Indication procedures may be invoked to provide different forwarding addresses of the prepared candidate target SNs. In this case, it is up to the MN and the source SN implementations to make sure that the EARLY STATUS TRANSFER message(s) from the source SN, if any, is forwarded to the right target destination. The Data Forwarding Address Indication procedure may further be invoked to indicate to the source SN to stop already initiated early data forwarding for some SN-terminated bearers if they are no longer subject to data forwarding due to the modification or cancellation of the prepared conditional SN change procedures.
NOTE 5c:	For the early transmission of MN terminated split/SCG bearers, the MN forwards the PDCP PDU to the candidate SN(s).
5.	The UE starts evaluating the execution conditions. If the execution condition of one candidate PSCell is satisfied, the UE applies RRCConnectionReconfiguration* message corresponding to the selected candidate PSCell, and sends an RRCConnectionReconfigurationComplete* message, including an NR RRCReconfigurationComplete** message for the selected candidate PSCell, and information enabling the MN to identify the SN of the selected candidate PSCell.
6a-6b.	The MN triggers the MeNB initiated SgNB Release procedure to inform the source SN to stop providing user data to the UE, and, if applicable, the address of the SN of the selected candidate PSCell to start data forwarding.
7a-7c.	If the RRC connection reconfiguration procedure was successful, the MN informs the SN of the selected candidate PSCell via SgNB Reconfiguration Complete message, including the SN RRCReconfigurationComplete** message. The MN sends the SgNB Release Request message(s) to cancel CPC in the other candidate SN(s), if configured. The other candidate SN(s) acknowledges the release request.
8.	The UE synchronizes to the PSCell indicated in the RRCConnectionReconfiguration* message applied in step 5.
9a-9b.	For SN terminated bearers using RLC AM, the source SN sends the SN Status Transfer message, which the MN sends to the SN of the selected candidate PSCell, if needed.
10.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the early data forwarding address in step 4a.
11.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE over the NR radio for the related E-RABs.
NOTE 6:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN is not defined. The SN may send the report when the transmission of the related bearer is stopped.
12-16.	If applicable, a path update is triggered by the MN.
17.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.
SN initiated conditional SN Change
The SN initiated conditional SN change procedure is used for inter-SN CPC configuration and inter-SN CPC execution.
The SN initiated conditional SN change procedure may also be initiated by the source SN, to modify the existing SN initiated inter-SN CPC configuration, or to trigger the release of the candidate SN by cancellation of all the prepared PSCells at the candidate SN and releasing the CPC related UE context at the candidate SN.
NOTE 6a0:	To modify or release an existing intra-SN CPC configuration, the source SN triggers an SN initiated Conditional SN Modification (with or without SRB3) without MN involvement, as specified in 10.3.
Figure 10.5.1-4: Conditional SN Change – SN initiated
Figure 10.5.1-4 shows an example signalling flow for the Conditional Secondary Node Change initiated by the SN:
1.	The source SN initiates the conditional SN change procedure by sending SgNB Change Required message which contains a CPC initiation indication. The message also contains candidate SN ID(s) information and may include the SCG configuration (to support delta configuration), and contains the measurement results related to the candidate SN(s). The message also includes a list of proposed PSCell candidates recommended by the source SN, including execution conditions, the upper limit for the number of PSCells that can be prepared by each candidate SN, and may also include the SCG measurement configurations for CPC (e.g. measurement ID(s) to be used for CPC).
2/3.	The MN requests each candidate SN to allocate resources for the UE by means of the SgNB Addition procedure(s) , indicating the request is for CPAC, and the measurements results related to the candidate SN and indicating a list of proposed PSCell candidates received from the source SN, but not including execution conditions. Within the list of PSCells suggested by the source SN, the candidate SN decides the list of PSCell(s) to prepare (considering the maximum number indicated by the MN) and, for each prepared PSCell, the candidate SN decides SCG SCells and provides the new corresponding SCG radio resource configuration to the MN in an NR RRCReconfiguration** message contained in the SgNB Addition Request Acknowledge message. If data forwarding is needed, the candidate SN provides data forwarding addresses to the MN. The candidate SN includes the indication of full or delta RRC configuration, and the list of prepared PSCell IDs to the MN. The candidate SN can either accept or reject each of the candidate cells suggested by the source SN, i.e. it cannot configure any alternative candidates.
NOTE 6a:	In case the candidate SN includes the indication of the full RRC configuration, the MN performs release of the SN terminated radio bearer configuration and release and add of the NR SCG configuration part towards the UE in the conditional configuration.
4/5.	The MN may indicate the candidate PSCells accepted by each candidate SN to the source SN via SgNB Modification Request message before it configures the UE e.g., when not all candidate PSCells were accepted by the candidate SN(s). If the MN does not send such indication, step 4 and 5 are skipped. If requested,the source SN sends an SgNB Modification Request Acknowledge message and if needed, provides an updated measurement configurations and/or the execution conditions for CPC to the MN.
6.	The MN sends to the UE an RRCConnectionReconfiguration message including the CPC configuration, i.e. a list of RRCConnectionReconfiguration* messages and associated execution conditions, in which each RRCConnectionReconfiguration* message contains the SCG configuration in the RRCReconfiguration** message received from the candidate SN in step 3 and possibly an MCG configuration. Besides, the RRCConnectionReconfiguration message can also include an updated MCG configuration, as well as the NR RRCReconfiguration*** message generated by the source SN, e.g., to configure the required conditional measurements.
7.	The UE applies the RRCConnectionReconfiguration message received in step 6, stores the CPC configuration and replies to the MN with an RRCConnectionReconfigurationComplete message, which can include an NR RRCReconfigurationComplete*** message. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
8.	If an NR RRC response message is included, the MN informs the source SN with the NR RRCReconfigurationComplete*** message via SgNB Change Confirm message. If step 4 and 5 are skipped, the MN will indicate the candidate PSCells accepted by each candidate SN to the source SN in the SgNB Change Confirm message.
The MN sends the SgNB Change Confirm message towards the source SN to indicate that CPC is prepared, and in such case the source SN continues providing user data to the UE. If early data forwarding is applied, the MN informs the source SN the data forwarding addresses as received from the candidate SN(s), the source SN, if applicable, together with the Early Status Transfer procedure, starts early data forwarding. The PDCP SDU forwarding may take place during early data forwarding. In case multiple candidate SNs are prepared, the MN includes a list of Target SgNB ID and list of data forwarding addresses to the source SN.
NOTE 6b:	The Data Forwarding Address Indication procedure may further be invoked to indicate to the source SN to stop already initiated early data forwarding for some PDCP SDUs if they are no longer subject to data forwarding due to the modification or cancellation of the prepared conditional PSCell change.
NOTE 6c:	For the early transmission of MN terminated split/SCG bearers, the MN forwards the PDCP PDU to the candidate SN(s).
9a-9d.	The source SN may send the SgNB Modification Required message to trigger an update of CPC execution condition and/or corresponding SCG measurement configuration for CPC. In such case in step 9b, the MN reconfigures the UE and in step 9c the UE responds with RRCConnectionReconfigurationComplete, similarly as in steps 6 and 7.
10.	The UE starts evaluating the execution conditions. If the execution condition of one candidate PSCell is satisfied, the UE applies the RRCConnectionReconfiguration* message corresponding to the selected candidate PSCell, and sends an RRCConnectionReconfigurationComplete* message, including the NR RRCReconfigurationComplete** message for the selected candidate PSCell, and information enabling the MN to identify the SN of the selected candidate PSCell.
11a-11b.	The MN triggers the MeNB initiated SgNB Release procedure to inform source SN to stop providing user data to the UE, and provide the address of the SN of the selected candidate PSCell and if applicable, start late data forwarding.
12a-12c.	If the RRC connection reconfiguration procedure was successful, the MN informs the SN of the selected candidate PSCell via SgNB Reconfiguration Complete message, including the SN RRCReconfigurationComplete** message. The MN sends the SgNB Release Request message(s) to cancel CPC in the other candidate SN(s), if configured. The other candidate SN(s) acknowledges the release request.
13.	The UE synchronizes to the PSCell indicated in the RRCConnectionReconfiguration* message applied in step 10.
14a-14b.	For SN terminated bearers using RLC AM, the source SN sends the SN Status Transfer message, which the MN sends then to the SN of the selected candidate PSCell, if needed.
15.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the early data forwarding message from the MN.
16.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE over the NR radio for the related E-RABs.
NOTE 7:	The order the source SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN/target SN is not defined. The SgNB may send the report when the transmission of the related bearer is stopped.
17-21.	If applicable, a path update is triggered by the MN.
22.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.",TS 37.340,10.5.1,all_images/image_571.jpeg,Conditional SN Change – SN initiated
"MN initiated SN Change
The MN initiated SN change procedure is used to transfer a UE context from the source SN to a target SN and to change the SCG configuration in UE from one SN to another.
The Secondary Node Change procedure always involves signalling over MCG SRB towards the UE.
Figure 10.5.2-1: SN change procedure - MN initiated
Figure 10.5.2-1 shows an example signalling flow for the SN Change initiated by the MN:
1/2.	The MN initiates the SN change by requesting the target SN to allocate resources for the UE by means of the SN Addition procedure. The MN may include measurement results related to the target SN. If data forwarding is needed, the target SN provides data forwarding addresses to the MN. The target SN includes the indication of the full or delta RRC configuration.
NOTE 1:	The MN may trigger the MN-initiated SN Modification procedure (to the source SN) to retrieve the current SCG configuration and to allow provision of data forwarding related information before step 1.
2a.	For SN terminated bearers using MCG resources, the MN provides Xn-U DL TNL address information in the Xn-U Address Indication message.
3.	If the allocation of target SN resources was successful, the MN initiates the release of the source SN resources including a Cause indicating SCG mobility. The Source SN may reject the release. If data forwarding is needed the MN provides data forwarding addresses to the source SN. If direct data forwarding is used for SN terminated bearers, the MN provides data forwarding addresses as received from the target SN to source SN. Reception of the SN Release Request message triggers the source SN to stop providing user data to the UE.
4/5.	The MN triggers the UE to apply the new configuration. The MN indicates the new configuration to the UE in the MN RRC reconfiguration message including the target SN RRC reconfiguration message. The UE applies the new configuration and sends the MN RRC reconfiguration complete message, including the SN RRC response message for the target SN, if needed. In case the UE is unable to comply with (part of) the configuration included in the MN RRC reconfiguration message, it performs the reconfiguration failure procedure.
6.	If the RRC connection reconfiguration procedure was successful, the MN informs the target SN via SN Reconfiguration Complete message with the included SN RRC response message for the target SN, if received from the UE.
7.	If configured with bearers requiring SCG radio resources the UE synchronizes to the target SN.
8.	If PDCP termination point is changed for bearers using RLC AM, the source SN sends the SN Status Transfer message, which the MN sends then to the target SN, if needed.
9.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the SN Release Request message from the MN.
10.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE as described in clause 10.11.2.
NOTE 2:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN is not defined. The SN may send the report when the transmission of the related QoS flow is stopped.
11-15.	If applicable, a PDU Session path update procedure is triggered by the MN.
16.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue
SN initiated SN Change
The SN initiated SN change procedure is used to transfer a UE context from the source SN to a target SN and to change the SCG configuration in UE from one SN to another.
Figure 10.5.2-2: SN change procedure - SN initiated
Figure 10.5.2-2 shows an example signalling flow for the SN Change initiated by the SN:
1.	The source SN initiates the SN change procedure by sending the SN Change Required message, which contains a candidate target node ID and may include the SCG configuration (to support delta configuration) and measurement results related to the target SN.
2/3.	The MN requests the target SN to allocate resources for the UE by means of the SN Addition procedure, including the measurement results related to the target SN received from the source SN. If data forwarding is needed, the target SN provides data forwarding addresses to the MN. The target SN includes the indication of the full or delta RRC configuration.
3a.	For SN terminated bearers using MCG resources, the MN provides Xn-U DL TNL address information in the Xn-U Address Indication message.
4/5.	The MN triggers the UE to apply the new configuration. The MN indicates the new configuration to the UE in the MN RRC reconfiguration message including the SN RRC reconfiguration message generated by the target SN. The UE applies the new configuration and sends the MN RRC reconfiguration complete message, including the SN RRC response message for the target SN, if needed. In case the UE is unable to comply with (part of) the configuration included in the MN RRC reconfiguration message, it performs the reconfiguration failure procedure.
6.	If the allocation of target SN resources was successful, the MN confirms the change of the source SN. If data forwarding is needed the MN provides data forwarding addresses to the source SN. If direct data forwarding is used for SN terminated bearers, the MN provides data forwarding addresses as received from the target SN to source SN. Reception of the SN Change Confirm message triggers the source SN to stop providing user data to the UE and, if applicable, to start data forwarding.
7.	If the RRC connection reconfiguration procedure was successful, the MN informs the target SN via SN Reconfiguration Complete message with the included SN RRC response message for the target SN, if received from the UE.
8.	The UE synchronizes to the target SN.
9.	If PDCP termination point is changed for bearers using RLC AM, the source SN sends the SN Status Transfer message, which the MN sends then to the target SN, if needed.
10.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the SN Change Confirm message from the MN.
11.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE as described in clause 10.11.2.
NOTE 3:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN/target SN is not defined. The SN may send the report when the transmission of the related QoS flow is stopped.
12-16.	If applicable, a PDU Session path update procedure is triggered by the MN.
17.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.
MN initiated conditional SN Change
The Conditional Secondary Node Change procedure is initiated by the MN for inter-SN CPC configuration and inter-SN CPC execution.
Figure 10.5.2-3: Conditional SN change procedure - MN initiated
Figure 10.5.2-3 shows an example signalling flow for the conditional SN Change initiated by the MN:
1/2.	The MN initiates the conditional SN change by requesting the candidate SN(s) to allocate resources for the UE by means of the SN Addition procedure, indicating that the request is for CPAC. The MN also provides the candidate cells recommended by MN via the latest measurement results for the candidate SN(s) to choose and configure the SCG cell(s), provides the upper limit for the number of PSCells that can be prepared by the candidate SN. Within the list of cells as indicated within the measurement results indicated by the MN, the candidate SN decides the list of PSCell(s) to prepare (considering the maximum number indicated by the MN) and, for each prepared PSCell, the candidate SN decides other SCG SCells and provides the new corresponding SCG radio resource configuration to the MN in an NR RRCReconfiguration** message contained in the SN Addition Request Acknowledge message with the prepared PSCell ID(s). If data forwarding is needed, the candidate SN provides data forwarding addresses to the MN. The candidate SN includes the indication of the full or delta RRC configuration. The candidate SN can either accept or reject each of the candidate cells listed within the measurement results indicated by the MN, i.e. it cannot configure any alternative candidates.
NOTE 4:	The MN may trigger the MN-initiated SN Modification procedure (to the source SN) to retrieve the current SCG configuration and to allow provision of data forwarding related information before step 1.
2a.	For SN terminated bearers using MCG resources, the MN provides Xn-U DL TNL address information in the Xn-U Address Indication message to the candidate SN(s).
3.	The MN sends to the UE an RRCReconfiguration message including the CPC configuration, i.e. a list of RRCReconfiguration* messages and associated execution conditions, in which each RRCReconfiguration* message contains the SCG configuration in the RRCReconfiguration** message received from the candidate SN in step 2 and possibly an MCG configuration. Besides, the RRCReconfiguration message can also include an updated MCG configuration, e.g., to configure the required conditional measurements.
4.	The UE applies the RRCReconfiguration message received in step 3, stores the CPC configuration and replies to the MN with an RRCReconfigurationComplete message. In case the UE is unable to comply with (part of) the configuration included in the RRCReconfiguration message, it performs the reconfiguration failure procedure.
4a.	Upon receiving the MN RRCReconfigurationComplete message from the UE, the MN informs the source SN that the CPC has been configured via Xn-U Address Indication procedure, the source SN, if applicable, together with the Early Status Transfer procedure, starts early data forwarding. The PDCP SDU forwarding may take place during early data forwarding.
NOTE 4a:	Separate Xn-U Address Indication procedures may be invoked to provide different forwarding addresses of the prepared candidate target SNs. In this case, it is up to the MN and the source SN implementations to make sure that the EARLY STATUS TRANSFER message(s) from the source SN, if any, is forwarded to the right target destination. The Xn-U Address Indication procedure may further be invoked to indicate to the source SN to stop already initiated early data forwarding for some SN-terminated bearers if they are no longer subject to data forwarding due to the modification or cancellation of the prepared conditional SN change procedures.
NOTE 4b:	For the early transmission of MN terminated split/SCG bearers, the MN forwads the PDCP PDU to the candidate SN(s).
5.	The UE starts evaluating the execution conditions. If the execution condition of one candidate PSCell is satisfied, the UE applies RRCReconfiguration* message corresponding to the selected candidate PSCell, and sends an MN RRCReconfigurationComplete* message, including an NR RRCReconfigurationComplete** message for the selected candidate PSCell, and information enabling the MN to identify the SN of the selected candidate PSCell.
6a-6c.	The MN triggers the MN initiated SN Release procedure to inform the source SN to stop providing user data to the UE, and if applicable, triggers the Xn-U Address Indication procedure to inform the source SN the address of the SN of the selected candidate PSCell, to start late data forwarding.
7a-7c.	If the RRC connection reconfiguration procedure was successful, the MN informs the SN of the selected candidate PSCell via SN Reconfiguration Complete message, including the SN RRCReconfigurationComplete** message. The MN sends the SN Release Request message(s) to cancel CPC in the other candidate SN(s), if configured. The other candidate SN(s) acknowledges the release request.
8.	The UE synchronizes to the PSCell indicated in the RRCReconfiguration* message applied in step 5.
9a-9b.	If PDCP termination point is changed for bearers using RLC AM, the source SN sends the message, which the MN sends then to the SN of the selected candidate PSCell, if needed.
10.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the early data forwarding address in step 4a.
11.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE as described in clause 10.11.2.
NOTE 5:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN is not defined. The SN may send the report when the transmission of the related QoS flow is stopped.
12-16.	If applicable, a PDU Session path update procedure is triggered by the MN.
17.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.
SN initiated conditional SN Change
The SN initiated conditional SN change procedure is used for inter-SN CPC configuration and inter-SN CPC execution.
The SN initiated conditional SN change procedure may also be initiated by the source SN, to modify the existing SN initiated inter-SN CPC configuration, or to trigger the release of the candidate SN by cancellation of all the prepared PSCells at the candidate SN and releasing the CPC related UE context at the candidate SN.
NOTE 5a0:	To modify or release an existing intra-SN CPC configuration, the source SN triggers an SN initiated Conditional SN Modification (with or without SRB3) without MN involvement, as specified in 10.3.
Figure 10.5.2-4: Conditional SN change procedure - SN initiated
Figure 10.5.2-4 shows an example signalling flow for the conditional SN Change initiated by the SN:
1.	The source SN initiates the conditional SN change procedure by sending the SN Change Required message, which contains a CPC initiation indication. The message also contains candidate node ID(s) and may include the SCG configuration (to support delta configuration), and contains the measurements results which may include cells that are not CPC candidates. The message also includes a list of proposed PSCell candidates recommended by the source SN, including execution conditions, the upper limit for the number of PSCells that can be prepared by each candidate SN, and may also include the SCG measurement configurations for CPC (e.g. measurement ID(s) to be used for CPC).
2/3.	The MN requests each candidate SN(s) to allocate resources for the UE by means of the SN Addition procedure(s), indicating the request is for CPAC, and the measurements results which may include cells that are not CPC candidates received from the source SN to the candidate SN, and indicating a list of proposed PSCell candidates received from the source SN, but not including execution conditions. Within the list of PSCells suggested by the source SN, the candidate SN decides the list of PSCell(s) to prepare (considering the maximum number indicated by the MN) and, for each prepared PSCell, the candidate SN decides SCG SCells and provides the new corresponding SCG radio resource configuration to the MN in an NR RRCReconfiguration** message contained in the SgNB Addition Request Acknowledge message. If data forwarding is needed, the candidate SN provides data forwarding addresses to the MN. The candidate SN includes the indication of full or delta RRC configuration, and the list of prepared PSCell IDs to the MN. The candidate SN can either accept or reject each of the candidate cells suggested by the source SN, i.e., it cannot configure any alternative candidates.
3a.	For SN terminated bearers using MCG resources, the MN provides Xn-U DL TNL address information in the Xn-U Address Indication message to the candidate SN(s).
4/5.	The MN may indicate the candidate PSCells accepted by each candidate SN to the source SN via SN Modification Request message before it configures the UE, e.g., when not all candidate PSCells were accepted by the candidate SN(s). If the MN does not send such indication, step 4 and 5 are skipped. If requested, the source SN sends an SN Modification Request Acknowledge message and if needed, provides an updated measurement configurations and/or the execution conditions to the MN.
6.	The MN sends to the UE an RRCReconfiguration message including the CPC configuration, i.e. a list of RRCReconfiguration* messages and associated execution conditions, in which each RRCReconfiguration* message contains the SCG configuration in the RRCReconfiguration** message received from the candidate SN in step 3 and possibly an MCG configuration. Besides, the RRCReconfiguration message can also include an updated MCG configuration, as well as the NR RRCReconfiguration*** message generated by the source SN, e.g., to configure the required conditional measurements.
7.	The UE applies the RRCReconfiguration message received in step 6, stores the CPC configuration and replies to the MN with an RRCReconfigurationComplete message, which can include an NR RRCReconfigurationComplete*** message. In case the UE is unable to comply with (part of) the configuration included in the RRCReconfiguration message, it performs the reconfiguration failure procedure.
8.	If an SN RRC response message is included, the MN informs the source SN with the SN RRCReconfigurationComplete*** message via SN Change Confirm message. If step 4 and 5 are skipped, the MN will indicate the candidate PSCells accepted by each candidate SN to the source SN in the SN Change Confirm message.
The MN sends the SN Change Confirm message towards the source SN to indicate that CPC is prepared, and in such case the source SN continues providing user data to the UE. If early data forwarding is applied, the MN informs the source SN the data forwarding addresses as received from the candidate SN(s), the source SN, if applicable, together with the Early Status Transfer procedure, starts early data forwarding. The PDCP SDU forwarding may take place during early data forwarding. In case multiple candidate SNs are prepared, the MN includes a list of Target SN ID and list of data forwarding addresses to the source SN.
NOTE 5a:	The Xn-U Address Indication procedure may further be invoked to indicate to the source SN to stop already initiated early data forwarding for some PDCP SDUs if they are no longer subject to data forwarding due to the modification or cancellation of the prepared conditional PSCell change.
NOTE 5b:	For the early transmission of MN terminated split/SCG bearers, the MN forwads the PDCP PDU to the candidate SN(s).
9a-9d.	The source SN may send the SN Modification Required message to trigger an update of CPC execution condition and/or corresponding SCG measurement configuration for CPC. In such case in step 9b, the MN reconfigures the UE and in step 9c the UE responds with RRCReconfigurationComplete, similarly as in steps 6 and 7.
10.	The UE starts evaluating the execution conditions. If the execution condition of one candidate PSCell is satisfied, the UE applies RRCReconfiguration* message corresponding to the selected candidate PSCell, and sends an RRCReconfigurationComplete* message, including an RRCReconfigurationComplete** message for the selected candidate PSCell, and information enabling the MN to identify the SN of the selected candidate PSCell.
11a-11c.	The MN triggers the MN initiated SN Release procedure to inform the source SN to stop providing user data to the UE, and triggers the Xn-U Address Indication procedure to inform the source SN the address of the SN of the selected candidate PSCell and if applicable, starts late data forwarding.
12a-12c.	If the RRC connection reconfiguration procedure was successful, the MN informs the SN of the selected candidate PSCell via SN Reconfiguration Complete message, including the SN RRCReconfigurationComplete** message. The MN sends the SN Release Request message(s) to cancel CPC in the other candidate SN(s), if configured. The other candidate SN(s) acknowledges the release request.
13.	The UE synchronizes to the PSCell indicated in the RRCReconfiguration* message applied in step 10.
14.	If PDCP termination point is changed for bearers using RLC AM, the source SN sends the SN Status Transfer message, which the MN sends then to the SN of the selected candidate PSCell, if needed.
15.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the data forwarding address related information from the MN.
16.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE as described in clause 10.11.2.
NOTE 6:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN/target SN is not defined. The SN may send the report when the transmission of the related QoS flow is stopped.
17-21.	If applicable, a PDU Session path update procedure is triggered by the MN.
22.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.",TS 37.340,10.5.2,all_images/image_572.jpeg,SN change procedure - MN initiated
"MN initiated SN Change
The MN initiated SN change procedure is used to transfer a UE context from the source SN to a target SN and to change the SCG configuration in UE from one SN to another.
The Secondary Node Change procedure always involves signalling over MCG SRB towards the UE.
Figure 10.5.2-1: SN change procedure - MN initiated
Figure 10.5.2-1 shows an example signalling flow for the SN Change initiated by the MN:
1/2.	The MN initiates the SN change by requesting the target SN to allocate resources for the UE by means of the SN Addition procedure. The MN may include measurement results related to the target SN. If data forwarding is needed, the target SN provides data forwarding addresses to the MN. The target SN includes the indication of the full or delta RRC configuration.
NOTE 1:	The MN may trigger the MN-initiated SN Modification procedure (to the source SN) to retrieve the current SCG configuration and to allow provision of data forwarding related information before step 1.
2a.	For SN terminated bearers using MCG resources, the MN provides Xn-U DL TNL address information in the Xn-U Address Indication message.
3.	If the allocation of target SN resources was successful, the MN initiates the release of the source SN resources including a Cause indicating SCG mobility. The Source SN may reject the release. If data forwarding is needed the MN provides data forwarding addresses to the source SN. If direct data forwarding is used for SN terminated bearers, the MN provides data forwarding addresses as received from the target SN to source SN. Reception of the SN Release Request message triggers the source SN to stop providing user data to the UE.
4/5.	The MN triggers the UE to apply the new configuration. The MN indicates the new configuration to the UE in the MN RRC reconfiguration message including the target SN RRC reconfiguration message. The UE applies the new configuration and sends the MN RRC reconfiguration complete message, including the SN RRC response message for the target SN, if needed. In case the UE is unable to comply with (part of) the configuration included in the MN RRC reconfiguration message, it performs the reconfiguration failure procedure.
6.	If the RRC connection reconfiguration procedure was successful, the MN informs the target SN via SN Reconfiguration Complete message with the included SN RRC response message for the target SN, if received from the UE.
7.	If configured with bearers requiring SCG radio resources the UE synchronizes to the target SN.
8.	If PDCP termination point is changed for bearers using RLC AM, the source SN sends the SN Status Transfer message, which the MN sends then to the target SN, if needed.
9.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the SN Release Request message from the MN.
10.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE as described in clause 10.11.2.
NOTE 2:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN is not defined. The SN may send the report when the transmission of the related QoS flow is stopped.
11-15.	If applicable, a PDU Session path update procedure is triggered by the MN.
16.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue
SN initiated SN Change
The SN initiated SN change procedure is used to transfer a UE context from the source SN to a target SN and to change the SCG configuration in UE from one SN to another.
Figure 10.5.2-2: SN change procedure - SN initiated
Figure 10.5.2-2 shows an example signalling flow for the SN Change initiated by the SN:
1.	The source SN initiates the SN change procedure by sending the SN Change Required message, which contains a candidate target node ID and may include the SCG configuration (to support delta configuration) and measurement results related to the target SN.
2/3.	The MN requests the target SN to allocate resources for the UE by means of the SN Addition procedure, including the measurement results related to the target SN received from the source SN. If data forwarding is needed, the target SN provides data forwarding addresses to the MN. The target SN includes the indication of the full or delta RRC configuration.
3a.	For SN terminated bearers using MCG resources, the MN provides Xn-U DL TNL address information in the Xn-U Address Indication message.
4/5.	The MN triggers the UE to apply the new configuration. The MN indicates the new configuration to the UE in the MN RRC reconfiguration message including the SN RRC reconfiguration message generated by the target SN. The UE applies the new configuration and sends the MN RRC reconfiguration complete message, including the SN RRC response message for the target SN, if needed. In case the UE is unable to comply with (part of) the configuration included in the MN RRC reconfiguration message, it performs the reconfiguration failure procedure.
6.	If the allocation of target SN resources was successful, the MN confirms the change of the source SN. If data forwarding is needed the MN provides data forwarding addresses to the source SN. If direct data forwarding is used for SN terminated bearers, the MN provides data forwarding addresses as received from the target SN to source SN. Reception of the SN Change Confirm message triggers the source SN to stop providing user data to the UE and, if applicable, to start data forwarding.
7.	If the RRC connection reconfiguration procedure was successful, the MN informs the target SN via SN Reconfiguration Complete message with the included SN RRC response message for the target SN, if received from the UE.
8.	The UE synchronizes to the target SN.
9.	If PDCP termination point is changed for bearers using RLC AM, the source SN sends the SN Status Transfer message, which the MN sends then to the target SN, if needed.
10.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the SN Change Confirm message from the MN.
11.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE as described in clause 10.11.2.
NOTE 3:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN/target SN is not defined. The SN may send the report when the transmission of the related QoS flow is stopped.
12-16.	If applicable, a PDU Session path update procedure is triggered by the MN.
17.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.
MN initiated conditional SN Change
The Conditional Secondary Node Change procedure is initiated by the MN for inter-SN CPC configuration and inter-SN CPC execution.
Figure 10.5.2-3: Conditional SN change procedure - MN initiated
Figure 10.5.2-3 shows an example signalling flow for the conditional SN Change initiated by the MN:
1/2.	The MN initiates the conditional SN change by requesting the candidate SN(s) to allocate resources for the UE by means of the SN Addition procedure, indicating that the request is for CPAC. The MN also provides the candidate cells recommended by MN via the latest measurement results for the candidate SN(s) to choose and configure the SCG cell(s), provides the upper limit for the number of PSCells that can be prepared by the candidate SN. Within the list of cells as indicated within the measurement results indicated by the MN, the candidate SN decides the list of PSCell(s) to prepare (considering the maximum number indicated by the MN) and, for each prepared PSCell, the candidate SN decides other SCG SCells and provides the new corresponding SCG radio resource configuration to the MN in an NR RRCReconfiguration** message contained in the SN Addition Request Acknowledge message with the prepared PSCell ID(s). If data forwarding is needed, the candidate SN provides data forwarding addresses to the MN. The candidate SN includes the indication of the full or delta RRC configuration. The candidate SN can either accept or reject each of the candidate cells listed within the measurement results indicated by the MN, i.e. it cannot configure any alternative candidates.
NOTE 4:	The MN may trigger the MN-initiated SN Modification procedure (to the source SN) to retrieve the current SCG configuration and to allow provision of data forwarding related information before step 1.
2a.	For SN terminated bearers using MCG resources, the MN provides Xn-U DL TNL address information in the Xn-U Address Indication message to the candidate SN(s).
3.	The MN sends to the UE an RRCReconfiguration message including the CPC configuration, i.e. a list of RRCReconfiguration* messages and associated execution conditions, in which each RRCReconfiguration* message contains the SCG configuration in the RRCReconfiguration** message received from the candidate SN in step 2 and possibly an MCG configuration. Besides, the RRCReconfiguration message can also include an updated MCG configuration, e.g., to configure the required conditional measurements.
4.	The UE applies the RRCReconfiguration message received in step 3, stores the CPC configuration and replies to the MN with an RRCReconfigurationComplete message. In case the UE is unable to comply with (part of) the configuration included in the RRCReconfiguration message, it performs the reconfiguration failure procedure.
4a.	Upon receiving the MN RRCReconfigurationComplete message from the UE, the MN informs the source SN that the CPC has been configured via Xn-U Address Indication procedure, the source SN, if applicable, together with the Early Status Transfer procedure, starts early data forwarding. The PDCP SDU forwarding may take place during early data forwarding.
NOTE 4a:	Separate Xn-U Address Indication procedures may be invoked to provide different forwarding addresses of the prepared candidate target SNs. In this case, it is up to the MN and the source SN implementations to make sure that the EARLY STATUS TRANSFER message(s) from the source SN, if any, is forwarded to the right target destination. The Xn-U Address Indication procedure may further be invoked to indicate to the source SN to stop already initiated early data forwarding for some SN-terminated bearers if they are no longer subject to data forwarding due to the modification or cancellation of the prepared conditional SN change procedures.
NOTE 4b:	For the early transmission of MN terminated split/SCG bearers, the MN forwads the PDCP PDU to the candidate SN(s).
5.	The UE starts evaluating the execution conditions. If the execution condition of one candidate PSCell is satisfied, the UE applies RRCReconfiguration* message corresponding to the selected candidate PSCell, and sends an MN RRCReconfigurationComplete* message, including an NR RRCReconfigurationComplete** message for the selected candidate PSCell, and information enabling the MN to identify the SN of the selected candidate PSCell.
6a-6c.	The MN triggers the MN initiated SN Release procedure to inform the source SN to stop providing user data to the UE, and if applicable, triggers the Xn-U Address Indication procedure to inform the source SN the address of the SN of the selected candidate PSCell, to start late data forwarding.
7a-7c.	If the RRC connection reconfiguration procedure was successful, the MN informs the SN of the selected candidate PSCell via SN Reconfiguration Complete message, including the SN RRCReconfigurationComplete** message. The MN sends the SN Release Request message(s) to cancel CPC in the other candidate SN(s), if configured. The other candidate SN(s) acknowledges the release request.
8.	The UE synchronizes to the PSCell indicated in the RRCReconfiguration* message applied in step 5.
9a-9b.	If PDCP termination point is changed for bearers using RLC AM, the source SN sends the message, which the MN sends then to the SN of the selected candidate PSCell, if needed.
10.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the early data forwarding address in step 4a.
11.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE as described in clause 10.11.2.
NOTE 5:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN is not defined. The SN may send the report when the transmission of the related QoS flow is stopped.
12-16.	If applicable, a PDU Session path update procedure is triggered by the MN.
17.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.
SN initiated conditional SN Change
The SN initiated conditional SN change procedure is used for inter-SN CPC configuration and inter-SN CPC execution.
The SN initiated conditional SN change procedure may also be initiated by the source SN, to modify the existing SN initiated inter-SN CPC configuration, or to trigger the release of the candidate SN by cancellation of all the prepared PSCells at the candidate SN and releasing the CPC related UE context at the candidate SN.
NOTE 5a0:	To modify or release an existing intra-SN CPC configuration, the source SN triggers an SN initiated Conditional SN Modification (with or without SRB3) without MN involvement, as specified in 10.3.
Figure 10.5.2-4: Conditional SN change procedure - SN initiated
Figure 10.5.2-4 shows an example signalling flow for the conditional SN Change initiated by the SN:
1.	The source SN initiates the conditional SN change procedure by sending the SN Change Required message, which contains a CPC initiation indication. The message also contains candidate node ID(s) and may include the SCG configuration (to support delta configuration), and contains the measurements results which may include cells that are not CPC candidates. The message also includes a list of proposed PSCell candidates recommended by the source SN, including execution conditions, the upper limit for the number of PSCells that can be prepared by each candidate SN, and may also include the SCG measurement configurations for CPC (e.g. measurement ID(s) to be used for CPC).
2/3.	The MN requests each candidate SN(s) to allocate resources for the UE by means of the SN Addition procedure(s), indicating the request is for CPAC, and the measurements results which may include cells that are not CPC candidates received from the source SN to the candidate SN, and indicating a list of proposed PSCell candidates received from the source SN, but not including execution conditions. Within the list of PSCells suggested by the source SN, the candidate SN decides the list of PSCell(s) to prepare (considering the maximum number indicated by the MN) and, for each prepared PSCell, the candidate SN decides SCG SCells and provides the new corresponding SCG radio resource configuration to the MN in an NR RRCReconfiguration** message contained in the SgNB Addition Request Acknowledge message. If data forwarding is needed, the candidate SN provides data forwarding addresses to the MN. The candidate SN includes the indication of full or delta RRC configuration, and the list of prepared PSCell IDs to the MN. The candidate SN can either accept or reject each of the candidate cells suggested by the source SN, i.e., it cannot configure any alternative candidates.
3a.	For SN terminated bearers using MCG resources, the MN provides Xn-U DL TNL address information in the Xn-U Address Indication message to the candidate SN(s).
4/5.	The MN may indicate the candidate PSCells accepted by each candidate SN to the source SN via SN Modification Request message before it configures the UE, e.g., when not all candidate PSCells were accepted by the candidate SN(s). If the MN does not send such indication, step 4 and 5 are skipped. If requested, the source SN sends an SN Modification Request Acknowledge message and if needed, provides an updated measurement configurations and/or the execution conditions to the MN.
6.	The MN sends to the UE an RRCReconfiguration message including the CPC configuration, i.e. a list of RRCReconfiguration* messages and associated execution conditions, in which each RRCReconfiguration* message contains the SCG configuration in the RRCReconfiguration** message received from the candidate SN in step 3 and possibly an MCG configuration. Besides, the RRCReconfiguration message can also include an updated MCG configuration, as well as the NR RRCReconfiguration*** message generated by the source SN, e.g., to configure the required conditional measurements.
7.	The UE applies the RRCReconfiguration message received in step 6, stores the CPC configuration and replies to the MN with an RRCReconfigurationComplete message, which can include an NR RRCReconfigurationComplete*** message. In case the UE is unable to comply with (part of) the configuration included in the RRCReconfiguration message, it performs the reconfiguration failure procedure.
8.	If an SN RRC response message is included, the MN informs the source SN with the SN RRCReconfigurationComplete*** message via SN Change Confirm message. If step 4 and 5 are skipped, the MN will indicate the candidate PSCells accepted by each candidate SN to the source SN in the SN Change Confirm message.
The MN sends the SN Change Confirm message towards the source SN to indicate that CPC is prepared, and in such case the source SN continues providing user data to the UE. If early data forwarding is applied, the MN informs the source SN the data forwarding addresses as received from the candidate SN(s), the source SN, if applicable, together with the Early Status Transfer procedure, starts early data forwarding. The PDCP SDU forwarding may take place during early data forwarding. In case multiple candidate SNs are prepared, the MN includes a list of Target SN ID and list of data forwarding addresses to the source SN.
NOTE 5a:	The Xn-U Address Indication procedure may further be invoked to indicate to the source SN to stop already initiated early data forwarding for some PDCP SDUs if they are no longer subject to data forwarding due to the modification or cancellation of the prepared conditional PSCell change.
NOTE 5b:	For the early transmission of MN terminated split/SCG bearers, the MN forwads the PDCP PDU to the candidate SN(s).
9a-9d.	The source SN may send the SN Modification Required message to trigger an update of CPC execution condition and/or corresponding SCG measurement configuration for CPC. In such case in step 9b, the MN reconfigures the UE and in step 9c the UE responds with RRCReconfigurationComplete, similarly as in steps 6 and 7.
10.	The UE starts evaluating the execution conditions. If the execution condition of one candidate PSCell is satisfied, the UE applies RRCReconfiguration* message corresponding to the selected candidate PSCell, and sends an RRCReconfigurationComplete* message, including an RRCReconfigurationComplete** message for the selected candidate PSCell, and information enabling the MN to identify the SN of the selected candidate PSCell.
11a-11c.	The MN triggers the MN initiated SN Release procedure to inform the source SN to stop providing user data to the UE, and triggers the Xn-U Address Indication procedure to inform the source SN the address of the SN of the selected candidate PSCell and if applicable, starts late data forwarding.
12a-12c.	If the RRC connection reconfiguration procedure was successful, the MN informs the SN of the selected candidate PSCell via SN Reconfiguration Complete message, including the SN RRCReconfigurationComplete** message. The MN sends the SN Release Request message(s) to cancel CPC in the other candidate SN(s), if configured. The other candidate SN(s) acknowledges the release request.
13.	The UE synchronizes to the PSCell indicated in the RRCReconfiguration* message applied in step 10.
14.	If PDCP termination point is changed for bearers using RLC AM, the source SN sends the SN Status Transfer message, which the MN sends then to the SN of the selected candidate PSCell, if needed.
15.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the data forwarding address related information from the MN.
16.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE as described in clause 10.11.2.
NOTE 6:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN/target SN is not defined. The SN may send the report when the transmission of the related QoS flow is stopped.
17-21.	If applicable, a PDU Session path update procedure is triggered by the MN.
22.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.",TS 37.340,10.5.2,all_images/image_573.jpeg,SN change procedure - SN initiated
"MN initiated SN Change
The MN initiated SN change procedure is used to transfer a UE context from the source SN to a target SN and to change the SCG configuration in UE from one SN to another.
The Secondary Node Change procedure always involves signalling over MCG SRB towards the UE.
Figure 10.5.2-1: SN change procedure - MN initiated
Figure 10.5.2-1 shows an example signalling flow for the SN Change initiated by the MN:
1/2.	The MN initiates the SN change by requesting the target SN to allocate resources for the UE by means of the SN Addition procedure. The MN may include measurement results related to the target SN. If data forwarding is needed, the target SN provides data forwarding addresses to the MN. The target SN includes the indication of the full or delta RRC configuration.
NOTE 1:	The MN may trigger the MN-initiated SN Modification procedure (to the source SN) to retrieve the current SCG configuration and to allow provision of data forwarding related information before step 1.
2a.	For SN terminated bearers using MCG resources, the MN provides Xn-U DL TNL address information in the Xn-U Address Indication message.
3.	If the allocation of target SN resources was successful, the MN initiates the release of the source SN resources including a Cause indicating SCG mobility. The Source SN may reject the release. If data forwarding is needed the MN provides data forwarding addresses to the source SN. If direct data forwarding is used for SN terminated bearers, the MN provides data forwarding addresses as received from the target SN to source SN. Reception of the SN Release Request message triggers the source SN to stop providing user data to the UE.
4/5.	The MN triggers the UE to apply the new configuration. The MN indicates the new configuration to the UE in the MN RRC reconfiguration message including the target SN RRC reconfiguration message. The UE applies the new configuration and sends the MN RRC reconfiguration complete message, including the SN RRC response message for the target SN, if needed. In case the UE is unable to comply with (part of) the configuration included in the MN RRC reconfiguration message, it performs the reconfiguration failure procedure.
6.	If the RRC connection reconfiguration procedure was successful, the MN informs the target SN via SN Reconfiguration Complete message with the included SN RRC response message for the target SN, if received from the UE.
7.	If configured with bearers requiring SCG radio resources the UE synchronizes to the target SN.
8.	If PDCP termination point is changed for bearers using RLC AM, the source SN sends the SN Status Transfer message, which the MN sends then to the target SN, if needed.
9.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the SN Release Request message from the MN.
10.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE as described in clause 10.11.2.
NOTE 2:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN is not defined. The SN may send the report when the transmission of the related QoS flow is stopped.
11-15.	If applicable, a PDU Session path update procedure is triggered by the MN.
16.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue
SN initiated SN Change
The SN initiated SN change procedure is used to transfer a UE context from the source SN to a target SN and to change the SCG configuration in UE from one SN to another.
Figure 10.5.2-2: SN change procedure - SN initiated
Figure 10.5.2-2 shows an example signalling flow for the SN Change initiated by the SN:
1.	The source SN initiates the SN change procedure by sending the SN Change Required message, which contains a candidate target node ID and may include the SCG configuration (to support delta configuration) and measurement results related to the target SN.
2/3.	The MN requests the target SN to allocate resources for the UE by means of the SN Addition procedure, including the measurement results related to the target SN received from the source SN. If data forwarding is needed, the target SN provides data forwarding addresses to the MN. The target SN includes the indication of the full or delta RRC configuration.
3a.	For SN terminated bearers using MCG resources, the MN provides Xn-U DL TNL address information in the Xn-U Address Indication message.
4/5.	The MN triggers the UE to apply the new configuration. The MN indicates the new configuration to the UE in the MN RRC reconfiguration message including the SN RRC reconfiguration message generated by the target SN. The UE applies the new configuration and sends the MN RRC reconfiguration complete message, including the SN RRC response message for the target SN, if needed. In case the UE is unable to comply with (part of) the configuration included in the MN RRC reconfiguration message, it performs the reconfiguration failure procedure.
6.	If the allocation of target SN resources was successful, the MN confirms the change of the source SN. If data forwarding is needed the MN provides data forwarding addresses to the source SN. If direct data forwarding is used for SN terminated bearers, the MN provides data forwarding addresses as received from the target SN to source SN. Reception of the SN Change Confirm message triggers the source SN to stop providing user data to the UE and, if applicable, to start data forwarding.
7.	If the RRC connection reconfiguration procedure was successful, the MN informs the target SN via SN Reconfiguration Complete message with the included SN RRC response message for the target SN, if received from the UE.
8.	The UE synchronizes to the target SN.
9.	If PDCP termination point is changed for bearers using RLC AM, the source SN sends the SN Status Transfer message, which the MN sends then to the target SN, if needed.
10.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the SN Change Confirm message from the MN.
11.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE as described in clause 10.11.2.
NOTE 3:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN/target SN is not defined. The SN may send the report when the transmission of the related QoS flow is stopped.
12-16.	If applicable, a PDU Session path update procedure is triggered by the MN.
17.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.
MN initiated conditional SN Change
The Conditional Secondary Node Change procedure is initiated by the MN for inter-SN CPC configuration and inter-SN CPC execution.
Figure 10.5.2-3: Conditional SN change procedure - MN initiated
Figure 10.5.2-3 shows an example signalling flow for the conditional SN Change initiated by the MN:
1/2.	The MN initiates the conditional SN change by requesting the candidate SN(s) to allocate resources for the UE by means of the SN Addition procedure, indicating that the request is for CPAC. The MN also provides the candidate cells recommended by MN via the latest measurement results for the candidate SN(s) to choose and configure the SCG cell(s), provides the upper limit for the number of PSCells that can be prepared by the candidate SN. Within the list of cells as indicated within the measurement results indicated by the MN, the candidate SN decides the list of PSCell(s) to prepare (considering the maximum number indicated by the MN) and, for each prepared PSCell, the candidate SN decides other SCG SCells and provides the new corresponding SCG radio resource configuration to the MN in an NR RRCReconfiguration** message contained in the SN Addition Request Acknowledge message with the prepared PSCell ID(s). If data forwarding is needed, the candidate SN provides data forwarding addresses to the MN. The candidate SN includes the indication of the full or delta RRC configuration. The candidate SN can either accept or reject each of the candidate cells listed within the measurement results indicated by the MN, i.e. it cannot configure any alternative candidates.
NOTE 4:	The MN may trigger the MN-initiated SN Modification procedure (to the source SN) to retrieve the current SCG configuration and to allow provision of data forwarding related information before step 1.
2a.	For SN terminated bearers using MCG resources, the MN provides Xn-U DL TNL address information in the Xn-U Address Indication message to the candidate SN(s).
3.	The MN sends to the UE an RRCReconfiguration message including the CPC configuration, i.e. a list of RRCReconfiguration* messages and associated execution conditions, in which each RRCReconfiguration* message contains the SCG configuration in the RRCReconfiguration** message received from the candidate SN in step 2 and possibly an MCG configuration. Besides, the RRCReconfiguration message can also include an updated MCG configuration, e.g., to configure the required conditional measurements.
4.	The UE applies the RRCReconfiguration message received in step 3, stores the CPC configuration and replies to the MN with an RRCReconfigurationComplete message. In case the UE is unable to comply with (part of) the configuration included in the RRCReconfiguration message, it performs the reconfiguration failure procedure.
4a.	Upon receiving the MN RRCReconfigurationComplete message from the UE, the MN informs the source SN that the CPC has been configured via Xn-U Address Indication procedure, the source SN, if applicable, together with the Early Status Transfer procedure, starts early data forwarding. The PDCP SDU forwarding may take place during early data forwarding.
NOTE 4a:	Separate Xn-U Address Indication procedures may be invoked to provide different forwarding addresses of the prepared candidate target SNs. In this case, it is up to the MN and the source SN implementations to make sure that the EARLY STATUS TRANSFER message(s) from the source SN, if any, is forwarded to the right target destination. The Xn-U Address Indication procedure may further be invoked to indicate to the source SN to stop already initiated early data forwarding for some SN-terminated bearers if they are no longer subject to data forwarding due to the modification or cancellation of the prepared conditional SN change procedures.
NOTE 4b:	For the early transmission of MN terminated split/SCG bearers, the MN forwads the PDCP PDU to the candidate SN(s).
5.	The UE starts evaluating the execution conditions. If the execution condition of one candidate PSCell is satisfied, the UE applies RRCReconfiguration* message corresponding to the selected candidate PSCell, and sends an MN RRCReconfigurationComplete* message, including an NR RRCReconfigurationComplete** message for the selected candidate PSCell, and information enabling the MN to identify the SN of the selected candidate PSCell.
6a-6c.	The MN triggers the MN initiated SN Release procedure to inform the source SN to stop providing user data to the UE, and if applicable, triggers the Xn-U Address Indication procedure to inform the source SN the address of the SN of the selected candidate PSCell, to start late data forwarding.
7a-7c.	If the RRC connection reconfiguration procedure was successful, the MN informs the SN of the selected candidate PSCell via SN Reconfiguration Complete message, including the SN RRCReconfigurationComplete** message. The MN sends the SN Release Request message(s) to cancel CPC in the other candidate SN(s), if configured. The other candidate SN(s) acknowledges the release request.
8.	The UE synchronizes to the PSCell indicated in the RRCReconfiguration* message applied in step 5.
9a-9b.	If PDCP termination point is changed for bearers using RLC AM, the source SN sends the message, which the MN sends then to the SN of the selected candidate PSCell, if needed.
10.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the early data forwarding address in step 4a.
11.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE as described in clause 10.11.2.
NOTE 5:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN is not defined. The SN may send the report when the transmission of the related QoS flow is stopped.
12-16.	If applicable, a PDU Session path update procedure is triggered by the MN.
17.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.
SN initiated conditional SN Change
The SN initiated conditional SN change procedure is used for inter-SN CPC configuration and inter-SN CPC execution.
The SN initiated conditional SN change procedure may also be initiated by the source SN, to modify the existing SN initiated inter-SN CPC configuration, or to trigger the release of the candidate SN by cancellation of all the prepared PSCells at the candidate SN and releasing the CPC related UE context at the candidate SN.
NOTE 5a0:	To modify or release an existing intra-SN CPC configuration, the source SN triggers an SN initiated Conditional SN Modification (with or without SRB3) without MN involvement, as specified in 10.3.
Figure 10.5.2-4: Conditional SN change procedure - SN initiated
Figure 10.5.2-4 shows an example signalling flow for the conditional SN Change initiated by the SN:
1.	The source SN initiates the conditional SN change procedure by sending the SN Change Required message, which contains a CPC initiation indication. The message also contains candidate node ID(s) and may include the SCG configuration (to support delta configuration), and contains the measurements results which may include cells that are not CPC candidates. The message also includes a list of proposed PSCell candidates recommended by the source SN, including execution conditions, the upper limit for the number of PSCells that can be prepared by each candidate SN, and may also include the SCG measurement configurations for CPC (e.g. measurement ID(s) to be used for CPC).
2/3.	The MN requests each candidate SN(s) to allocate resources for the UE by means of the SN Addition procedure(s), indicating the request is for CPAC, and the measurements results which may include cells that are not CPC candidates received from the source SN to the candidate SN, and indicating a list of proposed PSCell candidates received from the source SN, but not including execution conditions. Within the list of PSCells suggested by the source SN, the candidate SN decides the list of PSCell(s) to prepare (considering the maximum number indicated by the MN) and, for each prepared PSCell, the candidate SN decides SCG SCells and provides the new corresponding SCG radio resource configuration to the MN in an NR RRCReconfiguration** message contained in the SgNB Addition Request Acknowledge message. If data forwarding is needed, the candidate SN provides data forwarding addresses to the MN. The candidate SN includes the indication of full or delta RRC configuration, and the list of prepared PSCell IDs to the MN. The candidate SN can either accept or reject each of the candidate cells suggested by the source SN, i.e., it cannot configure any alternative candidates.
3a.	For SN terminated bearers using MCG resources, the MN provides Xn-U DL TNL address information in the Xn-U Address Indication message to the candidate SN(s).
4/5.	The MN may indicate the candidate PSCells accepted by each candidate SN to the source SN via SN Modification Request message before it configures the UE, e.g., when not all candidate PSCells were accepted by the candidate SN(s). If the MN does not send such indication, step 4 and 5 are skipped. If requested, the source SN sends an SN Modification Request Acknowledge message and if needed, provides an updated measurement configurations and/or the execution conditions to the MN.
6.	The MN sends to the UE an RRCReconfiguration message including the CPC configuration, i.e. a list of RRCReconfiguration* messages and associated execution conditions, in which each RRCReconfiguration* message contains the SCG configuration in the RRCReconfiguration** message received from the candidate SN in step 3 and possibly an MCG configuration. Besides, the RRCReconfiguration message can also include an updated MCG configuration, as well as the NR RRCReconfiguration*** message generated by the source SN, e.g., to configure the required conditional measurements.
7.	The UE applies the RRCReconfiguration message received in step 6, stores the CPC configuration and replies to the MN with an RRCReconfigurationComplete message, which can include an NR RRCReconfigurationComplete*** message. In case the UE is unable to comply with (part of) the configuration included in the RRCReconfiguration message, it performs the reconfiguration failure procedure.
8.	If an SN RRC response message is included, the MN informs the source SN with the SN RRCReconfigurationComplete*** message via SN Change Confirm message. If step 4 and 5 are skipped, the MN will indicate the candidate PSCells accepted by each candidate SN to the source SN in the SN Change Confirm message.
The MN sends the SN Change Confirm message towards the source SN to indicate that CPC is prepared, and in such case the source SN continues providing user data to the UE. If early data forwarding is applied, the MN informs the source SN the data forwarding addresses as received from the candidate SN(s), the source SN, if applicable, together with the Early Status Transfer procedure, starts early data forwarding. The PDCP SDU forwarding may take place during early data forwarding. In case multiple candidate SNs are prepared, the MN includes a list of Target SN ID and list of data forwarding addresses to the source SN.
NOTE 5a:	The Xn-U Address Indication procedure may further be invoked to indicate to the source SN to stop already initiated early data forwarding for some PDCP SDUs if they are no longer subject to data forwarding due to the modification or cancellation of the prepared conditional PSCell change.
NOTE 5b:	For the early transmission of MN terminated split/SCG bearers, the MN forwads the PDCP PDU to the candidate SN(s).
9a-9d.	The source SN may send the SN Modification Required message to trigger an update of CPC execution condition and/or corresponding SCG measurement configuration for CPC. In such case in step 9b, the MN reconfigures the UE and in step 9c the UE responds with RRCReconfigurationComplete, similarly as in steps 6 and 7.
10.	The UE starts evaluating the execution conditions. If the execution condition of one candidate PSCell is satisfied, the UE applies RRCReconfiguration* message corresponding to the selected candidate PSCell, and sends an RRCReconfigurationComplete* message, including an RRCReconfigurationComplete** message for the selected candidate PSCell, and information enabling the MN to identify the SN of the selected candidate PSCell.
11a-11c.	The MN triggers the MN initiated SN Release procedure to inform the source SN to stop providing user data to the UE, and triggers the Xn-U Address Indication procedure to inform the source SN the address of the SN of the selected candidate PSCell and if applicable, starts late data forwarding.
12a-12c.	If the RRC connection reconfiguration procedure was successful, the MN informs the SN of the selected candidate PSCell via SN Reconfiguration Complete message, including the SN RRCReconfigurationComplete** message. The MN sends the SN Release Request message(s) to cancel CPC in the other candidate SN(s), if configured. The other candidate SN(s) acknowledges the release request.
13.	The UE synchronizes to the PSCell indicated in the RRCReconfiguration* message applied in step 10.
14.	If PDCP termination point is changed for bearers using RLC AM, the source SN sends the SN Status Transfer message, which the MN sends then to the SN of the selected candidate PSCell, if needed.
15.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the data forwarding address related information from the MN.
16.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE as described in clause 10.11.2.
NOTE 6:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN/target SN is not defined. The SN may send the report when the transmission of the related QoS flow is stopped.
17-21.	If applicable, a PDU Session path update procedure is triggered by the MN.
22.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.",TS 37.340,10.5.2,all_images/image_574.jpeg,Conditional SN change procedure - MN initiated
"MN initiated SN Change
The MN initiated SN change procedure is used to transfer a UE context from the source SN to a target SN and to change the SCG configuration in UE from one SN to another.
The Secondary Node Change procedure always involves signalling over MCG SRB towards the UE.
Figure 10.5.2-1: SN change procedure - MN initiated
Figure 10.5.2-1 shows an example signalling flow for the SN Change initiated by the MN:
1/2.	The MN initiates the SN change by requesting the target SN to allocate resources for the UE by means of the SN Addition procedure. The MN may include measurement results related to the target SN. If data forwarding is needed, the target SN provides data forwarding addresses to the MN. The target SN includes the indication of the full or delta RRC configuration.
NOTE 1:	The MN may trigger the MN-initiated SN Modification procedure (to the source SN) to retrieve the current SCG configuration and to allow provision of data forwarding related information before step 1.
2a.	For SN terminated bearers using MCG resources, the MN provides Xn-U DL TNL address information in the Xn-U Address Indication message.
3.	If the allocation of target SN resources was successful, the MN initiates the release of the source SN resources including a Cause indicating SCG mobility. The Source SN may reject the release. If data forwarding is needed the MN provides data forwarding addresses to the source SN. If direct data forwarding is used for SN terminated bearers, the MN provides data forwarding addresses as received from the target SN to source SN. Reception of the SN Release Request message triggers the source SN to stop providing user data to the UE.
4/5.	The MN triggers the UE to apply the new configuration. The MN indicates the new configuration to the UE in the MN RRC reconfiguration message including the target SN RRC reconfiguration message. The UE applies the new configuration and sends the MN RRC reconfiguration complete message, including the SN RRC response message for the target SN, if needed. In case the UE is unable to comply with (part of) the configuration included in the MN RRC reconfiguration message, it performs the reconfiguration failure procedure.
6.	If the RRC connection reconfiguration procedure was successful, the MN informs the target SN via SN Reconfiguration Complete message with the included SN RRC response message for the target SN, if received from the UE.
7.	If configured with bearers requiring SCG radio resources the UE synchronizes to the target SN.
8.	If PDCP termination point is changed for bearers using RLC AM, the source SN sends the SN Status Transfer message, which the MN sends then to the target SN, if needed.
9.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the SN Release Request message from the MN.
10.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE as described in clause 10.11.2.
NOTE 2:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN is not defined. The SN may send the report when the transmission of the related QoS flow is stopped.
11-15.	If applicable, a PDU Session path update procedure is triggered by the MN.
16.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue
SN initiated SN Change
The SN initiated SN change procedure is used to transfer a UE context from the source SN to a target SN and to change the SCG configuration in UE from one SN to another.
Figure 10.5.2-2: SN change procedure - SN initiated
Figure 10.5.2-2 shows an example signalling flow for the SN Change initiated by the SN:
1.	The source SN initiates the SN change procedure by sending the SN Change Required message, which contains a candidate target node ID and may include the SCG configuration (to support delta configuration) and measurement results related to the target SN.
2/3.	The MN requests the target SN to allocate resources for the UE by means of the SN Addition procedure, including the measurement results related to the target SN received from the source SN. If data forwarding is needed, the target SN provides data forwarding addresses to the MN. The target SN includes the indication of the full or delta RRC configuration.
3a.	For SN terminated bearers using MCG resources, the MN provides Xn-U DL TNL address information in the Xn-U Address Indication message.
4/5.	The MN triggers the UE to apply the new configuration. The MN indicates the new configuration to the UE in the MN RRC reconfiguration message including the SN RRC reconfiguration message generated by the target SN. The UE applies the new configuration and sends the MN RRC reconfiguration complete message, including the SN RRC response message for the target SN, if needed. In case the UE is unable to comply with (part of) the configuration included in the MN RRC reconfiguration message, it performs the reconfiguration failure procedure.
6.	If the allocation of target SN resources was successful, the MN confirms the change of the source SN. If data forwarding is needed the MN provides data forwarding addresses to the source SN. If direct data forwarding is used for SN terminated bearers, the MN provides data forwarding addresses as received from the target SN to source SN. Reception of the SN Change Confirm message triggers the source SN to stop providing user data to the UE and, if applicable, to start data forwarding.
7.	If the RRC connection reconfiguration procedure was successful, the MN informs the target SN via SN Reconfiguration Complete message with the included SN RRC response message for the target SN, if received from the UE.
8.	The UE synchronizes to the target SN.
9.	If PDCP termination point is changed for bearers using RLC AM, the source SN sends the SN Status Transfer message, which the MN sends then to the target SN, if needed.
10.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the SN Change Confirm message from the MN.
11.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE as described in clause 10.11.2.
NOTE 3:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN/target SN is not defined. The SN may send the report when the transmission of the related QoS flow is stopped.
12-16.	If applicable, a PDU Session path update procedure is triggered by the MN.
17.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.
MN initiated conditional SN Change
The Conditional Secondary Node Change procedure is initiated by the MN for inter-SN CPC configuration and inter-SN CPC execution.
Figure 10.5.2-3: Conditional SN change procedure - MN initiated
Figure 10.5.2-3 shows an example signalling flow for the conditional SN Change initiated by the MN:
1/2.	The MN initiates the conditional SN change by requesting the candidate SN(s) to allocate resources for the UE by means of the SN Addition procedure, indicating that the request is for CPAC. The MN also provides the candidate cells recommended by MN via the latest measurement results for the candidate SN(s) to choose and configure the SCG cell(s), provides the upper limit for the number of PSCells that can be prepared by the candidate SN. Within the list of cells as indicated within the measurement results indicated by the MN, the candidate SN decides the list of PSCell(s) to prepare (considering the maximum number indicated by the MN) and, for each prepared PSCell, the candidate SN decides other SCG SCells and provides the new corresponding SCG radio resource configuration to the MN in an NR RRCReconfiguration** message contained in the SN Addition Request Acknowledge message with the prepared PSCell ID(s). If data forwarding is needed, the candidate SN provides data forwarding addresses to the MN. The candidate SN includes the indication of the full or delta RRC configuration. The candidate SN can either accept or reject each of the candidate cells listed within the measurement results indicated by the MN, i.e. it cannot configure any alternative candidates.
NOTE 4:	The MN may trigger the MN-initiated SN Modification procedure (to the source SN) to retrieve the current SCG configuration and to allow provision of data forwarding related information before step 1.
2a.	For SN terminated bearers using MCG resources, the MN provides Xn-U DL TNL address information in the Xn-U Address Indication message to the candidate SN(s).
3.	The MN sends to the UE an RRCReconfiguration message including the CPC configuration, i.e. a list of RRCReconfiguration* messages and associated execution conditions, in which each RRCReconfiguration* message contains the SCG configuration in the RRCReconfiguration** message received from the candidate SN in step 2 and possibly an MCG configuration. Besides, the RRCReconfiguration message can also include an updated MCG configuration, e.g., to configure the required conditional measurements.
4.	The UE applies the RRCReconfiguration message received in step 3, stores the CPC configuration and replies to the MN with an RRCReconfigurationComplete message. In case the UE is unable to comply with (part of) the configuration included in the RRCReconfiguration message, it performs the reconfiguration failure procedure.
4a.	Upon receiving the MN RRCReconfigurationComplete message from the UE, the MN informs the source SN that the CPC has been configured via Xn-U Address Indication procedure, the source SN, if applicable, together with the Early Status Transfer procedure, starts early data forwarding. The PDCP SDU forwarding may take place during early data forwarding.
NOTE 4a:	Separate Xn-U Address Indication procedures may be invoked to provide different forwarding addresses of the prepared candidate target SNs. In this case, it is up to the MN and the source SN implementations to make sure that the EARLY STATUS TRANSFER message(s) from the source SN, if any, is forwarded to the right target destination. The Xn-U Address Indication procedure may further be invoked to indicate to the source SN to stop already initiated early data forwarding for some SN-terminated bearers if they are no longer subject to data forwarding due to the modification or cancellation of the prepared conditional SN change procedures.
NOTE 4b:	For the early transmission of MN terminated split/SCG bearers, the MN forwads the PDCP PDU to the candidate SN(s).
5.	The UE starts evaluating the execution conditions. If the execution condition of one candidate PSCell is satisfied, the UE applies RRCReconfiguration* message corresponding to the selected candidate PSCell, and sends an MN RRCReconfigurationComplete* message, including an NR RRCReconfigurationComplete** message for the selected candidate PSCell, and information enabling the MN to identify the SN of the selected candidate PSCell.
6a-6c.	The MN triggers the MN initiated SN Release procedure to inform the source SN to stop providing user data to the UE, and if applicable, triggers the Xn-U Address Indication procedure to inform the source SN the address of the SN of the selected candidate PSCell, to start late data forwarding.
7a-7c.	If the RRC connection reconfiguration procedure was successful, the MN informs the SN of the selected candidate PSCell via SN Reconfiguration Complete message, including the SN RRCReconfigurationComplete** message. The MN sends the SN Release Request message(s) to cancel CPC in the other candidate SN(s), if configured. The other candidate SN(s) acknowledges the release request.
8.	The UE synchronizes to the PSCell indicated in the RRCReconfiguration* message applied in step 5.
9a-9b.	If PDCP termination point is changed for bearers using RLC AM, the source SN sends the message, which the MN sends then to the SN of the selected candidate PSCell, if needed.
10.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the early data forwarding address in step 4a.
11.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE as described in clause 10.11.2.
NOTE 5:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN is not defined. The SN may send the report when the transmission of the related QoS flow is stopped.
12-16.	If applicable, a PDU Session path update procedure is triggered by the MN.
17.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.
SN initiated conditional SN Change
The SN initiated conditional SN change procedure is used for inter-SN CPC configuration and inter-SN CPC execution.
The SN initiated conditional SN change procedure may also be initiated by the source SN, to modify the existing SN initiated inter-SN CPC configuration, or to trigger the release of the candidate SN by cancellation of all the prepared PSCells at the candidate SN and releasing the CPC related UE context at the candidate SN.
NOTE 5a0:	To modify or release an existing intra-SN CPC configuration, the source SN triggers an SN initiated Conditional SN Modification (with or without SRB3) without MN involvement, as specified in 10.3.
Figure 10.5.2-4: Conditional SN change procedure - SN initiated
Figure 10.5.2-4 shows an example signalling flow for the conditional SN Change initiated by the SN:
1.	The source SN initiates the conditional SN change procedure by sending the SN Change Required message, which contains a CPC initiation indication. The message also contains candidate node ID(s) and may include the SCG configuration (to support delta configuration), and contains the measurements results which may include cells that are not CPC candidates. The message also includes a list of proposed PSCell candidates recommended by the source SN, including execution conditions, the upper limit for the number of PSCells that can be prepared by each candidate SN, and may also include the SCG measurement configurations for CPC (e.g. measurement ID(s) to be used for CPC).
2/3.	The MN requests each candidate SN(s) to allocate resources for the UE by means of the SN Addition procedure(s), indicating the request is for CPAC, and the measurements results which may include cells that are not CPC candidates received from the source SN to the candidate SN, and indicating a list of proposed PSCell candidates received from the source SN, but not including execution conditions. Within the list of PSCells suggested by the source SN, the candidate SN decides the list of PSCell(s) to prepare (considering the maximum number indicated by the MN) and, for each prepared PSCell, the candidate SN decides SCG SCells and provides the new corresponding SCG radio resource configuration to the MN in an NR RRCReconfiguration** message contained in the SgNB Addition Request Acknowledge message. If data forwarding is needed, the candidate SN provides data forwarding addresses to the MN. The candidate SN includes the indication of full or delta RRC configuration, and the list of prepared PSCell IDs to the MN. The candidate SN can either accept or reject each of the candidate cells suggested by the source SN, i.e., it cannot configure any alternative candidates.
3a.	For SN terminated bearers using MCG resources, the MN provides Xn-U DL TNL address information in the Xn-U Address Indication message to the candidate SN(s).
4/5.	The MN may indicate the candidate PSCells accepted by each candidate SN to the source SN via SN Modification Request message before it configures the UE, e.g., when not all candidate PSCells were accepted by the candidate SN(s). If the MN does not send such indication, step 4 and 5 are skipped. If requested, the source SN sends an SN Modification Request Acknowledge message and if needed, provides an updated measurement configurations and/or the execution conditions to the MN.
6.	The MN sends to the UE an RRCReconfiguration message including the CPC configuration, i.e. a list of RRCReconfiguration* messages and associated execution conditions, in which each RRCReconfiguration* message contains the SCG configuration in the RRCReconfiguration** message received from the candidate SN in step 3 and possibly an MCG configuration. Besides, the RRCReconfiguration message can also include an updated MCG configuration, as well as the NR RRCReconfiguration*** message generated by the source SN, e.g., to configure the required conditional measurements.
7.	The UE applies the RRCReconfiguration message received in step 6, stores the CPC configuration and replies to the MN with an RRCReconfigurationComplete message, which can include an NR RRCReconfigurationComplete*** message. In case the UE is unable to comply with (part of) the configuration included in the RRCReconfiguration message, it performs the reconfiguration failure procedure.
8.	If an SN RRC response message is included, the MN informs the source SN with the SN RRCReconfigurationComplete*** message via SN Change Confirm message. If step 4 and 5 are skipped, the MN will indicate the candidate PSCells accepted by each candidate SN to the source SN in the SN Change Confirm message.
The MN sends the SN Change Confirm message towards the source SN to indicate that CPC is prepared, and in such case the source SN continues providing user data to the UE. If early data forwarding is applied, the MN informs the source SN the data forwarding addresses as received from the candidate SN(s), the source SN, if applicable, together with the Early Status Transfer procedure, starts early data forwarding. The PDCP SDU forwarding may take place during early data forwarding. In case multiple candidate SNs are prepared, the MN includes a list of Target SN ID and list of data forwarding addresses to the source SN.
NOTE 5a:	The Xn-U Address Indication procedure may further be invoked to indicate to the source SN to stop already initiated early data forwarding for some PDCP SDUs if they are no longer subject to data forwarding due to the modification or cancellation of the prepared conditional PSCell change.
NOTE 5b:	For the early transmission of MN terminated split/SCG bearers, the MN forwads the PDCP PDU to the candidate SN(s).
9a-9d.	The source SN may send the SN Modification Required message to trigger an update of CPC execution condition and/or corresponding SCG measurement configuration for CPC. In such case in step 9b, the MN reconfigures the UE and in step 9c the UE responds with RRCReconfigurationComplete, similarly as in steps 6 and 7.
10.	The UE starts evaluating the execution conditions. If the execution condition of one candidate PSCell is satisfied, the UE applies RRCReconfiguration* message corresponding to the selected candidate PSCell, and sends an RRCReconfigurationComplete* message, including an RRCReconfigurationComplete** message for the selected candidate PSCell, and information enabling the MN to identify the SN of the selected candidate PSCell.
11a-11c.	The MN triggers the MN initiated SN Release procedure to inform the source SN to stop providing user data to the UE, and triggers the Xn-U Address Indication procedure to inform the source SN the address of the SN of the selected candidate PSCell and if applicable, starts late data forwarding.
12a-12c.	If the RRC connection reconfiguration procedure was successful, the MN informs the SN of the selected candidate PSCell via SN Reconfiguration Complete message, including the SN RRCReconfigurationComplete** message. The MN sends the SN Release Request message(s) to cancel CPC in the other candidate SN(s), if configured. The other candidate SN(s) acknowledges the release request.
13.	The UE synchronizes to the PSCell indicated in the RRCReconfiguration* message applied in step 10.
14.	If PDCP termination point is changed for bearers using RLC AM, the source SN sends the SN Status Transfer message, which the MN sends then to the SN of the selected candidate PSCell, if needed.
15.	If applicable, data forwarding from the source SN takes place. It may be initiated as early as the source SN receives the data forwarding address related information from the MN.
16.	The source SN sends the Secondary RAT Data Usage Report message to the MN and includes the data volumes delivered to and received from the UE as described in clause 10.11.2.
NOTE 6:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN/target SN is not defined. The SN may send the report when the transmission of the related QoS flow is stopped.
17-21.	If applicable, a PDU Session path update procedure is triggered by the MN.
22.	Upon reception of the UE Context Release message, the source SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.",TS 37.340,10.5.2,all_images/image_575.jpeg,Conditional SN change procedure - SN initiated
"Inter-Master Node handover with/without MN initiated Secondary Node change is used to transfer context data from a source MN to a target MN while the context at the SN is kept or moved to another SN. During an Inter-Master Node handover, the target MN decides whether to keep or change the SN (or release the SN, as described in clause 10.8).
NOTE 1:	Void.
Figure 10.7.1-1: Inter-MN handover with/without MN initiated SN change
Figure 10.7.1-1 shows an example signaling flow for inter-Master Node handover with or without MN initiated Secondary Node change:
NOTE 2:	For an inter-Master Node handover without Secondary Node change, the source SN and the target SN shown in Figure 10.7.1-1 are the same node.
1.	The source MN starts the handover procedure by initiating the X2 Handover Preparation procedure including both MCG and SCG configuration. The source MN includes the (source) SN UE X2AP ID, SN ID and the UE context in the (source) SN in the Handover Request message.
NOTE 3:	The source MN may trigger the MN-initiated SN Modification procedure (to the source SN) to retrieve the current SCG configuration before step 1.
2.	If the target MN decides to keep the UE context in SN, the target MN sends SgNB Addition Request to the SN including the SN UE X2AP ID as a reference to the UE context in the SN that was established by the source MN. If the target MN decides to change the SN allowing delta configuration, the target MN sends the SgNB Addition Request to the target SN including the UE context in the source SN that was established by the source MN. Otherwise, the target MN may send the SgNB Addition Request to the target SN including neither the SN UE X2AP ID nor the UE context in the source SN that was established by the source MN.
3.	The (target) SN replies with SgNB Addition Request Acknowledge. The (target) SN may include the indication of the full or delta RRC configuration.
NOTE 3a:	In case the target SN includes the indication of the full RRC configuration, the MN performs release of the SN terminated radio bearer configuration and release and add of the NR SCG configuration part towards the UE.
NOTE 3b:	Void.
4.	The target MN includes within the Handover Request Acknowledge message a transparent container to be sent to the UE as an RRC message to perform the handover, and may also provide forwarding addresses to the source MN. The target MN indicates to the source MN that the UE context in the SN is kept if the target MN and the SN decided to keep the UE context in the SN in step 2 and step 3.
5.	The source MN sends SgNB Release Request to the (source) SN including a Cause indicating MCG mobility. The (source) SN acknowledges the release request. The source MN indicates to the (source) SN that the UE context in SN is kept, if it receives the indication from the target MN. If the indication as the UE context kept in SN is included, the SN keeps the UE context.
6.	The source MN triggers the UE to apply the new configuration.
7/8.	The UE synchronizes to the target MN and replies with RRCConnectionReconfigurationComplete message.
9.	If configured with bearers requiring SCG radio resources, the UE synchronizes to the (target) SN.
NOTE 3b1:	The order the UE performs Random Access towards the MN (step 7) and performs the Random Access procedure towards the SN (step 9) is not defined.
10.	If the RRC connection reconfiguration procedure was successful, the target MN informs the (target) SN via SgNB Reconfiguration Complete message.
11a.	The SN sends the Secondary RAT Data Usage Report message to the source MN and includes the data volumes delivered to and received from the UE over the NR radio for the related E-RABs.
NOTE 4:	The order the source SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN/target SN is not defined. The SgNB may send the report when the transmission of the related bearer is stopped.
11b.	The source MN sends the Secondary RAT Report message to MME to provide information on the used NR resource.
12.	For bearers using RLC AM, the source MN sends the SN Status Transfer message, including, if needed, SN Status received from the source SN to the target MN. The target forwards the SN Status to the target SN, if needed.
13.	If applicable, data forwarding takes place from the source side. If the SN is kept, data forwarding may be omitted for SN-terminated bearers kept in the SN.
14-17.	The target MN initiates the S1 Path Switch procedure.
NOTE 5:	If new UL TEIDs of the S-GW are included, the target MN performs the MN initiated SN Modification procedure to provide them to the SN.
18.	The target MN initiates the UE Context Release procedure towards the source MN.
19.	Upon reception of the UE Context Release message, the (source) SN releases C-plane related resources associated to the UE context towards the source MN. Any ongoing data forwarding may continue. The SN shall not release the UE context associated with the target MN if the UE context kept indication was included in the SgNB Release Request message in step 5.",TS 37.340,10.7.1,all_images/image_576.jpeg,Inter-MN handover with/without MN initiated SN change
"Inter-MN handover with/without MN initiated SN change is used to transfer UE context data from a source MN to a target MN while the UE context at the SN is kept or moved to another SN. During an Inter-Master Node handover, the target MN decides whether to keep or change the SN (or release the SN, as described in clause 10.8). Only intra-RAT Inter-Master node handover with/without SN change is supported (e.g. no transition from NGEN-DC to NR-DC).
Figure 10.7.2-1: Inter-MN handover with/without MN initiated SN change procedure
Figure 10.7.2-1 shows an example signalling flow for inter-MN handover with or without MN initiated SN change:
NOTE 1:	For an Inter-Master Node handover without Secondary Node change, the source SN and the target SN shown in Figure 10.7.2-1 are the same node.
1.	The source MN starts the handover procedure by initiating the Xn Handover Preparation procedure including both MCG and SCG configuration. The source MN includes the source SN UE XnAP ID, SN ID and the UE context in the source SN in the Handover Request message.
NOTE 2:	The source MN may trigger the MN-initiated SN Modification procedure (to the source SN) to retrieve the current SCG configuration and to allow provision of data forwarding related information before step 1.
2.	If the target MN decides to keep the UE context in source SN, the target MN sends SN Addition Request to the SN including the SN UE XnAP ID as a reference to the UE context in the SN that was established by the source MN. If the target MN decides to change the SN allowing delta configuration, the target MN sends the SN Addition Request to the target SN including the UE context in the source SN that was established by the source MN. Otherwise, the target MN may send the SN Addition Request to the target SN including neither the SN UE XnAP ID nor the UE context in the source SN that was established by the source MN.
3.	The (target) SN replies with SN Addition Request Acknowledge. The (target) SN may include the indication of the full or delta RRC configuration.
NOTE 2a0: Void.
3a.	For SN terminated bearers using MCG resources, the target MN provides Xn-U DL TNL address information in the Xn-U Address Indication message.
4.	The target MN includes within the Handover Request Acknowledge message the MN RRC reconfiguration message to be sent to the UE in order to perform the handover, and may also provide forwarding addresses to the source MN. If PDU session split is performed in the target side during handover procedure, more than one data forwarding addresses corresponding to each node are included in the Handover Request Acknowledge message. The target MN indicates to the source MN that the UE context in the SN is kept if the target MN and the SN decided to keep the UE context in the SN in step 2 and step 3.
5a/5b.	The source MN sends SN Release Request message to the (source) SN including a Cause indicating MCG mobility. The (source) SN acknowledges the release request. The source MN indicates to the (source) SN that the UE context in SN is kept, if it receives the indication from the target MN. If the indication as the UE context kept in SN is included, the SN keeps the UE context.
5c.	The source MN sends XN-U Address Indication message to the (source) SN to transfer data forwarding information. More than one data forwarding addresses may be provided if the PDU session is split in the target side.
6.	The source MN triggers the UE to perform handover and apply the new configuration.
7/8.	The UE synchronizes to the target MN and replies with MN RRC reconfiguration complete message.
9.	If configured with bearers requiring SCG radio resources, the UE synchronizes to the (target) SN.
NOTE 2a1:	The order the UE performs Random Access towards the MN (step 7) and performs the Random Access procedure towards the SN (step 9) is not defined.
10.	If the RRC connection reconfiguration procedure was successful, the target MN informs the (target) SN via SN Reconfiguration Complete message.
11a. The source SN sends the Secondary RAT Data Usage Report message to the source MN and includes the data volumes delivered to and received from the UE over the NR/E-UTRA radio as described in clause 10.11.2.
NOTE 2a2:	The order the source SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN/target SN is not defined. The SN may send the report when the transmission of the related QoS is stopped.
11b. The source MN sends the Secondary RAT Report message to AMF to provide information on the used NR/E-UTRA resource.
12.	For bearers using RLC AM, the source MN sends the SN Status Transfer message to the target MN, including, if needed, SN Status received from the source SN. The target forwards the SN Status to the target SN, if needed.
13.	If applicable, data forwarding takes place from the source side. If the SN is kept, data forwarding may be omitted for SN terminated bearers or QoS flows kept in the SN.
14-17.	The target MN initiates the Path Switch procedure. If the target MN includes multiple DL TEIDs for one PDU session in the Path Switch Request message, multiple UL TEID of the UPF for the PDU session should be included in the Path Switch Ack message in case there is TEID update in UPF.
NOTE 3:	If new UL TEIDs of the UPF for SN are included, the target MN performs MN initiated SN Modification procedure to provide them to the SN.
18.	The target MN initiates the UE Context Release procedure towards the source MN.
19.	Upon reception of the UE Context Release message from source MN, the (source) SN releases C-plane related resources associated to the UE context towards the source MN. Any ongoing data forwarding may continue. The SN shall not release the UE context associated with the target MN if the UE contest kept indication was included in the SN Release Request message in step 5.",TS 37.340,10.7.2,all_images/image_577.jpeg,Inter-MN handover with/without MN initiated SN change procedure
"The Master Node to eNB Change procedure is used to transfer context data from a source MN/SN to a target eNB.
Figure 10.8.1-1: Master Node to eNB Change procedure
Figure 10.8.1-1 shows an example signalling flow for the Master Node to eNB Change procedure:
1.	The source MN starts the MN to eNB Change procedure by initiating the X2 Handover Preparation procedure, including both MCG and SCG configuration.
NOTE 1:	The source MN may trigger the MN-initiated SN Modification procedure (to the source SN) to retrieve the current SCG configuration before step 1.
2.	The target eNB includes the field in HO command which releases SCG configuration, and may also provide forwarding addresses to the source MN.
3.	If the allocation of target eNB resources was successful, the MN initiates the release of the source SN resources towards the source SN including a Cause indicating MCG mobility. The SN acknowledges the release request. If data forwarding is needed, the MN provides data forwarding addresses to the source SN. Reception of the SgNB Release Request message triggers the source SN to stop providing user data to the UE and, if applicable, to start data forwarding.
NOTE 1a:	In case the handover is a conditional handover, step 3a and step 3b are performed after the source MN receives an indication that the UE has successfully accessed one of the potential target eNB(s) as described in step 11a in Figure 10.1.2.1a-1in TS 36.300 [2], i.e,. after step 6 in Figure 10.8.1-1.
NOTE 1b:	In case the handover is a conditional handover, the Data Forwarding Address Indication procedure is executed right after step 2. This Data Forwarding Address Indication procedure notifies conditional handover to the source SN, for which it may decide to perform, if applicable, early data forwarding for SN-terminated bearers, together with the sending of an EARLY STATUS TRANSFER message to the source MN. Separate Data Forwarding Address Indication procedures may be invoked to provide different forwarding addresses of the prepared conditional handovers. In this case, it is up to the source MN and SN implementations to make sure that the EARLY STATUS TRANSFER message(s) from the source SN, if any, is forwarded to the right target destination. The Data Forwarding Address Indication procedure may further be invoked to indicate to the source SN to stop already initiated early data forwarding for some SN-terminated bearers if they are no longer subject to data forwarding due to the modification or cancellation of the prepared conditional handovers. If applicable, the normal data forwarding and SN STATUS TRANSFER message would follow from the source SN once it receives the SgNB Release Request message of the step 3a that is performed after step 6.
4.	The MN triggers the UE to apply the new configuration. Upon receiving the new configuration, the UE releases the entire SCG configuration.
5/6.	The UE synchronizes to the target eNB.
7.	For SN terminated bearers using RLC AM, the SN sends the SN Status Transfer message, which the source MN sends then to the target eNB.
8.	If applicable, data forwarding takes place from the source side.
9a.	The source SN sends the Secondary RAT Data Usagee Report message to the source MN and includes the data volumes delivered to and received from the UE over the NR radio for the related E-RABs.
NOTE 2:	The order the SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN is not defined. The SN may send the report when the transmission of the related bearer is stopped.
9b.	The source MN sends the Secondary RAT Report message to MME to provide information on the used NR resource.
10-14.	The target eNB initiates the S1 Path Switch procedure.
15.	The target eNB initiates the UE Context Release procedure towards the source MN.
16.	Upon reception of the UE Context Release message, the SN releases radio and C-plane related resources associated to the UE context. Any ongoing data forwarding may continue.
NOTE 3:	Inter-system HO from E-UTRA with EN-DC configuration to NR or to E-UTRA connected to 5GC is also supported.",TS 37.340,10.8.1,all_images/image_578.jpeg,Master Node to eNB Change procedure
"The Activity Notification function is used to report user plane activity within SN resources. It can either report inactivity or resumption of activity after inactivity was reported. In EN-DC the Activity Reporting is provided from the SN only. The MN may take further actions.
EN-DC Activity Notification
Figure 10.12.1-1: Support of Activity Notification in EN-DC
Support of Activity Notification in EN-DC is used to keep the MN informed about user traffic activity in resources owned by the SN. The MN may take appropriate action upon receiving such notification.
1.	The SN informs the MN about user data inactivity of resources owned by the SN.
2.	The MN decides to keep SN resources.
3.	After a while the SN reports resumption of user plane activity.
EN-DC with suspended RRC connection – SCG configuration released in SN
The Activity Notification function may be used to enable EN-DC with suspended RRC connected operation. The MN node may decide, after inactivity is reported from the SN and also MN resources show no activity, to send the UE to suspended RRC connection. Resumption to RRC_CONNECTED may take place after activity is reported from the SN for SN terminated bearers.
Figure 10.12.1-2: Support of Activity Notification in EN-DC with suspended RRC connection – SCG configuration released in SN
Figure 10.12.1-2 shows how Activity Notification function interacts with E-UTRAN functions for suspended RRC connection and SgNB Modification procedures in order to keep the higher layer EN-DC E-UTRAN resources established for UEs in suspended RRC connection, including S1 and X2 interface C-plane, U-plane and bearer contexts established while lower layer MCG and SCG resources are released. E-UTRAN memorises the cell group configuration for MCG in order to apply delta signalling at resume, as specified in TS 36.331 [4]. After the UE has transited successfully back to RRC_CONNECTED, lower layer SCG resources are established afterwards by means of RRC Connection Reconfiguration.
1.	The SN notifies the MN about user data inactivity for SN terminated bearers.
2.	The MN decides to send the UE to suspended RRC connection.
3/4.	The MN triggers the MN initiated SgNB Modification procedure, requesting the SN to release lower layers.
5.	The UE is sent to suspended RRC connection.
6-8.	After a period of suspended RRC connection, upon activity notification from the SN, the UE returns to RRC_CONNECTED.
8bis.	MN decides whether to reactivate the SN terminated bearers. If (e.g. due to UE mobility), MN decides not to reactivate the SN terminated bearers, it initiates the MN initiated SN release procedure and the procedure ends.
9/10.	The MN triggers the MN initiated SgNB Modification procedure to re-establish lower layers. The SN provides configuration data within an SN RRC configuration message.
11-14.	The RRC Connection Reconfiguration procedure commences.
EN-DC with suspended RRC connection - SCG configuration suspended in SN
The Activity Notification function may be used to enable EN-DC with suspended RRC connection operation. The MN node may decide, after inactivity is reported from the SN and also MN resources show no activity, to send the UE to suspended RRC connection, while keeping the SCG configuration. Resumption to RRC_CONNECTED may take place after activity is reported from the SN for SN terminated bearers.
Figure 10.12.1-3: Support of Activity Notification in EN-DC with suspended RRC connection - SCG configuration suspended in SN
Figure 10.12.1-3 shows how Activity Notification function interacts with functions for suspended RRC connection and SgNB Modification procedures in order to keep the full EN-DC resources established for UEs in suspended RRC connection. When the UE transits successfully back to RRC_CONNECTED, lower layer MCG and SCG configurations are restored or reconfigured by means of RRC Connection Resume.
1.	The SN notifies the MN about user data inactivity for SN terminated bearers.
2.	The MN decides to send the UE to suspended RRC connection.
3/4.	The MN triggers the MN initiated SN Modification procedure, requesting the SN to suspend lower layers.
5.	The UE is sent to suspended RRC connection.
6-7.	After a period of suspended RRC connection, the MN receives activity notification from the SN.
8.	The MN decides whether to reactivate the SN terminated bearers. If (e.g. due to UE mobility), the MN decides not to reactivate the SN terminated bearers, it initiates the MN initiated SN release procedure, rather than the MN initiated SN modification procedure in steps 9/10. If the MN decides to return the UE to RRC_CONNECTED, the network triggered state transition from suspended RRC connection to RRC_CONNECTED commences.
9/10.	The MN triggers the MN initiated SN Modification procedure to resume the SCG lower layers. If the SCG configuration needs to be updated, the SN provides the configuration data within an SN RRC configuration message.
11/12.	The UE is instructed to resume both the MCG and the SCG. If the SCG configuration is to be updated, the new configuration is provided in the RRCConnectionResume message.
13.	The MN informs the SN that the UE has completed the reconfiguration procedure successfully, via the SgNB Reconfiguration Complete message, including the SN RRC response message, if received from the UE.
14.	The UE performs synchronisation towards the PSCell of the SN.",TS 37.340,10.12.1,all_images/image_582.png,Support of Activity Notification in EN-DC with suspended RRC connection – SCG
"The Activity Notification function is used to report user plane activity within SN resources. It can either report inactivity or resumption of activity after inactivity was reported. In EN-DC the Activity Reporting is provided from the SN only. The MN may take further actions.
EN-DC Activity Notification
Figure 10.12.1-1: Support of Activity Notification in EN-DC
Support of Activity Notification in EN-DC is used to keep the MN informed about user traffic activity in resources owned by the SN. The MN may take appropriate action upon receiving such notification.
1.	The SN informs the MN about user data inactivity of resources owned by the SN.
2.	The MN decides to keep SN resources.
3.	After a while the SN reports resumption of user plane activity.
EN-DC with suspended RRC connection – SCG configuration released in SN
The Activity Notification function may be used to enable EN-DC with suspended RRC connected operation. The MN node may decide, after inactivity is reported from the SN and also MN resources show no activity, to send the UE to suspended RRC connection. Resumption to RRC_CONNECTED may take place after activity is reported from the SN for SN terminated bearers.
Figure 10.12.1-2: Support of Activity Notification in EN-DC with suspended RRC connection – SCG configuration released in SN
Figure 10.12.1-2 shows how Activity Notification function interacts with E-UTRAN functions for suspended RRC connection and SgNB Modification procedures in order to keep the higher layer EN-DC E-UTRAN resources established for UEs in suspended RRC connection, including S1 and X2 interface C-plane, U-plane and bearer contexts established while lower layer MCG and SCG resources are released. E-UTRAN memorises the cell group configuration for MCG in order to apply delta signalling at resume, as specified in TS 36.331 [4]. After the UE has transited successfully back to RRC_CONNECTED, lower layer SCG resources are established afterwards by means of RRC Connection Reconfiguration.
1.	The SN notifies the MN about user data inactivity for SN terminated bearers.
2.	The MN decides to send the UE to suspended RRC connection.
3/4.	The MN triggers the MN initiated SgNB Modification procedure, requesting the SN to release lower layers.
5.	The UE is sent to suspended RRC connection.
6-8.	After a period of suspended RRC connection, upon activity notification from the SN, the UE returns to RRC_CONNECTED.
8bis.	MN decides whether to reactivate the SN terminated bearers. If (e.g. due to UE mobility), MN decides not to reactivate the SN terminated bearers, it initiates the MN initiated SN release procedure and the procedure ends.
9/10.	The MN triggers the MN initiated SgNB Modification procedure to re-establish lower layers. The SN provides configuration data within an SN RRC configuration message.
11-14.	The RRC Connection Reconfiguration procedure commences.
EN-DC with suspended RRC connection - SCG configuration suspended in SN
The Activity Notification function may be used to enable EN-DC with suspended RRC connection operation. The MN node may decide, after inactivity is reported from the SN and also MN resources show no activity, to send the UE to suspended RRC connection, while keeping the SCG configuration. Resumption to RRC_CONNECTED may take place after activity is reported from the SN for SN terminated bearers.
Figure 10.12.1-3: Support of Activity Notification in EN-DC with suspended RRC connection - SCG configuration suspended in SN
Figure 10.12.1-3 shows how Activity Notification function interacts with functions for suspended RRC connection and SgNB Modification procedures in order to keep the full EN-DC resources established for UEs in suspended RRC connection. When the UE transits successfully back to RRC_CONNECTED, lower layer MCG and SCG configurations are restored or reconfigured by means of RRC Connection Resume.
1.	The SN notifies the MN about user data inactivity for SN terminated bearers.
2.	The MN decides to send the UE to suspended RRC connection.
3/4.	The MN triggers the MN initiated SN Modification procedure, requesting the SN to suspend lower layers.
5.	The UE is sent to suspended RRC connection.
6-7.	After a period of suspended RRC connection, the MN receives activity notification from the SN.
8.	The MN decides whether to reactivate the SN terminated bearers. If (e.g. due to UE mobility), the MN decides not to reactivate the SN terminated bearers, it initiates the MN initiated SN release procedure, rather than the MN initiated SN modification procedure in steps 9/10. If the MN decides to return the UE to RRC_CONNECTED, the network triggered state transition from suspended RRC connection to RRC_CONNECTED commences.
9/10.	The MN triggers the MN initiated SN Modification procedure to resume the SCG lower layers. If the SCG configuration needs to be updated, the SN provides the configuration data within an SN RRC configuration message.
11/12.	The UE is instructed to resume both the MCG and the SCG. If the SCG configuration is to be updated, the new configuration is provided in the RRCConnectionResume message.
13.	The MN informs the SN that the UE has completed the reconfiguration procedure successfully, via the SgNB Reconfiguration Complete message, including the SN RRC response message, if received from the UE.
14.	The UE performs synchronisation towards the PSCell of the SN.",TS 37.340,10.12.1,all_images/image_583.jpeg,Support of Activity Notification in EN-DC with suspended RRC connection - SCG
"The Activity Notification function is used to report user plane activity within SN resources or to report a RAN Paging Failure event to the SN. It can either report inactivity or resumption of activity after inactivity was reported. In MR-DC with 5GC the Activity Reporting is provided from the SN only. The MN may take further actions. RAN Paging Failure Reporting is provided from the MN only.
MR-DC with 5GC Activity Notification
Figure 10.12.2-1: Support of Activity Notification in MR-DC with 5GC
1.	The SN notifies the MN about user data inactivity.
2.	The MN decides further actions that impact SN resources (e.g. send UE to RRC_INACTIVE, bearer reconfiguration). In the case shown, MN takes no action.
3.	The SN notifies the MN that the (UE or PDU Session or QoS flow) is no longer inactive.
MR-DC with 5GC with RRC_INACTIVE – SCG configuration released in SN
The Activity Notification function may be used to enable MR-DC with 5GC with RRC_INACTIVE operation. The MN node may decide, after inactivity is reported from the SN and also MN resources show no activity, to send the UE to RRC_INACTIVE. Resumption to RRC_CONNECTED may take place after activity is reported from the SN for SN terminated bearers.
Figure 10.12.2-2: Support of Activity Notification in MR-DC with 5GC with RRC_Inactive – SCG configuration released in SN
Figure 10.12.2-2 shows how Activity Notification function interacts with NG-RAN functions for RRC_INACTIVE and SN Modification procedures in order to keep the higher layer MR-DC NG-RAN resources established for UEs in RRC_INACTIVE, including NG and Xn interface C-plane, U-plane and bearer contexts established while lower layer MCG and SCG resources are released. NG-RAN memorises the cell group configuration for MCG in order to apply delta signalling at resume, as specified in TS 38.331 [4]. After the UE has transited successfully back to RRC_CONNECTED, lower layer SCG resources are established afterwards by means of RRC Connection Reconfiguration.
1.	The SN notifies the MN about user data inactivity for SN terminated bearers.
2.	The MN decides to send the UE to RRC_INACTIVE.
3/4.	The MN triggers the MN initiated SN Modification procedure, requesting the SN to release lower layers.
5.	The UE is sent to RRC_INACTIVE.
6-8.	After a period of inactivity, upon activity notification from the SN, the UE returns to RRC_CONNECTED.
8bis.	MN decides whether to reactivate the SN terminated bearers. If (e.g. due to UE mobility), MN decides not to reactivate the SN terminated bearers, it initiates the MN initiated SN release procedure and the procedure ends.
9/10.	The MN triggers the MN initiated SN Modification procedure to re-establish lower layers. The SN provides configuration data within an SN RRC reconfiguration message.
11-14.	The RRC Connection Reconfiguration procedure commences.
MR-DC with 5GC with RRC_INACTIVE - SCG configuration suspended in SN
The Activity Notification function may be used to enable MR-DC with 5GC with RRC_INACTIVE operation. The MN node may decide, after inactivity is reported from the SN and also MN resources show no activity, to send the UE to RRC_INACTIVE, while keeping the SCG configuration. Resumption to RRC_CONNECTED may take place after activity is reported from the SN for SN terminated bearers.
Figure 10.12.2-3: Support of Activity Notification in MR-DC with 5GC with RRC_Inactive - SCG configuration suspended in SN
Figure 10.12.2-3 shows how Activity Notification function interacts with NG-RAN functions for RRC_INACTIVE and SN Modification procedures in order to keep the full MR-DC NG-RAN resources established for UEs in RRC_INACTIVE. When the UE transits successfully back to RRC_CONNECTED, lower layer MCG and SCG configurations are restored or reconfigured by means of RRC (Connection) Resume.
1.	The SN notifies the MN about user data inactivity for SN terminated bearers.
2.	The MN decides to send the UE to RRC_INACTIVE.
3/4.	The MN triggers the MN initiated SN Modification procedure, requesting the SN to suspend lower layers.
5.	The UE is sent to RRC_INACTIVE.
6-7.	After a period of inactivity, the MN receives activity notification from the SN.
8.	The MN decides whether to reactivate the SN terminated bearers. If (e.g. due to UE mobility), the MN decides not to reactivate the SN terminated bearers, it initiates the MN initiated SN release procedure, rather than the MN initiated SN modification procedure in steps 9/10. If the MN decides to return the UE to RRC_CONNECTED, the network triggered state transition from RRC_INACTIVE to RRC_CONNECTED commences as described in clause 9.2.2.4.2 in TS 38.300 [3].
9/10.	The MN triggers the MN initiated SN Modification procedure to resume the SCG lower layers. If the SCG configuration needs to be updated, the SN provides the configuration data within an SN RRC reconfiguration message.
11/12.	The UE is instructed to resume both the MCG and the SCG. If the SCG configuration is to be updated, the new configuration is provided in the RRC(Connection)Resume message.
13.	The MN informs the SN that the UE has completed the reconfiguration procedure successfully, via the SN Reconfiguration Complete message, including the SN RRC response message, if received from the UE.
14.	The UE performs synchronisation towards the PSCell of the SN.",TS 37.340,10.12.2,all_images/image_584.jpeg,Support of Activity Notification in MR-DC with 5GC with RRC_Inactive - SCG
"When some QoS flows are offloaded from the MN to the SN, the MN may decide to split the PDU session served by the MN into more than one NG-U tunnels. The MN sends the SN Addition/Modification Request message including UPF UL TEID address used at the MN. Later on, if the MN receives a new UL TEID in the PDU Session Resource Modify Confirm message, the MN may provide the new UL TEID to the SN.
Figure 10.14.3-1: PDU Session Split at UPF during RAN initiated PDU session resource modify (QoS flows offloading from MN to SN)
1-2.	If the MN decides to split a PDU session, it uses the SN Addition procedure or the MN-initiated SN Modification procedure, including current UPF UL NG-U tunnel used at the MN. If in-order delivery is required for some QoS flows, an UL forwarding tunnel may be setup for the PDU session at this stage.
NOTE 1:	In case the MN offloads some QoS flows to the SN within a PDU session already split between the MN and the SN, the MN initiated SN Modification procedure is used.
3-6d.	If in-order delivery is required, the SN buffers the first packets received from the UE for a certain QoS flow until it receives an GTP-U end marker packet over the UL forwarding tunnel indicating that the MN has delivered all UL packets from the source side to UPF for that QoS flow. Then the SN starts delivering UL packets to UPF for that QoS flow using the UPF UL TEID address used at the MN received at step 1.
7-8.	The MN uses the PDU Session Resource Modify Indication message to inform 5GC that the PDU session is split into two tunnels and indicate which QoS flows are associated with which DL tunnel. The 5GC triggers the sending of DL End Marker packets without QFI tag at step 7a and confirms with the PDU Session Resource Modify Confirm message and allocates corresponding uplink tunnels.
After receiving the End Marker packet(s) from UPF at step 7a, the MN determines that the End Marker packets only work on the offloaded QoS flows, and may stop delivering and discard DL packets of the offloaded QoS flows, and the MN shall continue transmiting DL packets for the not offloaded QoS flows, if any.
7a./7b.	After receiving the DL end marker from 5GC at step 7a, the MN may generate at step 7b DL End Marker packets without QFI tag towards the SN.
9-10.	If the MN receives a new UL TEID in the PDU Session Resource Modify Confirm message for itself, the MN will use it to deliver UL packets to UPF. If the MN receives a new UL TEID for the SN, then the MN-initiated SN Modification procedure (i.e., step 9 and step 10) is used to provide the new UL TEID to the SN and then the SN switches to use the new UL TEID to deliver UL packets.
10.14.4	PDU Session Split at UPF (RAN initiates QoS flows offloading from SN to MN)
When some QoS flows are offloaded from the SN to the MN, the MN may decide to split the PDU session served by the SN into more than one NG-U tunnels. If the MN requests to offload, the MN sends the SN Modification Request message to the SN. In case the SN requests to offload, the SN sends the SN Modification Required message to the MN.
Figure 10.14.4-1: PDU Session Split at UPF during RAN initiated PDU session resource modify (QoS flows offloading from SN to MN)
1a-1c.	When the MN requests to offload some QoS flows from the SN to the MN for a PDU session, it sends the SN Modification Request message. If in-order delivery is required for some of the QoS flows, an UL forwarding tunnel may be setup for the PDU session at this stage and the MN provides the UL forwarding tunnel address information in the Xn-U Address Indication message.
2a-2b.	When the SN requests to offload some QoS flows to the MN for a PDU session, the SN sends the SN Modification Required message. If in-order delivery is required for some of the QoS flows, an UL forwarding tunnel may be setup for the PDU session at this stage and the MN provides the UL forwarding tunnel address information in the SN Modification Confirm message.
3-6d.	If in-order delivery is required, the MN buffers the first packets received from the UE for a certain QoS flow until it receives an GTP-U end marker packet over the UL forwarding tunnel indicating that the SN has delivered all UL packets from the source side to UPF for that QoS flow.
7-8.	The MN uses the PDU Session Resource Modify Indication message to inform 5GC that the PDU session is split into two tunnels and indicate which QoS flows are associated with which DL tunnel. The 5GC triggers the sending of DL End Marker packets without QFI tag at step 7a and confirms with the PDU Session Resource Modify Confirm message and allocates corresponding uplink tunnels.
After receiving the End Marker packet(s) from UPF at step 7a, the SN determines that the End Marker packets only work on the offloaded QoS flows, and may stop delivering and discard DL packets of the offloaded QoS flows, and the SN shall continue transmiting DL packets for the not offloaded QoS flows, if any.
7a./7b.	After receiving the DL end marker from 5GC at step 7a, the SN may generate at step 7b DL End Marker packets without QFI tag towards the MN.
9-10.	If the MN receives a new UL TEID in the PDU Session Resource Modify Confirm message for itself, the MN will use it to deliver UL packets to UPF. If the MN receives a new UL TEID for the SN, then the MN-initiated SN Modification procedure (i.e., the step 9 and step 10) is used to provide the new UL TEID to the SN and then the SN switches to use the new UL TEID to deliver UL packets.",TS 37.340,10.14.3,all_images/image_585.jpeg,PDU Session Split at UPF during RAN initiated PDU session resource modify (QoS
"Inter-system handover from EPS to 5GS with the Secondary Node used as target refers to a deployment scenario where the source en-gNB and the target gNB are realised within the same network entity.
Figure 10.16.2-1: Inter-system handover from EPS to 5GS with the Secondary Node used as target
-	Step 1: The (source) eNB, performing EN-DC with the (source) en-gNB triggers handover preparation including the SgNB UE X2AP ID within the Source NG-RAN to Target NG-RAN Transparent Container.
-	Step 2: The target gNB infers from the received SgNB UE X2AP ID in the Handover Request message that direct data forwarding can be performed in a node-internal way.
-	Step 3: DL UP data is forwarded in a node-internal way for the SN terminated bearers.
-	Step 4: After the end marker has arrived from the SGW, the (target) gNB processes UP data from the UPF.",TS 37.340,10.16.2,all_images/image_586.jpeg,Inter-system handover from EPS to 5GS with the Secondary Node used as target
"Inter-system handover from 5GS to EPS with the Source Node used as target Secondary Node refers to a deployment scenario where the source gNB and the target en-gNB are realised within the same network entity.
Figure 10.16.3-1: Inter-system handover from 5GS to EPS with the Source Node used as target Secondary Node
1.	The (source) gNB triggers handover preparation phase including in the Source eNB to Target eNB Transparent Container the Source NG-RAN node ID and the RAN UE NGAP ID.
2.	The target eNB receives the Source NG-RAN node ID and the RAN UE NGAP ID in the Source eNB to Target eNB Transparent Container.
3.-4. The X2AP SgNB Addition procedure is performed towards the (target) en-gNB indicated in the Source NG-RAN node ID received in step 2. The eNB includes the RAN UE NGAP ID received in step 2 in the X2 SgNB Addition Request message.
5.-8. Handover proceeds.
9.	DL UP data is forwarded in a node-internal way for the SN terminated bearers.",TS 37.340,10.16.3,all_images/image_587.jpeg,Inter-system handover from 5GS to EPS with the Source Node used as target
"Inter-MN RRC Resume without MN initiated SN change is used to transfer UE context data from a source MN to a target MN while the UE context at the SN is kept. During the procedure, the target MN may decide not to keep the SN.
Figure 10.17.1-1: Inter-MN RRC Resume without MN initiated SN change procedure
Figure 10.17.1-1 shows an example signalling flow for inter-MN RRC Resume without MN initiated SN change:
1.	The UE resumes from RRC_INACTIVE, providing the I-RNTI, allocated by the source MN, i.e., the last serving NG-RAN node.
2.	The target MN, if able to resolve the NG-RAN node identity contained in the I-RNTI, requests the source MN to provide UE Context by initiating the Xn Retrieve UE Context procedure.
3.	If the verification is successful, the source MN provides UE context data. The source MN includes the SN UE XnAP ID, SN ID and the UE context in the SN in the Retrieve UE Context Response message.
NOTE 1:	The source MN may trigger the MN-initiated SN Modification procedure (to the SN) to retrieve the current SCG configuration and to allow provision of data forwarding related information before step 3.4a.	If the target MN decides to keep the SN, the target MN sends SN Addition Request to the SN including the SN UE XnAP ID as a reference to the UE context in the SN that was established by the source MN.
4b.	The SN replies with SN Addition Request Acknowledge message.
4c.	For SN terminated bearers using MCG resources, the target MN provides Xn-U DL TNL address information in the Xn-U Address Indication message.
5/6.	The target MN and UE complete the resumption of the RRC connection.
7.	If configured with bearers requiring SCG radio resources, the UE synchronizes to the SN.
NOTE 2:	The order the UE sends the RRCResumeComplete message towards the target MN (step 6) and performs the Random Access procedure towards the SN (step 7) is not defined.
8.	If the RRC connection reconfiguration procedure was successful, the target MN informs the SN via SN Reconfiguration Complete message.
9.	If the RRC connection reconfiguration procedure was successful, the target MN initiates the Xn Retrieve UE Context Confirm procedure and indicates to the source MN whether the UE context in the SN is kept or not.
10.	The Xn-U Address Indication procedure may be invoked by the target MN to provide forwarding address information if loss of DL user data buffered in the source side needs to be avoided.
11a/11b.	The source MN sends SN Release Request message to the SN including a Cause indicating MCG mobility. The SN acknowledges the release request. The source MN indicates to the SN that the UE context in the SN is kept, if it receives the indication from the target MN. If the indication as the UE context kept in the SN is included, the SN keeps the UE context.
11c.	If received in step 10, the source MN sends the Xn-U Address Indication message to the SN to transfer data forwarding information. More than one data forwarding addresses may be provided if the PDU session is split in the target side.
12.	If applicable, data forwarding takes place from the source side. If the SN is kept, data forwarding may be omitted for SN terminated bearers or QoS flows kept in the SN.
13-16.	The target MN initiates the Path Switch procedure. If the target MN includes multiple DL TEIDs for one PDU session in the Path Switch Request message, multiple UL TEID of the UPF for the PDU session should be included in the Path Switch Ack message in case there is TEID update in UPF.
NOTE 3:	If new UL TEIDs of the UPF for SN terminated bearers are included, the target MN performs MN initiated SN Modification procedure to provide them to the SN.
17.	The target MN initiates the UE Context Release procedure towards the source MN.
18.	Upon reception of the UE Context Release message from source MN, the SN releases C-plane related resources associated to the UE context towards the source MN. Any ongoing data forwarding may continue. The SN shall not release the UE context associated with the target MN if the UE context kept indication was included in the SN Release Request message in step 11.",TS 37.340,10.17.1,all_images/image_588.jpeg,Inter-MN RRC Resume without MN initiated SN change procedure
"The Conditional Handover with Secondary Node procedure is used for configuration and execution of CHO with SN. This procedure includes the cases where the SN is kept, changed or added. If the SN is kept, the UE context at the SN is kept. If the SN is changed, the UE context at the source SN is moved to the target SN.
Figure 10.19.1-1: Conditional Handover with Secondary Node procedure
Figure 10.19.1-1 shows an example signaling flow for Conditional Handover with Secondary Node.
NOTE 1:	For a CHO without SN change, the source SN and the target SN shown in Figure 10.19.1-1 are the same node.
NOTE 2:	For a CHO with SN addition, the source SN and steps involving the source SN in Figure 10.19.1-1 are ignored.
1.	The source MN starts the conditional handover procedure by initiating the X2 Handover Preparation procedure including MCG configuration and, if the UE is configured with an SCG, SCG configuration. The source MN may include the (source) SN UE X2AP ID, SN ID, the UE context in the (source) SN and the Conditional Handover Information Request IE in the Handover Request message.
NOTE 3:	In case of the CHO with/without SN change, the source MN may trigger the MN-initiated SN Modification procedure (to the source SN) to retrieve the current SCG configuration, if configured, before step 1.
2.	If the candidate MN decides to keep the UE context in the SN, the candidate MN sends the SgNB Addition Request message to the SN including the SN UE X2AP ID as a reference to the UE context in the SN that was established by the source MN. If the candidate MN decides to change the SN allowing delta configuration, the candidate MN sends the SgNB Addition Request message to the candidate SN including the UE context in the source SN that was established by the source MN. Otherwise, the candidate MN may send the SgNB Addition Request message to the candidate SN including neither the SN UE X2AP ID nor the UE context in the source SN that was established by the source MN. Within the SgNB Addition Request message, the candidate MN also includes the CHO related information, i.e., the source MN ID and the MN UE X2AP ID in the source MN, in order to indicate that the SgNB Addition Preparation procedure is triggered in relation to a CHO and to enable the SN to identify requests related to the same UE.
NOTE 3a:	The target MN and other potential target MNs may trigger the SgNB Addition Preparation procedure to the same (target) SN.
NOTE 3b:	The source MN may initiate additional X2 Handover Preparation procedures towards the same or other target MNs. Based on each X2 Handover Preparation procedure, each target MN may decide to trigger SgNB Addition Preparation procedure.
3.	The (candidate) SN replies with the SgNB Addition Request Acknowledge message. The (candidate) SN may include the indication of full or delta RRC configuration.
NOTE 4:	In CHO with SCG configuration, it is up to the candidate MN implementation to make sure that the CG-Config provided from the (candidate) SN can be used in all CHO preparations.
4.	The candidate MN includes within the Handover Request Acknowledge message a transparent container to be sent to the UE as an RRC message to perform the conditional handover, and may also provide forwarding addresses to the source MN. The candidate MN indicates to the source MN that the UE context in the SN is kept if the candidate MN and the SN decided to keep the UE context in the SN in step 2 and step 3.
NOTE 4a0:	Steps 1-4 may be produced in several instances, each instance initiated with a separate Handover Preparation procedure (step 1). The order of messages belonging to separate instances is not defined.
4a.	The source MN sends the Data Forwarding Address Indication message to the (source) SN. This Data Forwarding Address Indication message notifies conditional handover to the (source) SN, which may decide to perform, if applicable, early data forwarding for SN-terminated bearers, together with the sending of an Early Status Transfer message to the source MN.
NOTE 4a:	Separate Data Forwarding Address Indication procedures may be initiated to provide different forwarding addresses of the prepared conditional handovers. In this case, it is up to the source MN and SN implementations to make sure that the Early Status Transfer message(s) from the source SN, if any, is forwarded to the right target MN. The Data Forwarding Address Indication procedure may further be initiated to indicate to the (source) SN to stop already initiated early data forwarding for some SN-terminated bearers, if they are no longer subject to data forwarding due to the modification or cancellation of the prepared conditional handovers.
5.	The source MN sends an RRCConnectionReconfiguration message to the UE, including the CHO configuration, i.e. a list of RRCConnectionReconfiguration* messages and associated execution conditions, in which each RRCConnectionReconfiguration* message contains an MCG configuration and possibly an SCG configuration in the RRCReconfiguration** message received from the candidate SN in step 3.
6.	The UE applies the RRCConnectionReconfiguration message received in step 5, stores the CHO configuration and replies to the MN with an RRCConnectionReconfigurationComplete message.
7/8. The UE maintains connection with the source MN and, if the UE is configured with a PSCell, with the source PSCell, after receiving CHO configuration, and starts evaluating the CHO execution condition for the candidate cell(s). If at least one CHO candidate cell satisfies the corresponding CHO execution condition, the UE detaches from the source MN, applies the stored corresponding configuration for that selected candidate cell, synchronises to that candidate cell and completes the RRC handover procedure by sending RRCConnectionReconfigurationComplete* message to the target MN. If the stored configuration for the selected candidate cell includes an SCG configuration, the UE includes an embedded SN RRCReconfigurationComplete** message for the target SN. The UE releases stored CHO configurations after successful completion of RRC handover procedure.
NOTE 5:	In case the target SN includes the indication of full RRC configuration, the MN performs release of the SN terminated radio bearer configuration and release and add of the NR SCG configuration part towards the UE.
9.	If configured with bearers requiring SCG radio resources, the UE synchronizes to the (target) SN.
NOTE 6:	The order the UE performs Random Access towards the MN (step 7) and performs the Random Access procedure towards the (target) SN (step 9) is not defined.
10.	If the RRC connection reconfiguration procedure was successful, the target MN informs the (target) SN via SgNB Reconfiguration Complete message.
11.	The target MN sends the Handover Success message to the source MN to inform that the UE has successfully accessed the target cell.
12a/b.	The source MN sends SgNB Release Request message to the (source) SN including a Cause indicating MCG mobility and, if applicable, data forwarding information. The source MN indicates to the (source) SN that the UE context in SN is kept, if it receives the indication from the target MN. The (source) SN acknowledges the release request.
12c.	The source MN sends the Handover Cancel message toward the other signalling connections or other candidate MNs, if any, to cancel CHO for the UE.
12d/e.	If the target MN is configured with other candidate PCell(s) associated with other candidate SN(s) than the target SN, the target MN sends the SgNB Release Request message(s) to the corresponding candidate SN(s). Other candidate MN(s) send(s) the SgNB Release Request message(s) to other candidate SN(s), if configured. The other candidate SN(s) acknowledges the release request.
13a.	The (source) SN sends the Secondary RAT Data Usage Report message to the source MN and includes the data volumes delivered to and received from the UE over the NR radio for the related E-RABs.
NOTE 7:	The order the source SN sends the Secondary RAT Data Usage Report message and performs data forwarding with MN/target SN is not defined. The SgNB may send the report when the transmission of the related bearer is stopped.
13b.	The source MN sends the Secondary RAT Data Usage Report message to MME to provide information on the used NR resource.
14.	For bearers using RLC AM, the source MN sends the SN Status Transfer message, including, if needed, SN Status received from the source SN to the target MN. The target MN forwards the SN Status to the target SN, if needed.
15.	If applicable, data forwarding takes place from the source side (i.e. source MN or source SN). If the SN is kept, data forwarding may be omitted for SN-terminated bearers kept in the SN.
16-19.	The target MN initiates the S1 Path Switch procedure.
NOTE 8:	If new UL TEIDs of the S-GW are included, the target MN performs the MN initiated SN Modification procedure to provide them to the SN.
20.	The target MN initiates the UE Context Release procedure towards the source MN.
21.	Upon reception of the UE Context Release message, the (source) SN releases C-plane related resources associated to the UE context towards the source MN. Any ongoing data forwarding may continue. The SN shall not release the UE context associated with the target MN if the UE context kept indication was included in the SgNB Release Request message in step 12a.",TS 37.340,10.19.1,all_images/image_589.jpeg,Conditional Handover with Secondary Node procedure
"The assumption of the two-stage MIMO OTA method is that the measured far field antenna pattern of the DUT's multiple antennas can fully capture the mutual coupling of the multiple antenna arrays and their influence on radiated performance. 
Thus to do the two-stage MIMO OTA test, the antenna patterns of the antenna array needs to be measured accurately in the first stage. In order to accurately measure the antenna pattern of the intact device, the chipset needs to support amplitude and relative phase measurements of the antennas. To achieve this, two new UE measurements have been defined called Reference Signal Antenna Power (RSAP) and Reference Signal Relative Antenna Phase (RSARP). These measurements are defined in TR 36.978 [20].
Stage 1: The measurement of the DUT’s multiple antennas takes place in a traditional anechoic chamber set up as described in Annex A.2 in [4], where the DUT is put into the chamber and each antenna element's complex far zone pattern is measured using the RSAP and RSARP measurements defined in [20]. The influence of human body loss can also be measured by attaching the DUT to a SAM head and or hand phantom when doing the antenna pattern measurements. The characteristics of the SAM phantom are specified in Annex A.1 of [4]. The chamber is equipped with a positioner, that makes it possible to perform full 3-D far zone pattern measurements for both Tx and Rx radiated performance. As specified in A.2 of [4] the measurement antenna shall be able to measure two orthogonal polarizations (typically linear theta () and phi () polarizations as shown in Figure 6.3.1.3.1-1).
Figure 6.3.1.3.1-1: The coordinate system used in the measurements
Stage 2: Convolve the antenna patterns measured in stage 1 with the chosen MIMO channel model, using a channel emulator and then use the resulting signal to perform the OTA throughput test. The signal is coupled into the DUT using either a cabled or radiated connection.
The two-stage method is illustrated in Figure 6.3.1.3.1-2. In the conducted two-stage method shown in Figure 6.3.1.3.1-2 the BS emulator is connected to the MIMO channel emulator and then to the DUT’s temporary antenna ports via approved RF cables. These ports are the standard ones provided for conducted conformance tests. The alternative to using a conducted connection is to use a calibrated radiated connection in an anechoic environment as shown in Figure 6.3.1.3.1-3 is the radiated two-stage (RTS) method. This coupling technique exploits the Eigen modes of the transmission channel in the anechoic chamber to provide isolated radiated connections between the probe antennas and each DUT receiver after the DUT antenna. Throughput with the DUT’s MIMO antenna influence can be measured using either coupling method. However, only the radiated coupling method intrinsically includes the effects of DUT self-interference and is the method defined for conformance testing in Clause 12.
There are two different approaches to convolve the DUT antenna patterns with MIMO channel model.
a) 	Apply antenna patterns to geometric (Ray-based) channel models. Ray-based models support arbitrary antenna patterns under predefined channel modes in a natural way as described above. If Ray-based models like SCME are specified to be used for MIMO OTA testing, then the channel emulator needs to support SCME channel model emulation and convolution with the measured antenna patterns.
b) 	Apply antenna patterns to correlation-based channel models. With a correlation matrix calculation method for arbitrary antenna patterns under multipath channel conditions, the correlation matrix and the antenna imbalance can be calculated and then emulated by the channel emulator.
Figure 6.3.1.3.1-2: Proposed conducted two-stage test methodology for MIMO OTA test
An example implementation of the radiated method of connecting to the EUT in the second stage is shown in Figure 6.3.1.3.1-3.
Figure 6.3.1.3.1-3: Alternative connection for the radiated two-stage (RTS) test methodology for MIMO OTA test
Figure 6.3.1.3.1-3 shows the radiated coupling method for the second stage. Two probe antennas with polarization V and H are co-located in the anechoic chamber. Note, unlike in the first stage where the V and H probes are used at different times, in the second stage both V and H probes are used simultaneously. An example implementation of this would be the dual polarized configuration described in Annex A.2.2 of [4]. The only difference between the conducted second stage and the radiated second stage  is to replace the RF cables with the radiated channel inside the chamber. Due to the propagation channel in the chamber, signals transmitted from each probe antenna are received by both DUT antennas which is different from the cable conducted case where the signals are isolated by the cables. However, by precoding the transmitted signals using spatial multiplexing techniques it is possible by calculating the radiated channel matrix and by applying its inverse to the transmitted signals, to create an identity matrix allowing the transmitted signals to be received independently at each DUT receiver after the DUT antenna. This precoding recreates the equivalent of the isolated cable conducted conditions at the receiver but but with radiated self-interference now included.
The establishment of the radiated connection is explained as follows. Assume and are the transmitted signals from the base station emulator, after applying the desired channel model and convolution with the complex antenna pattern we get:
and .
The radiated channel matrix between the probe antennas and the DUT antennas is  .
If the channel emulator applies the inverse of the radiated channel matrix  to   and , the signal received after the DUT antennas is same as the cable-conducted method as follows:
The above example of RTS using two probe antennas is applicable to UE with two Rx antennas. For UE with > 2 Rx antennas, the RTS method is FFS.",TR 37.977,6.3.1.3.1,all_images/image_591.jpeg,Proposed conducted two-stage test methodology for MIMO OTA test
"In this method an assessment of the antenna's performance in MIMO or Diversity operation is performed. Several simplifications are used in order to optimise the testing.
A test of the UE in an anechoic environment with the help of a base station emulator is proposed, with a limited number of faded channels and transmitting antennas, and in a simple geometrical set-up.
The underlying principle is to decompose the task for evaluating MIMO performance. It combines the radiated measurements in the anechoic chamber where no fading is applied with conducted measurements with fading. The total performance of the UE is decomposed into these two steps, and therefore we name it decomposition approach. Figure 6.3.1.4.1-1 illustrates this approach.
Figure 6.3.1.4.1-1: Diagram of decomposition approach for 2x2 LTE MIMO",TR 37.977,6.3.1.4.1,all_images/image_592.jpeg,Diagram of decomposition approach for 2x2 LTE MIMO
"To determine the throughput results for the overall MIMO device performance, the following key measurements are needed, as shown in Figure 6.3.1.4.2-1:
-	Baseline: the conducted measurement with channel model of the identity matrix
-	Conducted: the conducted measurement with the real-world channel model
-	Radiated: the average of the radiated measurements for a set of antenna constellations
Figure 6.3.1.4.2-1: Key measurements for Decomposition Approach
From these measurements, the receiver MIMO efficiency and the antenna MIMO efficiency are determined as illustrated in Figure 6.3.1.4.2-2. The receiver MIMO efficiency is defined as the difference between the baseline conducted test and the conducted test with dynamic fading as a function of throughput, Figure 6.3.1.4.2-2 (a). 
Similarly, the antenna MIMO efficiency is defined as the difference between the baseline conducted test and the radiated test for all throughput levels, Figure 6.3.1.4.2-2 (b)
(a)


(b)
Figure 6.3.1.4.2-2: Definition of (a) receiver MIMO and b) antenna MIMO efficiencies
The relative Figure Of Merit (FOM) for the UE MIMO performance is subsequently defined as the UE MIMO efficiency that is the sum of the receiver and antenna MIMO efficiencies. By adding this efficiency to the baseline throughput curve, the absolute FOM for the UE MIMO performance, i.e., decomposed throughput curve as a function of DL power level, can be obtained as shown in 6.3.1.4.2-3.
Figure 6.3.1.4.2-3: Illustration of the decomposed throughput curve calculation",TR 37.977,6.3.1.4.2,all_images/image_593.jpeg,Definition of (a) receiver MIMO and b) antenna MIMO efficiencies
"This measurement checks that the resulting Power Delay Profile (PDP) is like defined in the channel model.
Method of measurement:
Step the emulation and store traces from VNA. I.e. run the emulation to CIR number 1, pause, measure VNA trace, run the emulation to CIR number 10, pause, measure VNA trace. Continue until 1000 VNA traces are measured.
VNA settings:
Table 8.3.2.1-1: VNA settings for PDP
Channel model specification:
Table 8.3.2.1-2: Channel model specification for PDP
Method of measurement result analysis:
Measured VNA traces (frequency responses H(t,f)) are saved into a hard drive. The data is read into, e.g., Matlab. 
The analysis is performed by taking the Fourier transform of each FR. The resulting impulse responses h(t,tau) are averaged in power over time:
Finally the resulting PDP is shifted in delay, such that the first tap is on delay zero. The reference PDP plots from Table 8.2-1 and Table 8.2-2 are shown in Figure 8.3.2.1-1.
OTA antenna configuration: 		For e.g. 1 full ring (or single cluster configuration) of V polarized elements.
Measurement antenna: 			For e.g. Vertically oriented sleeve dipole.
Figure 8.3.2.1-1: Reference PDP values for SCME Urban Macro / SCME Urban Micro
 plotted from Table 8.2-1 and Table 8.2-2
Method of measurement for RTS:
The vector signal generator repeatedly generates the Zadoff-Chu sequence as defined in Table 8.3.2.1-3. After a given time interval, the spectrum analyser or scope is triggered by the vector signal generator at the beginning of the next Zadoff-Chu sequence. The time interval needs to exceed the required minimum distance between two PDPs as defined in Table 8.3.2.1-4 and depends on the centre frequency and the mobile speed.
After receiving the trigger signal, the spectrum analyser or scope starts with the acquisition of the IQ data. The number of recorded IQ samples corresponds to the length of the used Zadoff-Chu sequence. This step is repeated until at least 1000 blocks of IQ samples are recorded.
Vector signal generator settings:
Table 8.3.2.1-3: PDP measurement parameters for signal generator
Signal and spectrum analyser settings:
Table 8.3.2.1-4: PDP measurement parameters for spectrum analyser
The channel model specifications match those from Table 8.3.2.1-2.
Method of measurement result analysis:
The measured blocks of IQ samples are saved and later analysed by a post processing SW, e.g., Matlab. The analysis is performed by applying the circular cross-correlation between each recorded block of IQ samples and the IQ samples of the original Zadoff-Chu sequence. The resulting impulse responses h(t,tau) are averaged in power over time:
Finally the resulting PDP is shifted in delay and normalized in power, such that the first tap is on delay zero and has a relative power of 0 dB.
Antenna configurations: 	For e.g. a pair of vertically oriented sleeve dipoles or vertically polarized horn antennas.",TR 37.977,8.3.2.1,all_images/image_595.jpeg,Reference PDP values for SCME Urban Macro / SCME Urban Micro
"This measurement checks the Doppler/temporal correlation.
Method of measurement:
Sine wave (CW, carrier wave) signal is transmitted from the signal generator. The signal is connected from the signal generator to fading emulator via cables. The fading emulator output signals are connected to power amplifier boxes via cables. The amplified signals are then transferred via cables to the probe antennas. The probe antennas radiate the signals over the air to the test antenna The Doppler spectrum is measured by the spectrum analyzer and the trace is saved.
Signal generator settings:
Table 8.3.2.2-1: Signal generator settings for Doppler/Temporal correlation
Spectrum analyzer settings:
Table 8.3.2.2-2: Spectrum analyzer settings for Doppler/Temporal correlation
Channel model specification:
Table 8.3.2.2-3: Channel model specification for Doppler/Temporal correlation
Method of measurement result analysis: Measurement data file (Doppler power spectrum) is saved into hard drive. 
The data is read into, e.g., Matlab. 
The analysis is performed by taking the Fourier transformation of the Doppler spectrum. 
The resulting temporal correlation function   is normalized such that . 
Then the function values left from the maximum is cut out. 
Further on the function values after, e.g. seven periods is cut out. 
The reference temporal correlation plots from Table 8.2-1 and 8.2-2 are shown in Figure 8.3.2.2-1 and Figure 8.3.2.2-2.
OTA antenna configuration: 		For e.g. 1 full ring (or single cluster configuration) of V polarized elements.
Measurement antenna: 			For e.g. vertically oriented dipole.
Figure 8.3.2.2-1: Reference Temporal Correlation Functions for SCME Urban Macro (left)
 and SCME Urban Micro (right) plotted from Table 8.2-1 and Table 8.2-2
Figure 8.3.2.2-2: Reference Temporal Correlation Function for correlation implementation of
 SCME UMa and UMi with Jake's Doppler spectrum plotted from Table 8.2-1 and Table 8.2-2",TR 37.977,8.3.2.2,all_images/image_597.jpeg,Reference Temporal Correlation Functions for SCME Urban Macro (left)
"The power delay profiles of the SCME UMi channel model specified in Clause 8.2 has been measured according to the procedures in 8.3.2.1. Figure 8.4.1-1a below illustrates the measured results for Band 13, and Band 7.
Figure 8.4.2-1: Void
(a)  (b)
(c)  (d)
(e)  (f)
Figure 8.4.2-1a: For MPAC system 1, CE 1 (a) and CE 2 (b) PDP verification measurement for Band 13; for MPAC system 1, CE 1 (c) CE 2 (d) PDP verification measurement for Band 7; For MPAC system 2, PDP verification measurements for Band 13 (e) and Band 7 (f).
Table 8.4.2-1a below summarizes the PDP verification results.
Table 8.4.2-1: Void
Table 8.4.2-1a: Summary of PDP verification results at Band 13, and Band 7 from MPAC system providers
The results for the RTS method with geometric implementation are shown in Figure 8.4.2-2 for System 1 with CE1 for Band 13, in Figure 8.4.2-2a for System 2 with CE2 for Band 13, and in in Figure 8.4.2-2b for System 2 with CE2 for Band 7.
Figure 8.4.2-2: SCMe UMa and UMi PDP verification measurement
 for the RTS method with geometric implementation for System 1 with CE1 for Band 13
Figure 8.4.2-2a: SCMe UMa and UMi PDP verification measurement
 for the RTS method with geometric implementation for System 2 with CE2 for Band 13
Figure 8.4.2-2b: SCMe UMa and UMi PDP verification measurement
 for the RTS method with geometric implementation for System 2 with CE2 for Band 7
The results for the RTS method with correlation implementation (Jake’s Doppler spectrum) are shown in Figures 8.4.2-3 to 8.4.2-3b:
Figure 8.4.2-3: SCMe UMa and UMi PDP verification measurement
 for the RTS method with correlation implementation (Jake's Doppler spectrum) for System 1 with CE1 for Band 13
Figure 8.4.2-3a: SCMe UMa and UMi PDP verification measurement
 for the RTS method with correlation implementation (Jake's Doppler spectrum) for System 2 with CE2 for Band 13
Figure 8.4.2-3b: SCMe UMa and UMi PDP verification measurement
 for the RTS method with correlation implementation (Jake's Doppler spectrum) for System 2 with CE2 for Band 7
The summarized results can be found in Tables 8.4.2-2 to 8.4.2-3b:
Table 8.4.2-2: Summary of PDP verification results at Band 13 for the RTS method with geometric implementation for System 1 with CE1 for Band 13
Table 8.4.2-2a: Summary of PDP verification results at Band 13 for the RTS method with geometric implementation for System 2 with CE2 for Band 13
Table 8.4.2-2b: Summary of PDP verification results at Band 13 for the RTS method with geometric implementation for System 2 with CE2 for Band 7
Table 8.4.2-3: Summary of PDP verification results for the RTS method  with correlation implementation (Jake's Doppler spectrum) for System 1 with CE1 for Band 13
Table 8.4.2-3a: Summary of PDP verification results for the RTS method  with correlation implementation (Jake's Doppler spectrum) for System 2 with CE2 for Band 13
Table 8.4.2-3b: Summary of PDP verification results for the RTS method  with correlation implementation (Jake's Doppler spectrum) for System 2 with CE2 for Band 7",TR 37.977,8.4.2,all_images/image_598.jpeg,SCMe UMa and UMi PDP verification measurement
"The Doppler spread and temporal correlation of the SCME UMi channel model defined in clause 8.2 has been characterized according to clause 8.3.2.2. Figure 8.4.3-1a below illustrates the measured results for Band 13, and Band 7.. Figure 8.4.3-1: Void. (a)  (b). (c)  (d). (e)  (f). Figure 8.4.3-1a: For MPAC system 1, CE 1 (a) and CE 2 (b) temporal correlation measurements for Band 13; for MPAC system 1, CE 1 (c) CE 2 (d) temporal correlation measurements for Band 7; For MPAC system 2, temporal correlation measurements for Band 13 (e) and Band 7 (f). Figure 8.4.3-2: Void. Figure 8.4.3-3: Void. The temporal correlation results for the RTS method using the geometric implementation are shown in Figures 8.4.3-4 to 8.4.3-4b:. Figure 8.4.3-4: Temporal correlation measurements of SCMe UMa and UMi
 for the RTS method with geometric implementation for System 1 with CE1 for Band 13. Figure 8.4.3-4a: Temporal correlation measurements of SCMe UMa and UMi
 for the RTS method with geometric implementation for System 2 with CE2 for Band 13. Figure 8.4.3-4b: Temporal correlation measurements of SCMe UMa and UMi
 for the RTS method with geometric implementation for System 2 with CE2 for Band 7. The temporal correlation results for the radiated two-stage method using correlation implementation of SCME (Jake's Doppler spectrum) are shown in Figures 8.4.3-5 to 8.4.3-5b:. Figure 8.4.3-5: Temporal correlation measurements for the radiated two-stage method using correlation implementation of SCME UMa and UMi with with correlation implementation (Jake's Doppler spectrum) for System 1 with CE1 for Band 13. Figure 8.4.3-5a: Temporal correlation measurements for the radiated two-stage method using correlation implementation of SCME UMa and UMi with with correlation implementation (Jake's Doppler spectrum) for System 2 with CE2 for Band 13. Figure 8.4.3-5b: Temporal correlation measurements for the radiated two-stage method using correlation implementation of SCME UMa and UMi with with correlation implementation (Jake's Doppler spectrum) for System 2 with CE2 for Band 7",TR 37.977,8.4.3,all_images/image_606.jpeg,Temporal correlation measurements of SCMe UMa and UMi
"The Doppler spread and temporal correlation of the SCME UMi channel model defined in clause 8.2 has been characterized according to clause 8.3.2.2. Figure 8.4.3-1a below illustrates the measured results for Band 13, and Band 7.. Figure 8.4.3-1: Void. (a)  (b). (c)  (d). (e)  (f). Figure 8.4.3-1a: For MPAC system 1, CE 1 (a) and CE 2 (b) temporal correlation measurements for Band 13; for MPAC system 1, CE 1 (c) CE 2 (d) temporal correlation measurements for Band 7; For MPAC system 2, temporal correlation measurements for Band 13 (e) and Band 7 (f). Figure 8.4.3-2: Void. Figure 8.4.3-3: Void. The temporal correlation results for the RTS method using the geometric implementation are shown in Figures 8.4.3-4 to 8.4.3-4b:. Figure 8.4.3-4: Temporal correlation measurements of SCMe UMa and UMi
 for the RTS method with geometric implementation for System 1 with CE1 for Band 13. Figure 8.4.3-4a: Temporal correlation measurements of SCMe UMa and UMi
 for the RTS method with geometric implementation for System 2 with CE2 for Band 13. Figure 8.4.3-4b: Temporal correlation measurements of SCMe UMa and UMi
 for the RTS method with geometric implementation for System 2 with CE2 for Band 7. The temporal correlation results for the radiated two-stage method using correlation implementation of SCME (Jake's Doppler spectrum) are shown in Figures 8.4.3-5 to 8.4.3-5b:. Figure 8.4.3-5: Temporal correlation measurements for the radiated two-stage method using correlation implementation of SCME UMa and UMi with with correlation implementation (Jake's Doppler spectrum) for System 1 with CE1 for Band 13. Figure 8.4.3-5a: Temporal correlation measurements for the radiated two-stage method using correlation implementation of SCME UMa and UMi with with correlation implementation (Jake's Doppler spectrum) for System 2 with CE2 for Band 13. Figure 8.4.3-5b: Temporal correlation measurements for the radiated two-stage method using correlation implementation of SCME UMa and UMi with with correlation implementation (Jake's Doppler spectrum) for System 2 with CE2 for Band 7",TR 37.977,8.4.3,all_images/image_610.png,Temporal correlation measurements for the radiated two-stage method using
"The spatial correlation properties of the SCME UMi channel model defined in clause 8.2 has been characterized according to clause 8.3.2.3. Figure 8.4.4-1a below illustrates the measured results for Band 13, and Band 7.
Figure 8.4.4-1: Void
(a)  (b)
(c)  (d)
(e)  (f)
Figure 8.4.4-1a: For MPAC system 1, CE 1 (a) and CE 2 (b) spatial correlation measurements for Band 13; for MPAC system 1, CE 1 (c) CE 2 (d) spatial correlation measurements for Band 7; For MPAC system 2, spatial correlation measurements for Band 13 (e) and Band 7 (f)
Figure 8.4.4-2: Void
Figure 8.4.4-3: Void
The spatial correlation results for the RTS method using correlation implementation of SCME (Jake's Doppler spectrum) are shown in Figures 8.4.4-4 to 8.4.4-4b.
Figure 8.4.4-4: Spatial correlation measurements for the radiated two-stage method using correlation implementation of SCME UMa and UMi (Jake's Doppler spectrum) for System 1 with CE1 for Band 13
Figure 8.4.4-4a: Spatial correlation measurements for the radiated two-stage method using correlation implementation of SCME UMa and UMi (Jake's Doppler spectrum) for System 2 with CE2 for Band 13
Figure 8.4.4-4b: Spatial correlation measurements for the radiated two-stage method using correlation implementation of SCME UMa and UMi (Jake's Doppler spectrum) for System 2 with CE2 for Band 7
The spatial correlation results for the RTS method using geometric implementation of SCME are shown in Figures 8.4.4-5 to 8.4.4-5b.
Figure 8.4.4-5: Spatial correlation measurements for the RTS method using geometric implementation of SCME UMa and UMi for System 1 with CE1 for Band 13
Figure 8.4.4-5a: Spatial correlation measurements for the RTS method using geometric implementation of SCME UMa and UMi for System 2 with CE2 for Band 13
Figure 8.4.4-5b: Spatial correlation measurements for the RTS method using geometric implementation of SCME UMa and UMi for System 2 with CE2 for Band 7",TR 37.977,8.4.4,all_images/image_616.png,Spatial correlation measurements for the radiated two-stage method using correlation
"The spatial correlation properties of the SCME UMi channel model defined in clause 8.2 has been characterized according to clause 8.3.2.3. Figure 8.4.4-1a below illustrates the measured results for Band 13, and Band 7.
Figure 8.4.4-1: Void
(a)  (b)
(c)  (d)
(e)  (f)
Figure 8.4.4-1a: For MPAC system 1, CE 1 (a) and CE 2 (b) spatial correlation measurements for Band 13; for MPAC system 1, CE 1 (c) CE 2 (d) spatial correlation measurements for Band 7; For MPAC system 2, spatial correlation measurements for Band 13 (e) and Band 7 (f)
Figure 8.4.4-2: Void
Figure 8.4.4-3: Void
The spatial correlation results for the RTS method using correlation implementation of SCME (Jake's Doppler spectrum) are shown in Figures 8.4.4-4 to 8.4.4-4b.
Figure 8.4.4-4: Spatial correlation measurements for the radiated two-stage method using correlation implementation of SCME UMa and UMi (Jake's Doppler spectrum) for System 1 with CE1 for Band 13
Figure 8.4.4-4a: Spatial correlation measurements for the radiated two-stage method using correlation implementation of SCME UMa and UMi (Jake's Doppler spectrum) for System 2 with CE2 for Band 13
Figure 8.4.4-4b: Spatial correlation measurements for the radiated two-stage method using correlation implementation of SCME UMa and UMi (Jake's Doppler spectrum) for System 2 with CE2 for Band 7
The spatial correlation results for the RTS method using geometric implementation of SCME are shown in Figures 8.4.4-5 to 8.4.4-5b.
Figure 8.4.4-5: Spatial correlation measurements for the RTS method using geometric implementation of SCME UMa and UMi for System 1 with CE1 for Band 13
Figure 8.4.4-5a: Spatial correlation measurements for the RTS method using geometric implementation of SCME UMa and UMi for System 2 with CE2 for Band 13
Figure 8.4.4-5b: Spatial correlation measurements for the RTS method using geometric implementation of SCME UMa and UMi for System 2 with CE2 for Band 7",TR 37.977,8.4.4,all_images/image_620.png,Spatial correlation measurements for the RTS method using geometric
"This framework is methodology agnostic, and shall be used to compare each MIMO OTA testing method's ability to emulate the specified network and channel propagation characteristics based on an absolute data throughput metric (Clause 5.1.1).
The purposes of this framework are:
-	For the agreed Channel Models, currently SCME Umi and Uma, to understand and quantify what are the deviations (if any) introduced by the chamber used in radiated mode compared to the conducted mode (when reference antennas are embedded). This shall be applied inter labs for the same method and inter methods.
- 	For methods that are able to reproduce channel models that are not agreed in the present document, it can be used to define the channel model details that need to be injected in the conducted test to obtain same results in the radiated part. And therefore it is easier to reproduce those conditions across methods.
The above use cases for the framework are required to be conducted for inter methodology comparison. 
Other applications for the framework are optional and not excluded.
And more concretely, the following scenarios for comparison are defined:
Figure 9.3.1.6-1: Application of the framework and scenarios for comparison
These scenarios are intended to address the following aspects:
1.	The first scenario, anechoic based: intended to compare the conducted portion of the test (with embedded radiation pattern antennas) with the same results of the radiated test. 
Throughputs are compared to understand any artifacts introduced by the setup.
2.	The second scenario, reverberation based: intended to compare the conducted portion of the test (with embedded radiation pattern antennas) with the same results of the radiated test. 
Throughputs are compared to understand any artifacts introduced by the setup.
3.	The third scenario, reverberation based: intended to compare the conducted portion of the test (with embedded radiation pattern antennas) and with 3D isotropic channel model with the same results of the radiated test. 
Throughputs are compared to understand any artifacts introduced by the setup. 
Additionally this scenario will help to define the 3D isotropic properties of the channel model as perceived by the UE in the reverb chamber, and compare its realization in the conducted portion.
NOTE:	 If scenario2 holds true, it would mean that for the agreed setup anechoic method and reverberation method provides comparable results for the agreed channel models in the present document, currently 2D SCME.",TR 37.977,9.3.1.6,all_images/image_624.jpeg,Application of the framework and scenarios for comparison
"Figure 9.3.1.7.3-1 and Figure 9.3.1.7.3-2 show results from measurements using the absolute data throughput comparison framework for the reverberation chamber and channel emulator methodology, implementing the short delay spread low correlation and the long delay spread high correlation channel model. The conducted and radiated results align within +/- 1 dB (comparing the 70 % throughput level), therefore validating the framework concept.
Details about the measurement setups are given in Table 9.3.1.7.3-1 and Table 9.3.1.7.3-2.
Table 9.3.1.7.3-1: Measurement setup for the reverberation chamber and channel emulator methodology
Figure 9.3.1.7.3-1: Proof of concept for the reverberation chamber and channel emulator methodology emulating the short delay spread low correlation channel model
Table 9.3.1.7.3-2: Measurement setup for the reverberation chamber and channel emulator methodology
Figure 9.3.1.7.3-2: Proof of concept for the reverberation chamber and channel emulator methodology emulating the long delay spread high correlation channel model",TR 37.977,9.3.1.7.3,all_images/image_625.jpeg,Proof of concept for the reverberation chamber and channel emulator
"Inter-Lab/Inter-Technique (IL/IT) campaigns have been performed in CTIA MOSG LTE MIMO OTA by the Anechoic Chamber test methodology. The results are produced here in Figures 10.2.2-1 to 10.2.2-9.
Figure 10.2.2-1: Absolute data throughput framework results for the SCME UMi Channel model
 for SATIMO
Figure 10.2.2-2: Absolute data throughput framework results for the SCME UMa-B Channel model
 for SATIMO
Further, from Figure 10.2.2-2, it can be noted that the max deviation between the absolute data throughput and OTA measurements is around 1.5dB at 70% throughput. This can be observed for the Good antenna system and SCME UMi case with the absolute data throughput outperforming the OTA measurements. There is also a deviation of around 1dB for the following case - SCME UMi with Nominal antenna and SCME UMa B case with Good antenna. 
Very little deviation is noted for the Bad antenna and both SCME UMi, and UMa B case.
. Figure 10.2.2-3 Absolute data throughput framework results for the SCME UMi Channel model
 for Intel
Figure 10.2.2-4 Absolute data throughput framework results for the SCME UMa B Channel model
 for Intel
Figure 10.2.2-3 and Figure 10.2.2-4 show a results agreement within the specified margins.
Figure 10.2.2-5: Comparison between the conductive measurements between Intel and SATIMO
 for the SCME UMi channel model
Figure 10.2.2-6: Comparison between the conductive measurements between Intel and SATIMO
 for the SCME UMaB channel model
Figure 10.2.2-7: Average radiated throughput comparison under SCMe UMi OTA
 for Intel and SATIMO
Figure 10.2.2-8: Average radiated throughput comparison under SCMe UMa-B OTA
 for Intel and SATIMO
Figure 10.2.2-9: Conducted non-faded measurements comparison between Intel and SATIMO
The legend in the Figure 10.2.2-9 should be read as indicated in Table 10.2.2-1.
Table 10.2.2-1: Explanation of the legend for Figure 10.2.2-9
The references for the different phones are provided in Table 10.2.2-2.
Table 10.2.2-2: Explanation of the legend for Figure 10.2.2-9
And finally Rep. in the legend stands for repetition number.",TR 37.977,10.2.2,all_images/image_627.png,Absolute data throughput framework results for the SCME UMi Channel model
"Inter-Lab/Inter-Technique (IL/IT) campaigns have been performed in CTIA MOSG LTE MIMO OTA by the Anechoic Chamber test methodology. The results are produced here in Figures 10.2.2-1 to 10.2.2-9.
Figure 10.2.2-1: Absolute data throughput framework results for the SCME UMi Channel model
 for SATIMO
Figure 10.2.2-2: Absolute data throughput framework results for the SCME UMa-B Channel model
 for SATIMO
Further, from Figure 10.2.2-2, it can be noted that the max deviation between the absolute data throughput and OTA measurements is around 1.5dB at 70% throughput. This can be observed for the Good antenna system and SCME UMi case with the absolute data throughput outperforming the OTA measurements. There is also a deviation of around 1dB for the following case - SCME UMi with Nominal antenna and SCME UMa B case with Good antenna. 
Very little deviation is noted for the Bad antenna and both SCME UMi, and UMa B case.
. Figure 10.2.2-3 Absolute data throughput framework results for the SCME UMi Channel model
 for Intel
Figure 10.2.2-4 Absolute data throughput framework results for the SCME UMa B Channel model
 for Intel
Figure 10.2.2-3 and Figure 10.2.2-4 show a results agreement within the specified margins.
Figure 10.2.2-5: Comparison between the conductive measurements between Intel and SATIMO
 for the SCME UMi channel model
Figure 10.2.2-6: Comparison between the conductive measurements between Intel and SATIMO
 for the SCME UMaB channel model
Figure 10.2.2-7: Average radiated throughput comparison under SCMe UMi OTA
 for Intel and SATIMO
Figure 10.2.2-8: Average radiated throughput comparison under SCMe UMa-B OTA
 for Intel and SATIMO
Figure 10.2.2-9: Conducted non-faded measurements comparison between Intel and SATIMO
The legend in the Figure 10.2.2-9 should be read as indicated in Table 10.2.2-1.
Table 10.2.2-1: Explanation of the legend for Figure 10.2.2-9
The references for the different phones are provided in Table 10.2.2-2.
Table 10.2.2-2: Explanation of the legend for Figure 10.2.2-9
And finally Rep. in the legend stands for repetition number.",TR 37.977,10.2.2,all_images/image_629.png,Comparison between the conductive measurements between Intel and SATIMO
"Inter-Lab/Inter-Technique (IL/IT) campaigns have been performed in CTIA MOSG LTE MIMO OTA by the Anechoic Chamber test methodology. The results are produced here in Figures 10.2.2-1 to 10.2.2-9.
Figure 10.2.2-1: Absolute data throughput framework results for the SCME UMi Channel model
 for SATIMO
Figure 10.2.2-2: Absolute data throughput framework results for the SCME UMa-B Channel model
 for SATIMO
Further, from Figure 10.2.2-2, it can be noted that the max deviation between the absolute data throughput and OTA measurements is around 1.5dB at 70% throughput. This can be observed for the Good antenna system and SCME UMi case with the absolute data throughput outperforming the OTA measurements. There is also a deviation of around 1dB for the following case - SCME UMi with Nominal antenna and SCME UMa B case with Good antenna. 
Very little deviation is noted for the Bad antenna and both SCME UMi, and UMa B case.
. Figure 10.2.2-3 Absolute data throughput framework results for the SCME UMi Channel model
 for Intel
Figure 10.2.2-4 Absolute data throughput framework results for the SCME UMa B Channel model
 for Intel
Figure 10.2.2-3 and Figure 10.2.2-4 show a results agreement within the specified margins.
Figure 10.2.2-5: Comparison between the conductive measurements between Intel and SATIMO
 for the SCME UMi channel model
Figure 10.2.2-6: Comparison between the conductive measurements between Intel and SATIMO
 for the SCME UMaB channel model
Figure 10.2.2-7: Average radiated throughput comparison under SCMe UMi OTA
 for Intel and SATIMO
Figure 10.2.2-8: Average radiated throughput comparison under SCMe UMa-B OTA
 for Intel and SATIMO
Figure 10.2.2-9: Conducted non-faded measurements comparison between Intel and SATIMO
The legend in the Figure 10.2.2-9 should be read as indicated in Table 10.2.2-1.
Table 10.2.2-1: Explanation of the legend for Figure 10.2.2-9
The references for the different phones are provided in Table 10.2.2-2.
Table 10.2.2-2: Explanation of the legend for Figure 10.2.2-9
And finally Rep. in the legend stands for repetition number.",TR 37.977,10.2.2,all_images/image_631.png,Average radiated throughput comparison under SCMe UMi OTA
"Inter-Lab/Inter-Technique (IL/IT) campaigns have been performed in CTIA MOSG LTE MIMO OTA by the Anechoic Chamber test methodology. The results are produced here in Figures 10.2.2-1 to 10.2.2-9.
Figure 10.2.2-1: Absolute data throughput framework results for the SCME UMi Channel model
 for SATIMO
Figure 10.2.2-2: Absolute data throughput framework results for the SCME UMa-B Channel model
 for SATIMO
Further, from Figure 10.2.2-2, it can be noted that the max deviation between the absolute data throughput and OTA measurements is around 1.5dB at 70% throughput. This can be observed for the Good antenna system and SCME UMi case with the absolute data throughput outperforming the OTA measurements. There is also a deviation of around 1dB for the following case - SCME UMi with Nominal antenna and SCME UMa B case with Good antenna. 
Very little deviation is noted for the Bad antenna and both SCME UMi, and UMa B case.
. Figure 10.2.2-3 Absolute data throughput framework results for the SCME UMi Channel model
 for Intel
Figure 10.2.2-4 Absolute data throughput framework results for the SCME UMa B Channel model
 for Intel
Figure 10.2.2-3 and Figure 10.2.2-4 show a results agreement within the specified margins.
Figure 10.2.2-5: Comparison between the conductive measurements between Intel and SATIMO
 for the SCME UMi channel model
Figure 10.2.2-6: Comparison between the conductive measurements between Intel and SATIMO
 for the SCME UMaB channel model
Figure 10.2.2-7: Average radiated throughput comparison under SCMe UMi OTA
 for Intel and SATIMO
Figure 10.2.2-8: Average radiated throughput comparison under SCMe UMa-B OTA
 for Intel and SATIMO
Figure 10.2.2-9: Conducted non-faded measurements comparison between Intel and SATIMO
The legend in the Figure 10.2.2-9 should be read as indicated in Table 10.2.2-1.
Table 10.2.2-1: Explanation of the legend for Figure 10.2.2-9
The references for the different phones are provided in Table 10.2.2-2.
Table 10.2.2-2: Explanation of the legend for Figure 10.2.2-9
And finally Rep. in the legend stands for repetition number.",TR 37.977,10.2.2,all_images/image_633.png,Conducted non-faded measurements comparison between Intel and SATIMO
"The IL/IT test results from CTIA MOSG LTE MIMO OTA Round Robin campaign for the reverberation chamber candidate methodology 1 (RC) using the NIST model are reproduced in figures 10.2.3-1 to 10.2.3-4. 
A maximum standard deviation uncertainty value for inter-chamber comparison of NIST of 0.7 dB STD has been found, showing that IL/IT consistency has been achieved using the reverberation chamber methodology 1 (RC).
Figure 10.2.3-1: IL/IT results consistency for Reverberation Chamber candidate methodology 1 (RC) measurements implementing the NIST channel model (all reference antennas)
Figure 10.2.3-2: IL/IT results consistency for Reverberation Chamber candidate methodology 1 (RC) measurements implementing the NIST channel model with the Good reference antennas
Figure 10.2.3-3: IL/IT results consistency for Reverberation Chamber candidate methodology 1 (RC) measurements implementing the NIST channel model with the Nominal reference antennas
Figure 10.2.3-4: IL/IT results consistency for Reverberation Chamber candidate methodology 1 (RC) measurements implementing the NIST channel model with the Bad reference antennas
The IL/IT test results from CTIA MOSG LTE MIMO OTA Round Robin campaign for the reverberation chamber candidate methodology 2 (RC+CE) using the Short Delay Spread Low Correlation model are reproduced in Figures 10.2.3-5 to 10.2.3-8. A maximum standard deviation uncertainty value for inter-chamber comparison of Short Delay Spread Low Correlation of 1.7 dB STD has been found, showing that IL/IT consistency has been achieved using the reverberation chamber methodology 2 (RC+CE).
Figure 10.2.3-5: IL/IT results consistency for Reverberation Chamber candidate methodology 2 (RC+CE) measurements implementing the Short Delay channel model (all antennas)
Figure 10.2.3-6: IL/IT results consistency for Reverberation Chamber candidate methodology 2 (RC+CE) measurements implementing the Short Delay channel model with the Good reference antennas
Figure 10.2.3-7: IL/IT results consistency for Reverberation Chamber candidate methodology 2 (RC+CE) measurements implementing the Short Delay channel model with the Nominal reference antennas
Figure 10.2.3-8: IL/IT results consistency for Reverberation Chamber candidate methodology 2 (RC+CE) measurements implementing the Short Delay channel model with the Bad reference antennas
The IL/IT test results from CTIA MOSG LTE MIMO OTA Round Robin campaign for the reverberation chamber candidate methodology 2 (RC+CE) using the Long Delay Spread High Correlation model are reproduced in figures 10.2.3-9 to 10.2.3-12. A maximum standard deviation uncertainty value for inter-chamber comparison of Long Delay Spread High Correlation of 1.86 dB STD has been found, showing that IL/IT consistency has been achieved using the reverberation chamber methodology 2 (RC+CE).
Figure 10.2.3-9: IL/IT results consistency for reverberation chamber methodology 2 (RC+CE) measurements implementing the Long Delay Spread High Correlation channel model (all antennas)
Figure 10.2.3-10: IL/IT results consistency for reverberation chamber methodology 2 (RC+CE) measurements implementing the Long Delay Spread High Correlation channel model with Good reference antenna only
Figure 10.2.3-11: IL/IT results consistency for reverberation chamber methodology 2 (RC+CE) measurements implementing the Long Delay Spread High Correlation channel model with Nominal reference antenna only
Figure 10.2.3-12: IL/IT results consistency for reverberation chamber methodology 2 (RC+CE) measurements implementing the Long Delay Spread High Correlation channel model with Bad reference antenna only
The case for conducted non-faded measurements is shown in Figure 10.2.3-13.
Figure 10.2.3-13: Conducted non-faded measurements comparison between Bluetest and Azimuth
In all cases for Figures 10.2.3-5 through 10.2.3-13 the following applies:
-	AZ: Azimuth
-	BT: Bluetest
The details on the devices used in all cases for Figures 10.2.3-5 through 10.2.3-13 are given in the table below.
Table 10.1.2-1",TR 37.977,10.2.3,all_images/image_634.jpeg,IL/IT results consistency for Reverberation Chamber candidate methodology 2
"The IL/IT test results from CTIA MOSG LTE MIMO OTA Round Robin campaign for the reverberation chamber candidate methodology 1 (RC) using the NIST model are reproduced in figures 10.2.3-1 to 10.2.3-4. 
A maximum standard deviation uncertainty value for inter-chamber comparison of NIST of 0.7 dB STD has been found, showing that IL/IT consistency has been achieved using the reverberation chamber methodology 1 (RC).
Figure 10.2.3-1: IL/IT results consistency for Reverberation Chamber candidate methodology 1 (RC) measurements implementing the NIST channel model (all reference antennas)
Figure 10.2.3-2: IL/IT results consistency for Reverberation Chamber candidate methodology 1 (RC) measurements implementing the NIST channel model with the Good reference antennas
Figure 10.2.3-3: IL/IT results consistency for Reverberation Chamber candidate methodology 1 (RC) measurements implementing the NIST channel model with the Nominal reference antennas
Figure 10.2.3-4: IL/IT results consistency for Reverberation Chamber candidate methodology 1 (RC) measurements implementing the NIST channel model with the Bad reference antennas
The IL/IT test results from CTIA MOSG LTE MIMO OTA Round Robin campaign for the reverberation chamber candidate methodology 2 (RC+CE) using the Short Delay Spread Low Correlation model are reproduced in Figures 10.2.3-5 to 10.2.3-8. A maximum standard deviation uncertainty value for inter-chamber comparison of Short Delay Spread Low Correlation of 1.7 dB STD has been found, showing that IL/IT consistency has been achieved using the reverberation chamber methodology 2 (RC+CE).
Figure 10.2.3-5: IL/IT results consistency for Reverberation Chamber candidate methodology 2 (RC+CE) measurements implementing the Short Delay channel model (all antennas)
Figure 10.2.3-6: IL/IT results consistency for Reverberation Chamber candidate methodology 2 (RC+CE) measurements implementing the Short Delay channel model with the Good reference antennas
Figure 10.2.3-7: IL/IT results consistency for Reverberation Chamber candidate methodology 2 (RC+CE) measurements implementing the Short Delay channel model with the Nominal reference antennas
Figure 10.2.3-8: IL/IT results consistency for Reverberation Chamber candidate methodology 2 (RC+CE) measurements implementing the Short Delay channel model with the Bad reference antennas
The IL/IT test results from CTIA MOSG LTE MIMO OTA Round Robin campaign for the reverberation chamber candidate methodology 2 (RC+CE) using the Long Delay Spread High Correlation model are reproduced in figures 10.2.3-9 to 10.2.3-12. A maximum standard deviation uncertainty value for inter-chamber comparison of Long Delay Spread High Correlation of 1.86 dB STD has been found, showing that IL/IT consistency has been achieved using the reverberation chamber methodology 2 (RC+CE).
Figure 10.2.3-9: IL/IT results consistency for reverberation chamber methodology 2 (RC+CE) measurements implementing the Long Delay Spread High Correlation channel model (all antennas)
Figure 10.2.3-10: IL/IT results consistency for reverberation chamber methodology 2 (RC+CE) measurements implementing the Long Delay Spread High Correlation channel model with Good reference antenna only
Figure 10.2.3-11: IL/IT results consistency for reverberation chamber methodology 2 (RC+CE) measurements implementing the Long Delay Spread High Correlation channel model with Nominal reference antenna only
Figure 10.2.3-12: IL/IT results consistency for reverberation chamber methodology 2 (RC+CE) measurements implementing the Long Delay Spread High Correlation channel model with Bad reference antenna only
The case for conducted non-faded measurements is shown in Figure 10.2.3-13.
Figure 10.2.3-13: Conducted non-faded measurements comparison between Bluetest and Azimuth
In all cases for Figures 10.2.3-5 through 10.2.3-13 the following applies:
-	AZ: Azimuth
-	BT: Bluetest
The details on the devices used in all cases for Figures 10.2.3-5 through 10.2.3-13 are given in the table below.
Table 10.1.2-1",TR 37.977,10.2.3,all_images/image_638.jpeg,IL/IT results consistency for reverberation chamber methodology 2 (RC+CE)
"Inter-Lab/Inter-Technique (IL/IT) campaigns have been performed in CTIA MOSG LTE MIMO OTA by the RTS test methodology by Agilent's lab and CATR using the GTS lab. Both labs used the correlation implementation of the SCME channel model with the Jake's Doppler spectrum.
The static conducted baseline measurements for Agilent and GTS are provided in Figure 10.2.4-1.
Figure 10.2.4-1: Static conducted reference results for Agilent and GTS
The absolute data throughput framework proof of concept for the RTS method is in Clause 9.3.1.7. 
The absolute data throughput measurements for the new GTS lab to demonstrate equivalence between conducted and radiated measurements was performed for the UMi channel model are shown in Figures 10.2.4-2 and 10.2.4-3. 
These results show approximately +/- 0.2 dB consistency for UMi and +/- 0.6 dB consistency for UMa/B.
Figure 10.2.4-2: Radiated vs Cable-conducted Absolute Throughput Test for UMi Model 
for the GTS lab
Figure 10.2.4-3: Radiated vs. Cable-conducted Absolute Throughput Test for UMa/B Model
 for the GTS lab
A comparison between both RTS labs is shown in Figures 10.2.4-4 and 10.2.4-5.
Figure 10.2.4-4: Comparison of RTS results for UMi
Figure 10.2.4-5: Comparison of RTS results for UMa/B
The RTS UMi results compared against Intel and SATIMO anechoic are shown in Figure 10.2.4-6.
Figure 10.2.4-6: Absolute Throughput Test for UMi Model
The RTS UMa results compared against Intel and SATIMO anechoic are shown in Figure 10.2.4-7.
Figure 10.2.4-7: Absolute Throughput Test for UMa/B Model
A tabular comparison of all the results at 70% throughput is given in Tables 10.2.4-1 and 10.2.4-2.
Table 10.2.4-1: Summary of UMi results at 70% throughput
Table 10.2.4-2. Summary of UMa results at 70% throughput",TR 37.977,10.2.4,all_images/image_643.png,Static conducted reference results for Agilent and GTS
"Inter-Lab/Inter-Technique (IL/IT) campaigns have been performed in CTIA MOSG LTE MIMO OTA by the RTS test methodology by Agilent's lab and CATR using the GTS lab. Both labs used the correlation implementation of the SCME channel model with the Jake's Doppler spectrum.
The static conducted baseline measurements for Agilent and GTS are provided in Figure 10.2.4-1.
Figure 10.2.4-1: Static conducted reference results for Agilent and GTS
The absolute data throughput framework proof of concept for the RTS method is in Clause 9.3.1.7. 
The absolute data throughput measurements for the new GTS lab to demonstrate equivalence between conducted and radiated measurements was performed for the UMi channel model are shown in Figures 10.2.4-2 and 10.2.4-3. 
These results show approximately +/- 0.2 dB consistency for UMi and +/- 0.6 dB consistency for UMa/B.
Figure 10.2.4-2: Radiated vs Cable-conducted Absolute Throughput Test for UMi Model 
for the GTS lab
Figure 10.2.4-3: Radiated vs. Cable-conducted Absolute Throughput Test for UMa/B Model
 for the GTS lab
A comparison between both RTS labs is shown in Figures 10.2.4-4 and 10.2.4-5.
Figure 10.2.4-4: Comparison of RTS results for UMi
Figure 10.2.4-5: Comparison of RTS results for UMa/B
The RTS UMi results compared against Intel and SATIMO anechoic are shown in Figure 10.2.4-6.
Figure 10.2.4-6: Absolute Throughput Test for UMi Model
The RTS UMa results compared against Intel and SATIMO anechoic are shown in Figure 10.2.4-7.
Figure 10.2.4-7: Absolute Throughput Test for UMa/B Model
A tabular comparison of all the results at 70% throughput is given in Tables 10.2.4-1 and 10.2.4-2.
Table 10.2.4-1: Summary of UMi results at 70% throughput
Table 10.2.4-2. Summary of UMa results at 70% throughput",TR 37.977,10.2.4,all_images/image_644.png,Radiated vs Cable-conducted Absolute Throughput Test for UMi Model 
"The call flow is shown in Figure 5.2.6.1-1.
Figure 5.2.6.1-1: High-level call flow for content preparation before downlink streaming
Steps:
1.	The 5GMSd Application Provider creates a Provisioning Session with the 5GMSd AF (M1d).
2.	The 5GMSd Application Provider provisions the 5GMSd AF with one or more Content Preparation Templates defining instructions for content preparation, as well as the required output format(s) (M1d).
3.	The 5GMSd AF, based on the received Content Preparation Templates, requests the 5GMSd AS to verify availability of resources for content preparation (M3d, procedures not specified):
a.	Syntax checking of Content Preparation Template(s).
b.	Semantic validation of Content Preparation Template(s).
c.	Basic assessment of 5GMSd AS resource availability implied by the Content Preparation Template(s).
4.	The 5GMSd AF acknowledges to the 5GMSd Application Provider the successful creation of Content Preparation Templates (M1d).
5.	The 5GMSd Application Provider provisions the 5GMSD AF with a Content Hosting Configuration that references one or more Content Preparation Templates created in step 2 above (M1d).
6.	The 5GMSd AF, based on the received Content Hosting Configuration, requests the 5GMSd AS to confirm the availability of distribution resources (M3d, procedures not specified).
7.	The 5GMSd AF acknowledges to the 5GMSd Application Provider the successful creation of the Content Hosting Configuration (M1d).
8.	The 5GMSd Application Provider feeds the content to the 5GMSd AS (M2d).
9.	The 5GMSd Application Provider optionally provides the service access information to the 5GMSd-Aware Application (M8d, out of scope)
If needed, steps 10–14 may optionally be executed:
10.	The 5GMSd-Aware Application requests the 5GMSd Application Provider to use the service (M8d).
11.	The 5GMSd Application Provider provides the 5GMSd AF with updated Content Preparation Template(s) (M1d).
12.	The 5GMSd AF, based on the modified Content Preparation Template(s), requests an updated confirmation of downlink streaming resource availability (M3d).
13.	The 5GMSd AF acknowledges to the 5GMSd Application Provider that the Content Preparation Template(s) have been successfully updated (M1d).
14.	The 5GMSd Application Provider acknowledges to the 5GMSd AF the use of the service (M8d).
The rest of the call flow concerns the 5GMS downlink streaming process:
15. The 5GMS-Aware Application request the 5GMSd Client to start an uplink streaming session (M6d/M7d).
16.	If Service Access Information was not provided in step 9, the 5GMSd Client requests this information from the 5GSMd AF (M5d).
17.	 The 5GMSd Client requests start of the downlink streaming session from the 5GSMd AF (M5d).
18.	The 5GMSd AF requests instantiation of the content preparation process (M3d).
19.	The 5GMSd AS instantiates the media preparation process if it (or any of its parts) are not already running.
20.	The 5GMSd AF acknowledges the instantiation of the content preparation process (M3d).
Steps 18–20 are not needed if another user has already requested the content and therefore the content preparation process is already running on the 5GMS AS, or if this process was instantiated in earlier steps of the workflow (e.g. in step 3 or step 12).
One use-case for steps 18–20 is when a user requests a content format that is not included in the previously instantiated content preparation process. In this case, 5GMSd AS may add new processes to the content preparation processing to provide the requested content format.
21. The downlink media streaming starts (M4d).
Finally:
22.	The 5GMSd AS releases its resources after observing a period of interactivity.
NOTE:	Step 22 is implementation-dependent.",TR 26.804,5.2.6.1,all_images/image_645.jpeg,High-level call flow for content preparation before downlink streaming
"The call flow is shown in Figure 5.2.6.2-1.
Figure 5.2.6.2-1: Call flow for content preparation after uplink streaming
Steps:
1.	The 5GMSu Application Provider creates a Provisioning Session with the 5GMSu AF (M1u).
2.	The 5GMSu Application Provider creates one or more Content Preparation Templates defining instructions for content preparation, as well as the required output format(s) (M1u).
3.	The 5GMSu AF, based on the received Content Preparation Templates requests the 5GMSu AS to verify availability of content preparation and contribution resources, e.g. to allocate 5GMSu content ingest and contribution egest resources. (M3u, procedures not specified):
a.	Syntax checking of Content Preparation Template.
b.	Semantic validation of Content Preparation Template.
c.	Basic assessment of 5GMSu AS resource availability implied by the Content Preparation Template.
4.	The 5GMSu AF acknowledges to the 5GMSu Application Provider the successful creation of Content Preparation Templates, as well as successful provisioning of content preparation (M1u).
5.	The 5GMSu Application Provider optionally provides the service access information to the 5GMSu-Aware Application (M8u, out of scope)
If needed, steps 6–10 may optionally be executed.
6.	The 5GMSu-Aware Application requests the 5GMSu Application Provider to support impending reception of uplink streaming content (M8u)
7.	The 5GMSu Application Provider provides the 5GMSu AF with updated Content Preparation Template(s) (M1u).
8.	The 5GMSu AF, based on the modified Content Preparation Templates, requests an updated confirmation of uplink streaming resource availability (M3u).
9.	The 5GMSu AF acknowledges to the 5GMSu Application Provider that the Content Preparation Templates have been successfully updated (M1u).
10.	The 5GMSu Application Provider acknowledges to the 5GMSu AF the use of the service (M8u).
The rest of the call flow concerns the 5GMS uplink streaming process:
11.	The 5GMSu-Aware Application request the 5GMSu Client to start an uplink streaming session (M6/7u).
12.	If Service Access Information was not provided in Step 5, the 5GMSu Client requests this information from the 5GSMu AF (M5u).
13.	The 5GMSu Client requests start of the uplink streaming session from the 5GSMu AF (M5u).
NOTE 1:	Although the above step is defined by the stage 2 design in TS 26.501 [15], it is not realised in Release 16 by stage 3 procedures defined in TS 26.512 [16].
14.	The 5GMSd AF requests instantiation of the content preparation process (M3u).
15.	The 5GMSd AS instantiate the media preparation process if it has not started before (M3u).
16.	The 5GMSd AF acknowledges the instantiation of the content preparation process (M3u).
Steps 14–16 may not be needed if the content preparation process has been instantiated during earlier steps in the call flow (such as between 3 and 8).
17.	Uplink media streaming from the 5GMSu Client to the 5GMSu AS commences (M4u).
18.	Media streaming egest from the 5GMSu AS to the 5GMSu Application Provider (M2u) commences.
Finally:
19.	The 5GMSu AS releases its resources after observing a period of interactivity. Note that this is implementation dependent.
NOTE 2:	The 5GMSu Application Provider also sets up the M2u configuration during the provisioning section. The details of such set-up are not shown in the above call flow.
Editor’s Note: The M2u configuration process is the subject of the uplink streaming topic of this study.",TR 26.804,5.2.6.2,all_images/image_646.jpeg,Call flow for content preparation after uplink streaming
"Figure 5.2.6.3-1 shows the call flow for this scenario.
Figure 5.2.6.3-1: High-level call flow for content preparation
between uplink streaming and downlink streaming
Steps:
1.	Identical to steps 1–7 in 5.2.6.1-1.
2.	The 5GMS Application Provider creates a Provisioning Session with the 5GMSu AF (M1u).
3.	The 5GMSu AF requests the 5GMSu AS to confirm the uplink resources availability. (M3u, procedures not specified).
4.	The 5GMSu AF acknowledges to the 5GMSu Application Provider of the successful provisioning (M1u).
5.	The 5GMS Application optionally provides the service access information to the 5GMSu-Aware Application (M8u, out of scope).
6. The 5GMS-Aware Application request the 5GMSu Client to start an uplink streaming session (M6/7u).
7.	If Service Access Information was not provided in step 5, the 5GMSu Client requests this information from the 5GSMu AF (M5u).
8.	 The 5GMSu Client requests start of the uplink streaming session from the 5GSMu AF (M5u).
9. The uplink media streaming starts (M4u).
10.	The 5GMSu AS streams the content to the 5GMSd AS (I2, not specified).
11.	The 5GMS Application Provider optionally provides the service access information to the 5GMSd-Aware Application (M8d, out of scope).
12.	Identical to steps 10–14 in 5.2.6.1-1.
13.	Identical to steps 15–21 in 5.2.6.1-1.
14.	The 5GMSu AS releases its resources after observing a period of interactivity.
NOTE 1:	Step 14 is implementation-dependent.
15.	The 5GMSd AS releases its resources after observing a period of interactivity.
NOTE 2:	Step 15 is implementation-dependent.",TR 26.804,5.2.6.3,all_images/image_647.png,High-level call flow for content preparation
"For different features like usage of QoS or different charging rules within the 5G Media Streaming Architecture, it is necessary for the 5G System to identify the traffic flows. The increased usage of transport encryption (e.g. HTTPS) increases the difficulty of detecting the packets for certain application flows. Existing detection methods, such as using “significant parts of the URL to be matched” (contained in a Packet Flow Description, see below), are impractical for HTTPS traffic, since the URL is carried in the encrypted payload.
Multimedia streaming applications might not be able to uniquely identify the 5-tuple of the streaming session, since the 5-tuples are often changing. This is due to factors such as load balancing, CDN distribution, multiple concurrent requests for different types of resources, etc. This study will address how to properly configure the 5G System to enable efficient detection of application flows (service data flows) e.g. for event reporting, and QoS profile usage, etc.
Note that the TS 23.50x specifications use different terminology from the TS 29.xxx specifications. Furthermore, TS 23.503 [41] uses slightly different terms than TS 23.501 [23] and TS 23.502 [24]. The two common terms are defined in TS 23.503:
-	Packet flow: A specific user data flow from and/or to the UE.
-	Service data flow: An aggregate set of packet flows carried through the UPF that matches a service data flow template.
The terms traffic detection [23] and application detection [23] refer to the process of finding matching service data flows among all packet flows. This logic is defined in TS 23.503 as an application detection filter.
The procedures in TS 23.502 use the term flow description, which is only a subset of an IP Packet Filter Set (as defined in TS 23.501).
Figure 5.3.1-1 depicts the chain of functions (taken from TS 29.244 [26], Figure 5.2.1-1) within an UPF.
Figure 5.3.1-1: Packet processing flow in the UP function (Figure 5.2.1-1 from TS 29.244 [26])
The steps are as follows:
1.	The UPF always first looks up the Packet Forwarding Control Protocol (PFCP) session context to which a packet belongs. The PFCP session context is an individual PDU session or a standalone PFCP session not tied to any PDU session.
2.	Then there are so-called Packet Detection Rules (PDR), which implement traffic detection of the service data flows with respect to different conditions.
NOTE:	A PDR is direction specific. Thus, an Uplink (UL) PDR and a Downlink (DL) PDR are needed to detect a bidirectional Service Data Flow.
3.	Based on the PDR result, the next rules are executed, namely Multi-Access Rule (MAR), Forward Action Rule (FAR), QoS Enforcement Rule (QER), and Usage Reporting Rule (URR).
NOTE:	Only the Forward Action Rule (FAR) is mandatory. The QoS Enforcement Rule (QER) is only present for QoS Flows. The Usage Reporting Rule (URR) is only available when traffic volume measurements (e.g. for charging) are needed.
The Packet Detection Rule (PDR) is based on Service Data Flow Templates, which contain one or more Service Data Flow (SDF) Filters or an Application Identifier. An Application Identifier refers to one or more Packet Flow Descriptions (PFDs).
A Service Data Flow (SDF) Filter contains for IP PDU Sessions a single IP Packet filter, i.e. any combination of
-	Source/destination IP address or IPv6 prefix.
-	Source / destination port number.
-	Protocol ID of the protocol above IP/Next header type.
-	Type of Service (ToS) (IPv4) or Traffic class (IPv6) and Mask.
-	Flow Label (IPv6).
-	Security parameter index.
-	Packet Filter direction.
A PFD includes a PFD ID; and one or more of the following:
-	3-tuple(s) comprising protocol, server-side IP address and port number.
-	the significant parts of the URL to be matched, e.g. host name.
-	a domain name matching criterion and information about applicable protocol(s).
The application detection filter can be configured in the SMF and the SMF then provides it in the Service Data Flow Template to the UPF. Alternatively, the Service Data Flow Template for traffic handling in the UPF is received from the dynamic PCC Rule.
Besides, the Management of Packet Flow Descriptions enables the UPF to perform accurate application detection when PFD(s) are provided by an Application Service Provider (ASP) and then to apply enforcement actions as instructed in a PCC Rule.
The operator is able to configure pre-defined PCC Rules in the SMF or dynamic PCC Rules in the PCF. A PCC rule includes either a list of Service Data Flow filters or an application identifier for Service Data Flow detection.  The PCC rule further includes charging control information, i.e. charging key and optionally a Sponsor identifier or an ASP identifier or both.
The application identifier references one or more PFDs, which are managed using the PFD Management API. Depending on the service level agreements between the operator and the Application Server Provider, it may be possible for the ASP to provide to the SMF individual PFDs or the full set of PFDs for each application identifier maintained by the ASP via the PFD Management service in the NEF (PFDF). The PFDs become part of the application detection filters in the SMF/UPF and are thereafter used as part of the logic to detect traffic generated by an application. The ASP may remove or modify some or all of the PFDs which have been provided previously for one or more application identifiers. The SMF may report the application stop to the PCF for an application instance identifier as defined in clause 5.8.2.8.4 of TS 23.501 [5] if the removed/modified PFD in SMF/UPF would result in an inability to detect traffic for that application instance.
The ASP manages (i.e. provisions, updates, deletes) the PFDs through the NEF (PFDF). The PFD(s) are transferred to the SMF through the NEF (PFDF). The PFDF is a logical functionality in the NEF which receives PFD(s) from the ASP through the NEF, stores the PFD(s) in the UDR and provides the PFD(s) to the SMF(s) either on the request from ASP PFD management through NEF (PFDF) (push mode) or on the request from SMF (pull mode). Finally, the PFDF functionality is a service provided by the NEF.
The ASP may provide/update/remove PFDs with an allowed delay to the NEF (PFDF). Upon reception of the request from the ASP, the NEF (PFDF) checks if the ASP is authorized to provide/update/remove those PFD(s) and request the allowed delay. The NEF (PFDF) may be configured with a minimum allowed delay based on SLA to authorize the allowed delay provided by the ASP. When both the requesting ASP and the requested allowed delay are successfully authorized, the NEF (PFDF) translates each external Application Identifier to the corresponding Application Identifier known in the core network. The NEF (PFDF) stores the PDF(s) into the UDR.
The Application Identifier is simply an index to a set of application detection rules configured in the UPF. It is an identifier that can be mapped to a specific application traffic detection rule.
The procedure is depicted Figure 5.3.1-2 below:
Figure 5.3.1-2:
The PFD (Packet Flow Description) is a set of information enabling the detection of application traffic.
Each PFD may be identified by a PFD ID. A PFD ID is unique in the scope of a particular Application Identifier. Conditions for when a PFD ID is included in the PFD are described in TS 29.551 [6]. There may be different PFD types associated with an Application Identifier.",TR 26.804,5.3.1,all_images/image_648.png,Packet processing flow in the UP function (Figure 5.2.1-1 from TS 29.244 [26])
,TR 26.804,5.9.2,all_images/image_649.jpeg,Collaboration 1 (Collaboration 3 of TS 26.501)
"The following is a simplified call flow when using the ToS Traffic Class for Traffic Identification, meaning, only the Type of Service field is used within a SDF Filter. The Type of Service (ToS) is an 8-bit field within the IP header (both IPv4 and IPv6) that can be used to convey a 6-bit DS Code Point (DSCP) value as described in clause 5.3.2.2, and for ECN marking [30]. Here, and in the candidate solution presented in clause 5.3.6, only the leading 6 bits are considered for traffic identification.
It is assumed here that the QoS flow should be used (e.g. for Premium QoS) as described in TS 26.512, Annex A.
Figure 5.3.4.3-1: ToS usage within an application traffic detection rule (simplified)
Figure 5.3.4.3-1 depicts a call flow for ToS-based traffic detection. It is assumed here that the 5GMSd AF provides the ToS value for traffic identification in the Policy Activation response message (step 5). Another solution might be that the Media Session Handler allocates a ToS value and then provides the value to the 5GMSd AF.
The call flow works as the following steps:
1:	The Media Session Handler activates a Dynamic Policy and provides the Policy Template Id with the activation request (among other parameters).
The 5GMSd AF triggers the activation of a Dynamic PCC rule:
2:	The 5GMSd AF uses the Policy Authorization Service API and triggers a PCC rule activation. The 5GMSd AF provides the UE IP address, an IP Packet Filter Set with the ToS value and the UE IP address of the requesting UE and QoS parameters.
3:	As result, the PCF uses the Npcf_SMPolicyControl APIs to provide a new PCC rule to the SMF.
4: 	The SMF uses the PDU Session Modification procedure to add/modify a QoS Rule in the UE SDAP entity.
5:	The SMF uses the N4 interface to provide a new Packet Detection Rule (PDR) together with other rules for the UE to the UPF. Once the new rule is installed in the UPF, the UPF starts taking actions on the detected traffic.
6:	If the Dynamic Policy can be activated, the 5GMSd AF provides a value for the ToS field in return.
NOTE 1: The ToS Value is not immediately provided to the Media Session Handler to prevent race conditions.
7:	The Media Player prepares a new TCP connection and sets the ToS value nominated by the 5GMSd AF on the TCP socket using the setsockopt() API or equivalent. As a result, all TCP packets for the flow will be marked by the UE with the ToS value.
8:	The TCP Connection is established, and the traffic is marked with the ToS field. The UPF detects the traffic (by inspecting the IP header) and handles it according to the policy in the PCC Rule.
NOTE 2:	The PCC Rule is scoped by the PDU Session, so the treatment of the ToS field value by the UPF is limited to the requesting UE. The UPF first looks up the relevant PDRs for a PDU session based on the incoming GTP Tunnel Id.
The UPF also needs to detect the downlink traffic matching the uplink traffic. There are different solutions to achieve this:
A:	The 5GMSd AS uses the same ToS field for downlink traffic as used for uplink traffic.
NOTE 3:	This solution may not work for cases where traffic crosses operational domain boundaries, since the ToS header field is often reset by border IP routers.
B:	The UPF captures the 5-tuple carrying a specific ToS field from the TCP SYN Packet that establishes the connection in the uplink direction. As result, the UPF automatically creates a new PDR in the opposite direction derived by inverting the address fields found in the SYN packet.
NOTE 4:	The connection handshake of other transport protocols may be more difficult to detect.
C:	Often, the UEs in a PLMN are shielded from public Internet traffic by means of firewalls that employ Network Address Translation (NAT). In order to set the ToS field within the Trusted DN to an appropriate value, the N6-NAT may set the downlink ToS to the same value as the uplink ToS.
NOTE 5:	This is similar to solution A above.",TR 26.804,5.3.4.3,all_images/image_652.png,ToS usage within an application traffic detection rule (simplified)
"The following are simplified call flows for the realization of the traffic identification leveraging Packet Flow Descriptions (PFDs).
In the first call flow (Figure 5.3.4.4-1) the provisioning step is described, in which one or more PFDs for the traffic identification of a single application are provisioned. The provisioned PFDs for the application are identified by the Application Identifier.
Figure 5.3.4.4-1: PFD Provisioning using the PFD Management API (simplified)
In the second call flow (Figure 5.3.4.4-2) the on-demand usage of a set of PFDs for an application is described.
Figure 5.3.4.4-2: PFD usage within an application detection filter (simplified)
Here, the 5GMSd AF resides within the Trusted Data Network and interacts directly with the PCF. When activating an QoS flow, the 5GMSd AF provides to the PCF the Application Identifer for detecting the 5G Media Streaming traffic together with the UE IP address and other policy information.
When the 5GMSd AF resides in an external Data Network, the 5GMSd AF instead uses the equivalent NEF API (such as the Nnef_AFsessionWithQoS or Nnef_ChargeableParty service APIs) and provides the (external) Application Identifier, referencing one or more PFDs, to the NEF.
The 5GMSd AF can update the PFDs during an ongoing media streaming session. When updating, the 5GMS AF uses the NEF PFD management APIs. The system then automatically updates the Packet Detection Rules in the UPF used for traffic detection.",TR 26.804,5.3.4.4,all_images/image_653.png,PFD usage within an application detection filter (simplified)
A service provider/content provider runs an adaptive media streaming service between HTTP/3 and QUIC enabled 5G Media Streaming AS and an HTTP/3 and QUIC enabled UE using 5G Media Streaming over M2d and M4d.,TR 26.804,5.4.2,all_images/image_654.jpeg,Collaboration 2 (unchanged from Figure A.2-1 in TS 26.501 [15])
"Mobile Network Operators (MNO) are faced with the challenge of overload of their networks during peak hours. The following diagram shows a typical distribution of traffic over the day hours in a residential area:
Figure 5.6.1-1:	Example of traffic distribution over time
Note that the traffic distribution is also highly dependent on the geographic area. For instance, traffic distribution in a residential area maybe quite different from traffic distribution in a business or commercial area. Another example is traffic along roads during commute hours, which maybe higher by orders of magnitude than traffic during other hours.
As can be seen from the diagram, the traffic distribution is non-uniform/uneven throughout the day, which leads to congestion during the peak hours and very low utilization during off-peak hours. To alleviate this situation, the MNO may incentivize offloading traffic to off-peak hours to balance the network resource usage throught the day. The incentives may be provided in terms of preferential charging and guaranteed QoS.",TR 26.804,5.6.1,all_images/image_662.jpeg,Example of traffic distribution over time
"The following is a potential high-level call flow for the configuration and usage of a BDT session in 5G media streaming:
Figure 5.6.4-1: Potential call flow for BDT session configuration and establishment",TR 26.804,5.6.4,all_images/image_663.jpeg,Potential call flow for BDT session configuration and establishment
,TR 26.804,5.7,all_images/image_664.jpeg,Capped VBR rate control encoding compared with CBR and VBR
,TR 26.804,5.7,all_images/image_665.jpeg,Content-Aware Streaming based on static parameters
"The 5G Media Streaming architecture can be used for different application service offerings. Annex A in TS 26.512 [16] describes three different Dynamic Policy usage examples: Premium QoS, Conditional Zero Rating and Background Download. In all the three cases, different network features are used to realise the Dynamic Policy, e.g. an increase in network resource utilization when consuming HD content with the corresponding network QoS.
It is assumed in all three examples that the 5GMS Application Provider (and the Application Service Provider) has an agreement with the 5G System provider to use the relevant network feature.
Figure 5.9.3-1: Applying roles for 5G Media Streaming Architecture functions
Figure 5.9.2-1 illustrates the different roles and responsibilities:
-	The resource in question is a network policy.
-	The 5G System Provider is the resource owner in this case, since it provides the 5G connectivity service.
-	The 5GMSd-Aware Application is the Resource User. It instructs the 5GMSd Client to activate a certain dynamic policy, based on the service subscription and the selected content.
-	The 5GMS Application Provider is the Resource Owner. It checks that the requested dynamic policy matches the application service subscription. For example (with reference to clause A.2 in TS 26.512 [16]), when the user has an HD video subscription, the user should only be authorised to activate a dynamic policy corresponding to the HD operating point.",TR 26.804,5.9.3,all_images/image_671.jpeg,Applying roles for 5G Media Streaming Architecture functions
"This solution is based on the concept that the 5GMS AF can contact the 5GMS Application Provider (ASP) whenever a new Dynamic Policy is activated by a 5GMS Client.
The 5GMS Application Provider provides a different authorization token (e.g. a random number or a random string) via M8 to each 5GMS-Aware Application, so that each application can identify itself uniquely to the 5GMS AF.
When activating a Dynamic Policy, the 5GMS-Aware Application passes the token (via an M6 API call) to the Media Session Handler. When the Media Session Handler desires to activate a dynamic policy, it presents the authorization token to the 5GMS AF by invoking an M5 operation. Upon receit of such a token, the 5GMS AF executes a callback to the 5GMS Application Provider in order to verify, whether this authorization token is valid. When the token is valid, the UE application is authorized to activate this policy.
The authorization token is provided e.g. during the login procedure or is requested at a later stage. The UE Application may fetch metadata for the media assets at some stage.
The call flow is depicted below, assuming that the authorization token is provided with the application service login response.
Figure 5.9.6.2-1: Usage of a callback for policy activation authorization
The steps are as follows:
1.	When the user wants to use the 5GMS-Aware Application to consume e.g. video content, the user needs to authenticate with the application and the 5GMS Application Provider. (In some cases, this authorization can be cached/stored by the application, so that the user is not always challenged to provide the login credentials.)
NOTE:	The application may be a native application (e.g. an Android application) or a browser application.
2.	The 5GMS Application Provider determines the policy rights to which this application service subscription is entitled (e.g. the user may have subscribed to an SD quality video service or a 4K quality video service). According to the subscription entitlement level, the 5GMS Application Provider creates an authorization token and passes this token together with the login response back to the application.
3.	When the 5GMS-Aware Application (immediately or later) invokes the Media Session Handler to activate the network service from the 5GMS AF, the application passes the authorization token to the Media Session Handler. The authorization token can embed a user identifier, or the user identifier may be passed as separate (anonymised) parameter.
4.	When the Media Session Handler activates a dynamic policy, it provides the the token to the 5GMS AF, e.g. as an HTTP query parameter.
5.	The 5GMS AF then verifies the authorization token with the 5GMS Application Provider, using a callback function.
This callback URL can be stored by the 5GMS AF together with the Policy Template parameters so that the use of the network policy resource can be revalidated periodically with the 5GMSd Application Provider.
6.	When the 5GMS AF has verified that the 5GMS Aware Application is authorized to active the dynamic policy (based on the token), the 5GMS AF invokes the appropriate procuedres on the NEF or PCF. For example, the 5GMS AF triggers the addition of a QoS flow by invoking the Nnef_AFsessionWithQoS service.",TR 26.804,5.9.6.2,all_images/image_672.jpeg,Usage of a callback for policy activation authorization
"In order to reduce the number of callbacks, tokens with a limited validity duration may be provisioned with the 5GMS AF and the 5GMS-Aware Applications.
In this solution the 5GMSd Application Provider provisions a set of valid authorization tokens, including expiry time, in the 5GMS AF in advance via M1.
As in Solution 1, the Media Session Handler passes an authorization token when invoking the 5GMS AF at M5. The 5GMA AF authorizes the Media Sesssion Handler’s request based on this token.
Since the token validity is time-limited, the 5GMS Application Provider must periodically update the set of valid authorization tokens provisioned at the 5GMS AF and the 5GMS-Aware Application is responsible for refreshing the token used by the Media Session Handler. For example, the application may be configured to periodically fetch a new token from the 5GMS Application Provider.
Figure 5.9.6.3-1: Usage of time-limited tokens for policy activation authorization
The steps are as follows:
1.	The 5GMS Application Provider provisions tokens on the 5GMS AF before any 5GMS-Aware Application tries to activate any Dyanmic Policy. The token is provisioned together with the Policy Template definitions.
2.	When a user (and the 5GMS-Aware Application) successfully authenticates with the 5GMS Application Provider, the 5GMS-Aware Application receives a time-limited authorization token. The 5GMS-Aware Application typically stores the token.
The difference with Solution 1 is the use of the token by the 5GMS AF:
3.	When a 5GMS-Aware Application wishes to activate a Dynamic Policy, it provides the authorization token to the 5GMS AF. The 5GMS AF then validates the token using a simple lookup against it list of currently valid tokens without reference to the 5GMS Application Provider.",TR 26.804,5.9.6.3,all_images/image_673.jpeg,Usage of time-limited tokens for policy activation authorization
,TR 26.804,5.11.1,all_images/image_674.jpeg,Different latencies and delays relevant for low-latency distribution
"This clause provides an extension to the general call flow in clause 6.2.3 of TS 26.501 [15] in order to address operation point services.
Figure 5.11.4.1-1: High-level procedure for DASH content for Operation Point handling
Prerequisites:
-	The 5GMSd Application Provider has provisioned the 5G Media Streaming System and has set up content ingest.
-	The 5GMSd-Aware Application has received the Service Announcement from the 5GMSd Application Provider.
Extended Steps:
1:	Policy Templates are defined
12:	Media Player informs application about the current set of Operation Points.
13:	5GMSd-Awaer Application selects an Operation Point.
14:	Media Player provdes Operation Point parameters to the Media Session Handler.
15:	Media Session Hahdnler selects a Dynamic Policy based on the provided Operation Point parameters.
21: Media Player provides Operation Point metrics to the Media Session Handler.
22: Media Session Handler sends Operation Point measurements and events to the 5GMSd AF.",TR 26.804,5.11.4.1,all_images/image_675.jpeg,High-level procedure for DASH content for Operation Point handling
"The 5GMS Application Provider may use the M1 provisioning interface to define a set of network slices that can be used for the media streaming sessions that it offers. This is done when the 5GMS Application Provider would like to request that its media traffic is isolated from other traffic. This may facilitate features such charging and QoS accounting.
It may associate each operation point (e.g. 4K HDR, HD, SD) with a dedicated network slice. Access to each network slice at reference point M4 is restricted to UEs with a valid subscription to that service level. The list or groups of users that are to be authorized to use a certain slice is provided by the 5GMS Application Provider during the provisioning step and can be updated subsequently.
Figure 5.12.6.1-1 below shows a call flow for this solution:
Figure 5.12.6.1-1: Call flow for provisioning network slices and Operation Points
The steps are as follows:
1.	The 5GMS Application Provider provisions the configuration for all upcoming media streaming sessions in the 5GMS AF at reference point M1.
a.	The Application Provider declares a requirement for one or more network slices that correspond to the operation points that it offers for the media streaming service.
b.	The 5GMS AF requests the MnS to create or update a set of network slices based on the provided provisioning information. The MnS for network slice management capability exposure  is currently being studied in SA5 in TR 28.824. The characteristics of a network slice are stored as part of the ServiceProfile as defined in TS 28.541.
c.	The Media Session Handler in the 5GMS Client retrieves Service Access Information from the 5GMS AF. The response includes a mapping between the operation point and the S-NSSAI that should be used by the session.
2.	The 5GMS-Aware Application retrieves the entry point for the media streaming session from the 5GMS Application Provider at reference point M8. The returned entry point contains information about the allowed Operation Points, e.g. in the DASH service descriptor.
3.	The 5GMS-Aware Application selects one of the offered Operation Points.
4.	The application informs the Media Session Handler about the start of a new media streaming session and indicates the selected Operation Point.
5.	The Media Session Handler informs the 5GMS AF about the starting media streaming session and the desired Operation Point.
6.	The 5GMS AF requests the application of the corresponding QoS profile to the media streaming session.
7.	The Media Session Handler may request the establishment of a new PDU session or the  modification of an existing PDU session to use the allowed network slice as indicated by the S-NSSAI. Note that the PDU session is dedicated for the media streaming session traffic. The PDU session establishment and update procedures are defined in clause 8.3 of TS 24.501.
8.	The AMF may request admission control to use the selected slice from the NSACF.
9.	If allowed, the PDU session is established/updated to use the selected S-NSSAI.
10.	Media streaming commences at reference point M4.
To support this high-level procedure:
-	The streaming session uses the eMBB SST slice/service type.
-	The Slice Differntiator is mapped to an operation point of the service that is indicated through the externalReference as defined in clause 7.9.3.1 of TS 26.512 [16].",TR 26.804,5.12.6.1,all_images/image_676.jpeg,Call flow for provisioning network slices and Operation Points
"The Networked Media Open Specifications (NMOS) [15] is a family of specifications produced by the Advanced Media Workflow Association (AMWA) related to networked media for professional applications. NMOS was created to help enable automation in live IP-based architectures through control plane APIs that are built on typical patterns used for web services (REST, publish-subscribe). NMOS specifications are increasingly being adopted for applications using SMPTE ST 2110, and are part of the EBU’s Technology Pyramid for Media Nodes [14][16] reproduced in Figure 4.5.2-1 below.
Figure 4.5.2-1: EBU’s Technology Pyramid for Media Nodes (with the permission of EBU)
AMWA has defined a system template containing several building blocks in [18]. The system template contains four distinct layers, namely Media & Infrastructure, Control, Monitoring and Security. Figure 4.5.2-2 depicts Figure 3 from [18] for convenience.
Figure 4.5.2-2: Networked Media Systems Template – Showing the Roles of NMOS (Figure 3 from [18]) (with the permission of AMWA)
The Control layer contains:
-	Provisioning functions: Discovery and Registration, Device Configuration and System Parameters.
-	Media Routing functions: Flow Connection, Audio Channel Mapping and Network Routing.
-	Operational Control functions: Service Control and Event & Tally.
The Media layer is subdivided into Production, Service and Flows. For the present study, the content within the Flows box is mostly of interest. Flows in this context are sequences of video, audio or time-related data, and are configured and controlled using the Flow Connection tool from the Control layer.
Further details of NMOS can be found at [15], and the specifications are documented at [20].
The most relevant NMOS specifications are depicted in also Figure 4.5.2-2:
-	AMWA IS-04 allows media nodes (i.e. networked media devices) to register themselves, along with what they are (or are capable of) sending or receiving, and allows control applications to query this information.
-	AMWA IS-05 allows control applications to set up and remove connections between media nodes.
-	AMWA IS-07 provides a publish-and-subscribe channel for sending time-based events such as tally information.
-	AMWA IS-08 specifies how to handle audio channels in NMOS APIs.
-	AMWA BCP-002-01 provides grouping of related resources, e.g. video, audio and data senders.
-	The AMWA BCP-003 suite of specifications (including IS-10) covers secure communication and authorisation of NMOS APIs.
-	AMWA BCP-004-01 lets a receiver describe any constraints on the types or parameters of streams it can receive.
To date NMOS has mostly been used with ST 2110 [21] uncompressed multicast video and audio streams within wired facilities. However, NMOS can be used with other types of streams, including unicast. There is growing interest in other areas, such as professional audio-visual applications using compressed video (e.g. IPMX – see clause 5.2.6 above – uses NMOS), and where media is streamed between facilities over WAN connections (VSF WAN group).",TR 26.805,4.5.2,all_images/image_680.jpeg,EBU’s Technology Pyramid for Media Nodes (with the permission of EBU)
"A straightforward realization of Scenario 1 (clause 5.2) is the usage of a Standalone NPN. Here, a dedicated 5G System is deployed for exclusive use for media production. The media producer also acts as the Mobile Network Operator; thus, all Application Functions are trusted and may interact with other network functions as needed.
Figure 5.5.2-1: On-site production with a Standalone NPN",TR 26.805,5.5.2,all_images/image_683.jpeg,On-site production with a Standalone NPN
"This deployment model contains three sub-scenarios, based on the distance between media production site and the media production network.
1.	Local PNI-NPN production with support for on-site edge computing: A media producer may leverage the network of a Mobile Network Operator for an on-site media production event. When a local breakout in a local edge computing environment is provided, the deployment is very similar to an on-site wireless production with an SNPN (clause 5.5.2). For example, the media producer connects the equipment of an OB Van through a local breakout at an event location with the 5G PNI-NPN. Low latency communication is enabled due to close proximity of devices.
2.	Remote production: A media producer may leverage the network of a Mobile Network Operator for remote media production. Here, media production equipment is kept more centrally in the network in order to reduce equipment and people movement, as described in clause 5.4.
3.	Contribution: A media producer may leverage the network of a Mobile Network Operator for an Outside Broadcast contribution event, for example Electronic News Gathering (ENG) including mobile journalism. Here, the media production network elements are located more centrally within the studio facility of the media producer.
Figure 5.5.3-1: PNI-NPN collaboration model for on-site productions or OB contributions
In this collaboration scenario, the NEF APIs are the key enabler for the collaboration. Some procedures, such as the SLA definition and agreement, may be outside of the scope of the NEF APIs.",TR 26.805,5.5.3,all_images/image_684.jpeg,PNI-NPN collaboration model for on-site productions or OB contributions
"Quality of Service (QoS) is a tool which only becomes relevant at times of high network utilisation. In these situations, the 5G System may need to prioritize some packets over others. In a well-planned production scenario, the 5G System is dimensioned to fit the needs of the media production and high network utilisation only occurs rarely. However, proper planning and dimensioning might not be achievable in all media production scenarios. Thus, it might be preferred to degrade the output of a camera, keeping the most essential traffic intact. Depending on the scenario, different media flows are more essential than others to the media production.
An example communication protocol stack is illustrated in Figure 6.3.3-1 below. The different media flows may use different higher layer protocols. For audio and video streams, the RTP protocol is often used, which typically uses UDP as its Layer 4 protocol. Data streams such as tally light control may be carried using, for example, MQTT [48] (AMWA NMOS recommendation) which uses TCP as its Layer 4 protocol. (NMOS [15] is described in clause 4.5.2.)
Figure 6.3.3-1: Example protocol stacks for different media application flows
MQTT [48] is a message-oriented application protocol based on the publish–subscribe paradigm. It was developed as an OASIS open standard and published as ISO/IEC 20922. MQTT uses TCP as its transport protocol. MQTT adds some message headers, which allow (among other things) the byte-stream-oriented TCP protocol to be used for message separation.
The different combinations of media flows (figure 5.2-1) depend on the media production scenario. In the following, the mappings for some example scenarios are presented and discussed.",TR 26.805,6.3.3,all_images/image_687.jpeg,Example protocol stacks for different media application flows
"This use case is identical to Use case F but the discussion here focuses on bitrate variations that may occur in the session, even under normal operating conditions with good channel condition and low network load so that there is no need for end-to-end bitrate adaptation. This use case therefore illustrates the bitrate variations that may be generated by a video codec if no restrictions are applied to the encoding process.
Alice and Bob are setting up a video telephony session including both speech and video. Both UEs support the minimum set of speech and video codecs defined in TS 26.114, i.e.:
-	for speech: AMR (4.75-12.2 kbps); and:
-	for video: H.264 Constrained Baseline Profile (CBP) level 1.2.
Alice sends the SDP offer and Bob sends the SDP answer as shown below. Since this analysis is targeting issues for bitrate variations for video then the SDPs do not include audio. The SDP examples shown below are also simplified versions without SDPCapNeg, AVPF feedback messages, image attribute and video orientation since these things make no difference for the current analysis.
Table 6.11.1-1: SDP offer-answer for use case J
This discussion focuses on video and speech is not considered any more in this use case.
For the media handling in the UEs, the SDP offer/answer negotiation means:
-	UE-A (Alice) wants to receive max 315 kbps (on average).
-	UE-B (Bob) wants to receive max 315 kbps (on average).
-	UE-A will send max 315 kbps (on average).
-	UE-B will send max 315 kbps (on average).
The Application Functions use the b=AS values from the SDP offer and the SDP answer sets the service information to:
-	In IMS-A:
-	UE-A max send rate is 315 kbps (on average).
-	UE-A min send rate is unknown and is therefore left undefined.
-	UE-A max receive rate is 315 kbps (on average).
-	UE-A min receive rate is also unknown and is therefore left undefined.
-	In IMS-B:
-	UE-B max send rate is 315 kbps (on average).
-	UE-B min send rate is unknown and is therefore left undefined.
-	UE-B max receive rate is 315 kbps (on average).
-	UE-B min receive rate is unknown and is therefore left undefined.
The AF sends these parameters together with the remaining media-related information to the PCRF.
In this case, it is assumed that the PCRFs suggest to set up a bearer with MBR=GBR. This gives the following bearer allocation.
Table 6.11.1-2: Bearer allocation for video
In this discussion it is assumed that these parameters are also used in the PGW to monitor that the UEs do not exceed the negotiated bandwidths.
Two trace files of video frame sizes are used to facilitate the discussion on bitrate variations. The files are described in the Table 6.11.1-3 below and are shown in Figures 6.11.1-1 and 6.11.1-2.
Table 6.11.1-3: File information
These files do not include any I frames.
Figure 6.11.1-1: Video frame sizes for file 1
Figure 6.11.1-2: Video frame sizes for file 2
When measuring the used bitrate, e.g. in a policing function, then one need to average the instantaneous bitrates over some time to create a short-term average. In this analysis, an averaging window has been used and different lengths of the averaging window have been tested. The figure below shows a few examples of how the variations in the short-term bitrate average are reduced as the length of the averaging window increases.
Figure 6.11.1-3: Bitrates for file 1 with different averaging windows
As can be seen in the figure above the variations in the short-term average are significantly reduced when applying an averaging window, even if the window is as short as 0.5 seconds. This is however excluding I frames. Statistics when applying different averaging window lengths are shown in Table 6.11.1-4.
I frames may be generated by the encoder for several reasons, for example generated at a regular interval to stop error propagation or generated when the receiver requests a Full Intra Refresh. I frames are usually much larger than the average frame size, often as large as 5 to 10 times larger. The effects of I frames on the short-term bitrate average have been analysed by manually inserting I frames every 15 second in the video trace files. Both I frames of 5 times and 10 times the average video frame size have been used. The video trace files were then re-scaled to maintain the 315 kbps average bitrate (measured over the whole trace file). The averaging windows were then applied in the same was as above. Table 6.11.1-4 shows the statistics for the two files when I frames have been added.
Table 6.11.1-4: Bitrate variations after applying averaging window
As can be seen in the table, adding I frames has a large impact on how the averaged bitrate varies. To get a maximum short-term average (measured over the averaging window) that is reasonably close to the long-term average (measured over the whole file) then one need to have a long averaging window, at least a few seconds long.
Looking at the columns showing how many times the average exceeds 25 % and 10 % over the average one can see that this occurs quite frequently when 5x and 10x I frames are added, even for long averaging windows. If the network would drop a packet every time this happens then this would increase the packet loss rate with a few percent, in the worst cases with as much as 10 %.
Another observation is that the frequency of large short-term average actually seems to increase with increasing window length when large I frames are added.",TR 26.924,6.11.1,all_images/image_694.png,Video frame sizes for file 1
"This use case is identical to Use case F but the discussion here focuses on bitrate variations that may occur in the session, even under normal operating conditions with good channel condition and low network load so that there is no need for end-to-end bitrate adaptation. This use case therefore illustrates the bitrate variations that may be generated by a video codec if no restrictions are applied to the encoding process.
Alice and Bob are setting up a video telephony session including both speech and video. Both UEs support the minimum set of speech and video codecs defined in TS 26.114, i.e.:
-	for speech: AMR (4.75-12.2 kbps); and:
-	for video: H.264 Constrained Baseline Profile (CBP) level 1.2.
Alice sends the SDP offer and Bob sends the SDP answer as shown below. Since this analysis is targeting issues for bitrate variations for video then the SDPs do not include audio. The SDP examples shown below are also simplified versions without SDPCapNeg, AVPF feedback messages, image attribute and video orientation since these things make no difference for the current analysis.
Table 6.11.1-1: SDP offer-answer for use case J
This discussion focuses on video and speech is not considered any more in this use case.
For the media handling in the UEs, the SDP offer/answer negotiation means:
-	UE-A (Alice) wants to receive max 315 kbps (on average).
-	UE-B (Bob) wants to receive max 315 kbps (on average).
-	UE-A will send max 315 kbps (on average).
-	UE-B will send max 315 kbps (on average).
The Application Functions use the b=AS values from the SDP offer and the SDP answer sets the service information to:
-	In IMS-A:
-	UE-A max send rate is 315 kbps (on average).
-	UE-A min send rate is unknown and is therefore left undefined.
-	UE-A max receive rate is 315 kbps (on average).
-	UE-A min receive rate is also unknown and is therefore left undefined.
-	In IMS-B:
-	UE-B max send rate is 315 kbps (on average).
-	UE-B min send rate is unknown and is therefore left undefined.
-	UE-B max receive rate is 315 kbps (on average).
-	UE-B min receive rate is unknown and is therefore left undefined.
The AF sends these parameters together with the remaining media-related information to the PCRF.
In this case, it is assumed that the PCRFs suggest to set up a bearer with MBR=GBR. This gives the following bearer allocation.
Table 6.11.1-2: Bearer allocation for video
In this discussion it is assumed that these parameters are also used in the PGW to monitor that the UEs do not exceed the negotiated bandwidths.
Two trace files of video frame sizes are used to facilitate the discussion on bitrate variations. The files are described in the Table 6.11.1-3 below and are shown in Figures 6.11.1-1 and 6.11.1-2.
Table 6.11.1-3: File information
These files do not include any I frames.
Figure 6.11.1-1: Video frame sizes for file 1
Figure 6.11.1-2: Video frame sizes for file 2
When measuring the used bitrate, e.g. in a policing function, then one need to average the instantaneous bitrates over some time to create a short-term average. In this analysis, an averaging window has been used and different lengths of the averaging window have been tested. The figure below shows a few examples of how the variations in the short-term bitrate average are reduced as the length of the averaging window increases.
Figure 6.11.1-3: Bitrates for file 1 with different averaging windows
As can be seen in the figure above the variations in the short-term average are significantly reduced when applying an averaging window, even if the window is as short as 0.5 seconds. This is however excluding I frames. Statistics when applying different averaging window lengths are shown in Table 6.11.1-4.
I frames may be generated by the encoder for several reasons, for example generated at a regular interval to stop error propagation or generated when the receiver requests a Full Intra Refresh. I frames are usually much larger than the average frame size, often as large as 5 to 10 times larger. The effects of I frames on the short-term bitrate average have been analysed by manually inserting I frames every 15 second in the video trace files. Both I frames of 5 times and 10 times the average video frame size have been used. The video trace files were then re-scaled to maintain the 315 kbps average bitrate (measured over the whole trace file). The averaging windows were then applied in the same was as above. Table 6.11.1-4 shows the statistics for the two files when I frames have been added.
Table 6.11.1-4: Bitrate variations after applying averaging window
As can be seen in the table, adding I frames has a large impact on how the averaged bitrate varies. To get a maximum short-term average (measured over the averaging window) that is reasonably close to the long-term average (measured over the whole file) then one need to have a long averaging window, at least a few seconds long.
Looking at the columns showing how many times the average exceeds 25 % and 10 % over the average one can see that this occurs quite frequently when 5x and 10x I frames are added, even for long averaging windows. If the network would drop a packet every time this happens then this would increase the packet loss rate with a few percent, in the worst cases with as much as 10 %.
Another observation is that the frequency of large short-term average actually seems to increase with increasing window length when large I frames are added.",TR 26.924,6.11.1,all_images/image_696.jpeg,Bitrates for file 1 with different averaging windows
,TR 26.909,4.1,all_images/image_700.jpeg,Proposed subsystem for logging and digesting QoE-related data for Video Streaming
"ITU-T P.NATS project ([3]) will develop the objective assessment model for progressive download and adaptive type media streaming. It supports both the OTT and operator managed video service. The supported protocol scope includes HTTP/TCP/IP, RTMP/TCP/IP, HLS/HTTP/TCP/IP, and DASH/HTTP/TCP/IP. It supports 3GPP, MP4 and other file format, and the model is agnostic to the type of file format.
It will support sequence duration of 60 sec to 5 min for quality evaluation. The supported video resolution is 240p, 360p, 480p, 720p and 1080p. The supported frame rate range is 8 to 50 fps.
ITU-T P.NATS phase 2 aims at extending the quality model for supporting 2K and 4K.
The current working model agreed in P.NATS project is depicted in figure 4.2-1.
Figure 4.2-1: Building blocks of the P.NATS model
As shown in table 4-1, P.NATS will support 4 modes.
Table 4-1: Different modes defined in P.NATS
The P.NATS model will receive media information and prior knowledge about the media stream or streams. The model receives the following input signals regardless of the mode of operation:
-	I.GEN: display resolution and device type
-	I.11: audio coding information
-	I.13: video coding information
-	I.14: Stalling events
The P.NATS model input parameters are provided in table 4-2 below.
Table 4-2: ITU-T P.NATS model input parameters.
The P.NATS model outputs are as follows:
O.21: Audio coding quality per output sampling interval
Multiple segment scores provided per session and on a 1-5 quality scale.
O.22: Video coding quality per output sampling interval
Multiple segment scores provided per session and on a 1-5 quality scale.
O.23: Perceptual buffering indication
Single score on a 1-5 quality scale for the session.
O.34: Audiovisual segment coding quality per output sampling interval.
Multiple segment scores provided per session.
Window-size same as for/synced with O.21, O.22
O.35: Final audio-visual coding quality score
Single score for the session, on a 1-5 quality scale.
Includes aspects of temporal integration.
O.46: Final media session quality score
Single score for the session, on a 1-5 quality scale.
Includes initial buffering and stalling aspects.",TR 26.909,4.2,all_images/image_701.jpeg,Building blocks of the P.NATS model
"The ITU-T P.NATS quality model will support four modes (see clause 4.1). Mode 0, Mode 1 and Mode 3 are of special interest for client-based QoE monitoring.
Mode 0 supports estimating the quality based on metadata information such as audio codec, video codec and bitrates. This quality estimation requires very low processing power and the meta information is typically available even for media streams encrypted at the chunk level.
Mode 1 uses in addition information on the GOP structure and frame sizes. This is possible for unencrypted streams or streams encrypted only on elementary stream level. It requires low processing power and the estimation of video quality is better over mode 0.
Mode 3 takes the bitstream itself into account. The video quality model considers the, quantization parameters and further coding-related features in addition to the codec's profile, video framing and bitrates for getting a significant better estimation of the video coding quality. A tradeoff is that Mode 3 requires more processing power and an unencrypted bitstream. Therefore, is deploying P.NATS Mode 3 on the user end devices is unlikely, but Mode 3 can be applied by splitting the processing for the model in one part processing the coding quality on the server side and another part processing the stalling and overall quality integration part on the client side.
As shown in figure 4.2-1, the P.NATS quality model is composed of separate modules for estimating the audio quality (Pa), video quality (Pv) and for integrating audio, video and stalling quality (Pq). This modular approach allows separating the quality estimation into a server-side estimation of the audio and video coding quality and a client-side integration of the coding quality in combination with stalling events that may have occurred on the client. The outputs of the audio module (O.21) and the video module (O.22) are provided with a sampling frequency of 1 Hz. The integration module Pq takes the samples of the audio and video coding quality output for an appropriate measurement interval and combines them with the occurred stalling events. The result is an estimate for the audio-visual quality of the stream, named ""MOS-AVQO"". It is to  be noted that the Pq integration model is identical for all modes.
Figure 4.5-1 illustrates different possible scenarios for applying the P.NATS quality model for monitoring HTTP Adaptive Streaming services.
a) Mode 0: Deriving codec info and bitrate from the meta information
b) Mode 3: Deriving the coding related quality at server attaching to the media description,
c) Possible extended mode: Deriving coding related quality with a full reference model
Figure 4.5-1: Possible scenarios for applying the ITU-T P.NATS quality model for monitoring HTTP Adaptive Streaming services
a)	Mode 0 implements a simple efficient quality estimation. The input parameters to estimate audio-visual quality are taken from the metadata description of the audio-visual stream (codecs, bitrate).
b)	Mode 3 uses the unencrypted bitstream to derive the coding quality. Beside the codec information, video resolution, framerate, bitrate, GOP structure, also the QP parameters and further coding features are derived and considered. As the required processing (bitstream parsing) may be computationally intensive for terminals, it is appropriate to derive O.21(m) and O22(m) for all possible representations of the adaptive stream already at the server side. As explained above, P.NATS Mode 3 foresees a sample frequency of 1 Hz of the output of the audio and video quality estimation module. Hence, for example, for a segment with a length of 6 seconds, one would calculate 12 quality scores (6 audio, 6 video) and transmit them along with the audio-visual data to a client device, which then calculates the integrated MOS-AVQO.
Note: 	The coding quality information could be attached with enhancement of timed metadata track, as described in clause 16 of TS 26.244 [7], clause 6.17 of TR 26.938 [6] – this approach relies on MPEG's ISO/IEC 23001-10 [10].
c)	In future, standardized quality models for HTTP adaptive streaming may support a full-reference quality model. This way, the quality monitoring would take also the possibly varying quality of the encoder into account. The Phase 2 for the P.NATS development (""AVHD / P.NATS Phase 2"") foresees the additional support of a full-reference pixel-based model for video quality estimation.
As discussed in e.g. clause 4.4 in the present document, it may be an advantage to calculate the P.1203 (P.NATS) scores at the server responsible for QoE monitoring.
Thus to be able to divide the P.NATS model execution as described, it is imperative that this can be done in such a way that the final P.NATS score can still be calculated on the network side. This would mean that the Pa and Pv scores which are sent to the client, would also be needed at the QoE Server. Then these scores (together with the other client QoE reported metrics, such as buffering info), can then be used in the QoE Server to finally calculate the P.NATS score.
If the CDN (and thus the Pa/Pv scores) is accessible for the operator owning the QoE Server, then this is not a major problem, as the Pa and Pv scores can then potentially be communicated between the CDN and the QoE Server. There will be a need for some kind of synchronization to know which Pa and Pv scores belong to which QoE reports, but in principle it is possible to handle.
However, if the CDN is not accessible then the Pa and Pv scores, which are sent from the CDN to the client, will be reported back from the client to the QoE Server. Otherwise the QoE Server cannot calculate the P.NATS score. This situation is also the reason for the existing ""MPD Information"" in TS 26.247 (see clause 10.2.8), to make the needed MPD information available to a QoE Server which does not have MPD access.
Note that the use of distributed P.NATS calculation is most straightforward for non-live content, as live content puts additional requirements on the Pa and Pv calculations. Thus the use for live content needs further study.",TR 26.909,4.5,all_images/image_702.png,Possible scenarios for applying the ITU-T P.NATS quality model for monitoring HTTP
,TR 26.909,5.6,all_images/image_705.jpeg,MDT enhancement for supporting QoE reporting
,TR 26.909,5.6,all_images/image_706.jpeg,MDT enhancement for supporting QoE reporting when OMA-DM is not supported
"The content hosting feature is applicable to downlink media streaming only. It provides a service equivalent to a Content Delivery Network (CDN) deployed inside or outside the Trusted DN. High-level procedures for this feature are defined in clause 5.4.
Figure 4.0.2-1: High-level arrangement for content hosting feature
When a 5GMSd Application Provider has provisioned the content hosting feature for downlink media streaming:
1.	Media content is either retrieved by a network-side component of the 5GMS System from a media origin at the 5GMSd Application Provider (pull-based content ingest) or else it is published to a network-side component of the the 5GMS System by the 5GMSd Application Provider (push-based content ingest).
2.	The network-side component of the 5GMS System may cache this content for a configurable period of time.
3.	Network-side components of the 5GMS System may manipulate the content according to rules provisioned in Content Preparation Templates (see clause 4.0.4).
4.	The 5GMSd Client in the UE subsequently retrieves the (possibly manipulated) media content as part of a downlink media streaming session. The security of the content served to the 5GMSd Client by network-side components of the 5GMS System may be guaranteed by a provisioned Server Certificate.
In addition, the use of content hosting by 5GMSd Clients is logged by the 5GMS System and, if suitably provisioned, is exposed by it to subscribing 5GMSd Application Providers in the form of events. This information is equivalent to that contained in CDN access logs (see also clause 4.0.12).",TS 26.501,4.0.2,all_images/image_709.png,High-level arrangement for content hosting feature
"The content publication feature is applicable to uplink media streaming only. High-level procedures for this feature are for future study.
Figure 4.0.3-1: High-level arrangement for content publishing feature
When a 5GMSu Application Provider has provisioned the content publishing feature for uplink media streaming:
1.	Media content is published by the 5GMSu Client in the UE to a network-side component of the 5GMS System as part of an uplink media streaming session. The security of the content published to the 5GMS System may be guaranteed by a provisioned Server Certificate.
2.	The network-side component of the 5GMS System may cache this content for a configurable period of time.
3.	Network-side components of the 5GMS System may manipulate the content according to rules provisioned in Content Preparation Templaes (see clause 4.0.4).
4.	A network-side component of the 5GMS System makes the media content available for retrieval by the 5GMSu Application Provider (pull-based content egest) or publishes it directly to the 5GMSu Application Provider (push-based content egest).",TS 26.501,4.0.3,all_images/image_710.png,High-level arrangement for content publishing feature
"The network assistance feature is applicable to both downlink media streaming and uplink media streaming. It enables the 5GMS Client in the UE to interrogate or manipulate the network Quality of Service for an ongoing media streaming session.
High-level procedures for this feature are defined in clause 5.9 (downlink media streaming) and in clauses 6.1, 6.5 and 6.7 (uplink media streaming). The network assistance feature is not explicitly provisioned by the 5GMS Application Provider. It is either available for a particular media streaming session or not, depending on system pre-configuration and/or policy.
Two mechanisms for obtaining network assistance are defined in the present document: one based on interactions with the PCF via network-based components of the 5GMS System (AF-based network assistance), the other based on ANBR signalling interactions between the UE modem and the RAN (ANBR-based network assistance).
Figure 4.0.5-1: High-level arrangement for network assistance feature
The following AF-based network assistance sub-features are defined in this release:
1.	Bit rate recommendation (or throughput estimation). The 5GMS Client requests an estimate from a network-side component of the 5GMS System of the bit rate that can currently be offered by a media streaming session. The network-side component interrogates the PCF on behalf of the 5GMS Client to obtain this information about the PDU session corresponding to the media streaming session.
The 5GMS Client uses this information to adjust its own streaming bit rate to fit within the Quality of Service (QoS) envelope that the network is able to offer, for example by switching to a different representation listed in its Media Entry Point, or by adjusting the encoding bit rate for uplink streaming to fits within this bit rate budget. The media streaming Quality of Experience (QoE) is more stable and consistent as a consequence.
2.	Delivery boost. The 5GMS Client speculatively requests a temporary boost to the bit rate of a media streaming session from a network-side component of the  5GMS System. The network-side component requests a modification to the PDU session corresponding to the media streaming session from the PCF on behalf of the 5GMS Client. If there is sufficient spare network capacity to accommodate the requested bit rate, it is granted by the 5GMS System on a temporary basis.
The 5GMS Client uses this temporary boost to speed up media streaming data transfer, for example to replenish a depleted downlink streaming buffer or to complete a download/upload faster than would otherwise be possible.
ANBR-based bit rate recommendation is also defined for downlink media streaming (see clause 5.9.3).
ANBR-based delivery boost is also defined for uplink media streaming (see clause 6.7).
In addition, the use of network assistance by 5GMS Clients is logged by the 5GMS System, if suitably provisioned, is exposed by it to subscribing 5GMS Application Providers in the form of events (see also clause 4.0.12).",TS 26.501,4.0.5,all_images/image_711.jpeg,High-level arrangement for network assistance feature
"The QoE metrics reporting feature is applicable to downlink media streaming only in this release. It allows the Quality of Experience of media streaming sessions to be logged by the 5GMS System and exposed for analysis.
Two mechanisms for reporting downlink QoE metrics are defined in the present document: one that involves reports being sent to the OAM via the RAN (RAN-based QoE metrics reporting, see clause 5.5.2), the other involving reports sent to the network-based components of the 5GMS System (AF-based QoE metrics reporting, see clause 5.5.3).
Figure 4.0.9-1: High-level arrangement for QoE metrics reporting feature
When a 5GMS Application Provider has provisioned the QoE metrics reporting feature for media streaming:
1.	The 5GMS Client reports QoE metrics that it has collected during media streaming sessions to a network-side component of the 5GMS System.
In addition, the data contained in AF-based QoE metrics reports may be exposed by the 5GMS System to subscribing 5GMS Application Providers in the form of events (see also clause 4.0.12).",TS 26.501,4.0.9,all_images/image_714.png,High-level arrangement for QoE metrics reporting feature
"The overall 5G Media Streaming Architecture is shown in Figure 4.1-1 below.
NOTE:	The functions indicated by the yellow filled boxes are in scope of stage 3 specifications for 5GMS. The functions indicated by the grey boxes are defined in 5G System specifications. The functions indicated by the blue boxes are neither in scope of 5G Media Streaming nor 5G System specifications.
Figure 4.1-1: 5G Media Streaming within the 5G System
The 5GMS Application Provider uses 5GMS for streaming services. It provides a 5GMS Aware-Application on the UE to make use of 5GMS Client and network functions using interfaces and APIs defined in 5GMS.
The architecture in Figure 4.1-1 represents the specified 5GMS functions within the 5G System (5GS) as defined in TS 23.501 [2]. Three main functions are defined:
-	5GMS AF: An Application Function similar to that defined in TS 23.501 [2] clause 6.2.10, dedicated to 5G Media Streaming.
-	5GMS AS: An Application Server dedicated to 5G Media Streaming.
-	5GMS Client: A UE internal function dedicated to 5G Media Streaming. The 5GMS Client is a logical function and its subfunctions may be distributed within the UE according to implementation choice.
5GMS AF and 5GMS AS are Data Network (DN) functions and communicate with the UE via N6 as defined in TS 23.501 [2].
Functions in trusted DNs, e.g. a 5GMS AF in the Trusted DN, are trusted by the operator's network as illustrated in Figure 4.2.3-5 of TS 23.501 [2]. Therefore, such AFs may directly communicate with the relevant 5G Core functions.
Functions in external DNs, e.g. a 5GMS AF in the External DN, may only communicate with 5G Core functions via the NEF using N33.
The present document specifies the according network architectures for 5GS. The 5GMS architecture may be applied to an EPS although such an application is not specified in the present document and is left to the discretion of deployments and implementations.
The 5G Media Services Architecture maps the overall high-level architecture shown in Figure 4.1-1 above to the general architecture shown in Figure 4.1-2 below.
NOTE:	The 5GMS Client in the UE is depicted in the form of Media Session Handler and Media Stream Handler constituent functions which expose APIs to one another in the same way that those APIs are exposed to 5GMS-Aware Applications. This UE architecture is not applicable generally; it is just as valid to implement a 5GMS Client that does not expose interfaces M6 and M7 within the 5GMS Client. It is also valid for a 5GMS Client inside a UE to be completely self-contained, such that all functionality typically implemented in the 5GMS-Aware Application is embedded in the UE and thus interfaces M6 and M7 are not exposed at all.
Figure 4.1-2: 5G Media Streaming General Architecture
The remainder of the present document specifies stage 2 aspects of the media streaming functional entities shown in the general architecture of Figure 4.1-2.
This architecture specification addresses two main scenarios as concerns each individual media streaming operation:
-	Downlink streaming: The network is the origin of the media and the UE acts as the consumption device.
-	Uplink streaming: The UE is the origin of the media and the network acts as the consumption entity.
The functional entities and interfaces of the media streaming general architecture need to be elaborated with specificities relating to downlink and uplink streaming. For this purpose, corresponding descriptions add the suffix ""d"" for downlink and ""u"" for uplink functionality as appropriate in each case.
Clause 4.2 introduces the 5G Unicast Downlink Media Streaming architecture.
Clause 4.3 introduces the 5G Unicast Uplink Media Streaming architecture.",TS 26.501,4.1,all_images/image_715.png,5G Media Streaming within the 5G System
"The 5GMSd Application Provider uses 5GMSd functions for downlink streaming services. It provides a 5GMSd-Aware Application on the UE the ability to make use of 5GMSd Client and network functions using 5GMSd interfaces and APIs.
The architecture in Figure 4.2.1-1 below represents the specified 5GMSd functions within the 5G System (5GS) as defined in TS 23.501 [2]. Three main functions are defined:
-	5GMSd AF: An Application Function similar to that defined in TS 23.501 [2] clause 6.2.10, dedicated to 5G Downlink Media Streaming.
-	5GMSd AS: An Application Server dedicated to 5G Downlink Media Streaming.
-	5GMSd Client: A UE internal function dedicated to 5G Downlink Media Streaming. The 5GMSd Client is a logical function and its subfunctions may be distributed within the UE according to implementation choice.
5GMSd AF and 5GMSd AS are Data Network (DN) functions and communicate with the UE via the User Plane Function (UPF) using the N6 reference point as defined in TS 23.501 [2].
Functions in trusted DNs are trusted by the operator's network as illustrated in Figure 4.2.3-5 of TS 23.501 [2]. Therefore, AFs in trusted DNs may directly communicate with relevant 5G Core functions.
Functions in external DNs, i.e. 5GMSd AFs in external DNs, may only communicate with 5G Core functions via the NEF using N33.
NOTE 1:	The 5GMS architecture may be applied to an EPS although such an application is not specified in the present document and is left to the discretion of deployments and implementations.
Figure 4.2.1-1: 5G Downlink Media Streaming within 5G System
NOTE 2:	The functions indicated by the yellow filled boxes are in scope of stage 3 specifications for 5GMS. The functions indicated by the grey boxes are defined in 5G System specifications. The functions indicated by the blue boxes are neither in scope of 5G Media Streaming nor 5G System specifications.
The architecture in Figure 4.2.1-2 below represents the media architecture connecting UE internal functions and related network functions.
Figure 4.2.1-2: Media Architecture for unicast downlink media streaming
NOTE 3:	As described in the NOTE of Figure 4.1-2, the functions indicated by the yellow filled boxes are in scope of stage 3 for 5GMSd. The functions indicated by the grey boxes are defined in 5GS. The interfaces indicated by solid lines are in scope of stage 3 for 5GMSd. The interfaces indicated by dashed lines are defined in 5GS. The interfaces indicated by dotted lines are neither in scope of 5GS nor 5GMSd, but are considered as part of informative call flows.
NOTE 4:	Red ovals indicate API provider functions.
NOTE 5:	The 5GMSd AF may also interact with the NEF for NEF-enabled API access. However, within Release 16, the NEF is only used by the 5GMSd AF to interact with the Policy and Charging Function (PCF) in 5GMS specifications.
NOTE 6:	Some information might also be exchanged between 5GMSd entities and the OAM, although the OAM is not explicitly shown in the architecture.
The following functions are defined:
-	5G Media Streaming Client for downlink (5GMSd Client) on the UE: Receiver of 5GMS downlink media streaming service that may be accessed through well-defined interfaces/APIs. Alternatively, the UE may be implemented in a self-contained manner such that interfaces M6d and M7d are not exposed at all.
-	The 5GMSd Client contains two subfunctions:
-	Media Session Handler: A function on the UE that communicates with the 5GMSd AF in order to establish, control and support the delivery of a media session, and may perform additional functions such as consumption and QoE metrics collection and reporting. The Media Session Handler may expose APIs that can be used by the 5GMSd-Aware Application.
-	Media Player: A function on the UE that communicates with the 5GMSd AS in order to stream the media content and may provide APIs to the 5GMSd-Aware Application for media playback and to the Media Session Handler for media session control.
-	5GMSd-Aware Application: The 5GMSd Client is typically controlled by an external media application, e.g. an App, which implements external application or content service provider specific logic and enables a media session to be established. The 5GMSd-Aware Application is not defined within the 5G Media Streaming specifications, but the function makes use of 5GMSd Client and network functions using 5GMSd interfaces and APIs.
-	5GMSd AS: An Application Server which hosts 5G media functions. Note that there may be different realizations of the 5GMSd AS, including the distribution of 5GMSd AS functionality between different physical hosts, for example in a Content Delivery Network (CDN).
The 5GMSd AS in this release supports the following features:
i.	Content Hosting, including:
-	Ingesting media content from a 5GMSd Application Provider at reference point M2d.
-	Caching media content to reduce the need to ingest the same content repeatedly at reference point M2d.
-	A generic framework for content preparation.
-	Geographic restrictions on content access by the Media Player at reference point M4d (""geofencing"").
-	Domain Name aliasing at reference point M4d.
-	Support for server certificates at reference point M4d.
-	URL path rewriting at reference point M4d.
-	URL signing at reference point M4d.
NOTE 6a:	The features of the 5GMSd AS cater primarily for media streaming content. However, many of these features may also be used to support the delivery of other types of content, for example web content.
-	5GMSd Application Provider: External application or content-specific media functionality, e.g., media creation, encoding and formatting that uses 5GMSd interfaces to stream media to 5GMSd-Aware Applications.
-	5GMSd AF: An Application Function that provides various control functions to the Media Session Handler on the UE and/or to the 5GMSd Application Provider. It may relay or initiate a request for different Policy or Charging Function (PCF) treatment or interact with other network functions via the NEF.
NOTE 7:	There may be multiple 5GMSd AFs present in a deployment and residing within the Data Network , each exposing one or more APIs.
The following interfaces are defined for 5G Downlink Media Streaming:
-	M1d (5GMSd Provisioning API): External API, exposed by the 5GMSd AF which enables the 5GMSd Application Provider to provision the usage of the 5G Media Streaming System for downlink media streaming and to obtain feedback.
-	M2d (5GMSd Ingest API): Optional External API exposed by the 5GMSd AS used when the 5GMSd AS in the trusted DN is selected to host content for the streaming service.
-	M3d: (Internal and NOT SPECIFIED): Internal API used to exchange information for content hosting on a 5GMSd AS within the trusted DN.
-	M4d (Media Streaming APIs): APIs exposed by a 5GMSd AS to the Media Player to stream media content.
-	M5d (Media Session Handling API): APIs exposed by a 5GMSd AF to the Media Session Handler for media session handling, control, reporting and assistance that also include appropriate security mechanisms, e.g. authorization and authentication.
-	M6d (UE Media Session Handling APIs): APIs exposed by a Media Session Handler to the Media Player for client-internal communication, and exposed to the 5GMSd-Aware Application enabling it to make use of 5GMS functions.
-	M7d (UE Media Player APIs): APIs exposed by a Media Player to the 5GMSd-Aware Application and Media Session Handler to make use of the Media Player.
-	M8d: (Application API): application interface used for information exchange between the 5GMSd-Aware Application and the 5GMSd Application Provider, for example to provide Service Access Information to the 5GMSd-Aware Application. This API is external to the 5G System and not specified by 5GMS.
NOTE 8:	Non-Standalone, Roaming, Non-3GPP Access and EPC-5GC interworking aspects are FFS.
The following subfunctions are identified as a part of a more detailed breakdown of the 5GMSd AS for stage 3 specifications:
-	Adaptive Bit Rate (ABR) Encoder, Encryption and Encapsulator.
-	Manifest (e.g. MPD) Generator and Segment (e.g. DASH) Packager.
-	Origin Server.
-	CDN Server (e.g. Edge Servers).
-	DRM Server (e.g. DRM License Server).
-	Service Directory.
-	Content Guide Server.
-	Replacement content server (e.g. Ad content server).
-	Manifest Proxy, i.e. MPD modification server.
-	App Server.
-	Session Management Server.
A breakdown of 5GMSd functions in the UE is provided in clause 4.2.2 below.",TS 26.501,4.2.1,all_images/image_717.png,5G Downlink Media Streaming within 5G System
"The 5GMSd Application Provider uses 5GMSd functions for downlink streaming services. It provides a 5GMSd-Aware Application on the UE the ability to make use of 5GMSd Client and network functions using 5GMSd interfaces and APIs.
The architecture in Figure 4.2.1-1 below represents the specified 5GMSd functions within the 5G System (5GS) as defined in TS 23.501 [2]. Three main functions are defined:
-	5GMSd AF: An Application Function similar to that defined in TS 23.501 [2] clause 6.2.10, dedicated to 5G Downlink Media Streaming.
-	5GMSd AS: An Application Server dedicated to 5G Downlink Media Streaming.
-	5GMSd Client: A UE internal function dedicated to 5G Downlink Media Streaming. The 5GMSd Client is a logical function and its subfunctions may be distributed within the UE according to implementation choice.
5GMSd AF and 5GMSd AS are Data Network (DN) functions and communicate with the UE via the User Plane Function (UPF) using the N6 reference point as defined in TS 23.501 [2].
Functions in trusted DNs are trusted by the operator's network as illustrated in Figure 4.2.3-5 of TS 23.501 [2]. Therefore, AFs in trusted DNs may directly communicate with relevant 5G Core functions.
Functions in external DNs, i.e. 5GMSd AFs in external DNs, may only communicate with 5G Core functions via the NEF using N33.
NOTE 1:	The 5GMS architecture may be applied to an EPS although such an application is not specified in the present document and is left to the discretion of deployments and implementations.
Figure 4.2.1-1: 5G Downlink Media Streaming within 5G System
NOTE 2:	The functions indicated by the yellow filled boxes are in scope of stage 3 specifications for 5GMS. The functions indicated by the grey boxes are defined in 5G System specifications. The functions indicated by the blue boxes are neither in scope of 5G Media Streaming nor 5G System specifications.
The architecture in Figure 4.2.1-2 below represents the media architecture connecting UE internal functions and related network functions.
Figure 4.2.1-2: Media Architecture for unicast downlink media streaming
NOTE 3:	As described in the NOTE of Figure 4.1-2, the functions indicated by the yellow filled boxes are in scope of stage 3 for 5GMSd. The functions indicated by the grey boxes are defined in 5GS. The interfaces indicated by solid lines are in scope of stage 3 for 5GMSd. The interfaces indicated by dashed lines are defined in 5GS. The interfaces indicated by dotted lines are neither in scope of 5GS nor 5GMSd, but are considered as part of informative call flows.
NOTE 4:	Red ovals indicate API provider functions.
NOTE 5:	The 5GMSd AF may also interact with the NEF for NEF-enabled API access. However, within Release 16, the NEF is only used by the 5GMSd AF to interact with the Policy and Charging Function (PCF) in 5GMS specifications.
NOTE 6:	Some information might also be exchanged between 5GMSd entities and the OAM, although the OAM is not explicitly shown in the architecture.
The following functions are defined:
-	5G Media Streaming Client for downlink (5GMSd Client) on the UE: Receiver of 5GMS downlink media streaming service that may be accessed through well-defined interfaces/APIs. Alternatively, the UE may be implemented in a self-contained manner such that interfaces M6d and M7d are not exposed at all.
-	The 5GMSd Client contains two subfunctions:
-	Media Session Handler: A function on the UE that communicates with the 5GMSd AF in order to establish, control and support the delivery of a media session, and may perform additional functions such as consumption and QoE metrics collection and reporting. The Media Session Handler may expose APIs that can be used by the 5GMSd-Aware Application.
-	Media Player: A function on the UE that communicates with the 5GMSd AS in order to stream the media content and may provide APIs to the 5GMSd-Aware Application for media playback and to the Media Session Handler for media session control.
-	5GMSd-Aware Application: The 5GMSd Client is typically controlled by an external media application, e.g. an App, which implements external application or content service provider specific logic and enables a media session to be established. The 5GMSd-Aware Application is not defined within the 5G Media Streaming specifications, but the function makes use of 5GMSd Client and network functions using 5GMSd interfaces and APIs.
-	5GMSd AS: An Application Server which hosts 5G media functions. Note that there may be different realizations of the 5GMSd AS, including the distribution of 5GMSd AS functionality between different physical hosts, for example in a Content Delivery Network (CDN).
The 5GMSd AS in this release supports the following features:
i.	Content Hosting, including:
-	Ingesting media content from a 5GMSd Application Provider at reference point M2d.
-	Caching media content to reduce the need to ingest the same content repeatedly at reference point M2d.
-	A generic framework for content preparation.
-	Geographic restrictions on content access by the Media Player at reference point M4d (""geofencing"").
-	Domain Name aliasing at reference point M4d.
-	Support for server certificates at reference point M4d.
-	URL path rewriting at reference point M4d.
-	URL signing at reference point M4d.
NOTE 6a:	The features of the 5GMSd AS cater primarily for media streaming content. However, many of these features may also be used to support the delivery of other types of content, for example web content.
-	5GMSd Application Provider: External application or content-specific media functionality, e.g., media creation, encoding and formatting that uses 5GMSd interfaces to stream media to 5GMSd-Aware Applications.
-	5GMSd AF: An Application Function that provides various control functions to the Media Session Handler on the UE and/or to the 5GMSd Application Provider. It may relay or initiate a request for different Policy or Charging Function (PCF) treatment or interact with other network functions via the NEF.
NOTE 7:	There may be multiple 5GMSd AFs present in a deployment and residing within the Data Network , each exposing one or more APIs.
The following interfaces are defined for 5G Downlink Media Streaming:
-	M1d (5GMSd Provisioning API): External API, exposed by the 5GMSd AF which enables the 5GMSd Application Provider to provision the usage of the 5G Media Streaming System for downlink media streaming and to obtain feedback.
-	M2d (5GMSd Ingest API): Optional External API exposed by the 5GMSd AS used when the 5GMSd AS in the trusted DN is selected to host content for the streaming service.
-	M3d: (Internal and NOT SPECIFIED): Internal API used to exchange information for content hosting on a 5GMSd AS within the trusted DN.
-	M4d (Media Streaming APIs): APIs exposed by a 5GMSd AS to the Media Player to stream media content.
-	M5d (Media Session Handling API): APIs exposed by a 5GMSd AF to the Media Session Handler for media session handling, control, reporting and assistance that also include appropriate security mechanisms, e.g. authorization and authentication.
-	M6d (UE Media Session Handling APIs): APIs exposed by a Media Session Handler to the Media Player for client-internal communication, and exposed to the 5GMSd-Aware Application enabling it to make use of 5GMS functions.
-	M7d (UE Media Player APIs): APIs exposed by a Media Player to the 5GMSd-Aware Application and Media Session Handler to make use of the Media Player.
-	M8d: (Application API): application interface used for information exchange between the 5GMSd-Aware Application and the 5GMSd Application Provider, for example to provide Service Access Information to the 5GMSd-Aware Application. This API is external to the 5G System and not specified by 5GMS.
NOTE 8:	Non-Standalone, Roaming, Non-3GPP Access and EPC-5GC interworking aspects are FFS.
The following subfunctions are identified as a part of a more detailed breakdown of the 5GMSd AS for stage 3 specifications:
-	Adaptive Bit Rate (ABR) Encoder, Encryption and Encapsulator.
-	Manifest (e.g. MPD) Generator and Segment (e.g. DASH) Packager.
-	Origin Server.
-	CDN Server (e.g. Edge Servers).
-	DRM Server (e.g. DRM License Server).
-	Service Directory.
-	Content Guide Server.
-	Replacement content server (e.g. Ad content server).
-	Manifest Proxy, i.e. MPD modification server.
-	App Server.
-	Session Management Server.
A breakdown of 5GMSd functions in the UE is provided in clause 4.2.2 below.",TS 26.501,4.2.1,all_images/image_718.png,Media Architecture for unicast downlink media streaming
"The UE may include many detailed subfunctions that can be used individually or controlled individually by the 5GMSd-Aware Application. This clause breaks down several relevant identified subfunctions for which stage 3 specification is available.
NOTE:	This UE architecture is logical; the realization of reference points M6 and M7 inside the logical 5GMS Client is subject to implementation choice.
The 5GMSd-Aware Application itself may include many functions that are not provided by the 5GMSd Client or by the 5G UE. Examples include service and content discovery, notifications and social network integration. The 5GMSd-Aware Application may also include functions that are equivalent to ones provided by the 5GMSd Client and may only use a subset of the 5GMSd client functions. The 5GMSd-Aware Application may act based on user input or may for example also receive remote control commands from the 5GMSd Application Provider through M8d.
With respect to Media Player functions, Figure 4.2.2-1 below shows more detailed functional components of a UE for media player functions to access the 5GMSd AS.
Figure 4.2.2-1: UE 5G Downlink Media Streaming Functions (Media Player centric)
The following subfunctions are identified as part of a more detailed breakdown of the Media Player function:
-	Media Access Client: Accesses media content such as DASH-formatted media segments.
-	Media Decapsulation: Extracts the elementary media streams for decoding and provides media system related functions such as time synchronization, capability signalling, accessibility signalling, etc.
-	Consumption Measurement and Logging Client: Performs the measurement and logging of content consumption-related information in accordance with the Consumption Reporting Configuration part of provisioning data, supplied by the 5GMSd Application Provider to the 5GMSd AF, and forwarded by the 5GMSd AF to the Media Player via the Media Session Handler.
-	Metrics Measurement and Logging Client: Performs the measurement and logging of QoE metrics in accordance with the Metrics Reporting Configuration part of provisioning data, supplied by the 5GMSd Application Provider to the 5GMSd AF, and forwarded by the 5GMSd AF to the Media Player via the Media Session Handler.
-	DRM Client (optional): When present, the DRM client might or might not be a part of the Media Player. It provides a content protection mechanism with its unique key management and key delivery system, authentication/‌authorization, policy enforcement and entitlement check. The DRM Client is not defined within 5G Media Streaming specifications.
-	Media Decryption (optional): When present, media decryption is responsible to decrypt the media samples using the keys provided in the DRM license, and further passing to the Media Decoder to enable playback of encrypted media. The media decryption and media decoding could be implemented on a general-purpose processor in software or hardware or, for a more secure and robust architecture, the decryption, decoding and rendering could be implemented on the hardware of secure processors.
-	Media Decoder: Decodes the media, such as audio or video.
-	Media Presentation and Rendering: Presents the media using an appropriate output device and enables possible interaction with the media.
With respect to the Media Session Handler, Figure 4.2.2-2 below shows more detailed functional components of a UE to access the 5GMSd AF.
Figure 4.2.2-2: UE 5G Media Streaming Functions (Control-Centric)
NOTE 1:	The yellow colour indicates here that the 3GPP has created specifications for the function.
NOTE 2:	A UE is a logical device which may correspond to the tethering of multiple physical devices or other types of realizations.
The following subfunctions are identified as part of a more detailed breakdown of Media Session Handler:
-	Core Functions: Realization of a ""session"" concept for media communications, optionally spanning multiple stateless sessions. May optionally interact with network-based 5GMSd AFs.
-	Metrics Collection and Reporting: executes the collection of QoE metrics measurement logs from the Media Player and sending of metrics reports to the 5GMSd AF for the purpose of metrics analysis or to enable potential transport optimizations by the network.
-	Consumption Collection and Reporting: executes the collection of content consumption measurement logs from the Media Player and sending of consumption reports to a 5GMSd AF about the currently consumed media within the available presentation, about the UE capabilities and about the environment of the media session for potential transport optimizations by the network or consumption report analysis.
.-	Network Assistance: downlink streaming delivery assisting functions provided by the network to the 5GMSd Client and Media Player in the form of bit rate recommendation (or throughput estimation) and/or delivery boost. Network Assistance functionality may be supported by 5GMSd AF or ANBR-based RAN signalling mechanisms.
NOTE 3:	Based on such a decomposition, additional interfaces and APIs may exist in inside the UE:
-	Media control interface(s) to configure and interact with the different UE media functions.
-	Media control interface for media session management.
-	Control interface for collection of logged QoE metrics measurements..
-	Control interface for collection of logged content consumption measurements.
-	Decoded media samples are handed over to the media renderer.
-	Decrypted, compressed media samples are handed over to a trusted media decoder.
-	In the case of encryption, the encrypted, compressed media samples are handed over to the DRM Client.
NOTE 4:	Non-Standalone, Roaming, Non-3GPP Access and EPC-5GC interworking aspects are FFS.",TS 26.501,4.2.2,all_images/image_719.png,UE 5G Downlink Media Streaming Functions (Media Player centric)
"The UE may include many detailed subfunctions that can be used individually or controlled individually by the 5GMSd-Aware Application. This clause breaks down several relevant identified subfunctions for which stage 3 specification is available.
NOTE:	This UE architecture is logical; the realization of reference points M6 and M7 inside the logical 5GMS Client is subject to implementation choice.
The 5GMSd-Aware Application itself may include many functions that are not provided by the 5GMSd Client or by the 5G UE. Examples include service and content discovery, notifications and social network integration. The 5GMSd-Aware Application may also include functions that are equivalent to ones provided by the 5GMSd Client and may only use a subset of the 5GMSd client functions. The 5GMSd-Aware Application may act based on user input or may for example also receive remote control commands from the 5GMSd Application Provider through M8d.
With respect to Media Player functions, Figure 4.2.2-1 below shows more detailed functional components of a UE for media player functions to access the 5GMSd AS.
Figure 4.2.2-1: UE 5G Downlink Media Streaming Functions (Media Player centric)
The following subfunctions are identified as part of a more detailed breakdown of the Media Player function:
-	Media Access Client: Accesses media content such as DASH-formatted media segments.
-	Media Decapsulation: Extracts the elementary media streams for decoding and provides media system related functions such as time synchronization, capability signalling, accessibility signalling, etc.
-	Consumption Measurement and Logging Client: Performs the measurement and logging of content consumption-related information in accordance with the Consumption Reporting Configuration part of provisioning data, supplied by the 5GMSd Application Provider to the 5GMSd AF, and forwarded by the 5GMSd AF to the Media Player via the Media Session Handler.
-	Metrics Measurement and Logging Client: Performs the measurement and logging of QoE metrics in accordance with the Metrics Reporting Configuration part of provisioning data, supplied by the 5GMSd Application Provider to the 5GMSd AF, and forwarded by the 5GMSd AF to the Media Player via the Media Session Handler.
-	DRM Client (optional): When present, the DRM client might or might not be a part of the Media Player. It provides a content protection mechanism with its unique key management and key delivery system, authentication/‌authorization, policy enforcement and entitlement check. The DRM Client is not defined within 5G Media Streaming specifications.
-	Media Decryption (optional): When present, media decryption is responsible to decrypt the media samples using the keys provided in the DRM license, and further passing to the Media Decoder to enable playback of encrypted media. The media decryption and media decoding could be implemented on a general-purpose processor in software or hardware or, for a more secure and robust architecture, the decryption, decoding and rendering could be implemented on the hardware of secure processors.
-	Media Decoder: Decodes the media, such as audio or video.
-	Media Presentation and Rendering: Presents the media using an appropriate output device and enables possible interaction with the media.
With respect to the Media Session Handler, Figure 4.2.2-2 below shows more detailed functional components of a UE to access the 5GMSd AF.
Figure 4.2.2-2: UE 5G Media Streaming Functions (Control-Centric)
NOTE 1:	The yellow colour indicates here that the 3GPP has created specifications for the function.
NOTE 2:	A UE is a logical device which may correspond to the tethering of multiple physical devices or other types of realizations.
The following subfunctions are identified as part of a more detailed breakdown of Media Session Handler:
-	Core Functions: Realization of a ""session"" concept for media communications, optionally spanning multiple stateless sessions. May optionally interact with network-based 5GMSd AFs.
-	Metrics Collection and Reporting: executes the collection of QoE metrics measurement logs from the Media Player and sending of metrics reports to the 5GMSd AF for the purpose of metrics analysis or to enable potential transport optimizations by the network.
-	Consumption Collection and Reporting: executes the collection of content consumption measurement logs from the Media Player and sending of consumption reports to a 5GMSd AF about the currently consumed media within the available presentation, about the UE capabilities and about the environment of the media session for potential transport optimizations by the network or consumption report analysis.
.-	Network Assistance: downlink streaming delivery assisting functions provided by the network to the 5GMSd Client and Media Player in the form of bit rate recommendation (or throughput estimation) and/or delivery boost. Network Assistance functionality may be supported by 5GMSd AF or ANBR-based RAN signalling mechanisms.
NOTE 3:	Based on such a decomposition, additional interfaces and APIs may exist in inside the UE:
-	Media control interface(s) to configure and interact with the different UE media functions.
-	Media control interface for media session management.
-	Control interface for collection of logged QoE metrics measurements..
-	Control interface for collection of logged content consumption measurements.
-	Decoded media samples are handed over to the media renderer.
-	Decrypted, compressed media samples are handed over to a trusted media decoder.
-	In the case of encryption, the encrypted, compressed media samples are handed over to the DRM Client.
NOTE 4:	Non-Standalone, Roaming, Non-3GPP Access and EPC-5GC interworking aspects are FFS.",TS 26.501,4.2.2,all_images/image_720.png,UE 5G Media Streaming Functions (Control-Centric)
"The 5GMSu Application Provider uses 5GMSu functions for uplink streaming services. It provides a 5GMSu-Aware Application on the UE the ability to make use of 5GMSu Client and network functions using 5GMSu interfaces and APIs.
Figure 4.3.1-1: Media Architecture for unicast uplink media streaming
NOTE 1:	The functions indicated by the yellow filled boxes are in scope of stage 3 specifications for 5GMS. The functions indicated by the grey boxes are defined in 5G System specifications. The functions indicated by the blue boxes are neither in scope of 5G Media Streaming nor 5G System specifications.
The architecture in Figure 4.3.1-1 above represents the specified 5GMSu functions within the 5G System (5GS) as defined in TS 23.501 [2]. Three main functions are defined:
-	5GMSu AF: An Application Function similar to that defined in TS 23.501 [2] clause 6.2.10, dedicated to 5G Uplink Media Streaming.
-	5GMSu AS: An Application Server dedicated to 5G Uplink Media Streaming.
-	5GMSu Client: A UE-internal function dedicated to 5G Uplink Media Streaming.
5GMSu AF and 5GMSu AS are Data Network (DN) functions and communicate with the UE via N6 as defined in TS 23.501 [2].
Functions in trusted DNs, e.g., a 5GMSu AF in the Trusted DN, are trusted by the operator's network as illustrated in Figure 4.2.3-5 of TS 23.501 [2]. Therefore, such AFs may directly communicate with relevant 5G Core functions.
Functions in external DNs, e.g., a 5GMSu AF in the External DN, may only communicate with 5G Core functions via the NEF using N33.
The architecture in Figure 4.3.1-2 below represents the media architecture connecting UE internal functions and related network functions for 5G Uplink Media Streaming.
Figure 4.3.1-2: Media Architecture for unicast uplink media streaming
NOTE 2:	The functions indicated by the yellow filled boxes are in scope of stage 3 for 5GMSu. The functions indicated by the grey boxes are defined in 5GS. The interfaces indicated by solid lines are in scope of stage 3 for 5GMSu. The interfaces indicated by dashed lines are defined in 5GS. The interfaces indicated by dotted lines are neither in scope of 5GS nor 5GMSu, but are considered as part of informative call flows.
NOTE 3:	Red ovals indicate API provider functions.
NOTE 4:	The 5GMSu AF may also interact with the NEF for NEF-enabled API access. However, within Release 16, the NEF is only used by the 5GMSu AF to interact with the Policy and Charging Function (PCF) in 5GMS specifications.
NOTE 5:	Some information might also be exchanged between 5GMSu entities and the OAM, although the OAM is not explicitly shown in the architecture.
The following functions are defined:
-	5G Media Streaming Client for uplink (5GMSu Client) on UE: Originator of 5GMSu service that may be accessed through well-defined interfaces/APIs. The UE may also be implemented in a self-contained manner such that interfaces M6u and M7u are not exposed at all.
-	The 5GMSu Client contains two subfunctions:
-	Media Session Handler: A function on the UE that communicates with the 5GMSu AF in order to establish, control and support the delivery of a media session, and that may perform QoE metrics reporting. The Media Session Handler exposes APIs that can be used by the 5GMSu-Aware Application.
-	Media Streamer: A function on the UE that communicates with the 5GMSu AS in order to perform uplink streaming of media content and provides a service to both the 5GMSu-Aware Application for media capturing and uplink streaming and the Media Session Handler for media session control.
-	5GMSu-Aware Application: The 5GMSu Client is typically controlled by an external media application, e.g. an App, which implements external application or content service provider specific logic and enables a media session to be established. The 5GMSu-Aware Application is not defined within the 5G Media Streaming specifications, but the function makes use of 5GMSu Client and network functions using 5GMSu interfaces and APIs.
-	5GMSu AS: An Application Server which hosts 5G media functions. Note that there may be different realizations of a 5GMSu AS, for example a Content Delivery Network (CDN) server.
-	5GMSu Application Provider: External application or content-specific media functionality, e.g., media storage, consumption, transcoding and redistribution that uses 5GMSu interfaces to receive streaming media from 5GMSu Aware Applications.
-	5GMSu AF: An Application Function that provides various control functions to the Media Session Handler on the UE and/or to the 5GMSu Application Provider. It may relay or initiate a request for different Policy or Charging Function (PCF) treatment or interact with other network functions via the NEF.
NOTE 6:	There may be multiple 5GMSu AFs present in a deployment and residing within the Data, each exposing one or more APIs.
The following interfaces are defined for 5G Uplink Media Streaming:
-	M1u (5GMSu Provisioning API): External API, exposed by the 5GMSu AF and which enables the 5GMSu Application Provider to provision the usage of the 5G Media Streaming system for uplink media streaming and to obtain feedback.
-	M2u (5GMSu Publish API): Optional External API exposed by the 5GMSu AS used when the 5GMSu AS in the trusted DN is selected to receive the content for the streaming service.
-	M3u: (Internal and NOT SPECIFIED): Internal API used to exchange information for content hosting on a 5GMSu AS within the trusted DN.
-	M4u (Uplink Media Streaming APIs): APIs exposed by a 5GMSu AS to the Media Streamer to stream media content.
-	M5u (Media Session Handling API): APIs exposed by a 5GMSu AF to the Media Session Handler for media session handling, control and assistance that also include appropriate security mechanisms e.g. authorization and authentication, and QoE metrics reporting.
-	M6u (UE Media Session Handling APIs): APIs that may be exposed by a Media Session Handler to the Media Streamer for client-internal communication, and to the 5GMSu-Aware Application to make use of 5GMSu functions.
-	M7u (UE Media Streamer APIs): APIs that may be exposed by a Media Streamer to the 5GMSu-Aware Application and Media Session Handler to make use of the Media Streamer, including configuration of QoE metrics to be measured and logged, and the collection of metrics measurement logs.
-	M8u: (Application API): application interface used for information exchange between the 5GMSu-Aware Application and the 5GMSu Application Provider, for example to provide Service Access Information to the 5GMSu-Aware Application. This API is external and not specified in the 5GMS architecture.
NOTE 7:	Non-Standalone, Roaming, Non-3GPP Access and EPC-5GC interworking aspects are FFS.",TS 26.501,4.3.1,all_images/image_721.png,Media Architecture for unicast uplink media streaming
"The UE may include many detailed subfunctions that can be used individually or controlled individually by the 5GMSu-Aware Application. This clause breaks down several relevant identified subfunctions for which stage 3 specification is available.
The 5GMSu-Aware Application itself may include many functions that are not provided by the 5GMSu Client or to the 5G UE. Examples include peripheral discovery, notifications and social network integration. The 5GMSu-Aware Application may also include functions that are equivalent to ones provided by the 5GMSu Client and may only use a subset of the 5GMSu Client functions.
With respect to the Media Streamer and Media Handler functions, Figure 4.3.2-1 shows more detailed functional components of a 5GMSu Client.
Figure 4.3.2-1: UE 5G Uplink Media Streaming Functions
NOTE 1:	A UE is a logical device which may correspond to the tethering of multiple physical devices or other types of realizations.
The following subfunctions are identified as part of a more detailed breakdown of the UE 5G Uplink Media Streaming functions:
-	5GMSu-Aware Application: application which is out of scope of the present specification and which uses the UE 5G Uplink Media Streaming functions and APIs.
-	Media Capturing: Devices such as video cameras or microphones that transform an analogue media signal into digital media data.
-	Media Encoder(s): Compresses the media data.
-	Metrics Measurement and Logging: execution of QoE metrics measurement and logging by the Media Streamer in accordance with the metrics configuration.
-	Metrics Collection and Reporting: execution of the collection of QoE metrics measurement logs from the Media Streamer by the Media Session Handler for subsequent metrics reporting to the 5GMSu AF, in accordance with the metrics configuration.
-	Media Upstream Client: encapsulates encoded media data and pushes it upstream.
NOTE 2:	The Media Upstream Client maps logically to the FLUS media function in the FLUS Source specified in TS 26.238 [5] Uplink Streaming stage 3.
-	Network Assistance: uplink streaming delivery assisting functions provided by the network to the 5GMSu Client and Media Streamer in the form of bit rate recommendation (or throughput estimation) and/or delivery boost. Network Assistance functionality may be supported by 5GMSu AF or ANBR-based RAN signalling mechanisms.
NOTE 3:	The Network Assistance function maps logically to the FLUS Assistance function specified in TS 26.238 [5] Uplink Streaming stage 3.
-	Media Remote Control: receives control commands from a 5GMSu AF.
NOTE 4:	Media Remote Control maps logically to the FLUS Remote control function specified in TS 26.238 [5] Uplink Streaming stage 3.
-	Core Functions: configures the 5GMSu AS for uplink streaming reception.
NOTE 5:	The core functions map logically to the FLUS control function in the FLUS source specified in TS 26.238 [5] Uplink Streaming stage 3.
Here are the roles of the different APIs of the UE 5G Uplink Media Streaming functions:
-	M6u: API used to control the Core Functions and the Remote Control function.
-	M7u: API used to configure, activate and stop the Media Capturing, Media Encoding(s) and Media Upstream Client functions, and also to support metrics configuration and collection functionality.",TS 26.501,4.3.2,all_images/image_723.png,UE 5G Uplink Media Streaming Functions
"Figure 4.6.1-1 below depicts an architecture for downlink 5G Media Streaming via eMBMS that combines the functions and reference points of the 5GMS System with those of the MBMS System.
Figure 4.6.1-1: Architecture for 5G Media Streaming over eMBMS
This arrangement allows 5GMS-based downlink media streaming to be deployed as an MBMS-aware Application on top of eMBMS as defined in TS 23.246 [18], TS 26.346 [19], TS 26.347 [20] and TS 26.348 [21].
In this case:
1.	The 5GMSd AF configures the delivery of 5GMSd content to an MBMS Client in the UE by creating a Service as defined in TS 26.348 [21], clause 5.3. In order to additionally deliver this content over an MBMS User Service, the 5GMSd AF invokes xMB-C control plane procedures on the BM SC as specified in clauses 5.3 and 5.4 of TS 26.348 [21] and, as a result, content is ingested by the BM-SC from the 5GMSd AS using the xMB-U File Distribution procedures specified in clause 5.5.2 of TS 26.348 [21] to allow xMB-C Session types Application and Files.
2.	The 5GMSd Client acts as eMBMS-Aware Application (as defined in TS 26.347 [20]) for the MBMS Client. Thus, the MBMS Client is controlled by the 5GMSd Client via the Media Streaming Service API specified in clause 6.3 of TS 26.347 [20] or via the File Delivery Application Service API specified in clause 6.2 of TS 26.347 [20]. (This interaction is labelled MBMS-API-C in figure 4.6.1-1 above.)
3.	The MBMS Client receives media and other objects from the BM-SC according to the MBMS Download Delivery Method specified in clause 7 of TS 26.346 [19]. If an uplink is available to the MBMS Client, and if associated delivery procedures as specified in clause 9.3 of TS 26.346 [19] are activated, the MBMS Client uses the associated delivery procedures to recover damaged media objects received from the BM-SC for xMB-C Session type Files.
4.	The Media Server function interfaces with the MBMS Client per figure 5.1 of TS 26.347 [20], and shall expose the content received (and possibly repaired) by the MBMS Client to the 5GMSd Client via the HTTP client-to-application interface specified in clause 7.2 of TS 26.347 [20]. (This interaction is labelled MBMS-API-U in figure 4.6.1-1 above.)
5.	The media player sends requests according to the signalled object availability times in the manifest. In case a media object transmitted via the MBMS User Service is not received by the MBMS Client by the object availability times, or if it cannot be repaired in time for consumption by the 5GMS Client, the Media Server returns an error or a partial object in response to the Media Player's request for the media object, and the Media Player may instead attempt to retrieve the media object, or ranges of it, from the 5GMSd AS at reference point M4d, if available. The object shall be available for the application for a well-defined time duration.
NOTE:	Details on determining the availability time requirements of the application are deferred to stage-3.
The usage of existing reference points to support these scenarios is documented in the following clauses. Procedures for 5GMS via eMBMS are defined in clause 5.10.",TS 26.501,4.6.1,all_images/image_724.png,Architecture for 5G Media Streaming over eMBMS
"The abstract data collection and reporting architecture defined in clause 4 of TS 26.531 [22] and depicted in figure 4.2-1 of TS 26.531 [22] is instantiated in the 5G Media Streaming architecture as shown in figure 4.7.1-1 and as defined below.
Figure 4.7.1-1: Data collection and reporting architecture instantiation for 5G Media Streaming
The functional elements in this instantiation are defined as follows:
-	The role of the Application Service Provider in the abstract architecture is played by the 5GMS Application Provider.
-	The Data Collection AF for 5G Media Streaming is instantiated in the 5GMS AF.
-	The Direct Data Collection Client for 5G Media Streaming is instantiated in the Media Session Handler. This takes logical responsibility for the Metrics Collection & Reporting and Consumption Collection & Reporting subfunctions.
-	The Provisioning AF of the Application Service Provider is not instantiated in the 5GMS architecture. Data collection and reporting is instead provisioned using the procedures defined in the present document.
-	The Indirect Data Collection Client is not instantiated in the 5GMS architecture. Indirect reporting of UE data is outside the scope of 5G Media Streaming.
-	The role of the AS data collection client in the abstract reference architecture is played by 5GMS AS. This may be deployed as a trusted AS within the 5G System or deployed externally.
-	The Event Consumer AF is instantiated in the 5GMS Application Provider as a consumer of 5G Media Streaming events from the Data Collection AF.
The reference points as defined as follows in this instantiation:
R1	This reference point is not instantiated in the 5GMS architecture.
M1	Provisioning of data collection and reporting features in the Data Collection AF.
R2	This reference point is not instantiated in the 5GMS architecture. Instead, it is logically realised by the combination of the following components:
-	Internal interfaces between the Direct Data Reporting Client and its subordinate functions, namely Metrics Collection & Reporting and Consumption Reporting & Reporting.
-	Internal interface between the Media Session Handler and its subordinate Direct Data Collection Client function.
-	Reference point M5, as defined below.
-	Internal interface between the 5GMS AF and its subordinate Data Collection AF function.
M5	Direct data reporting by the Direct Data Collection Client to the Data Collection AF, via the Media Session Handler and 5GMS AF.
R3	This reference point is not instantiated in the 5GMS architecture.
R4	Media streaming access reporting by the 5GMS AS to the Data Collection AF.
R5	Event exposure by the Data Collection AF to subscribing NWDAF [23] instances.
R6	Event exposure by the Data Collection AF to subscribing Event Consumer AF instances in the 5GMS Application Provider.
R7	This reference point is not instantiated in the 5GMS architecture.
M6	Configuration of 5GMS-related data reporting by the 5GMS-Aware Application.
R8	This reference point is not instantiated in the 5GMS architecture.",TS 26.501,4.7.1,all_images/image_725.png,Data collection and reporting architecture instantiation for 5G Media Streaming
"The downlink streaming procedures follow the general high-level workflow depicted in Figure 5.1-1 below, starting from provisioning and ingest session preparation to the actual content streaming sessions. The Ingest Session refers to the time interval during which media content is uploaded to the 5GMSd AS. The Provisioning Session refers to the time interval during which the 5GMSd Client can access the media content and the 5GMSd Application Provider can control and monitor the media content and its delivery. Interactions between the 5GMSd AF and the 5GMSd Application Provider may occur at any time while the Provisioning Session is active.
Figure 5.1-1: High Level Procedure for downlink streaming
The 5GMSd provisioning API at M1d allows selection of media session handling (M5d) and media streaming (M4d) options, including whether the media content is hosted on trusted 5GMSd AS instances. of provisioned 5GMSd features is captured in a Provisioning Session (see clause 5.3) that is uniquely identified in the 5GMS System by a Provisioning Session identifier. The Provisioning Session information may include Content Hosting Configurations, Content Preparation Templates, Server Certificates, Policy Templates, a Consumption Reporting Configuration, Metrics Reporting Configurations, Edge Resources Configurations and Event Data Processing Configurations.
The Consumption Reporting and/or Metrics Reporting Configuration information provisioned over M1d and passed to the 5GMSd Client by the 5GMSd AF over M5d determines the UE data to be collected by the 5GMSd Client and subsequently reported to the 5GMSd AF. The 5GMSd Application Provider is additionally able to provision Event Data Processing Configurations that specify data processing instructions for subsequent manipulation by the 5GMSd AF of UE data, whether reported by the 5GMSd Client or otherwise obtained, and rules for restricting the subsequent exposure by the 5GMSd AF of UE data to event consumers including the NWDAF defined in TS 23.288 [23] and/or the 5GMSd Application Provider.
The 5GMSd AF selects the M5d interface features according to the provisioning option. The Media Session Handling interface exposed by the 5GMSd AF can be used for core session handling; configuring content consumption measurement, logging, collection and reporting; configuring QoE metrics measurement, logging collection and reporting; requesting different policy and charging treatments; or 5GMSd AF-based Network Assistance.
When the media content is hosted by trusted 5GMSd AS instances, then the 5GMSd AF selects and configures the 5GMSd AS. Interactions between a 5GMSd AF and a 5GMSd AS (M3d interactions) take place for content hosting configuration, including 5GMS Ingest (M2d) and Media Streaming (M4d) resource reservations. The 5GMSd AS allocates M2d and M4d resources and communicates resource identifiers back to the 5GMSd AF. The 5GMSd AF provides information about the provisioned resources (in form of resource identifiers) for Media Session Handling (M5d), the 5GMSd Ingest (M2d) and the Media Streaming (M4d), to the 5GMSd Application Provider. The resource identifiers for Media Session Handling and Media Streaming are needed by the 5GMSd Client to access the 5GMSd functions.
When Content Hosting is provided by a 5GMSd AS in the external DN, then the M3d interface is not used and the 5GMSd AF does not provide 5GMS Ingest (M2d) and Media Streaming (M4d) resource reservations. M3d procedures are not standardized.
5GMSd Clients can (in principle) start streaming media as soon as the corresponding content is ingested by activating a unicast downlink streaming session. However, it may take some time until the media content is available for Media Streaming (via the Media Streaming API) or the distribution availability might be based on a provisioned schedule. The unicast downlink streaming session for a given UE (or ""for each UE"") is active from the time at which the 5GMSd-Aware Application activates the reception of a streaming service until its termination.
The 5GMSd-Aware Application receives application data from the 5GMSd Application Providerbefore receiving the downlink streaming media. The application data contains Service Access Information, which acts as an entry point for the 5GMSd Client to start the downlink streaming session. The 5GMSd Client may either receive a reference to that Service Access Information or the full Service Access Information from the 5GMSd Application Provider.
Steps:
1.	The 5GMSd Application Provider creates a Provisioning Session with the 5GMSd AF and starts provisioning the usage of the 5G Media Streaming System. During the establishment phase, the used features are negotiated and detailed configurations are exchanged. The 5GMSd AF receives Service Access Information for M5d (Media Session Handling) and, where media content hosting is negotiated, Service Access Information for M2d (Ingestion) and M4d (Media Streaming) as well. This information is needed by the 5GMSd Client to access the service. Depending on the provisioning, only a reference to the Service Access Information might be supplied.
2.	When Content Hosting is offered and selected there may be interactions between the 5GMSd AF and the 5GMSd AS, e.g. to allocate 5GMSd content ingest and  distribution resources. The 5GMSd AS provides resource identifiers for the allocated resources to the 5GMSd AF, which then provides the information to the 5GMSd Application Provider. The M3d procedures between 5GMSd AF and 5GMSd AS are not specified.
3.	The 5GMSd Application Provider starts the Ingest Session by ingesting content. In case of live services, the content is continuously ingested. In case of on-demand streaming services, the content may be uploaded once and then updated later on.
NOTE 1:	A 5GMSd AS in the external Data Network may provide the Content Hosting.
4.	The 5GMSd Application Provider provides the Service Announcement Information to the 5GMSd-Aware Application. The service announcement includes either the whole Service Access Information (i.e. details for Media Session Handling (M5d) and for Media Streaming access (M4d)) or a reference to the Service Access Information or pre-configured information. When only a reference is included, the 5GMSd Client fetches (in step 6) the Services Access Information when needed.
5.	When the 5GMSd-Aware Application decides to begin streaming, the Service Access Information (all or a reference) is provided to the 5GMSd Client. The 5GMSd Client activates the unicast downlink streaming session.
6.	(Optional) In case the 5GMSd Client received only a reference to the Service Access Information, then it acquires the Service Access Information from the 5GMSd AF.
NOTE 2:	Pre-caching of Service Access Information may also be supported by the 5GMS Client to speed up the activation of the service.
7.	The 5GMSd Client uses the Media Session Handling API exposed by the 5GMSd AF at M5d. The Media Session Handling API is used for configuring content consumption measurement, logging, collection and reporting; configuring QoE metrics measurement, logging, collection and reporting; requesting different policy and charging treatments; or 5GMSd AF-based Network Assistance. The actual time of API usage depends on the feature and interactions that may be used during the media content reception.
8.	The 5GMSd Client activates reception of the media content.",TS 26.501,5.1,all_images/image_726.jpeg,High Level Procedure for downlink streaming
,TS 26.501,5.2,all_images/image_727.png,High Level Procedure for progressive download for on-demand media
,TS 26.501,5.2,all_images/image_728.png,High Level Procedure for DASH content
"The present clause describes the baseline procedure to provision the features using the 5GMS System.
NOTE 1:	SLA negotiations between the 5GMSd Application Provider and the 5GMS System provider are outside the scope of the present specification and are included in the figure below for illustrative purposes only.
Figure 5.3.2-1: High Level Procedure for provisioning the 5GMS System for downlink streaming sessions
Steps:
1.	The 5GMSd Application Provider discovers the address (URL) of the 5GMSd AF (M1d) for Session Provisioning.
2.	The 5GMSd Application Provider authenticates itself with the system. This procedure reuses existing authentication/authorization procedures, e.g. as defined for CAPIF [13].
3.	The 5GMSd Application Provider creates a Provisioning Session, providing its 5GMSd Application Provider identifier as input. 5GMSd Application Provider queries the capabilities and authorized features.
4.	The 5GMSd Application Provider specifies one or more 5GMSd features in the Provisioning Session. A set of authorized features is activated, such as content consumption measurement, logging, collection and reporting; QoE metrics measurement, logging, collection and reporting; dynamic policy; network assistance; and content hosting (including ingest).
When the content hosting feature is offered and selected, the 5GMS Application Provider configures the content hosting behaviour of the 5GMSd AS. This Content Hosting Configuration is specified in clause 5.4 and includes selecting the ingest protocol and format, caching and proxying of media objects, content preparation, access protection (e.g. URL signing) and indicating a target distribution area (e.g. through geofencing).
When the dynamic policy feature is offered and selected, the 5GMSd Application Provider specifies a set of policies which can be invoked for the unicast downlink streaming session. The UE becomes aware of the selected policies in the form of a list of valid Policy Template Ids.
When the content consumption measurement, logging, collection and reporting feature is offered and selected, the 5GMSd Application Provider indicates the desired reporting interval. When the 5GMSd Application Provider has delegated Service Access Information handling to the 5GMS System, then location reporting is also selected or de-selected.
When the QoE metrics measurement, logging, collection and reporting feature is offered and selected, the 5GMSd Application Provider provides configuration input on the QoE post processing. When the 5GMSd Application Provider has delegated Service Access Information handling to the 5GMS System, then more detailed metrics reporting is configured.
When the edge computing feature is offered and selected, the 5GMSd Application Provider provides one or more Edge Resources Configurations that can be used to support either client-driven management or Application Provider-driven management of edge resources associated with the Provisioning Session.
When the event data processing feature is offered and selected, the 5GMSd Application Provider provides one or more Event Data Processing Configurations that determine how, in the scope of the Provisioning Session, content consumption and QoE metrics collected from the UE and application logs collected from the 5GMSd AS are processed into events and exposed to subscribers.
5.	When content hosting is desired, the 5GMSd AF interacts with the 5GMSd AS to allocate M2d resources and configure the ingest format. Then the 5GMSd AS responds with the M2d address. The 5GMSd AF selects the desired ingest format.
6.	The 5GMSd AF compiles the Service Access Information. The Service Access Information contains access details and options such as the Provisioning Session identifier, M5d (Media Session Handling) addresses for content consumption reporting, QoE metrics reporting, dynamic policy, network assistance, etc. When content hosting is offered and has been selected in step 4, then also M4d (Media Streaming) information such as the DASH MPD is included.
7.	The 5GMSd AF provides the results to the 5GMSd Application Provider.
a.	When the 5GMSd Application Provider has selected full Service Access Information, then the results are provided in the form of addresses and configurations for M2d (Ingest), M5d (Media Session Handling) and M4d (Media Streaming).
b.	When the 5GMSd Application Provider delegated the service access information handling to the 5GMS System, then a reference to the Service Access Information (e.g. an URL) is provided. The Media Session Handler fetches the full Service Access Information later from the 5GMSd AF.
8.	When content hosting is offered and has been selected in step 4, the 5GMSd Application Provider can start supplying content at the M2d ingest interface. In the case of progressive download or on-demand DASH sessions, the 5GMSd Application Provider makes the content assets available. In the case of Live DASH streaming sessions, the 5GMSd Application Provider starts supplying the live content.
9.	The 5GMSd Application Provider executes Service Announcement and updates the UEs (during the lifetime of the Provisioning Session).
Optional:
10.	The 5GMSd Application Provider may update the Provisioning Session.
Depending on the parameters of the Provisioning Session:
11.	The 5GMSd AF may send event-related or periodic notifications to the 5GMSd Application Provider.
According to schedule, or upon request:
12.	The 5GMSd Application Provider may manually terminate the Provisioning Session (at any time). All associated resources are released. Content may be removed from the 5GMSd AS. The 5GMSd Application Provider may configure a schedule for Provisioning Session termination.
13.	The 5GMSd AF sends a notification upon Provisioning Session termination.
The 5GMSd AF may request the creation or reuse of one or more network slices for distributing the content of the provisioned session. If more than one network slice is provisioned for the distribution of the content of a session, the list of allowed S-NSSAIs shall be conveyed to the target UEs (e.g. through URSP or through M5d or M8d).
NOTE 2:	The 5GMSd AS(s) serving the content are only accessible through the DNN(s) used by the network slice(s) provisioned for the distribution of that content.",TS 26.501,5.3.2,all_images/image_730.png,High Level Procedure for provisioning the 5GMS System for downlink streaming
"In the first use-case, shown in Figure 5.5.2-1 below, the 5GMS System operator controls the metrics collection and reporting using the RAN-based configuration method. In this case the metrics are configured via the RAN and the control plane, independent of 5GMS functional support.
Figure 5.5.2-1: Metrics collection and reporting via RAN-based configuration
The different steps are explained below:
1:	Overall metrics configuration is done on the network level, for instance defining which geographical areas that shall have metrics collection active, which metrics to collect, and how metrics shall be reported. If per-slice metrics collection and reporting is supported, a slice scope may be present in the metrics configuration, indicating the specific slice instance(s) for metrics collection and reporting.
2:	The metrics configuration(s) is/are sent from the OAM to the RAN, which does not forward that information to the UE at this stage.
3:	Time passes, and it is assumed that the UE moves around during that period.
4:	The UE enters an area (cell, location area, etc.,) which is inside the geographical constraint. This is discovered by the RAN, and it now needs to activate metrics collection and reporting for the UE.
5:	The actual metrics configuration is sent from the RAN to the Media Session Handler, via the control plane.
6:	Additional time passes, and the UE has a metrics configuration, but no streaming session has started.
7:	A streaming session is started.
8:	The session setup is done in conjunction with signalling transactions (not shown here).
8a:	If a slice scope is included in the metrics configuration set, the Media Session Handler shall check the running slice which is carrying the current media streaming (e.g. via the AT Command +CGDCONT [24] or the specific traffic mapping with URSP [4]). If the running slice is within the slice scope, the metrics collection and reporting shall be excuted. Additionally, the running slice shall also be included into the metrics reports.
9:	A new metrics collection job is created in the Media Player.
10:	A reference to the new metrics collection job is returned.
11:	The configuration for the metrics collection job is sent to the Media Player (i.e. which metrics should be measured) along with the measurement resolution interval). The metrics reporting interval timer is activated in the Media Session Handler.
12:	Media is delivered and rendered, and...
13:	...more media is delivered...
14:	The configured metrics reporting interval has elapsed, and the Media Session Handler now requests the collected metrics from the Media Player.
15:	The Media Player returns the collected metrics.
16:	The metrics are reported via the control plane.
17:	The session continues...
18:	more media is delivered, and then the session is finished.
19:	The Media Session Handler requests the final metrics collected.
20:	The Media Player returns the final collected metrics.
21:	The metrics are reported to the OAM via the control plane.
21a: The OAM may determine the per-slice QoE metrics based on the metrics reports and the slice scope.
22:	The metrics collection job is deleted.
23:	Time passes, the UE moves around.
24:	The UE leaves the geographical area specified by the metrics configuration.
25:	The RAN sends metrics (de)configuration to the UE, to stop future metrics collection.",TS 26.501,5.5.2,all_images/image_732.png,Metrics collection and reporting via RAN-based configuration
"The 5GMSd Application Provider requests the assignment of more than one network slice for the distribution of the service. The 5GMSd Application Provider indicates the desired network slice features that correspond to the Service Access Information. Upon successful assignment of the network slices for the service, the 5GMSd AF shall respond with the list of allowed S-NSSAIs to the 5GMSd Application Provider.
Figure 5.8.1-1 is the flowchart diagram for this procedure.
Figure 5.8.1-1: Dynamic Policy based on Network Slicing for Downlink Streaming
Pre-requisites:
1.	The UE knows how to access the network slice(s) associated with a particular Provisioning Session.
2.	The 5GMSd AS(s) serving the content for the particular Provisioning Session shall be accessible through the DNN(s) associated to the network slice(s) provisioned for the distribution of that content.
The steps are as follows:
1.	The 5GMSd-Aware Application triggers media playback by invoking the Media Player with the Media Player Entry for the selected content.
2.	The Media Player requests the manifest from the 5GMSd AS.
3.	The Media Player notifies the Media Session Handler about the upcoming media session and may request specific 5GMSd AF-based Network Assistance for that session, when not already established.
4.	The Media Session Handler retrieves information from the 5GMSd AF to assist with the route selection for the session. This may include information about the network slices, the DNNs, any pre-authorized QoS guarantees for that Provisioning Session. The Media Session Handler gets information about the operation point selection from the Media Player as described in step 4.
5.	The Media Session Handler and the UE Policy Management in the UE perform the route selection procedure using information such as the playback operation point, the traffic descriptors. The UE Policy Management will use the matching filter to retrieve the Route Selection descriptor, which provides the DNN, and the S-NSSAI(s), identifying the network slice(s) to be used for this Provisioning Session.
6.	The UE reuses an existing PDU session with the selected S-NSSAI and DNN from step 5, or requests the establishment of a new PDU session with the identified parameters, if one doesn't exist already.
7.	The streaming of the media content at the target operation point starts.",TS 26.501,5.8.1,all_images/image_737.jpeg,Dynamic Policy based on Network Slicing for Downlink Streaming
"In this case, 5GMS media data is exclusively delivered via eMBMS, i.e. media content is not delivered via reference point M4d, but only via MBMS User Services. The 5GMSd Client acts as an MBMS-Aware Application.
The call flow in Figure 5.10.2 1 extends the call flow defined in clause 5.3.2 to address the delivery of 5GMS media data exclusively via eMBMS. Aspects specific to this use-case are indicated in bold.
Figure 5.10.2-1: High-level procedure for DASH content delivery via eMBMS
Prerequisites (step 0):
-	The 5GMSd Application Provider has provisioned the 5G Media Streaming System, including content ingest and the authorization to distribute 5GMS content via eMBMS.
-	The 5GMS AF has informed the BM-SC about the availability of 5GMS content by provisioning an MBMS service and has obtained relevant information from the eMBMS Service Announcement (such as the MBMS service identifier).
-	The BM-SC is ingesting content from the 5GMS AS, using either pull mode or push mode.
-	The BM-SC has broadcast the MBMS Service Announcement, including an indication that the content is 5GMS content.
Steps:
1:	The 5GMSd-Aware Application triggers the Service Announcement procedure and the 5GMS Service and Content Discovery procedure at reference point M8.
2:	A media content item is selected.
3:	The 5GMSd-Aware Application triggers the 5GMSd Client to start media playback. The Media Player Entry is provided to the 5GMSd Client.
4:	If the 5GMS-Aware Application has received only a reference to the Service Access Information (see step 1), the Media Session Handler interacts with the 5GMSd AF to acquire the whole Service Access Information. This includes relevant information from the eMBMS Service Announcement (such as the MBMS service identifier) in order to bootstrap reception of the MBMS service.
5-11:	The Media Session Handler acts as an MBMS-Aware Application and initiates service acquisition. For details, see TS 26.347 [18]. This establishes a transport session for the MPD and the Content.
NOTE:	The MPD and Initialization Segment(s) are forwarded by the MBMS Client to the Media Server to enable their subsequent delivery to the Media Player upon request.
12:	The Media SessionHandler provides the MPD URL to the Media Player either directly or through the 5GMSd-Aware Application.
13:	The Media Player is invoked to start media access and playback.
14:	The Media Player retrieves the Media Player Entry resource (an MPD) from the proxy Media Server.
15:	The Media Player processes the retrieved MPD. It determines, for example, the number of transport sessions needed for media acquisition. The Media Player should be able to use the MPD information to initialize the media pipelines for each media stream (see step 18). When DRM is used (see step 17) the MPD should also contain sufficient information to initialize the DRM client.
16:	The Media Player notifies the Media Session Handler about the start of a new downlink media streaming session. The notification may include parameters from the MPD.
17:	Optional: The Media Player acquires any necessary DRM information, for example a DRM License.
18:	The Media Player configures the media playback pipeline.
19:	The Media Player retrieves initialization segment(s) referenced by the MPD.
20-25:	Content is delivered using DASH-over-MBMS. Session Announcement updates are provided to the MBMS Client as necessary. MPD updates and Segments are pushed to the media server. The Media Player retrieves media segments from the proxy Media Server according to the MPD and forwards them to the appropriate media rendering pipeline.",TS 26.501,5.10.2,all_images/image_739.png,High-level procedure for DASH content delivery via eMBMS
"In this case, 5GMS consumption reporting is used to report consumption of 5GMSd content via an eMBMS service.
NOTE:	eMBMS consumption reporting is disabled in this case.
The call flow in Figure 5.10.3-1 extends the call flow defined in clause 5.6.1 to address consumption reporting. Aspects specific to this use-case are indicated in bold.
Figure 5.10.3-1: Consumption reporting for 5GMS via eMBMS
Prerequisites (step 0):
-	The 5GMSd Application Provider has provisioned the 5G Media Streaming System, including content ingest, consumption reporting and the permission to distribute 5GMS content via eMBMS.
-	The BM-SC is ingesting content from the 5GMS AS, using either pull mode or push mode.
-	eMBMS media delivery is established.
-	Consumption reporting is established.
Steps:
The user preferences relating to consumption reporting may be changed:
1:	The 5GMSd-Aware Application selects/changes the user preferences.
2:	The Media Player transmits consumption reporting user preferences to the Media Session Handler.
The first phase is initialisation.
3:	The 5GMSd-Aware Application is started.
4:	A media content item is selected.
5:	The 5GMSd-Aware Application triggers the Media Session Handler to start content playback. The Media Player Entry is provided.
6:	If the 5GMS-Aware Application has received only a reference to the Service Access Information, the Media Session Handler interacts with the 5GMSd AF to acquire the whole Service Access Information. This includes a client consumption reporting configuration including parameters such as reporting frequency.
7:	The MBMS service is initiated.
8:	The Media Session Handler triggers consumption reporting in the Media Player.
9:	The Media Session Handler starts the Media Player with the Media Player Entry.
The second phase is media playback.
When media is playing, the consumption reporting parameters may be updated by the 5GMSd AF.
10:	The Media Session Handler acquires updated Service Access Information from the 5GMSd AF including updated consumption reporting parameters.
When media is playing:
11:	Media content is accessed through different networks, possibly via eMBMS or unicast.
12:	The Media Player transmits information about the media streaming resources consumed to the Media Session Handler, including the source of the media.
13:	The Media Session Handler regularly sends consumption report(s) to the 5GMSd AF, including information about the delivery network from which the media was acquired.
14:	The Media Player provides an update to the Media Session Handler about the consumed media streaming resources, for example a change in the delivery network.
The last phase is to stop the media:
15:	The 5GMSd-Aware Application triggers the Media Session Handler to stop content playback.
16:	The Media Session Handler stops the Media Player.
17:	The Media Session Handler stops consumption reporting in the Media Player.
18:	The Media Session Handler may send final consumption report(s) to the 5GMSd AF.",TS 26.501,5.10.3,all_images/image_740.png,Consumption reporting for 5GMS via eMBMS
"In this case, 5GMS metrics reporting is used to report 5GMS and eMBMS metrics to the 5GMSd AF.
NOTE:	eMBMS metrics reporting is disabled in this case.
The call flow in Figure 5.10.4-1 extends the call flow defined in clause 5.5.3 to address metrics reporting. Aspects specific to this use-case are indicated in bold.
Figure 5.10.4-1: Metrics reporting for 5GMS via eMBMS
Prerequisites (step 0):
-	The 5GMSd Application Provider has provisioned the 5G Media Streaming System, including content ingest, metrics reporting and the permission to distribute 5GMS content via eMBMS.
-	The BM-SC is ingesting content from the 5GMS AS, using either pull mode or push mode.
-	eMBMS media delivery is established.
-	Metrics reporting is established.
Steps:
The user preferences relating to metrics reporting may be changed:
1:	The 5GMSd-Aware Application selects/changes the user preferences.
2:	The Media Player transmits metrics reporting user preferences to the Media Session Handler.
The first phase is initialisation.
3:	The 5GMSd-Aware Application is started.
4:	A media content item is selected.
5:	The 5GMSd-Aware Application triggers the Media Session Handler to start content playback. The Media Player Entry is provided.
6:	If the 5GMS-Aware Application has received only a reference to the Service Access Information, the Media Session Handler interacts with the 5GMSd AF to acquire the whole Service Access Information. This includes a client metrics reporting configuration including parameters such as reporting frequency.
7:	The MBMS service is initiated.
8:	The Media Session Handler triggers metrics collection by the MBMS Client and by the Media Player.
9:	The Media Session Handler starts the Media Player with the Media Player Entry.
The second phase is media playback.
When media is playing, the metrics reporting parameters may be updated by the 5GMSd AF.
10:	The Media Session Handler acquires updated Service Access Information from the 5GMSd AF including updated metrics reporting parameters.
When media is playing:
11:	Media content is accessed through different networks, possibly via eMBMS or unicast.
12:	The Media Player provides DASH metrics to the Media Session Handler.
13:	The MBMS Client provides MBMS metrics to the Media Session Handler using MBMS-API-C.
14:	The Media Session Handler regularly sends metrics report(s) to the 5GMSd AF, including information about the delivery network from which the media was acquired.
The last phase is to stop the media:
15:	The 5GMSd-Aware Application triggers the Media Session Handler to stop content playback.
16:	The Media Session Handler stops metrics collection in the MBMS Client and the Media Player.
17:	The Media Session Handler stops metrics reporting.
18:	The Media Session Handler may send final metrics report(s) to the 5GMSd AF.",TS 26.501,5.10.4,all_images/image_741.png,Metrics reporting for 5GMS via eMBMS
,TS 26.501,5.10.5,all_images/image_742.jpeg,High-level procedure for hybrid delivery of DASH content
,TS 26.501,5.10.5,all_images/image_743.png,High-level procedure for hybrid delivery of DASH content (continued)
"In this scenario the same content is distributed via eMBMS (for example using a broadcast network in receive-only mode) and via a 5GMS System. The resources of the broadcast system are statically configured. eMBMS-based distribution may, for example, be used only for services in high demand, and the resources and quality of the service distributed through broadcast may be adjusted according to demand. Demand may be identified through 5GMS Consumption Reporting.
The call flow in Figures 5.10.6 1 and 5.10.6 2 extends that defined in clause 5.6.1 to address generic use cases for broadcast-on-demand. Specific additional use cases are presented in the remainder of clause 5.10.6.
Figure 5.10.6.1-1: High-level procedure for DASH content delivered via eMBMS broadcast-on-demand
Steps:
1:	The 5GMS Application Provider provisions one or more MBMS services and permits broadcast distribution of the media content.
2:	As a consequence, the 5GMSd AF provisions MBMS delivery and the BM SC informs the 5GMS AF about the resources it will use to ingest media content.
NOTE:	This step may happen later, up to (and possibly as part of) step 15, for example only when demand is identified.
3:	The media content is announced to the 5GMSd-Aware Application and the application request the entry points for the service.
4:	The 5GMSd AS starts to ingest content from the 5GMSd Application Provider.
5:	Consumption Reporting is applied for the 5GMSd session.
Media playback initially uses unicast 5G Media Streaming:
6:	The media content is selected by the 5GMSd-Aware Application.
7:	The 5GMSd-Aware Application triggers the start of media playback by the Media Player.
8:	The media presentation manifest (e.g. DASH MPD) is requested by the Media Player from the 5GMSd AS.
9:	The Media Player processes the media presentation manifest and identifies that the media content is available on the 5GMS AS
10:	The Media Player, under the control of the application, selects the media content and different content options.
11:	Media content is received from the 5GMSd AS via reference point M4d.
12:	The Media Player informs the Media Session Handler about the consumed media content.
13:	The Media Session Handler sends consumption reports to the 5GMSd AF.
Subsequently, media playback switches to eMBMS:
14:	By analysing the consumption reports submitted to it in the previous step, the 5GMSd AF identifies a high level of demand for the service.
15:	Additional MBMS delivery sessions are provisioned to add delivery of the service via eMBMS.
16: The BM SC starts ingesting media content from the 5GMSd AS.
17:	MBMS delivery starts.
18:	The 5GMSd AF informs the Media Session Handler that MBMS delivery is initiated and provides the Service Success Information.
19:	MBMS content reception is initiated by the Media Session Handler.
20:	Once the service is ready, the content delivered on MBMS is used by the Media Player. Consumption reporting continues. Specific cases may use different policies, similar to the hybrid case in clause 5.10.5.
Figure 5.10.6.1-2: High-level procedure for DASH content delivered via eMBMS broadcast-on-demand (continued)",TS 26.501,5.10.6.1,all_images/image_745.png,High-level procedure for DASH content delivered via eMBMS broadcast-on-demand
"The procedures for uplink media streaming allow a system user to create, modify, establish and delete sessions. Uplink media streaming sessions exist between a 5GMSu Client and a 5GMSu AS. The term Sink Configuration refers to the provisioned parameters of a 5GMSu AS. The term Source Session refers to the provisioned parameters in the 5GMSu Client.
The uplink streaming procedures follow a general high-level workflow, starting from provisioning to the actual uplink streaming sessions. The egest session refers to the time during which media content is uplink streamed into the 5GMSu AS. The provisioning session refers to the time period during which the 5GMSu Client is permitted to uplink stream media content. Interactions between the 5GMSu AF and the 5GMSu Application Provider may occur at any time while the Provisioning Session is active.
The 5GMSu Provisioning API allows selection of Media Session Handling (M5u) and Uplink Streaming (M4u) options, including whether the media content is published to trusted 5GMSu AS instances. The 5GMSu AF selects the M5u interface according to the provisioning option. The Media Session Handling interface exposed by the 5GMSu AF can be used for remote control, metrics reporting, requesting different policy and charging treatments, or 5GMSu AF-based Network Assistance.
When the 5GMSu AF and AS are in the same DN, then the 5GMSu AF selects the 5GMSu AS. Interactions between a 5GMSu AF and a 5GMSu AS (M3u interactions) take place for 5GMS Egest (M2u) and Uplink Streaming (M4u) resource reservations. The 5GMSu AS allocates M2u and M4u resources and communicates resource identifiers back to the 5GMSu AF. The 5GMSu AF provides information about the provisioned resources (in the form of resource identifiers) for Media Session Handling, Egest and Uplink Streaming to the 5GMSu Application Provider. The resource identifiers for Media Session Handling and Uplink Streaming are needed by the 5GMSu Client to access the selected features.
When 5GMSu AF and 5GMSu AS are operated by different providers, then the M3u interface is not used and the 5GMSu AF does not provide 5GMS Egest (M2u) and Uplink Streaming (M4u) resource reservations. M3u procedures are not specified.
5GMSu Client can (in principle) start the uplink streaming by activating its uplink streaming session. The uplink streaming session for a given UE (or for each UE) is active from the time at which the 5GMSu-Aware Application activates the transmission of an uplink streaming service until its termination.
The 5GMSu-Aware Application receives application metadata from the 5GMSu Application Provider before transmitting the uplink streaming media. The application metadata contains Service Access Information, which acts as an entry point for the 5GMSu Client to start the uplink streaming session. The 5GMSu Client may either receive the Service Access Information from the 5GMSu Application Provider (using a not standardized interface) or instructions for a remote control session. When remote control is activated, then the 5GMSu Client is remotely configured and controlled by a 5GMSu AF.
The Network Assistance (NA) feature enables a UE that is receiving a uplink media stream to improve the QoE of the media streaming session, by being able to make use of two distinct facilities.
The first facility is bit rate recommendation (throughput estimation). This enables the UE to start a uplink streaming session at the most appropriate bit rate for the network conditions at hand, or to obtain a recommendation from the network which will remain valid until further notice during a media streaming session. The recommended bit rate is based on network estimations or predictions of available link bandwidth. This function is provided as an additional tool to support the UE, in addition to the common approach of the UE performing its own estimation based on measurement of the uplink traffic in the past.
The second facility is the delivery boost. The 5GMSu Client uses this function to indicate to the network that a temporary boost, i.e., a temporary increase of network throughput for this client is needed, for example in order to prevent the uplink media streaming buffer in the Media Streamer from overflowing.
Network Assistance for uplink media streaming may be offered to the UE in one of two ways:
-	Based on interaction between the UE and the 5GMSu AF, with a subsequent interaction between the 5GMSu AF and the PCF (or the NEF), as defined in clause 6.5.
-	Based on interaction between the UE and the RAN, re-using the ANBR-based RAN signalling as defined in clause 6.7.
The UE shall not use both approaches on the same Network Assistance session.
Figure 6.1-1: High Level Procedure for uplink streaming
Steps:
1.	The 5GMSu Application Provider creates a Provisioning Session and starts provisioning the usage of the 5G Media Streaming System. During the establishment phase, the used features are negotiated and detailed configurations are exchanged. The 5GMSu Application Provider receives Service Access Information for M5u (Media Session Handling) and, when media content reception is negotiated, Service Access Information for M2u (Egest) and M4d (Uplink Streaming). This information is needed by the 5GMSu Client to access the service. Depending on the provisioning, only Remote Configuration information may be provided.
2.	When the 5GMSu AF and the 5GMSu AS are operated by the same provider (e.g. the MNO), there may be interactions between the 5GMSu AF and 5GMSu AS, e.g. to allocate 5GMSu egest and uplink streaming resources. The 5GMSu AS provides resource identifiers for the allocated resources to the 5GMSu AF, which then provides the information to the 5GMSu Application Provider. The M3u procedures between 5GMSu AF and 5GMSu AS are not specified.
3.	The 5GMSu Application Provider provides the Service Announcement Information to the 5GMSu-Aware Application.
NOTE:	This may include manual entering of parameters.
The Service Announcement includes either the whole Service Access Information (i.e. details for Media Session Handling (M5u) and for Media Streaming access (M4u)) or only a remote configuration and control address (5GMSu AF URL). In the latter case, the 5GMSu Client retrieves the Services Access Information in a later step.
4.	The 5GMSu-Aware Application configures and starts the 5GMSu Client.
5.	When the 5GMSu-Aware Application decides to activate the streaming service transmission, the Service Access Information is provided to the 5GMSu Client. When remote configuration and control is activated, then the 5GMSu AF configures and controls the 5GMSu Client remotely.
6.	Depending on the configurations, the 5GMSu Client uses the Media Session Handling API towards the 5GMSu AF. The Media Session Handling API is used for requesting different policy and charging treatments or 5GMSu AF-based Network Assistance.
7.	The 5GMSu Client starts the Egest Session by activating the uplink streaming session.
8.	The 5GMSu AS publishes the content towards the 5GMSu Application Provider.",TS 26.501,6.1,all_images/image_749.jpeg,High Level Procedure for uplink streaming
"Figure 6.7-1 depicts an uplink streaming architecture where RAN signalling is employed to support uplink Network Assistance functionality.
The RAN in the architecture contains control plane and user plane entities that interact with peer control and user plane entities in the UE, in the request/response for boost of the uplink streaming data rate, and subsequent media transport. The user plane functionality as shown in Figure 6.7-1 (solid line going from UE to RAN to 5GMSu AS) illustrates the scheduling/passthrough functionality associated with user plane communications, governed by the RAN, as result of the uplink assistance messaging over the control plane (shown by dotted line between the UE and RAN). It is assumed in this case that 5GMSu AF-based Network Assistance is not utilized.
It should be noted that although the 5GMSu AF is not utilized when RAN signalling based network assistance is performed, it is assumed that there is a higher level network entity which coordinates and tracks network assistance performed using RAN signalling versus application signalling for individual UEs.
Figure 6.7-1: RAN Signalling based Uplink Network Assistance",TS 26.501,6.7,all_images/image_754.png,RAN Signalling based Uplink Network Assistance
"EVS Selection and Characterization Phase Test Results are summarized in the main body and detailed in Annex D of TR 26.952 [3]. In this clause a few test results are highlighted to quantify the improvements of the EVS codec along the three dimensions listed above, i.e., speech quality, compression efficiency, and error resiliency. To further simplify the performance comparison a reference point for benchmarking is established, namely AMR-WB at a bit-rate of 12.65 kbps based on commercial grade HD Voice services available today.
NOTE. The correlation between voice quality and intelligibility is dependent on the test parameters. In general, improved voice quality may result in improved intelligibility. However, it is also possible e.g., in noisy conditions of [-30 dB to 5 dB SNR], that the improvements observed using subjective voice quality testing and the improvements observed using subjective intelligibility testing may not correlate well. In the other end of spectrum, e.g., in clean speech, while the voice quality may have improved significantly, the intelligibility may already have approached a level of saturation.
Three mixed bandwidth DCR (Degradation Category Rating) tests were performed as a part of EVS Characterization testing whose results are shown in Figure 13.
In general, EVS-WB codec offers quality significantly better than AMR-WB at a similar bit-rate and quality equivalent to AMR-WB at a lower bit rate. The EVS-SWB codec performance is significantly better than both AMR-WB and corresponding bit rates of EVS-WB.
For clean speech content (Figure 13a), the lowest bit-rate of EVS-WB namely 5.9 kbps can offer quality significantly better than AMR-WB at 8.85 kbps and equivalent to AMR-WB at 12.65 kbps. The subjective quality of EVS-WB coding starting at 9.6 kbps is significantly better than the AMR-WB coding at its highest bit rate of 23.85 kbps. The super-wideband mode of EVS at 13.2 kbps achieves transparency to the direct source and offers quality significantly better than both 23.85 kbps of AMR-WB and 24.4 kbps of EVS-WB.
For noisy speech (Figure 13b), EVS-WB at 9.6 kbps offers quality on par with AMR-WB at 12.65 kbps. This has also been shown across different languages/noise types and summarized in TR 26.952. However, none of the noisy speech tests included the presence of a front end noise suppression, which is expected to establish the equivalence to AMR-WB 12.65 kbps quality at a bit-rate lower than 9.6 kbps by providing a higher SNR at the input to the coder. EVS-WB at 13.2 kbps offers quality on par with AMR-WB at approximately twice the bit-rate with consistent progression in subjective quality with increasing bit-rates. The subjective quality of EVS-SWB coding at 13.2 kbps is significantly better than that of AMR-WB at 23.85 kbps and EVS-WB at the same bit-rate.
For mixed/music coding (Figure 13c, 13d) under clean channel conditions, both the EVS-WB and SWB codec starting at 13.2 kbps achieves subjective quality that is significantly better than that of AMR-WB at any bit-rate. For North American English music and mixed content (Figure 13d), EVS-SWB coding performs significantly better than EVS-WB at the same bit rate.
(a)												(b)
Figure 5.1.1.6.3.1-1: EVS-SWB Channel aware mode clean speech performance under clean and impaired channels (Mixed bandwidth DCR Test), (a) Danish, (b) North American English
Figure 5.1.1.6.3.1-1 shows the EVS-SWB channel aware mode performance at 13.2 kbps under clean channel as well as under five different delay/loss profiles (Profiles 5, 7, 8, 9, and 10) which simulate impaired channel characteristic with varying delay and jitter. Profile 5 is a MTSI delay loss profile from TS 26.114 [4] and profiles 8-10 are VoLTE delay loss profile used for characterization testing of EVS channel aware mode [http://www.3gpp.org/ftp/tsg_sa/WG4_CODEC/EVS_Permanent_Documents/EVS-7c_S4-141392.zip]
Most 3GPP networks are expected to be configured such that the FER is around 1% for each link. While the 2% data point was not tested in this test, comparisons were made between the EVS modes versus AMR-WB at the nearest data points namely, 0% (clean channel) and 3% FER.
In general, the 13.2 kbps EVS-SWB clean speech performance under impaired channel with channel aware mode enabled is significantly better than without channel aware mode which in turn is significantly better than AMR-WB at its highest bit-rate of 23.85 kbps. For both languages, the quality of EVS SWB 13.2 kbps channel aware and non-channel aware modes in clean channel are significantly better than AMR-WB at its highest bit-rate of 23.85 kbps.
For North American English (Figure 5.1.1.6.3.1-1b), EVS SWB 13.2 kbps channel aware mode operating at around 6% FER delivers quality on par with that of the highest bit-rate of AMR-WB (23.85 kbps) under no loss. The 13.2 kbps SWB non-channel aware mode is able to achieve the quality equivalence to AMR-WB 23.85 clean channel when operating at around 3% FER. EVS 13.2 kbps channel aware mode even at 10% FER delivers quality better than AMR-WB 23.85 kbps at 3% FER, while the 13.2 kbps EVS SWB non-channel aware mode can operate at 8% FER but achieve quality equivalence to AMR-WB 23.85 kbps at 3% FER.
For Danish (Figure 5.1.1.6.3.1-1a), EVS SWB 13.2 kbps channel aware mode operating at around 3% FER delivers quality on par with that of the highest bit-rate of AMR-WB (23.85 kbps) under no loss. EVS 13.2 kbps channel aware mode even at 10% FER delivers quality equivalent to AMR-WB 23.85 kbps at 3% FER, while the 13.2 kbps EVS SWB non-channel aware mode can operate at 6% FER to achieve quality equivalence to AMR-WB 23.85 kbps at 3% FER.
Figure 5.1.1.6.3.1-2: EVS-SWB Channel aware mode noisy speech performance under clean and impaired channels (North American English with car noise @ 15 dB SNR- Mixed bandwidth DCR test)
In general, the 13.2 kbps EVS-SWB noisy speech performance under impaired channel with channel aware mode enabled is significantly better than without channel aware mode which in turn is significantly better than AMR-WB at its highest bit-rate of 23.85 kbps.
For North American English with car noise at 15 dB SNR, EVS SWB 13.2 kbps channel aware mode operating at 10% FER and the EVS SWB non-channel aware mode operating at 6% FER can achieve quality equivalence to AMR-WB 23.85 kbps at 3% FER.
Figure 5.1.1.6.3.1-3: EVS-WB Channel aware mode clean speech performance under clean and impaired channels (Single bandwidth ACR test –Experiment W1 from EVS Characterization Testing) (a) North American English, (b) Mandarin
For North American English (Figure 5.1.1.6.3.1-3a), the 13.2 kbps EVS-WB clean speech performance under impaired channel with channel aware mode enabled is significantly better than without channel aware mode which in turn is significantly better than AMR-WB at 15.85 kbps. The quality of EVS WB 13.2 kbps channel aware and non-channel aware modes in clean channel are significantly better than AMR-WB at 15.85 kbps.
Specifically, it can be seen that for both languages tested, the EVS 13.2 kbps channel aware mode operating at 10% FER can deliver quality on par with AMR-WB at 15.85 kbps at 3% FER. In addition, the 13.2 kbps non-channel aware mode can operate at 6% FER to achieve equivalence to AMR-WB 15.85 kbps at 3% FER.
Since AMR-WB 12.65 kbps at 2% FER (""HD Voice"" center of cell speech quality) quality benchmark was not included in the tests summarizes in Figures 5.1.1.6.3.1-3a and 5.1.1.6.3.1-3b, the source used P.OLQA to determine the frame error rate at which the 13.2 kbps EVS WB channel aware and non-channel aware modes is equal to the ""HD Voice"" reference speech quality.
The source presents below the result of a study to characterize the correlation between subjective MOS and P.OLQA [10] for the North American English Absolute Category Rating (ACR) MOS test results shown in Figure 5.1.1.6.3.1-3a. A North American English database comprising of 3 male and 3 female talkers with 5 sentence pairs per talker was used for computing the P.OLQA scores. The sentence pair wise scores for each condition was averaged to obtain a single P.OLQA score for the condition.
NOTE. As per [12], POLQA has been tested to work with background noise levels. A fixed lower SNR limit at which POLQA can be applied was not reported in [12] and it was noted that it is highly signal-dependent. POLQA analysis in this Clause is done on clean speech in clean and noisy channel conditions. POLQA analysis for extreme noisy conditions [10 to -5 dB] is not performed.
To study the correlation between the POLQA and subjective MOS, the relationship between the two sre plotted in Figure 5.1.1.6.3.1-4. The data points in this plot include the subjective MOS scores from Figure 5.1.1.6.3.1-3a and POLQA scores computed as described above. The data points used for this plot include all conditions (clean channel and all delay loss profiles tested) of AMR-WB 15.85 kbps, EVS-WB 13.2 kbps non-channel aware and channel aware modes (a plot showing the correlation with the channel and non-channel aware modes separated is provided in clause A.2 of the Annex). The ""Linear (AMR-WB)"" line represents the linear regression between AMR-WB MOS and the corresponding POLQA scores. Therefore, assuming that the ""Linear (AMR-WB)"" represents the true relationship between POLQA and subjective MOS, then it is seen that POLQA underestimates the subjective quality of EVS WB 13.2 kbps modes.
Figure 5.1.1.6.3.1-4: Correlation between Subjective MOS and P.OLQA
Figure 5.1.1.6.3.1-5: Use of P.OLQA to determine frame error rate for EVS WB 13.2 kbps channel aware and non-channel aware modes at same speech quality as AMR-WB 2% FER
As illustrated in Figure 5.1.1.6.3.1-5, EVS WB 13.2 kbps channel aware mode operating under 8% FER results in the same P.OLQA score as AMR-WB 12.65 kbps at 2% FER. The corresponding data point for the non-channel aware mode is 4% FER. The 3, 6, 8 and 10% FER data points (anchors) shown on the X-axis in Figure 4.1.6 were simulated via delay loss profiles 7, 8, 9 and 10 respectively (used in ACR MOS results shown in Figure 4.1.4a). Delay loss profiles to simulate the other FER data points were created as a random subset of the nearest highest FER anchor. For example the 1 and 2% FER profiles were created as a subset of delay loss profile 7 (3% FER).
Taking into account the under estimation observed in Figure 5.1.1.6.3.1-4 and results from the subjective MOS tests shown in Figure 5.1.1.6.3.1-3a and 5.1.1.6.3.1-3b, it can be seen that the above determination of frame error rate for EVS-WB 13.2 kbps channel aware and non-channel aware modes to achieve the same speech quality as AMR-WB 12.65 kbps at 2% FER, is conservative. The respective SWB modes will provide significantly improved voice quality as compared to the 13.2 kbps WB modes which will result in even higher frame error rates than what is determined above for the WB modes.",TR 26.989,5.1.1.6.3.1,all_images/image_760.png,EVS-SWB Channel aware mode clean speech performance under clean and
"EVS Selection and Characterization Phase Test Results are summarized in the main body and detailed in Annex D of TR 26.952 [3]. In this clause a few test results are highlighted to quantify the improvements of the EVS codec along the three dimensions listed above, i.e., speech quality, compression efficiency, and error resiliency. To further simplify the performance comparison a reference point for benchmarking is established, namely AMR-WB at a bit-rate of 12.65 kbps based on commercial grade HD Voice services available today.
NOTE. The correlation between voice quality and intelligibility is dependent on the test parameters. In general, improved voice quality may result in improved intelligibility. However, it is also possible e.g., in noisy conditions of [-30 dB to 5 dB SNR], that the improvements observed using subjective voice quality testing and the improvements observed using subjective intelligibility testing may not correlate well. In the other end of spectrum, e.g., in clean speech, while the voice quality may have improved significantly, the intelligibility may already have approached a level of saturation.
Three mixed bandwidth DCR (Degradation Category Rating) tests were performed as a part of EVS Characterization testing whose results are shown in Figure 13.
In general, EVS-WB codec offers quality significantly better than AMR-WB at a similar bit-rate and quality equivalent to AMR-WB at a lower bit rate. The EVS-SWB codec performance is significantly better than both AMR-WB and corresponding bit rates of EVS-WB.
For clean speech content (Figure 13a), the lowest bit-rate of EVS-WB namely 5.9 kbps can offer quality significantly better than AMR-WB at 8.85 kbps and equivalent to AMR-WB at 12.65 kbps. The subjective quality of EVS-WB coding starting at 9.6 kbps is significantly better than the AMR-WB coding at its highest bit rate of 23.85 kbps. The super-wideband mode of EVS at 13.2 kbps achieves transparency to the direct source and offers quality significantly better than both 23.85 kbps of AMR-WB and 24.4 kbps of EVS-WB.
For noisy speech (Figure 13b), EVS-WB at 9.6 kbps offers quality on par with AMR-WB at 12.65 kbps. This has also been shown across different languages/noise types and summarized in TR 26.952. However, none of the noisy speech tests included the presence of a front end noise suppression, which is expected to establish the equivalence to AMR-WB 12.65 kbps quality at a bit-rate lower than 9.6 kbps by providing a higher SNR at the input to the coder. EVS-WB at 13.2 kbps offers quality on par with AMR-WB at approximately twice the bit-rate with consistent progression in subjective quality with increasing bit-rates. The subjective quality of EVS-SWB coding at 13.2 kbps is significantly better than that of AMR-WB at 23.85 kbps and EVS-WB at the same bit-rate.
For mixed/music coding (Figure 13c, 13d) under clean channel conditions, both the EVS-WB and SWB codec starting at 13.2 kbps achieves subjective quality that is significantly better than that of AMR-WB at any bit-rate. For North American English music and mixed content (Figure 13d), EVS-SWB coding performs significantly better than EVS-WB at the same bit rate.
(a)												(b)
Figure 5.1.1.6.3.1-1: EVS-SWB Channel aware mode clean speech performance under clean and impaired channels (Mixed bandwidth DCR Test), (a) Danish, (b) North American English
Figure 5.1.1.6.3.1-1 shows the EVS-SWB channel aware mode performance at 13.2 kbps under clean channel as well as under five different delay/loss profiles (Profiles 5, 7, 8, 9, and 10) which simulate impaired channel characteristic with varying delay and jitter. Profile 5 is a MTSI delay loss profile from TS 26.114 [4] and profiles 8-10 are VoLTE delay loss profile used for characterization testing of EVS channel aware mode [http://www.3gpp.org/ftp/tsg_sa/WG4_CODEC/EVS_Permanent_Documents/EVS-7c_S4-141392.zip]
Most 3GPP networks are expected to be configured such that the FER is around 1% for each link. While the 2% data point was not tested in this test, comparisons were made between the EVS modes versus AMR-WB at the nearest data points namely, 0% (clean channel) and 3% FER.
In general, the 13.2 kbps EVS-SWB clean speech performance under impaired channel with channel aware mode enabled is significantly better than without channel aware mode which in turn is significantly better than AMR-WB at its highest bit-rate of 23.85 kbps. For both languages, the quality of EVS SWB 13.2 kbps channel aware and non-channel aware modes in clean channel are significantly better than AMR-WB at its highest bit-rate of 23.85 kbps.
For North American English (Figure 5.1.1.6.3.1-1b), EVS SWB 13.2 kbps channel aware mode operating at around 6% FER delivers quality on par with that of the highest bit-rate of AMR-WB (23.85 kbps) under no loss. The 13.2 kbps SWB non-channel aware mode is able to achieve the quality equivalence to AMR-WB 23.85 clean channel when operating at around 3% FER. EVS 13.2 kbps channel aware mode even at 10% FER delivers quality better than AMR-WB 23.85 kbps at 3% FER, while the 13.2 kbps EVS SWB non-channel aware mode can operate at 8% FER but achieve quality equivalence to AMR-WB 23.85 kbps at 3% FER.
For Danish (Figure 5.1.1.6.3.1-1a), EVS SWB 13.2 kbps channel aware mode operating at around 3% FER delivers quality on par with that of the highest bit-rate of AMR-WB (23.85 kbps) under no loss. EVS 13.2 kbps channel aware mode even at 10% FER delivers quality equivalent to AMR-WB 23.85 kbps at 3% FER, while the 13.2 kbps EVS SWB non-channel aware mode can operate at 6% FER to achieve quality equivalence to AMR-WB 23.85 kbps at 3% FER.
Figure 5.1.1.6.3.1-2: EVS-SWB Channel aware mode noisy speech performance under clean and impaired channels (North American English with car noise @ 15 dB SNR- Mixed bandwidth DCR test)
In general, the 13.2 kbps EVS-SWB noisy speech performance under impaired channel with channel aware mode enabled is significantly better than without channel aware mode which in turn is significantly better than AMR-WB at its highest bit-rate of 23.85 kbps.
For North American English with car noise at 15 dB SNR, EVS SWB 13.2 kbps channel aware mode operating at 10% FER and the EVS SWB non-channel aware mode operating at 6% FER can achieve quality equivalence to AMR-WB 23.85 kbps at 3% FER.
Figure 5.1.1.6.3.1-3: EVS-WB Channel aware mode clean speech performance under clean and impaired channels (Single bandwidth ACR test –Experiment W1 from EVS Characterization Testing) (a) North American English, (b) Mandarin
For North American English (Figure 5.1.1.6.3.1-3a), the 13.2 kbps EVS-WB clean speech performance under impaired channel with channel aware mode enabled is significantly better than without channel aware mode which in turn is significantly better than AMR-WB at 15.85 kbps. The quality of EVS WB 13.2 kbps channel aware and non-channel aware modes in clean channel are significantly better than AMR-WB at 15.85 kbps.
Specifically, it can be seen that for both languages tested, the EVS 13.2 kbps channel aware mode operating at 10% FER can deliver quality on par with AMR-WB at 15.85 kbps at 3% FER. In addition, the 13.2 kbps non-channel aware mode can operate at 6% FER to achieve equivalence to AMR-WB 15.85 kbps at 3% FER.
Since AMR-WB 12.65 kbps at 2% FER (""HD Voice"" center of cell speech quality) quality benchmark was not included in the tests summarizes in Figures 5.1.1.6.3.1-3a and 5.1.1.6.3.1-3b, the source used P.OLQA to determine the frame error rate at which the 13.2 kbps EVS WB channel aware and non-channel aware modes is equal to the ""HD Voice"" reference speech quality.
The source presents below the result of a study to characterize the correlation between subjective MOS and P.OLQA [10] for the North American English Absolute Category Rating (ACR) MOS test results shown in Figure 5.1.1.6.3.1-3a. A North American English database comprising of 3 male and 3 female talkers with 5 sentence pairs per talker was used for computing the P.OLQA scores. The sentence pair wise scores for each condition was averaged to obtain a single P.OLQA score for the condition.
NOTE. As per [12], POLQA has been tested to work with background noise levels. A fixed lower SNR limit at which POLQA can be applied was not reported in [12] and it was noted that it is highly signal-dependent. POLQA analysis in this Clause is done on clean speech in clean and noisy channel conditions. POLQA analysis for extreme noisy conditions [10 to -5 dB] is not performed.
To study the correlation between the POLQA and subjective MOS, the relationship between the two sre plotted in Figure 5.1.1.6.3.1-4. The data points in this plot include the subjective MOS scores from Figure 5.1.1.6.3.1-3a and POLQA scores computed as described above. The data points used for this plot include all conditions (clean channel and all delay loss profiles tested) of AMR-WB 15.85 kbps, EVS-WB 13.2 kbps non-channel aware and channel aware modes (a plot showing the correlation with the channel and non-channel aware modes separated is provided in clause A.2 of the Annex). The ""Linear (AMR-WB)"" line represents the linear regression between AMR-WB MOS and the corresponding POLQA scores. Therefore, assuming that the ""Linear (AMR-WB)"" represents the true relationship between POLQA and subjective MOS, then it is seen that POLQA underestimates the subjective quality of EVS WB 13.2 kbps modes.
Figure 5.1.1.6.3.1-4: Correlation between Subjective MOS and P.OLQA
Figure 5.1.1.6.3.1-5: Use of P.OLQA to determine frame error rate for EVS WB 13.2 kbps channel aware and non-channel aware modes at same speech quality as AMR-WB 2% FER
As illustrated in Figure 5.1.1.6.3.1-5, EVS WB 13.2 kbps channel aware mode operating under 8% FER results in the same P.OLQA score as AMR-WB 12.65 kbps at 2% FER. The corresponding data point for the non-channel aware mode is 4% FER. The 3, 6, 8 and 10% FER data points (anchors) shown on the X-axis in Figure 4.1.6 were simulated via delay loss profiles 7, 8, 9 and 10 respectively (used in ACR MOS results shown in Figure 4.1.4a). Delay loss profiles to simulate the other FER data points were created as a random subset of the nearest highest FER anchor. For example the 1 and 2% FER profiles were created as a subset of delay loss profile 7 (3% FER).
Taking into account the under estimation observed in Figure 5.1.1.6.3.1-4 and results from the subjective MOS tests shown in Figure 5.1.1.6.3.1-3a and 5.1.1.6.3.1-3b, it can be seen that the above determination of frame error rate for EVS-WB 13.2 kbps channel aware and non-channel aware modes to achieve the same speech quality as AMR-WB 12.65 kbps at 2% FER, is conservative. The respective SWB modes will provide significantly improved voice quality as compared to the 13.2 kbps WB modes which will result in even higher frame error rates than what is determined above for the WB modes.",TR 26.989,5.1.1.6.3.1,all_images/image_762.png,EVS-SWB Channel aware mode noisy speech performance under clean and
"EVS Selection and Characterization Phase Test Results are summarized in the main body and detailed in Annex D of TR 26.952 [3]. In this clause a few test results are highlighted to quantify the improvements of the EVS codec along the three dimensions listed above, i.e., speech quality, compression efficiency, and error resiliency. To further simplify the performance comparison a reference point for benchmarking is established, namely AMR-WB at a bit-rate of 12.65 kbps based on commercial grade HD Voice services available today.
NOTE. The correlation between voice quality and intelligibility is dependent on the test parameters. In general, improved voice quality may result in improved intelligibility. However, it is also possible e.g., in noisy conditions of [-30 dB to 5 dB SNR], that the improvements observed using subjective voice quality testing and the improvements observed using subjective intelligibility testing may not correlate well. In the other end of spectrum, e.g., in clean speech, while the voice quality may have improved significantly, the intelligibility may already have approached a level of saturation.
Three mixed bandwidth DCR (Degradation Category Rating) tests were performed as a part of EVS Characterization testing whose results are shown in Figure 13.
In general, EVS-WB codec offers quality significantly better than AMR-WB at a similar bit-rate and quality equivalent to AMR-WB at a lower bit rate. The EVS-SWB codec performance is significantly better than both AMR-WB and corresponding bit rates of EVS-WB.
For clean speech content (Figure 13a), the lowest bit-rate of EVS-WB namely 5.9 kbps can offer quality significantly better than AMR-WB at 8.85 kbps and equivalent to AMR-WB at 12.65 kbps. The subjective quality of EVS-WB coding starting at 9.6 kbps is significantly better than the AMR-WB coding at its highest bit rate of 23.85 kbps. The super-wideband mode of EVS at 13.2 kbps achieves transparency to the direct source and offers quality significantly better than both 23.85 kbps of AMR-WB and 24.4 kbps of EVS-WB.
For noisy speech (Figure 13b), EVS-WB at 9.6 kbps offers quality on par with AMR-WB at 12.65 kbps. This has also been shown across different languages/noise types and summarized in TR 26.952. However, none of the noisy speech tests included the presence of a front end noise suppression, which is expected to establish the equivalence to AMR-WB 12.65 kbps quality at a bit-rate lower than 9.6 kbps by providing a higher SNR at the input to the coder. EVS-WB at 13.2 kbps offers quality on par with AMR-WB at approximately twice the bit-rate with consistent progression in subjective quality with increasing bit-rates. The subjective quality of EVS-SWB coding at 13.2 kbps is significantly better than that of AMR-WB at 23.85 kbps and EVS-WB at the same bit-rate.
For mixed/music coding (Figure 13c, 13d) under clean channel conditions, both the EVS-WB and SWB codec starting at 13.2 kbps achieves subjective quality that is significantly better than that of AMR-WB at any bit-rate. For North American English music and mixed content (Figure 13d), EVS-SWB coding performs significantly better than EVS-WB at the same bit rate.
(a)												(b)
Figure 5.1.1.6.3.1-1: EVS-SWB Channel aware mode clean speech performance under clean and impaired channels (Mixed bandwidth DCR Test), (a) Danish, (b) North American English
Figure 5.1.1.6.3.1-1 shows the EVS-SWB channel aware mode performance at 13.2 kbps under clean channel as well as under five different delay/loss profiles (Profiles 5, 7, 8, 9, and 10) which simulate impaired channel characteristic with varying delay and jitter. Profile 5 is a MTSI delay loss profile from TS 26.114 [4] and profiles 8-10 are VoLTE delay loss profile used for characterization testing of EVS channel aware mode [http://www.3gpp.org/ftp/tsg_sa/WG4_CODEC/EVS_Permanent_Documents/EVS-7c_S4-141392.zip]
Most 3GPP networks are expected to be configured such that the FER is around 1% for each link. While the 2% data point was not tested in this test, comparisons were made between the EVS modes versus AMR-WB at the nearest data points namely, 0% (clean channel) and 3% FER.
In general, the 13.2 kbps EVS-SWB clean speech performance under impaired channel with channel aware mode enabled is significantly better than without channel aware mode which in turn is significantly better than AMR-WB at its highest bit-rate of 23.85 kbps. For both languages, the quality of EVS SWB 13.2 kbps channel aware and non-channel aware modes in clean channel are significantly better than AMR-WB at its highest bit-rate of 23.85 kbps.
For North American English (Figure 5.1.1.6.3.1-1b), EVS SWB 13.2 kbps channel aware mode operating at around 6% FER delivers quality on par with that of the highest bit-rate of AMR-WB (23.85 kbps) under no loss. The 13.2 kbps SWB non-channel aware mode is able to achieve the quality equivalence to AMR-WB 23.85 clean channel when operating at around 3% FER. EVS 13.2 kbps channel aware mode even at 10% FER delivers quality better than AMR-WB 23.85 kbps at 3% FER, while the 13.2 kbps EVS SWB non-channel aware mode can operate at 8% FER but achieve quality equivalence to AMR-WB 23.85 kbps at 3% FER.
For Danish (Figure 5.1.1.6.3.1-1a), EVS SWB 13.2 kbps channel aware mode operating at around 3% FER delivers quality on par with that of the highest bit-rate of AMR-WB (23.85 kbps) under no loss. EVS 13.2 kbps channel aware mode even at 10% FER delivers quality equivalent to AMR-WB 23.85 kbps at 3% FER, while the 13.2 kbps EVS SWB non-channel aware mode can operate at 6% FER to achieve quality equivalence to AMR-WB 23.85 kbps at 3% FER.
Figure 5.1.1.6.3.1-2: EVS-SWB Channel aware mode noisy speech performance under clean and impaired channels (North American English with car noise @ 15 dB SNR- Mixed bandwidth DCR test)
In general, the 13.2 kbps EVS-SWB noisy speech performance under impaired channel with channel aware mode enabled is significantly better than without channel aware mode which in turn is significantly better than AMR-WB at its highest bit-rate of 23.85 kbps.
For North American English with car noise at 15 dB SNR, EVS SWB 13.2 kbps channel aware mode operating at 10% FER and the EVS SWB non-channel aware mode operating at 6% FER can achieve quality equivalence to AMR-WB 23.85 kbps at 3% FER.
Figure 5.1.1.6.3.1-3: EVS-WB Channel aware mode clean speech performance under clean and impaired channels (Single bandwidth ACR test –Experiment W1 from EVS Characterization Testing) (a) North American English, (b) Mandarin
For North American English (Figure 5.1.1.6.3.1-3a), the 13.2 kbps EVS-WB clean speech performance under impaired channel with channel aware mode enabled is significantly better than without channel aware mode which in turn is significantly better than AMR-WB at 15.85 kbps. The quality of EVS WB 13.2 kbps channel aware and non-channel aware modes in clean channel are significantly better than AMR-WB at 15.85 kbps.
Specifically, it can be seen that for both languages tested, the EVS 13.2 kbps channel aware mode operating at 10% FER can deliver quality on par with AMR-WB at 15.85 kbps at 3% FER. In addition, the 13.2 kbps non-channel aware mode can operate at 6% FER to achieve equivalence to AMR-WB 15.85 kbps at 3% FER.
Since AMR-WB 12.65 kbps at 2% FER (""HD Voice"" center of cell speech quality) quality benchmark was not included in the tests summarizes in Figures 5.1.1.6.3.1-3a and 5.1.1.6.3.1-3b, the source used P.OLQA to determine the frame error rate at which the 13.2 kbps EVS WB channel aware and non-channel aware modes is equal to the ""HD Voice"" reference speech quality.
The source presents below the result of a study to characterize the correlation between subjective MOS and P.OLQA [10] for the North American English Absolute Category Rating (ACR) MOS test results shown in Figure 5.1.1.6.3.1-3a. A North American English database comprising of 3 male and 3 female talkers with 5 sentence pairs per talker was used for computing the P.OLQA scores. The sentence pair wise scores for each condition was averaged to obtain a single P.OLQA score for the condition.
NOTE. As per [12], POLQA has been tested to work with background noise levels. A fixed lower SNR limit at which POLQA can be applied was not reported in [12] and it was noted that it is highly signal-dependent. POLQA analysis in this Clause is done on clean speech in clean and noisy channel conditions. POLQA analysis for extreme noisy conditions [10 to -5 dB] is not performed.
To study the correlation between the POLQA and subjective MOS, the relationship between the two sre plotted in Figure 5.1.1.6.3.1-4. The data points in this plot include the subjective MOS scores from Figure 5.1.1.6.3.1-3a and POLQA scores computed as described above. The data points used for this plot include all conditions (clean channel and all delay loss profiles tested) of AMR-WB 15.85 kbps, EVS-WB 13.2 kbps non-channel aware and channel aware modes (a plot showing the correlation with the channel and non-channel aware modes separated is provided in clause A.2 of the Annex). The ""Linear (AMR-WB)"" line represents the linear regression between AMR-WB MOS and the corresponding POLQA scores. Therefore, assuming that the ""Linear (AMR-WB)"" represents the true relationship between POLQA and subjective MOS, then it is seen that POLQA underestimates the subjective quality of EVS WB 13.2 kbps modes.
Figure 5.1.1.6.3.1-4: Correlation between Subjective MOS and P.OLQA
Figure 5.1.1.6.3.1-5: Use of P.OLQA to determine frame error rate for EVS WB 13.2 kbps channel aware and non-channel aware modes at same speech quality as AMR-WB 2% FER
As illustrated in Figure 5.1.1.6.3.1-5, EVS WB 13.2 kbps channel aware mode operating under 8% FER results in the same P.OLQA score as AMR-WB 12.65 kbps at 2% FER. The corresponding data point for the non-channel aware mode is 4% FER. The 3, 6, 8 and 10% FER data points (anchors) shown on the X-axis in Figure 4.1.6 were simulated via delay loss profiles 7, 8, 9 and 10 respectively (used in ACR MOS results shown in Figure 4.1.4a). Delay loss profiles to simulate the other FER data points were created as a random subset of the nearest highest FER anchor. For example the 1 and 2% FER profiles were created as a subset of delay loss profile 7 (3% FER).
Taking into account the under estimation observed in Figure 5.1.1.6.3.1-4 and results from the subjective MOS tests shown in Figure 5.1.1.6.3.1-3a and 5.1.1.6.3.1-3b, it can be seen that the above determination of frame error rate for EVS-WB 13.2 kbps channel aware and non-channel aware modes to achieve the same speech quality as AMR-WB 12.65 kbps at 2% FER, is conservative. The respective SWB modes will provide significantly improved voice quality as compared to the 13.2 kbps WB modes which will result in even higher frame error rates than what is determined above for the WB modes.",TR 26.989,5.1.1.6.3.1,all_images/image_763.png,EVS-WB Channel aware mode clean speech performance under clean and
"EVS Selection and Characterization Phase Test Results are summarized in the main body and detailed in Annex D of TR 26.952 [3]. In this clause a few test results are highlighted to quantify the improvements of the EVS codec along the three dimensions listed above, i.e., speech quality, compression efficiency, and error resiliency. To further simplify the performance comparison a reference point for benchmarking is established, namely AMR-WB at a bit-rate of 12.65 kbps based on commercial grade HD Voice services available today.
NOTE. The correlation between voice quality and intelligibility is dependent on the test parameters. In general, improved voice quality may result in improved intelligibility. However, it is also possible e.g., in noisy conditions of [-30 dB to 5 dB SNR], that the improvements observed using subjective voice quality testing and the improvements observed using subjective intelligibility testing may not correlate well. In the other end of spectrum, e.g., in clean speech, while the voice quality may have improved significantly, the intelligibility may already have approached a level of saturation.
Three mixed bandwidth DCR (Degradation Category Rating) tests were performed as a part of EVS Characterization testing whose results are shown in Figure 13.
In general, EVS-WB codec offers quality significantly better than AMR-WB at a similar bit-rate and quality equivalent to AMR-WB at a lower bit rate. The EVS-SWB codec performance is significantly better than both AMR-WB and corresponding bit rates of EVS-WB.
For clean speech content (Figure 13a), the lowest bit-rate of EVS-WB namely 5.9 kbps can offer quality significantly better than AMR-WB at 8.85 kbps and equivalent to AMR-WB at 12.65 kbps. The subjective quality of EVS-WB coding starting at 9.6 kbps is significantly better than the AMR-WB coding at its highest bit rate of 23.85 kbps. The super-wideband mode of EVS at 13.2 kbps achieves transparency to the direct source and offers quality significantly better than both 23.85 kbps of AMR-WB and 24.4 kbps of EVS-WB.
For noisy speech (Figure 13b), EVS-WB at 9.6 kbps offers quality on par with AMR-WB at 12.65 kbps. This has also been shown across different languages/noise types and summarized in TR 26.952. However, none of the noisy speech tests included the presence of a front end noise suppression, which is expected to establish the equivalence to AMR-WB 12.65 kbps quality at a bit-rate lower than 9.6 kbps by providing a higher SNR at the input to the coder. EVS-WB at 13.2 kbps offers quality on par with AMR-WB at approximately twice the bit-rate with consistent progression in subjective quality with increasing bit-rates. The subjective quality of EVS-SWB coding at 13.2 kbps is significantly better than that of AMR-WB at 23.85 kbps and EVS-WB at the same bit-rate.
For mixed/music coding (Figure 13c, 13d) under clean channel conditions, both the EVS-WB and SWB codec starting at 13.2 kbps achieves subjective quality that is significantly better than that of AMR-WB at any bit-rate. For North American English music and mixed content (Figure 13d), EVS-SWB coding performs significantly better than EVS-WB at the same bit rate.
(a)												(b)
Figure 5.1.1.6.3.1-1: EVS-SWB Channel aware mode clean speech performance under clean and impaired channels (Mixed bandwidth DCR Test), (a) Danish, (b) North American English
Figure 5.1.1.6.3.1-1 shows the EVS-SWB channel aware mode performance at 13.2 kbps under clean channel as well as under five different delay/loss profiles (Profiles 5, 7, 8, 9, and 10) which simulate impaired channel characteristic with varying delay and jitter. Profile 5 is a MTSI delay loss profile from TS 26.114 [4] and profiles 8-10 are VoLTE delay loss profile used for characterization testing of EVS channel aware mode [http://www.3gpp.org/ftp/tsg_sa/WG4_CODEC/EVS_Permanent_Documents/EVS-7c_S4-141392.zip]
Most 3GPP networks are expected to be configured such that the FER is around 1% for each link. While the 2% data point was not tested in this test, comparisons were made between the EVS modes versus AMR-WB at the nearest data points namely, 0% (clean channel) and 3% FER.
In general, the 13.2 kbps EVS-SWB clean speech performance under impaired channel with channel aware mode enabled is significantly better than without channel aware mode which in turn is significantly better than AMR-WB at its highest bit-rate of 23.85 kbps. For both languages, the quality of EVS SWB 13.2 kbps channel aware and non-channel aware modes in clean channel are significantly better than AMR-WB at its highest bit-rate of 23.85 kbps.
For North American English (Figure 5.1.1.6.3.1-1b), EVS SWB 13.2 kbps channel aware mode operating at around 6% FER delivers quality on par with that of the highest bit-rate of AMR-WB (23.85 kbps) under no loss. The 13.2 kbps SWB non-channel aware mode is able to achieve the quality equivalence to AMR-WB 23.85 clean channel when operating at around 3% FER. EVS 13.2 kbps channel aware mode even at 10% FER delivers quality better than AMR-WB 23.85 kbps at 3% FER, while the 13.2 kbps EVS SWB non-channel aware mode can operate at 8% FER but achieve quality equivalence to AMR-WB 23.85 kbps at 3% FER.
For Danish (Figure 5.1.1.6.3.1-1a), EVS SWB 13.2 kbps channel aware mode operating at around 3% FER delivers quality on par with that of the highest bit-rate of AMR-WB (23.85 kbps) under no loss. EVS 13.2 kbps channel aware mode even at 10% FER delivers quality equivalent to AMR-WB 23.85 kbps at 3% FER, while the 13.2 kbps EVS SWB non-channel aware mode can operate at 6% FER to achieve quality equivalence to AMR-WB 23.85 kbps at 3% FER.
Figure 5.1.1.6.3.1-2: EVS-SWB Channel aware mode noisy speech performance under clean and impaired channels (North American English with car noise @ 15 dB SNR- Mixed bandwidth DCR test)
In general, the 13.2 kbps EVS-SWB noisy speech performance under impaired channel with channel aware mode enabled is significantly better than without channel aware mode which in turn is significantly better than AMR-WB at its highest bit-rate of 23.85 kbps.
For North American English with car noise at 15 dB SNR, EVS SWB 13.2 kbps channel aware mode operating at 10% FER and the EVS SWB non-channel aware mode operating at 6% FER can achieve quality equivalence to AMR-WB 23.85 kbps at 3% FER.
Figure 5.1.1.6.3.1-3: EVS-WB Channel aware mode clean speech performance under clean and impaired channels (Single bandwidth ACR test –Experiment W1 from EVS Characterization Testing) (a) North American English, (b) Mandarin
For North American English (Figure 5.1.1.6.3.1-3a), the 13.2 kbps EVS-WB clean speech performance under impaired channel with channel aware mode enabled is significantly better than without channel aware mode which in turn is significantly better than AMR-WB at 15.85 kbps. The quality of EVS WB 13.2 kbps channel aware and non-channel aware modes in clean channel are significantly better than AMR-WB at 15.85 kbps.
Specifically, it can be seen that for both languages tested, the EVS 13.2 kbps channel aware mode operating at 10% FER can deliver quality on par with AMR-WB at 15.85 kbps at 3% FER. In addition, the 13.2 kbps non-channel aware mode can operate at 6% FER to achieve equivalence to AMR-WB 15.85 kbps at 3% FER.
Since AMR-WB 12.65 kbps at 2% FER (""HD Voice"" center of cell speech quality) quality benchmark was not included in the tests summarizes in Figures 5.1.1.6.3.1-3a and 5.1.1.6.3.1-3b, the source used P.OLQA to determine the frame error rate at which the 13.2 kbps EVS WB channel aware and non-channel aware modes is equal to the ""HD Voice"" reference speech quality.
The source presents below the result of a study to characterize the correlation between subjective MOS and P.OLQA [10] for the North American English Absolute Category Rating (ACR) MOS test results shown in Figure 5.1.1.6.3.1-3a. A North American English database comprising of 3 male and 3 female talkers with 5 sentence pairs per talker was used for computing the P.OLQA scores. The sentence pair wise scores for each condition was averaged to obtain a single P.OLQA score for the condition.
NOTE. As per [12], POLQA has been tested to work with background noise levels. A fixed lower SNR limit at which POLQA can be applied was not reported in [12] and it was noted that it is highly signal-dependent. POLQA analysis in this Clause is done on clean speech in clean and noisy channel conditions. POLQA analysis for extreme noisy conditions [10 to -5 dB] is not performed.
To study the correlation between the POLQA and subjective MOS, the relationship between the two sre plotted in Figure 5.1.1.6.3.1-4. The data points in this plot include the subjective MOS scores from Figure 5.1.1.6.3.1-3a and POLQA scores computed as described above. The data points used for this plot include all conditions (clean channel and all delay loss profiles tested) of AMR-WB 15.85 kbps, EVS-WB 13.2 kbps non-channel aware and channel aware modes (a plot showing the correlation with the channel and non-channel aware modes separated is provided in clause A.2 of the Annex). The ""Linear (AMR-WB)"" line represents the linear regression between AMR-WB MOS and the corresponding POLQA scores. Therefore, assuming that the ""Linear (AMR-WB)"" represents the true relationship between POLQA and subjective MOS, then it is seen that POLQA underestimates the subjective quality of EVS WB 13.2 kbps modes.
Figure 5.1.1.6.3.1-4: Correlation between Subjective MOS and P.OLQA
Figure 5.1.1.6.3.1-5: Use of P.OLQA to determine frame error rate for EVS WB 13.2 kbps channel aware and non-channel aware modes at same speech quality as AMR-WB 2% FER
As illustrated in Figure 5.1.1.6.3.1-5, EVS WB 13.2 kbps channel aware mode operating under 8% FER results in the same P.OLQA score as AMR-WB 12.65 kbps at 2% FER. The corresponding data point for the non-channel aware mode is 4% FER. The 3, 6, 8 and 10% FER data points (anchors) shown on the X-axis in Figure 4.1.6 were simulated via delay loss profiles 7, 8, 9 and 10 respectively (used in ACR MOS results shown in Figure 4.1.4a). Delay loss profiles to simulate the other FER data points were created as a random subset of the nearest highest FER anchor. For example the 1 and 2% FER profiles were created as a subset of delay loss profile 7 (3% FER).
Taking into account the under estimation observed in Figure 5.1.1.6.3.1-4 and results from the subjective MOS tests shown in Figure 5.1.1.6.3.1-3a and 5.1.1.6.3.1-3b, it can be seen that the above determination of frame error rate for EVS-WB 13.2 kbps channel aware and non-channel aware modes to achieve the same speech quality as AMR-WB 12.65 kbps at 2% FER, is conservative. The respective SWB modes will provide significantly improved voice quality as compared to the 13.2 kbps WB modes which will result in even higher frame error rates than what is determined above for the WB modes.",TR 26.989,5.1.1.6.3.1,all_images/image_765.png,Correlation between Subjective MOS and P.OLQA
"The simulation results in this clause demonstrate EVS and AMR-WB performance on the downlink MBMS bearer and compare this to the reference. The error conditions and scheduler assumptions considered in the MBMS downlink bearer in these simulations, including the definition of Case 1 and Case2, are detailed in clause A.1. The results provided are the output of simulations conducted by one source company using the models described in clause A.1.
Figures 5.1.1.6.3.3-1 (Superwideband) and 5.1.1.6.3.3-2 (Wideband) show speech quality comparison of EVS vs AMR-WB for Case 1. Simulated error conditions in the downlink MBMS bearer channel is given in Table A.1.3-1. In all MBMS bearer scenarios considered, EVS significantly outperforms AMR-WB in terms of voice quality.
Figure 5.1.1.6.3.3-1: P.OLQA scores for Case 1 – Superwideband Speech
Figure 5.1.1.6.3.3-2: P.OLQA scores for Case 1 – Wideband Speech
Figures 5.1.1.6.3.2-3 and 5.1.1.6.3.2-4 show speech quality for Case 2 described in clause A.1.3. Total uplink and network error levels of 1% FER are considered with various MBMS bearer conditions in the downlink with 40ms scheduling at eNB, and de-jitter buffering at the receiving MCPTT UE.
AMR-WB is unable to meet the reference error resilience, speech quality, and speech intelligibility in all scenarios except for the 1% FER cases. EVS meets or exceeds these reference KPIs in most cases. In addition, both EVS wideband and superwideband modes offer notable improvement in voice quality over AMR-WB under various error conditions considered here.
In certain cases (e.g. v120_b5_4 profile in Figure 5.1.1.6.3.2-3) the improvement in P.OLQA scores by EVS over AMR-WB is 0.65, while AMR-WB yield low P.OLQA scores around 2.84. This may translate into scenarios where an end user may not understand certain portions of speech with AMR-WB under certain FER conditions in the MBMS coverage area, while EVS would provide clear and meaningful speech.
In most test cases considered under Case 1 and Case 2 above, AMR-WB is unable to meet the reference ""HD Voice"" quality as it suffers from a significant reduction in voice quality during channel errors. From a coverage perspective, this would be experienced as significant degradation in voice quality in areas exhibiting above channel characteristics with errors. Above results also demonstrate how the EVS can compensate for errors significantly better than AMR-WB. Note that the improvement of speech quality over AMRWB offered by EVS Channel Aware mode increases, when more errors are present in the downlink MBMS bearer channel.
Figure 5.1.1.6.3.3-3: P.OLQA scores for Case 2 – Superwideband Speech
Figure 5.1.1.6.3.3-4: P.OLQA scores for case 2 – Wideband Speech
Error resiliency, Speech Quality, and Speech Intelligibility:
The results in this clause show that EVS can withstand MBMS channel errors much better than AMR-WB. With increasing error rates in the MBMS downlink, AMR-WB speech quality degrades at a faster pace, while EVS is able to maintain a reasonable level of speech quality.
In all of the MBMS bearer scenarios, with the exception of FERs >= 3% in Case 2 wideband, the EVS channel-aware mode is able to meet or exceed the performance of the reference error resiliency, speech quality, and speech intelligibility.
In most of the MBMS bearer scenarios (FER<4% for SWB and FER<3% for WB), EVS non-channel aware mode is able to meet or exceed the performance of the reference.
In all the cases where EVS non-channel aware mode cannot meet the reference, it significantly outperforms AMR-WB. AMR-WB fails to meet the reference in all scenarios except for the 1% FER cases.
Coverage:
Figures 5.1.1.6.3.3-1, 5.1.1.6.3.3-2, 5.1.1.6.3.3-3, and 5.1.1.6.3.3-4 show that EVS channel aware and non-channel aware modes provide significantly better and better coverage than AMR-WB, respectively, due to their ability to handle higher FERs with less degradation in voice quality.
The simulations discussed in clause A.1.1 demonstrated that less than 95% of the cell coverage area can support FER <=1% on the MBMS bearer downlink in SC-PTM when two rings of adjacent cells are only transmitting at 50% interference. Unfortunately, it was not possible to generate more simulation results showing exactly how much cell coverage area provides <=1% FER and how much provides <=5% FER using SC-PTM.
However, it is expected that relaxing the FER target to 5% in the simulations will improve the coverage enough to cover at least 90% of the cell and thus demonstrate that EVS channel aware mode operated over the SC-PTM in the simulated conditions can at least meet the reference coverage.
A comparison of MBMS MBSFN coverage to the reference was not provided as the source did not have simulations that could be used for this analysis.
Call Capacity:
It is not possible to make a reasonable comparison of the capacity of an MBMS bearer with the capacity of an HD Voice unicast bearer system. For example, the number of users supported by the MBMS bearer could be very high when there's a very dense concentration of listeners near the center of the cell.
Nevertheless, the following observations and statements can be made regarding MBMS capacity.
When operating EVS at 13.2 kbps it consumes the same MBMS bearer resources as AMR-WB 12.65kbps. However, due to the higher error-resiliency of EVS, the number of EVS users that can receive the MBMS speech traffic intelligibly is greater than that of AMR-WB users. Therefore EVS provides better call capacity than AMR-WB.
The EVS VBR mode with a lower average rate of 5.9kbps, which provides the same voice quality as AMR-WB 12.65, can also provide an improvement in capacity by using less of the MBMS bearer resources. This would allow the MBMS bearer to carry concurrently more speech streams of EVS VBR than AMR-WB.",TR 26.989,5.1.1.6.3.3,all_images/image_767.png,P.OLQA scores for Case 1 – Superwideband Speech
"The simulation results in this clause demonstrate EVS and AMR-WB performance on the downlink MBMS bearer and compare this to the reference. The error conditions and scheduler assumptions considered in the MBMS downlink bearer in these simulations, including the definition of Case 1 and Case2, are detailed in clause A.1. The results provided are the output of simulations conducted by one source company using the models described in clause A.1.
Figures 5.1.1.6.3.3-1 (Superwideband) and 5.1.1.6.3.3-2 (Wideband) show speech quality comparison of EVS vs AMR-WB for Case 1. Simulated error conditions in the downlink MBMS bearer channel is given in Table A.1.3-1. In all MBMS bearer scenarios considered, EVS significantly outperforms AMR-WB in terms of voice quality.
Figure 5.1.1.6.3.3-1: P.OLQA scores for Case 1 – Superwideband Speech
Figure 5.1.1.6.3.3-2: P.OLQA scores for Case 1 – Wideband Speech
Figures 5.1.1.6.3.2-3 and 5.1.1.6.3.2-4 show speech quality for Case 2 described in clause A.1.3. Total uplink and network error levels of 1% FER are considered with various MBMS bearer conditions in the downlink with 40ms scheduling at eNB, and de-jitter buffering at the receiving MCPTT UE.
AMR-WB is unable to meet the reference error resilience, speech quality, and speech intelligibility in all scenarios except for the 1% FER cases. EVS meets or exceeds these reference KPIs in most cases. In addition, both EVS wideband and superwideband modes offer notable improvement in voice quality over AMR-WB under various error conditions considered here.
In certain cases (e.g. v120_b5_4 profile in Figure 5.1.1.6.3.2-3) the improvement in P.OLQA scores by EVS over AMR-WB is 0.65, while AMR-WB yield low P.OLQA scores around 2.84. This may translate into scenarios where an end user may not understand certain portions of speech with AMR-WB under certain FER conditions in the MBMS coverage area, while EVS would provide clear and meaningful speech.
In most test cases considered under Case 1 and Case 2 above, AMR-WB is unable to meet the reference ""HD Voice"" quality as it suffers from a significant reduction in voice quality during channel errors. From a coverage perspective, this would be experienced as significant degradation in voice quality in areas exhibiting above channel characteristics with errors. Above results also demonstrate how the EVS can compensate for errors significantly better than AMR-WB. Note that the improvement of speech quality over AMRWB offered by EVS Channel Aware mode increases, when more errors are present in the downlink MBMS bearer channel.
Figure 5.1.1.6.3.3-3: P.OLQA scores for Case 2 – Superwideband Speech
Figure 5.1.1.6.3.3-4: P.OLQA scores for case 2 – Wideband Speech
Error resiliency, Speech Quality, and Speech Intelligibility:
The results in this clause show that EVS can withstand MBMS channel errors much better than AMR-WB. With increasing error rates in the MBMS downlink, AMR-WB speech quality degrades at a faster pace, while EVS is able to maintain a reasonable level of speech quality.
In all of the MBMS bearer scenarios, with the exception of FERs >= 3% in Case 2 wideband, the EVS channel-aware mode is able to meet or exceed the performance of the reference error resiliency, speech quality, and speech intelligibility.
In most of the MBMS bearer scenarios (FER<4% for SWB and FER<3% for WB), EVS non-channel aware mode is able to meet or exceed the performance of the reference.
In all the cases where EVS non-channel aware mode cannot meet the reference, it significantly outperforms AMR-WB. AMR-WB fails to meet the reference in all scenarios except for the 1% FER cases.
Coverage:
Figures 5.1.1.6.3.3-1, 5.1.1.6.3.3-2, 5.1.1.6.3.3-3, and 5.1.1.6.3.3-4 show that EVS channel aware and non-channel aware modes provide significantly better and better coverage than AMR-WB, respectively, due to their ability to handle higher FERs with less degradation in voice quality.
The simulations discussed in clause A.1.1 demonstrated that less than 95% of the cell coverage area can support FER <=1% on the MBMS bearer downlink in SC-PTM when two rings of adjacent cells are only transmitting at 50% interference. Unfortunately, it was not possible to generate more simulation results showing exactly how much cell coverage area provides <=1% FER and how much provides <=5% FER using SC-PTM.
However, it is expected that relaxing the FER target to 5% in the simulations will improve the coverage enough to cover at least 90% of the cell and thus demonstrate that EVS channel aware mode operated over the SC-PTM in the simulated conditions can at least meet the reference coverage.
A comparison of MBMS MBSFN coverage to the reference was not provided as the source did not have simulations that could be used for this analysis.
Call Capacity:
It is not possible to make a reasonable comparison of the capacity of an MBMS bearer with the capacity of an HD Voice unicast bearer system. For example, the number of users supported by the MBMS bearer could be very high when there's a very dense concentration of listeners near the center of the cell.
Nevertheless, the following observations and statements can be made regarding MBMS capacity.
When operating EVS at 13.2 kbps it consumes the same MBMS bearer resources as AMR-WB 12.65kbps. However, due to the higher error-resiliency of EVS, the number of EVS users that can receive the MBMS speech traffic intelligibly is greater than that of AMR-WB users. Therefore EVS provides better call capacity than AMR-WB.
The EVS VBR mode with a lower average rate of 5.9kbps, which provides the same voice quality as AMR-WB 12.65, can also provide an improvement in capacity by using less of the MBMS bearer resources. This would allow the MBMS bearer to carry concurrently more speech streams of EVS VBR than AMR-WB.",TR 26.989,5.1.1.6.3.3,all_images/image_768.jpeg,P.OLQA scores for Case 2 – Superwideband Speech
"The following plots show the mean scores and 95% confidence intervals for the experiment with coffee background noise, where 25 naive subjects participated. Unfortunately, not enough subjects did follow the lab invitation for the siren noise experiment and it was not possible to compensate the missing subjects. As a consequence, the it was decided to omit this experiment. It should be noted that the number of listeners is rather small for a codec selection process, however at least the number of 24 listeners has been reached which is the usual minimum requirement for listening tests in a codec qualification process. It should also be noted that this experiment can only be considered a snapshot of listening effort in a single language. Those results do therefore not claim to be exhaustive and should only be used to evaluate trends.
Given that 25 listeners participated in the test and there were six trials per condition, a total number of 3900 trials were reported, meaning 150 trials per condition.
Figure 5.1.1.7.2-1: Plot of listening effort in 10dB SNR coffee background noise for 13.2 kbps gross bit rate incl. AMR-WB, EVS-WB in channel aware mode and EVS-SWB in channel aware mode
Figure 5.1.1.7.2-2: Plot of listening effort in 10dB SNR coffee background noise for 24.4 kbps gross bit rate incl. AMR-WB, EVS-WB and EVS-SWB
The following points can be observed:
All error-free conditions show an average score above 4 on the listening effort scale. These operation points seem to guarantee sufficiently low listening effort and are not considered as critical.
As the experiment design is focusing on high packet loss conditions, conclusions on other influencing factors such as audio bandwidth or bit rate can not be drawn
For packet loss rates of 5% and 10%, EVS always shows a significantly higher score compared to corresponding AMR-WB conditions
EVS with 10% packet loss rate performs similar to AMR-WB at 5% packet loss rate
Using the channel aware mode, EVS@13.2kbps with 20% packet loss rate performs similar to AMR-WB@12.65 with 10% packet loss rate.",TR 26.989,5.1.1.7.2,all_images/image_772.jpeg,Plot of listening effort in 10dB SNR coffee background noise for 13.2 kbps gross
"The following plots show the mean scores and 95% confidence intervals for the experiment with coffee background noise, where 25 naive subjects participated. Unfortunately, not enough subjects did follow the lab invitation for the siren noise experiment and it was not possible to compensate the missing subjects. As a consequence, the it was decided to omit this experiment. It should be noted that the number of listeners is rather small for a codec selection process, however at least the number of 24 listeners has been reached which is the usual minimum requirement for listening tests in a codec qualification process. It should also be noted that this experiment can only be considered a snapshot of listening effort in a single language. Those results do therefore not claim to be exhaustive and should only be used to evaluate trends.
Given that 25 listeners participated in the test and there were six trials per condition, a total number of 3900 trials were reported, meaning 150 trials per condition.
Figure 5.1.1.7.2-1: Plot of listening effort in 10dB SNR coffee background noise for 13.2 kbps gross bit rate incl. AMR-WB, EVS-WB in channel aware mode and EVS-SWB in channel aware mode
Figure 5.1.1.7.2-2: Plot of listening effort in 10dB SNR coffee background noise for 24.4 kbps gross bit rate incl. AMR-WB, EVS-WB and EVS-SWB
The following points can be observed:
All error-free conditions show an average score above 4 on the listening effort scale. These operation points seem to guarantee sufficiently low listening effort and are not considered as critical.
As the experiment design is focusing on high packet loss conditions, conclusions on other influencing factors such as audio bandwidth or bit rate can not be drawn
For packet loss rates of 5% and 10%, EVS always shows a significantly higher score compared to corresponding AMR-WB conditions
EVS with 10% packet loss rate performs similar to AMR-WB at 5% packet loss rate
Using the channel aware mode, EVS@13.2kbps with 20% packet loss rate performs similar to AMR-WB@12.65 with 10% packet loss rate.",TR 26.989,5.1.1.7.2,all_images/image_773.jpeg,Plot of listening effort in 10dB SNR coffee background noise for 24.4 kbps gross
"Figure 4.2.2.2-1 provides a functional structure for Type 1: 5G STandalone AR (STAR) UE.
Figure 4.2.2.2-1: Functional structure for Type 1: 5G STandalone AR (STAR) UE
Main characteristics of Type 1: 5G STandalone AR (STAR) UE:
-	The STAR UE is a regular 5G UE. 5G connectivity is provided through an embedded 5G modem.
-	The AR Runtime is local and uses input from sensors, audio inputs or video inputs. XR Spatial Compute is primarily local, but may access or share information on the network.
-	The AR Scene Manager is local and provides immersive rendering capabilities. Support of compute on the network may be provided, but scenes may typically be composed on the UE.
-	The AR/MR application is resident on the device.
-	An AR/MR application provider is providing a service and the service may be supported/assisted by network-based AR functions and rendering.
-	Due to the amount of processing required, such devices are likely to require a higher power consumption in comparison to the other device types.
-	As the device includes all UE functionalities, the application resides and pre-dominantly is executed on the device and all essential AR/MR functions are available for typical media processing use cases, the device referred to as STandalone AR (STAR) UE.
-	Media Access Functions are provided that support the delivery of media content components over the 5G system. For details refer to clause 4.2.6.
-	The application may also communicate though the 5G System using a dedicated interface.",TR 26.998,4.2.2.2,all_images/image_775.jpeg,Functional structure for Type 1: 5G STandalone AR (STAR) UE
"This clause introduces the 5G WireLess Tethered AR UE. Two sub-types are differentiated:
Split Rendering WLAR UE. In this case the 5G phone that includes the modem also acts to support rendering of complex scenes and provides the pre-rendered data to the glass
Relay WLAR UE: In this case, the 5G phone acts as a relay to provide IP connectivity.
Figure 4.2.2.4-1 provides a functional structure for Type 3a: 5G Split Rendering WireLess Tethered AR UE.
Figure 4.2.2.4-1: Functional structure for Type 3a: 5G Split Rendering WireLess Tethered AR UE
Main characteristics of Type 3a: 5G Split Rendering WireLess Tethered AR UE:
-	5G connectivity is provided through a tethered device which embeds the 5G modem. Wireless tethered connectivity is provided through WiFi or 5G sidelink. BLE (Bluetooth Low Energy) connectivity may be used for audio. The motion-to-render-to-photon loop runs from the glass to the phone. While the connectivity is outside of the 5G Uu domain, it is still expected that for proper performance when used for split rendering, a stable and constant delay link may be setup on the tethered connection.
-	The AR Runtime is local and uses from sensors, audio inputs or video inputs, but may be assisted by functionalities on phone.
-	While media processing (for 2D media) may be done on the AR glasses, energy intensive AR/MR media processing may be done on the AR/MR tethered device or split.
-	Some devices might have limited support for immersive media decoding and rendering and may need to rely on 5G cloud/edge
-	While such devices are likely to use significantly less processing than Type 1: 5G STAR devices by making use of the processing capabilities of the tethered device, they still support a lot of local media and AR/MR processing. Such devices are expected to provide 8-10h of battery life while keeping a significantly low weight.
-	The tethered glass itself is not a regular 5G UE, but the combination of the glass and the phone results in a regular 5G UE.
-	Media Access Functions are provided that support the delivery of media content components over the 5G system. Examples of the Media Access Functions are 5GMS functions, MTSI functions, web-connectivity or edge-related client functions. Detailed requirements are for study in this report.
Figure 4.2.2.4-2 provides a functional structure for Type 3b: 5G Relay WireLess Tethered AR UE.
Figure 4.2.2.4-2: Functional structure for Type 3b: 5G Relay WireLess Tethered AR UE
Main characteristics of Type 3b: 5G Relay WireLess Tethered AR UE:
-	5G connectivity is provided through a tethered device which embeds the 5G modem. Wireless tethered connectivity is through WiFi or 5G sidelink. BLE (Bluetooth Low Energy) connectivity may be used for audio.
-	The 5G Phone acts as a relay to forward IP packets. The 5G Phone runs a Media Session Handler including EDGE functionalities to support QoS control on the 5G System. To support proper end-to-end QoS, the media session handling needs to take into account the constraints of the tethering link to provide sufficient QoS on the 5G System link to provide adequate QoE for the end user. Details on the exact function of the relay, for example of it is on IP layer (layer 3) or on lower layer is for further study.
-	Media Access functions are provided on the glass device to support the delivery of media content components over the 5G and wireless tethered link.
-	The motion-to-render-to-photon loop runs from the glass to the edge and hence includes in total 4 wireless links. It is expected that for proper performance when used for split rendering, a stable and constant delay end to end link needs to be setup.
-	The AR Runtime is local and uses from sensors, audio inputs or video inputs, but may be assisted by functionalities on phone.
-	Media Processing is either done on the glass device or it is split with the network. In particular, relevant is that many devices have limited support for immersive media decoding and rendering and may need to rely on 5G cloud/edge.
-	While such devices are likely to use significantly less processing than Type 1: 5G STAR devices by making use of the processing capabilities of the tethered device, they still support a lot of local media and AR/MR processing. Such devices are expected to provide 8-10h of battery life while keeping a significantly low weight.
-	The tethered glass itself is not a regular 5G UE, but the combination of the glass and the phone results in a regular 5G UE.
-	For services with low latency requirements, such as MTSI or those provided by FLUS, it may be necessary to take the status of wireless connectivity into account when configuring the services, such that the link between AR glass and 5G phone is not overly loaded. Although some work on the convergence of different acces networks is defined in [3], the coordination of the operation of Uu and wireless connectivity in such services is FFS.
A key challenge for WLAR and WTAR UEs is to properly estimate the required QoS allocations for the AR sessions. The QoS allocation must take into account the wireless/wired tethering link from the glass to the UE. This applies to all QoS parameters, namely bitrate, packet loss, delay, and jitter. The following diagram depicts a breakdown of the components contributing to the end-to-end delay as an example:
Figure 4.2.2.4-3: End-to-end delay breakdown to components
For a smooth operation of the AR session, the UE must estimate the impact of the tethering link on the overal QoS requirements. This corresponds to the Dn,1 component in the example figure. The MSH on the UE is the best entity to perform such estimates, which it may do by:
-	Running some measurement tests for latency, packet loss, and bitrate
-	Exchanging information with the radio and/or AF on the QoS policy
The MSH may regularly adjust its QoS allocation based on the observation of the status of the tethering link, thus targeting a consistent end-to-end QoS experience.",TR 26.998,4.2.2.4,all_images/image_777.jpeg,Functional structure for Type 3a: 5G Split Rendering WireLess Tethered AR UE
"This clause introduces the 5G WireLess Tethered AR UE. Two sub-types are differentiated:
Split Rendering WLAR UE. In this case the 5G phone that includes the modem also acts to support rendering of complex scenes and provides the pre-rendered data to the glass
Relay WLAR UE: In this case, the 5G phone acts as a relay to provide IP connectivity.
Figure 4.2.2.4-1 provides a functional structure for Type 3a: 5G Split Rendering WireLess Tethered AR UE.
Figure 4.2.2.4-1: Functional structure for Type 3a: 5G Split Rendering WireLess Tethered AR UE
Main characteristics of Type 3a: 5G Split Rendering WireLess Tethered AR UE:
-	5G connectivity is provided through a tethered device which embeds the 5G modem. Wireless tethered connectivity is provided through WiFi or 5G sidelink. BLE (Bluetooth Low Energy) connectivity may be used for audio. The motion-to-render-to-photon loop runs from the glass to the phone. While the connectivity is outside of the 5G Uu domain, it is still expected that for proper performance when used for split rendering, a stable and constant delay link may be setup on the tethered connection.
-	The AR Runtime is local and uses from sensors, audio inputs or video inputs, but may be assisted by functionalities on phone.
-	While media processing (for 2D media) may be done on the AR glasses, energy intensive AR/MR media processing may be done on the AR/MR tethered device or split.
-	Some devices might have limited support for immersive media decoding and rendering and may need to rely on 5G cloud/edge
-	While such devices are likely to use significantly less processing than Type 1: 5G STAR devices by making use of the processing capabilities of the tethered device, they still support a lot of local media and AR/MR processing. Such devices are expected to provide 8-10h of battery life while keeping a significantly low weight.
-	The tethered glass itself is not a regular 5G UE, but the combination of the glass and the phone results in a regular 5G UE.
-	Media Access Functions are provided that support the delivery of media content components over the 5G system. Examples of the Media Access Functions are 5GMS functions, MTSI functions, web-connectivity or edge-related client functions. Detailed requirements are for study in this report.
Figure 4.2.2.4-2 provides a functional structure for Type 3b: 5G Relay WireLess Tethered AR UE.
Figure 4.2.2.4-2: Functional structure for Type 3b: 5G Relay WireLess Tethered AR UE
Main characteristics of Type 3b: 5G Relay WireLess Tethered AR UE:
-	5G connectivity is provided through a tethered device which embeds the 5G modem. Wireless tethered connectivity is through WiFi or 5G sidelink. BLE (Bluetooth Low Energy) connectivity may be used for audio.
-	The 5G Phone acts as a relay to forward IP packets. The 5G Phone runs a Media Session Handler including EDGE functionalities to support QoS control on the 5G System. To support proper end-to-end QoS, the media session handling needs to take into account the constraints of the tethering link to provide sufficient QoS on the 5G System link to provide adequate QoE for the end user. Details on the exact function of the relay, for example of it is on IP layer (layer 3) or on lower layer is for further study.
-	Media Access functions are provided on the glass device to support the delivery of media content components over the 5G and wireless tethered link.
-	The motion-to-render-to-photon loop runs from the glass to the edge and hence includes in total 4 wireless links. It is expected that for proper performance when used for split rendering, a stable and constant delay end to end link needs to be setup.
-	The AR Runtime is local and uses from sensors, audio inputs or video inputs, but may be assisted by functionalities on phone.
-	Media Processing is either done on the glass device or it is split with the network. In particular, relevant is that many devices have limited support for immersive media decoding and rendering and may need to rely on 5G cloud/edge.
-	While such devices are likely to use significantly less processing than Type 1: 5G STAR devices by making use of the processing capabilities of the tethered device, they still support a lot of local media and AR/MR processing. Such devices are expected to provide 8-10h of battery life while keeping a significantly low weight.
-	The tethered glass itself is not a regular 5G UE, but the combination of the glass and the phone results in a regular 5G UE.
-	For services with low latency requirements, such as MTSI or those provided by FLUS, it may be necessary to take the status of wireless connectivity into account when configuring the services, such that the link between AR glass and 5G phone is not overly loaded. Although some work on the convergence of different acces networks is defined in [3], the coordination of the operation of Uu and wireless connectivity in such services is FFS.
A key challenge for WLAR and WTAR UEs is to properly estimate the required QoS allocations for the AR sessions. The QoS allocation must take into account the wireless/wired tethering link from the glass to the UE. This applies to all QoS parameters, namely bitrate, packet loss, delay, and jitter. The following diagram depicts a breakdown of the components contributing to the end-to-end delay as an example:
Figure 4.2.2.4-3: End-to-end delay breakdown to components
For a smooth operation of the AR session, the UE must estimate the impact of the tethering link on the overal QoS requirements. This corresponds to the Dn,1 component in the example figure. The MSH on the UE is the best entity to perform such estimates, which it may do by:
-	Running some measurement tests for latency, packet loss, and bitrate
-	Exchanging information with the radio and/or AF on the QoS policy
The MSH may regularly adjust its QoS allocation based on the observation of the status of the tethering link, thus targeting a consistent end-to-end QoS experience.",TR 26.998,4.2.2.4,all_images/image_778.jpeg,Functional structure for Type 3b: 5G Relay WireLess Tethered AR UE
"In this clause we provide a typical workflow for setting up a session between a 5G UE and network/cloud for receiving AR scenes from a scene provider. The basic workflow is provided in Figure 4.3.1-1. In this case, the following steps happen:
1.	The application contacts the application provider to fetch the entry point for the content. The acquisition of the entry point may be performed in different ways and is considered out of scope. An entry point may for example be a URL to a scene description.
2.	Session set up:
2a.	In case when the entry point is a URL of a scene description, the application initializes the Scene Manager using the acquired entry point.
2b.	The Scene Manager retrieves the scene description from the scene provider based on the entry point information.
NOTE:	The scene provider can be mapped to a functional entity in the cloud/edge. Architecture mappings are described in clause 6.
2c.	The Scene Manager parses the entry point and creates the immersive scene.
2d.	The Scene Manager requests the creation of a local AR/MR session from the AR Runtime.
2e.		The AR Runtime creates a local AR/MR session and performs registration with the local environment.
Then steps 3 and 4 run in parallel:
3:	AR Media Delivery Pipeline: In case when entry point is a scene URL, a delivery session - for accessing scenes (new scenes or scene updates) and related media over the network is established. This can basically use the MAF as well as the scene manager and the corresponding network functions. Details are introduced in clause 4.3.2.
NOTE:	The realization of AR media delivery pipeline may vary in different architectures as shown in clause 6.
4:	XR Spatial Compute Pipeline: A pipeline that uses sensor data to provide an understanding of the physical space surrounding the device to determine the device’s position and orientation and placement of AR objects in reference to the real world and uses XR Spatial Description information from the network to support this process. This uses the XR Spatial Description functions as introduced in clause 4.4.7. Details are introduced in clause 4.3.3.
5:	Steps 3 and 4 run independently, but the results of both pipelines (e.g., media organized in a scene graph and pose of the AR device) are inputs of the AR/MR Scene Manager function. This function handles the common processing of the two asynchronous pipelines to create an AR experience.
Figure 4.3.1-1: Basic workflow for delivering an AR experience",TR 26.998,4.3.1,all_images/image_780.png,Basic workflow for delivering an AR experience
"In this clause, we provide the detailed processes to set up AR Media Delivery Pipeline as addressed in step 3 of Figure 4.3.1-1. This generic basic process may be extended to address specific applications and use cases. The call flow as shown in Figure 4.3.2-1 aligns with the STAR/EDGAR architecture and serves as a baseline for defining use-case specific call flows.
Figure 4.3.2-1: Functional diagram for AR Media Delivery Pipeline
For an AR Media Delivery Pipeline:
1.	The Scene Manager initializes AR delivery session.
2.	The MAF establishes AR delivery session.
3.	The MAF may receive updates to the scene description from the scene provider
4.	The MAF passes the scene update to the Scene Manager.
5.	The Scene Manager updates the current scene.
6.	The Scene Manager acquires the latest pose information and the user’s actions
7.	The Scene Manager in the device shares that information with the Scene Manager in edge/cloud
The media rendering loop consists of the following steps. Note that steps 8, 9 and 10 are running as 3 parallel loops:
8.	For each new object in the scene:
a.	The Scene Manager triggers the MAF to fetch the related media.
b.	The MAF creates a dedicated media pipeline to process the input.
c.	The MAF establishes a transport session for each component of the media object.
9.	For each transport session:
a.	The media pipeline fetches the media data. It could be static, segmented, or real-time media streams.
b.	The media pipeline processes the media and makes it available in buffers.
10.	For each object to be rendered:
a.	The Scene Manager gets processed media data from the media pipeline buffers
b.	The Scene Manager reconstructs and renders the object
11.	The Scene Manager passes the rendered frame to the AR/MR Runtime for display on the user’s HMD.",TR 26.998,4.3.2,all_images/image_781.png,Functional diagram for AR Media Delivery Pipeline
"Building on top of the architectures introduced in clause 4.2 in this document as well as the latency considerations in TR 26.928 [2], Figure 4.5.3-1 provides a summary of different latencies involved networked AR services. Based on TR 26.928 as well as Table 4.5.2-1, two relevant latency requirements for adequate user experience matter:
-	motion-to-photon latency being less 20ms, but preferably even single digit latency below 10ms.
-	pose-to-render-to-photon latency: as small as 50-60ms
It is important to note that the motion-to-photon latency is primarily a function of the device implementation as it is basically covered within the AR runtime. What matters and is relevant is the time used to provide the pose information from the AR runtime to the renderer and the renderer using this pose to generate the displayed media. Final pose correction to the latest pose may always be done in the AR runtime.
Figure 4.5.3-1 provides different latency critical uplink and downlink operations, depending on where the rendering is done, locally, in the edge or in the cloud. If done in the edge or cloud, rendered data needs to be delivered in low-latency and high-quality over the network. The typical operations in this case include:
-	pose detection in the UE
-	sending the pose through a 5G uplink network to the edge of cloud.
-	rendering the scene in the edge or cloud
-	compressing and encrypting the rendered scene and delivering to the UE
-	decrypting and decompressing the rendered scene
-	composition of the scene
-	applying the latest pose in the pose correction and display the immersive media.
Note that Figure 4.5.3-1 also adds buffers that are typically handled by the AR Run time, namely eye and depth as well as sound buffers.
Figure 4.5.3-1: Typical Latencies in networked AR services
It is ultimately relevant that in case of networking the rendering loop, the processes in the loop are executed such that the end-to-end latency requirements for the pose-to-render-to-photon latency are ensured. Clearly the “closer” the rendering happens at the AR UE, the easier it is to meet latency requirements. However, with proper support of 5G system and media functionalities, these networked AR challenges are solved. This is subject of the remaining discussion of this report.
With reference to TR 26.928 [2], other types of latencies impact the user experience, for example when used for cloud gaming, interactive scenes or in case of real-time network-based processing of sensor data. These aspects are not specific to AR but are also relevant. Some more details are provided in clause 6 for the different scenarios.",TR 26.998,4.5.3,all_images/image_782.jpeg,Typical Latencies in networked AR services
"ETSI Industry Specification Group AR Framework (ISG ARF) has developed a framework for AR components and systems [21]. It introduces the characteristics of an AR system and describes the functional building blocks of the AR reference architecture and their mutual relationships. The generic nature of the architecture is validated by mapping the workflow of several use cases to the components of this framework architecture.
The ETSI AR Framework Architecture describes a system composed of hardware and software components as well as data describing the real world and virtual content. The architecture is composed of three layers as described in clause 4 of [21] and illustrated in Figure 4.6.3-1.
Hardware layer including:
>	Tracking Sensors: These sensors aim to localize (position and orientation) the AR system in real-time in order to register virtual contents with the real environment. Most of AR systems such as smartphones, tablets or see-through glasses embed at least one or several vision sensors (generally monochrome or RGB cameras) as well as an inertial measurement unit and a GPS™. However, specific and/or recent systems use complementary sensors such as dedicated vision sensors (e.g. depth sensors and event cameras), or exteroceptive sensors (e.g. Infrared/laser tracking, Li-Fi™ and Wi-Fi™).
>	Processing Units: Computer vision, machine learning-based inference as well as 3D rendering are processing operations requiring significant computing resources optimized thanks to dedicated processor architectures (e.g. GPU, VPU and TPU). These processing units may be embedded in the device, may be remote and/or distributed.
>	Rendering Interfaces: Virtual content require interfaces to be rendered to the user so that he or she may perceive them as part of the real world. As each rendering device has its own characteristics, the signals generated by the rendering software generally need to be transformed in order to adapt them to each specific rendering hardware.
-	Software layer including:
>	Vision Engine: This software aims to mix the virtual content with the real world. It consists of localizing (position and orientation) the AR device relative to the real world reference, localizing specific real objects relatively to the AR device, reconstructing a 3D representation of the real world or analysing the real world (e.g. objects detection, segmentation, classification and tracking). This software component essentially uses vision sensors signals as input, but not only (e.g. fusion of visual information with inertial measurements or initialization with a GPS), it benefits from the hardware optimization offered by the various dedicated processors embedded in the device or remote, and will deliver to the rendering engine all information required to adapt the rendering for a consistent combination of virtual content with the real world.
>	3D Rendering Engine: This software maintains an up-to-date internal 3D representation of the virtual scene augmenting the real world. This internal representation is updated in real-time according to various inputs such as user's interactions, virtual objects behaviour, the last user viewpoint estimated by the Vision Engine, an update of the World Knowledge to manage for example occlusions between real and virtual elements, etc. This internal representation of the virtual content is accessible by the renderer (e.g. video, audio or haptic) which produces thanks to dedicated hardware (e.g. Graphic Processing unit) data (e.g. 2D images, sounds or forces) ready to be played by the Rendering Interfaces (e.g. screens, headphones or a force-feedback arm).
-	Data layer including:
>	World Knowledge: This World Knowledge represents the information either generated by the Vision Engine or imported from external tools to provide information about the real world or a part of this world (CAD model, markers, etc.). This World Knowledge corresponds to the digital representation of the real space used for different usages such as localization, world analysis, 3D reconstruction, etc.
>	Interactive Content: These Interactive Content represent the virtual content mixed to the perception of the real world. These contents may be interactive or dynamic, meaning that they include both 3D contents, their animations, their behaviour regarding input events such as user's interactions. These Interactive Contents could be extracted from external authoring tools requiring to adapt original content to AR application (e.g. 3D model simplification, fusion, and instruction guidelines conversion).
Figure 4.6.3-1: Global overview of the architecture of an AR system
In the ETSI AR functional architecture, there are eleven logical functions as illustrated in Figure 4.6.3-2. Each function is composed of two or more subfunctions.
Figure 4.6.3-2: Diagram of the functional reference architecture
The ETSI ISG ARF has validated that the functional architecture covers all requirements for AR experience delivery in a variety of use cases. The logical functions are connected by Reference Point (RP). An RP in the AR functional architecture is located at the juncture of two non-overlapping functions and represents the interactions between those functions.
Details for each of the eleven functions and their subfunctions are described in clause 5 of [21] and details of each of the 18 RPs are described in clause 6 of [21].",TR 26.998,4.6.3,all_images/image_783.jpeg,Global overview of the architecture of an AR system
"ETSI Industry Specification Group AR Framework (ISG ARF) has developed a framework for AR components and systems [21]. It introduces the characteristics of an AR system and describes the functional building blocks of the AR reference architecture and their mutual relationships. The generic nature of the architecture is validated by mapping the workflow of several use cases to the components of this framework architecture.
The ETSI AR Framework Architecture describes a system composed of hardware and software components as well as data describing the real world and virtual content. The architecture is composed of three layers as described in clause 4 of [21] and illustrated in Figure 4.6.3-1.
Hardware layer including:
>	Tracking Sensors: These sensors aim to localize (position and orientation) the AR system in real-time in order to register virtual contents with the real environment. Most of AR systems such as smartphones, tablets or see-through glasses embed at least one or several vision sensors (generally monochrome or RGB cameras) as well as an inertial measurement unit and a GPS™. However, specific and/or recent systems use complementary sensors such as dedicated vision sensors (e.g. depth sensors and event cameras), or exteroceptive sensors (e.g. Infrared/laser tracking, Li-Fi™ and Wi-Fi™).
>	Processing Units: Computer vision, machine learning-based inference as well as 3D rendering are processing operations requiring significant computing resources optimized thanks to dedicated processor architectures (e.g. GPU, VPU and TPU). These processing units may be embedded in the device, may be remote and/or distributed.
>	Rendering Interfaces: Virtual content require interfaces to be rendered to the user so that he or she may perceive them as part of the real world. As each rendering device has its own characteristics, the signals generated by the rendering software generally need to be transformed in order to adapt them to each specific rendering hardware.
-	Software layer including:
>	Vision Engine: This software aims to mix the virtual content with the real world. It consists of localizing (position and orientation) the AR device relative to the real world reference, localizing specific real objects relatively to the AR device, reconstructing a 3D representation of the real world or analysing the real world (e.g. objects detection, segmentation, classification and tracking). This software component essentially uses vision sensors signals as input, but not only (e.g. fusion of visual information with inertial measurements or initialization with a GPS), it benefits from the hardware optimization offered by the various dedicated processors embedded in the device or remote, and will deliver to the rendering engine all information required to adapt the rendering for a consistent combination of virtual content with the real world.
>	3D Rendering Engine: This software maintains an up-to-date internal 3D representation of the virtual scene augmenting the real world. This internal representation is updated in real-time according to various inputs such as user's interactions, virtual objects behaviour, the last user viewpoint estimated by the Vision Engine, an update of the World Knowledge to manage for example occlusions between real and virtual elements, etc. This internal representation of the virtual content is accessible by the renderer (e.g. video, audio or haptic) which produces thanks to dedicated hardware (e.g. Graphic Processing unit) data (e.g. 2D images, sounds or forces) ready to be played by the Rendering Interfaces (e.g. screens, headphones or a force-feedback arm).
-	Data layer including:
>	World Knowledge: This World Knowledge represents the information either generated by the Vision Engine or imported from external tools to provide information about the real world or a part of this world (CAD model, markers, etc.). This World Knowledge corresponds to the digital representation of the real space used for different usages such as localization, world analysis, 3D reconstruction, etc.
>	Interactive Content: These Interactive Content represent the virtual content mixed to the perception of the real world. These contents may be interactive or dynamic, meaning that they include both 3D contents, their animations, their behaviour regarding input events such as user's interactions. These Interactive Contents could be extracted from external authoring tools requiring to adapt original content to AR application (e.g. 3D model simplification, fusion, and instruction guidelines conversion).
Figure 4.6.3-1: Global overview of the architecture of an AR system
In the ETSI AR functional architecture, there are eleven logical functions as illustrated in Figure 4.6.3-2. Each function is composed of two or more subfunctions.
Figure 4.6.3-2: Diagram of the functional reference architecture
The ETSI ISG ARF has validated that the functional architecture covers all requirements for AR experience delivery in a variety of use cases. The logical functions are connected by Reference Point (RP). An RP in the AR functional architecture is located at the juncture of two non-overlapping functions and represents the interactions between those functions.
Details for each of the eleven functions and their subfunctions are described in clause 5 of [21] and details of each of the 18 RPs are described in clause 6 of [21].",TR 26.998,4.6.3,all_images/image_784.jpeg,Diagram of the functional reference architecture
"Figure 6.2.4.1-1 illustrates the procedure diagram for 5G immersive media downlink streaming using a STAR-based UE when all essential AR/MR functions in a UE are available without an assist by an edge.
Figure 6.2.4.1-1: STAR-based procedure for 5G downlink streaming
Prerequisites and assumptions:
-	The AR/MR Scene Manager includes immersive media rendering and scene graph handling functionalities.
-	The Media Player includes immersive content delivery and immersive media decoding functionalities.
-	The AR/MR Application in the UE is run by the user.
-	The STAR UE initialises AR registration (starts analysing the surroundings where a user/UE is located), it namely:
a.	captures its surroundings via camera(s)
b.	analyses where the device is located
c.	registers the device into the analysed surroundings.
-	AR/MR Application and AR/MR Application Provider have exchanged some information, such as device capability or content configuration, for content rendering. The exchange procedures for device capability and content configuration are FFS.
-	AR/MR Application Provider has established a Provisioning Session and its detailed configurations has been exchanged.
-	AR/MR Application Provider has completed to set up ingesting immersive contents.
Procedures:
1.	The scene content is ingested by the 5GMSd AS.
2.	Service Announcement is triggered by AR/MR Application. Service Access Information including Media Client entry or a reference to the Service Access Information is provided through the M8d interface.
3.	Desired media content is selected.
4.	Optionally, the Service Access information is acquired or updated.
5.	The AR/MR Application initializes the Scene Manager with the entry point (full scene description) URL.
6.	The Media Client establishes the transport session for receiving the entry point (scene description).
7.	The Media Client requests and receives the full scene description.
8.	The entry point (scene description) is processed.
9.	The AR/MR Scene Manager requests the creation of a new AR/MR session from the AR Runtime.
10.	The AR Runtime creates a new AR/MR session.
AR Media Delivery Pipeline, steps 11~23 requests, receives and renders scenes and scene updates:
11.	The Media Client and/or AR/MR Scene Manager notifies the necessary QoS information required to the Media Session Handler.
12.	The Media Session Handler shares the information with the 5GMSd AF, in some cases including desired QoS information.  Based on existing provisioning by the AR/MR Application Provider, the 5GMSd AF may request QoS modifications to the PDU sessions.
Steps 13~15 establish the transport sessions, receives, and process the delivery manifests:
13.	For the required media content, the Media Client establishes the transport session(s) to acquire delivery manifest(s) information.
14.	The Media Client requests and receives the delivery manifest(s) from the 5GMSd AS.
15.	The Media Client processes the delivery manifest(s).  It determines for example the number of needed transport sessions for media acquisition.  The Media Client is expected to be able to use the delivery manifest(s) information to initialize the media pipelines for each media stream.
16.	The AR/MR Scene Manager and Media Client configures the rendering and delivery media pipelines.
17.	The Media Client establishes the transport session(s) to acquire the media content.
Media session loop, steps 18~23 provide the latest pose information, request, receive and render the media objects of the immersive scene:
18.	The latest pose information is acquired by the AR/MR Scene Manager and shared to the Media Client.
19.	The Media Client requests the immersive media data according to the delivery manifest processed, possibly taking into account pose information (e.g., viewport dependent streaming).
20.	The Media Client receives the immersive media data and triggers the media rendering pipeline(s), including the registration of AR content into the real world accordingly.
21.	The Media Client decodes and processes the media data. For encrypted media data, the Media Client may also perform decryption.
22.	The Media Client passes the media data to the AR/MR Scene Manager.
23.	The AR/MR Scene Manager renders the media, and passes the rendered media to the AR Runtime, which performs further processing such as registration of the AR content into the real world, and pose correction.",TR 26.998,6.2.4.1,all_images/image_790.png,STAR-based procedure for 5G downlink streaming
"Figure 6.2.4.2-1 illustrates the procedure diagram for 5G immersive media downlink streaming using an EDGAR-based UE.
Figure 6.2.4.2-1: EDGAR-based procedure for 5G downlink streaming
Prerequisites and assumptions:
-	Identical to those from the STAR UE case.
Procedures:
1~8.	Identical to steps 1~8 from the STAR UE case (figure 6.2.4.1-1).
9.	Based on the processed scene description and the device capabilities, the 5GMSd AS/EAS is selected, and edge processes are instantiated using the processes defined in 5GMS_EDGE:
a.	The AR/MR Lightweight Scene Manager sends the scene description and the device capabilities to 5GMS AS. The 5GMS AS derives the EAS KPIs and if needed selects a new AS/EAS (through AF) based on the new KPI.  Then the edge processes are started, and a new entry point URL is provided to the AR/MR Lightweight Scene Manager.
b.	The AR/MR Lightweight Scene Manager derives the EAS KPIs from the scene description and device capabilities, requests the AF to provide the list of suitable EAS. Then the AR/MR Lightweight Scene Manager selects the AS/EAS and requests to start the edge processes in the EAS. The edge processes are started, and a new entry point URL is provided to the AR/MR Lightweight Scene Manager.
10.	The AR/MR Lightweight Scene Manager requests the lightweight scene description. The edge processes derive the lightweight scene description from the full scene description and provide it to AR/MR Lightweight Scene Manager.
11.	The simplified entry point (lightweight scene description) is processed.
12~19.		Identical to steps 9~16 from the STAR UE case (figure 6.2.4.1-1).
20.	The Media Client establishes the transport session(s) to acquire the media content.
21.	The 5GMSd AS initiates and starts a media session. This media session forms a stateful session loop specific to the UE, containing steps 22~25:
Stateful media session loop (steps 22~28):
22.	The latest pose information is acquired by the AR/MR Lightweight Scene Manager and shared to the Media Client.
23.	The Media Client sends the latest pose information to the 5GMSd AS.
24.	The 5GMSd AS performs pre-rendering of the media based on the latest received pose information and possibly any original scene update. Pre-rendering may typically consist of decoding and rendering immersive media, and encoding the rendered (2D) media.
25.	The pre-rendered media is sent by the 5GMSd AS to the Media Client.
26.	The Media Client decodes and processes the media data. For encrypted media data, the Media Client may also perform decryption.
27.	The Media Client passes the media data to the AR/MR Lightweight Scene Manager.
28.	The AR/MR Lightweight Scene Manager renders the media, and passes the rendered media to the AR Runtime, which performs further processing such as registration of the AR content into the real world, composition, and pose correction.",TR 26.998,6.2.4.2,all_images/image_791.png,EDGAR-based procedure for 5G downlink streaming
"Figure 6.3.3.1-1 provides an architecture for immersive interactive media distribution using a STAR UE.
Figure 6.3.3.1-1: STAR-based 5G interactive immersive service architecture",TR 26.998,6.3.3.1,all_images/image_792.jpeg,STAR-based 5G interactive immersive service architecture
"Figure 6.3.4.1-1 illustrates the procedure diagram for interactive immersive services using a STAR-based UE when all essential AR/MR functions in a UE are available without an assist by an edge.
Figure 6.3.4.1-1: STAR-based procedure for interactive immersive service
Prerequisites and assumptions:
-	The AR/MR Scene Manager includes immersive media rendering and scene graph handling functionalities.
-	The Media Player includes immersive content delivery and immersive media decoding functionalities.
-	The AR/MR Application in the UE is run by the user.
-	The STAR UE initialises AR registration (starts analysing the surroundings where a user/UE is located), it namely:
a.	captures its surroundings via camera(s)
b.	analyses where the device is located
c.	registers the device into the analysed surroundings.
-	AR/MR Application and AR/MR Application Provider have exchanged some information, such as device capability or content configuration, for content rendering. The exchange procedures for device capability and content configuration are FFS.
-	AR/MR Application Provider has established a Provisioning Session and its detailed configurations has been exchanged.
-	AR/MR Application Provider has completed to set up ingesting immersive contents.
Procedures:
1.	The Scene Server context is established, and scene content is ingested by the Media AS.
2.	Service Announcement is triggered by AR/MR Application. Service Access Information including Media Client entry or a reference to the Service Access Information is provided through the M8d interface.
3.	Desired media content is selected.
4.	Optionally, the Service Access information is acquired or updated.
5.	The AR/MR Application initializes the Scene Manager with the entry point (full scene description) URL.
6.	The Media Client establishes the transport session for the scene session between the Scene Manager in the UE and the Scene Server.
7.	The Media Client requests and receives the full scene description. The entry point (scene description) is processed by the AR/MR Scene Manager, and a scene session is created.
8.	The AR/MR Scene Manager requests the creation of a new AR/MR session from the AR Runtime.
9.	The AR Runtime creates a new AR/MR session.
AR Media Delivery Pipeline, steps 10~24, send the interaction and pose information and receives and renders the updated scenes accordingly:
10.	The latest interaction and pose information are acquired by the AR/MR Scene Manager and shared to the Media Client. The Media Client sends this information to the Media AS and Scene Server.
11.	The Scene Server processes the scene according to the interaction and pose information from the UE. Depending on the level of processing, the current scene may be updated or replaced.
12.	When needed, one of the following steps:
12a.	The Scene Server sends a new scene entry points to the AR/MR Scene Manager through the Media AS and Media Client (go to step 7), or
12b.	The Scene Server sends a scene update (updating streams/objects) to the AR/MR Scene Manager through the Media AS and Media Client.
13.	The AR/MR Scene requests to create additional streaming sessions if needed for new media objects in the scene.
NOTE:	The number of the additional streaming sessions depends on the delivery mechanism. One or more media objects may be delivered through a single manifest and/or use of the same connection. Therefore, introduction of every new media object may not need an additional streaming session.
14. The Media Session Handle establishes the additional streaming sessions based on the received request.
Streaming session, steps 15~18 establish the transport sessions for media objects and configure the media pipelines
15.	For the required media content, the Media Client establishes the transport session(s) to acquire delivery manifest(s) information.
16.	The Media Client requests and receives the delivery manifest(s) from the Media AS.
17.	The Media Client processes the delivery manifest(s).  It determines for example the number of needed transport sessions for media acquisition.  The Media Client is expected to be able to use the delivery manifest(s) information to initialize the media pipelines for each media stream.
18.	The AR/MR Scene Manager and Media Client configures the rendering and delivery media pipelines.
19.	The Media Client establishes the transport session(s) to acquire the media content.
Media session loop includes steps 20~24 which are for streaming, decoding and rendering media components:
20.	The Media Client requests the immersive media data according to the delivery manifest processed, possibly taking into account pose information (e.g., viewport dependent streaming).
21.	The Media Client receives the immersive media data and triggers the media rendering pipeline(s), including the registration of AR content into the real world accordingly.
22.	The Media Client decodes and processes the media data. For encrypted media data, the Media Client may also perform decryption.
23.	The Media Client passes the media data to the AR/MR Scene Manager.
24.	The AR/MR Scene Manager renders the media, and passes the rendered media to the AR Runtime, which performs further processing such as registration of the AR content into the real world, and pose correction.",TR 26.998,6.3.4.1,all_images/image_794.png,STAR-based procedure for interactive immersive service
"Figure 6.3.4.2-1 illustrates the procedure diagram for interactive immersive services using an EDGAR-based UE.
Figure 6.3.4.2-1: EDGAR-based procedure for interactive immersive service
Prerequisites and assumptions:
-	Identical to those from the STAR UE case.
Procedures:
1~7.	Identical to steps 1~7 from the STAR UE case (figure 6.3.4.1-1).
8.	Based on the processed scene description and the device capabilities, the Media AS/EAS is selected, and edge processes are instantiated using the processes defined in EDGE:
a.	The AR/MR Lightweight Scene Manager sends the scene description and the device capabilities to Media AS. The Media AS derives the EAS KPIs and if needed selects a new AS/EAS (through AF) based on the new KPI.  Then the edge processes are started, and a new entry point URL is provided to the AR/MR Lightweight Scene Manager.
b.	The AR/MR Lightweight Scene Manager derives the EAS KPIs from the scene description and device capabilities, requests the AF to provide the list of suitable EAS. Then the AR/MR Lightweight Scene Manager selects the AS/EAS and requests to start the edge processes in the AS. The edge processes are started, and a new entry point URL is provided to the AR/MR Lightweight Scene Manager.
9.	The AR/MR Lightweight Scene Manager requests the lightweight scene description. The edge processes derive the lightweight scene description from the full scene description and provide it to AR/MR Scene Manager.
10.	The simplified entry point (lightweight scene description) is processed.
11~21.	Identical to steps 8~18 from the STAR UE case (figure 6.3.4.1-1).
NOTE:	After step 15a (12a in Figure 6.3.4.1-1): go to step 10
22.	The Media Client establishes the transport session(s) to acquire the media content.
23.	The Media AS initiates and starts a media session. This media session forms a stateful session loop specific to the UE, containing steps 25~28:
Stateful media session loop (steps 24~30):
24.	The latest pose information is acquired by the AR/MR Lightweight Scene Manager and shared to the Media Client.
25.	The Media Client sends the latest pose information to the Media AS.
26.	The 5GMSd AS performs pre-rendering of the media based on the latest received pose information. Pre-rendering may typically consist of decoding and rendering immersive media, and encoding the rendered (2D) media.
27.	The pre-rendered media is sent by the Media AS to the Media Client.
28.	The Media Client decodes and processes the media data. For encrypted media data, the Media Client may also perform decryption.
29.	The Media Client passes the media data to the AR/MR Lightweight Scene Manager.
30.	The AR/MR Lightweight Scene Manager renders the media, and passes the rendered media to the AR Runtime, which performs further processing such as registration of the AR content into the real world, composition, and pose correction.",TR 26.998,6.3.4.2,all_images/image_795.png,EDGAR-based procedure for interactive immersive service
"The above scenarios relate to the following cases in TR 26.928 [2], clause 6. In particular:
-	For STAR:
>	Viewport-dependent streaming based on clause 6.2.3 as defined TR 26.928 [2],
>	Raster-based split rendering based on clause 6.2.5 as defined TR 26.928 [2],
>	Generalized XR split rendering based on clause 6.2.6 as defined TR 26.928 [2].
-	For EDGAR:
>	Raster-based split rendering based on clause 6.2.5 as defined TR 26.928 [2].
For STAR-based delivery, a basic architecture as shown in Figure 6.3.6-1 applies. Two important latency considerations are important:
-	User interaction latency, i.e. the time duration between the moment at which a user action is initiated and the time such an action is taken into account by the stage performer or content creation engine. In the context of gaming, this is the time between the moment the user interacts with the game and the moment at which the game engine processes the player’s response.
-	End-to-End Latency (EEL): The latency for an action that is originally presented in the scene or captured by camera until its visibility on the remote display.
-	Round-trip Interaction Delay (RID): The time of an action by the user until it sees the action reflected on its screen. This delay is the sum of the user interaction delay and End-to-End Latency.
Figure 6.3.6-1: Architecture and latencies for interactive immersive service
The maximum RID depends on the type of scene.  A typical example is the Stadia cloud gaming platform and an excellent introduction is provided here [52]. Some extracted high-level requirements on user experience for RID are provided between time 700 to 800 ms [52].
Similar data is collected in TR 26.928 [2], clause 4.5. Typically, systems have maximum delay requirements between 60ms and 500ms. In terms of formats and bitrates, similar considerations as for clause 6.2.6 apply. However, note that in many cases a pre-rendering is applied in the network, such that data rates and formats are more similar to the split-rendering considerations. Similar considerations as for clause 6.2.6 apply on raster-based split rendering.
For EDGAR-based devices, raster-based split rendering based on clause 6.2.5 as defined TR 26.928 [2] applies. Similar considerations as for clause 6.2.6 apply.
The uplink is predominantly the pose information and user interactions. Data rates are several 100 kbit/s and the latency need to be small in order to not add to the overall target latency.",TR 26.998,6.3.6,all_images/image_796.png,Architecture and latencies for interactive immersive service
"Figure 6.4.3.1-1 provides an architecture for immersive interactive media distribution using a STAR UE.
Figure 6.4.3.1-1: STAR-based 5G cognitive immersive service architecture",TR 26.998,6.4.3.1,all_images/image_797.jpeg,STAR-based 5G cognitive immersive service architecture
"Figure 6.4.4-1 illustrates the generic procedure diagram for cognitive immersive services for both STAR-based and EDGAR-based UEs.
Figure 6.4.4-1: Generic procedure for cognitive immersive service
Prerequisites and assumptions:
-	The AR/MR Scene Manager includes immersive media rendering and scene graph handling functionalities.
-	The Media Player includes immersive content delivery and immersive media decoding functionalities.
-	The AR/MR Application in the UE is run by the user.
-	The UE initialises AR registration (starts analysing the surroundings where a user/UE is located), it namely:
a.	captures its surroundings via camera(s)
b.	analyses where the device is located
c.	registers the device into the analysed surroundings.
-	AR/MR Application and AR/MR Application Provider have exchanged some information, such as device capability or content configuration, for content rendering. The exchange procedures for device capability and content configuration are FFS.
-	AR/MR Application Provider has established a Provisioning Session and its detailed configurations has been exchanged.
-	AR/MR Application Provider has completed to set up ingesting immersive contents.
Procedures:
1.	The Scene Server context is established, and scene content is ingested by the Media AS.
2.	Service Announcement is triggered by AR/MR Application. Service Access Information including Media Client entry or a reference to the Service Access Information is provided through the M8d interface.
3.	Desired media content is selected.
4.	Optionally, the Service Access information is acquired or updated.
5.	The AR/MR Application initializes the Scene Manager with the entry point (full scene description) URL.
6.	The Media Client establishes the transport session for the scene session between the Scene Manager in the UE and the Scene Server.
7.	The Media Client requests and receives the full scene description. The entry point (scene description) is processed by the AR/MR Scene Manager, and a scene session is created.
8.	The AR/MR Scene Manager requests the creation of a new AR/MR session from the AR Runtime.
9.	The AR Runtime creates a new AR/MR session.
Scene session loop, steps 10~24, send the interaction and pose information and receives and renders the updated scenes accordingly:
10. The latest sensor data (e.g. captured media) is acquired by the AR/MR Scene Manager and shared with the Media Client. The Media Client sends this information to the Media AS and AR/MR Application.
11.	The AR/MR Application performs cognitive processing according to the sensor data from the UE. Depending on the outcome, the current scene may be updated or replaced.
12.	When needed, one of the following steps:
12a. The Scene Server sends a new scene entry point to the AR/MR Scene Manager through the Media AS and Media Client (go to step 7), or
12b. The Scene Server sends a scene update (updating streams/objects) to the AR/MR Scene Manager through the Media AS and Media Client.
13.	The AR/MR Scene requests to create additional streaming sessions if needed for new media objects in the scene.
NOTE:	The number of the additional streaming sessions depends on the delivery mechanism. One or more media objects may be delivered through a single manifest and/or use of the same connection. Therefore, introduction of every new media object may not need an additional streaming session.
14. The Media Session Handle establishes the additional streaming sessions based on the received request.
Streaming session, steps 15~18 establish the transport sessions for media objects and configure the media pipelines
15.	For the required media content, the Media Client establishes the transport session(s) to acquire delivery manifest(s) information.
16.	The Media Client requests and receives the delivery manifest(s) from the Media AS.
17.	The Media Client processes the delivery manifest(s).  It determines for example the number of needed transport sessions for media acquisition.  The Media Client is expected to be able to use the delivery manifest(s) information to initialize the media pipelines for each media stream.
18.	The AR/MR Scene Manager and Media Client configures the rendering and delivery media pipelines.
19.	The Media Client establishes the transport session(s) to acquire the media content.
Media session loop includes steps 20~24 which are for streaming, decoding and rendering media components:
20.	The Media Client requests the media data according to the delivery manifest processed, possibly taking into account pose information (e.g., viewport dependent streaming).
21.	The Media Client receives the media data and triggers the media rendering pipeline(s), including the possible registration of AR content into the real world accordingly (depending on the device type).
22.	The Media Client decodes and processes the media data. For encrypted media data, the Media Client may also perform decryption.
23.	The Media Client passes the media data to the AR/MR Scene Manager.
24.	The XR Spatial Compute Pipeline as specified in clause 4.3.3.
25.	The AR scene data and XR Spatial Compute data are combined for composition and rendering.
6.4.5	Content formats and codecs
Based on the use cases, the following formats, codecs and packaging formats are of relevance for cognitive immersive media distribution of AR:
-	Scene graph and scene description
-	Spatial description
-	2D video formats
-	3D formats such as static and dynamic point clouds or meshes
-	2D video formats with depth
-	Regular audio formats
-	Several video decoding instances
-	Decoding tools for such formats
-	Encoding tools for 2D formats
-	Low-latency downlink and uplink real-time streaming of the above media
-	Uplink streaming of pose information
-	Uplink streaming of media",TR 26.998,6.4.4,all_images/image_799.png,Generic procedure for cognitive immersive service
"There are different options for mapping to 5G system:
a)	The MTSI architecture (TS 26.114 [15]) supports audio and 2D video conversational services. Extending the MTSI architecture to support AR signalling and immersive media. This includes both MTSI/RTP and MTSI/Data channel (DC) stack options.
b)	Extending the 5GMS architecture (TS 26.501 [26]) to support AR conversational services by combining live uplink and live downlink. 5GMS offers basic functionality such as QoS support, reporting, and in the future also edge, which will be beneficial for all types of applications. The typical/expected QoS parameters (especially delay) need to be clarified.
c)	An architecture based on something different than MTSI / IMS or 5GMS, for example, browser implementations such as WebRTC. WebRTC is widely deployed today for conversational services and is built on flexible ecosystem on the device side, which is important in this case since conversational AR will require significant device-side changes.
Table 6.5.3-1: Comparison of different architecture options for supporting AR conversational services
NOTE:	There is no support of WebRTC media stack in 3GPP today, except for the WebRTC data channel stack in MTSI. WebRTC access to IMS was studied in TR 23.701 [41] and TR 23.706, [42] and OTT WebRTC client access to 3GPP core network through a gateway is specified in TS 24.371 [43].
To describe the functional architecture for AR conversational use-cases such as clause Annex A.4 and identify the content delivery protocols and performance indicators an end-to-end architecture is addressed. The end-to-end workflow for AR conferencing (one direction) is shown in Figure 6.5.3-1. Camera is capturing the participant in an AR conferencing scenario. The camera is connected to a UE (e.g. laptop) via a data network (wired/wireless). Live camera feed, sensors and audio signals are provided to a UE/Edge node (or split) which processes, encodes, and transmits immersive media content to the 5G system for distribution. The immersive media processing function in UE may include pre-processing of the captured 3D video, format conversion, and any other processing needed before compression. Immersive media content includes 3D representation, such as in form of meshes or point clouds, of participants in an AR conferencing scenario.  After processing and encoding, the compressed 3D video and audio streams are transmitted over the 5G system. A 5G STAR UE decodes, processes and renders the 3D video and audio stream.
The use-case may be extended to bi-directional/symmetric case by adding a 3D camera on the receiver side and AR glasses on the sender side and applying a similar workflow. For an asymmetrical case of EDGAR UE, the immersive media is further pre-rendered by the immersive media processing function in the 5G System and transmitted to the UE. Depending on the device capability, further media processing such as main scene management, composition, and rendering partial scene for individual participant are processed in cloud/edge.
Figure 6.5.3-1: Extensions to device architecture of conversational services for STAR UE",TR 26.998,6.5.3,all_images/image_800.jpeg,Extensions to device architecture of conversational services for STAR UE
"This instantiation provides the detailed architecture and procedures for the case of extending the current MTSI architecture. Figure 6.5.4-1 provides an MTSI-based architecture of conversational services for STAR UE.
An MTSI client specified in TS 26.114 [15] may be extended to an AR-MTSI client which supports AR immersive media and take a role of Media Access Functions. A data channel application, an HTML web page including JavaScript(s) provided by a data channel server through a bootstrap data channel, also may be used to provide rich user experiences such as sitting side by side on a bench. Support of data channel media is optional for an MTSI client. An AR-MTSI client supporting data channel is denoted as an AR-DCMTSI client. Note that the data channel server may be implemented in IMS core or outside of it.
Figure 6.5.4-1: MTSI-based conversational service architecture for STAR UE
Figure 6.5.4-2 illustrates the procedure diagram for an immersive AR two party call using STAR UEs including an AR-MTSI client.
Figure 6.5.4-2: AR-MTSI client to AR-MTSI client call establishment (STAR UE)
Assumptions:
-	AR immersive media is sent over RTP/UDP/IP.
-	AR immersive media format (e.g. point clouds, triangular/polygon meshes) is negotiated and configured using SDP.
Procedures:
1.	A STAR UE initiates a SIP INVITE request, containing the SDP offer with AR media capabilities.
2.	The call propagates to the terminating STAR UE.
3.	The called party’s STAR UE returns an SDP answer in a SIP 183 progress message. The P-CSCF uses the SDP answer to allocate the required resources.
4.	The originating STAR UE generate a PRACK which is transited to the terminating side of the call.
5.	The originating STAR UE receives an associated 200 OK (PRACK).
6.	The STAR UE reserves internal resources to reflect the SDP answer and configures media pipelines.
7.	The STAR UE sends a SIP UPDATE message with a new SDP offer confirming the selected media parameters.
8.	The 200 OK (UPDATE) response is received for the terminating STAR UE containing the SDP answer.
9.	The terminating STAR UE is now alerted and sends a SIP 180 Ringing response.
10.	When the called party’s STAR UE has answered the call, it sends a 200 OK to the calling party STAR UE.
11.	The STAR UE receives the 200 OK, and sends a SIP ACK message to acknowledge that the call has been established.
12.	The STAR UE processes the immersive media to be transmitted.
a.	The AR runtime function captures and processes the immersive media to be sent.
b.	The AR runtime function passes the immersive media data to the AR-MTSI client.
c.	The AR-MTSI client encodes the immersive media to be sent to the called party’s STAR UE.
NOTE:	The capturing may be done by an external camera. In that case, the processing and encoding may be done outside STAR UE (i.e. AR-MTSI client)
13.	The STAR UE has an AR call established with AR media traffic.
14.	The STAR UE processes the received immersive media.
a.	The AR-MTSI client decodes and process the received immersive media.
b.	The AR-MTSI client passes the immersive media data to the Scene Manager.
c.	The Scene Manager renders the immersive media, which includes the registration of the AR content into the real world accordingly.
Figure 6.5.4-3 illustrates the procedure diagram for an immersive AR two party call using STAR UEs including an AR-DCMTSI client.
Figure 6.5.4-3: AR-DCMTSI client to AR-DCMTSI client call establishment (STAR UE)
Assumptions:
-	AR immersive media is sent over RTP/UDP/IP.
-	AR immersive media is negotiated and configured using SDP.
-	A data channel application provides rich user experiences by utilizing both user’s underlying scene and pose of objects representing users in the scene.
Procedures:
1-14.	Same as the procedures for AR-MTSI client to AR-MTSI client call establishment except that the SDP contains a data channel media description for the bootstrap data channel.
15.	The STAR UE retrieve a data channel application through the bootstrap data channel.
16.	Any additional data channels created and used by the data channel application itself are requested.
17.	The AR-DCMTSI client initiate SIP re-INVITE request, containing an updated SDP offer to establish those data channels.
18.	The data channels for the data channel application has been established.
19.	The established data channel may be used by the data channel application JavaScript(s).",TR 26.998,6.5.4,all_images/image_801.jpeg,MTSI-based conversational service architecture for STAR UE
"This instantiation provides the detailed architecture and procedures for the case of extending the current MTSI architecture. Figure 6.5.4-1 provides an MTSI-based architecture of conversational services for STAR UE.
An MTSI client specified in TS 26.114 [15] may be extended to an AR-MTSI client which supports AR immersive media and take a role of Media Access Functions. A data channel application, an HTML web page including JavaScript(s) provided by a data channel server through a bootstrap data channel, also may be used to provide rich user experiences such as sitting side by side on a bench. Support of data channel media is optional for an MTSI client. An AR-MTSI client supporting data channel is denoted as an AR-DCMTSI client. Note that the data channel server may be implemented in IMS core or outside of it.
Figure 6.5.4-1: MTSI-based conversational service architecture for STAR UE
Figure 6.5.4-2 illustrates the procedure diagram for an immersive AR two party call using STAR UEs including an AR-MTSI client.
Figure 6.5.4-2: AR-MTSI client to AR-MTSI client call establishment (STAR UE)
Assumptions:
-	AR immersive media is sent over RTP/UDP/IP.
-	AR immersive media format (e.g. point clouds, triangular/polygon meshes) is negotiated and configured using SDP.
Procedures:
1.	A STAR UE initiates a SIP INVITE request, containing the SDP offer with AR media capabilities.
2.	The call propagates to the terminating STAR UE.
3.	The called party’s STAR UE returns an SDP answer in a SIP 183 progress message. The P-CSCF uses the SDP answer to allocate the required resources.
4.	The originating STAR UE generate a PRACK which is transited to the terminating side of the call.
5.	The originating STAR UE receives an associated 200 OK (PRACK).
6.	The STAR UE reserves internal resources to reflect the SDP answer and configures media pipelines.
7.	The STAR UE sends a SIP UPDATE message with a new SDP offer confirming the selected media parameters.
8.	The 200 OK (UPDATE) response is received for the terminating STAR UE containing the SDP answer.
9.	The terminating STAR UE is now alerted and sends a SIP 180 Ringing response.
10.	When the called party’s STAR UE has answered the call, it sends a 200 OK to the calling party STAR UE.
11.	The STAR UE receives the 200 OK, and sends a SIP ACK message to acknowledge that the call has been established.
12.	The STAR UE processes the immersive media to be transmitted.
a.	The AR runtime function captures and processes the immersive media to be sent.
b.	The AR runtime function passes the immersive media data to the AR-MTSI client.
c.	The AR-MTSI client encodes the immersive media to be sent to the called party’s STAR UE.
NOTE:	The capturing may be done by an external camera. In that case, the processing and encoding may be done outside STAR UE (i.e. AR-MTSI client)
13.	The STAR UE has an AR call established with AR media traffic.
14.	The STAR UE processes the received immersive media.
a.	The AR-MTSI client decodes and process the received immersive media.
b.	The AR-MTSI client passes the immersive media data to the Scene Manager.
c.	The Scene Manager renders the immersive media, which includes the registration of the AR content into the real world accordingly.
Figure 6.5.4-3 illustrates the procedure diagram for an immersive AR two party call using STAR UEs including an AR-DCMTSI client.
Figure 6.5.4-3: AR-DCMTSI client to AR-DCMTSI client call establishment (STAR UE)
Assumptions:
-	AR immersive media is sent over RTP/UDP/IP.
-	AR immersive media is negotiated and configured using SDP.
-	A data channel application provides rich user experiences by utilizing both user’s underlying scene and pose of objects representing users in the scene.
Procedures:
1-14.	Same as the procedures for AR-MTSI client to AR-MTSI client call establishment except that the SDP contains a data channel media description for the bootstrap data channel.
15.	The STAR UE retrieve a data channel application through the bootstrap data channel.
16.	Any additional data channels created and used by the data channel application itself are requested.
17.	The AR-DCMTSI client initiate SIP re-INVITE request, containing an updated SDP offer to establish those data channels.
18.	The data channels for the data channel application has been established.
19.	The established data channel may be used by the data channel application JavaScript(s).",TR 26.998,6.5.4,all_images/image_802.jpeg,AR-MTSI client to AR-MTSI client call establishment (STAR UE)
"This instantiation provides the detailed architecture and procedures for the case of extending the current MTSI architecture. Figure 6.5.4-1 provides an MTSI-based architecture of conversational services for STAR UE.
An MTSI client specified in TS 26.114 [15] may be extended to an AR-MTSI client which supports AR immersive media and take a role of Media Access Functions. A data channel application, an HTML web page including JavaScript(s) provided by a data channel server through a bootstrap data channel, also may be used to provide rich user experiences such as sitting side by side on a bench. Support of data channel media is optional for an MTSI client. An AR-MTSI client supporting data channel is denoted as an AR-DCMTSI client. Note that the data channel server may be implemented in IMS core or outside of it.
Figure 6.5.4-1: MTSI-based conversational service architecture for STAR UE
Figure 6.5.4-2 illustrates the procedure diagram for an immersive AR two party call using STAR UEs including an AR-MTSI client.
Figure 6.5.4-2: AR-MTSI client to AR-MTSI client call establishment (STAR UE)
Assumptions:
-	AR immersive media is sent over RTP/UDP/IP.
-	AR immersive media format (e.g. point clouds, triangular/polygon meshes) is negotiated and configured using SDP.
Procedures:
1.	A STAR UE initiates a SIP INVITE request, containing the SDP offer with AR media capabilities.
2.	The call propagates to the terminating STAR UE.
3.	The called party’s STAR UE returns an SDP answer in a SIP 183 progress message. The P-CSCF uses the SDP answer to allocate the required resources.
4.	The originating STAR UE generate a PRACK which is transited to the terminating side of the call.
5.	The originating STAR UE receives an associated 200 OK (PRACK).
6.	The STAR UE reserves internal resources to reflect the SDP answer and configures media pipelines.
7.	The STAR UE sends a SIP UPDATE message with a new SDP offer confirming the selected media parameters.
8.	The 200 OK (UPDATE) response is received for the terminating STAR UE containing the SDP answer.
9.	The terminating STAR UE is now alerted and sends a SIP 180 Ringing response.
10.	When the called party’s STAR UE has answered the call, it sends a 200 OK to the calling party STAR UE.
11.	The STAR UE receives the 200 OK, and sends a SIP ACK message to acknowledge that the call has been established.
12.	The STAR UE processes the immersive media to be transmitted.
a.	The AR runtime function captures and processes the immersive media to be sent.
b.	The AR runtime function passes the immersive media data to the AR-MTSI client.
c.	The AR-MTSI client encodes the immersive media to be sent to the called party’s STAR UE.
NOTE:	The capturing may be done by an external camera. In that case, the processing and encoding may be done outside STAR UE (i.e. AR-MTSI client)
13.	The STAR UE has an AR call established with AR media traffic.
14.	The STAR UE processes the received immersive media.
a.	The AR-MTSI client decodes and process the received immersive media.
b.	The AR-MTSI client passes the immersive media data to the Scene Manager.
c.	The Scene Manager renders the immersive media, which includes the registration of the AR content into the real world accordingly.
Figure 6.5.4-3 illustrates the procedure diagram for an immersive AR two party call using STAR UEs including an AR-DCMTSI client.
Figure 6.5.4-3: AR-DCMTSI client to AR-DCMTSI client call establishment (STAR UE)
Assumptions:
-	AR immersive media is sent over RTP/UDP/IP.
-	AR immersive media is negotiated and configured using SDP.
-	A data channel application provides rich user experiences by utilizing both user’s underlying scene and pose of objects representing users in the scene.
Procedures:
1-14.	Same as the procedures for AR-MTSI client to AR-MTSI client call establishment except that the SDP contains a data channel media description for the bootstrap data channel.
15.	The STAR UE retrieve a data channel application through the bootstrap data channel.
16.	Any additional data channels created and used by the data channel application itself are requested.
17.	The AR-DCMTSI client initiate SIP re-INVITE request, containing an updated SDP offer to establish those data channels.
18.	The data channels for the data channel application has been established.
19.	The established data channel may be used by the data channel application JavaScript(s).",TR 26.998,6.5.4,all_images/image_803.png,AR-DCMTSI client to AR-DCMTSI client call establishment (STAR UE)
"Compared with the instantiation for MTSI-based architecture extension, this instantiation emphasises that the IMS-AGW/MRF may support immersive media processing. It is necessary for 5G EDGAR UEs with poor media capabilities. Figure 6.5.5-1 provides an DCMTSI-based architecture of AR conversational services for EDGAR UE. A 5G EDGAR UE integrated with DCMTSI client in terminal is denoted as an EDGAR-DCMTSI client. An EDGAR-DCMTSI client may request an AR application (i.e., an entry point) via a bootstrap data channel from the data channel server. An EDGAR-DCMTSI client may also generate or retrieve some AR specific data (e.g., pose and viewpoint information) which is transmitted via additional data channels, given that non-media data is handled by using SCTP as specified in IETF RFC 8831 [44]. When an EDGAR-DCMTSI client initiates an AR call with another one, the IMS-AGW/MRF with a support of immersive media processing may perform pre-rendering with the media stream originated from the parties of this AR session if they receive the corresponding AR-specific data (i.e. the pose and viewpoint information).
EDGAR-DCMTSI clients negotiate the properties such as reliable or unreliable message transmission, in-order or out-of-order message delivery and an optional protocol for data channel using SDP as defined in IETF RFC 8864 [45]. Based on the user plane protocol stack for a basic MTSI client defined in clause 4.2 of TS 26.114 [15] and the clause 6.5 of IETF RFC 8827 [46], all data channels (e.g., both an AR application via bootstrap data channels and AR-specific data via additional data channels) are secured via DTLS.
Figure 6.5.5-1: DCMTSI-based conversational service architecture for EDGAR UE
Furthermore, the IMS-AGW/MRF with a support of immersive media processing are also desirable to 5G STAR UEs due to saving power consumption. Note that the IMS-AGW/MRF with a support of immersive media processing may perform pre-rendering based on the request of the STAR UEs carried in these additional data channels. Particularly, the logical function of immersive media processing may be integrated in the MRF or other media functions.
Figure 6.5.5-2 illustrates the procedure diagram for an immersive AR conversational with two party using EDGAR UEs including an EDGAR-DCMTSI client in the context of the IMS-AGW/MRF with a support of immersive media processing. The procedure is also applicable to establish an immersive AR call where the two parties of a session are STAR UEs or one is STAR UE and the other is EDGAR UE.
Figure 6.5.5-2: AR-DCMTSI client to AR-DCMTSI client call establishment for EDGAR UE
Assumptions:
-	AR immersive media may be sent over RTP/UDP/IP and/or SCTP/UDP/IP.
-	AR immersive media may be negotiated and configured using SDP.
-	A data channel application may provide rich user experiences by utilizing both user’s underlying scene and pose of objects representing users in the scene.
Procedures:
1.	An EDGAR UE initiates a SIP INVITE request, containing the SDP offer with AR media capabilities.
2.	The call propagates to the terminating EDGAR UE.
3.	The terminating EDGAR UE returns an SDP answer in a SIP 183 progress message. The P-CSCF uses the SDP answer to allocate the required resources.
4.	The originating EDGAR UE generate a PRACK which is transited to the terminating side of the call.
5.	The originating EDGAR UE receives an associated 200 OK (PRACK).
6.	The terminating EDGAR UE reserves internal resources to reflect the SDP answer and configures media pipelines.
7.	The originating EDGAR UE sends a SIP UPDATE message with a new SDP offer confirming the selected media parameters.
8.	The 200 OK (UPDATE) response is received for the terminating STAR UE containing the SDP answer.
9.	The terminating EDGAR UE is now alerted and sends a SIP 180 Ringing response.
10.	When the terminating EDGAR UE has answered the call, it sends a 200 OK to the originating EDGAR UE.
11.	The terminating EDGAR UE receives the 200 OK, and sends a SIP ACK message to acknowledge that the call has been established.
12.	The EDGAR UEs retrieve a data channel application for AR through the bootstrap data channel. If the EDGAR UE enables to provide native AR application, this step is not required.
13.	Any additional data channels created and used by the data channel application for AR itself are requested.
14.	The originating EDGAR UE initiates SIP re-INVITE request, containing an updated SDP offer to establish those additional data channels.
15.	The AS/S-CSCF identify an updated SDP offer for additional data channels and modify the ""c="" as the IP address of the MRF, and then send this SDP offer to the remote party.
16.	The AS/S-CSCF send this updated SDP offer to the remote party.
17.	The AS/S-CSCF receive an updated SDP answer from the remote party.
18.	The AS/S-CSCF identify this updated SDP answer for additional data channels and modify the ""c="" as the IP address of the MRF, and then send this SDP answer to the remote party.
19.	The additional data channels for the data channel application has been established.
20.	The EDGAR UE processes the immersive media to be transmitted.
a.	The AR runtime function captures and processes the immersive media to be sent.
b.	The AR runtime function passes the immersive media data to the AR-DCMTSI client.
c.	The AR-DCMTSI client encodes the immersive media to be transmitted to the IMS-AGW/MRF supporting immersive media processing.
NOTE:	The capturing process may be done by an external camera. In this case, the processing and encoding processes are done outside EDGAR UE (e.g., AR-DCMTSI client)
21.	The data channel application for AR collects the AR-specific data, and decides to send them to the AR-DCMTSI client if the AR experiences requires assistance from the network side.
22.	The AR-DCMTSI client sends the AR-specific data (e.g., virtual objects info) to the IMS-AGW/MRF via the designated data channel 1 based on the previous SDP negotiation.
23.	The IMS-AGW/MRF composes, renders and encodes the AR immersive media based on the received media stream and the AR-specific data from the originating party, and finally send them to the terminating party.
24.	The data channel application for AR collects the AR-specific data, and decides to send them to the AR-DCMTSI client if the AR experiences requires assistance from the network side.
25.	The AR-DCMTSI client sends the AR-specific data (e.g. pose info and/or viewport info) to the IMS-AGW/MRF via the designated data channel 2 based on the previous SDP negotiation.
26.	The IMS-AGW/MRF decodes and pre-renders media stream based on the received media stream from the terminating party and the AR-specific data from the originating party, and finally sends them to the originating party.
27.	The EDGAR UE processes the received immersive media.
a.	The AR-DCMTSI client decodes and process the received immersive media.
b.	The AR-DCMTSI client passes the immersive media data to the Lightweight Scene Manager.
The Lightweight Scene Manager renders the immersive media, which includes the registration of the AR content into the real world accordingly.",TR 26.998,6.5.5,all_images/image_804.jpeg,DCMTSI-based conversational service architecture for EDGAR UE
"Compared with the instantiation for MTSI-based architecture extension, this instantiation emphasises that the IMS-AGW/MRF may support immersive media processing. It is necessary for 5G EDGAR UEs with poor media capabilities. Figure 6.5.5-1 provides an DCMTSI-based architecture of AR conversational services for EDGAR UE. A 5G EDGAR UE integrated with DCMTSI client in terminal is denoted as an EDGAR-DCMTSI client. An EDGAR-DCMTSI client may request an AR application (i.e., an entry point) via a bootstrap data channel from the data channel server. An EDGAR-DCMTSI client may also generate or retrieve some AR specific data (e.g., pose and viewpoint information) which is transmitted via additional data channels, given that non-media data is handled by using SCTP as specified in IETF RFC 8831 [44]. When an EDGAR-DCMTSI client initiates an AR call with another one, the IMS-AGW/MRF with a support of immersive media processing may perform pre-rendering with the media stream originated from the parties of this AR session if they receive the corresponding AR-specific data (i.e. the pose and viewpoint information).
EDGAR-DCMTSI clients negotiate the properties such as reliable or unreliable message transmission, in-order or out-of-order message delivery and an optional protocol for data channel using SDP as defined in IETF RFC 8864 [45]. Based on the user plane protocol stack for a basic MTSI client defined in clause 4.2 of TS 26.114 [15] and the clause 6.5 of IETF RFC 8827 [46], all data channels (e.g., both an AR application via bootstrap data channels and AR-specific data via additional data channels) are secured via DTLS.
Figure 6.5.5-1: DCMTSI-based conversational service architecture for EDGAR UE
Furthermore, the IMS-AGW/MRF with a support of immersive media processing are also desirable to 5G STAR UEs due to saving power consumption. Note that the IMS-AGW/MRF with a support of immersive media processing may perform pre-rendering based on the request of the STAR UEs carried in these additional data channels. Particularly, the logical function of immersive media processing may be integrated in the MRF or other media functions.
Figure 6.5.5-2 illustrates the procedure diagram for an immersive AR conversational with two party using EDGAR UEs including an EDGAR-DCMTSI client in the context of the IMS-AGW/MRF with a support of immersive media processing. The procedure is also applicable to establish an immersive AR call where the two parties of a session are STAR UEs or one is STAR UE and the other is EDGAR UE.
Figure 6.5.5-2: AR-DCMTSI client to AR-DCMTSI client call establishment for EDGAR UE
Assumptions:
-	AR immersive media may be sent over RTP/UDP/IP and/or SCTP/UDP/IP.
-	AR immersive media may be negotiated and configured using SDP.
-	A data channel application may provide rich user experiences by utilizing both user’s underlying scene and pose of objects representing users in the scene.
Procedures:
1.	An EDGAR UE initiates a SIP INVITE request, containing the SDP offer with AR media capabilities.
2.	The call propagates to the terminating EDGAR UE.
3.	The terminating EDGAR UE returns an SDP answer in a SIP 183 progress message. The P-CSCF uses the SDP answer to allocate the required resources.
4.	The originating EDGAR UE generate a PRACK which is transited to the terminating side of the call.
5.	The originating EDGAR UE receives an associated 200 OK (PRACK).
6.	The terminating EDGAR UE reserves internal resources to reflect the SDP answer and configures media pipelines.
7.	The originating EDGAR UE sends a SIP UPDATE message with a new SDP offer confirming the selected media parameters.
8.	The 200 OK (UPDATE) response is received for the terminating STAR UE containing the SDP answer.
9.	The terminating EDGAR UE is now alerted and sends a SIP 180 Ringing response.
10.	When the terminating EDGAR UE has answered the call, it sends a 200 OK to the originating EDGAR UE.
11.	The terminating EDGAR UE receives the 200 OK, and sends a SIP ACK message to acknowledge that the call has been established.
12.	The EDGAR UEs retrieve a data channel application for AR through the bootstrap data channel. If the EDGAR UE enables to provide native AR application, this step is not required.
13.	Any additional data channels created and used by the data channel application for AR itself are requested.
14.	The originating EDGAR UE initiates SIP re-INVITE request, containing an updated SDP offer to establish those additional data channels.
15.	The AS/S-CSCF identify an updated SDP offer for additional data channels and modify the ""c="" as the IP address of the MRF, and then send this SDP offer to the remote party.
16.	The AS/S-CSCF send this updated SDP offer to the remote party.
17.	The AS/S-CSCF receive an updated SDP answer from the remote party.
18.	The AS/S-CSCF identify this updated SDP answer for additional data channels and modify the ""c="" as the IP address of the MRF, and then send this SDP answer to the remote party.
19.	The additional data channels for the data channel application has been established.
20.	The EDGAR UE processes the immersive media to be transmitted.
a.	The AR runtime function captures and processes the immersive media to be sent.
b.	The AR runtime function passes the immersive media data to the AR-DCMTSI client.
c.	The AR-DCMTSI client encodes the immersive media to be transmitted to the IMS-AGW/MRF supporting immersive media processing.
NOTE:	The capturing process may be done by an external camera. In this case, the processing and encoding processes are done outside EDGAR UE (e.g., AR-DCMTSI client)
21.	The data channel application for AR collects the AR-specific data, and decides to send them to the AR-DCMTSI client if the AR experiences requires assistance from the network side.
22.	The AR-DCMTSI client sends the AR-specific data (e.g., virtual objects info) to the IMS-AGW/MRF via the designated data channel 1 based on the previous SDP negotiation.
23.	The IMS-AGW/MRF composes, renders and encodes the AR immersive media based on the received media stream and the AR-specific data from the originating party, and finally send them to the terminating party.
24.	The data channel application for AR collects the AR-specific data, and decides to send them to the AR-DCMTSI client if the AR experiences requires assistance from the network side.
25.	The AR-DCMTSI client sends the AR-specific data (e.g. pose info and/or viewport info) to the IMS-AGW/MRF via the designated data channel 2 based on the previous SDP negotiation.
26.	The IMS-AGW/MRF decodes and pre-renders media stream based on the received media stream from the terminating party and the AR-specific data from the originating party, and finally sends them to the originating party.
27.	The EDGAR UE processes the received immersive media.
a.	The AR-DCMTSI client decodes and process the received immersive media.
b.	The AR-DCMTSI client passes the immersive media data to the Lightweight Scene Manager.
The Lightweight Scene Manager renders the immersive media, which includes the registration of the AR content into the real world accordingly.",TR 26.998,6.5.5,all_images/image_805.jpeg,AR-DCMTSI client to AR-DCMTSI client call establishment for EDGAR UE
"To describe the functional architecture for shared AR conversational experience use case such as clause Annex A.7 and identify the content delivery protocols and performance indicators, an end-to-end architecture is addressed. The end-to-end architecture for shared AR conferencing (one direction) is shown in Figure 6.6.3-1. To simplify the architecture, only 5G STAR UE is considered in this figure.
Figure 6.6.3-1: Shared AR conversational service for STAR UE.
Camera(s) are capturing the participant(s) in an AR conferencing scenario. The camera(s) for each participant are connected to a UE (e.g. laptop or mobile phone or AR glasses) via a data network (wired/wireless). Live camera feeds, sensors, and audio signals are provided to a UE which processes, encodes, and transmits immersive media content to the 5G system for distribution.  In multi-party AR conversational services, the immersive media processing function on the cloud/network receives the uplink streams from various devices and composes a scene description defining the arrangement of individual participants in a single virtual conference room.  The scene description as well as the encoded media streams are delivered to each receiving participant. A receiving participant’s 5G STAR UE receives, decodes, and processes the 3D video and audio streams, and renders them using the received scene description and the information received from its AR Runtime, creating an AR scene of the virtual conference room with all other participants.
Also note that if the format conversion is desired, the immersive media processing function on the cloud may optionally use media services such as pre-processing of the captured 3D video, format conversion, and any other processing before compression of immersive media content including 3D representation, such as in form of meshes or point clouds, of participants in an AR conferencing scenario.
NOTE:	As an example of the composite scene generation, the immersive media processing function may take the input from the participants’ physical constraints, so that the generated scene is consistent with every participants’ environment and can be rendered at each device consistently.
Figure 6.6.3-2 illustrates the architecture for shared AR conversational experience use case when an 5G EDGAR UE (receiver) is used. While the functionalities of the sender and the network/cloud shown in Figure 6.6.3-1 are identical in the STAR and EDGAR devices, an EDGAR device uses a split-rendering function on Cloud/Edge.
Figure 6.6.3-2: Shared AR conversational service for EDGAR UE and cloud/edge pre-rendering.
The AR session management may be done by AR/MR application on device. In this case, it is a responsibility of the device to connect and to acquire an entry point for edge/cloud during the session management. AR Scene Manager on cloud/edge generates the lightweight scene description and simple format of AR media that match AR glass display capabilities of the individual participant’s 5G EDGAR device. The lightweight scene description and encoded rendered scene are delivered to the UE. The UE receives the simple format of AR media and audio streams, decodes and renders them using the received lightweight scene description and the information received from its AR Runtime, creating an AR scene of the virtual conference room with all other participants.",TR 26.998,6.6.3,all_images/image_806.jpeg,Shared AR conversational service for STAR UE.
"Figure 6.6.4-1 illustrates the call flow for an immersive AR conversational for a receiving EDGAR UE. Only one sender is shown in this diagram without showing its detailed call flow.
Figure 6.6.4-1: Shared AR conversational experience call flow for a receiving EDGAR UE
Procedures:
1.	Session Establishment:
a.	The AR/MR Application requests to start a session through EDGE.
b.	The EDGE negotiates with the Scene Composite Generator (SCG) and the sender UE to establish the session.
c.	The EDGE acknowledges the session establishment to the UE.
2.	Media pipeline configuration:
a.	MAF configures its pipelines.
b.	EDGE configures its pipelines.
3.	The AR/MR Application requests the start of the session.
Loops 4, 5, 6, and 7 are run in parallel:
4.	AR uplink loop:
a.	The AR Runtime sends the AR data to the AR/MR Application.
b.	The AR/MR Application processes the data and sends it to the MAF.
c.	The MAF streams up the AR data to the EDGE.
5.	Shared experience loop:
a.	Parallel to 9, the sender UE streams its media streams up to Media Delivery (MD).
b.	The sender UE streams its AR data up to the Scene Graph Compositor (SGC).
c.	Using the AR data from various participants, the SCG creates the composted scene.
d.	The composted scene is delivered to the EDGE.
e.	The media streams are delivered to the EDGE.
6.	Media uplink loop:
a.	The AR Runtime captures the media components and processes them.
b.	The AR Runtime sends the media data to the MAF.
c.	The MAF encodes the media.
d.	The MAF streams up the media streams to the EDGE.
7.	Media downlink loop:
a.	The EDGE parses the scene description and media components, partially renders the scene, and creates a simple scene description as well as the media component.
b.	The simplified scene is delivered to the Media Client and Scene Manager.
c.	Media stream loop:
i.	The pre-rendered media components are streamed to the MAF.
ii.	The MAF decodes the media streams.
iii.	The Scene Manager parses the basic scene description and composes the scene.
iv.	The AR manager after correcting the pose, renders the immersive scene including the registration of AR content into the real world.",TR 26.998,6.6.4,all_images/image_807.jpeg,Shared AR conversational experience call flow for a receiving EDGAR UE
"This clause documents and clusters potential new work and study areas identified in the context of this Technical Report. In particular, two areas have been identified as crucial for supporting AR type of services and applications that impact network and terminal architectures:
-	5G Generic Architecture for Real-Time Media Delivery as introduced in clause 8.2.
-	Support for Media Capabilities for Augmented Reality Glasses as introduced in clause 8.5.
In order to separate the work areas of these potential work topics, Figure 8.1-1 and Figure 8.1-2 provides the high-level scope of these two work topics for STAR-based and EDGAR-based UEs, respectively.
Figure 8.1-1: Work topic separation between AR media capabilities, terminal architecture and network architecture for STAR-type devices.
Figure 8.1-2: Work topic separation between AR media capabilities, terminal architecture and network architecture for EDGAR-type devices.",TR 26.998,8.1,all_images/image_808.jpeg,"Work topic separation between AR media capabilities, terminal architecture and"
,TR 26.928,4.1,all_images/image_810.jpeg,Different Types of Realities and some applications
,TR 26.928,4.1,all_images/image_811.jpeg,Different degrees of freedom for a user in extended realities
"The integration of XR applications within the 5G System is approached following the model of 5G Media Streaming as defined in 3GPP TS 26.501 [8]. Assume a 5G-XR Application Provider being an XR Application provider that makes use of 5G System functionalities for its services. For this purpose, it provides a 5G-XR Aware Application on the UE to make use of a 5G-XR client and network functions using network interfaces and APIs, potentially defined in 5G-XR related specifications.
The architecture in Figure 4.3.2-1 represents potential 5G-XR functions within the 5G System (5GS) as defined in 3GPP TS 23.501 [23]. Three main functions are defined:
5G-XR AF: An Application Function similar as defined in 3GPP TS 23.501 [23], clause 6.2.10, dedicated to 5G-XR Services.
5G-XR AS: An Application Server dedicated to 5G-XR Services.
5G-XR Client: A UE internal function dedicated to 5G-XR Services.
In the context of this Technical Report, 5G-XR AF and 5G-XR AS are initially considered Data Network (DN) functions and communicate with the UE via N6, N3 and Uu as defined in 3GPP TS 23.501 [23].
Communication through sidelink PC5 may be an alternative to Uu based communication.
Functions in trusted DNs are trusted by the operator’s network as illustrated.. Therefore, AFs in trusted DNs may directly communicate with all 5G Core functions.
Functions in external DNs may only communicate with 5G Core functions via the NEF using N33.
Figure 4.3.2-1: 5G-XR functions integrated in 5G System
NOTE 1: The functions indicated by the yellow filled boxes are in potential scope of stage 3 specifications for 5G-XR. The functions indicated by the grey boxes are defined in 5G System specifications. The functions indicated by the blue boxes are assigned to the applications.
The above architecture is used as a starting point. With XR related functions exclusively assigned to either DN or UE. However, architectural extensions may be identified for the 3GPP system that may benefit from XR applications. Examples include the use of network slicing, edge computing or usage of 5G quality of service.
Figure 4.3.2-2: 5G-XR Interfaces and Architecture
A basic XR architecture integrated in 5G is shown in Figure 4.3.2-2.
The following functions may be considered to be defined:
-	5G-XR Client on UE: Receiver of 5G-XR session data that may be accessed through well-defined interfaces/APIs by the 5G-XR Aware Application.
-	The 5G-XR Client contains two sub-functions
-	XR Session Handler: A function of the UE that communicates with the 5G-XR AF in order to establish, control and support the delivery of an XR session. The XR Session Handler exposes APIs that can be used by the 5G-XR Aware Application.
-	XR Engine: A function of the UE that communicates with the 5G-XR Application Server in order to get access to XR related data, includes XR relevant functionalities such as sensors and tracking, processes this data and communicates with the XR Session Handler for XR session control.
-	5G-XR Aware Application: The 5G-XR Client is typically controlled by an external XR aware application, e.g. an App, which implements the external application service provider specific logic and enables establishing an XR session. The 5G-XR Aware Application makes use of 5G-XR Client and network functions using interfaces and APIs.
-	5G-XR AS: An Application Server which hosts 5G-XR media and media functions.
-	5G-XR Application Provider: External XR application provider that makes use of 5G-XR client and network functionalities to provide an XR experience to the 5G-XR Aware applications.
-	5G-XR AF: provides various control functions to the XR Session Handler on the UE and/or to the 5G-XR Application Provider. It may relay or initiate a request for different Policy or Charging Function (PCF) treatment or interact with other network functions.
In the context of the above, 5G radio may also be differentiated between 5G Uu and 5G Sidelink/PC5. Uu is the interface between User Equipement (UE) and Radio Access Network (RAN) as defined in 3GPP TS 38.300 [24]. Sidelink is a mode of communication whereby UEs can communicate with each other directly as defined in 3GPP TS 38.300 [24].",TR 26.928,4.3.2,all_images/image_815.png,5G-XR functions integrated in 5G System
"XR engines provide a middleware that abstracts hardware and software functionalities for developers of XR applications. In the market as understood when initially writing this report, such engines are predominantly based on proprietary and commercial solutions, but with a trend towards providing standardized abstraction layers and APIs, notably provided by Khronos' OpenXR [16] as well as W3C's WebXR [17]. An overview of the landscape as seen by the OpenXR community is shown in Figure 4.4.1-1.
Figure 4.4.1-1: XR engine and ecosystem landscape today and in the future as seen by OpenXR © Khronos
An XR engine is a software-development environment designed for people to build XR experiences such as games and other XR applications. The core functionality typically provided by XR engines include a rendering engine (""renderer"") for 2D or 3D graphics, a physics engine or collision detection (and collision response), sound, scripting, animation, artificial intelligence, networking, streaming, memory management, threading, localization support, scene graph, and may include video support.
Typical components are summarized below
Rendering engine: This engine basically provides the functionalities as documented in clause 4.2.2 with a set of well defined APIs. In summary, the rendering engine generates animated 3D graphics by any of a number of methods (rasterization, ray-tracing etc.). Instead of being programmed and compiled to be executed on the CPU or GPU directly, most often rendering engines are built upon one or multiple rendering application programming interfaces (APIs), such as Direct3D, OpenGL, or Vulkan which provide a software abstraction of the graphics processing unit (GPU).
Audio engine: The audio engine is the component which consists of algorithms related to the loading, modifying and output of sound through the client's speaker system.  At a minimum it is able to load, decompress and play sound files. More advanced audio engines can calculate and produce such configurations as Doppler effects, echoes, pitch/amplitude adjustments, oscillation, etc. The audio engine can perform calculations on the CPU, or on a dedicated ASIC. Abstraction APIs, such as OpenAL, SDL audio, XAudio 2, Web Audio, etc. are available.
Physics engine: The physics engine is responsible for emulating the laws of physics realistically within the XR application. Specifically, it provides a set of functions for simulating physical forces and collisions, acting on the various objects within the scene at run time.
Artificial intelligence (AI): AI is usually outsourced from the main XR engine into a special module. XR applications may implement very different AI systems, and thus, AI is considered to be specific to the particular XR application for which it is created.
One of the major game engines used to create several notable games such as Fortnite ™, PlayerUnknown's Battlegrounds ™, and Life is Strange 2 ™, is the Unreal Engine 4 ™. Another game engine with significant share is the Unity ™ engine. This engine is the one behind games such as Rust ™, Subnautica ™, and Life is Strange Before the Storm ™. Unity™ is a cross-platform XR engine developed by Unity Technologies, first announced and released in June 2005. A component of Unity are scriptable rendering pipelines for developers to create high-end graphics including high-end ones for consoles and PC experiences, as well as the lightweight ones for mobile, virtual reality, augmented reality, and mixed reality.
The Unreal Engine was first showcased in the 1998 first-person shooter game Unreal. Although initially developed for first-person shooters, it is used in a variety of other genres, including platformers, fighting games, MMORPGs, and other RPGs.
Figure 4.4.1-2 provides an overview of typical CPU and GPU operations for XR applications.
Figure 4.4.1-2: CPU and GPU operations for XR applications
As mentioned above, key aspects of such XR engines and abstraction layers is the integration of advanced functionalities for new XR experiences including video, sound, scripting, networking, streaming, localization support, and scene graphs. By well-defined APIs, XR engines may also be distributed, where part of the functionality is hosted in the network on an XR Server and other parts of the functionality are carried out in the XR device.
GPU operations and rendering is dealt with in clause 4.4.2.
In the remainder of this Technical Report, the term XR engine is used to provide any type of typical XR functionalities as mentioned above. A key issue is the functional integration of potentially 3GPP defined technologies, including well defined APIs and interfaces for the usability and benefit of XR application developers.",TR 26.928,4.4.1,all_images/image_817.jpeg,XR engine and ecosystem landscape today and in the future as seen by OpenXR © Khronos
"XR engines provide a middleware that abstracts hardware and software functionalities for developers of XR applications. In the market as understood when initially writing this report, such engines are predominantly based on proprietary and commercial solutions, but with a trend towards providing standardized abstraction layers and APIs, notably provided by Khronos' OpenXR [16] as well as W3C's WebXR [17]. An overview of the landscape as seen by the OpenXR community is shown in Figure 4.4.1-1.
Figure 4.4.1-1: XR engine and ecosystem landscape today and in the future as seen by OpenXR © Khronos
An XR engine is a software-development environment designed for people to build XR experiences such as games and other XR applications. The core functionality typically provided by XR engines include a rendering engine (""renderer"") for 2D or 3D graphics, a physics engine or collision detection (and collision response), sound, scripting, animation, artificial intelligence, networking, streaming, memory management, threading, localization support, scene graph, and may include video support.
Typical components are summarized below
Rendering engine: This engine basically provides the functionalities as documented in clause 4.2.2 with a set of well defined APIs. In summary, the rendering engine generates animated 3D graphics by any of a number of methods (rasterization, ray-tracing etc.). Instead of being programmed and compiled to be executed on the CPU or GPU directly, most often rendering engines are built upon one or multiple rendering application programming interfaces (APIs), such as Direct3D, OpenGL, or Vulkan which provide a software abstraction of the graphics processing unit (GPU).
Audio engine: The audio engine is the component which consists of algorithms related to the loading, modifying and output of sound through the client's speaker system.  At a minimum it is able to load, decompress and play sound files. More advanced audio engines can calculate and produce such configurations as Doppler effects, echoes, pitch/amplitude adjustments, oscillation, etc. The audio engine can perform calculations on the CPU, or on a dedicated ASIC. Abstraction APIs, such as OpenAL, SDL audio, XAudio 2, Web Audio, etc. are available.
Physics engine: The physics engine is responsible for emulating the laws of physics realistically within the XR application. Specifically, it provides a set of functions for simulating physical forces and collisions, acting on the various objects within the scene at run time.
Artificial intelligence (AI): AI is usually outsourced from the main XR engine into a special module. XR applications may implement very different AI systems, and thus, AI is considered to be specific to the particular XR application for which it is created.
One of the major game engines used to create several notable games such as Fortnite ™, PlayerUnknown's Battlegrounds ™, and Life is Strange 2 ™, is the Unreal Engine 4 ™. Another game engine with significant share is the Unity ™ engine. This engine is the one behind games such as Rust ™, Subnautica ™, and Life is Strange Before the Storm ™. Unity™ is a cross-platform XR engine developed by Unity Technologies, first announced and released in June 2005. A component of Unity are scriptable rendering pipelines for developers to create high-end graphics including high-end ones for consoles and PC experiences, as well as the lightweight ones for mobile, virtual reality, augmented reality, and mixed reality.
The Unreal Engine was first showcased in the 1998 first-person shooter game Unreal. Although initially developed for first-person shooters, it is used in a variety of other genres, including platformers, fighting games, MMORPGs, and other RPGs.
Figure 4.4.1-2 provides an overview of typical CPU and GPU operations for XR applications.
Figure 4.4.1-2: CPU and GPU operations for XR applications
As mentioned above, key aspects of such XR engines and abstraction layers is the integration of advanced functionalities for new XR experiences including video, sound, scripting, networking, streaming, localization support, and scene graphs. By well-defined APIs, XR engines may also be distributed, where part of the functionality is hosted in the network on an XR Server and other parts of the functionality are carried out in the XR device.
GPU operations and rendering is dealt with in clause 4.4.2.
In the remainder of this Technical Report, the term XR engine is used to provide any type of typical XR functionalities as mentioned above. A key issue is the functional integration of potentially 3GPP defined technologies, including well defined APIs and interfaces for the usability and benefit of XR application developers.",TR 26.928,4.4.1,all_images/image_818.jpeg,CPU and GPU operations for XR applications
,TR 26.928,4.6.2,all_images/image_819.jpeg,Examples of Spherical to 2D mappings
,TR 26.928,4.6.7,all_images/image_821.jpeg,Example of a capture and production facility for Point Cloud/ 3D meshes
,TR 26.928,4.6.7,all_images/image_822.jpeg,Example of the 32 images captured simultaneously at one time instance in a studio
,TR 26.928,4.6.7,all_images/image_824.jpeg,Example of a dense depth map calculated per frame for each stereo camera pair
,TR 26.928,6.2.5,all_images/image_831.png,Split Rendering with Asynchronous Time Warping (ATW) Correction
"This clause defines setPacketServiceClassFilter() call.
While an MAA is actively registered with the MBMS client to consume MBMS Packet Delivery services, the MAA can call the setPacketServiceClassFilter() API to update the list of service classes the MAA wants to be registered with, see figure 6.4.3.5.1-1.
Figure 6.4.3.5.1-1: Sequence diagram for updating the registered service classes for an MAA",TS 26.347,6.4.3.5.1,all_images/image_838.jpeg,Sequence diagram for updating the registered service classes for an MAA
"This clause defines startPacketService() API.
After the MBMS Packet Delivery Service registration, the MAA can make calls on the startPacketService() API for the MBMS client to start reception of content received over broadcast, as shown in Figure 6.4.3.7.1-1.
Figure 6.4.3.7.1-1: MAA starts MBMS Packet Delivery services",TS 26.347,6.4.3.7.1,all_images/image_839.jpeg,MAA starts MBMS Packet Delivery services
,TS 26.347,6.4,all_images/image_840.jpeg,Signaling that a MBMS Packet Delivery service stalled
,TS 26.347,6.4,all_images/image_841.jpeg,Signaling errors with the startPacketService() request from the Packet-over-MBMS
,TS 26.347,6.4,all_images/image_842.jpeg,Signaling errors with the stopPacketService() request from the Packet-over-MBMS
"In the following, it is assumed that the Media Session Handler for downlink media streaming adheres to a basic set of functionalities as shown in Figure 12.2.1-1.
Figure 12.2.1-1: Usage of M6d in Media Downlink Streaming
The Media Session Handler is considered to run as a service in the background, and is invoked for a media session once a media player in the 5GMSd streaming client is activated with an MPD URL of media MIME type ""application/dash+xml"". Based on the MPD URL, the Media Session Handler may initiate communication with the 5GMSd AF through M5d.
NOTE:	The initiation of the Media Session Handler for other media types than DASH is for further study.
For an ongoing 5G Media Streaming session, the Media Session Handler is given the following authorizations:
1)	The ability to do status query on M7d. For details see clause 13.
2)	The ability to process notifications and error on M7d. For details see clause 13.
3)	The ability to configure certain parameters on the media player based on M7d. For details again see clause 13.
In addition, the MSH can provide information on M6d to the application and possibly delegated to Media Player using M6d for each of the Media Session Handler functionalities, namely providing:
1)	Notification and Error Events;
2)	Status Information.",TS 26.512,12.2.1,all_images/image_845.png,Usage of M6d in Media Downlink Streaming
"The MBMS User Service enables applications. It presents a complete service offering to the end-user and allows the end-user to activate or deactivate the service. For example, a DASH-over-MBMS could use the download delivery method to deliver content to MBMS subscribers. MBMS User service interfaces to the MBMS System via the BM-SC, GGSN (for GPRS) or MBMS GW (for EPS), and the UE, as depicted in Figure 4.2.2.3-1.
Figure 4.2.2.3-1: MBMS network architecture model for EPS
MBMS User Service procedures and protocols, including User Service Discovery/Announcement, User Service Initiation/Termination, and MBMS Data Transfer Procedure are specified in clause 5 of TS 26.346 [16].
MBMS User Services as defined in TS 26.346 [16] have been evolved over several releases. In particular, the following functionalities had been introduced to support different functionalities:
-	DASH-over-MBMS.
-	Generic Application Service to support HLS over MBMS as well as hybrid DASH/HLS over MBMS.
-	Service continuity to support reception of MBMS user services over unicast for different purposes.
-	Associated Delivery Procedures to support different functionalities such as file repair, consumption reporting, QoE reporting, etc.
-	Different service announcement modes.
-	MBMS Operation on Demand.
Relevant deployment profiles had been collected in Annex L in the document for service announcement, download delivery, and transparent delivery.",TR 26.802,4.2.2.3,all_images/image_850.jpeg,MBMS network architecture model for EPS
"3GPP SA2 workgroup has been exploring potential solutions to enhance 5G multicast-broadcast functionalities in TR 23.757 [7]. This 5MBS study item was completed in March 2021, except for those aspects with RAN2 decisions needed. This clause reviews the SA2 working group’s activities on enhanced 5G multicast-broadcast architecture from TR 23.757 [7].
The goal of the SA2 5MBS study is to identify and evaluate potential enhancements to the 5G system architecture to provide multicast-broadcast services that might be used for different vertical businesses. How to use the provisioned capabilities in a specific service type is out of the scope of SA2 5MBS study. The objectives are:
	Define the framework, including the functional split between (R)AN and CN, to support multicast/broadcast services, e.g. ad hoc multicast/broadcast streams, transparent IPv4/IPv6 multicast delivery, IPTV, software delivery over wireless, group communications and broadcast/multicast IoT applications, V2X applications, public safety.
	Support for different levels of services (e.g., transport only mode vs. full service mode).
	Enable flexible (i.e., distributed vs. centralized) network deployment and operation (e.g. separation of the control plane and user plane).
	Address whether and how relevant QoS and PCC rules apply to multicast/broadcast services.
	Support use cases and requirements (e.g. service continuity) for public safety, identified in SA1 and SA6 specifications (e.g., TS 22.179 and TS 22.280).
In the SA2 study, only NR or NG-RAN is considered as a wireless access technology. Support for UEs using or moving to an access network not supporting multicast/broadcast should be considered. The impact on RAN is to be analysed by and coordinated with the relevant RAN WGs. Currently, about 46 solutions are focusing on the following key issues:
1.	MBS Session Management.
2.	Definition of Service Levels.
3.	Levels of authorization for Multicast communication services.
4.	QoS level support for Multicast and Broadcast communication services.
5.	Support for Broadcast TV Video and Radio communication services. (Not within Release 17.)
6.	Local MBS service.
7.	Reliable delivery method switching between unicast and multicast.
8.	Reliable switching between unicast and broadcast delivery methods. (Not within Release 17.)
9.	Minimizing the interruption of public safety services upon transition between NR/5GC and E-UTRAN/EPC.
The study assumes the sequence to establish and deliver a Multicast Broadcast (MBS) session is as follows:
1.	Optional delivery of 5G MBS service information from application/service layer to 5GC.
2.	UEs participate in receiving MBS flow, i.e. UE requests to join an MBS session (for Multicast Session).
3.	Establishment of MBS flow transport. This step may happen before step 2 for individual UEs joining an MBS session which is already started.
4.	MBS data delivery to UEs.
5.	UEs stop receiving MBS flow (for Multicast Session).
6.	Release of MBS flow transport (what used to be session stop).
Multiple delivery methods may be used to deliver MBS traffic in the 5GS from a single data source to multiple UEs. TR 23.757 [7] further described delivery methods in 5G CN and RAN. Two delivery methods are possible from the 5G Core Network’s point of view:
-	5GC Individual MBS traffic delivery method: 5G CN receives a single copy of MBS data packets and delivers separate copies of those MBS data packets to individual UEs via per-UE PDU sessions.
-	5GC Shared MBS traffic delivery method: 5G CN receives a single copy of MBS data packets and delivers a single copy of those MBS packets packet to a RAN node, which then delivers them to one or multiple UEs.
NOTE 1:	The Shared MBS traffic delivery method and Individual MBS traffic delivery method are defined in SA2 WG and are listed here for reference only.
From the RAN’s point of view, in the case of the shared delivery, two delivery methods are available for the transmission of MBS packet flows over the radio interface:
-	Point-to-Point (PTP) delivery method: a RAN node delivers separate copies of MBS data packet over radio to individual UE.
-	Point-to-Multipoint (PTM) delivery method: a RAN node delivers a single copy of MBS data packets over radio to a set of UEs.
A RAN node may use any combination of the PTP/PTM delivery methods to deliver an MBS packet to a population of UEs. As shown in Figure 4.2.3-1, reproduced from TR 23.757 for the convenience of discussion, the Shared PTP or PTM delivery method and Individual delivery method may be used at the same time for a 5G MBS session.
NOTE 2:	The PTP and PTM delivery methods are defined in RAN WG and are listed here for reference only.
Figure 4.2.3-1: Overview of User Plane for a multicast session
A set of interim requirements for 5G MBS session management are agreed in TR 23.757 [7]:
-	For multicast solutions, signalling from the UE to the network to join a multicast session should be supported by UE and network. Join/leave operation via Control Plane (NAS) signalling should be supported.
-	For N3 transport of the shared delivery method, GTP-U tunnelling using a transport layer IP multicast method and shared N3 (GTP-U) Point-to-Point tunnel should be supported with support for QoS.
-	Both 5GC Shared MBS traffic delivery method and 5GC Individual MBS traffic delivery method should be standardized for multicast data delivery.
-	The network should be able to prepare and start the multicast traffic transmission for an MBS session after MBS service is started.
-	The network should support the selection of MB-SMF or SMF (depending on solution) at session join.
-	For N3 transport of the 5GC shared MBS delivery method, and for unicast transport, there should be 1-1 mapping between MBS Session and GTP-U tunnel towards a RAN node. And for multicast transport, there should be 1-1 mapping between MBS Session and the GTP-U tunnel.
A reference architecture is provided in Annex A.3 of [7], reproduced as Figure 4.2.3-2 here:
Figure 4.2.3-2: 5G MBS Reference Architecture from TR 23.757
The MBSF performs the following functions:
-	Service level functionality to support MBS and interworking with LTE MBMS.
-	Interacting with AF and MB-SMF for MBS session operations and transport.
-	Selection of MB-SMF for MBS Session.
-	Controlling the MBSTF (if it is used).
The MBSTF performs the following functions:
-	Modification of encoding of MBS data.
-	Media anchor for MBS data traffic if needed.
NOTE 3:	The MBSF and the MBSTF may be co-located or deployed separately.",TR 26.802,4.2.3,all_images/image_853.jpeg,Overview of User Plane for a multicast session
"3GPP SA2 workgroup has been exploring potential solutions to enhance 5G multicast-broadcast functionalities in TR 23.757 [7]. This 5MBS study item was completed in March 2021, except for those aspects with RAN2 decisions needed. This clause reviews the SA2 working group’s activities on enhanced 5G multicast-broadcast architecture from TR 23.757 [7].
The goal of the SA2 5MBS study is to identify and evaluate potential enhancements to the 5G system architecture to provide multicast-broadcast services that might be used for different vertical businesses. How to use the provisioned capabilities in a specific service type is out of the scope of SA2 5MBS study. The objectives are:
	Define the framework, including the functional split between (R)AN and CN, to support multicast/broadcast services, e.g. ad hoc multicast/broadcast streams, transparent IPv4/IPv6 multicast delivery, IPTV, software delivery over wireless, group communications and broadcast/multicast IoT applications, V2X applications, public safety.
	Support for different levels of services (e.g., transport only mode vs. full service mode).
	Enable flexible (i.e., distributed vs. centralized) network deployment and operation (e.g. separation of the control plane and user plane).
	Address whether and how relevant QoS and PCC rules apply to multicast/broadcast services.
	Support use cases and requirements (e.g. service continuity) for public safety, identified in SA1 and SA6 specifications (e.g., TS 22.179 and TS 22.280).
In the SA2 study, only NR or NG-RAN is considered as a wireless access technology. Support for UEs using or moving to an access network not supporting multicast/broadcast should be considered. The impact on RAN is to be analysed by and coordinated with the relevant RAN WGs. Currently, about 46 solutions are focusing on the following key issues:
1.	MBS Session Management.
2.	Definition of Service Levels.
3.	Levels of authorization for Multicast communication services.
4.	QoS level support for Multicast and Broadcast communication services.
5.	Support for Broadcast TV Video and Radio communication services. (Not within Release 17.)
6.	Local MBS service.
7.	Reliable delivery method switching between unicast and multicast.
8.	Reliable switching between unicast and broadcast delivery methods. (Not within Release 17.)
9.	Minimizing the interruption of public safety services upon transition between NR/5GC and E-UTRAN/EPC.
The study assumes the sequence to establish and deliver a Multicast Broadcast (MBS) session is as follows:
1.	Optional delivery of 5G MBS service information from application/service layer to 5GC.
2.	UEs participate in receiving MBS flow, i.e. UE requests to join an MBS session (for Multicast Session).
3.	Establishment of MBS flow transport. This step may happen before step 2 for individual UEs joining an MBS session which is already started.
4.	MBS data delivery to UEs.
5.	UEs stop receiving MBS flow (for Multicast Session).
6.	Release of MBS flow transport (what used to be session stop).
Multiple delivery methods may be used to deliver MBS traffic in the 5GS from a single data source to multiple UEs. TR 23.757 [7] further described delivery methods in 5G CN and RAN. Two delivery methods are possible from the 5G Core Network’s point of view:
-	5GC Individual MBS traffic delivery method: 5G CN receives a single copy of MBS data packets and delivers separate copies of those MBS data packets to individual UEs via per-UE PDU sessions.
-	5GC Shared MBS traffic delivery method: 5G CN receives a single copy of MBS data packets and delivers a single copy of those MBS packets packet to a RAN node, which then delivers them to one or multiple UEs.
NOTE 1:	The Shared MBS traffic delivery method and Individual MBS traffic delivery method are defined in SA2 WG and are listed here for reference only.
From the RAN’s point of view, in the case of the shared delivery, two delivery methods are available for the transmission of MBS packet flows over the radio interface:
-	Point-to-Point (PTP) delivery method: a RAN node delivers separate copies of MBS data packet over radio to individual UE.
-	Point-to-Multipoint (PTM) delivery method: a RAN node delivers a single copy of MBS data packets over radio to a set of UEs.
A RAN node may use any combination of the PTP/PTM delivery methods to deliver an MBS packet to a population of UEs. As shown in Figure 4.2.3-1, reproduced from TR 23.757 for the convenience of discussion, the Shared PTP or PTM delivery method and Individual delivery method may be used at the same time for a 5G MBS session.
NOTE 2:	The PTP and PTM delivery methods are defined in RAN WG and are listed here for reference only.
Figure 4.2.3-1: Overview of User Plane for a multicast session
A set of interim requirements for 5G MBS session management are agreed in TR 23.757 [7]:
-	For multicast solutions, signalling from the UE to the network to join a multicast session should be supported by UE and network. Join/leave operation via Control Plane (NAS) signalling should be supported.
-	For N3 transport of the shared delivery method, GTP-U tunnelling using a transport layer IP multicast method and shared N3 (GTP-U) Point-to-Point tunnel should be supported with support for QoS.
-	Both 5GC Shared MBS traffic delivery method and 5GC Individual MBS traffic delivery method should be standardized for multicast data delivery.
-	The network should be able to prepare and start the multicast traffic transmission for an MBS session after MBS service is started.
-	The network should support the selection of MB-SMF or SMF (depending on solution) at session join.
-	For N3 transport of the 5GC shared MBS delivery method, and for unicast transport, there should be 1-1 mapping between MBS Session and GTP-U tunnel towards a RAN node. And for multicast transport, there should be 1-1 mapping between MBS Session and the GTP-U tunnel.
A reference architecture is provided in Annex A.3 of [7], reproduced as Figure 4.2.3-2 here:
Figure 4.2.3-2: 5G MBS Reference Architecture from TR 23.757
The MBSF performs the following functions:
-	Service level functionality to support MBS and interworking with LTE MBMS.
-	Interacting with AF and MB-SMF for MBS session operations and transport.
-	Selection of MB-SMF for MBS Session.
-	Controlling the MBSTF (if it is used).
The MBSTF performs the following functions:
-	Modification of encoding of MBS data.
-	Media anchor for MBS data traffic if needed.
NOTE 3:	The MBSF and the MBSTF may be co-located or deployed separately.",TR 26.802,4.2.3,all_images/image_854.jpeg,5G MBS Reference Architecture from TR 23.757
"Figure 4.4.5.2-1 provides an architecture for which 5MBS is used independently of 5GMS. Note that the network part may have different instantations and implementation models, and is hence is not fully documented.
Figure 4.4.5.2-1: 5MBS architecture independent of 5GMS
The key aspects of the client architecture are:
1.	The existence of a 5MBS client on the UE. This client is expected to have similar functionalities of an MBMS client as defined in TS 26.346 [21].
2.	An API from the 5MBS client to the MBSF for the purpose of 5MBS control plane and service handling referred to as interface MBS-5. It is expected that this API has similar functionalities to those of the User Service Description as defined in TS 26.346 [21].
3.	An interface between the 5MBS Client and the MBSTF for the purpose of 5MBS user data exchange at MBS-4. This interface includes:
-	MBS-4-MC dealing with unidirectional and multicast delivery from the MBSTF to the 5MBS client. It is expected that this interface has similar functionalities as defined in the delivery methods defined in TS 26.346 [21].
Editor’s Note: 	Whether or not the architecture requires an interface MBS-4-UC for bidirectional and unicast-based delivery between the 5MBS AS and the 5MBS Client, and how the 5MBS AS is configured, is for further study.
4.	An interface MBS-8 between the 5MBS Application Provider and the 5MBS Aware-Application in order to announce 5MBS services.
5.	An API-based interface MBS-6 exposed by the 5MBS Client and used by the 5MBS-Aware Application to manage and control 5MBS services. It is expected that this API has similar functionalities to the control interfaces defined in clause 6 of TS 26.347 [21].
6.	An API-based interface MBS-7 exposed by the 5MBS Client and used by the 5MBS-Aware Application to receive user data information about 5MBS services. It is expected that this API has similar functionalities as the data interfaces defined in clause 7 of TS 26.347 [21].
NOTE:	In the case where the 5MBS Client is deployed in a 5G Residential Gateway and the 5MBS-Aware Application is deployed in a separate end device, reference points MBS-6 and MBS-7 span the network interface between these devices.
A further decomposition of the above client architecture is provided in Figure 4.4.5.2-2 for which the 5MBS Client is separated into two components, namely:
-	An MBSF Client communicating with the MBSF function and predominantly dealing with user service description aspects. This function exposes the aforementioned MBS-6 API.
-	An MBSTF Client communicating with the MBSTF function for delivery functions. This function exposes the aforementioned MBS-7 API.
Figure 4.4.5.2-2: Extended 5MBS architecture independent of 5GMS
Two new APIs are introduced, namely:
-	MBS-6′ that predominantly provides an API to control and manage the delivery functions of the MBSTF Client.
-	MBS-7′ that provides information logically assigned to MBS-5 delivery (user service information) through MBS-7′.
Some open question remain on details (see also clause 5.6 key issues):
-	Are there deployments that do not require an MBSF Client and hence, MBS-6′ is directly exposed to the 5MBS defined application.
-	Are there deployments for which no unicast is used? In this case MBS-5 is completely served through MBS-7′.
-	Is it useful to separate the MBSTF Client into a multicast delivery and a unicast delivery component?
-	On the MBS-4-UC requests, which unicast requests are proxied through 5MBS, for example to detect consumption, and which are served through M8?
NOTE:	The 5MBS-Aware Application itself may be a media function and may include a media player, independently of the 5GMS architecture.",TR 26.802,4.4.5.2,all_images/image_857.png,Extended 5MBS architecture independent of 5GMS
"Based on the architectures in clause 4.4.5.2, the 5GMS Client can be viewed as a 5MBS-Aware Application and the 5GMS-Aware Application is basically unaware of 5MBS usage. The network aspects are again not detailed here: it is assumed that MBSF and MBSTF exist.
Figure 4.4.5.3-1: Combined 5GMS and MBS client architecture (option A)
In this case:
-	The Media Session Handler, based on information via M6 and M5, identifies the existence of a 5GMS service that is available through 5MBS and uses this information to:
-	Initialize and control the 5MBS through MBS-6.
-	Initialize the Media Player through M7, to the extent that MBS-7 is used for service delivery.
-	The Media Player, based on static and dynamic information from the 5MSB client uses MBS-7 and/or M4 for receiving media.
Some open question remain on details (see also clause 5.6 key issues):
-	Where is the manifest served from, through MBS-7, through M4, both, or either?
-	How different deployment scenarios in terms of hybrid, MooD, can be realized?",TR 26.802,4.4.5.3,all_images/image_858.png,Combined 5GMS and MBS client architecture (option A)
"The alternative client architecture depicted in Figure 4.4.5.4-1 below combines the 5GMS architecture with that of 5MBS. It differs from Figure 4.4.5.3-1 in the use of an additional core function, the 5MBS AS, to terminate unicast file repair requests from the 5MBS Client at reference point MBS-4-UC. The interface at this reference point is technically identical to that at M4, i.e. unicast HTTP. The Media Player continues to use reference point M4 for non-5MBS media retrieval from the 5GMS AS.
Figure 4.4.5.4-1: Combined 5GMS and MBS client architecture (option B)
In practical deployments that combine 5G Media Streaming with 5MBS, the MBSF is likely to be co-located with the 5GMS AF, as described in clause 4.4.1 of the present document. In addition, the 5MBS AS is likely to be co-located with the 5GMS AS in such deployments because the two functions share a high degree of commonality. Figure 4.4.5.4-2 below illustrates this likely deployment architecture.
Figure 4.4.5.4-2: Combined 5GMS and MBS client architecture (option B) depicting likely co-location
In both of the above figures, the 5MBS AS exposes an interface at reference point MBS-4-UC that is technically identical to M4, and which is potentially useful to the 5MBS Client in at least the following contexts:
1.	Fast 5GMS session start-up via unicast while the 5MBS Client is waiting for initial multicast/broadcast packets to start arriving via MBS-4.
2.	Unicast recovery of the application payload data carried in multicast/broadcast packets that are not successfully received via MBS-4, in a manner that is transparent to the 5GMS Client.
3.	5GMS session continuity when multicast/broadcast service is temporarily unavailable, in a manner that is transparent to the 5GMS Client.
4.	Switching the operating mode of a 5GMS session to unicast under the direction of network-based multicast operation on demand (MooD), in a manner that is transparent to the 5GMS Client.
Relevant issues to be studied include:
-	How the 5MBS AS is configured.
-	Shared use of a single PDU Session by M4 and MBS-4-UC. (The solution to this may be trivial.)
-	Whether the presentation manifest is delivered via M4 or MBS-7.
-	How different deployment scenarios such as hybrid operation and MooD are realised.",TR 26.802,4.4.5.4,all_images/image_859.png,Combined 5GMS and MBS client architecture (option B)
"The model in Figure 5.3.1.2-1 below assumes that a FLUTE function according to MBMS Download Delivery (clause 7 in TS 26.346 [16]) is mapped into the MBSTF.
NOTE:	FLUTE is used in this clause for illustrative purposes to study the interface between a BM-SC control and user-plane. The reuse, evolution or replacement of this object delivery protocol in Release 17 should be studied in a separate Key Issue.
The purpose of this simplified model is to help identify the xMB-C parameters (xMB Service and Session Parameters) needed to configure an MBSTF at Nmb2.
Figure 5.3.1.2-1: Simplified User Plane model for FLUTE (as an MBSTF function)
The model depicts some key functions from an xMB-U ingest to an MB-UPF ingest (N6). In the case of 5MBS Download (e.g. used for DASH/HLS over MBMS or generic file delivery) the MBSTF operates as follows:
1.	The HTTP File Receiver is responsible for ingesting content resources intended for multicast transmission at xMB-U. It supports two basic content ingest modes:
a)	HTTP Pull, in which the MBSTF pulls resources from an upstream HTTP server, such as the 5GMSd AS. In this mode, the Nmb2 API is used to provide individual URLs to be downloaded.
b)	HTTP Push, in which resources are uploaded to the MBSTF by an upstream client using HTTP PUT. In this mode, the Nmb2 API is used to provide a base URL for ingesting data to the API invoker.
2.	The MBSTF may store partial or complete resources in a local File Cache prior to transmission at N6. Optimized implementations may pipe files through with only minimal buffering/caching.
3.	HTTP metadata such as Content-Location (resource URL), Content-Length (resource size), and Content-Type (MIME content type) is provided by the HTTP File Receiver to the FDT Instance creation function. This acts as input (with other Nmb2 parameters) to form the FDT Instance XML document.
4.	The File partitioning function segments resources (including FDT Instances) into one or more multicast packet payloads. In the case where a Forward Error Correction scheme such as Raptor FEC (RFC 5053 [23]) or Compact No-Code FEC (RFC 5445 [24]) is used, there are recommended schemes and parameters to partition a resource into a sequence of packet paylods (called encoding symbols).
5.	The Delivery object packetization function creates a sequence of IP packets (incl UDP and FLUTE packet headers) for the delivery object. It inserts FLUTE header parameters such as the TSI, sequence number (FEC Symbol ID according to No-Code FEC, RFC 3695 [25] or Raptor FEC, RFC 5053 [23]), etc. As result, a complete UDP packet payload is created, which can be written to a UDP socket at the appropriate time of transmission.
6.	Finally, the Streamer & Pacer function sends the multicast UDP packets according to a defined bit rate to the configured MP-UPF ingest point, which can be an MB2-U tunnel, some direct multicast, or similar.",TR 26.802,5.3.1.2,all_images/image_860.jpeg,Simplified User Plane model for FLUTE (as an MBSTF function)
"TS 26.346 [16] allows transmission of Service Announcement Metadata fragments in band with the session or out of band. Annex L.2.8 of [16] further defines handling of in-band fragments within the Service Announcement Channel (SACH) profile.
The usage of in-band fragments to update service announcement metadata fragments is specifically needed in cases of eMBMS-only transmissions, e.g. in areas of high receiver density or when offering services through a Shared MBMS Network (cf. TS 23.247, Clause 7.5). The usage of unicast is preferably avoided in areas of high receiver density to prevent congestion situations.
The service announcement for 5MBS User Services may evolve. In-band ancillary information is logically part of the 5MBS User Service announcement, and the information objects are sent in-band with the content stream using the same MBS Session. Only 5MBS Clients that have activated reception of the 5MBS Session will receive the in-band ancillary information.
In-band ancillary information objects are typically XML instance documents formatted as regular FLUTE transmission objects and received by the 5MBS Client. In-band ancillary information may be interleaved with other content objects, i.e. the BM-SC sends the packets comprising the in-band ancillary information interleaved with those comprising content object(s). In-band ancillary information may be repeated multiple times in carousel fashion to assist with unsynchronised acquisition by the MBMS Client. When repeating the transmission object corresponding to an in-band ancillary information object it is beneficial to keep the same FLUTE parameters, specifically the Transport Object Identifier (TOI), so that the FLUTE receiver in the 5MBS Client can efficiently detect and ignore repetitions.
The model in Figure 5.3.1.3-1 below extends the FLUTE model from clause 5.3.1.2 to include in-band ancillary information. The in-band-related functions are depicted in green; blue components are identical to those in Figure 5.3.1.2-1.
Figure 5.3.1.3-1: In-band ancillary information related functions (in green) of an MBSTF
Two categories of in-band ancillary information objects are considered in the context of 5MBS:
1:	5MBS Delivery function related, i.e. sending ancillary information objects (in band) to the 5MBS Client, such as file repair configuration information.
2:	5MBS User Service function related, i.e. sending ancillary information objects (in band) to an application component behind the 5MBS Client, such as a Media Player.
The model adds in-band ancillary information related functions to the user plane model:
1.	The Ingest function is responsible for receiving the control object for in-band delivery. It may support push- or pull-based ingest (similar to xMB-U). Alternatively, in-band ancillary information may be embedded in an Nmb2 control payload, e.g. using Base64 encoding. The control object is typically an XML instance doucment.
2.	The Partitioning, packetization and FDT Instance Creation function is converting the ingested control object into a sequence of FLUTE packets, including the corresponding FDT Instance object. In-band control objects are identified in the FDT Instance by a distinct MIME content type.
3.	The Cache function is used to retain a copy of the packetised control object for repetitions.
4.	The In-band ancillary information insertion function interleaves the in-band control object packets with those of other user plane objects.",TR 26.802,5.3.1.3,all_images/image_861.jpeg,In-band ancillary information related functions (in green) of an MBSTF
"The model in Figure 5.3.1.6-1 below assumes that the BM-SC FEC encoding function according to Group Communication Delivery Method (Clause 8A in TS 26.346 [16]) is mapped into the MBSTF. According to TR 23.757 [7], the MBSTF exposes an MB2-U interface, which should be used (only?) when FEC needs to be added to Group Communication. When no FEC is needed, the GCS AS may directly send the traffic to the MB-UPF using N6.
The purpose of this simplified model is to help identify the MB2-C parameters needed to configure an MBSTF at Nmb2. The function “FEC Payload creation” generates a new RTP flow carrying the FEC redundancy information to protect one or more RTP media flows.
Figure 5.3.1.6-1: Simplified User Plane model for Group Communication Delivery with FEC
(as an MBSTF function)
The model depicts some key functions from an MB2-U ingest to an MB-UPF ingest (N6). In the case of Group Communication Delivery the MBSTF operates as follows:
1.	The MB2-U Receiver is responsible for receiving the MB2-U packets. The IP multicast user plane packets are encapsulated into the MB2-U packets. The MB2-U receiver may duplicate the packets so that the original packet can be passed through to the output and the copy remains in the Packet Cache for FEC source block creation.
2.	The RTP Passthrough passes the source packets directly to the output.
Editor’s Note: It is ffs, whether the RTP Passthough function appends FEC information (like a source block id), without modifying the original parts.
3.	FEC Payload Creation calculates the FEC redundancy information which is then carried as a separate RTP flow to the receiver.
4.	RTP packet creation prepends RTP header fields to the payloads of the FEC flow.
5.	The Streamer & Pacer ensures a smooth output bit rate according to the configured Guaranteed Bit Rate.
NOTE:	Since FEC redundancy is added to the stream, the output bit rate is higher than the input bit rate.
When a GCS AS activates an MB2 session with FEC, the GCS AS provides the following information to the BM-SC:
-	FEC configuration information (see clause 6.4.27 of TS 29.468 [18]). A list of the FEC Framework configuration information according to clause 8A.5 of TS 26.346 [16] is depicted in Figure 5.3.1.5-2 below.
Figure 5.3.1.6-2: FEC Framework configuration information according to TS 26.346 Clause 8A.5
As response, the GCS AS receives the MB2-U tunnel endpoint information (i.e. the BM-SC Address AVP and BM-SC Port AVP).
When the BM-SC is split into MBSF and MBSTF, the MBSF interacts with the MB-SMF in order to obtain the N6 ingest parameters for the MB-UPF. The MBSF provides the FEC framework configuration information together with the MB-UPF N6 ingest information to the MBSTF via Nmb2. The MBSTF allocates the MB2-U tunnel endpoint information and passes the MB2-U ingest information back to the MBSF.
The MBSF may pass the FEC Framework configuration information to the MBSTF as an Octet Stream (see clause 6.4.27 of TS 29.468 [18]) so that the MBSTF parses the SDP information.",TR 26.802,5.3.1.6,all_images/image_862.jpeg,Simplified User Plane model for Group Communication Delivery with FEC
"The model in Figure 5.3.1.6-1 below assumes that the BM-SC FEC encoding function according to Group Communication Delivery Method (Clause 8A in TS 26.346 [16]) is mapped into the MBSTF. According to TR 23.757 [7], the MBSTF exposes an MB2-U interface, which should be used (only?) when FEC needs to be added to Group Communication. When no FEC is needed, the GCS AS may directly send the traffic to the MB-UPF using N6.
The purpose of this simplified model is to help identify the MB2-C parameters needed to configure an MBSTF at Nmb2. The function “FEC Payload creation” generates a new RTP flow carrying the FEC redundancy information to protect one or more RTP media flows.
Figure 5.3.1.6-1: Simplified User Plane model for Group Communication Delivery with FEC
(as an MBSTF function)
The model depicts some key functions from an MB2-U ingest to an MB-UPF ingest (N6). In the case of Group Communication Delivery the MBSTF operates as follows:
1.	The MB2-U Receiver is responsible for receiving the MB2-U packets. The IP multicast user plane packets are encapsulated into the MB2-U packets. The MB2-U receiver may duplicate the packets so that the original packet can be passed through to the output and the copy remains in the Packet Cache for FEC source block creation.
2.	The RTP Passthrough passes the source packets directly to the output.
Editor’s Note: It is ffs, whether the RTP Passthough function appends FEC information (like a source block id), without modifying the original parts.
3.	FEC Payload Creation calculates the FEC redundancy information which is then carried as a separate RTP flow to the receiver.
4.	RTP packet creation prepends RTP header fields to the payloads of the FEC flow.
5.	The Streamer & Pacer ensures a smooth output bit rate according to the configured Guaranteed Bit Rate.
NOTE:	Since FEC redundancy is added to the stream, the output bit rate is higher than the input bit rate.
When a GCS AS activates an MB2 session with FEC, the GCS AS provides the following information to the BM-SC:
-	FEC configuration information (see clause 6.4.27 of TS 29.468 [18]). A list of the FEC Framework configuration information according to clause 8A.5 of TS 26.346 [16] is depicted in Figure 5.3.1.5-2 below.
Figure 5.3.1.6-2: FEC Framework configuration information according to TS 26.346 Clause 8A.5
As response, the GCS AS receives the MB2-U tunnel endpoint information (i.e. the BM-SC Address AVP and BM-SC Port AVP).
When the BM-SC is split into MBSF and MBSTF, the MBSF interacts with the MB-SMF in order to obtain the N6 ingest parameters for the MB-UPF. The MBSF provides the FEC framework configuration information together with the MB-UPF N6 ingest information to the MBSTF via Nmb2. The MBSTF allocates the MB2-U tunnel endpoint information and passes the MB2-U ingest information back to the MBSF.
The MBSF may pass the FEC Framework configuration information to the MBSTF as an Octet Stream (see clause 6.4.27 of TS 29.468 [18]) so that the MBSTF parses the SDP information.",TR 26.802,5.3.1.6,all_images/image_863.png,FEC Framework configuration information according to TS 26.346 Clause 8A.5
"Collaboration A depicts a deployment where all 5MBS and 5GMSd functions are deployed inside the trusted DN. Three different variants are depicted.
The 5GMSd AF and AS are responsible for unicast content distribution (e.g. CDN), i.e. M5d and M4d are exposed by the 5GMSd functions.
The MBSF and MBSTF functions are for 5MBS distribution. The MBSF is the control and interacts with the MB-SMF using Nmbsmf.
-	A0: The MBSF is integrated within the 5GMSd AF.
-	A1: Fully separated functions.
-	A2: Integrated control and user plane functions.
Collaboration A0 describes a model where the MBSF function is integrated into the 5GMSd AF and the MBSTF function is still standalone. Background here is that the user plane functions are more specialized, i.e. optimized HTTP servers for unicast and optimized multicast delivery functions for multicast. The 5GMSd AF uses the newly developed Nx2 API to configure and control the multicast delivery functions. The 5GMSd AS might be extended to cut-though any push ingest into the Nmbstf (former xMB-U).
Figure 5.4.2-1: Collaboration A0: MBSF integrated within the 5GMSd AF
Figure 5.4.2-2: Collaboration A1: Fully separated functions
Figure 5.4.2-3: Collaboration A2: Integrated Control and User Plane functions",TR 26.802,5.4.2,all_images/image_864.jpeg,Collaboration A0: MBSF integrated within the 5GMSd AF
"Collaboration A depicts a deployment where all 5MBS and 5GMSd functions are deployed inside the trusted DN. Three different variants are depicted.
The 5GMSd AF and AS are responsible for unicast content distribution (e.g. CDN), i.e. M5d and M4d are exposed by the 5GMSd functions.
The MBSF and MBSTF functions are for 5MBS distribution. The MBSF is the control and interacts with the MB-SMF using Nmbsmf.
-	A0: The MBSF is integrated within the 5GMSd AF.
-	A1: Fully separated functions.
-	A2: Integrated control and user plane functions.
Collaboration A0 describes a model where the MBSF function is integrated into the 5GMSd AF and the MBSTF function is still standalone. Background here is that the user plane functions are more specialized, i.e. optimized HTTP servers for unicast and optimized multicast delivery functions for multicast. The 5GMSd AF uses the newly developed Nx2 API to configure and control the multicast delivery functions. The 5GMSd AS might be extended to cut-though any push ingest into the Nmbstf (former xMB-U).
Figure 5.4.2-1: Collaboration A0: MBSF integrated within the 5GMSd AF
Figure 5.4.2-2: Collaboration A1: Fully separated functions
Figure 5.4.2-3: Collaboration A2: Integrated Control and User Plane functions",TR 26.802,5.4.2,all_images/image_866.jpeg,Collaboration A2: Integrated Control and User Plane functions
"Collaboration B depicts a mixed deployment where only the 5MBS related-functions are deployed in the trusted DN. Configuration B in Figure A.3.2-2 (TR 23.757) indicates that an external AF uses the NEF as control plane entry point. It is assumed that the Nmbsf interface (based on xMB-C) is passed through the NEF and that the NEF adds security-related functions transparently.
Like in Collaboration A (and C), the 5GMSd functions are used for unicast content distribution, e.g. CDN functionality for DASH streaming is in an external DN. The functions in the trusted DN are leveraged to prepare the content for 5MBS delivery. Here is it assumed that unicast functions such as unicast content reception (e.g. DASH) and features like file repair can be offered by the 5GMSd AS from the external DN.
Note that Collaboration B2 does not contain 5GMSA functions. This collaboration scenario is associated with Collaboration B because the MBSF and MBSTF functions are within the Trusted DN.
Also, for Collaboration B, three different variants are depicted:
-	B0: The MBSF is presented in the Trusted DN for service management.
-	B1: The MBSF is absent and only an MBSTF is used.
-	B2: Only 5MBS functions, without 5GMSA functions.
Figure 5.4.3-1: Collaboration B0: Mixed external and Trusted DN functions
Figure 5.4.3-2: Collaboration B1: Mixed external and trusted DN functions
Figure 5.4.3-3: Collaboration B2: Mixed external and trusted DN functions deployed without 5GMS functions",TR 26.802,5.4.3,all_images/image_868.jpeg,Collaboration B1: Mixed external and trusted DN functions
"Collaboration C depicts a deployment where all media related functions are deployed in an external DN and the 5G System offers only connectivity services, i.e. either unicast connectivity or 5MBS transport-only connectivity.
Figure 5.4.4-1: Collaboration C: All media functions in external DN
One could wonder why 3GPP should consider this deployment option. The consideration here is that a 5GMSd Client (including a new 5MBS Client) in the UE can still be leveraged as a multicast receiver, supporting reception of 3GPP-defined “DASH over 5MBS” generic file delivery and RTP streaming. An “MBSTF-like” function would generate a bit stream compliant with TS 26.346 [16]. An external Application Function (AF) may use Nmbsmf (via NEF) to activate a transport-only type of delivery into the MB-UPF (according to Configuration 1 in Figure A.3.2-2 of TR 23.757 [7]).",TR 26.802,5.4.4,all_images/image_870.jpeg,Collaboration C: All media functions in external DN
"Anchors provide a baseline that a tested method can be compared against. Anchors defined in this specification use a codec/profile/level that exists in an existing 3GPP specification as introduced in clause 4.
Anchor tuples are collected to address different qualities and bitrates that can then be used for evaluation over a larger set of operation points.
The following principles apply to anchor definitions:
-	Each scenario typically has several well-defined anchors
-	An anchor is a combination of:
-	Explanation on anchor relevance
-	Reference sequence
-	Reference encoder
-	Encoder configuration matching scenario requirements
-	Encoding complexity estimation, if available
-	Variable encoder configuration to create multiple quality/bitrate variants (using for example QP variations or other bitrate/quality evaluation tools).
-	Anchor tuples creating multiple variants, each including
-	Anchor bitstream
-	Anchor Metrics
-	Additional recommended anchor information includes
-	MD5 check sum of the complete reconstructed yuv file (anchor sequence)
-	Output picture log from reference encoder
-	Output picture log from reference decoder
Anchors and anchor tuples are an integral part of this document.
Anchor tuples should be created over a wide range of parameters to provide sufficient data and overlap with expected test results to support the generation of characterization results (see clause 5.7).
The workflow for the generation of anchor tuples is shown in Figure 5.3-1.
Figure 5.3-1: Anchor Tuple Generation Framework and Anchor Tuple Metrics Generation
Anchors are provided according to the format as defined in Annex B.3.",TR 26.955,5.3,all_images/image_873.png,Anchor Tuple Generation Framework and Anchor Tuple Metrics Generation
,TR 26.955,5.5.4,all_images/image_874.jpeg,"Multi-scale structural similarity measurement system (L: low-pass filter, 2↓:"
"For high dynamic range (HDR) sequences, the following Metrics as defined in clause 5.5.3 are used:
-	Peak-Signal to Noise Ratio PSNR(Y) of luma component as specified in [44],
-	Peak-Signal to Noise Ratio PSNR(Y) of chroma component U,
-	Peak-Signal to Noise Ratio PSNR(V) of chroma component V,
-	Average colour component PSNR, PSNR over all colour components PSNR.
In addition, a weighted Peak-Signal To Noise Ratio metric for each colour components wPSNR(c) is used, which aims to compensate for a different distribution of codewords in HDR content:
-	wPSNR(Y), wPSNR(U), wPSNR(V), as specified in [44] and [58],
-	Average colour component weighted PSNR, wPSNR over all colour components wPSNR.
In addition, HDR specific quality metrics are reported. For this purpose, the YUV sequences, both original reference sequence and reconstructed sequences are transformed first from YUV 4:2:0 to 4:4:4 and then to floating point RGB to obtain 32-bit EXR floating point representation. The output is then used in the next step to compute
-	PSNRL100, as specified in [44] and [58],
-	DE100, as specified in [44] and [58].
The basic approach to generate HDR metrics is shown in Figure 5.5.5-1.
Figure 5.5.5-1: Basic approach for HDR metrics generation
The exact definition for all HDR quality metrics is based on the software scripts as referenced in clause 5.5.8. A reporting scheme for HDR metrics is defined in clause 5.5.6.",TR 26.955,5.5.5,all_images/image_875.png,Basic approach for HDR metrics generation
"Tests may be executed to compare codecs not yet in 3GPP specifications against anchors already defined in 3GPP specification. Tests, equivalently to anchors, are collected in tuples to address different quality and bitrates that can then be used for evaluation over a larger set of operation points.
A test is developed against an anchor and is a combination of:
-	The corresponding anchor, which includes
-	Scenario
-	Reference Sequence
-	Test encoder
-	Test encoder configuration that provides an equivalent setting to the anchor configuration based on the general encoding constraints in clause 5.6.
-	Test tuples creating multiple variants, each including
-	Test bitstream
-	Test Metrics
-	Additional recommended test information includes
-	MD5 check sum of the complete reconstructed yuv file (reconstructed test sequence)
-	Output picture log for reference encoder
-	Output picture log for reference decoder
-	Tests are an integral part of the Technical Report
The generation of test tuples is shown in Figure 5.7-1.
Figure 5.7-1: Test Tuple Generation Framework and Test Tuple Metrics Generation
For any coding technology being characterized in the study and reported in this document
the evaluation is conducted consistently with the framework and test designs defined for the anchors as defined in clauses 5.5 and 6.
technical documentation to conduct the study is available and provided. Such information includes normative specification text, reference software and description of configuration files, and codec description.
additional data such as subjective test results (with description of test methodology and conditions) not conducted as part of this study item, encoding tool and configuration file description is also important information that could be provided",TR 26.955,5.7,all_images/image_876.jpeg,Test Tuple Generation Framework and Test Tuple Metrics Generation
"Figure 4.4-1 below shows the reference architecture for data collection and reporting in service-based architecture notation. It depicts the case where the Data Collection AF is deployed inside the trusted domain, while the Application Service Provider and the AS may be deployed independently either inside or outside the trusted domain.
NOTE 1:	In its role as an event exposure service provider Application Function, the Data Collection AF provides the (un)subscription operations of the Naf_EventExposure (or Nnef_EventExposure) service for use by Network Function service consumers. As Network Function service consumers, the NWDAF and the Event Consumer AF provide the event notification operation of the Naf_EventExposure (or Nnef_EventExposure) service for use by the Data Collection AF.
NOTE 2:	The UE-based Direct Data Collection Client interacts with the Data Collection AF in the user plane, and so the interaction at reference point R2 does not traverse the service bus.
Figure 4.4-1: Reference architecture for data collection and reporting in service-based architecture notation when the Data Collection AF is deployed in the trusted domain
The following service-based APIs are used in connection with data collection and reporting:
1. 	The Ndcaf_DataReportingProvisioning service is provided by the Data Collection AF. It is defined by the present document and is specified in TS 26.532 [7]. This service is used by Provisioning AF instances to provision data collection and reporting in the Data Collection AF.
2. The Nnrf_NFManagement service is provided by the NRF. It is defined in clause 5.2.7.2 of TS 23.502 [3] and specified in clause 6.1 of TS 29.510 [6]. This service is used by the Data Collection AF to register an available NF profile with the NRF for each set of data collection and reporting provisioning information held by the former.
NOTE 1:	As described in clause 6.2.8.2.2 of TS 23.288 [4] the NF profile in this case includes the External Application Identifier (used by clients when reporting data to the Data Collection AF), the Internal Application Identifier (used for event exposure to the NWDAF) and the Event ID. These NF profile parameters are in addition to those specified in clause 5.2.7.2 of TS 23.502 [3].
3.	The Ndcaf_DataReporting service is provided by the Data Collection AF. It is defined by the present document and is specified in TS 26.532 [7].
a.	This service is used by the Direct Data Collection Client, by the Indirect Data Collection Client in the Application Service Provider server and by AS instances to obtain their data collection and reporting configuration from the Data Collection AF.
b.	Subsequently, this service is used by the Direct Data Collection Client, by the Indirect Data Collection Client and by AS instances to send data reports to the Data Collection AF.
NOTE 2:	Trusted AS instances play the role of a Network Function when invoking the Ndcaf_DataReporting service (or equivalent) and are therefore depicted in figure 4.4-1 as being directly attached to the service bus.
4.	The Naf_EventExposure service is provided by the Data Collection AF. It is defined in clause 5.2.19.2 of TS 23.502 [3] and TS 23.288 [4], and is specified in TS 29.517 [5].
a.	Used by the NWDAF to subscribe to data reporting events exposed by the Data Collection AF and subsequently used by the Data Collection AF to notify these events to the NWDAF, as described in clause 6.2.2.2 or 6.2.2.3 (as appropriate) of TS 23.288 [4].
b.	Used by an Event Consumer AF in the Application Service Provider server to subscribe to data reporting events exposed by the Data Collection AF and subsequently used by the Data Collection AF to notify these events to the Application Service Provider server, as described in clause 6.2.2.2 or clause 6.2.2.3 (as appropriate) of TS 23.288 [4].
Figure 4.4-2 depicts the case where the Data Collection AF is instead deployed outside the trusted domain, along with the Application Service Provider and the (external) AS. In this case, the subfunctions of the Application Service Provider and the (external) AS do not interact with the Data Collection AF via the 5G System service bus. The Ndcaf service is therefore not required in such deployments. The interactions at the relevant reference points are outside the scope of 3GPP and are depicted as R1′, R3′, R4′ and R6′ to reflect this.
Figure 4.4-2: Reference architecture for data collection and reporting in service-based architecture notation when the Data Collection AF is deployed outside the trusted domain",TS 26.531,4.4,all_images/image_879.png,Reference architecture for data collection and reporting in service-based architecture
"This clause defines the high-level procedures for data collection and reporting.
Figure 5.1-1 below depicts the case where all functional entities lie inside the trusted domain. The detailed steps for each phase are further elaborated in the following clauses.
Figure 5.1-1: High-level procedures for data collection and reporting",TS 26.531,5.1,all_images/image_882.jpeg,High-level procedures for data collection and reporting
"Figure 5.2-1: High-level procedures for AF registration and provisioning phases
Initially, the different types of AF register themselves with the NRF using the Nnrf_NFManagement_NFRegister service operation defined in clause 5.2.7.2.2 of TS 23.502 [3]:
1.	The NWDAF registers itself with the NRF.
2.	The Data Collection AF registers itself with the NRF. This registration includes a list of Event IDs that it is capable of exposing to event consumers.
At some later point, Data Collection and Reporting features are provisioned by the Application Service Provider's Provisioning AF:
3.	The Provisioning AF discovers the Data Collection AF by following the Nnrf_NFDiscovery procedure defined in clause 5.2.7.3 of TS 23.502 [3].
4.	The Provisioning AF provisions data collection and reporting in the Data Collection AF for a specific Event ID, using the Ndcaf_DataReportingProvisioning procedures defined in the present document. The provisioning information may vary depending on the data reporting method, i.e. direct reporting or indirect reporting.",TS 26.531,5.2,all_images/image_883.jpeg,High-level procedures for AF registration and provisioning phases
"At some later point, one or more of the three types of data collection client obtain their configuration from the Data Collection AF by invoking the Ndcaf_DataReporting service defined in the present document and specified in TS 26.532 [7]. The intersection between the above provisioning information and current event consumer subscriptions determines the contents of this configuration.
Figure 5.4-1: High-level procedures for data collection client configuration phase
The steps are as follows:
9.	If present in the instantiation, the UE Application creates a data collection and reporting context with the Direct Data Collection Client. As part of this context, the UE Application may indicate consent for a UE identifier to be included in data reports submitted on its behalf by the Direct Data Collection Client.
10.	As a consequence of step 9 or (if the UE Application is not present) during its own initialisation, the Direct Data Collection Client acquires its data collection and reporting configuration from the Data Collection AF, if relevant.
If the UE Application is instantiated, the Direct Data Collection Client provides it with a data collection and reporting configuration derived from that just obtained from the Data Collection AF.
11.	The Indirect Data Collection Client acquires its data collection and reporting configuration from the Data Collection AF, if relevant.
12.	The AS acquires its data collection and reporting configuration from the Data Collection AF, if relevant.
Whenever the provisioning information changes, or the set of event exposure subscriptions changes, a new set of data collection and reporting configuration shall be made available to data collection clients by the Data Collection AF.",TS 26.531,5.4,all_images/image_885.jpeg,High-level procedures for data collection client configuration phase
"Figure 5.5-1: High-level procedures for data reporting and exposure phase
The different data collection clients proceed as follows:
13.	If present in the instantiation, the UE Application reports data to the Direct Data Collection Client according to the configuration provided in step 10 for inclusion in a data report.
14.	The Direct Data Collection Client may submit a data report to the Data Collection AF via reference point R2 by invoking the Ndcaf_DataReporting service defined in the present document and specified in TS 26.532 [7].
15.	The UE Application may send application-specific data reporting to the Application Service Provider...
16.	...and the Indirect Data Collection Client may, as a result, submit a data report to the Data Collection AF by invoking the Ndcaf_DataReporting service defined in the present document and specified in TS 26.532 [7].
17.	The AS may submit a data report to the Data Collection AF by invoking the Ndcaf_DataReporting service defined in the present document and specified in TS 26.532 [7].",TS 26.531,5.5,all_images/image_886.jpeg,High-level procedures for data reporting and exposure phase
"The procedure for authorising access to the events exposed by the Data Collection AF is depicted by the following call flow:
Figure 5.8-1: High-level procedures for event consumer authorization
The steps are:
1.	The Provisioning AF provisions the data collection and the report exposure functionality at reference point R1, per the procedures in clause 5.2, including a set of Data Access Profiles.
1a.	The Data Collection AF may provision the Authorization AS with a Data Access Profile configuration corresponding to step 1, including the Data Access Profile ID. The procedures used in this step are outside the scope of standardisation.
2.	An event consumer sends a subscription request to the Data Collection AF to receive events via reference point R5 or R6, per the procedures in clause 5.3, indicating the Event ID of interest and any desired user-, location- and/or application-based filters (see clause 4.6.1).
3.	In return, the Data Collection AF redirects the event consumer to the Authorization AS in order to obtain access.
4.	The event consumer contacts the Authorization AS (according to the procedures for authorization of NF service access defined in clause 13.4 of TS 33.501 [9]) with a set of valid credentials.
5.	If access is granted, the Authorization AS responds with an access token that is valid for a specific period of time. The access token may encode a Data Access Profile ID if the authorization applies narrowly. The response may redirect the event consumer to the Data Collection AF using the initial subscription request URL, enhanced with the access token and optionally with the Data Access Profile ID passed in the clear.
6.	The event consumer resends the subscription request (including the Event ID and desired filters, if any) to the Data Collection AF, this time with the access token and, optionally, with the Data Access Profile ID.
7.	The Data Collection AF may verify the access token with the Authorization AS, or it may verify it locally.
8.	If verification is successful, the Data Collection AF approves the subscription request for the requested Access Profile
9.	The Data Collection AF sends event notifications to the event consumer, per the procedures in clause 5.6.
10.	The event consumer cancels its event subscription using the procedures in clause 5.7.",TS 26.531,5.8,all_images/image_888.jpeg,High-level procedures for event consumer authorization
"This section contains a similar description to clause 7.1.2 with the difference, that the CMAF track is subdivided into individual CMAF Segments. Depending on the FLUS Sink implementation, every CMAF Segment is identified by a unique URL or the FLUS sink derives the segment sequence from the segments itself. In the first case, all CMAF Segments belonging to the same CMAF Track are identified by the same base URL. In the latter case, that same URL is used for all CMAF Segment of the same CMAF Track.
This instantiation is identified in the F-C configuration by the following urn: “org:3gpp:flus:2018:instantiations:fmp4”. An additional F-C configuration option determines, whether HTTP 1.1 (with Chunked Transfer Encoding), HTTP2.0 with TCP or HTTP 2.0 with other transport protocols such as QUIC should be used. Note, the HTTP version and the transport protocol may also be negotiated at connection setup. When using QUIC as transport protocol, the FLUS Source can fall back to TCP, when the QUIC session setup fails.
A FLUS session may contain one or more media components. When the FLUS session contains multiple media components, each component is formatted as a CMAF Track and upstreamed separately. A common presentation timeline is used across the different media components.
The CMAF Header contains information around the number of tracks, the used codec, codec configuration and optionally static metadata for the upstreamed movie file.
Every CMAF Track starts with the CMAF Header, followed by a sequence of CMAF Segments. Every CMAF Segment may contain one or more CMAF Chunks.
Every CMAF Segment starts with an ‘styp’ box.
An additional F-C configuration option allows the selection of the “Segmented” Profile. When selecting the “Segmented” Profile, some additional configuration parameters are needed. For every CMAF Track, an URL for the CMAF Header and an URL Template for CMAF segments is configured.
Figure 7.1.5.1-1: Illustration of Segmented Profiles with one CMAF Chunk per CMAF Segment (with mapping to HTTP resources)
The FLUS sink offers a simple HTTP PUT or POST interface for upload. The actual uplink stream is provided in the HTTP request body. The HTTP request header contains an URL, either corresponding to the CMAF header or is formatted according to the CMAF Segment URL template.",TR 26.939,7.1.5.1,all_images/image_889.jpeg,Illustration of Segmented Profiles with one CMAF Chunk per CMAF Segment (with
"The FLUS session is created from the same device as the FLUS media plane is provided.
The FLUS Source selects a FLUS Sink, which supports the required Media Codecs and post processing capabilities.
The FLUS Sink provides a single HTTP Push URL so that the FLUS Source can establish one or more HTTP Sessions to the FLUS Sink. The Push URL here is http://sink.operator.com/sessionxyz/.
The FLUS Source uses the received Ingest URL and appends suffixes, so that any media component (CMAF Track) is identified by a unique URL. The FLUS Source here desires to upstream a video and an audio component.
Figure 8.2.1-1: Example Call Flow for fragmented MP4 with HTTP Delivery
FLUS Session Provisioning using F-C
1)	The User of the system (FLUS Source Control) logins into the FLUS system, e.g. using user-name and password.
2)	The user creates a FLUS session using F-C. The FLUS Sink provides a unique session id to be used in subsequent transactions
3)	For FLUS Session provisioning, the FLUS source first fetches the FLUS session parameters.
4)	The FLUS Sink provides the FLUS session parameters with the response.
5)	The FLUS Source does the needed FLUS Session modifications and applies the changes.
6)	The FLUS source fetches the updated FLUS session parameters (The FLUS Sink may have done updates due to configurations).
7)	The FLUS Sink provides the FLUS session parameters with the response. The FLUS Session parameters contains a Push base URL (here. http://sink.operator.com/sessionxyz/)
8)	The FLUS Session is now fully provisioned and the FLUS Source has all needed information.
Note:	The FLUS source function may be separated over different devices. A user can do the FLUS Session Configuration much earlier and potentially using a different device. When the FLUS Source re-connects to an already established, but not active session, the FLUS Source needs to authenticate towards the FLUS Sink (repetition of Step 1).
When time is due to establish the FLUS media session, the FLUS Source should establish here two HTTP Sessions for media components (each formatted as CMAF Track).
1)	The FLUS Source establishes a transport connection (e.g. TCP) and sends an HTTP 1.1 Command. Here, the FLUS Source Sends an HTTP PUT command to establish the audio HTTP session.
2)	The FLUS Source establishes a transport connection (e.g. TCP) and sends an HTTP 1.1 Command. Here, the FLUS Source Sends an HTTP PUT command to establish the video HTTP session.
3)	The FLUS Source sends the CMAF Header file for the audio component. The FLUS sink finds detailed conduct configuration information.
4)	The FLUS Source sends the CMAF Header file for the video component. The FLUS sink finds detailed conduct configuration information.
5)	The FLUS Source starts appending CMAF Chunks to the established HTTP Sessions (according to the type),
When the FLUS Source is pausing the live uplink streaming session, the FLUS source may stop sending CMAF Chunk and keep the HTTP session open. When the FLUS session is continued, the FLUS Source may continue appending CMAF chunks to the session.
When time is due to terminate the FLUS media session, the FLUS Source sends a zero size HTTP Chunk.
6)	Upon reception of the zero size HTTP Chunk, the FLUS Sink sends the HTTP response, indicating the creation of the audio track.
7)	Upon reception of the zero size HTTP Chunk, the FLUS Sink sends the HTTP response, indicating the creation of the video track.",TR 26.939,8.2.1,all_images/image_890.png,Example Call Flow for fragmented MP4 with HTTP Delivery
"Table 8.4.3.3-1 shows the required standard interfaces in this scenario:
Table 8.4.3.3-1: Required Standard APIs for NBMP in Application Server, MPE in Sink
NOTE: The internal APIs inside green boxes are out of the scope of this document",TR 26.939,8.4.3.2.1,all_images/image_893.png,"Call flow of NBMP in Application Server, MPE in Sink through F1"
"This scenario is shown in Figure 8.4.4.1-1.
Figure 8.4.4.1-1: NBMP Client in Application Server, NBMP Workflow Manager, and MPE in Sink",TR 26.939,8.4.4.1,all_images/image_894.jpeg,"NBMP Client in Application Server, NBMP Workflow Manager, and MPE in Sink"
"This scenario is shown in Figure 8.4.5.1-1.
Figure 8.4.5.1-1: NBMP Client in FLUS Control Source, NBMP Workflow Manager, and MPE in Sink
8.4.5.2	 Call Flow
The steps of establishing a FLUS-NBMP session are as the following:
Figure 8.4.5.2-1: Call flow for NBMP Client in FLUS Control Source, NBMP Workflow Manager, and MPE in Sink
In this case, the UE can either
1)	provide NBMP Workflow’s location, so that NBMP Client can discover the MPE capabilities through that API as well as establishing the workflow, or
2)	discover capabilities of Sink during the sink discovery process, so that NBMP Client doesn’t need to discover capabilities of a sink’s MPE in a different step.
The steps of establishing and operating a FLUS-NBMP session are as the following:
1)	UE Application (UA) makes a request through F8 to Application (EA) to start a live session.
2)	EA requests the list of FLUS Sinks and their capabilities from the Sink Discovery Server.
3)	EA picks a Sink that can run the workflow in its MPE and find its NBMP Workflow Manager and Media Sink address in the Sink capabilities.
4)	EA responds to UE with the NBMP Workflow Manager's full URL or a relative URL through FLUS Control Sink.
5)	UA requests FLUS Control Source to establish the FLUS session.
6)	FLUS Control Source establishes the FLUS session and acknowledges UA.
7)	UA requests NBMP Client to start the workflow.
8)	NBMP Client builds WDD, and requests NBMP Workflow Manager (directly or through FLUS Control Sink) to instantiate the Workflow.
Note: The details of this step are not shown in the call flow diagram.
9)	NBMP Workflow Manager instantiates the workflow in the MPE.
10)	NBMP Workflow responds to NBMP Client with updated WDD.
11)	NBMP Client acknowledges workflow instantiation to UA.
The session runs.
8.4.5.3	 Interfaces
Table 8.4.5.3-1 shows the required standard interfaces in this scenario:
Table 8.4.5.3-1: NBMP Client in FLUS Control Source, NBMP Workflow Manager, and MPE in Sink
NOTE: The internal APIs inside green boxes are out of the scope of this document.
8.4.5.4	 Gap Analysis
This subclause provides a gap analysis for the above deployment scenario.
8.4.5.4.1	 Mapping call flow to the standard APIs
The call flow presented in clause ‎8.4.5.2 is mapped to the FLUS and NBMP APIs in the following table:
Table 8.4.5.4.1-1 Mapping call flow to FLUS and NBMP APIs
8.4.5.4.2	 TS 26.238 potential extensions
The sink capability discovery of TS 26.238 is adequate for the discovery of NBMP WM support by FLUS Sink.
The communication of the WDD is achieved through the Sink resource which is defined by TS 26.238 Table 5.3.6-1.  In this table, the ‘url’ item provides the location of NBMP WM. Therefore, the NBMP Client can interact with NBMP WM directly. However, if NBMP Client is expected to interact with NBMP WM through the FLUS F-C link, then sending WDD and receiving it possible in the NBMP Workflow API’s synchronous mode only. The asynchronous mode may suboptimally work if the response includes the NBMP WM URL, which means that the retrieval of the WDD is direct. Also, the wait time for retrieving the WDD is not provided in this case.
For complete support of NBMP Workflow API asynchronous mode, the Sink configuration needs to be extended to include HTTP headers in the response in addition to the already included resource (WDD",TR 26.939,8.4.5.1,all_images/image_895.png,"NBMP Client in FLUS Control Source, NBMP Workflow Manager, and MPE in Sink"
"Figure 8.4.6.2.1-1 demonstrates the call flow when MPE capabilities are discovered through F1.. Figure 8.4.6.2.1-1: Call flow for NBMP Client in the UA, NBMP Workflow Manager in the Application Server, and MPE in Sink through F1. The steps of establishing a FLUS-NBMP session are as the following:. 1)	UE Application (UA) makes a request through F8 to Application (EA) to start a live session.. 2)	EA requests the list of FLUS Sinks and their capabilities from the Sink Discovery Server.. 3)	Sink Discovery Server responds to EA’s request.. 4)	EA picks a FLUS Sink that can run the workflow in its MPE and find its MPE address and MPE APIs in its capabilities.. 5)	EA responds to UA with FLUS Control Sink and FLUS Media Sink information.. 6)	UA requests NBMP Client to start an NBMP Workflow with FLUS Media Sink Address.. 7)	NBMP Client builds the WDD and requests NBMP Workflow Manager to instantiate the Workflow, with the assigned MPE.. 8)	NBMP Workflow Manager instantiates the workflow in the assigned MPE.. 9)	NBMP Workflow responds to NBMP Client with updated WDD.. 10)	NBMP Client acknowledges workflow instantiation to EA.. 11)	UA requests FLUS Control Source to establish the FLUS session.. 12)	FLUS Control Source establishes the FLUS session and acknowledges UA. 13)	The session starts.",TR 26.939,8.4.6.2.1,all_images/image_896.png,"Call flow for NBMP Client in the UA, NBMP Workflow Manager in the Application"
"Figure 8.4.6.2.2-1 demonstrates the call flow when the MPE is discovered through F1 and its capabilities are accessed through N3.. Figure 8.4.6.2.2-1: Call flow for NBMP Client in the UA, NBMP Workflow Manager in the Application Server and MPE in Sink through N3. The steps of establishing a FLUS-NBMP session are as the following:. 1)	UE Application (UA) makes a request through F8 to Application (EA) to start a live session.. 2)	EA requests the list of FLUS Sinks and their capabilities from the Sink Discovery Server and receives it.. 3)	EA picks a FLUS Sink that can run the workflow in its MPE and request its capabilities.. 4)	FLUS Sink provides its capabilities to EA including the address of MPE.. 5)	EA requests the MPE capabilities.. 6)	MPE provides its capabilities to EA.. 7)	EA responds to UA with FLUS Control Sink and FLUS Media Sink information.. 8)	UA requests NBMP Client to start an NBMP Workflow with FLUS Media Sink Address.. 9)	NBMP Client builds the WDD and requests NBMP Workflow Manager to instantiate the Workflow, with the assigned MPE.. 10)	NBMP Workflow Manager instantiates the workflow in the assigned MPE and acknowledges NBMP Client.. 11)	NBMP Client acknowledges workflow instantiation to EA.. 12)	UA requests FLUS Control Source to establish the FLUS session.. 13)	FLUS Control Source establishes the FLUS session and acknowledges UA. 14)	The session starts.",TR 26.939,8.4.6.2.2,all_images/image_897.jpeg,"Call flow for NBMP Client in the UA, NBMP Workflow Manager in the Application Server"
"In this scenario as shown in Figure 8.4.7.1-1, NBMP Client is in the UA, NBMP WM and MPE are located in the Application Server.. Figure 8.4.7.1-1: NBMP Client in the UA, NBMP Workflow Manager, and MPE in the Application Server",TR 26.939,8.4.7.1,all_images/image_898.png,"NBMP Client in the UA, NBMP Workflow Manager, and MPE in the Application Server"
"This deployment scenario is based on the deployment scenario of clauses 8.4.4 (WM-MPE-Sink) or 8.4.5 (NBMPSource-FLUSSource). However, there exists one or more 5GMS AF that are utilized for provisioning and helping to set up the service. All other deployment scenarios (as described in clauses 8.4.2, 8.4.3, 8.4.6, and 8.4.7) may be extended similarly by utilizing 5GMS AF.. This scenario is shown in Figure 8.4.8.1-1. In this figure, interfaces M1 and M2 indicate the corresponding 5GMSu AF’s M1 and M2 interfaces that are defined by TS 26.501, respectively.. Figure 8.4.8.1-1: NBMP-enabled FLUS Session Establishment using 5GMSu AF",TR 26.939,8.4.8.1,all_images/image_899.png,NBMP-enabled FLUS Session Establishment using 5GMSu AF
"Figure 10.2-1 illustrates at a high level the end-to-end procedures and interactions between network entities (including the UE-based FLUS Source and media content recipient), for the case of a mobile operator provided LUS service. In this example, the downlink delivery method (via unicast/PSS or broadcast/MBMS) is assumed to be determined prior to the uplink streaming event, based on the number and location of interested viewers.
Figure 10.2-1: End-to-end message flow for MNO provided Live Uplink Streaming service
Description of e2e operation of MNO-provided Live Uplink Streaming service:
1)	Via F-C, the FLUS sink discovery procedure is performed by the FLUS source to discover available network-based FLUS sinks offered by the FLUS service provider which in this message flow is the mobile operator. Additional information on this procedure can be found in clause 6.1.2 of this document, and normative description of this procedure is provided in clause 7 of TS 26.238 [2].
2)	Mutual authentication between FLUS source and FLUS sink, and the FLUS sink checks that the FLUS source is authorized to live stream media content to the network (e.g., from user subscription information).
3)	Via F-C, the FLUS sink capabilities discovery procedure is performed by the FLUS source to discover the capabilities of the available (network-based) FLUS sink(s). Additional information on this procedure can be found in clause 6.1.2 of this document, and normative description of this procedure is provided in clause 4.4.4 of TS 26.238 [2].
4)	Via F-C, the FLUS source creates a session at the FLUS sink, over which streaming media content can be subsequently sent to the FLUS sink via F-U. Additional information on this procedure can be found in clause 8.2.1 of this document, and normative description of this procedure is provided in clause 7.5 of TS 26.238 [2].
5)	The FLUS source interacts with the ‘Registration, Subscription & Measurement’ function in the network to register the impending live uplink streaming event.
6) and 7). Upon discovery of the schedule of upcoming live streaming events from one or more senders who have registered with the LUS service, viewers 1 to N who have interest in viewing the streaming media content from the FLUS source of concern in this message flow, perform subscription with the Registration, Subscription & Measurement function for reception of that content. It is assumed in this case that the location of each viewer (e.g. cell-ID in which his/her UE is currently located) is also provided to the network in the subscription transaction.
8)	Upon receiving and processing the subscriptions from the interested viewers of the upcoming live streaming event associated with the FLUS source, viewership popularity information, along with the location of the interested viewers are sent from the Registration, Subscription & Measurement function to Distribution function in the network.
Between its reception of the popularity+location information and the time at which the live uplink streaming event occurs, the Distribution function determines whether downlink distribution of the corresponding media content will be done via the broadcast (MBMS) or unicast (PSS) delivery method.
9) Via the FLUS session update procedure over F-C, the FLUS source selects the media session instantiation (e.g., IMS-based uplink transmission, CMAF-based fMP4 transmission, MPU-based fMP4 transmission or RTMP-based transport).
10) At the scheduled “broadcast” time, the FLUS source begins uplink media streaming to the FLUS sink.
11) Forwarding of received streaming content from FLUS sink to network Processing function.
12) Processing of incoming media content such as transcoding, reformatting, media combining, etc. by Processing function in accordance to previous FLUS session configuration (by the FLUS source), network policy, and possibly directives or other information supplied by the Distribution function.
13) Processing function forwards the processed media content to the Distribution functions for downlink delivery to recipient UEs
14) Distribution function performs downlink distribution of the streaming media to viewer devices which have subscribed to receive the LUS service content from the FLUS source, via MBMS or PSS.
15) a-c. At the conclusion of the live streaming event, the FLUS media session is terminated between the FLUS source and FLUS sink, and correspondingly leads to the termination of media processing and downlink distribution activities.",TR 26.939,10.2,all_images/image_900.jpeg,End-to-end message flow for MNO provided Live Uplink Streaming service
"Figure 10.3-1 illustrates at a high level the end-to-end procedures and interactions between network entities (including the UE-based FLUS Source and media content recipient), for the case of a 3rd-party provided LUS service, for which the 3rd-party provider hands off the uploaded content to a mobile operator for downloink distribution over 3GPP network technology (PSS or MBMS as shown). In this example, similar to Figure 10.2-1, the downlink delivery method (via unicast/PSS or broadcast/MBMS) is assumed to be determined prior to the uplink streaming event, based on information on the number and location of interested viewers provided by the 3rd-party provider to the mobile operator.
Figure 10.3-1: End-to-end message flow for 3rd Party provided Live Uplink Streaming service with downlink distribution handled by mobile operator
Description of e2e operation of 3rd party-provided Live Uplink Streaming service with downlink distribution handled by MNO:
1-15. The description for each of the numbered transactions between entities in the message flow of Figure 8 is identical to the counterpart numbered step as shown in Figure 10.2-1, with the only differences being: a) in Figure 8, some of the network entities belong to the 3rd-party LUS service provider while the others belong to the mobile operator, while in Figure 7, they all belong to the mobile operator; and b) UEs associated with Viewers 1 to N in Figure 8 are considered to be associated with/belong to both the 3rd-party provider and the mobile operator, while those viewers are strictly associated with/belong to the mobile operator in Figure 7.",TR 26.939,10.3,all_images/image_901.png,End-to-end message flow for 3rd Party provided Live Uplink Streaming service with
,TS 26.118,4.1,all_images/image_903.jpeg,Restricted coverage of the sphere region covered by the cropped output picture with
"This clause provides more details of a client reference architecture for VR streaming applications and describes their components and interfaces.
Figure 4.3-1 and Figure 4.3-2 show a high-level structure of the client reference architecture for VR DASH streaming and VR local playback, respectively, which consist of five functional components:
-	VR Application: The VR application controls the rendering depending on a user viewport or display capabilities. The application may communicate with other functional components, e.g., the access engine, the file decoder. The access engine or file decoder may parse some abstracted control information to the VR application and the application makes the decision on which adaptation sets or preselections to select or which tracks to choose taking into account platform or user information as well as the dynamic pose information.
-	Access Engine: The access engine connects through a 3GPP bearer and provides a conforming VR presentation to the receiver. The access engine fetches the Media Presentation Description (MPD), constructs and issues requests and receives Segments or parts of Segments. In the case of local playback, the 3GPP VR Track is accessed from the local storage. The access engine may interface with the VR application function to dynamically change the delivery session. The access engine provides a conforming 3GPP VR track to the file decoder.
-	File Decoder: The file decoder processes the 3GPP VR Track to generate signals that can be processed by the renderer. The file decoder typically includes at least of two sub-modules; the file parser and the media decoder. The file parser processes the file or segments, extracts elementary streams, and parses the metadata, if present. The processing may be supported by dynamic information provided by the VR application, for example which tracks to choose based on static and dynamic configurations. The media decoder decodes media streams of the selected tracks into the decoded signals. The file decoder outputs the decoded signals and metadata which is used for rendering. The file decoder is the primary focus of the present document.
-	VR Renderer: The VR Renderer uses the decoded signals and rendering metadata and provides a viewport presentation taking into account the viewport and possible other information. With the pose, a user viewport is determined by determining horizontal/vertical field of view of the screen of a head-mounted display or any other display device to render the appropriate part of decoded video or audio signals. The renderer is addressed in individual media profiles. For video, textures from decoded signals are projected to the sphere with rendering metadata received from the file decoder. During the texture-to-sphere mapping, a sample of the decoded signal is remapped to a position on the sphere. Likewise, the decoded audio signals are represented in the reference system domain. The appropriate part of video and audio signals for a current pose is generated by synchronizing and spatially aligning the rendered video and audio.
-	Sensor: The sensor extracts the current pose according to the user's movement and provides it to the renderer for viewport generation. The current pose may for example be determined by the head tracking and possibly also eye tracking functionalities. The current pose may also be used by the VR application to control the access engine on which adaptation sets or preselections to select (for the streaming case), or to control the file decoder on which tracks to choose for decoding (for the local playback case).
The main objective of the present document is to enable the file decoder to generate decoded signals and the rendering metadata from a conforming 3GPP VR Track by generating a bitstream that conforms to a 3GPP Operation Point. Both, a 3GPP VR Track as well as a bitstream conforming to an Operation Point are a well-defined conformance points for a VR File decoder and a Media Decoder. Both enable to represent the contained media in the VR reference system (spatially and temporally).
NOTE 1:	3GPP VR Track represents media in container formats according to the ISO/IEC 14496-12 [17] ISO Base Media File Format and may consist of one or more ISO BMFF tracks following the requirements of this specification.
Figure 4.3-1: Client Reference Architecture for VR DASH Streaming Applications
Figure 4.3-2: Client Reference Architecture for VR Local Playback
NOTE 2:	The dashed arrows indicate optional interfaces between components in the Figure 4.3-2. Viewport information should optionally be input to the access engine and file decoder.",TS 26.118,4.3,all_images/image_908.jpeg,Client Reference Architecture for VR DASH Streaming Applications
"This clause provides more details of a client reference architecture for VR streaming applications and describes their components and interfaces.
Figure 4.3-1 and Figure 4.3-2 show a high-level structure of the client reference architecture for VR DASH streaming and VR local playback, respectively, which consist of five functional components:
-	VR Application: The VR application controls the rendering depending on a user viewport or display capabilities. The application may communicate with other functional components, e.g., the access engine, the file decoder. The access engine or file decoder may parse some abstracted control information to the VR application and the application makes the decision on which adaptation sets or preselections to select or which tracks to choose taking into account platform or user information as well as the dynamic pose information.
-	Access Engine: The access engine connects through a 3GPP bearer and provides a conforming VR presentation to the receiver. The access engine fetches the Media Presentation Description (MPD), constructs and issues requests and receives Segments or parts of Segments. In the case of local playback, the 3GPP VR Track is accessed from the local storage. The access engine may interface with the VR application function to dynamically change the delivery session. The access engine provides a conforming 3GPP VR track to the file decoder.
-	File Decoder: The file decoder processes the 3GPP VR Track to generate signals that can be processed by the renderer. The file decoder typically includes at least of two sub-modules; the file parser and the media decoder. The file parser processes the file or segments, extracts elementary streams, and parses the metadata, if present. The processing may be supported by dynamic information provided by the VR application, for example which tracks to choose based on static and dynamic configurations. The media decoder decodes media streams of the selected tracks into the decoded signals. The file decoder outputs the decoded signals and metadata which is used for rendering. The file decoder is the primary focus of the present document.
-	VR Renderer: The VR Renderer uses the decoded signals and rendering metadata and provides a viewport presentation taking into account the viewport and possible other information. With the pose, a user viewport is determined by determining horizontal/vertical field of view of the screen of a head-mounted display or any other display device to render the appropriate part of decoded video or audio signals. The renderer is addressed in individual media profiles. For video, textures from decoded signals are projected to the sphere with rendering metadata received from the file decoder. During the texture-to-sphere mapping, a sample of the decoded signal is remapped to a position on the sphere. Likewise, the decoded audio signals are represented in the reference system domain. The appropriate part of video and audio signals for a current pose is generated by synchronizing and spatially aligning the rendered video and audio.
-	Sensor: The sensor extracts the current pose according to the user's movement and provides it to the renderer for viewport generation. The current pose may for example be determined by the head tracking and possibly also eye tracking functionalities. The current pose may also be used by the VR application to control the access engine on which adaptation sets or preselections to select (for the streaming case), or to control the file decoder on which tracks to choose for decoding (for the local playback case).
The main objective of the present document is to enable the file decoder to generate decoded signals and the rendering metadata from a conforming 3GPP VR Track by generating a bitstream that conforms to a 3GPP Operation Point. Both, a 3GPP VR Track as well as a bitstream conforming to an Operation Point are a well-defined conformance points for a VR File decoder and a Media Decoder. Both enable to represent the contained media in the VR reference system (spatially and temporally).
NOTE 1:	3GPP VR Track represents media in container formats according to the ISO/IEC 14496-12 [17] ISO Base Media File Format and may consist of one or more ISO BMFF tracks following the requirements of this specification.
Figure 4.3-1: Client Reference Architecture for VR DASH Streaming Applications
Figure 4.3-2: Client Reference Architecture for VR Local Playback
NOTE 2:	The dashed arrows indicate optional interfaces between components in the Figure 4.3-2. Viewport information should optionally be input to the access engine and file decoder.",TS 26.118,4.3,all_images/image_909.png,Client Reference Architecture for VR Local Playback
,TS 26.118,4.5,all_images/image_911.jpeg,Block diagram of Common Informative Binaural Renderer
"The client reference architecture for VR metrics, shown below in Figure 9.2.1-1, is based on the client architecture in Figure 4.3-1. It also contains a number of observation points where specific metric-related information can be made available to the Metrics Collection and Computation (MCC) function. The MCC can use and combine information from the different observation points to calculate more complex metrics.
Note that these observation points are only defined conceptually, and might not always directly interface to the MCC. For instance, an implementation might relay information from the actual observation points to the MCC via the VR application. It is also possible that the MCC is not separately implemented, but simply included as an integral part of the VR application.
Also note that in this version of this specification not all of the described observation points are necessarily used to produce VR metrics.
Figure 9.2.1-1: Client reference architecture for VR metrics",TS 26.118,9.2.1,all_images/image_914.png,Client reference architecture for VR metrics
"A provisioning and ingestion procedure in this section describes a realization of the ""Live Video from multiple cameras angles into a stadium"" use-case as introduced in clause 4.1. When the target broadcast area is not restricted to the small coverage of a stadium (e.g. broadcast coverage covers a region), the provisioning procedure describes the configuration of a MBMS Broadcast only TV services.
This procedure describes the provisioning for a Live DASH service into a single broadcast area. A Push Interface like WebDAV is used here as ingestion method for the user-plane data. The push interface is identified by a unique URI. The source of the user plane data (CP Source) are the DASH Media Segments as produced by a Live Encoder / Segmenter and the source pushes each new segment when it becomes available. The Media Presentation Description (MPD) URL for the Live DASH session is provided to BM-SC during Session creation or on a subsequent update request.
Figure 5.3.2-1: Live DASH Provisioning and Ingestion Procedure
1:	The operator and the Content Provider agree a Service Level Agreement, which entitles the Content Provider to use the MBMS system (in accordance to some rules) for content delivery. For instance, the SLA can include day time ranges, during which the Content Provider can distributed content. The SLA can also include geographical areas, in which the Content Provider is allowed to distribute content. The SLA also includes target bitrates and likely definitions of tolerable losses per service.
2:	The BM-SC administrators (operator) apply the agreed ranges. This can imply to add additional Service Areas, and other system related configurations.
The Content Provider provisioning a single Live DASH session in a single broadcast area.
3:	The Content Provider authenticates itself as authorized user. The Content Provider can only see those configurations, sessions and services, which belong to the Content Provider. On successful authentication, an access token is provided to CP and will be present in every subsequent message sent by CP to BM-SC.
4:	The Content Provider creates a new Service by providing service class, service languages, service names, notification configuration as well as consumption reporting configuration. The Content Provider can select whether the CP or the operator distributes service announcement by providing a list of Service Announcement Channel (SACH, as defined in Annex L.2 / L.3 of [3]) services used for operator-driven service announcement.
Note 1:	BM-SC derives the required UE capabilities from the provided service and session properties.
5:	Upon successful Service creation by the BM-SC, the BM-SC will provide a unique Service Id, that the Content Provider will use for subsequent requests.
6:	The Content Provider creates a Session for previously created Service. Common session properties provided as input by Content Provider: unique Service Id this session belongs to, max ingest bitrate (excluding any FEC redundancy and transport overhead), scheduling information (start time, stop time), QoE Reporting configuration and session type (set to Application). DASH specific session properties provided as input by Content Provider: Mime-type of ASD fragment (set to application/dash+xml), Application Entry Point URL (i.e. MPD URL), ingest mode (push/pull), Unicast Delivery Indicator, Components.
Note 2:	BM-SC allocates following parameters for SDP: TMGI, FLUTE IP Multicast Address, UDP Port and TSI.
Note 3:	BM-SC derives the SAI list from Geographical Area provided in Content Provider request and from PLMN id negotiated in step 1. FEC information (codec and ratio) and MBMS Bearer QoS (ARP, QCI) are also negotiated in step 1.
Note 4:	Service Announcement start time can be provided in request. If not, BM-SC starts announcing service as soon as all required service and session properties are provided by Content Provider.
Note 5:	In the case of regional services, i.e. that deliver region specific content, a Session can be cloned so that all Sessions of user service use same FLUTE parameters.
7:	A unique Session Id, which identifies the created Session, is responded. Additionally, the push URL (if required ingest mode is push) and QoE Report URL are added to the response.
8:	The Content provider queries the Session configuration, providing Session Id.
9:	The BM-SC provides the information in response. All readable session properties are provided in response.
10:	The Content Provider updates the session by providing Application Entry Point URL
11:	The BM-SC sends response with update status.
12:	Once all information for service announcement is available, and if service announcement start time is elapsed, the BM-SC starts announcing the service automatically. Service announcement is automatically updated following subsequent Session updates.
The BM-SC activates automatically the MBMS Bearer at Session start time.
13: The BM-SC activates the MBMS bearer by providing the TMGI, the Flow ID, the MBMS Service Area (MSA), the GBR and other parameters to the MBMS-GW. The BM-SC can notify the Content Provider about the activation of the MBMS Bearer.
14: The BM-SC activates the MBMS Broadcast bearer according to the time schedule. When the MBMS Broadcast bearer is activated, then the BM-SC MBMS Delivery Function (MDF) starts forwarding the user plane data (push interface). Any user plane data received before activation of the MBMS bearer can be discarded.
15: At Session stop time, the MBMS bearer is terminated. The BM-SC can notify the Content Provider about the termination of the MBMS Bearer.
16: The Content Provider terminates the service. All sessions, which are still created or active will be deleted automatically by BM-SC with the termination of the service.
17: BM-SC sends service termination response.",TR 26.981,5.3.2,all_images/image_916.png,Live DASH Provisioning and Ingestion Procedure
"A provisioning and ingestion procedure in this section describes a realization of ""VOD prepositioning"" use-case (as introduced in clause 4.3) and ""Software update"" Use-Case (as introduced in clause 4.4).
This use-case described the provisioning procedure for a File Delivery service without any file schedule element into a single broadcast area. The file schedule element is carried in the schedule description fragment during service announcement and contains transmission timings information for each URL. Consequently, the file URLs has to be present when creating service announcement information.
This use-case assumes that the BM-SC automatically fetches the file using a pull method and prepares the transmission. File URLs can be provided in Session creation request or any subsequent Session update request. When file preparation ends after Session start time, the file is automatically added to user plane flow. It is up to Content Provider to secure that Session scheduling is large enough to allow files preparation and transmission according to bitrate between BM-SC and file location, and bitrate of user plane.
Figure 5.3.4-1: File Delivery Provisioning and Ingestion Procedure
1: The operator and the Content Provider agree a Service Level Agreement, which entitles the Content Provider to use the MBMS system (in accordance to some rules) for content delivery. For instance, the SLA can include day time ranges, during which the Content Provider can distributed content. The SLA can also include geographical areas, in which the Content Provider is allowed to distribute content. The SLA also includes target bitrates and likely definitions of tolerable losses per service.
2: The BM-SC administrators (operator) apply the agreed ranges. This can imply to add additional Service Areas, and other system related configurations.
The Content Provider provisioning a file delivery session in a single broadcast area.
3: The Content Provider authenticates itself as authorized user. The Content Provider can only see those configurations, sessions and services, which belong to the Content Provider. On successful authentication, an access token is provided to CP and will be present in every subsequent message sent by CP to BM-SC.
4: The Content Provider creates a new Service by providing service class, service languages, service names, notification configuration as well as consumption reporting configuration. The Content Provider can select whether the CP or the operator distributes service announcement by providing a list of Service Announcement Channel (SACH, as defined in Annex L.2 / L.3 of [3]) services used for operator-driven service announcement.
Note: BM-SC derives the required UE capabilities from the provided service and session properties.
5: Upon successful Service creation by the BM-SC, the BM-SC will provide a unique Service Id, that the Content Provider will use for subsequent requests.
6: The Content Provider creates a Session for previously created Service.
Common session properties provided as input by Content Provider: unique Service Id this session belongs to, max ingest bitrate (excluding any FEC redundancy and transport overhead), scheduling information (start time, stop time), Geographical Area and QoE Reporting configuration and session type (set to Files).
Files specific session properties provided as input by Content Provider: ingest mode (pull/push), file list if pull mode.
Note 1:	BM-SC allocates following parameters for SDP: TMGI, FLUTE IP Multicast Address, UDP Port and TSI.
Note 2:	BM-SC derives the SAI list from Geographical Area provided in Content Provider request and from PLMN id negotiated in step 1. FEC information (codec and ratio) and MBMS Bearer QoS (ARP, QCI) are also negotiated in step 1.
Note 3:	In pull ingest mode, file URLs can be provided now or at a later stage through the Session Update procedure.
Note 4:	Service Announcement start time can be provided in request. If not, BM-SC starts announcing service as soon as all required service and session properties are provided by Content Provider
Note 5:	In the case of regional services, i.e. that deliver region specific content, a Session can be cloned so that all Sessions of user service use same FLUTE parameters.
7: A unique Session Id, which identifies the created Session, is responded. If push ingest mode is used, BM-SC provides also the push URL the Content Provider will use.
Note:	For file URLs provided in Session creation request, the BM-SC starts automatically to fetch the file resource(s) from the content location when file earliest fetch time elapses and generates the FLUTE and FEC symbols (if any). The BM-SC can notify the Content Provider when the process is finalized.
8: Once all information for service announcement is available, and if service announcement start time is elapsed, the BM-SC starts announcing the service automatically. Service announcement is automatically updated following subsequent Session updates. File schedule element can be present in Schedule fragment for files URLs provided in Session creation request.
9: The Content Provider queries the Session configuration, providing Session Id.
10: The BM-SC provides the information in response.
11: The Content Provider updates the session by providing additional File URLs.
12: The BM-SC sends response with update status.
Note 6:	The BM-SC starts automatically to fetch the new file resource(s) from the content location when file earliest fetch time elapses and generates the FLUTE and FEC symbols (if any). The BM-SC can notify the Content Provider when the process is finalized.
Note 7:	Steps 9-12 can be executed at any time after Session is created and prior to the Session stop time. Any file URL added after Session start time will be automatically fetched, processed and sent on user plane.
The BM-SC activates automatically the MBMS Bearer at Session start time.13: The BM-SC activates the MBMS bearer by providing the TMGI, the Flow ID, the MBMS Service Area (MSA), the GBR and other parameters to the MBMS-GW. The BM-SC can notify the Content Provider about the activation of the MBMS Bearer.
14: The BM-SC activates the MBMS Broadcast bearer according to the time schedule. When the MBMS Broadcast bearer is activated, then the BM-SC MBMS Delivery Function (MDF) starts sending the user plane data, according to Target reception completion time.
Note 8:	The BM-SC can notify Content Provider of file delivery start/end.
15: At Session stop time, the MBMS bearer is terminated. The BM-SC can notify the Content Provider about the termination of the MBMS Bearer.
16: The Content Provider terminates the service. All sessions, which are still created or active will be deleted automatically by BM-SC with the termination of the service.
17: BM-SC sends service termination response.",TR 26.981,5.3.4,all_images/image_917.png,File Delivery Provisioning and Ingestion Procedure
"This use-case describes the provisioning procedure for a File Carousel service. The provisioning procedure in clause 5.3.4 can also be used to realize File Carousel Services.
This use-case assumes that the BM-SC automatically fetches the file using a pull method and prepares the transmission. BM-SC sends files in a carousel back-to-back mode during Session transmission. File URLs can be provided in Session creation request or any subsequent Session update request. When file preparation ends after Session start time, the file is automatically added to user plane flow.
When Session starts, File Carousel Service checks on a regular basis the content location of each file URL. If file changed, updated version is automatically fetched, prepared and transmitted on user plane in place of old version.
Figure 5.3.5-1: File Carousel Provisioning and Ingestion Procedure
1: The operator and the Content Provider agree a Service Level Agreement, which entitles the Content Provider to use the MBMS system (in accordance to some rules) for content delivery. For instance, the SLA can include day time ranges, during which the Content Provider can distributed content. The SLA may also include geographical areas, in which the Content Provider is allowed to distribute content. The SLA also includes target bitrates and likely definitions of tolerable losses per service.
2: The BM-SC administrators (operator) apply the agreed ranges. This can imply to add additional Service Areas, and other system related configurations.
The Content Provider provisioning a file delivery session in a single broadcast area.
3: The Content Provider authenticates itself as authorized user. The Content Provider can only see those configurations, sessions and services, which belong to the Content Provider. On successful authentication, an access token is provided to CP and will be present in every subsequent message sent by CP to BM-SC.
4: The Content Provider creates a new Service by providing service class, service languages, service names, notification configuration as well as consumption reporting configuration. The Content Provider can select whether the CP or the operator distributes service announcement by providing a list of Service Announcement Channel (SACH, as defined in Annex L.2 / L.3 of [3]) services used for operator-driven service announcement.
Note 1:	BM-SC derives the required UE capabilities from the provided service and session properties.
5: Upon successful Service creation by the BM-SC, the BM-SC will provide a unique Service Id, that the Content Provider will use for subsequent requests.
6: The Content Provider creates a Session for previously created Service.
Common session properties provided as input by Content Provider: unique Service Id this session belongs to, max ingest bitrate (excluding any FEC redundancy and transport overhead), scheduling information (start time, stop time), Geographical Area, QoE Reporting configuration and session type (set to Files).
Files specific session properties provided as input by Content Provider: ingest mode (pull/push), file list if pull mode. In this use-case Content Provider provides a Keep Update Interval for files.
Note 2:	BM-SC allocates following parameters for SDP: TMGI, FLUTE IP Multicast Address, UDP Port and TSI.
Note 3:	BM-SC derives the SAI list from Geographical Area provided in Content Provider request and from PLMN id negotiated in step 1. FEC information (codec and ratio) and MBMS Bearer QoS (ARP, QCI) are also negotiated in step 1.
Note 4:	In pull ingest mode, file URLs can be provided now or at a later stage through the Session Update procedure.
Note 5:	Service Announcement start time can be provided in request. If not, BM-SC starts announcing service as soon as all required service and session properties are provided by Content Provider
Note 6:	In the case of regional services, i.e. that deliver region specific content, a Session can be cloned so that all Sessions of user service use same FLUTE parameters.
NOTE 7:	A unique Session Id, which identifies the created Session, is responded. If push ingest mode is used, BM-SC provides also the push URL the Content Provider  will use.
Note 8:	For file URLs provided in Session creation request, the BM-SC starts automatically to fetch the file resource(s) from the content location when file earliest fetch time elapses and generates the FLUTE and FEC symbols (if any). The BM-SC can notify the Content Provider when the process is finalized.
8: Once all information for service announcement is available, and if service announcement start time is elapsed, the BM-SC starts announcing the service automatically. Service announcement is automatically updated following subsequent Session updates.
9: The Content Provider queries the Session configuration, providing Session Id.
10: The BM-SC provides the information in response.
11: The Content Provider updates the session by providing additional File URLs.
12: The BM-SC sends response with update status.
Note 9:	The BM-SC starts automatically to fetch the new file resource(s) from the content location when file earliest fetch time elapses and generates the FLUTE and FEC symbols (if any). The BM-SC can notify the Content Provider when the process is finalized.
Note 10: Steps 9-12 can be executed at any time after Session is created and prior to the Session stop time. Any file URL added after Session start time will be automatically fetched, processed and sent on user plane.
The BM-SC activates automatically the MBMS Bearer at Session start time.
13: The BM-SC activates the MBMS bearer by providing the TMGI, the Flow ID, the MBMS Service Area (MSA), the GBR and other parameters to the MBMS-GW. The BM-SC can notify the content provider about the activation of the MBMS Bearer.
14: The BM-SC activates the MBMS Broadcast bearer according to the time schedule. When the MBMS Broadcast bearer is activated, then the BM-SC MBMS Delivery Function (MDF) starts sending the user plane data.
Note 11:	The BM-SC starts to check files update on content location using Keep Update Interval value. Any updated file is automatically fetched, processed and replaced in user plane flow, taking into account File repeat parameter. The BM-SC can realize file repetitions in various ways, e.g. simply repeating the source data of the file or send only FEC redundancy information during file repetitions.
15: At Session stop time, the MBMS bearer is terminated. The BM-SC can notify the content provider about the termination of the MBMS Bearer.
16: The Content Provider terminates the service. All sessions, which are still created or active will be deleted automatically by BM-SC with the termination of the service.
17: BM-SC sends service termination response.",TR 26.981,5.3.5,all_images/image_918.png,File Carousel Provisioning and Ingestion Procedure
"Due to the increasing consumption of video content with higher resolutions, the need for more efficient video compression techniques is growing. The first version of the High Efficiency Video Coding (HEVC) standard [15], jointly developed by the ITU-T VCEG and the ISO MPEG, was finalized in 2013. A wide range of products and services support HEVC [15] for video encoding/decoding, especially for Ultra High Definition (UHD) content, where HEVC [15] can provide around 50% bitrate savings for the same subjective quality as its predecessor H.264/AVC [14].
Both codecs are defined as part of the TV Video Profiles in TS 26.116 [5] and are also the foundation of the VR Video Profiles in TS 26.118 [6].
Work on video compression technologies beyond the capabilities of HEVC [15] are continued by the MPEG/ITU, with the creation of the Joint Video Exploration Team (JVET) on future video coding in October 2015. Many new coding tools have been proposed in the context of JVET, which eventually led to a Call for Proposals on video coding technologies with video compression capabilities beyond HEVC [15]. The reference software used in the exploration phase of JVET, called Joint Exploration Model (JEM), was leveraged as the base for the majority of responses to the call. Results included responses demonstrating compression efficiency gains of around 40 % or more with respect to HEVC [15]. This initiated the work by the Joint Video Experts Team (JVET) on the development of a new video coding standard, to be known as Versatile Video Coding (VVC).
MPEG has started working on a new video coding standard to be known as MPEG-5 Essential Video Coding (EVC) in January 2019. MPEG-5 EVC aims to provide a standardized video coding solution to address business needs in some use cases, such as video streaming, where existing ISO video coding standards have not been as widely adopted as might be expected from their purely technical characteristics. In addition, a main profile adds a small number of additional tools, each of which is individually capable of being either properly deactivated or switched to the corresponding basic tool. The target coding efficiency for the call for proposals was to be at least as efficient as HEVC. This target was exceeded by approximately 24 % in the responses to the call for proposals, which were evaluated at this meeting. The development of the MPEG-5 EVC standard is expected to be completed in 2020.
Figure 6.1.2-1 shows the typical improvements of video compression rates over time as well as the target for the VVC standard. It is also observed that compression technologies have enabled the reduction of bitrates by 50 % in a time frame of 7-10 years. Most of the gains come by the increase of encoding and decoding complexity, spurred according to Moore's law.
Figure 6.1.2-1: Video bitrate efficiency improvements and target for the final VVC standard [reproduced with appropriate permission from Fraunhofer]
Table 6.1.2-1 provides a summary of the expected compression efficiency of different codecs and expectations on target bitrates for different video technologies.
Table 6.1.2-1: Expected Video coding standards performance and bitrate target
Also noteworthy is the improvement of encoders over time even for existing standards which also leads to bitrate reductions at the same quality.
Based on this information it can be expected that within the time frame until 2025, video compression technology permit bitrate reductions by a factor of 50 % compared to what is today possible with HEVC [15].
However, not to forget according to Jevons Paradox, stating that the efficiency with which a resource is used tends to increase (rather than decrease) the rate of consumption of that resource. This may well mean that the compression efficiency gains spur even more traffic.",TR 26.925,6.1.2,all_images/image_933.jpeg,Video bitrate efficiency improvements and target for the final VVC standard
,TR 26.925,8.1,all_images/image_934.jpeg,The principle for classification and User Plane marking for QoS Flows and mapping to
,TR 26.925,8.1.5,all_images/image_935.png,Estimated TCP Throughput over One Way Latency for different packet loss rates and
"The NF Service Consumer (e.g. AMF) shall request the SMF to activate the User Plane connection of an existing PDU session, i.e. establish the N3 tunnel between the 5G-AN and UPF, as follows.
Figure 5.2.2.3.2.2-1: Activation of the User Plane connection of a PDU session
1.	The NF Service Consumer shall request the SMF to activate the user plane connection of the PDU session by sending a POST request, as specified in clause 5.2.2.3.1, with the following information:
-	the upCnxState attribute set to ACTIVATING;
-	the user location and access type associated to the PDU session, if modified;
-	the indication that the UE is inside or outside of the LADN service area, if the DNN of the established PDU session corresponds to a LADN;
-	the access type for which the user plane connection needs to be re-activated, for a MA PDU session (i.e. the access type over which a Registration or Service Request was received);
-	the ""MO Exception Data Counter"" if the UE has accessed the network by using ""MO exception data"" RRC establishment cause;
-	other information, if necessary.
2a.	Upon receipt of such a request, if the SMF can proceed with activating the user plane connection of the PDU session (see clause 4.2.3 of 3GPP TS 23.501 [2]), the SMF shall set the upCnxState attribute to ACTIVATING and shall return a 200 OK response including the following information:
-	upCnxState attribute set to ACTIVATING;
-	N2 SM information to request the 5G-AN to assign resources to the PDU session (see PDU Session Resource Setup Request Transfer IE in clause 9.3.4.1 of 3GPP TS 38.413 [9]), including the transport layer address and tunnel endpoint of the uplink termination point for the user plane data for this PDU session (i.e. UPF's GTP-U F-TEID for uplink traffic).
If the SMF finds the PDU session already activated when receiving the request in step 1, the SMF shall delete the N3 tunnel information and update the UPF accordingly (see step 8a of clause 4.2.3.2 of 3GPP TS 23.502 [3]).
For a MA-PDU session, the SMF shall perform the above requirements for the access type for which the user plane connection is requested to be re-activated (i.e. the access type indicated in the anTypeToReactivate attribute). The SMF shall not modify the user plane connection status for the other access type, e.g. if the user plane connection is already established for the other access type, it shall remain established.
If the ""MO Exception Data Counter"" is included in the request and Small Data Rate Control is enabled for the PDU session, then the V-SMF/I-SMF shall forward the counter to the H-SMF/SMF.
2b.	If the request does not include the ""UE presence in LADN service area"" indication and the SMF determines that the DNN corresponds to a LADN, then the SMF shall consider that the UE is outside of the LADN service area. The SMF shall reject the request if the UE is outside of the LADN service area.
If the SMF cannot proceed with activating the user plane connection of the PDU session (e.g. if the PDU session corresponds to a PDU session of SSC mode 2 and the SMF decides to change the PDU Session Anchor), the SMF shall return an error response, as specified for step 2b of figure 5.2.2.3.1-1.  For a 4xx/5xx response, the SmContextUpdateError structure shall include the following additional information:
-	upCnxState attribute set to DEACTIVATED.
3.	If the SMF returned a 200 OK response, the NF Service Consumer (e.g. AMF) shall subsequently update the SM context in the SMF by sending POST request, as specified in clause 5.2.2.3.1, with the following information:
-	N2 SM information received from the 5G-AN (see PDU Session Resource Setup Response Transfer IE in clause 9.3.4.2 of 3GPP TS 38.413 [9]), including the transport layer address and tunnel endpoint of one or two downlink termination point(s) and the associated list of QoS flows for this PDU session (i.e. 5G-AN's GTP-U F-TEID(s) for downlink traffic), if the 5G-AN succeeded in establishing resources for the PDU sessions; or
-	N2 SM information received from the 5G-AN (see PDU Session Resource Setup Unsuccessful Transfer IE in clause 9.3.4.16 of 3GPP TS 38.413 [9]), including the Cause of the failure, if resources failed to be established for the PDU session.
Upon receipt of this request, the SMF shall:
-	update the UPF with the 5G-AN's F-TEID(s) and set the upCnxState attribute to ACTIVATED, if the 5G-AN succeeded in establishing resources for the PDU sessions; or
-	consider that the activation of the User Plane connection has failed and set the upCnxState attribute to DEACTIVATED"" otherwise.
4.	The SMF shall then return a 200 OK response including the upCnxState attribute representing the final state of the user plane connection. If the activation of the User Plane connection failed due to insufficient resources, the cause IE shall be included in the response and set to ""INSUFFICIENT_UP_RESOURCES"".",TS 29.502,5.2.2.3.2.2,all_images/image_936.png,Activation of the User Plane connection of a PDU session
"This clause describes the structure for the Resource URIs and the resources and methods used for the service.
Figure 6.1.3.1-1 describes the resource URI structure of the Nsmf_PDUSession API.
Figure 6.1.3.1-1: Resource URI structure of the Nsmf_PDUSession API
NOTE:	The sm-contexts and pdu-sessions collection resources can be distributed on different processing instances or hosts. Thus, the authority and/or deployment-specific string of the apiRoot of the created individual sm context and pdu-session resources' URIs can differ from the authority and/or deployment-specific string of the apiRoot of the sm-contexts and pdu-sessions distributed collections' URIs.
Table 6.1.3.1-1 provides an overview of the resources and applicable HTTP methods.
Table 6.1.3.1-1: Resources and methods overview",TS 29.502,6.1.3.1,all_images/image_938.jpeg,Resource URI structure of the Nsmf_PDUSession API
"Figure 6.2.3.1-1: Resource URI structure of the Nhss_imsSDM API
Figure 6.2.3.1-2: Resource URI structure of the Nhss_imsSDM API
Table 6.2.3.1-1 provides an overview of the resources and applicable HTTP methods.
Table 6.2.3.1-1: Resources and methods overview",TS 29.562,6.2.3.1,all_images/image_939.jpeg,Resource URI structure of the Nhss_imsSDM API
"The NF Service Consumer (e.g. AMF) may update UE context in SMSF for a given service user by using the HTTP PATCH method as shown in Figure 5.2.2.2.3-1.
Figure 5.2.2.2.3-1: Modify UE Context in SMSF using HTTP PATCH Method
1.	The NF Service Consumer (e.g. AMF) shall send a PATCH request to the resource representing the UE Context for SMS (i.e. …/ue-contexts/{supi}) in the SMSF to modify the UE Context in SMSF for a given service user. The request body shall contain a list of PatchItem for each the JSON pointer is set to the attribute to be modified.
2a.	On success, the request is accepted, and all the modification instructions in the PATCH request have been implemented, the SMSF shall respond with ""204 No Content"".
2b.	On partial success, the request is accepted, but some of the modification instructions in the PATCH request have been discarded:
-	the SMSF shall respond with ""200 OK"" including PatchResult to indicate the failed modifications, if the NF service consumer has included in the supported-feature query parameter the ""PatchReport"" feature; or
-the SMSF shall respond with ""200 OK"" with the response body containing UeSmsContextData, if the NF service consumer does not support the ""PatchReport"" feature.
2c.	On failure, the appropriate HTTP status code (e.g. ""403 Forbidden"") indicating the error shall be returned. A ProblemDetails IE shall be included in the payload body of PATCH response, with the ""cause"" attribute of ProblemDetails set to application error codes specified in table 6.1.7.3-1.
If the modification is not allowed, HTTP status code ""403 Forbidden"" should be returned including additional error information in the response body (in the ""ProblemDetails"" element).
If the resource does not exist, e.g. the attribute to be modified cannot be found, HTTP status code ""404 Not Found"" should be returned including additional error information in the response body (in the ""ProblemDetails"" element).
2d.	On redirection, the appropriate HTTP status code (e.g. ""307 Temporary Redirect"") shall be returned. A RedirectResponse IE may be included in the payload body of PATCH response, as specified in table 6.1.3.3.3.1-3.",TS 29.540,5.2.2.2.3,all_images/image_946.png,Modify UE Context in SMSF using HTTP PATCH Method
"Figure 6.1.3.1-1: Resource URI structure of the nudsf-dr API
Table 6.1.3.1-1 provides an overview of the resources and applicable HTTP methods.
Table 6.1.3.1-1: Resources and methods overview",TS 29.598,6.1.3.1,all_images/image_947.jpeg,Resource URI structure of the nudsf-dr API
"Figure 7.5.13.2.2.5-1 shows an example message sequence chart for an CS network originating Session Setup with ISUP, where IMS CAT is provided by early session model.
Figure 7.5.13.2.2.5-1: CS Network Originating Session with Early Session SDP, ISUP (message sequence chart)
Figure 7.5.13.2.2.5-2 shows an example message sequence chart for an CS network originating Session Setup with BICC, where IMS CAT is provided by early session model.
Figure 7.5.13.2.2.5-2: CS Network Originating Session with Early Session SDP, BICC (message sequence chart)",TS 29.163,7.5.13.2.2.5,all_images/image_948.png,"CS Network Originating Session with Early Session SDP, ISUP (message"
"Figure 7.5.13.2.2.5-1 shows an example message sequence chart for an CS network originating Session Setup with ISUP, where IMS CAT is provided by early session model.
Figure 7.5.13.2.2.5-1: CS Network Originating Session with Early Session SDP, ISUP (message sequence chart)
Figure 7.5.13.2.2.5-2 shows an example message sequence chart for an CS network originating Session Setup with BICC, where IMS CAT is provided by early session model.
Figure 7.5.13.2.2.5-2: CS Network Originating Session with Early Session SDP, BICC (message sequence chart)",TS 29.163,7.5.13.2.2.5,all_images/image_949.jpeg,"CS Network Originating Session with Early Session SDP, BICC (message"
"The procedure for SMF to map network slice information into Network Instance is shown in Figure 6.106.86.86.8.2-1.
Figure 6.3.2-1: Procedures for SMF to map network slice information into Network Instance
1.	Pre-configure the mapping between the network slice information and the Network Instance on SMF.
2.	SMF sends the Network Instance from which the network slice can be derived to UPF via PFCP Session Establishment/Modification Request message.
3.	Upon receiving above message, UPF use the information in the Network Instance for traffic detection and routing as the same as required by network slice, so as to achieve multiple network slice sharing.
4.	UPF send PFCP Session Establishment/Modification Response message to SMF.",TR 29.820,6.3.2,all_images/image_952.jpeg,Procedures for SMF to map network slice information into Network Instance
"The end to end signalling flow in this clause is for information. For the procedure described below, it is a prerequisite that the UE is already registered into the 5GC, and both SMF and UPF support L2TP feature.
NOTE 1:	The scenario where the UE sends actual PPP frames/signaling towards the LAC, which involves back and forth message exchanges between the UE and LAC, for example, for LCP Negotiation is not in scope. The UE may send any such LCP-based information or authentication information (authentication protocol supported by the UE, that is, PAP/CHAP, and credentials such as username/password) to the SMF via the PCO.
NOTE 2:	The description is based on L2TP version 2, which is widely deployed in the network.
NOTE 3:	Similar end to end signalling flow applies for a PDN connection creation procedure when the UE is registered in EPS and request to establish a PDN connection towards a Packet Data Network requiring L2TP support.
Figure 6.8.4-1: Detailed L2TP Signalling for Tunnel/Session Setup
1.	The SMF receives a PDU session establishment request from the UE.
The UE may include additional (protocol) data (e.g. configuration parameters, error codes or messages/events) associated with an external protocol or an application in the PCO, e.g. the authentication information for PAP and/or CHAP, IPCP/PPP information to request DNS and NBNS Server. The CP Function may optionally be locally configured with the UE authentication information for a given DNN/APN.
The SMF may determine that an L2TP session is required for the PDU session based on local configuration (e.g. DNN/S-NSSAI). The SMF may retrieve the L2TP Tunnel parameters from external servers such as RADIUS/Diameter/AAA server, as described in step 2 below, or be configured locally.
The L2TP Tunnel parameters include the LNS Ipv4/Ipv6 address, LNS hostname, Tunnel Password, Tunnel Assignment ID, Tunnel Private Group ID.
Based on operator configuration, the Calling Number and the Called Number values may be configured to take the form of IMSI/MSISDN and APN Name, respectively.

The Tunnel Assignment ID is used to indicate to LAC (i.e. UP function) the particular L2TP tunnel to which a L2TP session is to be assigned, as described in clause 3.7 of IETF RFC 2868 [9] and clause 4.5.8 of IETF RFC 7155 [16]. 

NBNS server is s a server responsible for maintaining a list of mappings between NetBIOS computer names and network addresses for a network that uses NetBIOS as its naming service.
2.	The SMF may retrieve the L2TP Tunnel Parameters from the RADIUS/Diameter/AAA Server by sending a ""Access Request"" message or ""Diameter EAP Request (DER)"" message.
The following tunnel parameters can be retrieved, based on IETF RFC 2868 [9] and IETF RFC 7155 [16]: Tunnel Password, Tunnel Assignment ID, Tunnel Private Group ID. In addition, it can also, provide the L2TP version, LNS Ipv4/Ipv6 address, LNS hostname, which can also be locally configured on the CP Function.
The Tunnel Private Group ID is used to identify the session as belonging to a group that should receive some specific handling in the LNS. The Tunnel Assignment ID (TAID) is used to select an L2TP tunnel and have all the sessions created with the same TAID value in the same L2TP tunnel, and sessions with other Tunnel Assignment ID (TAID) value shall not be created on that tunnel.
The RADIUS/Diameter/AAA server responds with an ""Access Response"" message or ""Diameter EAP Answer (DEA)"" message, containing the L2TP parameters, such as, Tunnel Password, Tunnel Assignment ID (TAID), Tunnel Private Group ID, the L2TP version, LNS Ipv4/Ipv6 address and LNS hostname.
3.	If L2TP protocol is determined to support the PDN connection/PDU session, the SMF selects a UPF supporting L2TP and be configured with the LAC name/addresses (which may be included in response from Radius/Diameter/AAA server) and then requests the UPF to setup an L2TP session towards the L2TP server (LNS). For a given DNN/APN requiring L2TP function, multiple LACs may be configured to be connected multiple LNSs in the Data Network.  A UPF may be configured with the multiple LAC names and addresses for a given APN/DNN.
The SMF sends PFCP Session Establishment Request to the UPF, which includes L2TP Tunnel Information for setting up a L2TP tunnel and L2TP Session Information to setup a L2TP session, together with the information for authentication used during L2TP Tunnel setup, as well as for L2TP session. See clause 6.8.5.
The L2TP Tunnel Information includes Tunnel Password, Tunnel Assignment ID (TAID), Tunnel Private Group ID, the L2TP version, LNS Ipv4/Ipv6 address and LNS hostname.
The L2TP Session Information includes specific information related to the PDU session, e.g. a Calling Number which may be set to UE's SUPI, an indication to instruct that the UPF shall request the LNS to allocate an IP address for the PDU session, indications to instruct that the UPF shall request the LNS to provide DNS server addresses or NBNS server addresses, the MRU (Maximum Receive Unit) to use (based on the MTU size).
If the UE IP address should be allocated by the UPF (or the LNS), the SMF indicates this in the UE IP Address IEs in the PDRs and/or Traffic Endpoints.
4.	The UPF checks if any existing L2TP can be used to serve the PDU session according to the information provided in the L2TP Tunnel Information. 

If the UPF decides to setup a new L2TP tunnel, it initiates L2TP Tunnel establishment by sending an SCCRQ message towards the LNS, the UPF will allocate a Tunnel ID, and it may include a CHAP Challenge to authenticate the LNS. The Challenge and Challenge Response (to be included in SCCCN) is produced by the UPF using the Tunnel Password received from the SMF.
The LNS responds with an SCCRP message, containing its allocated Tunnel ID and a CHAP Challenge Response to the Challenge in SCCRQ. Optionally, the SCCRP message from the LNS may also contain a CHAP Challenge message towards the UPF, to authenticate the UPF.
The UPF then responds with a Challenge response for tunnel authentication in the SCCCN message. An L2TP Tunnel is established after the tunnel authentication is successful, with the reception of the SCCCN message sent by the UPF to the LNS.
If the UPF decides to use an already existing L2TP Tunnel for the requested PDU Session from the SMF, it proceeds with step 5 below.
See also IETF RFC 2661 [6].
5.	Once the L2TP Tunnel is established (or already present) between the UPF and the LNS for the PDU Session requested by the UE, the UPF proceeds with L2TP Session setup towards the LNS.
The UPF sends an ICRQ message towards the LNS, which contains the Tunnel ID assigned by the LNS, its assigned Session ID, and optionally, the Calling Number and Called Number. The LNS responds with an ICRP message and provides the Session ID assigned by it to the UPF.
The UPF then sends an ICCN message. The UPF includes the UE authentication information from the SMF received via PCO in step 1. In addition, the UPF (LAC) will act as a PPP endpoint to use LCP to communicate some link control parameters, e.g. MRU; to use PAP/CHAP to perform an authentication procedure; to use IPCP to request PDU Session IP Address, DNS and/or NBNS server address(es).
If proxy authentication is employed, the same ICCN message also provides the Proxy Authen Type and corresponding proxy authentication information to the LNS. This authentication information includes the fields of Proxy Authen Name, Proxy Authen Challenge, Proxy Authen ID and Proxy Authen Response.
If proxy authentication is successful, a success will be returned.
Otherwise, after the reception of the ICCN message, the LNS responds with a ZLB Ack Message. After the reception of ZLB Ack message, the LAC and LNS will use PPP LCP to communicate link specific control parameter, and indicate Authentication type, then either PPP PAP/CHAP takes place. The PPP IPCP transactions takes places to retrieve UE IP Address and/or DNS and/or NBNS server address.
Note:	In case the SMF sends a challenge and response for CHAP authentication, but, the LNS requires PAP, the L2TP session setup will fail, since the information required to perform PAP authentication is not available. If the UE sends PAP information, but, the LNS requires CHAP, the password sent by the UE can be used for CHAP authentication.
See also IETF RFC 2661 [6].
6.	The status of the L2TP session setup is sent by the UPF to the SMF in a PFCP Session Establishment Response.
7.	The SMF sends a PDU Session Establishment Response to the UE and the user data session is initiated, which contains the DNS and NBNS Server information.",TR 29.820,6.8.4,all_images/image_953.jpeg,Detailed L2TP Signalling for Tunnel/Session Setup
"The procedure for UPF to support multi-slice sharing is showed in Figure 6.9.2-1.
Figure 6.9.2-1: Procedures for the method that UPF supports multi-slice sharing
1.	Pre-configure supported slice information in UPF.
2.	[Optional] Nnrf_NFManagement_NFRegister_request procedure as in clause 4.17.1 of TS 23.502, carrying supported slice ID.
3.	UE Registration procedure as in clause 4.2.2.2.2 of TS 23.502.
4.	PDU Session Establishment Request procedure as in clause 4.3.2.2.1 of TS 23.502.
5.	AMF searches for and selects a suitable SMF in NRF combining DNN, location, slice identification and other information, as specified in clause 4.3.2.2.1 of TS 23.502.
6.	PDU Session Establishment request procedure as in 4.3.2.2.1 of TS 23.502.
7.	SMF retrieves the user subscription data from the UDM, as specified in clause 4.3.2.2.1 of TS 23.502.
8.	[Optional] SMF searches for the appropriate UPF according to DNN, location information and also supported slice ID from NRF, as the procedure in clause 4.17.4 of TS 23.502.
9.	SMF selects a UPF based on DNN, slice identification, location and other information, as specified in clause 4.3.2.2.1 of TS 23.502.
10.	SMF sends a PFCP Session Establishment request with the slice ID to UPF, as the procedure in clause 4.3.2.2.1 in TS 23.502.
11.	UPF performs corresponding resource allocation (e.g. GTP tunnel resources, CPU resources, etc) and subsequent slice isolation according to the received Network Instance ID, Pool ID (if received) and Network slice ID (i.e. S-NSSAI IE).
12.	UPF returns PFCP Session Establishment response to SMF as in clause 4.3.2.2.1 in TS 23.502.
13.	PDU session establishment procedures, as specified in clause 4.3.2.2.1 of TS 23.502.",TR 29.820,6.9.2,all_images/image_954.jpeg,Procedures for the method that UPF supports multi-slice sharing
"Figure 5.2.1-1: Resource URI sub-level structure for subscription data
Figure 5.2.1-2: Resource URI sub-level structure for subscription data (cont.)
Figure 5.2.1-3: Resource URI sub-level structure for subscription data (cont.)
Table 5.2.1-1 provides an overview of the resources, applicable HTTP methods and whether subscribe (implicit and explicit) to be notified about data change applies.
Table 5.2.1-1: Resources and methods overview",TS 29.505,5.2.1,all_images/image_955.jpeg,Resource URI sub-level structure for subscription data (cont.)
"This Key Issue explains modifications and enhancements needed for SBI-based SM MT, compared to the SM MT in 3GPP TS 23.040 [2]. As showed in the figure 5.1-1, this key issue includes:
-	Fundamental procedures of SBI-based SM MT within SMS, including:
-	Procedures for SBI-based MT Message Transfer;
-	Other SM MT procedures in 3GPP TS 23.040 [2] which are infected by SBI-based SM MT.
-	Node functionality enhancements needed for SBI-based SM MT, including:
-	Enhancements of SMS-GMSC;
-	Enhancements of SMS Router;
-	Enhancements of IP-SM-GW;
-	Enhancements of SMSF;
-	Enhancements of UDM;
-	Enhancements of NRF;
-	Enhancements of other related node functionalities.
-	Interface enhancements for SBI-based SM MT, including:
-	Interface 2: Interface between SMS-GMSC and UDM;
-	Interface 3: Interface between SMS-GMSC and SMSF;
-	Interface 3a: Interface between SMS-GMSC and SMS Router;
-	Interface 3b: Interface between SMS Router and SMSF;
-	Interface 4: Interface between SMS-GMSC and IP-SM-GW;
-	Interface 5: Interface between IP-SM-GW and SMSF;
-	Interface 6: Interface between UDM and SMS Router;
-	Interface 7: Interface between UDM and IP-SM-GW;
-	Interface between NRFs in source and target PLMNs;
-	Other related interfaces;
-	Routing rules for SM MT.
Figure 5.1-1: Message transfer architecture for SM MT",TR 29.829,5.1,all_images/image_956.png,Message transfer architecture for SM MT
"A new service Nsmsf_SMSDelivery is defined, to be exposed by SMSF and registered in NRF, in order to deliver MT SMS to SMSF, or to transfer the MO SMS Delivery Report to SMSF, as depicted in Figure 6.1.2-1.
Figure 6.1.2-1 MT SMS Delivery or MO SMS Delivery Report via the Nsmsf_SMSDelivery service
Another new service Nrouter_SMSDelivery is defined, to be exposed by SMS Router and registered in NRF, in order to enable the transfer of MT SMS Delivery to SMS Router, as depicted in Figure 6.1.2-2.
Figure 6.1.2-2 MT SMS Delivery via the Nrouter_SMSDelivery service
Another new service Nrouter_SMSSubmit is defined, to be exposed by SMS Router and registered in NRF, in order to enable the transfer of MT SMS Delivery Report to SMS Router, as depicted in Figure 6.1.2-3.
Figure 6.1.2-3 MT SMS Delivery Report via the Nrouter_SMSSubmit service
Another new service Nudm_SmsRoutingInfo is defined, to be exposed by UDM and registered in NRF, in order to enable NF service consumer to get routing information from UDM, as depicted in Figure 6.1.2-4.
Figure 6.1.2-4 Routing information offered by the Nudm_SmsRoutingInfo service
Another new service Nrouter_SmsRoutingInfo is defined, to be exposed by SMS-Router and registered in NRF, in order to enable NF service consumer to get routing information from SMS Router, as depicted in Figure 6.1.2-5.
Figure 6.1.2-5 Routing information offered by the Nrouter_SmsRoutingInfo service
Another new service Nudm_SmDeliveryReportStatus is defined, to be exposed by UDM and registered in NRF, in order to enable the update of MT SMS Delivery Report Status to UDM, as depicted in Figure 6.1.2-6.
Figure 6.1.2-6 MT SMS Delivery Report status update via the Nudm_SmDeliveryReportStatus
The procedure for successful SBI-based MT SMS message transfer is showed in Figure 6.1.2-7 and Figure 6.1.2-8, which is based on MT SMS procedures in 3GPP TS 23.040 [2] clause 10. Compared to procedures in 3GPP TS 23.040 [2], service providers register services in NRF, including:
-	Nudm_SmsRoutingInfo service provided by UDM.
-	Nrouter_SmsRoutingInfo service provided by SMS Router.
-	Nrouter_SMSSubmit service provided by SMS Router.
-	Nrouter_SMSDelivery service provided by SMS Router.
-	Nsmsf_SMSDelivery service provided by SMSF.
-	Nsc_SMSSubmit service provided by SMS-GMSC (as defined in Solution#2 TR29.829).
At the same time, service consumers discover services from NRF, including:
-	SMS-GMSC discovers Nudm_SmsRoutingInfo service from NRF.
-	SMS-GMSC discovers Nrouter_SmsRoutingInfo service from NRF.
-	SMS-GMSC discovers Nsmsf_SMSDelivery service from NRF.
-	SMS-GMSC discovers Nrouter_SMSDelivery service from NRF.
-	SMS Router discovers Nudm_SmsRoutingInfo service from NRF.
-	SMS Router discovers Nsmsf_SMSDelivery service from NRF.
-	SMS Router discovers Nsc_SMSSubmit service from NRF.
-	UDM discovers Nrouter_SmsRoutingInfo service from NRF.
-	SMSF discovers Nrouter_SMSSubmit service from NRF.
-	SMSF discovers Nsc_SMSSubmit service from NRF.
Figure 6.1.2-7: Procedures for successful SBI-based MT SMS message transfer (with SMS Router)
0	SMSF registers Nsmsf_SMSDelivery service in NRF, UDM registers Nudm_SmsRoutingInfo and Nudm_SmDeliveryReportStatus service in NRF, SMS-GMSC registers Nsc_SMSSubmit service in NRF, SMS Router registers Nrouter_SmsRoutingInfo service, Nrouter_SMSSubmit service and Nrouter_SMSDelivery service in NRF.
1	Message Transfer from SC to SMS-GMSC.
If SMS-GMSC has retrieved and stored Routing Information of this UE during the former MT SMS deliveries, or if Routing Information for the UE has been preconfigured in SMS-GMSC, steps 2a-2o and step 3 can be skipped.
2a-2f	Alternative 1: the SMS-GMSC discovers and selects Nudm_SmsRoutingInfo to retrieve the routing information of the UE to be able to send the MT SM from UDM. The UDM discovers and selects Nrouter_SmsRoutingInfo to retrieve the address of the SMS Router to receive the MT SM, the UDM also provides the SMSF instance to the SMS Router. Then the SMS Router provides its address to the UDM to receive the MT SM. UDM provides the received address to the SMS-GMSC.
2g-2o	Alternative 2: the SMS-GMSC discovers and selects Nudm_SmsRoutingInfo to retrieve the routing information of the UE to be able to send the MT SM from UDM. The UDM responses the message with 3xx redirection, the URI of the SMS Router is included location header. After that, SMS-GMSC discovers and selects Nrouter_SmsRoutingInfo to retrieve the address of the SMS Router to receive the MT SM, and the SMS Router queries the UDM by invoking the Nudm_SmsRoutingInfo to retrieve the SMSF instance. The SMS Router/IP-SM-GW provides address to the SMS-GMSC to receive the MT SM.
3	SMS-GMSC discovers Nrouter_SMSDelivery service from NRF.
4	SMS-GMSC to SMS Router: Nrouter_SMSDelivery service request, and MT SMS message transfer.
5	SMS Router to SMS-GMSC: Nrouter_SMSDelivery service resoponse.
6	SMS Router discovers Nsmsf_SMSDelivery service from NRF.
7	SMS Router to SMSF: Nsmsf_SMSDelivery service request, and MT SMS message transfer.
8	SMSF to SMS Router: Nsmsf_SMSDelivery service resoponse.
9	SMSF transfers message to UE.
10	SMSF to SMS Router: Nrouter_SMSSubmit service request, and transfer MT SMS Delivery Report.
11	SMS Router to SMSF: Nrouter_SMSSubmit service response.
12	SMS Router to SMS-GMSC: Nsc_SMSSubmit service request, and transfer MT SMS Delivery Report.
13	SMS-GMSC to SMS Router: Nsc_SMSSubmit service response.
14	SMS-GMSC updates SM-Delivery Report Status to UDM by invoking Nudm_SmDeliveryReportStatus.
15	UDM responses SM-Delivery Report Status update to SMS-GMSC.
16	SMS-GMSC sends Delivery Report to SC.
Figure 6.1.2-8: Procedures for successful SBI-based MT SMS message transfer (without SMS Router)
0	SMSF registers Nsmsf_SMSDelivery service in NRF, UDM registers Nudm_SmsRoutingInfo and Nudm_SmDeliveryReportStatus service in NRF, SMS-GMSC registers Nsc_SMSSubmit service in NRF.
If SMS-GMSC has retrieved and stored Routing Information of this UE during the former MT SMS deliveries, or if Routing Information for the UE has been preconfigured in SMS-GMSC, steps 2-5 can be skipped.
1	Message Transfer from SC to SMS-GMSC.
2	SMS-GMSC discovers and chooses Nudm_SmsRoutingInfo service from NRF.
3	SMS-GMSC to UDM: Nudm_SmsRoutingInfo service request.
4	UDM to SMS-GMSC: Nudm_SmsRoutingInfo service response.
5	SMS-GMSC discovers and chooses Nsmsf_SMSDelivery service from NRF.
6	SMS-GMSC to SMSF: Nsmsf_SMSDelivery service request, and forwards short message to SMSF directly.
7	SMSF to SMS-GMSC: Nsmsf_SMSDelivery service response.
8	SMSF transfers message to UE.
9	SMSF discovers and chooses Nsc_SMSSubmit service from NRF
10	SMSF to SMS-GMSC: Nsc_SMSSubmit service request, and transfer MT SMS Delivery Report.
11	SMS-GMSC to SMSF: Nsc_SMSSubmit service response.
12	SMS-GMSC updates SM-Delivery Report Status to UDM by invoking Nudm_SmDeliveryReportStatus.
13	UDM responses SM-Delivery Report Status update to SMS-GMSC.
14	SMS-GMSC sends Delivery Report to SC.
Note:	Nsc_SMSSubmit service for MT SMS Delivery Report is defined in Solution#2 TR29.829.
SMS-GMSC selects UDM based on the GPSI of the UE, and UDM can choose the right SMS route information based on the GPSI.
For the inter PLMN case, NF service provider registers corresponding services in the NRF of the PLMN where it is located, and NF service consumer discovers and invokes inter-PLMN services following the procedures in clause 5.2.2 of 3GPP TS 29.510 [10] and solution#3 in TR 29.829.",TR 29.829,6.1.2,all_images/image_957.png,Procedures for successful SBI-based MT SMS message transfer (with SMS Router)
"A new service Nsmsf_SMSDelivery is defined, to be exposed by SMSF and registered in NRF, in order to deliver MT SMS to SMSF, or to transfer the MO SMS Delivery Report to SMSF, as depicted in Figure 6.1.2-1.
Figure 6.1.2-1 MT SMS Delivery or MO SMS Delivery Report via the Nsmsf_SMSDelivery service
Another new service Nrouter_SMSDelivery is defined, to be exposed by SMS Router and registered in NRF, in order to enable the transfer of MT SMS Delivery to SMS Router, as depicted in Figure 6.1.2-2.
Figure 6.1.2-2 MT SMS Delivery via the Nrouter_SMSDelivery service
Another new service Nrouter_SMSSubmit is defined, to be exposed by SMS Router and registered in NRF, in order to enable the transfer of MT SMS Delivery Report to SMS Router, as depicted in Figure 6.1.2-3.
Figure 6.1.2-3 MT SMS Delivery Report via the Nrouter_SMSSubmit service
Another new service Nudm_SmsRoutingInfo is defined, to be exposed by UDM and registered in NRF, in order to enable NF service consumer to get routing information from UDM, as depicted in Figure 6.1.2-4.
Figure 6.1.2-4 Routing information offered by the Nudm_SmsRoutingInfo service
Another new service Nrouter_SmsRoutingInfo is defined, to be exposed by SMS-Router and registered in NRF, in order to enable NF service consumer to get routing information from SMS Router, as depicted in Figure 6.1.2-5.
Figure 6.1.2-5 Routing information offered by the Nrouter_SmsRoutingInfo service
Another new service Nudm_SmDeliveryReportStatus is defined, to be exposed by UDM and registered in NRF, in order to enable the update of MT SMS Delivery Report Status to UDM, as depicted in Figure 6.1.2-6.
Figure 6.1.2-6 MT SMS Delivery Report status update via the Nudm_SmDeliveryReportStatus
The procedure for successful SBI-based MT SMS message transfer is showed in Figure 6.1.2-7 and Figure 6.1.2-8, which is based on MT SMS procedures in 3GPP TS 23.040 [2] clause 10. Compared to procedures in 3GPP TS 23.040 [2], service providers register services in NRF, including:
-	Nudm_SmsRoutingInfo service provided by UDM.
-	Nrouter_SmsRoutingInfo service provided by SMS Router.
-	Nrouter_SMSSubmit service provided by SMS Router.
-	Nrouter_SMSDelivery service provided by SMS Router.
-	Nsmsf_SMSDelivery service provided by SMSF.
-	Nsc_SMSSubmit service provided by SMS-GMSC (as defined in Solution#2 TR29.829).
At the same time, service consumers discover services from NRF, including:
-	SMS-GMSC discovers Nudm_SmsRoutingInfo service from NRF.
-	SMS-GMSC discovers Nrouter_SmsRoutingInfo service from NRF.
-	SMS-GMSC discovers Nsmsf_SMSDelivery service from NRF.
-	SMS-GMSC discovers Nrouter_SMSDelivery service from NRF.
-	SMS Router discovers Nudm_SmsRoutingInfo service from NRF.
-	SMS Router discovers Nsmsf_SMSDelivery service from NRF.
-	SMS Router discovers Nsc_SMSSubmit service from NRF.
-	UDM discovers Nrouter_SmsRoutingInfo service from NRF.
-	SMSF discovers Nrouter_SMSSubmit service from NRF.
-	SMSF discovers Nsc_SMSSubmit service from NRF.
Figure 6.1.2-7: Procedures for successful SBI-based MT SMS message transfer (with SMS Router)
0	SMSF registers Nsmsf_SMSDelivery service in NRF, UDM registers Nudm_SmsRoutingInfo and Nudm_SmDeliveryReportStatus service in NRF, SMS-GMSC registers Nsc_SMSSubmit service in NRF, SMS Router registers Nrouter_SmsRoutingInfo service, Nrouter_SMSSubmit service and Nrouter_SMSDelivery service in NRF.
1	Message Transfer from SC to SMS-GMSC.
If SMS-GMSC has retrieved and stored Routing Information of this UE during the former MT SMS deliveries, or if Routing Information for the UE has been preconfigured in SMS-GMSC, steps 2a-2o and step 3 can be skipped.
2a-2f	Alternative 1: the SMS-GMSC discovers and selects Nudm_SmsRoutingInfo to retrieve the routing information of the UE to be able to send the MT SM from UDM. The UDM discovers and selects Nrouter_SmsRoutingInfo to retrieve the address of the SMS Router to receive the MT SM, the UDM also provides the SMSF instance to the SMS Router. Then the SMS Router provides its address to the UDM to receive the MT SM. UDM provides the received address to the SMS-GMSC.
2g-2o	Alternative 2: the SMS-GMSC discovers and selects Nudm_SmsRoutingInfo to retrieve the routing information of the UE to be able to send the MT SM from UDM. The UDM responses the message with 3xx redirection, the URI of the SMS Router is included location header. After that, SMS-GMSC discovers and selects Nrouter_SmsRoutingInfo to retrieve the address of the SMS Router to receive the MT SM, and the SMS Router queries the UDM by invoking the Nudm_SmsRoutingInfo to retrieve the SMSF instance. The SMS Router/IP-SM-GW provides address to the SMS-GMSC to receive the MT SM.
3	SMS-GMSC discovers Nrouter_SMSDelivery service from NRF.
4	SMS-GMSC to SMS Router: Nrouter_SMSDelivery service request, and MT SMS message transfer.
5	SMS Router to SMS-GMSC: Nrouter_SMSDelivery service resoponse.
6	SMS Router discovers Nsmsf_SMSDelivery service from NRF.
7	SMS Router to SMSF: Nsmsf_SMSDelivery service request, and MT SMS message transfer.
8	SMSF to SMS Router: Nsmsf_SMSDelivery service resoponse.
9	SMSF transfers message to UE.
10	SMSF to SMS Router: Nrouter_SMSSubmit service request, and transfer MT SMS Delivery Report.
11	SMS Router to SMSF: Nrouter_SMSSubmit service response.
12	SMS Router to SMS-GMSC: Nsc_SMSSubmit service request, and transfer MT SMS Delivery Report.
13	SMS-GMSC to SMS Router: Nsc_SMSSubmit service response.
14	SMS-GMSC updates SM-Delivery Report Status to UDM by invoking Nudm_SmDeliveryReportStatus.
15	UDM responses SM-Delivery Report Status update to SMS-GMSC.
16	SMS-GMSC sends Delivery Report to SC.
Figure 6.1.2-8: Procedures for successful SBI-based MT SMS message transfer (without SMS Router)
0	SMSF registers Nsmsf_SMSDelivery service in NRF, UDM registers Nudm_SmsRoutingInfo and Nudm_SmDeliveryReportStatus service in NRF, SMS-GMSC registers Nsc_SMSSubmit service in NRF.
If SMS-GMSC has retrieved and stored Routing Information of this UE during the former MT SMS deliveries, or if Routing Information for the UE has been preconfigured in SMS-GMSC, steps 2-5 can be skipped.
1	Message Transfer from SC to SMS-GMSC.
2	SMS-GMSC discovers and chooses Nudm_SmsRoutingInfo service from NRF.
3	SMS-GMSC to UDM: Nudm_SmsRoutingInfo service request.
4	UDM to SMS-GMSC: Nudm_SmsRoutingInfo service response.
5	SMS-GMSC discovers and chooses Nsmsf_SMSDelivery service from NRF.
6	SMS-GMSC to SMSF: Nsmsf_SMSDelivery service request, and forwards short message to SMSF directly.
7	SMSF to SMS-GMSC: Nsmsf_SMSDelivery service response.
8	SMSF transfers message to UE.
9	SMSF discovers and chooses Nsc_SMSSubmit service from NRF
10	SMSF to SMS-GMSC: Nsc_SMSSubmit service request, and transfer MT SMS Delivery Report.
11	SMS-GMSC to SMSF: Nsc_SMSSubmit service response.
12	SMS-GMSC updates SM-Delivery Report Status to UDM by invoking Nudm_SmDeliveryReportStatus.
13	UDM responses SM-Delivery Report Status update to SMS-GMSC.
14	SMS-GMSC sends Delivery Report to SC.
Note:	Nsc_SMSSubmit service for MT SMS Delivery Report is defined in Solution#2 TR29.829.
SMS-GMSC selects UDM based on the GPSI of the UE, and UDM can choose the right SMS route information based on the GPSI.
For the inter PLMN case, NF service provider registers corresponding services in the NRF of the PLMN where it is located, and NF service consumer discovers and invokes inter-PLMN services following the procedures in clause 5.2.2 of 3GPP TS 29.510 [10] and solution#3 in TR 29.829.",TR 29.829,6.1.2,all_images/image_958.jpeg,Procedures for successful SBI-based MT SMS message transfer (without SMS Router)
"A new service Nsc_SMSSubmit is defined, to be exposed by SMS-IWMSC/SMS-GMSC and registered in NRF, in order to submit the MO SMS to SMS-IWMSC/SMS-GMSC, or to transfer the MT SMS Delivery Report to SMS-GMSC.
Figure 6.2.2-1 MO SMS Submit or MT SMS Delivery Report via the Nsc_SMSSubmit service
The procedure for successful SBI-based MO SMS message submit and MT SMS Delivery Report is showed in Figure 6.2.2-2, which is based on SMS procedures in 3GPP TS 23.040 [2] clause 10.2. Compared to procedures in 3GPP TS 23.040 [2], service providers register services in NRF, including:
-	Nsc_SMSSubmit service provided by SMS-IWMSC/SMS-GMSC.
-	Nsmsf_SMSDelivery service provided by SMSF (as defined in Solution#1 TR29.829).
At the same time, service consumers discover services from NRF, including:
-	SMSF discovers Nsc_SMSSubmit service from NRF.
-	SMS-IWMSC discovers Nsmsf_SMSDelivery service from NRF.
Figure 6.2.2-2: Procedures for successful SBI-based SM MO message transfer
0	SMS-IWMSC registers Nsc_SMSSubmit service in NRF, SMSF registers Nsmsf_SMSDelivery service in NRF.
1	Message Transfer from UE to SMSF through AMF.
2	SMSF discovers and chooses Nsc_SMSSubmit service for MO SMS submit from NRF.
3	SMSF to SMS-IWMSC: Nsc_SMSSubmit service request, and forwards MO SMS to SMS-IWMSC.
4	SMS-IWMSC to SMSF: Nsc_SMSSubmit service response.
5	SMS-IWMSC transfers message to SC.
6	Delivery Report from SC to SMS-IWMSC.
7	SMS-IWMSC discovers and chooses Nsmsf_SMSDelivery service for MO SMS Delivery Report from NRF.
8	SMS-IWMSC to SMSF: Nsmsf_SMSDelivery service request, and transfer MO SMS Delivery Report.
9	SMSF to SMS-IWMSC: Nsmsf_SMSDelivery service response.
10	Delivery Report from SMSF to UE.
Note:	Nsmsf_SMSDelivery service for MO SMS Delivery Report is defined in Solution#1 TR29.829.
SMSF can choose the right SMS-IWMSC base on SUPI/SUCI of the UE, if SMS-IWMSC locates in a different PLMN, SMSF can find the right SMS-IWMSC through vNRF and hNRF.
For the inter PLMN case, NF service provider registers corresponding services in the NRF of the PLMN where it is located, and NF service consumer discovers and invokes inter-PLMN services following the procedures in clause 5.2.2 of 3GPP TS 29.510 [10] and solution#3 in TR 29.829.",TR 29.829,6.2.2,all_images/image_959.jpeg,Procedures for successful SBI-based SM MO message transfer
"A new service Nnef_SMService_MoForwardSm is defined, to be exposed by NEF and registered in NRF, in order to submit the MO SMS to AF.
Figure 6.2.4-1 MSISDN-less MO SMS Submit via the Nnef_SMService_MoForwardSm service
The procedure for SBI-based MSISDN-less MO SMS message transfer is showed in Figure 6.2.4-2, which is based on MSISDN-less MO SMS procedure via Nnef in 3GPP TS 23.502 [4] clause 4.13.7.2. Compared to procedures in 3GPP TS 23.502 [4], service providers register services in NRF, including:
-	Nnef_SMService_MoForwardSm service provided by NEF.
At the same time, service consumers discover services from NRF, including:
-	SMS-SC discovers Nnef_SMService_MoForwardSm service from NRF.
Figure 6.2.4-2: Procedures for MSISDN-less MO SMS message transfer
0	NEF registers Nnef_SMService_MoForwardSm service in NRF, during the NF registration procedure.
1	MO SMS transmit from UE to SMS-SC, as already defined in clause 6.2.2.
2a-2b	SMS-SC discovers and chooses Nnef_SMService_MoForwardSm service for MSISDN-less MO SMS submit from NRF.
3	SMS-SC forwards MO SM to NEF, by invoking Nnef_SMService_MoForwardSm service.
4-5	Nudm_SDM_Get and response between NEF and UDM, which refers to Step3-Step4 of Figure 4.13.7.2-1 in TS 23.502 [4].
6	The NEF provides a Nnef_MSISDN-less_MO_SMSNotify, which refers to Step5 of Figure 4.13.7.2-1 in TS 23.502 [4].
7	NEF sends Nnef_SMService_MoForwardSm response to SMS-SC, carrying a success or failure delivery indication to SMS-SC.
8	SMS-SC indicates success/failure back to UE using existing SBI-based SMS delivery report defined in clause 6.2.2.",TR 29.829,6.2.4,all_images/image_960.jpeg,Procedures for MSISDN-less MO SMS message transfer
"This solution is to address Key Issue #1 ""SBI-based SM MT message transfer"". Introduce the solution for successful SM MT message transfer based on SBI in 5GC.
Figure 6.4.1-1 (copied from TS 3GPP 23.502 [4] clause 4.13.3.6) below is the baseline procedure of MT SM over NAS from TS 3GPP 23.502 [4]. We can observe that the interfaces between SMSF and SMS-GMSC, SMS-GMSC and UDM are still based on legacy protocol. This solution targets to provide the new SBI-based interfaces between the SMSF and the SMS-GMSC, the SMS-GMSC and the UDM, and route based on SBI for successful MT SM transfer including transfer of MT SM and transfer of the report for MT SM.
Figure 6.4.1-1: MT SM over NAS in CM_IDLE state via 3GPP access",TR 29.829,6.4.1,all_images/image_961.jpeg,MT SM over NAS in CM_IDLE state via 3GPP access
"This solution is to address Key Issue #1 ""SBI-based SM MT message transfer"". Current procedure of MT SM transfer via SMS Router/IP-SM-GW is shown in Figure 6.6.1-1, interfaces between SMS-GMSC and UDM, UDM/SMSF and SMS Router/IP-SM-GW are still based on legacy protocol. This solution introduces a successful SM MT message transfer based on SBI in 5GC with SMS Router/IP-SM-GW deployed, steps 2, 4 and 6 are changed to messages in SBI interfaces, and other steps will not be impacted.
Figure 6.6.1-1: Successful MT SM transfer via the SMS Router/IP-SM-GW",TR 29.829,6.6.1,all_images/image_963.jpeg,Successful MT SM transfer via the SMS Router/IP-SM-GW
"As shown in Figure 6.6.2-1, step 3 is identical to step 2 in Figure 6.6.1-1, step 5 is identical to step 4 in Figure 6.6.1-1 and step 6 is identical to step 6 in Figure 6.6.1-1. This procedure also defines the UDM/SMSF registration and discovery before sending the message.
Figure 6.6.2-1: Successful MT SM transfer via the SMS Router/IP-SM-GW based on SBI
0	The UDM registers the NF profile including the supported SUPI ranges and/or GPSI ranges in the NRF. The SMSF also registers NF profile including the IP addresses and/or the FQDNs of the NF in the NRF.
1	The SC sends the MT SM to the SMS-GMSC.
2	The SMS-GMSC invokes the Nnrf_NFDiscovery_NFDiscovery to retrieve the UDM instance that manages the user subscriptions using the GPSI/SUPI.
3a.-3d.	Alternative 1: the SMS-GMSC invokes Nudm_UECM_Get to retrieve the routing information of the UE to be able to send the MT SM from the selected UDM. The UDM invokes Nsmsrouter_SMService_Get or Nipsmgw_SMService_Get to retrieve the address of the SMS Router/IP-SM-GW to receive the MT SM, the UDM also provides the SMSF instance to the SMS Router/IP-SM-GW. The address of the SMS Router/IP-SM-GW to be contacted by the UDM may be configured locally. The SMS Router/IP-SM-GW provides address to the UDM to receive the MT SM. UDM provides the received address to the SMS-GMSC.
3e.-3j.	Alternative 2: the SMS-GMSC invokes Nudm_UECM_Get to retrieve the routing information of the UE to be able to send the MT SM from the selected UDM, UDM responses the message with 3xx redirection, the URI of the SMS Router/IP-SM-GW is included location header. After that, the SMS-GMSC invokes Nsmsrouter_SMService_Get or Nipsmgw_SMService_Get to retrieve the address of the SMS Router/IP-SM-GW to receive the MT SM, and the SMS Router/IP-SM-GW queries the UDM by invoking the Nudm_UECM_Get to retrieve the SMSF instance. The SMS Router/IP-SM-GW provides address to the SMS-GMSC to receive the MT SM.
4	The SMS-GMSC sends the MT SM to SMS Router/IP-SM-GW.
5	The SMS Router/IP-SM-GW invokes the Nnrf_NFDiscovery_NFDiscovery to retrieve the IP addresses or FQDNs of the serving SMSF of the UE based on the SMSF instance received in step 3b.
6a.	The SMS Router/IP-SM-GW sends the MT SM records to the SMSF.
6b and 6c.	The SMSF responses SMS Router/IP-SM-GW for the receiving of the MT SM records and sends delivery report to the SMS Router/IP-SM-GW later – alternative 1.
6c.	The SMSF responses SMS Router/IP-SM-GW with the delivery report included – alternative 2.",TR 29.829,6.6.2,all_images/image_964.jpeg,Successful MT SM transfer via the SMS Router/IP-SM-GW based on SBI
"When the SMS-GMSC receives the failure that the UE memory for SMS is exceeded and the SMS-GMSC decided reattempting the delivery of the MT SM, the SMS-GMSC subscribes to the event ""UE_MEMORY_AVAILABLE_FOR_SMS"" provided by the network, and the network shall notify the SMS-GMSC when the event happened.
To support the subscription and notification of the event ""UE_MEMORY_AVAILABLE_FOR_SMS"", the existing UDM EE subscribe and Notify service operation shall be extended to support the event. See Subscription to Notification of event occurrence service operation of UDM EE service in 3GPP TS 29.503 [7] clause 5.5.2.2.2, the specific and extended part of the service operation is described below:
In the subscription request, the event type is set to the newly added ""UE_MEMORY_AVAILABLE_FOR_SMS"", the expiry time is set to the maximum store time of MT SM in SC, the MaxNumOfReports is set to 1, and Monitoring Configuration data includes the SC address.
Event Occurrence Notification service operation of UDM EE service is described in 3GPP TS 29.503 [7] clause 5.5.2.4.2, the extended part of the service operation is that eventType indicates ""UE_MEMORY_AVAILABLE_FOR_SMS"" and the SC address is also included in the notify request.
To support the subscription and notification of the event ""UE_MEMORY_AVAILABLE_FOR_SMS"", the SMSF added a new service Nsmsf_EventExposure, and subscribe/unsubscribe/notify service operation on this new service.
When the UDM receives the EE subscription to event ""UE_MEMORY_AVAILABLE_FOR_SMS"", the UDM shall invoke the Nsmsf_EventExposure_subscribe to subscribe to the event ""UE_MEMORY_AVAILABLE_FOR_SMS"" in the SMSF, see Figure 6.9.2-1.
Figure 6.9.2-1: NF service consumer subscribes to notifications
1.	The NF service consumer (e.g. UDM) sends a POST request to the parent resource (collection of subscriptions) (.../{ueIdentity}/ee-subscriptions), to create a subscription as present in message body. The request may event type (e.g. mobile has memory available), the callbackURI to which the notification will send, the configuration related to the Event (e.g. one time event).
2a.	On success, the UDM responds with ""201 Created"" with the message body containing a representation of the created subscription. The Location HTTP header shall contain the URI of the created subscription. If the event subscription was for a group of UEs:
When the UDM decided to unsubscribe to the event ""UE_MEMORY_AVAILABLE_FOR_SMS"" for which it has subscribed previously, the UDM shall invoke the Nsmsf_EventExposure_unsubscribe to unsubscribe to the event ""UE_MEMORY_AVAILABLE_FOR_SMS"" in SMSF, see Figure 6.9.2-2.
Figure 6.9.2-2: NF service consumer unsubscribes to notifications
1.	The NF service consumer sends a DELETE request to the resource identified by the URI previously received during subscription creation.
2a.	On success, the UDM responds with ""204 No Content"".
2b.	If there is no valid subscription available (e.g. due to an unknown SubscriptionId value), HTTP status code ""404 Not Found"" shall be returned including additional error information in the response body (in the ""ProblemDetails"" element).
When SMSF received the RP-SMMA message from UE (see 3GPP 24.011 [8] clause 7.3.2), the SMSF is aware of memory available of the MS, then SMSF notifies the memory available to the consumers (e.g. UDM) which subscribes to this service. It is suggested that the SMSF adds a new service Nsmsf_EventExposure to provide subscribe/unsubscribe/notify the events related the UE (e.g. mobile has memory available). The service operation are show below.
Figure 6.9.2-3: Event Occurrence Notification
1.	The UDM sends a POST request to the callbackURI provided by the NF service consumer when subscribing to the event, the request shall include the report related to the monitored event (e.g. mobile has memory available).
2.	The NF Service Consumer responds with ""204 No Content"".",TR 29.829,6.9.2,all_images/image_966.jpeg,NF service consumer unsubscribes to notifications
"Figure 6.13.3-1: SMS termination using SMS-GMSC in the home network of SMS recipient
Figure 6.13.3-1 above shows the signalling flow for transferring the short message to a UE, through the terminating SMSC, using service-based interfaces.
0.	The originating SMSC forwards the SMS to the SMSC in the SMS recipient MSISDN's home network.
1a.	The UDM in the home network of the SMS recipient MSISDN registers with the NRF for Nudm_SmsRoutingInfo service
1a.	The SMSF registers with the NRF for Nnrf_MTForwardSM service. If the UE is roaming in a visited PLMN, the SMSF and NRF both belong to the visited PLMN
2.	When the SMSC/SMS-GMSC in the home network receives the SMS from the originating SMSC (step 0), the home SMSC/SMS-GMSC performs discovery of UDM NF profile via NRF for sending the routing information query to the UDM.
3.	The SMSC/SMS-GMSC then invokes the Nudm_SmsRoutingInfo_Get request service operation to the UDM instance discovered in step 2 for the recipient MSISDN. The UDM provides the serving SMSF information in response.
4.	The SMSC/SMS-GMSC invokes the Nnrf_NFDiscovery request to fetch SMSF profile from NRF.
5.	The SMSC/SMS-GMSC then invokes the Nsmsf_MTFormwardSM service operation to transfer the short message to the SMSF. The SMSF provides delivery report in Nsmsf_MTFormwardSM response.",TR 29.829,6.13.3,all_images/image_969.jpeg,SMS termination using SMS-GMSC in the home network of SMS recipient
"The following procedures are considered.
Figure 6.18.2-1: Procedure on SEPP evaluation taking account relationship of PLMNs
1.	NF Consumer will include the purpose, e.g. roaming, interconnect, general, test, in the request destined to another PLMN in an HTTP custom header.
2.	cSEPP will check the content HTTP custom header and evaluate whether the requested purpose of the request can be sent towards the other PLMN, based on relationship with the other network.
3a.	If the evaluation in step2 is allowed to forward, the signaling is forwarded to the pSEPP.
3b. If the evaluation in step2 is rejected due to the relationship, a response message is sent back to the NF Consumer with an appropriate HTTP status code.
4.	pSEPP will check the content HTTP custom header and evaluate whether the requested purpose of the request can be accepted from the other PLMN, based on relationship with the other network.
5a.	If the evaluation in step4 is allowed to forward, the signaling is forwarded to the pSEPP.
5b. If the evaluation in step4 is rejected due to the relationship, a response message is sent back the result to the NF Consumer with an appropriate HTTP status code.
6.	NF Producer will apply necessary procedures defined for the NF Producer.
7.	NF Producer will return",TR 29.829,6.18.2,all_images/image_970.jpeg,Procedure on SEPP evaluation taking account relationship of PLMNs
"This procedure is used by the NF service consumers (i.e. NFs, OAM and AFs) to subscribe to/unsubscribe from analytics information directly from the NWDAF, it is also used by the NWDAF to notify the observed analytics event(s) to the NF service consumer if subscribed before.
Figure 5.2.2.1-1: Analytics Subscribe/Unsubscribe/Notify initiated by 5GC NFs, OAM or AFs
1.	In order to subscribe to notification(s) of analytics information from the NWDAF, the NF service consumer invokes Nnwdaf_EventsSubscription_Subscribe service operation by sending an HTTP POST request targeting the resource ""NWDAF Events Subscriptions"". The request includes the subscribed events and may include event filter information.
In order to update the existing subscription, the NF service consumer invokes Nnwdaf_EventsSubscription_Subscribe service operation by sending an HTTP PUT request with Resource URI of the resource ""Individual NWDAF Event Subscription"".
2.	The NWDAF responds to the Nnwdaf_EventsSubscription_Subscribe service operation. Upon receipt of the HTTP POST request, if the subscription is accepted to be created, the NWDAF responds to the NF service consumer with ""201 Created"", and the URI of the created subscription is included in the Location header field.
Upon receipt of the HTTP PUT request, if the subscription is accepted to be updated, the NWDAF responds to the NF service consumer with ""200 OK"" or ""204 No Content""
3.	If the NWDAF observes the subscribed event(s), the NWDAF invokes Nnwdaf_EventsSubscription_Notify service operation to report the event(s) by sending an HTTP POST request with {notificationURI} as Notification URI.
4.	The NF service consumer sends an HTTP ""204 No Content"" response to the NWDAF.
5.	In order to unsubscribe to the notification(s) of analytics information from the NWDAF, the NF service consumer invokes Nnwdaf_EventsSubscription_Unsubscribe service operation by sending an HTTP DELETE request targeting the resource ""Individual NWDAF Event Subscription"", to the NWDAF to unsubscribe from analytics information. The request includes the event subscriptionId of the existing subscription that is to be deleted.
6.	The NWDAF responds to the Nnwdaf_EventsSubscription_Unsubscribe service operation. If the unsubscription is accepted, the NWDAF responds with ""204 No Content"".
NOTE:	For details of Nnwdaf_EventsSubscription_Subscribe/Unsubscribe/Notify service operations refer to 3GPP TS 29.520 [5].",TS 29.552,5.2.2.1,all_images/image_973.jpeg,"Analytics Subscribe/Unsubscribe/Notify initiated by 5GC NFs, OAM or AFs"
"This procedure is used by the AF to subscribe to/unsubscribe from analytics information from the NWDAF via the NEF, it is also used by the NWDAF to notify the analytics event(s) to the AF via the NEF, if subscribed before.
Figure 5.2.2.2-1: Analytics Subscribe/Unsubscribe/Notify initiated by AFs via the NEF
1.	In order to subscribe to notification(s) of analytics exposure via the NEF, the AF invokes the Nnef_AnalyticsExposure_Subscribe request by sending an HTTP POST request message targeting the resource ""Analytics Exposure Subscriptions"" as defined in clause 4.4.14.1 of 3GPP TS 29.522 [10].
In order to update an existing analytics exposure subscription, the AF shall send an HTTP PUT request message to the NEF to the resource ""Individual Analytics Exposure Subscription"" requesting to change the subscription.
2.	Upon receipt of the HTTP request from the AF, if the AF is authorized with the requested analytics event(s) and the requested parameters comply with the inbound restriction in the analytics exposure mapping, the NEF shall invoke Nnwdaf_EventsSubscription_Subscribe service operation as described in step 1 in clause 5.2.2.1.
3.	The NWDAF responds to the Nnwdaf_EventsSubscription_Subscribe service operation as described in step 2 in clause 5.2.2.1.
4.	Upon receipt of the HTTP request response from the NWDAF, the NEF shall invoke the Nnef_AnalyticsExposure_Subscribe response message by mapping and forwarding the response to the AF.
5.	If the NWDAF observes the subscribed event(s), the NWDAF invokes Nnwdaf_EventsSubscription_Notify service operation as described in step 3 in clause 5.2.2.1 to the NEF.
6.	If the NEF receives an analytics information notification from the NWDAF indicating that the subscribed analytics event has been detected, the NEF shall invoke the Nnef_AnalyticsExposure_Notify request by sending HTTP POST request message provide a notification to the AF request including the AnalyticsEventNotification data structure at least with the detected analytics event identified by the notification URI together with the notification correlation identifier received during creation of the Individual Analytics Exposure Subscription.
7.	Upon receipt of the analytics event notification, the AF shall respond the NEF with a ""204 No Content"" status code to confirm the received notification in Nnef_AnalyticsExposure_Notify response message.
8.	The NEF shall forward the HTTP ""204 No Content"" response to the NWDAF.
9.	In order to delete an existing analytics exposure subscription, the AF shall invoke the Nnef_AnalyticsExposure_Unsubscribe request by sending an HTTP DELETE request message to the NEF to the resource ""Individual Analytics Exposure Subscription"".
10.	If the NEF receives an HTTP DELETE request from the AF, the NEF shall invoke the Nnwdaf_EventsSubscription_Unsubscribe service operation as described in step 5 in clause 5.2.2.1.
11.	The NWDAF responds to the Nnwdaf_EventsSubscription_Unsubscribe service operation as described in step 6 in clause 5.2.2.1.
12.	The NEF shall forward the HTTP ""204 No Content"" response to the AF.
NOTE:	Details of AnalyticsExposure API refer to clause 4.4.14 and clause 5.6 of 3GPP TS 29.522 [4].",TS 29.552,5.2.2.2,all_images/image_974.png,Analytics Subscribe/Unsubscribe/Notify initiated by AFs via the NEF
"This procedure is used by NF service consumer(s) based on local configuration, to subscribe/unsubscribe to NWDAF analytics event(s) via the DCCF, and upon the delivery option ""Delivery via Messaging Framework "" configured on the DCCF, the 3GPP DCCF Adaptor (3da) Data Management service and 3GPP Consumer Adaptor (3ca) Data Management service of the Messaging Framework Adaptor Function (MFAF) are used to interact with the 3GPP Network and the Messaging Framework for analytics information delivery to the NF service consumer(s) subscribed notification endpoint(s).
Figure 5.2.5-1: Analytics Exposure via DCCF and Messaging Framework
1.	In order to subscribe to notification(s) of analytics exposure via the DCCF based on local configuration, the NF service consumer invokes the Ndccf_DataManagement_Subscribe service operation by sending an HTTP POST request message targeting the resource ""DCCF Analytics Subscriptions"", the HTTP POST message shall include the NdccfAnalyticsSubscription data structure as request body with parameters as defined in clause 5.1.6.2.2 of 3GPP TS 29.574 [15].
2.	Upon the delivery option ""Delivery via MFAF"" configured on the DCCF, in order to create configuration of mapping data in the MFAF, the DCCF shall invoke the Nmfaf_3daDataManagement_Configure service operation by sending an HTTP POST request message targeting the resource ""MFAF Configurations"", the HTTP POST message shall include the MfafConfiguration data structure as request body with parameters as defined in clause 5.1.6 of 3GPP TS 29.576 [17].
3.	The MFAF responds to the Nmfaf_3daDataManagement_Configure service operation.
Upon receipt of the HTTP POST request, if the configuration is accepted to be created, the MFAF responds to the DCCF with ""201 Created"", and the URI of the created configuration is included in the Location header field.
4.	The DCCF keeps track of the analytics actively being collected for the Analytics Subscription it is coordinating. The NWDAF or ADRF may register the analytics data profile (may include the analytics data collection related service operation, Analytics Specification, NWDAF ID or ADRF ID) with the DCCF. The DCCF may then determine whether certain historical analytics data may be available in the NWDAF or ADRF based on the analytics data profile and the request time window.
If the historical analytics data handling is not applicable or not supported, the DCCF shall proceed step 5a, skip step 5b step 6b, step 7b, step 5c step 6c and step 7c.
If the historical analytics data is available in an ADRF, the DCCF shall proceed step 5a and step 5b, skip step 5c, step 6c and step 7c.
If the historical data is available in an NWDAF, the DCCF shall proceed step 5a and step 5c, skip step 5b, step 6b and step 7b.
5a.	The DCCF shall determine whether the analytics data requested in step 1 are already being collected.
If the analytics data requested are already being collected by an NF service consumer, the DCCF adds the NF service consumer to the list of analytics consumers that are subscribed for these data.
If the DCCF cannot handle the subscription request, shall take the error handling as defined in clause 4.2.2.2.2 of 3GPP TS 29.574 [15]
If the DCCF determines that no subscriptions need to be created or modified (e.g. because all the data can be made available either via pre-existing subscriptions or because of the historical data handling) then step 6a and step 7a are skipped.
5aa.	The DCCF may respond to the Ndccf_DataManagement_Subscribe service operation with HTTP ""201 Created"" status code with the message body containing a representation of the created subscription if the DCCF adds the new NF service consumer to the list of NF service consumers that are subscribed, or if error case happened may respond with corresponding error information.
6a	If the requested data at step 1 are not already available yet, the DCCF shall invoke the Nnwdaf_EventsSubscription_Subscribe service operation by sending an HTTP POST request message request to the NWDAF targeting the resource ""NWDAF Events Subscriptions"" to subscribe to a new analytics exposure subscription, or if the analytics subscribed in step 1 partially matches an analytics that is already being collected by the DCCF from an NWDAF, and a modification of this subscription to the NWDAF would satisfy both the existing analytics subscriptions as well as the newly requested analytics, by sending an HTTP PUT request to the resource ""Individual Analytics Exposure Subscription"" to replace an existing analytics exposure subscription. The request includes the subscribed event(s) and event filter information received from the NF service consumer, mapping to the parameters as defined in clause 5.1 of 3GPP TS 29.520 [5].
NOTE 1:	If the NWDAF instance or NWDAF Set is not identified by the NF service consumer, the DCCF determines the NWDAF instances that can provide analytics. If the consumer requested storage of analytics in an ADRF but an ADRF ID is not provided by the NF service consumer, or the collected analytics is to be stored in an ADRF according to configuration on the DCCF, the DCCF selects an ADRF to store the collected data.
7a	The NWDAF responds to the Nnwdaf_EventsSubscription_Subscribe service operation.
Upon receipt of the HTTP POST request, if the subscription is accepted to be created, the NWDAF responds to the DCCF with ""201 Created"" status code, and the URI of the created subscription is included in the Location header field.
Upon receipt of the HTTP PUT request, if the subscription is accepted to be updated, the NWDAF responds to the DCCF with ""200 OK"" or ""204 No Content"" status code.
5b	If the historical analytics data handling is applicable, and the DCCF determine to retrieve analytics data from the ADRF, the DCCF shall determine which ADRF instances might provide the analytics.
6b	In order to retrieve the historical analytics data from the ADRF, the DCCF shall invoke the Nadrf_DataManagement_RetrievalSubscribe service operation by sending an HTTP POST request message targeting the resource ""ADRF Data Retrieval Subscriptions"", the HTTP POST message shall include the NadrfDataRetrievalSubscription data structure as request body with parameters as defined in clause 5.1.6 of 3GPP TS 29.575 [16].
7b	The ADRF responds to the Nadrf_DataManagement_RetrievalSubscribe service operation.
Upon receipt of the HTTP POST request, if the subscription is accepted to be created, the ADRF responds to the DCCF with ""201 Created"" status code, and the URI of the created subscription is included in the Location header field.
5c	If the historical data handling is applicable, and the DCCF determines to retrieve analytics data from the NWDAF, the DCCF shall determine which NWDAF instances might provide the analytics as described and proceed step 6c.
6c	In order to retrieve the historical analytics data from the NWDAF, the DCCF may invoke the Nnwdaf_EventsSubscription_Subscribe service operation by sending an HTTP POST request message targeting the resource ""NWDAF Events Subscriptions"", the HTTP POST message shall include the NnwdafEventsSubscription data structure as request body with parameters as defined in clause 5.1.6 of 3GPP TS 29.520 [5] or Nnwdaf_AnalyticsInfo_Request request by sending an HTTP GET request message targeting the resource ""NWDAF Analytics"" with parameters as defined in clause 5.2.3.2.3.1 of 3GPP TS 29.520 [5].
7c	The NWDAF responds to the Nnwdaf_EventsSubscription_Subscribe or Nnwdaf_AnalyticsInfo_Request service operation.
Upon receipt of the HTTP POST request, if the subscription is accepted to be created, the NWDAF responds to the DCCF with ""201 Created"", and the URI of the created subscription is included in the Location header field.
8.	The DCCF responds to the Ndccf_DataManagement_Subscribe service operation with HTTP ""201 Created"" status code with the message body containing a representation of the created subscription.
9a.	(conditional)When the analytics are available, the NWDAF invokes the Nnwdaf_EventsSubscription_Notify service operation by sending an HTTP POST request message to notify the analytics information to the MFAF.
10a.	The MFAF responds to the Nnwdaf_EventsSubscription_Notify service operation with HTTP ""204 No Content"" status code.
11a.	The MFAF invokes the Nmfaf_3caDataManagement_Notify service operation by sending HTTP POST request message(s) to send the analytics data to all notification endpoints indicated in step 1. Analytics data sent to notification endpoints may be processed and formatted by the MFAF so that they conform to delivery requirements for each NF service consumer and/or notification endpoint.
NOTE 2:	According to Formatting Instructions provided by the NF service consumer, multiple notifications from the NWDAF can be combined in a single Nmfaf_3caDataManagement_Notify so that many notifications from an NWDAF result in fewer notifications (or one notification) to the NF service consumer and/or the subscribed notification endpoint(s). Alternatively, a notification can instruct the analytics data notification endpoint to fetch the analytics data from the MFAF.
12a.The NF service consumer responds to the Nmfaf_3caDataManagement_Notify service operation with HTTP ""204 No Content"" status code.
9b.	(conditional)When the historical analytics data are available in the ADRF, the ADRF shall invoke the Nadrf_DataManagement_RetrievalNotify service operation by sending an HTTP POST request message to notify the historical analytics or Fetch Instructions to the MFAF.
10b.	The MFAF responds to the Nadrf_DataManagement_RetrievalNotify service operation with HTTP ""204 No Content"" status code.
11b.	The MFAF invokes the Nmfaf_3caDataManagement_Notify service operation by sending HTTP POST request message(s) to send the analytics data to all notification endpoints indicated in step 1. Analytics data sent to notification endpoints may be processed and formatted by the MFAF so that they conform to delivery requirements for each NF service consumer or notification endpoint.
NOTE 3:	According to Formatting Instructions provided by the NF service consumer, multiple notifications from an ADRF can be combined in a single Nmfaf_3caDataManagement_Notify so many notifications from an ADRF results in fewer notifications (or one notification) to the NF service consumer and/or the subscribed notification endpoint(s). Alternatively, a notification can instruct the analytics data notification endpoint to fetch the analytics data from the MFAF.
12b.The NF service consumer responds to the Nmfaf_3caDataManagement_Notify service operation with HTTP ""204 No Content"" status code.
9c.	(conditional)When the historical analytics data are available in the NWDAF, the NWDAF may invoke the Nnwdaf_EventsSubscription_Notify service operation by sending an HTTP POST request message to notify the historical analytics data to the MFAF.
10c.	The MFAF responds to the Nnwdaf_EventsSubscription_Notify service operation with HTTP ""204 No Content"" status code.
11c.	The MFAF invokes the Nmfaf_3caDataManagement_Notify service operation by sending HTTP POST request message(s) to send the analytics data to all notification endpoints indicated in step 1. Analytics data sent to notification endpoints may be processed and formatted by the MFAF so they conform to delivery requirements for each NF service consumer or notification endpoint.
NOTE 4:	According to Formatting Instructions provided by the NF service consumer, multiple notifications from a NWDAF can be combined in a single Nmfaf_3caDataManagement_Notify so many notifications from an NWDAF results in fewer notifications (or one notification) to the NF service consumer and/or the subscribed notification endpoint(s). Alternatively, a notification can instruct the analytics data notification endpoint to fetch the analytics data from the MFAF.
12c.The NF service consumer responds to the Nmfaf_3caDataManagement_Notify service operation with HTTP ""204 No Content"" status code.
13.	(conditional) The NF service consumer invoke the Nmfaf_3caDataManagement_Fetch service operation by sending an HTTP GET request message to fetch the data from the MFAF before an expiry time, if received the fetch instruction in Nmfaf_3caDataManagement_Notify service operation in step 11a, step 11b or step 11c.
14.	The MFAF responds to the Nmfaf_3caDataManagement_Fetch service operation with HTTP ""200 OK"" status code with the message body containing the NmfafResourceRecord data structure.
15.	When the NF service consumer no longer need the subscription to the requested data in step 1, shall invoke the Ndccf_DataManagement_Unsubscribe service operation by sending an HTTP DELETE request message with ""{apiRoot}/nnwdaf-datamanagement/v1/subscriptions/{subscriptionId}"" as Resource URI, where ""{subscriptionId}"" is the event subscriptionId of the existing subscription that is to be deleted., using the Subscription Correlation Id received in response to its subscription in step 1. The DCCF removes the NF service consumer from the list of NF service consumers that are subscribed for these analytics data.
16.	The DCCF responds to the Ndccf_DataManagement_Unsubscribe service operation with HTTP ""204 No Content"" status code, upon removed the NF service consumer from the list of NF service consumers that are subscribed for these analytics data.
17a.	If there are no other NF service consumers subscribed to the analytics data, the DCCF invoke the Nnwdaf_EventsSubscription_Unsubscribe service operation by sending an HTTP DELETE request message to the NWDAF.
18a.	The DWDAF responds to the Nnwdaf_EventsSubscription_Unsubscribe service operation with HTTP ""204 No Content"" status code, upon the analytics event(s) subscription is removed.
17b.	If DCCF determines that no other NF service consumers requiring the historical analytics data from the ADRF, the DCCF may invoke the Nadrf_DataManagement_RetrievalUnSubscribe service operation by sending an HTTP DELETE request message to the ADRF.
18b.	The ADRF responds to the Nadrf_DataManagement_RetrievalUnSubscribe service operation with HTTP ""204 No Content"" status code, upon the data retrieval subscription is removed.
17c.	When DCCF determines that NF service consumer mapping has to be removed from MFAF, the DCCF may invoke the Nmfaf_3daDataManagement_Deconfigure service operation by sending an HTTP DELETE request message to the MFAF.
18c.	The MFAF responds to the Nmfaf_3daDataManagement_Deconfigure service operation with HTTP ""204 No Content"" status code, upon removing the individual resource linked to the delete request.",TS 29.552,5.2.5,all_images/image_976.png,Analytics Exposure via DCCF and Messaging Framework
"This procedure is used by the service consumer to request Analytics event(s) for an Area of Interest, in which multiple NWDAFs are required to serve the request collectively.
Figure 5.3.2-1: Analytics aggregation with provisioning of Area of Interest
1a-1c.	In order to obtain the specific network data analytics, the NF service consumer selects an NWDAF (e.g. NWDAF1) with aggregation capability according to the results returned by NRF or available information obtained by other means. The NWDAF service consumer invokes Nnwdaf_AnalyticsInfo_Request or Nnwdaf_EventsSubscription_Subscribe service operations as described in clause 5.2.3.1 and clause 5.2.2.1 to the selected NWDAF.
In the request message, the analytics event, analytics filter information including the Area of Interest (e.g. TAI-1, TAI-2, TAI-n, if available) and the Target of Analytics Reporting are provided. The NWDAF service consumer may indicate the time when the analytics is needed in ""timeAnaNeeded"" attribute, which needs to be equal or greater than the supported Analytics Delay per Analytics event of the Aggregator NWDAF.
2-5b.	The Aggregator NWDAF selects the other NWDAF instances, which collectively can cover the area of interest indicated in the request, according to the results returned by the NRF and/or the UDM, or available information obtained by other means. The Aggregator NWDAF invokes Nnwdaf_AnalyticsInfo_Request or Nnwdaf_EventsSubscription_Subscribe service operations to each selected NWDAF (e.g. NWDAF2, NWDAF3) as described in clause 4.2.2.2 or clause 4.3.2.2 of 3GPP TS 29.520 [5].
6-9b.	The selected NWDAFs send response or notification containing the requested analytics to the Aggregator NWDAF. If the selected NWDAFs (e.g. NWDAF 2 and/or NWDAF 3) cannot reply or notify the requested analytics before the expiry of the time that the Aggregator NWDAF has indicated, they may send an error response or error notification to the Aggregator NWDAF including a ""revised waiting time"" in ""rvWaitTime"" attribute.
10.	The Aggregator NWDAF aggregates the analytics received from the selected NWDAFs and the analytics of its own.
11a-11c.	The Aggregator NWDAF sends a response or notification containing the aggregated output analytics for the requested Analytics event(s) to the NWDAF service consumer.
If the Aggregator NWDAF cannot reply or notify the requested analytics before the expiry of the time that the consumer has indicated in ""timeAnaNeeded"" attribute, it may sends an error response or error notification to the consumer including a ""revised waiting time"" in ""rvWaitTime"" attribute.",TS 29.552,5.3.2,all_images/image_977.png,Analytics aggregation with provisioning of Area of Interest
"This procedure is used by the service consumer to request Analytics event(s) without providing an Area of Interest, in which multiple NWDAFs are required to serve the request collectively.
Figure 5.3.3-1: Analytics aggregation without provisioning of Area of Interest
1a-1c.	In order to obtain the specific network data analytics, the NF service consumer selects an NWDAF (e.g. NWDAF1) with aggregation capability according to the results returned by NRF or available information obtained by other means. The NWDAF service consumer invokes Nnwdaf_AnalyticsInfo_Request or Nnwdaf_EventsSubscription_Subscribe service operations as described in clause 5.2.3.1 and clause 5.2.2.1 to the selected NWDAF. If not, the NWDAF service consumer should select a NWDAF with large serving area from the candidate NWDAFs which supports analytics aggregation, e.g. NWDAF1.
2a-4b.	If the requested analytics requires UE location information, e.g. for the Analytics events ""UE_MOBILITY"", ""ABNORMAL_BEHAVIOUR"", or ""USER_DATA_CONGESTION"", then:
-	2a-2b: The Aggregator NWDAF may query UDM to discover the NWDAF serving the UE by invoking Nudm_UECM_Get service operation as described in clause 5.3.2.5.12 of 3GPP TS 29.503 [23], if it is supported.
-	3a-4b: The Aggregator NWDAF may determine the AMF serving the UE, then requests UE location information from the AMF by invoking Namf_EventExposure_Subscribe service operation as described in clause 5.3.2.2.2 of 3GPP TS 29.518 [18]. The AMF notifies the UE location information by invoking Namf_EventExposure_Notify service operation as described in 3GPP TS 29.518 [18] clause 5.3.2.4.
5.	If the requested analytics does not require UE location information, e.g. for the Analytics events ""SERVICE_EXPERIENCE"", ""NF_LOAD"", or ""UE_COMM"", the Aggregator NWDAF can determine the NFs to be contacted for data collection.
6.	With the data obtained in step 3a-5, the Aggregator NWDAF may query the NRF for discovering the required NWDAF, by sending an NF discovery request including UE location or NF serving area as a filter to NRF, and obtains candidates target NWDAF(s) that can provide the required analytics.
7.	If a single target NWDAF (e.g. NWDAF2) can provide the requested analytics data, the Aggregator NWDAF can redirect the Nnwdaf_AnalyticsInfo_Request to that target NWDAF or request an analytics subscription transfer to that target NWDAF.
8.	If the Aggregator NWDAF decides to request analytics from one or more target NWDAFs, the steps 2-9b of the analytics aggregation procedure in clause 5.3.2 are executed.",TS 29.552,5.3.3,all_images/image_978.png,Analytics aggregation without provisioning of Area of Interest
"The procedure in below figure is used when an NWDAF service consumer decides to select a new NWDAF instance due to internal or external triggers, e.g. the NWDAF service consumer starts serving a UE with analytics subscription information received upon UE context transfer procedure as described in 3GPP TS 23.502 [3], or the NWDAF service consumer starts to request NF related analytics, or the NWDAF service consumer receives a ""Termination Request"" for an existing analytics subscription from an NWDAF. The NWDAF service consumer sends to the target NWDAF information about the NWDAF previously used for analytics subscription, if available, in Nnwdaf_EventsSubscription_Subscribe service operation. The target NWDAF may initiate the transfer of the analytics context, using the Nnwdaf_AnalyticsInfo_ContextTransfer.
The procedure in below figure is also used when an Aggregator NWDAF, as the NWDAF service consumer, decides to select a new NWDAF to request output analytics for analytics aggregation. For example, upon receiving a Termination Request from one of the NWDAFs that are collectively serving a request for analytics subscription, the Aggregator NWDAF queries the NRF or UDM to select a target NWDAF using information e.g. the UE location, the 5GC NFs (identified by their NF Set IDs or NF types) serving the UE or to be contacted for data collection (if Area of Interest is not provisioned for the requested analytics), or the subset of AoI (if Area of Interest is provisioned for the requested analytics). Then, the Aggregator NWDAF sends information about the NWDAF previously used for analytics subscription, if available, in Nnwdaf_EventsSubscription_Subscribe service operation towards the selected target NWDAF.
Figure 5.4.1-1: Analytics context transfer initiated by target NWDAF selected by the NWDAF service consumer
0.	When the NWDAF service consumer (e.g. AMF) changes, the new NWDAF service consumer may receive the old subscription information from the old NWDAF service consumer.
1.	The NWDAF service consumer determines to select an NWDAF instance. The NWDAF service consumer discovers and selects the target NWDAF as specified in clause 5.8.
2.	To send a request for analytics subscription to the target NWDAF, the NWDAF service consumer invokes Nnwdaf_EventsSubscription_Subscribe service operation by sending the HTTP POST request message targeting the resource ""NWDAF Events Subscriptions"" to the target NWDAF. The NWDAF service consumer includes information on the previous analytics subscription (e.g., NWDAF ID and Subscription ID) which relates to the requested analytics subscription, if available. If the target NWDAF accepts the analytics subscription request, it responds with HTTP ""201 Created"" to the NWDAF service consumer. Details are described in clause 4.2.2.2 of 3GPP TS 29.520 [5].
If the target NWDAF does not receive information of previous analytics subscription in step 2, for UE related Analytics, the target NWDAF may discover previously used NWDAF in UDM as specified in clause 5.8.
NOTE:	If the selected target NWDAF instance is the same as the source NWDAF instance (as received from the other consumer in step 0), the new NWDAF service consumer invokes Nnwdaf_EventsSubscription_Subscribe service operation by sending the HTTP PUT request message targeting the resource ""Individual NWDAF Event Subscription"" to the target NWDAF, and the target NWDAF will update the existing analytics subscription to the new NWDAF service consumer. Following steps are skipped.
3.	If the target NWDAF decides to request an analytics context transfer from the previously used NWDAF, it invokes the Nnwdaf_AnalyticsInfo_ContextTransfer service operation by sending the HTTP GET request message targeting the resource ""NWDAF Context"" to the source NWDAF as described in clause 4.3.2.3 of 3GPP TS 29.520 [5].
Target NWDAF is now ready to generate analytics information by taking into account the information received in step 3.
4.	[Optional] Source NWDAF may purge analytics context after completion of step 3a, if performed, and if not already done, unsubscribes from the data source(s) and/or model source(s) that are no longer needed for the remaining analytics subscriptions.
5.	[Optional] Target NWDAF may subscribe to relevant data source(s) and/or model source(s), if it is not yet subscribed to the data source(s) and/or model source(s).",TS 29.552,5.4.1,all_images/image_979.jpeg,Analytics context transfer initiated by target NWDAF selected by the NWDAF service
"The procedure in below figure is used by a source NWDAF instance to request the transfer of analytics subscription(s) to another target NWDAF instance, using the Nnwdaf_EventsSubscription_Transfer service operation.
If the source NWDAF discovers that the NWDAF service consumer may change concurrently to this procedure, the source NWDAF should not perform the procedure. In such a case, the source NWDAF may send a message to indicate to the NWDAF service consumer that it will not serve this subscription anymore.
NOTE 1:	To discover the possible change of NWDAF service consumer, if the Analytics Event is UE related, the source NWDAF takes actions responding to external trigger (such as UE mobility), for example, checking if the Target of Analytics Reporting is still within the serving area of the analytics consumer, if the serving area information is available.
NOTE 2:	Handling of overload situation or preparation for a graceful shutdown are preferably executed inside an NWDAF Set, when available, therefore, not requiring an analytics subscription transfer as described in this clause. Below procedure is applicable for analytics subscription transfer across NF Sets or if the NWDAF is not deployed in a Set.
Figure 5.4.2-1: Analytics subscription transfer initiated by source NWDAF
0.	The NWDAF service consumer subscribes to analytics from source NWDAF. The NWDAF service consumer may send its NF ID or serving area, enabling the source NWDAF to determine whether the following analytics subscription transfer procedure is applicable. Optionally the source NWDAF subscribes to UE mobility events.
1.	[Optional] Source NWDAF determines, e.g. triggered by a UE mobility event notification, to prepare an analytics subscription transfer to target NWDAF(s) as described in clause 5.4.3 with steps 0-1, 5- 6 will be followed.
2.	Source NWDAF determines, e.g. based on the UE location information received and the analytics consumer's serving area either directly received in step 0 or indirectly received via NRF, to perform an analytics subscription transfer to target NWDAF(s). Therefore, the source NWDAF determines the analytics subscription(s) to be transferred to a target NWDAF.
3.	Source NWDAF performs an NWDAF discovery and selects the target NWDAF. NWDAF discovery may be skipped if the target NWDAF had already been discovered as part of a prepared analytics subscription transfer. In the case of aggregated analytics from multiple NWDAFs, the source NWDAF may use the set of NWDAF identifiers related to aggregated analytics to preferably select a target NWDAF that is already serving the consumer.
4.	Source NWDAF requests, using Nnwdaf_EventsSubscription_Transfer service operation, a transfer of the analytics subscription(s) determined in step 2 to the target NWDAF as described in clause 4.2.2.5 of 3GPP TS 29.520 [5], the response message in step 4b is optional.
5.	Target NWDAF accepts the analytics subscription transfer and takes over the analytics generation based on the information received from the source NWDAF.
The ML model related information namely ModelInfo may be provided by the source NWDAF in the Nnwdaf_EventsSubscription_Transfer request message.
-	If the instance ID or set ID of NWDAF(s) containing MTLF carried in ""modelProvIds"" attribute is provided in the Nnwdaf_EventsSubscription_Transfer, target NWDAF may request or subscribe to the ML model(s) from the indicated NWDAF(s).
NOTE 3:	If the provided ID(s) of NWDAF(s) containing MTLF carried in ""modelProvIds"" attribute are not part of the locally configured ID(s) of NWDAFs containing MTLF, the target NWDAF discovers the NWDAF(s) containing MTLF as described in clause 5.8.2.3.
-	When the source NWDAF itself provides the ML models, the address of ML model files may be provided, and the target NWDAF retrieves the ML model(s) from the indicated address.
Target NWDAF may use the above retrieved ML models and the ML models retrieved from the locally configured NWDAFs containing MTLF for the transferred analytics subscription.
NOTE 4:	If not yet done during a prepared analytics subscription transfer, the target NWDAF allocates a new Subscription ID to the received analytics subscriptions.
NOTE 5:	The target NWDAF might already have received information on some/all of the analytics subscriptions as part of the prepared analytics subscription transfer request received in step 1 and, thus, might already have started to prepare for the analytics generation, e.g. by having already subscribed to relevant event notifications.
6.	Target NWDAF informs the NWDAF service consumer about the successful analytics subscription transfer using a Nnwdaf_EventsSubscription_Notify request message. A new Subscription ID, which was assigned by the target NWDAF, is provided in the Subscription ID and the old Subscription Id, which was allocated by the source NWDAF, is provided in the Old Subscription ID parameter of this message.
NOTE 6:	Notification correlation information in the Nnwdaf_EventsSubscription_Notify message allows the NWDAF service consumer to correlate the notifications to the initial subscription request made with the source NWDAF in step 0.
NOTE 7:	The existing Analytics context in the source NWDAF is not deleted directly but will be purged first when it was collected by the target NWDAF.
NOTE 8:	If this subscription is used as input for analytics aggregation by the NWDAF service consumer, the NWDAF service consumer may inform the other NWDAFs instance participating in this analytics aggregation that the Set of NWDAF identifiers of NWDAF instances used by the NWDAF service consumer for this analytics aggregation has changed using the Nnwdaf_EventsSubscription_Subscribe service operation as described in clause 4.2.2.2 of 3GPP TS 29.520 [5].
7.	[Conditional] If ""analytics context identifier(s)"" had been included in the Nnwdaf_EventsSubscription_Transfer Request received in step 4, the target NWDAF requests the ""analytics context"" by invoking the Nnwdaf_AnalyticsInfo_ContextTransfer service operation as described in clause 4.3.2.3 of 3GPP TS 29.520 [5].
8.	[Optional] Target NWDAF subscribes to relevant data source(s), if it is not yet subscribed to the data source(s) for the data required for the Analytics.
9.	[Optional] Target NWDAF confirms the analytics subscription transfer to the source NWDAF by sending Nnwdaf_EventsSubscription_Transfer response message as described in clause 4.2.2.5 of 3GPP TS 29.520 [5], if the response has not been sent in step 4b.
10.	[Optional] Source NWDAF unsubscribes with the data source(s) that are no longer needed for the remaining analytics subscriptions. In addition, Source NWDAF unsubscribes with the NWDAF(s) containing MTLF, if exist, which are no longer needed for the remaining analytics subscriptions.
NOTE 9:	At this point, the analytics subscription transfer is deemed completed, i.e. the source NWDAF can delete all information related to the successfully transferred analytics subscription.
11-12.	Target NWDAF at some point derives new output analytics based on new input data and notifies the NWDAF service consumer about the new analytics using a Nnwdaf_EventsSubscription_Notify message as described in clause 4.2.2.4 of 3GPP TS 29.520 [5].",TS 29.552,5.4.2,all_images/image_980.png,Analytics subscription transfer initiated by source NWDAF
"This procedure depicted in Figure 5.5.2-1 is used by NWDAF or ADRF to register/update a data collection profile to the DCCF during/after the procedure of data collection.
Figure 5.5.2-1: Procedure for the NWDAF or ADRF to register data profile to DCCF
1.	An ADRF or NWDAF instance is collecting or has collected data directly, e.g. from collocated NF.
2.	In order to register a data collection profile, the ADRF or NWDAF invokes the Ndccf_ContextManagement_Register service operation by sending an HTTP POST request targeting the resource ""DCCF Data Collection Profiles"" as described in clause 4.3.2.2 of 3GPP TS 29.574 [15].
3.	The DCCF responds to the Ndccf_ContextManagement_Register service operation. Upon receipt of the HTTP POST request, if the data profile is accepted to be created, the DCCF responds to the ADRF or NWDAF with ""201 Created"", and the URI of the created profile is included in the Location header field.
4.	In order to update a data collection profile, the Data Consumer invokes the Ndccf_ContextManagement_Update service operation by sending an HTTP PUT request targeting the resource ""Individual DCCF Data Collection Profile"" as described in clause 4.3.2.3 of 3GPP TS 29.574 [15].
5.	The DCCF responds to the Ndccf_ContextManagement_Update service operation. Upon receipt of the HTTP PUT request, if the data profile is accepted to be updated, the DCCF responds to the ADRF or NWDAF with ""200 OK"" with a response body containing a representation of the updated data profile or ""204 No Content"".
6.	To obtain historical data and if the data consumer is configured to collect data via the DCCF using the Ndccf_DataManagement_Subscribe service operation, the data consumer uses the procedures described in clause 5.5.3.
7.	The ADRF or NWDAF requests to delete a registered data collection profile at the DCCF invoking the Ndccf_ContextManagement_Deregister service operation by sending a HTTP DELETE request targeting the ""Individual DCCF Data Collection Profile"" resource of the DCCF as described in clause 4.3.2.4 of 3GPP TS 29.574 [15].
8.	The DCCF responds to the Ndccf_ContextManagement_Deregister service operation with HTTP ""204 No Content"" status code, if the data collection profile is successfully removed.",TS 29.552,5.5.2,all_images/image_982.png,Procedure for the NWDAF or ADRF to register data profile to DCCF
"This procedure depicted in Figure 5.5.3.2-1 is used by a data consumer (e.g. NWDAF) to obtain data and be notified of events using the DCCF and a Messaging Framework. The 3GPP DCCF Adaptor (3da) Data Management service and 3GPP Consumer Adaptor (3ca) Data Management service of the Messaging Framework Adaptor Function (MFAF) are used to interact with the Messaging Framework. Whether the data consumer directly contacts the Data Source or goes via the DCCF is based on configuration.
Figure 5.5.3.2-1: Data Collection via DCCF and via Messaging Framework
1.	In order to subscribe to notification(s) of events exposure via the DCCF based on local configuration, the Data Consumer invokes the Ndccf_DataManagement_Subscribe service operation by sending an HTTP POST request message targeting the resource ""DCCF Data Subscriptions"", as described in clause 4.2.2.2.4 of 3GPP TS 29.574 [15].
2a.	If data is to be collected for a user, i.e. for a SUPI or GPSI, the user consent has not been checked by the data consumer, and local policy and regulations require to check user consent, the DCCF invokes Nudm_SDM_Get service operation by sending an HTTP GET request message targeting the resource ""AccessAndMobilitySubscriptionData"" at the UDM to request the data type ""User consent"" as described in clause 5.2.2.2 of 3GPP TS 29.503 [22]. Otherwise the procedure continues with step 4.
3a.	The UDM responds to the Nudm_SDM_Get service operation. If the request is accepted, the response includes the requested data with ""200 OK"" status code. In subsequent steps, the DCCF excludes the SUPI or GPSI from requests to collect data for users for whom the user consent is not granted.
2b.	For the users for which the user consent is granted, the DCCF subscribes to notifications of changes of the user consent by invoking the Nudm_SDM_Subscribe service operation by sending an HTTP POST request message targeting the resource ""SdmSubscriptions"" at the UDM as described in clause 5.2.2.3 of 3GPP TS 29.503 [22].
3b.	The UDM responds to the Nudm_SDM_Subscribe service operation. If the request is accepted, the UDM responds with ""201 Created"" status code.
4.	If the DCCF is configured to perform data delivery via the MFAF, in order to create configuration of mapping data in the MFAF, the DCCF shall invoke the Nmfaf_3daDataManagement_Configure service operation by sending an HTTP POST request message targeting the resource ""MFAF Configurations"", as described in clause 4.2.2.2.2 of 3GPP TS 29.576 [17].
In order to update configuration of mapping data in the MFAF, the DCCF shall invoke the Nmfaf_3daDataManagement_Configure service operation by sending an HTTP PUT request message targeting the resource ""Individual MFAF Configuration"", as described in clause 4.2.2.2.3 of 3GPP TS 29.576 [17].
5.	The MFAF responds to the Nmfaf_3daDataManagement_Configure service operation.
Upon receipt of the HTTP POST request message, if the configuration is accepted to be created, the MFAF responds to the DCCF with ""201 Created"" status code, and the URI of the created configuration is included in the Location header field.
Upon receipt of the HTTP PUT request message, if the configuration is accepted to be updated, the MFAF responds to the DCCF with ""200 OK"" or ""204 No Content"" status code.
6.	The DCCF determines the NF type(s) and/or OAM to retrieve the data based on the Service Operation requested in step 1. If the NF instance or NF Set ID is not provided by the data consumer. the DCCF determines the NF instances that can provide data as described in TS 23.288 [2] clause 5A.2 and clause 6.2.2.2. If the consumer requested storage of data in an ADRF but the ADRF ID is not provided by the data consumer, or the collected data is to be stored in an ADRF according to configuration on the DCCF, the DCCF selects an ADRF to store the collected data.
The DCCF keeps track of the data actively being collected from the Data Sources it is coordinating. The NWDAF or ADRF may register the data collection profile (including the data collection related Service Operation, Analytics/Data Specification, NWDAF ID or ADRF ID) with the DCCF. The DCCF may then determine whether certain historical data may be available in the NWDAF or ADRF based on the data collection profile and the request time window.
If the historical data handling is not applicable or not supported, the DCCF shall proceed with step 7a, and skip step 7b, step 8b, step 9b, step 7c, step 8c, and step 9c.
If the historical data is available in an ADRF, the DCCF shall proceed with step 7a and step 7b, and skip step 7c, step 8c, and step 9c.
If the historical data is available in an NWDAF, the DCCF shall proceed with step 7a and step 7c, and skip step 7b, step 8b, and step 9b.
7a.	The DCCF shall determine whether the data requested in step 1 are already being collected.
If the data requested are already being collected by a data consumer, the DCCF adds the data consumer to the list of data consumers that are subscribed for these data.
If the DCCF determines that no subscriptions need to be created or modified (e.g. because all the data can be made available either via pre-existing subscriptions or because of the historical data handling) then step 8a and step 9a are skipped.
8a.	If data requested in step 1 are not available yet, the DCCF shall invoke the Nnf_EventExposure_Subscribe service operation by sending an HTTP POST request message request to the NF targeting the resource representing event exposure subscriptions to subscribe to a new event exposure subscription, e.g. as described in clause 5.5.2.2 of 3GPP TS 29.503 [22] for the UDM, clause 5.3.2.2 of 3GPP TS 29.518 [18] for the AMF, clause 4.2.3 of 3GPP TS 29.508 [6] for the SMF, clause 4.2.2.2 of 3GPP TS 29.591 [11] for the NEF, or clause 4.2.2 of 3GPP TS 29.517 [12] for the AF.
Otherwise, if the requested data subscribed in step 1 partially matches data that is already being collected by the DCCF from an NF, and a modification of this subscription to the NF would satisfy both the existing data  subscriptions as well as the newly requested data, the DCCF shall send a request to the individual event exposure subscription resource to update an existing event exposure subscription, e.g. as described in clause 5.5.2.5 of 3GPP TS 29.503 [22] for the UDM, clause 5.3.2.2.3 of 3GPP TS 29.518 [18] for the AMF, clause 4.2.3.3 of 3GPP TS 29.508 [6] for the SMF, clause 4.2.2.2.3 of 3GPP TS 29.591 [11] for the NEF, or clause 4.2.2.3 of 3GPP TS 29.517 [12] for the AF.
9a.	The NF responds to the Nnf_EventExposure_Subscribe service operation.
Upon receipt of the HTTP POST request message, if the subscription is accepted to be created, the NF responds to the DCCF with ""201 Created"" status code, and the URI of the created subscription is included in the Location header field.
Upon receipt of the HTTP PUT request message, if the subscription is accepted to be updated, the NF responds to the DCCF with ""200 OK"" or ""204 No Content"" status code.
7b.	If the historical data handling is applicable, and the DCCF determines to retrieve data from the ADRF, the DCCF shall determine which ADRF instances might provide the data.
8b.	In order to retrieve the historical data from the ADRF, the DCCF shall invoke the Nadrf_DataManagement_RetrievalSubscribe service operation by sending an HTTP POST request message targeting the resource ""ADRF Data Retrieval Subscriptions"", as described in clause 4.2.2.6 of 3GPP TS 29.575 [16].
9b.	The ADRF responds to the Nadrf_DataManagement_RetrievalSubscribe service operation.
Upon receipt of the HTTP POST request message, if the subscription is accepted to be created, the ADRF responds to the DCCF with ""201 Created"" status code, and the URI of the created subscription is included in the Location header field.
7c.	 If the historical data handling is applicable, and the DCCF determines to retrieve data from the NWDAF, the DCCF shall determine which NWDAF instances might provide the data.
8c.	In order to retrieve the historical data from the NWDAF, the DCCF shall invoke the Nnwdaf_DataManagement_Subscribe service operation by sending an HTTP POST request message targeting the resource ""NWDAF Data Management Subscriptions"", as described in clause 4.4.2.2 of 3GPP TS 29.520 [5].
9c.	The NWDAF responds to the Nnwdaf_DataManagement_Subscribe service operation.
Upon receipt of the HTTP POST request message, if the subscription is accepted to be created, the NWDAF responds to the DCCF with ""201 Created"" status code, and the URI of the created subscription is included in the Location header field.
10.	The DCCF responds to the Ndccf_DataManagement_Subscribe service operation with HTTP ""204 No Content"" status code.
11a.	When the data are available, the NF invokes the Nnf_EventExposure_Notify service operation by sending an HTTP POST request message to notify the data events to the MFAF, e.g. as described in clause 5.5.2.4 of 3GPP TS 29.503 [22] for the UDM, clause 5.3.2.4 of 3GPP TS 29.518 [18] for the AMF, clause 4.2.2 of 3GPP TS 29.508 [6] for the SMF, clause 4.2.2.4 of 3GPP TS 29.591 [11] for the NEF, or clause 4.2.4 of 3GPP TS 29.517 [12] for the AF.
12a.	The MFAF responds to the Nnf_EventExposure_Notify service operation with HTTP ""204 No Content"" status code.
11b.	When the historical data are available in the ADRF, the ADRF shall invoke the Nadrf_DataManagement_RetrievalNotify service operation by sending an HTTP POST request message to notify the historical data or Fetch Instructions to the MFAF as described in clause 4.2.2.8 of 3GPP TS 29.575 [16].
12b.	The MFAF responds to the Nadrf_DataManagement_RetrievalNotify service operation with HTTP ""204 No Content"" status code.
11c.	When the historical data are available in the NWDAF, the NWDAF shall invoke the Nnwdaf_DataManagement_Notify service operation by sending an HTTP POST request message to notify the historical data to the MFAF as described in clause 4.4.2.4 of 3GPP TS 29.520 [5].
12c.	The MFAF responds to the Nnwdaf_DataManagement_Notify service operation with HTTP ""204 No Content"" status code.
13.	The MFAF invokes the Nmfaf_3caDataManagement_Notify service operation by sending HTTP POST request message(s) to send the data to all notification endpoints indicated in step 1. Data sent to notification endpoints may be processed and formatted by the MFAF so they conform to delivery requirements for each NF service consumer or notification endpoint.
NOTE:	According to Formatting Instructions provided by the NF service consumer, multiple notifications from a NF can be combined in a single Nmfaf_3caDataManagement_Notify so that many notifications from an NF results in fewer notifications (or one notification) to the Data Consumer. Alternatively, a notification can instruct the data notification endpoint to fetch the data from the MFAF.
14.	The NF service consumer responds to the Nmfaf_3caDataManagement_Notify service operation with HTTP ""204 No Content"" status code.
15.	The Data Consumer invokes the Nmfaf_3caDataManagement_Fetch service operation by sending an HTTP GET request message as described in clause 4.2.2.5 of 3GPP TS 29.574 [15] to fetch the data from the DCCF before an expiry time, if the fetch instruction was received in Nmfaf_3caDataManagement_Notify service operation in step 13.
16.	The MFAF responds to the Nmfaf_3caDataManagement_Fetch service operation with HTTP ""200 OK"" status code with the message body containing the NmfafResourceRecord data structure.
17.	When the NF service consumer no longer needs the subscription to the requested data in step 1, it shall invoke the Ndccf_DataManagement_Unsubscribe service operation by sending an HTTP DELETE request message as described in clause 4.2.2.3.3 of 3GPP TS 29.574 [15]. The DCCF removes the NF service consumer from the list of NF service consumers that are subscribed for these data.
18.	The DCCF responds to the Ndccf_DataManagement_Unsubscribe service operation with HTTP ""204 No Content"" status code, if the NF service consumer is successfully from the list of NF service consumers that are subscribed for these data.
19a.	If there are no other NF service consumers subscribed to the data, the DCCF invokes the Nnf_EventExposure_Unsubscribe service operation by sending an HTTP DELETE request message to the Data Source, e.g. as described in clause 5.5.2.3 of 3GPP TS 29.503 [22] for the UDM, clause 5.3.2.3 of 3GPP TS 29.518 [18] for the AMF, clause 4.2.4 of 3GPP TS 29.508 [6] for the SMF, clause 4.2.2.3 of 3GPP TS 29.591 [11] for the NEF, or clause 4.2.3 in 3GPP TS 29.517 [12] for the AF.
20a.	The Data Source responds to the Nnf_EventExposure_Unsubscribe service operation with HTTP ""204 No Content"" status code, if the data event(s) subscription is successfully removed.
19b.	If DCCF determines that no other NF service consumers requiring the historical data from the ADRF, the DCCF may invoke the Nadrf_DataManagement_RetrievalUnsubscribe service operation by sending an HTTP DELETE request message to the ADRF as described in clause 4.2.2.7 of 3GPP TS 29.575 [16].
20b.	The ADRF responds to the Nadrf_DataManagement_RetrievalUnsubscribe service operation with HTTP ""204 No Content"" status code, upon the data retrieval subscription is removed.
19c.	If DCCF determines that no other NF service consumers require the historical data from the NWDAF, the DCCF may invoke the Nnwdaf_DataManagement_Unsubscribe service operation by sending an HTTP DELETE request message to the NWDAF as described in clause 4.4.2.3 of 3GPP TS 29.520 [5].
20c.	The NWDAF responds to the Nnwdaf_DataManagement_Unsubscribe service operation with HTTP ""204 No Content"" status code, upon the data subscription is removed.
19d.	When the DCCF determines that an NF service consumer mapping has to be removed from MFAF, the DCCF invokes the Nmfaf_3daDataManagement_Deconfigure service operation by sending an HTTP DELETE request message to the MFAF as described in clause 4.2.2.3 of 3GPP TS 29.576 [17].
20d.	The MFAF responds to the Nmfaf_3daDataManagement_Deconfigure service operation with HTTP ""204 No Content"" status code, if the individual resource linked to the delete request is successfully removed.",TS 29.552,5.5.3.2,all_images/image_984.png,Data Collection via DCCF and via Messaging Framework
"This procedure is used by the NF to obtain the network slice (instance) load level analytics which are calculated by the NWDAF based on the information collected from the NSACF, NRF, AMF, SMF and/or OAM. If the NF is an AF which is untrusted, the AF will request analytics via the NEF as described in clause 5.2.3.2.
Figure 5.7.2-1: Procedure for Network Slice (Instance) load level Analytics
1a.	In order to obtain the network slice (instance) load level analytics, the NF may invoke Nnwdaf_AnalyticsInfo_Request service operation as described in clause 5.2.3.1.
1b-1c.	In order to obtain the network slice (instance) load level analytics, the NF may invoke Nnwdaf_EventsSubscription_Subscribe service operation as described in clause 5.2.2.1.
2a-2b.	If the event is set to ""LOAD_LEVEL_INFORMATION"" or ""NSI_LOAD_LEVEL"", the NWDAF invokes Nnrf_NFDiscovery_Request service operation as described in clause 5.3.2.2 of 3GPP TS 29.510 [26] to discover the AMF, SMF and NSSF instance(s) relevant to the analytics filters provided in the subscription request. The NRF responds to the NWDAF an HTTP ""201 Created"" response.
3a-3b.	(Only for ""NSI_LOAD_LEVEL"")The NWDAF may invoke Nnssf_NSSelection_Get service operation as described in clause 5.2.2.2 of 3GPP TS 29.531 [21] to obtain the NSI ID(s) corresponding to the S-NSSAI in the subscription request. The NRF responds to the NWDAF an HTTP ""201 Created"" response.
4a-4b.	(Only for ""NSI_LOAD_LEVEL"")The NWDAF may invoke Nnrf_NFManagement_NFStatusSubscribe service operation as described in clause 5.2.2.5 of 3GPP TS 29.510 [26] to subscribe to the resource usage information of a network slice instance obtained from its constituent NF instances. The NRF responds to the NWDAF an HTTP ""201 Created"" response.
5a-5b. (Only for ""NSI_LOAD_LEVEL"")	If step 4a and step 4b are performed, the NRF may invoke Nnrf_NFManagement_NFStatusNotify service operation as described in clause 5.2.2.6 of 3GPP TS 29.510 [26]. The NWDAF responds to the NRF an HTTP ""204 No Content"" response.
6a-6b.	The NWDAF may invoke Namf_EventExposure_Subscribe service operation as described in clause 5.3.2.2.2 of 3GPP TS 29.518 [18] to subscribe to the notification of individual UE registration/deregistration registered to an S-NSSAI or to an S-NSSAI and NSI ID, or request the total number of UEs served by the AMF per S-NSSAI or per S-NSSAI and NSI ID. The AMF responds to the NWDAF an HTTP ""201 Created"" response.
7a-7b.	If step 6a and step 6b are performed, the AMF invokes Namf_EventExposure_Notify service operation as described in 3GPP TS 29.518 [18] clause 5.3.2.4. The NWDAF responds to the AMF an HTTP ""204 No Content"" response.
8a-8b.	The NWDAF may invoke Nsmf_EventExposure_Subscribe service operation by sending an HTTP POST request targeting the resource ""SMF Notification Subscriptions"" to subscribe to the notification of individual PDU session established or PDU session released in an S-NSSAI or request the total number of PDU Sessions established in an S-NSSAI. The SMF responds to the NWDAF an HTTP ""201 Created"" response.
9a-9b.	If step 8a and step 8b are performed, the SMF may invoke Nsmf_EventExposure_Notify service operation by sending an HTTP POST request to the NWDAF identified by the notification URI received in step 8a. The NWDAF responds to the SMF an HTTP ""204 No Content"" response.
10.	The NWDAF may invoke ""Data collection service"" to the OAM to get the mean number of UEs registered as described in clause 5.2.1 of TS 28.552 [27], mean number of PDU sessions established as described in clause 5.3.1 of TS 28.552 [27] and/or the resource usage information of a network slice instance obtained from its constituent NF instances as described in clause 6.2 of TS 28.552 [27]. (Obtaining the resource usage information of a network slice instance is only applicable for ""NSI_LOAD_LEVEL"" event).
11a-11b.	The NWDAF may invoke Nnsacf_SliceEventExposure_Subscribe service operation as described in clause 5.3.2.2 of 3GPP TS 29.536 [20] to request the number of UEs registered to the network slice and/or the number of PDU sessions established to the network slice.
12a-12b.	The NSACF may invoke Nnsacf_SliceEventExposure_Notify service operation as described in clause 5.3.2.4 of 3GPP TS 29.536 [20]. The NWDAF responds to the NSACF an HTTP ""204 No Content"" response.
13.	The NWDAF calculates the network slice (instance) load level analytics based on the data collected from AMF, SMF, NRF, NSACF and/or OAM.
14a.	If step 1a is performed, the NWDAF responds to the Nnwdaf_AnalyticsInfo_Request service operation as described in clause 5.2.3.1.
14b-14c.	If step 1b and step 1c are performed, the NWDAF invokes Nnwdaf_EventsSusbcription_Notify service operation as described in clause 5.2.2.1.
15a-15b.	The same as step 5a and step 5b.
16a-16b.	The same as step 7a and step 7b.
17a-17b.	The same as step 9a and step 9b.
18.	The same as step 10.
19a-19b.	The same as step 12a and step 12b.
20.	The same as step 13.
21a-21b.	The same as step 14b and step 14c.
NOTE 1:	For details of Nsmf_EventExposure_Subscribe/Notify service operations refer to 3GPP TS 29.508 [6].
NOTE 2:	For details of Nnwdaf_EventsSubscription_Subscribe/Unsubscribe/Notify or Nnwdaf_AnalyticsInfo_Request service operations refer to 3GPP TS 29.520 [5].",TS 29.552,5.7.2,all_images/image_986.png,Procedure for Network Slice (Instance) load level Analytics
"This procedure is used by the NF to obtain the abnormal UE behavioural analytics which are calculated by the NWDAF based on the information collected from the AMF, SMF, AF and/or OAM. If the NF is an AF which is untrusted, the AF will request analytics via the NEF as described in clause 5.2.3.2.
Figure 5.7.9-1: Procedure for Abnormal UE behavioural Analytics
1a.	In order to obtain the abnormal UE behavioural parameters, the NF may invoke Nnwdaf_AnalyticsInfo_Request service operation as described in clause 5.2.3.1.
1b-1c.	In order to obtain abnormal UE behavioural parameters, the NF may invoke Nnwdaf_EventsSubscription_Subscribe service operation as described in clause 5.2.2.1.
2a.	If the event is set to ""ABNORMAL_BEHAVIOUR"" and the expected UE analytics type is set to ""MOBILITY"" or ""MOBILITY_AND_COMMUN"", or the list of exception IDs includes ""UNEXPECTED_UE_LOCATION"", ""PING_PONG_ACROSS_CELLS"", ""UNEXPECTED_RADIO_LINK_FAILURES"", or ""UNEXPECTED_WAKEUP"", the NWDAF collects data from AMF, AF and/or OAM as described in clause 5.7.6 from step 2a to step 9.
2b.	If the event is set to ""ABNORMAL_BEHAVIOUR"" and the expected UE analytics type is set to ""COMMUN"" or ""MOBILITY_AND_COMMUN"", or the list of exception IDs includes ""SUSPICION_OF_DDOS_ATTACK"", ""UNEXPECTED_LONG_LIVE_FLOW"", ""UNEXPECTED_LARGE_RATE_FLOW"", ""WRONG_DESTINATION_ADDRESS"", ""TOO_FREQUENT_SERVICE_ACCESS"" or ""UNEXPECTED_WAKEUP"", the NWDAF collects data from AMF, SMF and/or AF as described in clause 5.7.7 from step 2a to step 9d.
3.	The NWDAF calculates the abnormal UE behavioural parameters based on the collected data from AMF, SMF, AF and/or OAM.
4a.	If step 1a is performed, the NWDAF responds to the Nnwdaf_AnalyticsInfo_Request service operation as described in clause 5.2.3.1.
4b-4c.	If step 1b and step 1c are performed, the NWDAF invokes Nnwdaf_EventsSusbcription_Notify service operation as described in clause 5.2.2.1.
5a-5b.	The AMF, SMF, AF and/or OAM send the notifications to the NWDAF if it has subscribed to the related events in step 2a or step 2b.
6.	The same as step 3.
7a-7b.	The same as step 4b and step 4c.
NOTE:	For details of Nnwdaf_EventsSubscription_Subscribe/Unsubscribe/Notify or Nnwdaf_AnalyticsInfo_Request service operations refer to 3GPP TS 29.520 [5].",TS 29.552,5.7.9,all_images/image_992.jpeg,Procedure for Abnormal UE behavioural Analytics
"This procedure is used by the NWDAF service consumer (may be an NF e.g. NEF, AF, or PCF) to obtain the User Data Congestion analytics which are calculated by the NWDAF based on the information collected from the AMF, OAM, UPF and/or AF.
Figure 5.7.10-1: Procedure for User Data Congestion Analytics
1a.	In order to obtain the User Data Congestion analytics, the NWDAF service consumer may invoke Nnwdaf_AnalyticsInfo_Request service operation as described in clause 5.2.3.1, the requested event is set to ""USER_DATA_CONGESTION"" with the supported feature ""UserDataCongestion"".
1b-1c.	In order to obtain the User Data Congestion analytics, the NWDAF service consumer may invoke Nnwdaf_EventsSubscription_Subscribe service operation as described in clause 5.2.2.1, the subscribed event is set to ""USER_DATA_CONGESTION"" with the supported feature ""UserDataCongestion"".
2a-2b.	The NWDAF may invoke Namf_EventExposure_Subscribe service operation as described in clause 5.3.2.2.2 of 3GPP TS 29.518 [18] to retrieve the UE location information. The AMF responds to the NWDAF an HTTP ""201 Created"" response.
3a-3b.	If step 2a and step 2b are performed, the AMF may invoke Namf_EventExposure_Notify service operation as described in 3GPP TS 29.518 [18] clause 5.3.2.4. The NWDAF responds to the AMF an HTTP ""204 No Content"" response.
4.	The NWDAF may invoke ""Data collection service"" to the OAM to get the Performance Measurements that will be used by the NWDAF to determine congestion levels. Performance Measurements are related to information transfer over the user plane and/or the control plane (e.g. UE Throughput, DRB Setup Management, RRC Connection Number, PDU Session Management, and Radio Resource Utilization as defined in 3GPP TS 28.552 [27]). The NWDAF may obtain measurements by invoking management services that are defined in 3GPP TS 28.532 [19] and 3GPP TS 28.550 [31].
5.	The NWDAF may collect data related to User Data Congestion analytics information from UPF.
NOTE 1:	How the NWDAF collects UPF information is not defined in this release of the specification.
6a-6b.	If the AF is trusted, the NWDAF may invoke Naf_EventExposure_Subscribe service operation to the AF directly by sending an HTTP POST request targeting the resource ""Application Event Subscriptions"" to collect the data related to User Data Congestion analytics information. The AF responds to the NWDAF an HTTP ""201 Created"" response.
7a-7b.	If step 6a and step 6b are performed, the AF invokes Naf_EventExposure_Notify service operation by sending an HTTP POST request to the NWDAF identified by the notification URI received in step 6a. The NWDAF responds to the AF an HTTP ""204 No Content"" response.
8a-8d.	If the AF is untrusted, the NWDAF may invoke Nnef_EventExposure_Subscribe service operation to the NEF by sending an HTTP POST request targeting the resource ""Network Exposure Event Subscriptions"" and then the NEF invokes Naf_EventExposure_Subscribe service operation by sending an HTTP POST request targeting the resource ""Application Event Subscriptions"" to collect the data related to User Data Congestion analytics information. The AF responds to the NEF an HTTP ""201 Created"" response and then the NEF responds to the NWDAF an HTTP ""201 Created"" response.
9a-9d.	If step 8a to step 8d are performed, the AF invokes Naf_EventExposure_Notify service operation by sending an HTTP POST request to the NEF identified by the notification URI received in step 8b and the NEF invokes Nnef_EventExposure_Notify service operation by sending an HTTP POST request to the NWDAF identified by the notification URI received in step 8a. The NWDAF responds to the NEF an HTTP ""204 No Content"" response and then the NEF responds to the AF an HTTP ""204 No Content"" response.
10.	The NWDAF calculates the User Data Congestion analytics based on the data collected from AMF, OAM, UPF and/or AF.
11a.	If step 1a is performed, the NWDAF responds to the Nnwdaf_AnalyticsInfo_Request service operation as described in clause 5.2.3.1.
11b-11c.	If step 1b and step 1c are performed, the NWDAF invokes Nnwdaf_EventsSusbcription_Notify service operation as described in clause 5.2.2.1.
12a-12b.	The same as step 3a and step 3b.
13.	The same as step 4.
14.	The same as step 5.
15a-15b.	The same as step 7a and step 7b.
16a-16d.	The same as step 9a to step 9d.
17.	The same as step 10.
18a-18b.	The same as step 11b and step 11c.
NOTE 2:	For details of Naf_EventExposure_Subscribe/Notify service operations refer to 3GPP TS 29.517 [12].
NOTE 3:	For details of Nnef_EventExposure_Subscribe/Notify service operations refer to 3GPP TS 29.591 [11].
NOTE 4:	For details of Nnwdaf_EventsSubscription_Subscribe/Unsubscribe/Notify or Nnwdaf_AnalyticsInfo_Request service operations refer to 3GPP TS 29.520 [5].",TS 29.552,5.7.10,all_images/image_993.png,Procedure for User Data Congestion Analytics
"This procedure is used by the NWDAF service consumer e.g. SMF to obtain the Session Management Congestion Control Experience Analytics which are calculated by the NWDAF based on the information collected from the SMF.
Figure 5.7.14-1: Procedure for Session Management Congestion Control Experience Analytics
1a.	In order to obtain the SMCCE (Session Management Congestion Control Experience) analytics, the NWDAF service consumer may invoke Nnwdaf_AnalyticsInfo_Request service operation as described in clause 5.2.3.1, the requested event is set to ""SM_CONGESTION"" with the supported feature ""SMCCE"".
1b-1c.	In order to obtain the SMCCE (Session Management Congestion Control Experience) analytics, the NWDAF service consumer may invoke Nnwdaf_EventsSubscription_Subscribe service operation as described in clause 5.2.2.1, the subscribed event is set to ""SM_CONGESTION"" with the supported feature ""SMCCE"".
2a-2b.	The NWDAF may invoke Nsmf_EventExposure_Subscribe service operation by sending an HTTP POST request targeting the resource ""SMF Notification Subscriptions"" to subscribe to the notification of Information on UE ID and SMCC experience for PDU Session. The SMF responds to the NWDAF an HTTP ""201 Created"" response.
3a-3b.	If step 2a and step 2b are performed, the SMF may invoke Nsmf_EventExposure_Notify service operation by sending an HTTP POST request to the NWDAF identified by the notification URI received in step 2a. The NWDAF responds to the SMF an HTTP ""204 No Content"" response.
4.	The NWDAF calculates the Session Management Congestion Control Experience analytics based on the data collected from SMF.
5a.	If step 1a is performed, the NWDAF responds to the Nnwdaf_AnalyticsInfo_Request service operation as described in clause 5.2.3.1.
5b-5c.	If step 1b and step 1c are performed, the NWDAF invokes Nnwdaf_EventsSusbcription_Notify service operation as described in clause 5.2.2.1.
NOTE 1:	For details of Nsmf_EventExposure_Subscribe/Notify service operations refer to 3GPP TS 29.508 [6].
NOTE 2:	For details of Nnwdaf_EventsSubscription_Subscribe/Unsubscribe/Notify and Nnwdaf_AnalyticsInfo_Request service operations refer to 3GPP TS 29.520 [5].",TS 29.552,5.7.14,all_images/image_997.jpeg,Procedure for Session Management Congestion Control Experience Analytics
"This procedure is used by the NWDAF service consumer (may be an NF e.g. SMF) to obtain the Redundant Transmission Experience Analytics which are calculated by the NWDAF based on the information collected from the AMF, AF, SMF, UPF and/or OAM.
Figure 5.7.15-1: Procedure for Redundant Transmission Experience Analytics
1a.	In order to obtain the Redundant Transmission Experience Analytics, the NWDAF service consumer may invoke Nnwdaf_AnalyticsInfo_Request service operation as described in clause 5.2.3.1, the requested event is set to ""RED_TRANS_EXP"" with the supported feature ""RedundantTransmissionExp"".
1b-1c.	In order to obtain the Redundant Transmission Experience Analytics, the NWDAF service consumer may invoke Nnwdaf_EventsSubscription_Subscribe service operation as described in clause 5.2.2.1, the subscribed event is set to ""RED_TRANS_EXP"" with the supported feature ""RedundantTransmissionExp"".
2a-2b.	The NWDAF may invoke Namf_EventExposure_Subscribe service operation as described in clause 5.3.2.2.2 of 3GPP TS 29.518 [18] to retrieve the UE Mobility information. The AMF responds to the NWDAF an HTTP ""201 Created"" response.
3a-3b.	If step 2a and step 2b are performed, the AMF may invoke Namf_EventExposure_Notify service operation as described in 3GPP TS 29.518 [18] clause 5.3.2.4. The NWDAF responds to the AMF an HTTP ""204 No Content"" response.
4a-4b.	The NWDAF may invoke Nsmf_EventExposure_Subscribe service operation by sending an HTTP POST request targeting the resource ""SMF Notification Subscriptions"" to subscribe to the notification of Information related to PDU Session established with redundant transmission. The SMF responds to the NWDAF an HTTP ""201 Created"" response.
5a-5b.	If step 4a and step 4b are performed, the SMF may invoke Nsmf_EventExposure_Notify service operation by sending an HTTP POST request to the NWDAF identified by the notification URI received in step 4a. The NWDAF responds to the SMF an HTTP ""204 No Content"" response.
6.	The NWDAF may collect data related to packet delay measurement information from UPF, refer to clause 5.4 1 of TS 28.552 [27] for the performance measurement in UPF.
NOTE 1:	How the NWDAF collects UPF information is not defined in this release of the specification.
7.	The NWDAF may invoke ""Data collection service"" to the OAM to get the packet drop and/or packet delay measurement refer to clause 5.1 of TS 28.552 [27] for the performance measurement in NG-RAN.
8a-8b.	If the AF is trusted, the NWDAF may invoke Naf_EventExposure_Subscribe service operation to the AF directly by sending an HTTP POST request targeting the resource ""Application Event Subscriptions"" to collect the service data related to UE mobility information. The AF responds to the NWDAF an HTTP ""201 Created"" response.
9a-9b.	If step 8a and step 8b are performed, the AF invokes Naf_EventExposure_Notify service operation by sending an HTTP POST request to the NWDAF identified by the notification URI received in step 8a. The NWDAF responds to the AF an HTTP ""204 No Content"" response.
10a-10d.	If the AF is untrusted, the NWDAF may invoke Nnef_EventExposure_Subscribe service operation to the NEF by sending an HTTP POST request targeting the resource ""Network Exposure Event Subscriptions"" and then the NEF invokes Naf_EventExposure_Subscribe service operation by sending an HTTP POST request targeting the resource ""Application Event Subscriptions"" to collect the service data related to UE mobility information. The AF responds to the NEF an HTTP ""201 Created"" response and then the NEF responds to the NWDAF an HTTP ""201 Created"" response.
11a-11d.	If step 10a to step 10d are performed, the AF invokes Naf_EventExposure_Notify service operation by sending an HTTP POST request to the NEF identified by the notification URI received in step 10b and the NEF invokes Nnef_EventExposure_Notify service operation by sending an HTTP POST request to the NWDAF identified by the notification URI received in step 10a. The NWDAF responds to the NEF an HTTP ""204 No Content"" response and then the NEF responds to the AF an HTTP ""204 No Content"" response.
12.	The NWDAF calculates the Redundant Transmission Experience Analytics based on the data collected from AMF, AF SMF, UPF and/or OAM.
13a.	If step 1a is performed, the NWDAF responds to the Nnwdaf_AnalyticsInfo_Request service operation as described in clause 5.2.3.1.
13b-13c.	If step 1b and step 1c are performed, the NWDAF invokes Nnwdaf_EventsSusbcription_Notify service operation as described in clause 5.2.2.1.
14a-14b.	The same as step 3a and step 3b.
15a-15b.	The same as step 5a and step 5b.
16.	The same as step 6.
17.	The same as step 7.
18a-18b.	The same as step 9a and step 9b.
19a-18d.	The same as step 11a and step 11d.
20.	The same as step 12.
21a-21b.	The same as step 13b and step 13c.
NOTE 2:	For details of Naf_EventExposure_Subscribe/Notify service operations refer to 3GPP TS 29.517 [12].
NOTE 3:	For details of Nsmf_EventExposure_Subscribe/Notify service operations refer to 3GPP TS 29.508 [6].
NOTE 4:	For details of Nnwdaf_EventsSubscription_Subscribe/Unsubscribe/Notify or Nnwdaf_AnalyticsInfo_Request service operations refer to 3GPP TS 29.520 [5].",TS 29.552,5.7.15,all_images/image_998.png,Procedure for Redundant Transmission Experience Analytics
"If an NWDAF containing AnLF has previously registered in UDM for one or more analytics ID for a given UE, when the NWDAF containing AnLF no longer serves the UE, e.g., it does not collect data for the UE for that Analytics ID or does no keep produce analytic reports or does not keep any data related to the UE, the NWDAF containing AnLF should de-register from UDM by invoking the Nudm_UECM_Deregistration service operation (NWDAF registration ID, Analytics ID(s)), see TS 29.503 [22] clause 5.3.2.4.8). Figure 5.8.3.2.3-1 illustrates the signalling flow.
Figure 5.8.3.2.3-1: NWDAF containing AnLF deregistration from UDM
1.	If an NWDAF containing AnLF has previously registered one or more Analytics IDs for a UE in UDM, the NWDAF containing AnLF triggers a complete deregistration from UDM, e.g. based on the NWDAF containing AnLF not collecting data any longer for the UE, or the NWDAF containing AnLF not producing analytics reports for the UE, or the NWDAF containing AnLF not keeping analytics data for the UE.
2.	The NWDAF containing AnLF deregisters from UDM for the served UE, by sending Nudm_UECM_Deregistration request (NWDAF Registration Id).
3.	UDM sends a ""204 No Content"" response to the NWDAF containing AnLF. See TS 29.503 [22] for details.",TS 29.552,5.8.3.2.3,all_images/image_1000.jpeg,NWDAF containing AnLF deregistration from UDM
"The procedure is used by an NF service consumer (e.g. NWDAF, DCCF) to store received notifications in the ADRF.
Figure 5.9.3-1: Historical Data and Analytics storage/deletion procedure
1-2.	Based on provisioning or based on reception of a DataManagement subscription request (e.g. see clause 5.5.3.1), the NF service consumer (e.g. DCCF or NWDAF) determines that notifications are to be stored in the ADRF.
3.	The NF service consumer invokes Nadrf_DataManagement_StorageSubscriptionRequest service operation by sending an HTTP POST request in clause 4.2.2.3 of 3GPP TS 29.575 [16]. The request shall include one of the analytics subscription information, network exposure function event exposure subscription information, application function event exposure subscription information, access and mobility function event exposure subscription information, session management function event exposure subscription information, or unified data management event exposure subscription information, and one of the target identifiers, and may include the formatting instructions and/or processing instructions.
4.	The ADRF may, based on implementation, determines whether the same data or analytics is already stored or being stored based on the information sent in step 3 by the consumer.
5.	If the request is successfully processed and accepted, the ADRF sends Nadrf_DataManagement_StorageSubscriptionRequest Response message to the consumer with HTTP ""200 OK "" status code including a transaction reference identifier. If the data and/or analytics is already stored or being stored in the ADRF, the ADRF sends Nadrf_DataManagement_StorageSubscriptionRequest Response message to the consumer indicating that data or analytics is stored.
6a.	ADRF invokes Ndccf_DataManagement_Subscribe service operation to subscribe to the DCCF to receive notifications by sending an HTTP POST request message targeting the resource ""DCCF Analytics Subscriptions"", the HTTP POST message shall include notification endpoint address and a notification correlation ID as defined in clause 5.1.6.2.2 of 3GPP TS 29.574 [15].
6b.	ADRF invokes Nnwdaf_DataManagement_Subscribe service operation to subscribe to the NWDAF to receive notifications by sending an HTTP POST request message targeting the resource ""NWDAF Data Management Subscriptions"", the HTTP POST message shall include notification endpoint address and a notification correlation ID as defined in clause 4.4.2.2 of 3GPP TS 29.520 [5].
7a	If the Subscription is successfully processed and accepted, the DCCF sends Ndccf_DataManagement_Subscribe Response message to the consumer with HTTP ""201 Created"" status code with the message body containing a representation of the created subscription.
7b	If the Subscription is successfully processed and accepted, the NWDAF sends Nnwdaf_DataManagement_Subscribe Response message to the consumer with HTTP ""201 Created"" status code with the message body containing a representation of the created subscription.
8.	The NF service consumer (e.g. DCCF, MFAF or NWDAF) sends Analytics or Data notifications containing the notification correlation ID provided by the ADRF to ADRF notification endpoint address when the historical analytics data are available.
If the NWDAF is the service consumer in step 7, the NWDAF invokes Nnwdaf_DataManagement_Notify service operation as defined in clause 4.4.2.4 of 3GPP TS 29.520 [5]. The ADRF stores the notifications and responses to the Nnwdaf_DataManagement_Notify service operation with HTTP ""204 No Content"" status code.
If the DCCF is used for data collection in step 7, the DCCF invokes Ndccf_DataManagement_Notify service operation as defined in clause 4.2.2.4 of 3GPP TS 29.574 [15]. The ADRF stores the notifications and responses to the Ndccf_DataManagement_Notify service operation with HTTP ""204 No Content"" status code.
If the Messaging Framework is used for data collection in step 7, the procedure defined in clause 5.5.3.2 is applicable.
9.	The NF service consumer determines that notifications no longer need to be stored in the ADRF.
10.	In order to request the ADRF to delete the specified data or analytics subscription, the NF service consumer shall invoke the Nadrf_DataManagement_StorageSubscriptionRemoval service operation by sending an HTTP POST request as described in clause 4.2.2.4 of 3GPP TS 29.575 [16], including the transaction reference identifier.
11.	If the deletion is successful processed, the ADRF sends Nadrf_DataManagement_StorageSubscriptionRemoval Response message with HTTP ""204 No Content"" status code to the consumer.
12a.	ADRF invokes Ndccf_DataManagement_Unsubscribe service operation to subscribe to the DCCF to receive notifications by sending an HTTP DELETE request message targeting the resource ""Individual DCCF Analytics Subscription"", the HTTP URI shall include identifier of the existing analytics subscription that is to be deleted as defined in clause 4.2.2.3.2 of 3GPP TS 29.574 [15].
12b.	ADRF invokes Nnwdaf_DataManagement_Unsubscribe service operation to subscribe to the NWDAF to receive notifications by sending an HTTP DELETE request message targeting the resource ""Individual NWDAF Data Management Subscription"", the HTTP DELETE URI shall include identifier of the existing analytics subscription that is to be deleted as defined in clause 4.4.2.3.2 of 3GPP TS 29.520 [5].
13a	If the removal of the corresponding subscription is successfully processed and accepted, the DCCF sends Ndccf_DataManagement_Unsubscribe Response message to the consumer with HTTP ""204 No Content"" status code.
13b	If the removal of the corresponding subscription is successfully processed and accepted, the NWDAF sends Nnwdaf_DataManagement_Unsubscribe Response message to the consumer with HTTP ""204 No Content"" status code.",TS 29.552,5.9.3,all_images/image_1001.png,Historical Data and Analytics storage/deletion procedure
"When the StatusSubscribe service operation is used for creating a subscription, the NF Service Consumer (e.g. NEF, MBSF or AF) shall subscribe to MB-SMF service notifications by using the HTTP POST method as shown in Figure 5.3.2.6.2-1.
Figure 5.3.2.6.2-1: Subscribing to MB-SMF notifications
1.	The NF Service Consumer shall send a POST request to the resource URI representing the ""/subscriptions"" collection resource in the MB-SMF (/mbs-sessions/subscriptions). The request body shall include the data indicating the type of notifications that the NF Service Consumer is interested in receiving. The payload body of the POST request (StatusSubscribeReqData data structure, see clause 6.2.6.2.7) shall contain:
-	the MBS Session ID (source specific IP multicast address or TMGI);
-	Area Session ID, for a location dependent MBS session;
-	the list of MBS session events requested to be subscribed.
-	the Notification URI, indicating the address where the MB-SMF shall send the MBS session status notifications; and
-	the NF instance ID of the subscribing NF, if available.
The request body may also contain:
-	an expiry time suggested by the NF Service Consumer, representing the time span during which the subscription is desired to be kept active; and
-	a Notification Correlation ID indicating the correlation identity to be carried in event notifications generated by the subscription.
2a.	On success, the MB-SMF shall return a ""201 Created"" response. The ""Location"" header shall be present and shall contain the URI of the created resource. The payload body of the POST response shall include a representation of the created subscription (StatusSubscribeRspData data structure, see clause 6.2.6.2.8), with the following parameters:
-	MBS Session ID (source specific IP multicast address or TMGI);
-	Area Session ID, for a location dependent MBS session;
-	the list of MBS session events successfully subscribed; and
-	the expiry time after which the subscription becomes invalid.
The POST response may also contain:
-	a list of event reports, if corresponding information is available.
2b.	On failure or redirection, one of the HTTP status code listed in Table 6.2.3.4.3.1-3 shall be returned. For a 4xx/5xx response, the message body may contain a ProblemDetails structure with the ""cause"" attribute set to one of the application error listed in the same Table 6.2.3.4.3.1-3).",TS 29.532,5.3.2.6.2,all_images/image_1004.png,Updating a subscription to MB-SMF notifications
"Figure 6.2.3.1-1 describes the resource URI structure of the Nmbsmf_MBSSession API.
Figure 6.2.3.1-1: Resource URI structure of the Nmbsmf_MBSSession API
Table 6.2.3.1-1 provides an overview of the resources and applicable HTTP methods.
Table 6.2.3.1-1: Resources and methods overview",TS 29.532,6.2.3.1,all_images/image_1005.jpeg,Resource URI structure of the Nmbsmf_MBSSession API
"Figure 6.1.3.1-1: Resource URI structure of the Namf_Communication API
Table 6.1.3.1-1 provides an overview of the resources and applicable HTTP methods.
Table 6.1.3.1-1: Resources and methods overview",TS 29.518,6.1.3.1,all_images/image_1006.jpeg,Resource URI structure of the Namf_Communication API
"Figure 6.4.3.1-1: Resource URI structure of the Namf_Location Service API
Table 6.4.3.1-1 provides an overview of the resources and applicable HTTP methods.
Table 6.4.3.1-1: Resources and methods overview",TS 29.518,6.4.3.1,all_images/image_1007.jpeg,Resource URI structure of the Namf_Location Service API
"Figure 6.13.3-1: Procedure for Unified solution with Implicit Subscription
0.	UDR has a resource under each of /subscription-data, /policy-data, /exposure-data, and /application-data to store the restoration related information. This resource is of format of scope, that is, consists of impacted resource names, lastReplicationTime, and recoveryTime.
A front-end has in its NFProfile the restoration related information of format of scope, that is, consisting of impacted resource names, partialLastReplicationTime, and partialRecoveryTime. NF that consumes services of front-ends sends NRF Nnrf_NFManagement_NFStatusSubscribe for NF profile update notification for those front-ends.
1.	The front-ends issues the first communication with UDR. The front-ends may include in the Nudr_DataRepository service request the URI for receiving notifications.
2.	The UDR creates an implicit subscription to UDR restart event for the front-end.
3.	When UDR fails and restarts after reloading data from its back-up, the UDR needs to send corresponding notification its front-end. If the front-end did not provide the URI for receiving notifications in step 1, the UDR queries NRF to get the default URI for receiving notifications.
4~7.	The same as step 1~4 as described in Figure 6.7.3-1.",TR 29.821,6.13.3,all_images/image_1008.jpeg,Procedure for Unified solution with Implicit Subscription
"Figure 6.19.3.1-1: Procedure for PotentialUDRDataInconsistency notifications – AMF,SMF,SMSF
0.	UDM as well as AMF/SMF/SMSF, registers in its profile a new default notification endpoint for a new default notification type (i.e., PotentialUDRDataInconsistency.
1.	The UDR detects that the corruption, loss or inconsistency of data may happen because of some scenarios (e.g., the UDR fails and restarts, or migration of the data from old UDR to new UDR etc).
2-3.	The UDR discovers the PotentialUDRDataInconsistency endpoint(s) in UDM profiles. The UDR needs to discover from NRF the UDM profile with this new default notification type. E.g., it may discover all the profiles for a certain NF type and then search for profiles including PotentialUDRDataInconsistency default notification type, or as an alternative, using notification-type as a discovery query parameter, only the profiles including PotentialUDRDataInconsistency default notification type may be discovered.
4-5.	The UDR sends PotentialUDRDataInconsistency notification to the discovered PotentialUDRDataInconsistency endpoint(s).
6-7.	The UDM discovers the PotentialUDRDataInconsistency endpoint(s) in AMF, SMF and/or SMSF instances (as UDM consumers), similar to step 2-3.
8.	The UDM sends a new notification request(s) to the callback URI (for the default notification type: PotentialUDRDataInconsistency) defined in the profile of the UDM consumers, with the same contents for the notification received from UDR.
NOTE:	If UDRGroupId was received from UDR, the UDM may need to map that into corresponding UDMGroupId(s) if applicable; how this is done is implementation specific.
9.	AMF, SMF and/or SMSF, as UDM consumers, receive the PotentialUDRDataInconsistency notification request. They mark potentially impacted subscribers.
10.	The AMF/SMF/SMSF perform any required restoration action for the marked subscribers. E.g., AMF should send Nudm_UECM_Reg request to UDM for identified UE/SUPIs. UDM consumers should trigger the required synchronization actions towards UDM based on subsequent UE activity in order to avoid massive signalling.",TR 29.821,6.19.3.1,all_images/image_1009.jpeg,"Procedure for PotentialUDRDataInconsistency notifications – AMF,SMF,SMSF"
"Figure 6.19.3.2-1: Procedure for PotentialUDRDataInconsistency notifications - PCF
0.	PCF registers in its profile the new PotentialUDRDataInconsistency default notification endpoint.
1.	The UDR detects that the corruption, loss or inconsistency of data may happen because of some scenarios (e.g., the UDR fails and restarts, or migration of the data from old UDR to new UDR etc).
2-3.	The UDR discovers the PotentialUDRDataInconsistency endpoint(s) in PCF instance profiles.
4-5.	The UDR sends PotentialUDRDataInconsistency notification to the discovered PotentialUDRDataInconsistency endpoint(s).
6.	When the PotentialUDRDataInconsistency notification is received by PCF, it needs to perform required restoration actions for impacted subscribers. In this case, it is understood that the PCF does not need to send any notification to its consumers (SMF, AMF), while any restoration action must be taken in the PCF and are implementation specific.
Editor's note:	proposed PCF behavior should be assessed by CT3.",TR 29.821,6.19.3.2,all_images/image_1010.jpeg,Procedure for PotentialUDRDataInconsistency notifications - PCF
"Figure 6.19.3.3.2-1: Procedure for PotentialUDRDataInconsistency notifications – NEF direct to UDR
This flow is similar to the one described for PCF in Figure 6.19.3.2-1. The NEF does not send this notification to AF(s), while any restoration action (step 6) must be taken in the NEF and is implementation specific.
Editor's note:	proposed NEF behavior should be assessed by CT3.",TR 29.821,6.19.3.3.2,all_images/image_1011.jpeg,Procedure for PotentialUDRDataInconsistency notifications – NEF direct to UDR
,TR 29.821,6.19.3.3,all_images/image_1012.jpeg,Procedure for PotentialUDRDataInconsistency notifications – NEF via UDM
"The TCP Port Service Multiplexer (TCPMUX) is defined in IETF RFC 1078 [4]. The specification describes a multiplexing service that may be accessed with a network protocol to contact any one of a number of available TCP services of a host on a single, well-known port number.
The same principle is applied to SCTP applications.
An SCTP (IETF RFC 4960 [6]) packet is composed of a common header and chunks.
The SCTP common header contains:
-	The SCTP Source Port Number that can be used by the receiver in combination with the source IP address, the SCTP destination port, and possibly the destination IP address to identify the association to which this packet belongs.
-	The SCTP Destination Port Number that can be used by the receiving host to de-multiplex the SCTP packet to the correct receiving endpoint/application.
A SCTP chunk represents a protocol message, which can be used by the protocol itself or can contain user data. User data are contained in DATA chunks that include a Payload Protocol Identifier. The Payload Protocol Identifier is used to identify the application which uses the services of SCTP.
As it is contained in each DATA chunk, the Payload Protocol Identifier identifies the protocol being carried over SCTP independently of the port numbers being used. The Payload Protocol Identifier can be used therefore to de-multiplex the SCTP packet to the correct receiving endpoint/application above SCTP instead of the SCTP Destination Port Number.
The proposed solution based on the Payload Protocol Identifier parsing would then allow to contact multiple applications on a single well-known STCP port using the SCTP Payload Protocol Identifier instead of requesting IANA for allocation of a new well-known SCTP port number each time a new application is defined.
The SCTP multiplexer is implemented as a stand-alone process above the SCTP layer, listening at the well-known SCTP port and used to initiate and manage associations with remote SCTP endpoints and distribute received SCTP messages to upper-layer applications based on the Payload Protocol Identifier. The SCTP multiplexer is seen as a regular SCTP user. There is no impact on the SCTP stack.
The well-known port can be:
-	The port already allocated for TCPMUX (port 1);
-	A port already allocated for another SCTP application defined by 3GPP;
-	A new port dedicated to SCTP multiplexing allocated in a port range locally administrated by 3GPP.
-	A new port dedicated to SCTP multiplexing allocated by IANA.
In the figure below, a single SCTP host is supporting 4 new applications in addition of an existing W1 application (identified by the IANA-assigned port 38472). The port number used to identify the multiplexer is 47002 (given only as possible unassigned User Port that can be assigned by IANA for the SCTP multiplexer application).
Figure 4.3.1-1: SCTP server-side illustration for SCTP Multiplexer (port)
When DTLS over SCTP, as described in IETF RFC 6083 [9], is used to provide mutual authentication, integrity protection, replay protection and confidentiality protection, only SCTP user data are integrity protected and encrypted by DTLS. The Payload Data (DATA) header, in which the SCTP Payload Protocol Identifier is indicated, is therefore sent as clear text. The SCTP Multiplexer can still use the SCTP Payload Protocol Identifier to distribute SCTP messages to upper-layer applications. Moreover, the SCTP associations being managed by the SCTP Multiplexer and the DTLS connections being handled by the applications (identified by the SCTP Payload Protocol Identifier) above the SCTP Multiplexer, it is possible to have multiple DTLS connections over a the same SCTP association, one DTLS connection per application (or per SCTP Payload Protocol Identifier).
In the figure below, a single SCTP host is supporting 4 new applications in addition of an existing W1 application (identified by the IANA-assigned port 38472). The port number used to identify the multiplexer is 47002 (given only as possible unassigned User Port that can be used). DTLS over SCTP is used to provide communications privacy for applications above the SCTP Multiplexer.
Figure 4.3.1-2: SCTP server-side illustration for SCTP Multiplexer (SCTP MUX) with used of DTLS over SCTP",TR 29.941,4.3.1,all_images/image_1013.png,SCTP server-side illustration for SCTP Multiplexer (port)
"The TCP Port Service Multiplexer (TCPMUX) is defined in IETF RFC 1078 [4]. The specification describes a multiplexing service that may be accessed with a network protocol to contact any one of a number of available TCP services of a host on a single, well-known port number.
The same principle is applied to SCTP applications.
An SCTP (IETF RFC 4960 [6]) packet is composed of a common header and chunks.
The SCTP common header contains:
-	The SCTP Source Port Number that can be used by the receiver in combination with the source IP address, the SCTP destination port, and possibly the destination IP address to identify the association to which this packet belongs.
-	The SCTP Destination Port Number that can be used by the receiving host to de-multiplex the SCTP packet to the correct receiving endpoint/application.
A SCTP chunk represents a protocol message, which can be used by the protocol itself or can contain user data. User data are contained in DATA chunks that include a Payload Protocol Identifier. The Payload Protocol Identifier is used to identify the application which uses the services of SCTP.
As it is contained in each DATA chunk, the Payload Protocol Identifier identifies the protocol being carried over SCTP independently of the port numbers being used. The Payload Protocol Identifier can be used therefore to de-multiplex the SCTP packet to the correct receiving endpoint/application above SCTP instead of the SCTP Destination Port Number.
The proposed solution based on the Payload Protocol Identifier parsing would then allow to contact multiple applications on a single well-known STCP port using the SCTP Payload Protocol Identifier instead of requesting IANA for allocation of a new well-known SCTP port number each time a new application is defined.
The SCTP multiplexer is implemented as a stand-alone process above the SCTP layer, listening at the well-known SCTP port and used to initiate and manage associations with remote SCTP endpoints and distribute received SCTP messages to upper-layer applications based on the Payload Protocol Identifier. The SCTP multiplexer is seen as a regular SCTP user. There is no impact on the SCTP stack.
The well-known port can be:
-	The port already allocated for TCPMUX (port 1);
-	A port already allocated for another SCTP application defined by 3GPP;
-	A new port dedicated to SCTP multiplexing allocated in a port range locally administrated by 3GPP.
-	A new port dedicated to SCTP multiplexing allocated by IANA.
In the figure below, a single SCTP host is supporting 4 new applications in addition of an existing W1 application (identified by the IANA-assigned port 38472). The port number used to identify the multiplexer is 47002 (given only as possible unassigned User Port that can be assigned by IANA for the SCTP multiplexer application).
Figure 4.3.1-1: SCTP server-side illustration for SCTP Multiplexer (port)
When DTLS over SCTP, as described in IETF RFC 6083 [9], is used to provide mutual authentication, integrity protection, replay protection and confidentiality protection, only SCTP user data are integrity protected and encrypted by DTLS. The Payload Data (DATA) header, in which the SCTP Payload Protocol Identifier is indicated, is therefore sent as clear text. The SCTP Multiplexer can still use the SCTP Payload Protocol Identifier to distribute SCTP messages to upper-layer applications. Moreover, the SCTP associations being managed by the SCTP Multiplexer and the DTLS connections being handled by the applications (identified by the SCTP Payload Protocol Identifier) above the SCTP Multiplexer, it is possible to have multiple DTLS connections over a the same SCTP association, one DTLS connection per application (or per SCTP Payload Protocol Identifier).
In the figure below, a single SCTP host is supporting 4 new applications in addition of an existing W1 application (identified by the IANA-assigned port 38472). The port number used to identify the multiplexer is 47002 (given only as possible unassigned User Port that can be used). DTLS over SCTP is used to provide communications privacy for applications above the SCTP Multiplexer.
Figure 4.3.1-2: SCTP server-side illustration for SCTP Multiplexer (SCTP MUX) with used of DTLS over SCTP",TR 29.941,4.3.1,all_images/image_1014.png,SCTP server-side illustration for SCTP Multiplexer (SCTP MUX) with used of DTLS
"Custom Operations provide procedures that allow a service consumer NF (client) to interact with an NF service producer in other ways than what is supported by the CRUD methods described in clause 4.6.1.1.
Custom Operation can be related to a resource or can be related to an entire service and be independent of a resource.
Figure 4.6.1.2-1 illustrates the use of a custom operation related to a resource.
Figure 4.6.1.2-1: Custom Operation on a Resource using HTTP POST
1.	The request URI identifies the custom operation to be executed and the resource the custom operation relates to and is constructed by adding a verb as name for the custom operation at the end of the resource URI (see clauses 4.4.2 and 5.1.3.2). Parameters for the custom operation are included in the request body.
2.	On success, ""204 No Content"" or ""200 OK"" shall be returned. ""200 OK"" shall contain a body with data related to the custom operation.
On failure, the appropriate HTTP status code indicating the error shall be returned and appropriate additional error information should be returned in the POST response body (see clause 4.8).
Figure 4.6.1.2-2 illustrates the use of a custom operation related to a service.
Figure 4.6.1.2-2: Custom Operation related to Service using HTTP POST
1.	The request URI identifies the custom operation to be executed and is constructed by adding a verb as name for the custom operation at the end of the service URI (see clauses 4.4.2 and 5.1.3.2). Parameters for the custom operation are included in the request body.
2.	On success, ""204 No Content"" or ""200 OK"" shall be returned. ""200 OK"" shall contain a body with data related to the custom operation.
On failure, the appropriate HTTP status code indicating the error shall be returned and appropriate additional error information should be returned in the POST response body (see clause 4.8).",TS 29.501,4.6.1.2,all_images/image_1015.jpeg,Custom Operation on a Resource using HTTP POST
"Resource structure shall define the structure of the resource URIs, the resources, the associated HTTP methods and custom operations used for the service.
Figure 5.2.1-1 provides an example of the resource URI structure (i.e. resource tree) of an API. Table 5.2.1-1 provides an example of an overview of the resources defined for the service, and their applicable HTTP methods and custom operations.
Figure 5.2.1-1: Resource URI structure of the <xyz > API
In figure 5.2.1-1 the following graphical conventions are used:
-	a child node with a solid-line frame represents:
-	a resource-URI that has at least one supported HTTP method associated, see e.g. ""/resource A"" in Figure 5.2.1-1. Such node may be any of the archetypes defined in Annex C1, C2 and C3;
-	a resource-URI, which does not have any standard HTTP operation defined, but has a custom operation, see e.g. ""/individual child resource A2"" in Figure 5.2.1-1;
-	a child node with a dashed-line frame represents a  a specific custom operation, see e.g. ""/custom operation A3"" and ""/custom operation C1"" in Figure 5.2.1-1. Such node is a Custom operation archetype, see Annex C4;
-	a child node without a line around its frame (e.g. ""/special node type B"" in Figure 5.2.1-1)  typically represents a path segment for which no standard HTTP operation is specified. This graphical representation is also used when a custom operation without an associated resource is defined for a path segment.  .
Table 5.2.1-1: Resources and methods overview
NOTE 1:	The ""API URI"" is defined in clauses 3.1 and 4.4.1.
For a resource, the ""relative path after API URI"" is appended to the API URI to form the resource URI as defined in clause 3.1.",TS 29.501,5.2.1,all_images/image_1017.jpeg,Resource URI structure of the <xyz > API
"The subscription to notifications on NF Instances is executed creating a new individual resource under the collection resource ""subscriptions"". The operation is invoked by issuing a POST request on the URI representing the ""subscriptions"" resource.
Figure 5.2.2.5.2-1: Subscription to NF Instances in the same PLMN
1.	The NF Service Consumer shall send a POST request to the resource URI representing the ""subscriptions"" collection resource. The custom HTTP header ""3gpp-Sbi-Notif-Accepted-Encoding"", as defined in 3GPP TS 29.500 [4] clause 5.2.3.3.6, may be included to indicate the content-encodings supported by the NF Service Consumer receiving the notification.
The request body shall include the data indicating the type of notifications that the NF Service Consumer is interested in receiving; it also contains a callback URI, where the NF Service Consumer shall be prepared to receive the actual notification from the NRF (see NFStatusNotify operation in 5.2.2.6) and it may contain a validity time, suggested by the NF Service Consumer, representing the time span during which the subscription is desired to be kept active. When the NF Service Consumer creates multiple subscriptions in the NRF, it should use distinct callback URIs for each subscription.
The subscription request may also include additional parameters indicating the list of attributes (including Vendor-Specific attributes, see 3GPP TS 29.500 [4], clause 6.6.3) in the NF Profile to be monitored (or to be excluded from monitoring), in order to determine whether a notification from NRF should be sent, or not, when any of those attributes is changed in the profile.
The NF Service Consumer may request the creation of a subscription to a specific NF Instance, or to a set of NF Instances, where the set is determined according to different criteria specified in the request body, in the ""subscrCond"" attribute of the ""SubscriptionData"" object type (see clause 6.1.6.2.16).
The subscription shall be authorized, or rejected, by the NRF by checking the relevant input attributes (e.g. reqNfType, reqNfFqdn, reqSnssais, reqPerPlmnSnssais, reqPlmnList, reqSnpnList, etc.) in the subscription request body (along with the contents of any optional Oauth2 access token provided in the API request) against the list of authorization attributes in the NF Profile of the target NF Instance to be monitored.
When the subscription request is for a set of NFs, the authorization attributes of the NF Instances in the set may differ, resulting in positive authorization of the subscription for only a part of the NF Instances in the set; in that case, the subscription to the set of NFs may be accepted by the NRF, but the NF Instances in the set that are not authorized for the NF Service Consumer that requested the subscription, shall not result in triggering any notification event from the NRF to the NF Service Consumer.
2a.	On success, ""201 Created"" shall be returned. The response shall contain the data related to the created subscription, including the validity time, as determined by the NRF, after which the subscription becomes invalid. Once the subscription expires, if the NF Service Consumer wants to keep receiving status notifications, it shall create a new subscription in the NRF.
2b.	On failure or redirection:
-	If the creation of the subscription fails at the NRF due to errors in the SubscriptionData JSON object in the request body, the NRF shall return ""400 Bad Request"" status code with the ProblemDetails IE providing details of the error.
-	If the creation of the subscription fails at the NRF due to NRF internal errors, the NRF shall return ""500 Internal Server Error"" status code with the ProblemDetails IE providing details of the error.
-	In the case of redirection, the NRF shall return 3xx status code, which shall contain a Location header with an URI pointing to the endpoint of another NRF service instance.",TS 29.510,5.2.2.5.2,all_images/image_1018.png,Subscription to NF Instances in the same PLMN
"When multiple NRFs are deployed in one PLMN, an NF Instance can subscribe to changes of NF Instances registered in another NRF. The subscription message is redirected by a third NRF.
For that, step 1 in clause 5.2.2.5.2 is executed (send a POST request to the NRF-1 in the Serving PLMN); this request shall include the SubscriptionData parameter in the request body.
Then, steps 2-5 in Figure 5.2.2.5.5-1 are executed between NRF-1, NRF-2 and NRF-3.
Finally, step 2 in clause 5.2.2.5.2 is executed; the subscriptionID shall be sent to the NF Service Consumer.
Figure 5.2.2.5.5-1: Subscription to NF Instances with intermediate redirecting NRF
1.	NF Service Consumer send a subscription request to NRF-1.
2.	NRF-1 receives a subscription request but does not have the information to fulfil the request. Then NRF-1 sends the subscription request to a pre-configured NRF-2.
3.	Upon receiving a subscription request, based on the SubscriptionData contained in the subscription request (e.g.NF type) and locally stored information (see clause 5.2.2.2.3), NRF-2 shall identify the next hop NRF, and redirect the subscription request by returning HTTP 307 Temporary Redirect response.
The 307 Temporary Redirect response shall contain a Location header field, the host part of the URI in the Location header field represents NRF-3.
4.	Upon receiving 307 Temporary Redirect response, NRF-1 sends the subscription request to NRF-3 by using the URI contained in the Location header field of the 307 Temporary Redirect response.
5a.	On success, ""201 Created"" shall be returned by NRF-3.
5b.	On failure, if the creation of the subscription fails at the NRF-3, the NRF-3 shall return ""4XX/5XX"" response.
6a.	On success, ""201 Created"" shall be forwarded to NF Service Consumer via NRF-1. The payload body of the POST response shall contain the representation describing the status of the request and the ""Location"" header shall be present and shall contain the URI of the created resource. The authority and/or deployment-specific string of the apiRoot of the created resource URI may differ from the authority and/or deployment-specific string of the apiRoot of the request URI received in the POST request.
6b.	On failure, if the creation of the subscription fails, ""4XX/5XX"" shall be forwarded to NF Service Consumer via NRF-1.",TS 29.510,5.2.2.5.5,all_images/image_1020.jpeg,Subscription to NF Instances with intermediate redirecting NRF
"The update of subscription in a different PLMN is done by updating a subscription resource identified by a ""subscriptionID"".
For that, step 1 in clause 5.2.2.5.6 is executed (send a PATCH request to the NRF in the Serving PLMN); this request shall include the identity of the PLMN or SNPN of the home NRF (MCC/MNC/NID values) as component values of the susbcriptionID.
Then, steps 1-2 in Figure 5.2.2.5.7-1 are executed, between the NRF in the Serving PLMN and the NRF in the Home PLMN. In this step, the subscriptionID sent to the NRF in the Home PLMN shall not contain the identity of the PLMN (i.e., it shall be the same subscriptionID value as originally generated by the NRF in the Home PLMN). The NRF in the Home PLMN returns a status code with the result of the operation.
If the subscription was created in a different NRF in the HPLMN than the NRF in the HPLMN that receives the subscription update request, the latter shall forward the request received from the NRF in the serving PLMN towards the NRF in the HPLMN holding the subscription, using the information included in the subscriptionID (see clause 5.2.2.5.3). The subscriptionID value in the request forwarded to the NRF in the HPLMN holding the subscription shall contain the same value as originally generated by the latter.
Finally, step 2 in clause 5.2.2.5.7-2 is executed; a status code is returned to the NF Service Consumer in Serving PLMN in accordance to the result received from NRF in the Home PLMN.
Figure 5.2.2.5.7-1: Update of Subscription to NF Instances in a different PLMN
1.	The NRF in Serving PLMN shall send a PATCH request to the resource URI representing the individual subscription. The payload body of the PATCH request shall contain a ""replace"" operation on the ""validityTime"" attribute of the SubscriptionData structure and shall contain a new suggested value for it;
2a.	On success, if the NRF in the Home PLMN accepts the extension of the lifetime of the subscription, and it accepts the requested value for the ""validityTime"" attribute, a response with status code ""204 No Content"" shall be returned.
2b.	On success, if the NRF in the Home PLMN accepts the extension of the lifetime of the subscription, but it assigns a validity time different than the value suggested by the NF Service Consumer, a ""200 OK"" response code shall be returned. The response shall contain the new resource representation of the ""subscription"" resource, which includes the new validity time, as determined by the NRF in the Home PLMN, after which the subscription becomes invalid.
2c.	On failure or redirection:
-	If the update of the subscription fails at the NRF due to errors in the JSON Patch object in the request body, the NRF shall return ""400 Bad Request"" status code with the ProblemDetails IE providing details of the error.
-	If the update of the subscription fails at the NRF due to NRF internal errors, the NRF shall return ""500 Internal Server Error"" status code with the ProblemDetails IE providing details of the error.
-	In the case of redirection, the NRF shall return 3xx status code, which shall contain a Location header with an URI pointing to the endpoint of another NRF service instance.",TS 29.510,5.2.2.5.7,all_images/image_1022.png,Update of Subscription to NF Instances in a different PLMN
"The operation is invoked by issuing a POST request to each callback URI of the different subscribed NF Instances.
Figure 5.2.2.6.3-1: Notification from NRF in a different PLMN
Steps 1 and 2 are identical to steps 1 and 2 in Figure 5.2.2.6.2-1.
It should be noted that the POST request shall be sent directly from the NRF in Home PLMN to the NF Service Consumer in Serving PLMN, without involvement of the NRF in Serving PLMN.",TS 29.510,5.2.2.6.3,all_images/image_1023.jpeg,Notification from NRF in a different PLMN
"The service discovery in a different PLMN is done by querying the ""nf-instances"" resource in the NRF of the Home PLMN.
For that, step 1 in clause 5.3.2.2.2 is executed (send a GET request to the NRF in the Serving PLMN); this request shall include the identity of the PLMN of the home NRF in a query parameter of the URI.
If the NRF in Serving PLMN knows that Oauth2-based authorization is required for accessing the NF Discovery service of the NRF in Home PLMN, e.g. by learning this during an earlier Bootstrapping procedure or local configuration, and if the request received at the NRF in Serving PLMN does not include an access token, the NRF in Serving PLMN may reject the request with a 401 Unauthorized as specified in clause 6.7.3 of 3GPP TS 29.500 [4].
Then, steps 1-2 in Figure 5.3.2.2.3-1 are executed, between the NRF in the Serving PLMN and the NRF in the Home PLMN. In this step, the presence of the PLMN ID of the Home NRF in the query parameter of the URI is not required. The NRF in the Home PLMN returns a status code with the result of the operation. The NRF in the Serving PLMN shall be configured with:
-	a telescopic FQDN (see 3GPP TS 23.003 [12] and 3GPP TS 29.500 [4]) of the NRF in the Home PLMN, if TLS protection between the NRF and the SEPP in the serving PLMN relies on using telescopic FQDN; or
NOTE:	This is required for the NRF in the serving PLMN to route the NF discovery request to the NRF in the HPLMN through a SEPP in the serving PLMN and the SEPP to terminate the TLS connection with a wildcard certificate.
-	with the SEPP FQDN (or the FQDN of the SCP if the communication between the NRF and the SEPP goes through an SCP), if TLS protection between the NRF and the SEPP in the serving PLMN relies on using the 3gpp-Sbi-Target-apiRoot header.
See clause 6.1.4.3 of 3GPP TS 29.500 [4].
Finally, step 2 in clause 5.3.2.2.2 is executed; a status code is returned to the NF Service Consumer in Serving PLMN in accordance to the result received from NRF in Home PLMN.
Figure 5.3.2.2.3-1: Service Discovery in a different PLMN
Steps 1 and 2 are similar to steps 1 and 2 in Figure 5.3.2.2.2-1, where the originator of the service invocation is the NRF in Serving PLMN, and the recipient of the service invocation is the NRF in the Home PLMN.",TS 29.510,5.3.2.2.3,all_images/image_1024.jpeg,Service Discovery in a different PLMN
"When multiple NRFs are deployed in one PLMN, one NRF may query the ""nf-instances"" resource in a different NRF so as to fulfil the service discovery request from a NF service consumer. The query between these two NRFs is forwarded by a third NRF.
Figure 5.3.2.2.5-1: Service Discovery with intermediate forwarding NRF
1.	NRF-1 receives a service discovery request and sends the service discovery request to a pre-configured NRF-2. This may for example include cases where NRF-1 does not have sufficient information as determined by the operator policy to fulfill the request locally.
2a.	Upon receiving a service discovery request, based on the information contained in the service discovery request (e.g. the ""supi"" query parameter in the URI) and locally stored information, NRF-2 shall identify the next hop NRF (see clause 5.2.2.2.3), and forward the service discovery request to that NRF (i.e. NRF-3 in this example) similarly to steps 1 and 2 in Figure 5.3.2.2.2-1 where the originator of the service invocation is NRF-2 and the recipient of the service invocation is NRF-3. The locally stored information in NRF-2 may:
a)	be preconfigured; or
b)	registered by other NRFs (see clause 5.2.2.2.3).
2b.	if NRF-2 does not have enough information to forward the service discovery request, then it responds with 404 Not Found, and the rest of the steps are omitted.
3a.	Upon success, NRF-3 returns the search result.
3b.	On failure or redirection:
-	If the NF Service Consumer is not allowed to discover the NF services for the requested NF type provided in the query parameters, the NRF shall return ""403 Forbidden"" response.
-	If the discovery request fails at the NRF due to errors in the input data in the URI query parameters, the NRF shall return ""400 Bad Request"" status code with the ProblemDetails IE providing details of the error.
-	If the discovery request fails at the NRF due to NRF internal errors, the NRF shall return ""500 Internal Server Error"" status code with the ProblemDetails IE providing details of the error.
-	In the case of redirection, the NRF shall return 3xx status code, which shall contain a Location header with an URI pointing to the endpoint of another NRF service instance.
4a.	NRF-2 forwards the success response to NRF-1.
4b.	On failure or redirection:
-	NRF-2 forwards the error response to NRF-1.
-	In the case of redirection, the NRF shall return 3xx status code, which shall contain a Location header with an URI pointing to the endpoint of another NRF service instance.
NOTE:	It is not assumed that there can only be two NRF hierarchies, i.e. the NRF-3 can go on to forward the service discovery request to another NRF.",TS 29.510,5.3.2.2.5,all_images/image_1025.jpeg,Service Discovery with intermediate forwarding NRF
"When multiple NRFs are deployed in one PLMN, one NRF may request an OAuth2 access token to a different NRF so as to fulfil the Access Token Request from a NF service consumer. The acces token request between these two NRFs is forwarded by a third NRF in this case.
For this, step 1 in clause 5.4.2.2.1 is executed (send a POST request to NRF-1 in the Serving PLMN); this request shall include the OAuth 2.0 Access Token Request in the request body.
Then, steps 1-4 in Figure 5.4.2.2.2-1 hereinafter are executed between NRF-1in Serving PLMN, NRF-2 in Serving PLMN and NRF-3 in Serving PLMN.
Finally, step 2 in clause 5.4.2.2.1 is executed, the Access Token Response containing the requested access token, the token type and additional attributes shall be sent to the NF Service Consumer.
Figure 5.4.2.2.2-1: Access Token Request with intermediate forwarding NRF
1.	NRF-1 receives an Access token request but does not have the information to fulfil the request. Then NRF-1 sends the Access token request to a pre-configured NRF-2.
2a.	Upon reception of the Access token request and based on the information contained in the Acces token request and locally stored information, NRF-2 shall identify the next hop NRF (see clause 5.2.2.2.3), and forward the Access token request to that NRF (i.e. NRF-3 in this example) by replacing the originator of the service invocation with NRF-2, and the recipient of the service invocation with NRF-3. The locally stored information in NRF-2 may:
a)	be preconfigured; or
b)	registered by other NRFs (see clause 5.2.2.2.3).
2b.	if NRF-2 does not have enough information to forward the Access token request, then it responds with 404 Not Found, and the rest of the steps are omitted.
3a.	Upon success, NRF-3 shall return a ""200 OK"" status code, including in the response payload the Access token response containing the requested access token, the token type and additional attributes.
3b.	Upon failure, NRF-3 shall return ""400 Bad Request"" status code, including in the response payload a JSON object that provides details about the specific error(s) that occurred.
4a.	NRF-2 forwards the success response to NRF-1.
4b.	On failure or redirection:
-	NRF-2 forwards the error response to NRF-2.
-	In the case of redirection, the NRF shall return 3xx status code, which shall contain a Location header with an URI pointing to the endpoint of another NRF service instance.
NOTE:	It is not assumed that there can only be two NRF hierarchies, i.e. the NRF-3 can go on and forward the Access token request request to another NRF.",TS 29.510,5.4.2.2.2,all_images/image_1026.jpeg,Access Token Request with intermediate forwarding NRF
"When multiple NRFs are deployed in one PLMN, one NRF may request an OAuth2 access token to a different NRF so as to fulfil the Access Token Request from a NF service consumer. The acces token request between these two NRFs is redirected by a third NRF in this case.
For this, step 1 in clause 5.4.2.2.1 is executed (send a POST request to NRF-1 in the Serving PLMN); this request shall include the OAuth 2.0 Access Token Request in the request body
Then, steps 1-4 in Figure 5.4.2.2.3-1 hereinafter are executed between NRF-1in Serving PLMN, NRF-2 in Serving PLMN and NRF-3 in Serving PLMN.
Finally, step 2 in clause 5.4.2.2.1 is executed, the Access token response containing the requested access token, the token type and additional attributes shall be sent to the NF Service Consumer.
Figure 5.4.2.2.3-1: Access Token Request with intermediate redirecting NRF
1.	NRF-1 receives an Access token request but does not have the information to fulfil the request. Then NRF-1 sends the Access token request to a pre-configured NRF-2.
2a.	Upon reception of the Access token request and based on the information contained in the Access token request and locally stored information, NRF-2 shall identify the next hop NRF (see clause 5.2.2.2.3), and redirect the Access token request by returning HTTP ""307 Temporary Redirect"" response. The locally stored information in NRF-2 may:
a)	be preconfigured; or
b)	registered by other NRFs (see clause 5.2.2.2.3).
The ""307 Temporary Redirect"" response shall contain a Location header field, the host part of the URI in the Location header field represents NRF-3.
2b.	if NRF-2 does not have enough information to forward the Access token request, then it responds with ""404 Not Found"", and the rest of the steps are omitted.
3.	Upon reception of ""307 Temporary Redirect"" response, NRF-1 sends the Acces token request to NRF-3 by using the URI contained in the Location header field of the ""307 Temporary Redirect"" response.
4a.	Upon success, NRF-3shall return a ""200 OK"" status code including in the response payload the Access token response containing the requested access token, the token type and additional attributes.
4b.	On failure or redirection:
-	Upon failure, the NRF-3 shall return ""400 Bad Request"" status code, including in the response payload a JSON object that provides details about the specific error(s) that occurred.
-	In the case of redirection, the NRF shall return 3xx status code, which shall contain a Location header with an URI pointing to the endpoint of another NRF service instance.",TS 29.510,5.4.2.2.3,all_images/image_1027.jpeg,Access Token Request with intermediate redirecting NRF
"The structure of the Resource URIs of the NFManagement service is shown in figure 6.1.3.1-1.
Figure 6.1.3.1-1: Resource URI structure of the NFManagement API
Table 6.1.3.1-1 provides an overview of the resources and applicable HTTP methods.
Table 6.1.3.1-1: Resources and methods overview",TS 29.510,6.1.3.1,all_images/image_1028.jpeg,Resource URI structure of the NFManagement API
"This procedure is performed when a Policy Control Request Trigger condition is met.
Figure 5.1.2.1.1-1: AMF-initiated AM Policy Association Modification without AMF relocation procedure
This procedure concerns both roaming and non-roaming scenarios.
In the non-roaming case the role of the V-PCF is performed by the PCF. For the roaming scenarios, the V-PCF interacts with the AMF.
1.	The AMF detects a Policy Control Request Trigger condition is met or other condition is met, e.g. trace control configuration needs to be updated, as defined in clause 4.2.3.1 of 3GPP TS 29.507 [7].
2.	The AMF invokes the Npcf_AMPolicyControl_Update service operation to the (V-) PCF by sending the HTTP POST request to the ""Individual AM Policy Association"" resource with information on the conditions that have changed.
3.	The (V-)PCF stores the information received in step 2 and makes the policy decision.
4.	The (V-)PCF sends an HTTP ""200 OK"" response to the AMF with the updated Access and Mobility control policy information and/ or the updated Policy Control Request Trigger parameters as described in clause 4.2.3.3 of 3GPP TS 29.507 [7].
4a.	If an AF (either directly or via the NEF) has previously subscribed to events for the AF application AM context (e.g. service area restrictions policy change) as described in 3GPP TS 29.534 [50] clause 4.2.5, the PCF checks if reporting is needed based on the policy decision that was made and may send a respective notification using Npcf_AMPolicyAuthorization_Notify as defined in 3GPP TS 29.534 [50] clause 4.2.7.2 (in addition, a Nnef_AMPolicyAuthorization_Notify request/response may occur between the NEF and the AF if the notification is relayed via the NEF).
4b.	The AF (either directly or via the NEF) sends an HTTP ""204 No Content"" response as defined in 3GPP TS 29.534 [50] clause 4.2.7.2.
5.	The AMF deploys the Access and Mobility control policy if received, which includes, e.g. storing the Service Area Restrictions, provisioning the Service Area Restrictions to the NG-RAN and UE, and/or provisioning the RFSP index to the NG-RAN when the UE is registered in the 3GPP access.",TS 29.513,5.1.2.1.1,all_images/image_1030.jpeg,AMF-initiated AM Policy Association Modification without AMF relocation
"This procedure is performed when AMF relocation is performed and the old PCF is selected by the new AMF.
Figure 5.1.2.1.2-1: AMF-initiated AM Policy Association Modification with old PCF during AMF relocation procedure
This procedure concerns both roaming and non-roaming scenarios.
In the non-roaming case the role of the V-PCF is performed by the PCF. For the roaming scenarios, the V-PCF interacts with the AMF.
1.	When the old AMF and the new AMF belong to the same PLMN or the same SNPN, the old AMF transfers to the new AMF about the AM Policy Association information including, e.g. policy control request trigger(s), and the resource URI (i.e. {apiRoot}/npcf-am-policy-control/v1/policies/{polAssoId}) of AM Policy Association at the (V-)PCF).
2.	Based on local policies, the new AMF decides to contact with (V-)PCF and update the resource identified by the resource URI received in step 1.
3.	The new AMF invokes the Npcf_AMPolicyControl_Update service operation to the (V-) PCF by sending the HTTP POST request to the ""Individual AM Policy Association"" resource with the Notification URI of the new AMF. The request may also include the met policy control request trigger(s) and corresponding information, and the new alternate or backup IP addresses or FQDN.
4.	The (V-)PCF updates the stored information provided by the old AMF with the information provided by the new AMF and makes the policy decision.
5.	The PCF sends an HTTP ""200 OK"" response to the AMF with the updated Access and Mobility control policy information and/or the updated Policy Control Request Trigger parameters as described in clause 4.2.3.3 of 3GPP TS 29.507 [7].
5a.	If an AF (either directly or via the NEF) has previously subscribed to events for the AF application AM context (e.g. service area restrictions policy change) as described in 3GPP TS 29.534 [50] clause 4.2.5, the PCF checks if reporting is needed based on the policy decision that was made and may send a respective notification using Npcf_AMPolicyAuthorization_Notify as defined in 3GPP TS 29.534 [50] clause 4.2.7.2  (in addition, a Nnef_AMPolicyAuthorization_Notify request/response may occur between the NEF and the AF if the notification is relayed via the NEF).
5b.	The AF (either directly or via the NEF) sends an HTTP ""204 No Content"" response as defined in 3GPP TS 29.534 [50] clause 4.2.7.2.
6.	The AMF deploys the Access and Mobility control policy if received, which includes, e.g. storing the Service Area Restrictions, provisioning the Service Area Restrictions to the NG-RAN and UE, and/or provisioning the RFSP index to the NG-RAN when the UE is registered in the 3GPP access.",TS 29.513,5.1.2.1.2,all_images/image_1031.jpeg,AMF-initiated AM Policy Association Modification with old PCF during AMF
"This procedure is performed when the Access and Mobility control policies are changed.
Figure 5.1.2.2-1: PCF-initiated AM Policy Association Modification procedure
This procedure concerns both roaming and non-roaming scenarios.
In the non-roaming case the role of the V-PCF is performed by the PCF. For the roaming scenarios, the V-PCF interacts with the AMF.
1.	The (V-) PCF receives an external trigger, e.g. the subscriber policy data of a UE is changed or an AF request to influence AM policies has been received, or the (V-)PCF receives an internal trigger, e.g. operator policy is changed, to re-evaluate Access and Mobility control policy for a UE.
2.	The (V-)PCF makes the policy decision including, Access and Mobility control policy, and may determine applicable Policy Control Request Trigger(s).
3.	The (V-)PCF invokes the Npcf_AMPolicyControl_UpdateNotify service operation by sending the HTTP POST request with ""{notificationUri}/update"" as the callback URI to the AMF that has previously subscribed, as described in clause 4.2.4.2 of 3GPP TS 29.507 [7].
4.	The AMF sends an HTTP ""204 No Content"" response the PCF.
4a.	If an AF (either directly or via the NEF) has previously subscribed to events for the AF application AM context (e.g. service area restrictions policy change) as described in 3GPP TS 29.534 [50] clause 4.2.5, the PCF checks if reporting is needed based on the policy decision that was made and may send a respective notification using Npcf_AMPolicyAuthorization_Notify as defined in 3GPP TS 29.534 [50] clause 4.2.7.2  (in addition, a Nnef_AMPolicyAuthorization_Notify request/response may occur between the NEF and the AF if the notification is relayed via the NEF).
4b.	The AF (either directly or via the NEF) sends an HTTP ""204 No Content"" response as defined in 3GPP TS 29.534 [50] clause 4.2.7.2.
5.	The AMF deploys the Access and Mobility control policy information if received which includes, e.g. storing the Service Area Restrictions, provisioning the Service Area Restrictions to the UE and/or provisioning the RFSP index and Service Area Restrictions to the NG-RAN when the UE is registered in the 3GPP access.",TS 29.513,5.1.2.2,all_images/image_1032.jpeg,PCF-initiated AM Policy Association Modification procedure
"This procedure is performed when the UE deregisters from the network, when the UE deregisters from 5GS during the UE moving from 5GS to EPS or when the old AMF removes the AM Policy Association during AMF relocation.
Figure 5.1.3.1-1: AMF-initiated AM Policy Association Termination procedure
This procedure concerns both roaming and non-roaming scenarios.
In the non-roaming case the role of the V-PCF is performed by the PCF. For the roaming scenarios, the V-PCF interacts with the AMF.
Step 4 and step 5 are not executed in the roaming case.
1.	The AMF invokes the Npcf_AMPolicyControl_Delete service operation to delete the policy context in the (V-) PCF by sending the HTTP DELETE request to the ""Individual AM Policy Association"" resource.
2.	The AMF removes the UE context for this UE, including the Access and Mobility Control Policy related to the UE and/or policy control request triggers.
3.	The (V-)PCF removes the policy context for the UE and sends an HTTP ""204 No Content"" response to the AMF.
4.	The PCF invokes the Nudr_DataRepository_Unsubscribe service operation to unsubscribe the notification of subscriber policy data modification from the UDR by sending an HTTP DELETE request to the ""IndividualPolicyDataSubscription"" resource if it has subscribed such notification. The PCF invokes also the Nudr_DataRepository_Unsubscribe service operation to unsubscribe from notifications about AM Influence data changes at the UDR by sending an HTTP DELETE request to the ""IndividualApplicationDataSubscription"" resource if it has subscribed such notification.
5.	The UDR responds with HTTP ""204 No Content"" to the PCF.
6.	The PCF may also deregister from the BSF as the PCF for the UE (i.e. as the PCF that handles the AM Policy Association of this UE) by sending an HTTP DELETE request to the ""Individual PCF for a UE Binding"" resource of the Nbsf_Management_Deregister service as described in clause 4.2.3.3 of 3GPP TS 29.521 [22].
7.	The BSF responds with ""204 No Content"" if the deregistration of the PCF for the UE was successful.
8.	If there is AF/NEF application AM context associated with the UE, the PCF invokes the Npcf_AMPolicyAuthorization_Notify service operation by sending the HTTP POST request with the {termNotifUri} as the callback URI to the AF/NEF to trigger the AF to request the AF application AM context termination.
9.	The AF/NEF sends an HTTP ""204 No Content"" response to the PCF.
10.	The AF/NEF invokes the Npcf_AMPolicyAuthorization_Delete service operation by sending the HTTP POST request to the ""Individual Application AM Context"" resource.
11	The PCF removes the AF application AM session context and sends an HTTP ""204 No Content"" response to the AF.",TS 29.513,5.1.3.1,all_images/image_1033.jpeg,AMF-initiated AM Policy Association Termination procedure
"This procedure is performed when the UDR notifies the PCF that the policy profile is removed or when the PCF decides to terminate the AM Policy Association based on the internal logic, e.g. UE movement triggers a geo-fencing rule.
Figure 5.1.3.2-1: PCF-initiated AM Policy Association Termination procedure
This procedure concerns both roaming and non-roaming scenarios.
In the non-roaming case the role of the V-PCF is performed by the PCF. For the roaming scenarios, the V-PCF interacts with the AMF.
Step 1, step 2 and step 3 are not executed in the roaming case or in the case that the PCF decides to terminate the AM Policy Association based on the internal logic.
1.	The subscriber policy control data is removed from the UDR.
2.	The UDR invokes the Nudr_DataRepository_Notify service operation to notify the PCF that the policy profile is removed if PCF has subscribed such notification by sending the HTTP POST request to the callback URI ""{notificationUri}"" as specified in 3GPP TS 29.519 [12].
3.	The PCF sends the response to the Nudr_DataRepository_Notify service operation.
4.	The (V-)PCF decides to terminate the AM Policy Association based on step 2 or an internal trigger, e.g. operator policy is changed, to re-evaluate Access and Mobility control policy for a UE.
5.	The (V-)PCF may, depending on operator policies, invoke the Npcf_AMPolicyControl_UpdateNotify service operation towards the AMF to notify it of the removal of the Access and Mobility control policy control information by sending an HTTP POST request to the request URI ""{notificationUri}/terminate"" as described in clause 4.2.4.3 of 3GPP TS 29.507 [7].
Alternatively, the (V-)PCF may decide to maintain the Policy Association if a default profile is applied, and then step 4 through 6 are not executed.
6.	The AMF sends an HTTP ""204 No Content"" response to the PCF.
7.	Step 1 through step 3 and step 8 through step 11 as specified in Figure 5.1.3.1-1 are executed with the following difference:
-	the AMF removes the policy control request trigger(s) related to the AM policy association, but still keeps the provisioned AM policies and applies them to the UE.
-	Step 8 through step 11 can be issued at any time after step 4.",TS 29.513,5.1.3.2,all_images/image_1034.jpeg,PCF-initiated AM Policy Association Termination procedure
"This procedure is performed when the PCF decides to modify policy decisions for a PDU session.
Figure 5.2.2.2.1-1: Interactions between SMF, PCF and CHF for PCF-initiated SM Policy Association Modification procedure
1.	The PCF receives an internal or external trigger to re-evaluate PCC Rules and policy decision for a PDU Session. Possible external trigger events are described in clause 5.2.2.2.2. In addition, this procedure is triggered by the following cases:
-	The UDR notifies the PCF about a policy data change (e.g. change in MPS EPS Priority, MPS Priority Level, MCS Priority Level and/or IMS Signalling Priority, or change in user profile configuration indicating whether supporting application detection and control).
-	The UDR notifies the PCF about application data change (e.g. change in AF influence data or IPTV configuration data).
-	The CHF provides a Spending Limit Report to the PCF as described in clause 5.3.5.
2.	If the PCF determines that the policy decision depends on the status of the policy counters available at the CHF and such reporting is not established for the subscriber, the PCF initiates an Initial Spending Limit Report as defined in clause 5.3.2. If policy counter status reporting is already established for the subscriber, and the PCF decides to modify the list of subscribed policy counters, the PCF sends an Intermediate Spending Limit Report as defined in clause 5.3.3. If the PCF decides to unsubscribe any future status notification of policy counters, it sends a Final Spending Limit Report Request to cancel the request for reporting the change of the status of the policy counters available at the CHF as defined in clause 5.3.4.
3.	The PCF makes a policy decision. The PCF can determine that updated or new policy information need to be sent to the SMF.
4-5.	If network slice data rate related policy control applies, the (H-)PCF may invoke the Nudr_DataRepository_Update service operation by sending an HTTP PATCH request targeting the ""SlicePolicyControlData"" resource in order to update the Remaining Maximum Slice Data Rate information.
6.	The PCF invokes the Npcf_SMPolicyControl_UpdateNotify service operation by sending the HTTP POST request with ""{notificationUri}/update"" as the callback URI to the SMF that has previously subscribed. The request operation provides the PDU session ID and the updated policies, as described in clause 4.2.3 of 3GPP TS 29.512 [9].
7.	The SMF sends an HTTP ""200 OK"" or HTTP ""204 No Content"" to the PCF.",TS 29.513,5.2.2.2.1,all_images/image_1035.jpeg,"Interactions between SMF, PCF and CHF for PCF-initiated SM Policy Association"
"This procedure is performed when the AF/NEF requests to create an AF application session context for the requested service.
NOTE 1:	The NEF acts as an AF to support the network exposure functionality.
For the integration with TSC networks the AF represented in the figures is either the TSN AF (integration with IEEE TSN networks) or the TSCTSF (integration with other TSC networks than IEEE TSN).
Figure 5.2.2.2.2.1-1: AF Session Establishment triggers PCF-initiated SM Policy Association Modification procedure
1.	When the AF receives an internal or external trigger to set-up a new AF session, the AF invokes the Npcf_PolicyAuthorization_Create service operation to the PCF by sending the HTTP POST request to the ""Application Sessions"" resource. The request operation includes the IP address or the MAC address of the UE, the SUPI if available, the GPSI if available, the DNN if available, the S-NSSAI if available, service information, sponsored data connectivity if applicable, AF application identifier, Priority indicator, etc, as defined in clause 4.2.2.2 of 3GPP TS 29.514 [10]. The request operation may also include the subscription to notifications on certain user plane events, e.g. subscription to QoS notification control. To invoke MPS for DTS, the AF includes the MPS Action indication as defined in 3GPP TS 29.514 [10].
If the ""TimeSensitiveNetworking"" or ""TimeSensitiveCommunication"" feature is supported the TSN AF or TSCTSF may subscribe to notification of DS-TT PMIC and/or NW-TT PMIC(s) and/or UMIC availability. The TSN AF or TSCTSF may also provide TSC Assistance Container and QoS related data and/or a UMIC and/or one or more PMIC(s).
1a.	The AF provides the Service Information to the PCF by sending a Diameter AAR for a new Rx Diameter session.
2.	The PCF stores the Service Information received in step 1.
3-4.	If the PCF does not have the subscription data for the SUPI, DNN and S-NSSAI, it invokes the Nudr_DataRepository_Query service operation to the UDR by sending the HTTP GET request to the ""SessionManagementPolicyData"" resource. The UDR sends an HTTP ""200 OK"" response to the PCF with the subscription data.
Additionally, when network slice data rate related policy control is supported by the PCF, the PCF may invoke the Nudr_DataRepository_Query service operation towards the UDR by sending an HTTP GET request targeting the ""SlicePolicyControlData"" resource as specified in clause 5.2.12 of 3GPP TS 29.519 [12]. The UDR sends an HTTP ""200 OK"" response to the PCF with the network slice policy control data.
Additionally, if the AF provided a Background Data Transfer Reference ID in step 1 or step 1a and the corresponding transfer policy is not locally stored in the PCF, the PCF sends the HTTP GET request to the ""IndividualBdtData"" resource. The UDR sends an HTTP ""200 OK"" response to the PCF with the Background Data Transfer policy.
If the AF session is for MPS for DTS invocation, the PCF performs MPS subscription checks if and only if requested by the AF as described in clause 4.4.11 of 3GPP TS 29.214 [18] or as described in clause 4.2.2.12.2 of 3GPP TS 29.514 [10].
5.	The PCF identifies the affected established PDU Session (s) using the information previously received from the SMF and the Service Information received from the AF.
6.	The PCF sends an HTTP ""201 Created"" response to the AF.
6a.	The PCF sends a Diameter AAA to the AF.
7.	The AF may invoke the Npcf_PolicyAuthorization_Subscribe service operation by sending the HTTP PUT request to the ""Events Subscription"" resource to subscribe to events in the PCF. The request includes the events that subscribes and a Notification URI to indicate to the PCF where to send the notification of the subscribed events, as described in clause 4.2.6 of 3GPP TS 29.514 [10].
8.	The PCF sends an HTTP ""201 Created"" response to the AF.
9.	The PCF interacts with SMF according to Figure 5.2.2.2-1.",TS 29.513,5.2.2.2.2.1,all_images/image_1036.jpeg,AF Session Establishment triggers PCF-initiated SM Policy Association
"This procedure is performed when the AF/NEF requests to update an AF application session context for the requested service.
NOTE 1:	The NEF acts as an AF to support the network exposure functionality.
For the integration with TSC networks the AF represented in the figures is either the TSN AF (integration with IEEE TSN networks) or the TSCTSF (integration with other TSC networks than IEEE TSN).
Figure 5.2.2.2.2.2-1: AF Session Modification triggers PCF-initiated SM Policy Association Modification procedure
1.	When the AF receives an internal or external trigger to modify an existing AF session, the AF invokes the Npcf_PolicyAuthorization_Update service operation to the PCF by sending the HTTP PATCH request to the ""Individual Application Session Context"" resource including the modified service information as defined in clause 4.2.3.2 of 3GPP TS 29.514 [10]. The AF may also provide the updated subscription to notifications on user plane events. To invoke/revoke MPS for DTS, the AF includes the MPS Action indication as defined in 3GPP TS 29.514 [10].
If the ""TimeSensitiveNetworking"" or ""TimeSensitiveCommunication"" feature is supported the AF may also update the TSC Assistance Container and QoS related data and/or a UMIC and/or one or more PMIC(s).
1a.	The AF provides the Service Information to the PCF by sending a Diameter AAR for the existing Rx Diameter session corresponding to the modified AF session.
2.	The PCF stores the received Service Information.
3-4.	These steps are the same as steps 3-4 in clause 5.2.2.2.2.1.
5.	The PCF identifies the affected existing PDU Session(s) using the information previously received from the SMF and the Service Information received from the AF.
6.	The PCF sends an HTTP ""200 OK"" or HTTP ""204 No Content"" response to the AF.
6a.	The H-PCF sends a Diameter AAA to the AF.
7.	The AF may decide to (un)subscribe to events for the active AF application session context in relation to the corresponding PDU session.
-	If the AF decides to create a subscription to events or modify the events subscription, it invokes the Npcf_PolicyAuthorization_Subscribe service operation by sending the HTTP PUT request to the ""Events Subscription"" resource. The HTTP request includes the events that subscribes and may also include a Notification URI to indicate to the PCF where to send the notification of the subscribed events.
-	If the AF decides to remove subscription to all subscribed events for the existing application session context, it invokes the Npcf_PolicyAuthorization_Unsubscribe service operation by sending the HTTP DELETE request to the ""Events Subscription"" resource.
8.	The PCF responses to the AF.
-	If the PCF accept the HTTP PUT request to create a subscription to events, it sends an HTTP ""201 Created"" response.
-	If the PCF accept the HTTP PUT request to modify the events subscription, it sends an HTTP ""200 OK"" or HTTP ""204 No Content"" response.
-	Upon receipt of the HTTP DELETE request to remove subscription to all subscribed events, the PCF sends an HTTP ""204 No Content"" response.
9.	The PCF interacts with SMF according to Figure 5.2.2.2-1.",TS 29.513,5.2.2.2.2.2,all_images/image_1037.jpeg,AF Session Modification triggers PCF-initiated SM Policy Association
"This procedure is performed when the AF/NEF requests the PCF to delete the AF application session context.
NOTE:	The NEF acts as an AF to support the network exposure functionality for policy/charging capability.
For the integration with TSC networks the AF represented in the figures is either the TSN AF (integration with IEEE TSN networks) or the TSCTSF (integration with other TSC networks than IEEE TSN).
Figure 5.2.2.2.2.3-1: AF Session Termination triggers PCF-initiated SM Policy Association Modification procedure
1.	The AF sends the Npcf_PolicyAuthorization_Delete service operation by sending the HTTP POST request to the ""Individual Application Session Context"" resource to request the removal of the AF application session as defined in clause 4.2.3.2 of 3GPP TS 29.514 [10]. The request may include the events to subscribe to.
1a.	The AF sends a session termination request, Diameter STR, to the PCF to request the removal of the session. The request may include the events to subscribe to
2.	The PCF identifies the affected PDU Session where PCC rules related with this AF session are installed. These PCC rules need to be removed.
If the request in step 1 or step 1a does not include the event(s) or it includes the event(s) but the corresponding information is available at the PCF, step 3 or step3a is performed respectively; otherwise, the step 3* or step3a* is performed respectively.
3.	The PCF removes the AF application session context and sends an HTTP ""204 No Content"" or HTTP ""200 OK"" response to the AF.
3a.	The PCF sends a Diameter STA, session termination answer, to the AF.
3*.	The PCF removes the AF application session context and sends an HTTP ""200 OK"" response with the information corresponding to the requested event(s) to the AF.
3a*.	The PCF sends a Diameter STA, session termination answer with the information corresponding to the requested event(s), to the AF.
4.	The PCF interacts with SMF according to Figure 5.2.2.2-1.",TS 29.513,5.2.2.2.2.3,all_images/image_1038.jpeg,AF Session Termination triggers PCF-initiated SM Policy Association
"This procedure is performed when the SMF observes some policy control trigger condition is met or a PCC rule error is reported.
For the integration with TSC networks the AF represented in the figures is either the TSN AF (integration with IEEE TSN networks) or the TSCTSF (integration with other TSC networks than IEEE TSN).
Figure 5.2.2.3-1: SMF-initiated SM Policy Association Modification procedure
1.	The SMF detects a policy control request trigger condition is met or an error is reported.
2.	The SMF invokes the Npcf_SMPolicyControl_Update service operation to the PCF by sending the HTTP POST request to the ""Individual SM Policy"" resource with information on the conditions that have changed or a PCC rule error occurs.
If the feature ""TimeSensitiveNetworking"" or ""TimeSensitiveCommunication"" is supported and the ""TSN_BRIDGE_INFO"" policy control request trigger is provisioned in the SMF, the SMF may provide during PDU session establishment TSC user plan node information (DS-TT port number, DS-TT MAC address, if applicable, TSC user plane node Id and UE-DS-TT residence time, if available), and, if available, a UMIC and/or one or more PMIC(s) to the PCF, or, during PDU session modification procedures, updated UMIC and/or PMIC(s).
3.	If the (H-)PCF requires subscription-related information and does not have it, the (H-)PCF invokes the Nudr_DataRepository_Query service operation to the UDR by sending the HTTP GET request to the ""SessionManagementPolicyData"" resource to fetch the information.
Additionally, when network slice data rate related policy control is supported by the PCF, the PCF may invoke the Nudr_DataRepository_Query service operation towards the UDR by sending an HTTP GET request targeting the ""SlicePolicyControlData"" resource.
4.	The UDR sends an HTTP ""200 OK"" response to the PCF with the subscription related information containing the information about the allowed service(s) and PCC Rules information.
NOTE 1:	If the Npcf_SMPolicyControl_Update message of step 2 includes usage report(s), the (H-)PCF can also invoke the Nudr_DataRepository_Update service operation by sending an HTTP PATCH request to the ""SessionManagementPolicyData"" resource in order to update the usage monitoring information according to the received usage report(s).
NOTE 2:	If the Npcf_SMPolicyControl_Update message of step 2 includes the outcome of the resource allocation and network slice data rate policy control is supported, the (H-)PCF can also invoke the Nudr_DataRepository_Update service operation by sending an HTTP PATCH request targeting the ""SlicePolicyControlData"" resource in order to update the Remaining Maximum Slice Data Rate information.
5.	The PCF invokes the Npcf_PolicyAuthorization_Notify service operation to indicate that an event for which the AF requested a notification has occurred by sending the HTTP POST request with ""{notifUri}/notify"" as the callback URI to the AF or to request to the AF the deletion of the active application session if all the service data flows for the AF session are deleted by sending the HTTP POST request with ""{notifUri}/terminate"" as the callback URI to the AF.
If the feature ""TimeSensitiveNetworking"" or ""TimeSensitiveCommunication"" is supported:
-	When the PCF detects that there is no Individual Application Session Context resource bound to the Individual SM Policy resource the PCF shall provide the new TSC user plane node information received in step 2 to the TSN AF or TSCTSF by sending an HTTP POST request to the ""{notifUri}/new-bridge"" request URI, where the ""{notifUri}"" value is pre-configured in the PCF or, if not pre-configured, discovered by invoking the Nnrf_NFDiscovery service as defined in 3GPP TS 29.510 [51].
NOTE 3:	The TSCTSF registers in the NRF the notification URI within the default notification subscription for time sensitive communication and time synchronization notifications as described in 3GPP TS 29.510 [51].
-	When the PCF detects that there is an Individual Application Session Context resource bound to the Individual SM Policy resource, the PCF shall provide the received UMIC and/or PMICs to the AF by sending an HTTP POST request to the ""{notifUri}/notify"" callback URI.
When the PCF as a PCF for a PDU session becomes aware that a SM Policy Association that is being modified is receiving the callback URI of the PCF for a UE in step 2, the PCF shall send the event of PDU session established to the PCF for a UE by sending an HTTP POST request to the ""{notifUri}/pdu-session"" callback URI as defined in subclause 4.2.5.22 of 3GPP TS 29.514 [10].
5a.	If the AF requested a notification of the corresponding event, the PCF sends a Diameter RAR with the Specific-Action AVP set to indicate the event that caused the request. If all service data flows for an AF session are deleted, the PCF sends a Diameter ASR to request to the AF the termination of the active session.
6.	The AF sends an HTTP ""204 No Content"" response to the PCF.
If the feature ""TimeSensitiveNetworking"" or ""TimeSensitiveCommunication"" is supported and the TSN AF or TSCTSF received the notification of new TSC user plan node information over the ""{notifUri}/new-bridge"" request URI, the TSN AF or TSCTSF shall trigger the Npcf_PolicyAuthorization_Create service operation as described in clause 5.2.2.2.2.1, to request the creation of a new Individual Application Session Context resource specific to the PDU session identified by, for Ethernet type of PDU sessions, the received MAC address of the DS-TT port and for IP type of PDU sessions, the received UE IP address.
NOTE 4:	For the time synchronization service, the AF subscription to UE availability for time-synchronization service can occur after the PDU Session establishment has been completed in 5GS. Similarly, for the AF session with required QoS, the indication of the required QoS and TSC Assistance Container information can occur after the completion of the PDU session establishment. In such cases, the PCF sends the notification to the TSCTSF about the detection of a TSC user plane node information during PDU session establishment, but the TSCTSF doesn't have the time synchronization or required QoS available for the PDU session. In this case, the TSCTSF could defer the invocation of the Npcf_PolicyAuthorization_Create service operation till the reception of the subscription to UE availability for time synchronization or the AF session with required QoS occurs.
If the PCF for a UE receives the notification of PDU session establishment over the ""{notifUri}/pdu-session"" request URI and if the ""ApplicationDetectionEvents"" feature is supported, the PCF for a UE may trigger the Npcf_PolicyAuthorization_Subscribe service operation described in clause 4.2.6.9 to subscribe to the notification of the application detection;
6a.	If the AF receives an event notification, the AF replies with a Diameter RAA and may provide within it updated service information. If the AF receives an indication that all service data flows for an AF session are deleted, the AF replies with a Diameter ASA.
7.	If the PCF indicates in step 5 that an event for the active application session has occurred, the AF may invoke the Npcf_PolicyAuthorization_Update service operation to the PCF by sending the HTTP PATCH request to the ""Individual Application Session Context"" resource including the modified service information.
7a.	If the PCF indicates in step 5a that an event for the active application session has occurred, the AF may send a Diameter AAR to the PCF including the modified service information.
8.	The PCF sends an HTTP ""200 OK"" or an HTTP ""204 No Content"" response to the AF.
8a,	The AF responds by sending a Diameter AAA to the PCF.
9.	If the PCF indicates in step 5 that there are no transmission resources for the service, the AF may terminate the AF session by invoking the Npcf_PolicyAuthorization_Delete service operation by sending the HTTP POST request to the ""Individual Application Session Context"" resource to terminate the AF session. The request may include the events to subscribe to.
9a.	The AF sends a Diameter STR message to the PCF to indicate that the AF session is terminated.
10.	The PCF removes the AF application session context and sends an HTTP ""204 No Content"". If the PCF need to include the notification of event, it sends an HTTP ""200 OK"" response.
10a.	The PCF responds by sending a Diameter STA message to the AF and the AF session is terminated.
11.	If the PCF determines that the policy decision depends on the status of the policy counters available at the CHF and such reporting is not established for the subscriber, the PCF initiates an Initial Spending Limit Report as defined in clause 5.3.2. If policy counter status reporting is already established for the subscriber, and the PCF decides to modify the list of subscribed policy counters, the PCF sends an Intermediate Spending Limit Report as defined in clause 5.3.3. If the PCF decides to unsubscribe any future status notification of policy counters, it sends a Final Spending Limit Report Request to cancel the request for reporting the change of the status of the policy counters available at the CHF as defined in clause 5.3.4.
12.	The PCF makes a policy decision. The PCF may determine that updated or new policy information needs to be sent to the SMF in step 21.
13-14.	If network slice data rate related policy control applies, the (H-)PCF may invoke the Nudr_DataRepository_Update service operation by sending an HTTP PATCH request targeting the ""SlicePolicyControlData"" resource in order to update the Remaining Maximum Slice Data Rate information.
If the BindingUpdate feature defined in 3GPP TS 29.521 [22] is supported, the steps 15 to 16 will be performed, otherwise the steps 17 to 20 will be performed.
15.	If the UE address changes and the binding information has been previously registered in the BSF, or if the ""ExtendedSamePcf"" feature is supported, and the PCF registered binding information without including the UE address and UE address is received in step 2 and required for the retrieval of binding information by any NF (e.g. for PDU session binding), the PCF invokes the Nbsf_Management_Update service operation by sending an HTTP PATCH request to update the binding information in the BSF as detailed in clause 8.5.7.
16.	The PCF receives an HTTP ""200 OK"" response from the BSF.
17.	If the IP address is released for the IP PDU session or the MAC address is not used anymore for the Ethernet PDU session and the binding information has been previously registered in the BSF, the PCF invokes the Nbsf_Management_Deregister service operation by sending an HTTP DELETE request to the BSF to delete binding information as detailed in clause 8.5.3.
18.	The PCF receives an HTTP ""204 No Content"" response from the BSF as detailed in clause 8.5.3.
19.	If a new IP address is allocated for the IP PDU session or a new MAC address is used for the Ethernet PDU session and the BSF is to be used, or if the ""ExtendedSamePcf"" feature is supported, and the PCF registered binding information without including the UE address and UE address is received in step 2 and required for the retrieval of binding information by any NF, the PCF invokes the Nbsf_Management_Register service operation by sending an HTTP POST request to create the binding information in the BSF as detailed in clause 8.5.2.
20.	The PCF receives an HTTP ""201 Created"" response from the BSF with the created binding information as detailed in clause 8.5.2.
21.	The PCF sends an HTTP ""200 OK"" response to the SMF with updated policy information about the PDU Session determined in step 12.",TS 29.513,5.2.2.3,all_images/image_1039.jpeg,SMF-initiated SM Policy Association Modification procedure
"This procedure is performed when the UE requests to terminate a PDU session or based on some internal triggers in the SMF(e.g. operator policy).
Figure 5.2.3.1-1: SMF-initiated SM Policy Association Termination procedure
This procedure concerns both roaming and non-roaming scenarios.
In the LBO roaming case, the PCF acts as the V-PCF, and the V-PCF shall not contact the UDR/CHF. In the home routed roaming case, the PCF acts as the H-PCF, and the H-PCF interacts only with the H-SMF.
NOTE 1:	For LBO roaming case, session management policy data is not stored in the VPLMN. Therefore, interactions between PCF and UDR in the SM Policy Association Termination procedures do not apply to this scenario.
1.	The SMF invokes the Npcf_SMPolicyControl_Delete service operation by sending the HTTP POST request to the ""Individual SM Policy"" resource to request the PCF to delete the context of the SM related policy as defined in clause 4.2.5.2 of 3GPP TS 29.512 [9]. The request operation may include usage monitoring information (if applicable) and access network information.
2.	Upon receipt of Npcf_SMPolicyControl_Delete service operation, the PCF identifies the PCC Rules that require an AF to be notified and removes PCC Rules for the PDU Session.
3.	The SMF removes all the PCC Rules which are applied to the PDU session.
4.	The PCF invokes the Npcf_PolicyAuthorization_Notify service operation by sending the HTTP POST request with ""{notifUri}/terminate"" as the callback URI to the AF to trigger the AF to request the application session context termination.
When the PCF as a PDU session determins that the SM Policy Association that is terminating contains the callback URI for the PCF for a UE, the PCF shall send the event of PDU session terminated to the PCF for a UE by sending an HTTP POST request to the ""{notifUri}/pdu-session"" callback URI as defined in clause 4.2.5.22 of 3GPP TS 29.514 [10].
4a.	The PCF indicates the session abort to the AF by sending a diameter ASR to the AF.
5.	The AF sends an HTTP ""204 No Content"" response to the PCF.
5a.	The AF responds by sending a diameter ASA to the PCF.
6.	The AF invokes the Npcf_PolicyAuthorization_Delete service operation by sending the HTTP POST request to the ""Individual Application Session Context"" resource. The request may include the events to subscribe to.
6a.	The AF sends a diameter STR to the PCF to indicate that the session has been terminated. The request may include the events to subscribe to.
7.	The PCF removes the AF application session context and sends an HTTP ""204 No Content"" response to the AF. If the PCF needs to report usage data or the access network information, it sends an HTTP ""200 OK"" response. If usage thresholds were provided by the AF earlier, and the PCF has usage data that has not yet been reported to the AF, the PCF informs the AF about the resources that have been consumed by the user since the last report. If the SMF in step 1 reports the access network information and if the AF requested the PCF to report access network information in step 6 and/or the RAN-NAS-Cause feature is supported, the PCF informs the AF about the access network information. The PCF also deletes the subscription to PCF detected events for that AF application Session.
7a.	The PCF responds by sending a diameter STA to the AF. If usage thresholds were provided by the AF earlier, and the PCF has usage data that has not yet been reported to the AF, the PCF informs the AF about the resources that have been consumed by the user since the last report. If the SMF in step 1 reports the access network information and if the AF requested the PCF to report access network information in step 6a and/or the RAN-NAS-Cause feature is supported, the PCF informs the AF about the access network information.
8.	If this is the last PDU session for this subscriber the Final Spending Limit Report Request as defined in clause 5.3.4 is sent. If any existing PDU sessions for this subscriber require policy counter status reporting, the Intermediate Spending Limit Report Request as defined in clause 5.3.3 can be sent to alter the list of subscribed policy counters.
9.	The PCF removes PCC Rules for the terminated PDU Session and sends an HTTP ""204 No Content"" response to the SMF.
10.	The PCF invokes the Nudr_DataRepository_Update service operation by sending the HTTP PATCH request to the ""SessionManagementPolicyData"" resource to store the remaining usage allowance in the UDR, if all PDU sessions of the user to the same DNN and S-NSSAI are terminated.
Additionally, if network slice data rate related policy control applies, the (H-)PCF may invoke the Nudr_DataRepository_Update service operation by sending an HTTP PATCH request targeting the ""SlicePolicyControlData"" resource in order to update the Remaining Maximum Slice Data Rate information.
11.	The UDR sends an HTTP ""204 No Content"" response to the PCF.
12-13.	To unsubscribe the notification of the PDU session related data modification from the UDR, the PCF invokes the Nudr_DataRepository_Unsubscribe service operation by sending the HTTP DELETE request to the ""IndividualPolicyDataSubscription"" resource if it has subscribed such notification. The UDR sends an HTTP ""204 No Content"" response to the PCF.
Additionally, to unsubscribe the notification of changes of the AF influence data from the UDR, the PCF invokes the Nudr_DataRepository_Unsubscribe service operation by sending the HTTP DELETE request to the ""Individual Influence Data Subscription"" resource if it has subscribed such notification. The UDR sends an HTTP ""204 No Content"" response to the PCF.
-	Additionally, to unsubscribe from notifications about IPTV configuration data changes at the UDR, the PCF invokes the Nudr_DataRepository_Unsubscribe service operation by sending an HTTP DELETE request to the ""IndividualApplicationDataSubscription"" resource if it has subscribed such notification. The UDR sends an HTTP ""204 No Content"" response to the PCF.
14.	In the case that binding information has been previously registered in the BSF the PCF invokes the Nbsf_Management_Deregister service operation by sending an HTTP DELETE request to the BSF to delete binding information as detailed in clause 8.5.3.
NOTE:	The PCF invokes the Nbsf_Management_Deregister for every binding information previously registered in the BSF for the PDU session.
15.	The PCF receives an HTTP ""204 No Content response from the BSF as detailed in clause 8.5.3.",TS 29.513,5.2.3.1,all_images/image_1040.png,SMF-initiated SM Policy Association Termination procedure
"This procedure is performed when the PCF requests to terminate a SM Policy Association based on some external or internal triggers as described in step 1 below.
Figure 5.2.3.2-1: PCF-initiated SM Policy Association Termination procedure
This procedure concerns both roaming and non-roaming scenarios.
In the LBO roaming case, the PCF acts as the V-PCF. In the home routed roaming case, the PCF acts as the H-PCF, and the H-PCF interacts only with the H-SMF.
1.	The PCF makes policy decisions to terminate a PDU session based on an external trigger, e.g. UE subscription data is deleted, or based on an internal trigger, e.g. operator policy is changed.
2.	The PCF sends the Npcf_SMPolicyControl_UpdateNotify service operation by sending the HTTP POST request with ""{notificationUri}/delete"" as the callback URI to trigger the SMF to request the release of the PDU session as defined in clause 4.2.3.3 of 3GPP TS 29.512 [9]. The request includes resource URI of the individual SM policy to be deleted and the cause why the PCF requests the termination.
3.	The SMF sends an HTTP ""200 OK"" response to the PCF.
4.	The PCF interacts with SMF/AF/UDR/CHF/BSF according to Figure 5.2.3.1-1.",TS 29.513,5.2.3.2,all_images/image_1041.jpeg,PCF-initiated SM Policy Association Termination procedure
"Figure 5.5.3.2-1: Processing AF requests to influence traffic routing for Sessions identified by an UE address
1A.	The AF sends the AF request to PCF via the NEF.
1a-1b.	These steps are the same as steps 1-2 in Figure 5.5.3.3-1.
1c-1d.	If the PCF address is not available on the NEF based on local configuration, the NEF invokes the Nbsf_Management_Discovery service operation, specified in clause 8.5.4, to obtain the selected PCF ID for the ongoing PDU session identified by the individual UE address in the AF request.
1e-1f.	The NEF forwards the AF request to the PCF.
When receiving the Nnef_TrafficInfluence_Create request in step 1a, the NEF invokes the Npcf_PolicyAuthorization_Create service operation by sending the HTTP POST request to the ""Application Sessions"" resource as described in clause 5.2.2.2.2.1. If the ""URLLC"" feature defined in 3GPP TS 29.514 [10] is supported, and the indication of AF acknowledgement was received from the AF request, the NEF forwards the indication to the PCF as described in 3GPP TS 29.514 [10]. If the ""SimultConnectivity"" feature defined in 3GPP TS 29.514 [10] is supported, and the indication of simultaneous temporary connectivity for source and target PSA, and, optionally, guidance about when the connectivity over the source PSA can be removed were received from the AF request, the NEF forwards the received indication(s) to the PCF as described in 3GPP TS 29.514 [10]. If the ""EASDiscovery"" feature defined in 3GPP TS 29.514 [10] is supported, and, the indication of the EAS rediscovery is received from the AF request, the NEF forwards the received indication to the PCF as described in 3GPP TS 29.514 [10]. If the ""EASIPreplacement"" feature defined in 3GPP TS 29.514 [10] is supported and the EAS IP replacement information is received in the AF request, the NEF forwards the received EAS IP replacement information to the PCF as described in 3GPP TS 29.514 [10].
When receiving the Nnef_TrafficInfluence_Update request in step 1a, the NEF invokes the Npcf_PolicyAuthorization_Update service operation by sending the HTTP PATCH request to the ""Individual Application Session Context"" resource as described in clause 5.2.2.2.2.2. If the ""URLLC"" feature defined in 3GPP TS 29.514 [10] is supported, and the indication of AF acknowledgement was received from the AF request, the NEF forwards the indication to the PCF as described in 3GPP TS 29.514 [10]. If the ""SimultConnectivity"" feature defined in 3GPP TS 29.514 [10] is supported, and the indication of simultaneous temporary connectivity for source and target PSA, and, optionally, guidance about when the connectivity over the source PSA can be removed were received from the AF request, the NEF forwards the received indication(s) to the PCF as described in 3GPP TS 29.514 [10].
When receiving the Nnef_TrafficInfluence_Delete request in step 1a The NEF invokes the Npcf_PolicyAuthorization_Delete service operation by sending the HTTP POST request to the ""Individual Application Session Context"" resource as described in clause 5.2.2.2.2.3.
1g	The NEF sends the HTTP response message to the AF correspondingly.
1B.	The AF sends the AF request to PCF directly.
1a-1b.	If the PCF address is not available on the AF based on local configuration, the AF invokes the Nbsf_Management_Discovery service operation, as specified in clause 8.5.4, to obtain the selected PCF ID for the ongoing PDU session identified by the individual UE address in its request.
1c-1d.	To create a new AF request, the AF invokes the Npcf_PolicyAuthorization_Create service operation by sending the HTTP POST request to the ""Application Sessions"" resource as described in clause 5.2.2.2.2.1. If the ""URLLC"" feature defined in 3GPP TS 29.514 [10] is supported, the AF may provide an indication of AF acknowledgement to be expected as described in 3GPP TS 29.514 [10]. If the ""SimultConnectivity"" feature defined in 3GPP TS 29.514 [10] is supported, the AF may provide an indication of simultaneous temporary connectivity for source and target PSA, and, optionally, guidance about when the connectivity over the source PSA can be removed were received from the AF request to the PCF as described in 3GPP TS 29.514 [10]. If the ""EASDiscovery"" feature defined in 3GPP TS 29.514 [10] is supported, the AF may provide an indication of the EAS rediscovery to the PCF as described in 3GPP TS 29.514 [10]. If the ""EASIPreplacement"" feature defined in 3GPP TS 29.514 [10] is supported, the AF may provide the EAS IP replacement information to the PCF as described in 3GPP TS 29.514 [10]. If the ""AF_latency"" feature defined in 3GPP TS 29.514 [10] is supported, the AF may provide the maximum allowed user plane latency to the PCF as described in 3GPP TS 29.514 [10].
To update an existing AF request, the AF invokes the Npcf_PolicyAuthorization_Update service operation by sending the HTTP PATCH request to the ""Individual Application Session Context"" resource as described in clause 5.2.2.2.2.2. If the ""URLLC"" feature defined in 3GPP TS 29.514 [10] is supported, the AF may provide an indication of AF acknowledgement to be expected as described in 3GPP TS 29.514 [10]. If the ""SimultConnectivity"" feature defined in 3GPP TS 29.514 [10] is supported, the AF may provide an indication of simultaneous temporary connectivity for source and target PSA, and, optionally, guidance about when the connectivity over the source PSA can be removed were received from the AF request to the PCF as described in 3GPP TS 29.514 [10]. If the ""EASDiscovery"" feature defined in 3GPP TS 29.514 [10] is supported, the AF may provide an indication of the EAS rediscovery to the PCF as described in 3GPP TS 29.514 [10]. If the ""EASIPreplacement"" feature defined in 3GPP TS 29.514 [10] is supported, the AF may provide the EAS IP replacement information to the PCF as described in 3GPP TS 29.514 [10]. If the ""AF_latency"" feature defined in 3GPP TS 29.514 [10] is supported, the AF may provide the maximum allowed user plane latency to the PCF as described in 3GPP TS 29.514 [10].
To remove an existing AF request, the AF invokes the Npcf_PolicyAuthorization_Delete service operation by sending the HTTP POST request to the ""Individual Application Session Context"" resource as described in clause 5.2.2.2.2.3.
2-3.	Upon receipt of the AF request, the PCF invokes the Npcf_SMPolicyControl_UpdateNotify service operation to update the SMF with corresponding PCC rule(s) by sending the HTTP POST request to the callback URI ""{notificationUri}/update"" as described in clause 5.2.2.2.1. If the AF subscribes to UP Path change event, the PCF includes the related subscription information within the corresponding PCC rule(s) , in addition, if the ""URLLC"" feature defined in 3GPP TS 29.512 [9] is supported, and the indication of AF acknowledgement was received from the AF request, the PCF includes within the PCC rule(s) the indication of AF acknowledgement to be expected as specified in 3GPP TS 29.512 [9]. If the ""SimultConnectivity"" feature defined in 3GPP TS 29.512 [9] is supported, and the indication of simultaneous temporary connectivity for source and target PSA, and, optionally, guidance about when the connectivity over the source PSA can be removed, were received from the AF request, the PCF includes within the PCC rule(s) the received indication(s) as specified in 3GPP TS 29.512 [9]. If the ""EASDiscovery"" feature defined in 3GPP TS 29.512 [9] is supported, and the indication of the EAS rediscovery was received in the AF request, the PCF includes within the PCC rule(s) the received indication as specified in 3GPP TS 29.512 [9]. If the ""EASIPreplacement"" feature defined in 3GPP TS 29.512 [9] is supported, and the EAS IP replacement information was received in the AF request, the PCF includes within the PCC rule(s) the received information as specified in 3GPP TS 29.512 [9]. If the ""AF_latency"" feature defined in 3GPP TS 29.512 [9] is supported, and the maximum allowed user plane latency was received, the PCF includes within the PCC rule(s) the received maximum allowed user plane latency as specified in 3GPP TS 29.512 [9].
-	For the case of 4A, the PCF includes in the PCC rule(s) the Notification URI pointing to the NEF and the Notification Correlation ID assigned by NEF.
-	For the case of 4B, the PCF includes in the PCC rule(s) the Notification URI pointing to the AF and the Notification Correlation ID assigned by AF.
If the AF unsubscribes from UP Path change event, the PCF removes the related subscription information from the corresponding PCC rule(s) as specified in 3GPP TS 29.512 [9].
3a.	When the SMF installs PCC rule successfully, the SMF determines whether UP path change needs to be enforced. In this case, the SMF:
-	when early notification is required, shall notify as described in step 4 before reconfiguring the User Plane of the PDU session;
-	takes appropriate actions to reconfigure the User plane of the PDU Session such as:
i.	adding, replacing or removing a UPF in the data path to e.g. act as an UL CL or a Branching Point;
ii.	allocate a new Prefix to the UE (when IPv6 multi-Homing applies);
iii.	updating the UPF in the target DNAI with new traffic steering rules;
iv.	using the received maximum allowed user plane latency to decide whether edge relocation is needed to ensure that the user plane latency does not exceed the value and whether to relocate the PSA UPF to satisfy the user plane latency
v.	(re)configure Local PSA for EAS IP address replacement if applicable;
vi.	establishing a temporary N9 forwarding tunnel between the source UL CL and target UL CL and, if the AF requested so, and ""SimultConnectivity"" is supported in the concerned interfaces, maintaining simultaneous connectivity temporarily for the source and target PSA until the traffic ceases to exist for an AF indicated period of time or locally configured value; and
-	when late notification is required, shall notify as described in step 4 after reconfiguring the User Plane of the PDU session.
If the ""EASDiscovery"" feature is supported, and if UP path is enforced and/or the indication of the EAS rediscovery was received, the SMF indicates to the UE to refresh the cached EAS information as defined in clause 6.3.2 of 3GPP TS 24.501 [20].
4A.	In case of 1A, if the SMF observes PDU Session related event(s) that AF has subscribed to, the SMF sends notification to the AF via the NEF.
4a-4d.	The SMF invokes Nsmf_EventExposure_Notify service operation to the AF via the NEF by sending an HTTP POST request. When receiving the Nsmf_EventExposure_Notify service operation, the NEF performs information mapping (e.g. Notification Correlation ID to AF Transaction ID, etc.), and invokes the Nnef_TrafficInfluence_Notify service operation to forward the notification to the AF. If the indication of AF acknowledgement to be expected was included in the PCC rule(s), the SMF may notify with a notification URI for AF acknowledgement as described in 3GPP TS 29.508 [8], and then the NEF also notifies with a URI for the AF acknowledgement as described in 3GPP TS 29.522 [24].
4e-4h.	When receiving the notification with the URI for AF acknowledgement, the AF acknowledges the notification to the SMF identified by the notification URI via the NEF. If the ""EASIPreplacement"" feature defined in 3GPP TS 29.522 [24] is supported, the AF may provide the EAS IP replacement information to the NEF. Then the NEF notifies the SMF of the EAS IP replacement information as described in 3GPP TS 29.508 [8] if the NEF determines that the SMF supports the ""EASIPreplacement"" featureas defined in 3GPP TS 29.508 [8]. The AF may provide an indication that buffering of uplink traffic to the target DNAI is needed to the NEF. Then the NEF notifies the SMF of indication as described in 3GPP TS 29.508 [8] if the NEF determines that the SMF supports the ""ULBuffering"" feature as defined in 3GPP TS 29.508 [8].
The step is the same as steps 7-14 in Figure 5.5.3.3-1.
4B.	In case of 1B, if the SMF observes PDU Session related event(s) that AF has subscribed to, the SMF sends notification to the AF directly.
4a-4b.	The SMF invokes Nsmf_EventExposure_Notify service operation to the AF directly by sending an HTTP POST request to the callback URI ""{notifUri}"", and the AF sends a ""204 No Content"" response to the SMF. If the indication of AF acknowledgement to be expected was included in the PCC rule(s), the SMF may provide an URI for the AF acknowledgement as described in 3GPP TS 29.508 [8].
4c-4d.	When receiving the notification with the URI for AF acknowledgement from the SMF, the AF invokes Nsmf_EventExposure_AppRelocationInfo service operation by sending an HTTP POST request to the callback URI ""{ackUri}"" to acknowledge the notification, and the SMF sends a ""204 No Content"" response to the AF. The AF may provide the EAS IP replacement information to the SMF as described in 3GPP TS 29.508 [8] if the AF determines that the SMF supports the ""EASIPreplacement"" feature as defined in 3GPP TS 29.508 [8].The AF may provide an indication that buffering of uplink traffic to the target DNAI is needed to the SMF as described in 3GPP TS 29.508 [8] if the AF determines that the SMF supports the ""ULBuffering"" feature as defined in 3GPP TS 29.508 [8].",TS 29.513,5.5.3.2,all_images/image_1043.png,Processing AF requests to influence traffic routing for Sessions identified by an UE
"If the AF traffic influence request affects future PDU session, the traffic influence procedure is performed as depicted in Figure 5.5.3.3-1.
Figure 5.5.3.3-1: Processing AF requests to influence traffic routing for Sessions not identified by an UE address, affecting future PDU session
1.	To create a new AF request, the AF invokes the Nnef_TrafficInfluence_Create service operation to the NEF by sending the HTTP POST request to the ""Traffic Influence Subscription"" resource. If the ""URLLC"" feature defined in 3GPP TS 29.522 [24] is supported, the AF may provide an indication of AF acknowledgement to be expected. If the ""AF_latency"" feature defined in 3GPP TS 29.522 [24] is supported, the AF may provide a maximum allowed user plane latency to ensure that the user plane latency in the 5GC does not exceed that value and to allow the SMF decide whether to relocate the PSA UPF to satisfy the user plane latency. If the ""SimultConnectivity"" feature defined in 3GPP TS 29.522 [24] is supported, the AF may provide the indication of simultaneous temporary connectivity for source and target PSA, and, optionally, guidance about when the connectivity over the source PSA can be removed.
To update an existing AF request, the AF invokes the Nnef_TrafficInfluence_Update service operation by sending the HTTP PUT or PATCH request to the ""Individual Traffic Influence Subscription"" resource. If the ""URLLC"" feature defined in 3GPP TS 29.522 [24] is supported, the AF may provide an indication of AF acknowledgement to be expected. If the ""AF_latency"" feature defined in 3GPP TS 29.522 [24] is supported, the AF may provide a maximum allowed user plane latency to ensure that the user plane latency in the 5GC does not exceed that value and to alow the SMF decide whether to relocate the PSA UPF to satisfy the user plane latency. If the ""SimultConnectivity"" feature defined in 3GPP TS 29.522 [24] is supported, the AF may provide the indication of simultaneous temporary connectivity for source and target PSA, and, optionally, guidance about when the connectivity over the source PSA can be removed.
To remove an existing AF request, the AF invokes the Nnef_TrafficInfluence_Delete service operation by sending the HTTP DELETE request to the ""Individual Traffic Influence Subscription"" resource.
2.	Upon receipt of the AF request, the NEF authorizes it and then performs the mapping from the information provided by the AF into information needed by the 5GC as described in 3GPP TS 23.501 [2] and 3GPP TS 23.502 [3].
3-4.	When receiving the Nnef_TrafficInfluence_Create request, the NEF invokes the Nudr_DataRepository_Create service operation to store the AF request information in the UDR by sending the HTTP PUT request to the ""Individual Influence Data"" resource, and the UDR sends a ""201 Created"" response. If the ""SimultConnectivity"" feature defined in 3GPP TS 29.519 [12] is supported, and the indication of simultaneous temporary connectivity for source and target PSA, and, optionally, guidance about when the connectivity over the source PSA can be removed, were received from the AF request, the NEF includes within the creation request the received indication(s) as specified in 3GPP TS 29.519 [12]. If the ""AF_latency"" feature defined in 3GPP TS 29.519 [12] is supported, and the maximum allowed user plane latency was received from the AF request, the NEF includes within the creation request the received maximum allowed user plane latency as specified in 3GPP TS 29.519 [12].
When receiving the Nnef_TrafficInfluence_Update request, the NEF invokes the Nudr_DataRepository_Update service operation to modify the AF request information in the UDR by sending the HTTP PATCH/PUT request to the resource ""Individual Influence Data"", and the UDR sends a ""200 OK"" or ""204 No Content"" response accordingly. If the ""SimultConnectivity"" feature defined in 3GPP TS 29.519 [12] is supported, and the indication of simultaneous temporary connectivity for source and target PSA, and, optionally, guidance about when the connectivity over the source PSA can be removed, were received from the AF request, the NEF includes within the update request the received indication(s) as specified in 3GPP TS 29.519 [12]. If the ""AF_latency"" feature defined in 3GPP TS 29.519 [12] is supported, and the maximum allowed user plane latency was received from the AF request, the NEF includes within the update request the received maximum allowed user plane latency as specified in 3GPP TS 29.519 [12].
When receiving the Nnef_TrafficInfluence_Delete request, the NEF invokes the Nudr_DataRepository_Delete service operation to delete the AF requirements from the UDR by sending the HTTP DELETE request to the ""Individual Influence Data"" resource, and the UDR sends a ""204 No Content"" response.
5.	The NEF sends the HTTP response message to the AF correspondingly.
6.	The PCF retrieves the stored AF request in the UDR by invoking the Nudr_DataRepository_Query service operation during SM Policy Association Establishment procedure (see clause 5.2.1).
The PCF generates the PCC rule(s) based on the AF request and provides it to the SMF. If the AF subscribes to UP Path change event, the PCF includes the Notification URI pointing to the NEF and the Notification Correlation ID assigned by NEF within the corresponding PCC rule(s) as specified in 3GPP TS 29.512 [9]. If the AF unsubscribes from UP Path change event, the PCF removes the related subscription information from the corresponding PCC rule(s) as specified in 3GPP TS 29.512 [9].
If the ""SimultConnectivity"" feature defined in 3GPP TS 29.512 [9] is supported, and the indication of simultaneous temporary connectivity for source and target PSA, and, optionally, guidance about when the connectivity over the source PSA can be removed, were stored in UDR, the PCF includes within the PCC rule(s) the received indication(s) as specified in 3GPP TS 29.512 [9].
If the ""AF_latency"" feature defined in 3GPP TS 29.512 [9] is supported, and the maximum allowed user plane latency was stored in UDR, the PCF includes within the PCC rule(s) the received maximum allowed user plane latency as specified in 3GPP TS 29.512 [9].
6a.	This step is the same as the step 3a in Figure 5.5.3.2-1.
7.	If the SMF observes PDU Session related event(s) that AF has subscribed to, the SMF invokes the Nsmf_EventExposure_Notify service operation to the NEF by sending an HTTP POST request to the callback URI ""{notifUri}"". If the indication of AF acknowledgement to be expected was included in the PCC rule(s), the SMF may notify with an URI for the AF acknowledgement as described in 3GPP TS 29.508 [8].
8.	When receiving the Nsmf_EventExposure_Notify service operation, the NEF performs information mapping (e.g. Notification Correlation ID to AF Transaction ID), and invokes the Nnef_TrafficInfluence_Notify service operation to forward the notification to the AF by sending the HTTP request to the callback URI ""notificationDestination"" as specified in 3GPP TS 29.522 [24]. If the notification from the SMF includes an URI for the AF acknowledgement, the NEF also notifies with a URI for the AF acknowledgement as described in 3GPP TS 29.522 [24].
9.	The AF sends an HTTP ""204 No Content"" response to the NEF.
10.	The NEF sends an HTTP ""204 No Content"" response to the SMF.
11-12.	When receiving the notification with the URI for AF acknowledgement from the NEF, the AF invokes Nnef_TrafficInfluence_AppRelocationInfo service operation by sending an HTTP POST request to the callback URI ""{afAckUri}"" to acknowledge the notification, and the NEF sends a ""204 No Content"" response to the AF. If the ""ULBuffering"" feature is supported, the AF may provide an indication that buffering of uplink traffic to the target DNAI is needed to the NEF.
13-14.	When receiving the AF acknowledgement from the AF, to forward it to the SMF, the NEF invokes Nsmf_EventExposure_AppRelocationInfo service operation by sending an HTTP POST request to the callback URI ""{ackUri}"", and the SMF sends a ""204 No Content"" response to the NEF. If the NEF receives the indication that buffering of uplink traffic to the target DNAI is needed and the NEF determines that the SMF supports the ""ULBuffering"" feature as defined in 3GPP TS 29.508 [8], the NEF provides the indication that buffering of uplink traffic to the target DNAI is needed to the SMF.
If the AF traffic influence request affects ongoing PDU session, the traffic influence procedure is performed as depicted in Figure 5.5.3.3-2.
Figure 5.5.3.3-2: Processing AF requests to influence traffic routing for Sessions not identified by an UE address, affecting ongoing PDU session
0.	The PCF subscribes to the changes of traffic influence data in the UDR during SM Policy Association establishment procedure (see clause 5.2.1).
1-5.	These steps are the same as steps 1-5 in Figure 5.5.3.3-1.
6-7.	The UDR invokes the Nudr_DataRepository_Notify service operation to PCF(s) that have subscribed to modifications of AF requests by sending the HTTP POST request to the callback URI ""{notificationUri}"", and the PCF sends a ""204 No Content"" response to the UDR.
8-9.	Upon receipt of the AF request from the UDR, the PCF determines if existing PDU Sessions are potentially impacted by the AF request. For each of these PDU Sessions, the PCF invokes the Npcf_SMPolicyControl_UpdateNotify service operation to update the SMF with corresponding PCC rule(s) by sending the HTTP POST request to the callback URI ""{notificationUri}/update"" as described in clause 5.2.2.2.1.
If the AF subscribes to UP Path change event, the PCF includes the information on AF subscription to UP path change event within the corresponding PCC rule(s) as specified in 3GPP TS 29.512 [9]. If the AF unsubscribes from UP Path change event, the PCF removes the related subscription information from the corresponding PCC rule(s) as specified in 3GPP TS 29.512 [9].
If the ""SimultConnectivity"" feature defined in 3GPP TS 29.512 [9] is supported, and the indication of simultaneous temporary connectivity for source and target PSA, and, optionally, guidance about when the connectivity over the source PSA can be removed, were stored in UDR, the PCF includes within the PCC rule(s) the received indication(s) as specified in 3GPP TS 29.512 [9].
If the ""AF_latency"" feature defined in 3GPP TS 29.512 [9] is supported, and the maximum allowed user plane latency was stored in UDR, the PCF includes within the PCC rule(s) the received maximum allowed user plane latency as specified in 3GPP TS 29.512 [9].
9a.	This step is the same as step 6a in Figure 5.5.3.3-1.
10-17.	These steps are the same as steps 7-14 in Figure 5.5.3.3-1.",TS 29.513,5.5.3.3,all_images/image_1044.png,Processing AF requests to influence traffic routing for Sessions not identified by an
"Figure 5.5.4-1: Negotiation for future background data transfer procedure
1.	The AF invokes the Nnef_BDTPNegotiation_Create service operation by sending an HTTP POST request to the resource ""BDT Subscription"" to get background data transfer policies. The AF request shall contain an ASP identifier, the volume of data to be transferred per UE, the expected amount of UEs, the desired time window and optionally, network area information either as a geographical area (e.g. a civic address or shapes), or an area of interest that includes a list of TAs and/or list of NG-RAN nodes and/or a list of cell identifiers. When the AF provides a geographical area, then the NEF maps it based on local configuration into a short list of TAs and/or NG-RAN nodes and/or cells identifiers that is provided to the (H-)PCF.
If the ""BdtNotification_5G"" feature defined in 3GPP TS 29.122 [34] is supported, the AF request may contain a notification URI to request the BDT warning notification.
NOTE 1:	A 3rd party application server is typically not able to provide any specific network area information and if so, the AF request is for a whole operator network.
2.	Upon receipt of a Background Data Transfer request from the AF indicating a transfer policy request, the NEF invokes the Npcf_BDTPolicyControl_Create service operation with the (H-)PCF by sending an HTTP POST request to the resource ""BDT policies"". The request operation includes the ASP identifier, the volume of data to be transferred per UE, the expected number of UEs, the desired time window, and optionally the network area information (list of TAIs and/or NG-RAN nodes and/or cells identifiers).
If the AF requests the BDT warning notification in step 1, and if the ""BdtNotification_5G"" feature defined in 3GPP TS 29.544 [26] is supported, the NEF provides a notification URI to request the BDT warning notification correspondingly.
NOTE 2:	The NEF may contact any PCF in the operator network.
3-4.	The (H-) PCF may invoke the Nudr_DataRepository_Query service operation by sending an HTTP GET request to the resource ""BdtData"", to request from the UDR all stored transfer policies. The UDR sends an HTTP ""200 OK"" response to the (H-) PCF.
NOTE 3:	In case only one PCF is deployed in the network, transfer policies can be locally stored in the PCF and the interaction with the UDR is not required.
5.	The (H-) PCF determines one or more transfer policies based on the information received from the NEF and other available information (e.g. network policy, existing transfer policies, network area information, network performance information from the NWDAF and load status estimation for the desired time window).
6.	The (H-) PCF sends a ""201 Created"" response to the Npcf_BDTPolicyControl_Create service operation with the acceptable one or more transfer policies and a Background Data Transfer Reference ID.
7.	The NEF sends a ""201 Created"" response to forward the received transfer policies to the AF. If the NEF received only one background transfer policy from the (H) PCF, steps 8-11 are not executed and the flow proceeds to step 12. Otherwise, the flow proceeds to step 8.
8.	The AF invokes the Nnef_BDTPNegotiation_Update service operation by sending an HTTP PATCH request to the resource ""Individual BDT Subscription"" to provide the NEF with the selected background data transfer policy.
9.	The NEF invokes the Npcf_BDTPolicyControl_Update service operation by sending an HTTP PATCH request to the resource ""Individual BDT policy"" to provide the (H-)-PCF with the selected background data transfer policy.
10.	The (H-) PCF sends an HTTP PATCH response message to the NEF.
11.	The NEF sends an HTTP PATCH response message to the AF.
12-13.	If the (H-)PCF does not locally store the transfer policy, it invokes the Nudr_DataRepository_Update service operation by sending an HTTP PUT request to the resource ""IndividualBdtData"", to store for the provided ASP identifier the new transfer policy together with the associated background data transfer reference ID, the volume of data per UE, the expected number of UEs and if available the corresponding network area information in the UDR. The UDR sends an HTTP ""201 Created"" response to the (H-)PCF.
NOTE 4:	For details of Nnef_BDTPNegotiation_Create/Update service operations refer to 3GPP TS 29.522 [24].
NOTE 5:	For details of Npcf_BDTPolicyControl_Create/Update service operations refer to 3GPP TS 29.554 [26].
NOTE 6:	For details of Nudr_DataRepository_Query/Update service operations refer to 3GPP TS 29.519 [12] and 3GPP TS 29.504 [27].",TS 29.513,5.5.4,all_images/image_1046.jpeg,Negotiation for future background data transfer procedure
"Figure 5.5.6-1: Background data transfer policy applying procedure
0.	The AF negotiates policy for background data transfer during Negotiation for future background data transfer procedure (see clause 5.5.4).
1.	To apply the negotiated Background Data Transfer Policy to UE or a group of UE, the AF invokes the Nnef_ApplyPolicy_Create service operation to the NEF by sending the HTTP POST request to the ""Applied BDT Policy Subscriptions"" resource.
To update the applied policy, the AF invokes the Nnef_ApplyPolicy_Update service operation by sending the HTTP PATCH request to the ""Individual Applied BDT Policy Subscription"" resource.
To remove the applied policy, the AF invokes the Nnef_ApplyPolicy_Delete service operation by sending the HTTP DELETE request to the ""Individual Applied BDT Policy Subscription"" resource.
NOTE 1:	For details of Nnef_ApplyPolicy_Create/Update/Delete service operations refer to 3GPP TS 29.522 [24].
2.	Upon receipt of the AF request, the NEF authorizes it and then performs the mapping from the information provided by the AF into information needed by the 5GC as described in 3GPP TS 23.502 [3].
3-4.	When receiving the Nnef_ApplyPolicy_Create request, the NEF invokes the Nudr_DataRepository_Create service operation to store the AF request information in the UDR by sending the HTTP PUT request to the ""Individual Applied BDT Policy Data"" resource, and the UDR sends a ""201 Created"" response.
When receiving the Nnef_ApplyPolicy_Update request, the NEF invokes the Nudr_DataRepository_Update service operation to modify the AF request information in the UDR by sending the HTTP PATCH request to the resource ""Individual Applied BDT Policy Data"", and the UDR sends a ""200 OK"" or ""204 No Content"" response.
When receiving the Nnef_ApplyPolicy_Delete request, t he NEF invokes the Nudr_DataRepository_Delete service operation to delete the AF requirements from the UDR by sending the HTTP DELETE request to the ""Individual Applied BDT Policy Data"" resource, and the UDR sends a ""204 No Content"" response.
5.	The NEF sends the HTTP response message to the AF correspondingly.
6A.	The PCF previously subscribed to the changes of Applied BDT Policy Data during UE Policy Association Establishment procedure (see clause 5.6.1.2).
6a.	The UDR invokes the Nudr_DataRepository_Notify service operation to PCF(s) that have subscribed to the changes of Applied BDT Policy Data by sending the HTTP POST request to the callback URI ""{notificationUri}"".
6b.	The PCF sends a ""204 No Content"" response to the UDR.
6c.	The PCF initiates UE Policy Association Modification procedure (see clause 5.6.2.2.2) to send the background data transfer policy to the UE.
6B.	The PCF retrieves the Applied BDT Policy Data in the UDR by invoking the Nudr_DataRepository_Query service operation and sends the background data transfer policy to the UE during UE Policy Association Establishment procedure (see clause 5.6.1.2).
7.	The PCF invokes the Nudr_DataRepository_Update service operation to the UDR by sending the HTTP PATCH request to the ""SessionManagementPolicyData"" resource, to store the BDT reference ID(s) into the PDU session related policy data.
8.	The UDR sends a ""204 No Content"" or ""200 OK"" response to the PCF.
NOTE 2:	For details of the Nudr_DataRepository_Create/Update/Delete/Notify service operations refer to 3GPP TS 29.504 [27] and 3GPP TS 29.519 [12].",TS 29.513,5.5.6,all_images/image_1048.jpeg,Background data transfer policy applying procedure
"This procedure concerns only non-roaming scenarios, i.e. to cases where the involved entities serving the UE (i.e. NEF, PCF, BSF, AMF) belong to the home PLMN. The AF may belong to the home PLMN (trusted AF) or to a third party (untrusted AF).
This procedure is used for individual UEs when the request shall be applied independently of conditions related to the application traffic. The AF may interact with NFs of the Core Network either directly or via the NEF. The procedure for the NEF-mediated case is described in Figure 5.5.10.2-1, while the procedure for the direct case is described in Figure 5.5.10.2-2.
Figure 5.5.10.2-1: Processing NEF-mediated AF requests for Access and Mobility related policy authorization for a UE
1.	An AM Policy Association is established as described in clause 5.1.1. This step can occur at any time before step 7.
2.	To create a new AF request, the AF invokes the Nnef_AMPolicyAuthorization_Create service operation to the NEF by sending an HTTP POST request to the ""Application AM Contexts"" resource as described in clause 4.4.26.2 of 3GPP TS 29.522 [24].
To update an existing AF request, the AF invokes the Nnef_AMPolicyAuthorization_Update service operation by sending an HTTP PATCH request to the ""Individual Application AM Context"" resource as described in clause 4.4.26.3 of 3GPP TS 29.522 [24].
To remove an existing AF request, the AF invokes the Nnef_AMPolicyAuthorization_Delete service operation by sending an HTTP DELETE request to the ""Individual Application AM Context"" resource as described in clause 4.4.26.4 of 3GPP TS 29.522 [24].
3.	Upon receipt of the AF request, the NEF authorizes it, stores it, and performs the mapping from the information provided by the AF into information needed by the 5GC (e.g. translate a GPSI into a SUPI) as described in 3GPP TS 23.501 [2] and 3GPP TS 23.502 [3].
4.	The NEF responds to the AF request creation, update, or deletion as described respectively in clauses 4.4.26.2, 4.4.26.3, or 4.4.26.4 of 3GPP TS 29.522 [24].
If the creation or update request included the subscription to event(s) together with the indication of immediate reporting of the currently available values of the subscribed events, the NEF includes in the response the applicable event(s) information, if available, as specified in clauses 4.4.26.2, or 4.4.26.4 of 3GPP TS 29.522 [24]. In this case, the response is deferred after step 10.
5.	The NEF may subscribe to (or unsubscribe from) the BSF using Nbsf_Management_Subscribe (or Nbsf_Management_Unsubscribe) to be informed about the PCF for a UE of the UE targeted in the AF request received in step 2, as described in clause 4.2.6 (for subscribing) or clause 4.2.7 (for unsubscribing) of 3GPP TS 29.521 [22].
6.	The BSF responds by confirming the received request and, in the case of subscription, including the existing PCF for a UE registration in the response, if found, as described in clause 4.2.6.2 of 3GPP TS 29.521 [22].
7.	The BSF notifies the NEF once there is a PCF for a UE registration for the UE indicated in the subscription as described in clause 4.2.8 of 3GPP TS 29.521 [22].
8.	The NEF confirms the received notification by sending a ""204 No Content"" response as described in clause 4.2.8 of 3GPP TS 29.521 [22].
9.	The NEF forwards the AF request to the PCF.
If the NEF received the Nnef_AMPolicyAuthorization_Create request in step 2, the NEF invokes the Npcf_AMPolicyAuthorization_Create service operation by sending an HTTP POST request to the ""Application AM Contexts"" resource as described in clause 4.2.2 of 3GPP TS 29.534 [50].
If the NEF received the Nnef_AMPolicyAuthorization_Update request in step 2, the NEF invokes the Npcf_AMPolicyAuthorization_Update service operation by sending an HTTP PATCH request to the ""Individual Application AM Context"" resource as described in clause 4.2.3 of 3GPP TS 29.534 [50].
If the NEF received the Nnef_AMPolicyAuthorization_Delete request in step 2, the NEF invokes the Npcf_AMPolicyAuthorization_Delete service operation by sending an HTTP DELETE request to the ""Individual Application AM Context"" resource as described in clause 4.2.4 of 3GPP TS 29.534 [50].
10.	The PCF responds to the creation, update, or deletion request as described respectively in clauses 4.2.2, 4.2.3, or 4.2.4 of 3GPP TS 29.534 [50].
If the creation or update request included the subscription to event(s) together with the indication of immediate reporting of the currently available values of the subscribed events, the PCF includes in the response the applicable event(s) information, if available, as specified respectively in clauses 4.2.2 or 4.2.3 of 3GPP TS 29.534 [50].
11.	AM Policy Association modification initiated by the PCF may be performed as described in clause 5.1.2.2.
12-13.	If an event (e.g. service coverage area change) occurs to which the NEF has previously subscribed, the PCF notifies the NEF using the Npcf_AMPolicyAuthorization_Notify service operation by sending an HTTP POST request to the callback URI included in the subscription, and the NEF responds by sending a confirmation, as described in clause 4.2.7 of 3GPP TS 29.534 [50].
14-15.	When the NEF receives from the PCF an event (e.g. service coverage area change) to which the AF has previously subscribed, the NEF notifies the AF using the Nnef_AMPolicyAuthorization_Notify service operation by sending an HTTP POST request to the callback URI included in the subscription, and the AF responds by sending a confirmation, as described in clause 4.4.26.7 of 3GPP TS 29.522 [24].
NOTE:	The subscriptions required for steps 12-15 can have happened either in the Create/Update steps or with a separate Subscribe message which is not shown in the call flow.
Figure 5.5.10.2-2: Processing direct AF requests for Access and Mobility related policy authorization for a UE
1.	An AM Policy Association is established as described in clause 5.1.1. This step can occur at any time before step 4.
2.	The AF may subscribe to (or unsubscribe from) the BSF using Nbsf_Management_Subscribe (or Nbsf_Management_Unsubscribe) to be informed about PCF for a UE registrations for the target UE, as described in clause 4.2.6 (for subscribing) or clause 4.2.7 (for unsubscribing) of 3GPP TS 29.521 [22].
3.	The BSF responds by confirming the received request and, in the case of subscription, including the existing PCF for a UE registration in the response, if found, as described in clause 4.2.6.2 of 3GPP TS 29.521 [22].
4.	The BSF notifies the AF once there is a PCF for a UE registration for the UE indicated in the subscription as described in clause 4.2.8 of 3GPP TS 29.521 [22].
5.	The AF confirms the received notification by sending a ""204 No Content"" response as described in clause 4.2.8 of 3GPP TS 29.521 [22].
6.	To create a new AF request, the AF invokes the Npcf_AMPolicyAuthorization_Create service operation by sending an HTTP POST request to the ""Application AM Contexts"" resource as described in clause 4.2.2 of 3GPP TS 29.534 [50].
To update an existing AF request, the AF invokes the Npcf_AMPolicyAuthorization_Update service operation by sending an HTTP PATCH request to the ""Individual Application AM Context"" resource as described in clause 4.2.3 of 3GPP TS 29.534 [50].
To remove an existing AF request, the AF invokes the Npcf_AMPolicyAuthorization_Delete service operation by sending an HTTP DELETE request to the ""Individual Application AM Context"" resource as described in clause 4.2.4 of 3GPP TS 29.534 [50].
7.	The PCF responds to the creation, update, or deletion request as described respectively in clauses 4.2.2, 4.2.3, or 4.2.4 of 3GPP TS 29.534 [50].
If the creation or update request included the subscription to event(s) together with the indication of immediate reporting of the currently available values of the subscribed events, the PCF includes in the response the applicable event(s) information, if available, as specified respectively in clauses 4.2.2 or 4.2.3 of 3GPP TS 29.534 [50].
8.	AM Policy Association modification initiated by the PCF may be performed as described in clause 5.1.2.2.
9-10.	When an event (e.g. service coverage area change) occurs to which the AF has previously subscribed, the PCF notifies the AF using the Npcf_AMPolicyAuthorization_Notify service operation by sending an HTTP POST request to the callback URI included in the subscription, and the AF responds by sending a confirmation, as described in clause 4.2.7 of 3GPP TS 29.534 [50].
NOTE:	The subscriptions required for steps 9-10 can have happened either in the Create/Update steps or with a separate Subscribe message which is not shown in the call flow.",TS 29.513,5.5.10.2,all_images/image_1051.jpeg,Processing NEF-mediated AF requests for Access and Mobility related policy
"This procedure concerns only non-roaming scenarios, i.e. to cases where the involved entities serving the UE (i.e. NEF, PCF, BSF, AMF) belong to the home PLMN. The AF may belong to the home PLMN (trusted AF) or to a third party (untrusted AF).
This procedure is used for individual UEs when the request shall be applied independently of conditions related to the application traffic. The AF may interact with NFs of the Core Network either directly or via the NEF. The procedure for the NEF-mediated case is described in Figure 5.5.10.2-1, while the procedure for the direct case is described in Figure 5.5.10.2-2.
Figure 5.5.10.2-1: Processing NEF-mediated AF requests for Access and Mobility related policy authorization for a UE
1.	An AM Policy Association is established as described in clause 5.1.1. This step can occur at any time before step 7.
2.	To create a new AF request, the AF invokes the Nnef_AMPolicyAuthorization_Create service operation to the NEF by sending an HTTP POST request to the ""Application AM Contexts"" resource as described in clause 4.4.26.2 of 3GPP TS 29.522 [24].
To update an existing AF request, the AF invokes the Nnef_AMPolicyAuthorization_Update service operation by sending an HTTP PATCH request to the ""Individual Application AM Context"" resource as described in clause 4.4.26.3 of 3GPP TS 29.522 [24].
To remove an existing AF request, the AF invokes the Nnef_AMPolicyAuthorization_Delete service operation by sending an HTTP DELETE request to the ""Individual Application AM Context"" resource as described in clause 4.4.26.4 of 3GPP TS 29.522 [24].
3.	Upon receipt of the AF request, the NEF authorizes it, stores it, and performs the mapping from the information provided by the AF into information needed by the 5GC (e.g. translate a GPSI into a SUPI) as described in 3GPP TS 23.501 [2] and 3GPP TS 23.502 [3].
4.	The NEF responds to the AF request creation, update, or deletion as described respectively in clauses 4.4.26.2, 4.4.26.3, or 4.4.26.4 of 3GPP TS 29.522 [24].
If the creation or update request included the subscription to event(s) together with the indication of immediate reporting of the currently available values of the subscribed events, the NEF includes in the response the applicable event(s) information, if available, as specified in clauses 4.4.26.2, or 4.4.26.4 of 3GPP TS 29.522 [24]. In this case, the response is deferred after step 10.
5.	The NEF may subscribe to (or unsubscribe from) the BSF using Nbsf_Management_Subscribe (or Nbsf_Management_Unsubscribe) to be informed about the PCF for a UE of the UE targeted in the AF request received in step 2, as described in clause 4.2.6 (for subscribing) or clause 4.2.7 (for unsubscribing) of 3GPP TS 29.521 [22].
6.	The BSF responds by confirming the received request and, in the case of subscription, including the existing PCF for a UE registration in the response, if found, as described in clause 4.2.6.2 of 3GPP TS 29.521 [22].
7.	The BSF notifies the NEF once there is a PCF for a UE registration for the UE indicated in the subscription as described in clause 4.2.8 of 3GPP TS 29.521 [22].
8.	The NEF confirms the received notification by sending a ""204 No Content"" response as described in clause 4.2.8 of 3GPP TS 29.521 [22].
9.	The NEF forwards the AF request to the PCF.
If the NEF received the Nnef_AMPolicyAuthorization_Create request in step 2, the NEF invokes the Npcf_AMPolicyAuthorization_Create service operation by sending an HTTP POST request to the ""Application AM Contexts"" resource as described in clause 4.2.2 of 3GPP TS 29.534 [50].
If the NEF received the Nnef_AMPolicyAuthorization_Update request in step 2, the NEF invokes the Npcf_AMPolicyAuthorization_Update service operation by sending an HTTP PATCH request to the ""Individual Application AM Context"" resource as described in clause 4.2.3 of 3GPP TS 29.534 [50].
If the NEF received the Nnef_AMPolicyAuthorization_Delete request in step 2, the NEF invokes the Npcf_AMPolicyAuthorization_Delete service operation by sending an HTTP DELETE request to the ""Individual Application AM Context"" resource as described in clause 4.2.4 of 3GPP TS 29.534 [50].
10.	The PCF responds to the creation, update, or deletion request as described respectively in clauses 4.2.2, 4.2.3, or 4.2.4 of 3GPP TS 29.534 [50].
If the creation or update request included the subscription to event(s) together with the indication of immediate reporting of the currently available values of the subscribed events, the PCF includes in the response the applicable event(s) information, if available, as specified respectively in clauses 4.2.2 or 4.2.3 of 3GPP TS 29.534 [50].
11.	AM Policy Association modification initiated by the PCF may be performed as described in clause 5.1.2.2.
12-13.	If an event (e.g. service coverage area change) occurs to which the NEF has previously subscribed, the PCF notifies the NEF using the Npcf_AMPolicyAuthorization_Notify service operation by sending an HTTP POST request to the callback URI included in the subscription, and the NEF responds by sending a confirmation, as described in clause 4.2.7 of 3GPP TS 29.534 [50].
14-15.	When the NEF receives from the PCF an event (e.g. service coverage area change) to which the AF has previously subscribed, the NEF notifies the AF using the Nnef_AMPolicyAuthorization_Notify service operation by sending an HTTP POST request to the callback URI included in the subscription, and the AF responds by sending a confirmation, as described in clause 4.4.26.7 of 3GPP TS 29.522 [24].
NOTE:	The subscriptions required for steps 12-15 can have happened either in the Create/Update steps or with a separate Subscribe message which is not shown in the call flow.
Figure 5.5.10.2-2: Processing direct AF requests for Access and Mobility related policy authorization for a UE
1.	An AM Policy Association is established as described in clause 5.1.1. This step can occur at any time before step 4.
2.	The AF may subscribe to (or unsubscribe from) the BSF using Nbsf_Management_Subscribe (or Nbsf_Management_Unsubscribe) to be informed about PCF for a UE registrations for the target UE, as described in clause 4.2.6 (for subscribing) or clause 4.2.7 (for unsubscribing) of 3GPP TS 29.521 [22].
3.	The BSF responds by confirming the received request and, in the case of subscription, including the existing PCF for a UE registration in the response, if found, as described in clause 4.2.6.2 of 3GPP TS 29.521 [22].
4.	The BSF notifies the AF once there is a PCF for a UE registration for the UE indicated in the subscription as described in clause 4.2.8 of 3GPP TS 29.521 [22].
5.	The AF confirms the received notification by sending a ""204 No Content"" response as described in clause 4.2.8 of 3GPP TS 29.521 [22].
6.	To create a new AF request, the AF invokes the Npcf_AMPolicyAuthorization_Create service operation by sending an HTTP POST request to the ""Application AM Contexts"" resource as described in clause 4.2.2 of 3GPP TS 29.534 [50].
To update an existing AF request, the AF invokes the Npcf_AMPolicyAuthorization_Update service operation by sending an HTTP PATCH request to the ""Individual Application AM Context"" resource as described in clause 4.2.3 of 3GPP TS 29.534 [50].
To remove an existing AF request, the AF invokes the Npcf_AMPolicyAuthorization_Delete service operation by sending an HTTP DELETE request to the ""Individual Application AM Context"" resource as described in clause 4.2.4 of 3GPP TS 29.534 [50].
7.	The PCF responds to the creation, update, or deletion request as described respectively in clauses 4.2.2, 4.2.3, or 4.2.4 of 3GPP TS 29.534 [50].
If the creation or update request included the subscription to event(s) together with the indication of immediate reporting of the currently available values of the subscribed events, the PCF includes in the response the applicable event(s) information, if available, as specified respectively in clauses 4.2.2 or 4.2.3 of 3GPP TS 29.534 [50].
8.	AM Policy Association modification initiated by the PCF may be performed as described in clause 5.1.2.2.
9-10.	When an event (e.g. service coverage area change) occurs to which the AF has previously subscribed, the PCF notifies the AF using the Npcf_AMPolicyAuthorization_Notify service operation by sending an HTTP POST request to the callback URI included in the subscription, and the AF responds by sending a confirmation, as described in clause 4.2.7 of 3GPP TS 29.534 [50].
NOTE:	The subscriptions required for steps 9-10 can have happened either in the Create/Update steps or with a separate Subscribe message which is not shown in the call flow.",TS 29.513,5.5.10.2,all_images/image_1052.png,Processing direct AF requests for Access and Mobility related policy authorization
"This procedure concerns only non-roaming scenarios, i.e. to cases where the involved entities serving the UE (i.e. NEF, UDR, PCF, BSF, AMF) belong to the home PLMN. The AF may belong to the home PLMN (trusted AF) or to a third party (untrusted AF).
This procedure is used by the AF to provide its AM policy related request for one or multiple UEs at any time.
Figure 5.5.10.3-1: Processing AF requests to influence Access and Mobility related policy
1.	An AM Policy Association is established as described in clause 5.1.1 (including the retrieval of and subscription to AM Influence data in steps 2 and 4). This step may occur at any time before step 7.
2.	To create a new AF request, the AF invokes the Nnef_AMInfluence_Create service operation to the NEF by sending an HTTP POST request to the ""AM Influence Subscription"" resource. The AF may subscribe to Access and Mobility management related events (e.g. about service area coverage change outcome) as part of this operation.
To update an existing AF request, the AF invokes the Nnef_AMInfluence_Update service operation by sending an HTTP PUT or PATCH request to the ""Individual AM Influence Subscription"" resource. The AF may subscribe to or unsubscribe from Access and Mobility management related events (e.g. about service area coverage change outcome) as part of this operation.
To remove an existing AF request, the AF invokes the Nnef_AMInfluence_Delete service operation by sending an HTTP DELETE request to the ""Individual AM Influence Subscription"" resource. The AF may unsubscribe from Access and Mobility management related events (e.g. about service area coverage change outcome) as part of this operation.
3.	Upon receipt of the AF request, the NEF authorizes it and then performs the mapping from the information provided by the AF into information needed by the 5GC (e.g. translate a GPSI into a SUPI) as described in clause 4.4.27 of 3GPP TS 29.522 [24].
4-5.	When receiving the Nnef_AMInfluence_Create request, the NEF invokes the Nudr_DataRepository_Create service operation to store the AF request information in the UDR by sending an HTTP PUT request to the ""Individual AM Influence Data"" resource, and the UDR sends a ""201 Created"" response.
When receiving the Nnef_AMInfluence_Update request, the NEF invokes the Nudr_DataRepository_Update service operation to modify the AF request information in the UDR by sending an HTTP PATCH or PUT request to the resource ""Individual AM Influence Data"", and the UDR sends a ""200 OK"" or ""204 No Content"" response accordingly.
When receiving the Nnef_AMInfluence_Delete request, the NEF invokes the Nudr_DataRepository_Delete service operation to delete the AF request information from the UDR by sending an HTTP DELETE request to the ""Individual AM Influence Data"" resource, and the UDR sends a ""204 No Content"" response.
6.	The NEF sends an HTTP response message to the AF correspondingly.
7-8.	The UDR notifies the PCF(s) that have subscriptions (from step 1) which match the received AF request using the Nudr_DataRepository_Notify service operation by sending an HTTP POST request to the callback URI of the PCF that was included in the subscription, and the PCF(s) send a ""204 No Content"" response.
9.	If the received AM Influence data indicated that the AM policy depends on PDU session traffic events (e.g. the application start and application stop for an application Id or PDU session establishment and termination for a DNN and S-NSSAI combination), the PCF for the UE may discover the PCF(s) for a PDU Session that handle(s) the respective UE traffic as described in clause 8.4a.
10-11.	If the received AM Influence data indicated that the request is dependent (or does not depend anymore) on the existence of UE traffic that matches one or more application identifiers and the feature ""ApplicationDetectionEvents"" defined in 3GPP TS 29.514 [10] is supported, the PCF for the UE may subscribe (or unsubscribe) to the PCF(s) for the PDU Session for notifications about application traffic detection (e.g. start, stop) of the application(s) indicated in the AM Influence data using the Npcf_PolicyAuthorization_Subscribe service operation as described in 3GPP TS 29.514 [10] clause 4.2.6.9.
12.	The PCF for the PDU Session creates PCC rule(s) including the application ID(s) in the service data flow description, if they do not already exist, and installs the PCC rule(s) and the Policy Control request trigger(s), also if they do not already exist, to detect the start/stop of application traffic in the SMF as described in 3GPP TS 29.512 [9]. When the SMF detects that the Policy Control Request Trigger is met, the SMF reports to the PCF for the PDU session the start or stop of concerned the application traffic.
13-14.	The PCF for the PDU Session may notify the PCF for the UE about the detected event using the Npcf_PolicyAuthorization_Notify service operation by sending an HTTP POST request to the notification URI received in the subscription, and the PCF for the UE responds with ""204 No Content"", as described in 3GPP TS 29.514 [10] clause 4.2.5.19.
15.	AM Policy Association modification initiated by the PCF may be performed as described in clause 5.1.2.2.
16-19.	If the AF had subscribed to an Access and Mobility management related event (e.g. about service area coverage change outcome), the PCF may send respective notification(s) to the NEF using the Npcf_EventExposure_Notify service operation by sending an HTTP POST message as described in clause 4.2.4.2 of 3GPP TS 29.523 [49] to the notification URI that was included in the AM Influence data retrieved from the UDR. The NEF forwards such received notifications to the AF using the Nnef_AMInfluence_Notify service operation by sending an HTTP POST message to the notification URI previously received from the AF. The AF sends a ""204 No Content"" response to the NEF and the NEF sends a ""204 No Content"" response to the PCF.",TS 29.513,5.5.10.3,all_images/image_1053.png,Processing AF requests to influence Access and Mobility related policy
"Figure 5.6.1.2-1: UE Policy Association Establishment procedure - Non-roaming
1.	The AMF receives the registration request from the AN.
Based on local policy, and the authorized capabilities received from the UE (e.g. V2X capabilities and/or 5G ProSe capabilities), as defined in clause 4.2.2.1 of 3GPP TS 29.525 [31], the AMF decides to select and contact the PCF to create the UE policy association . The AMF invokes the Npcf_UEPolicyControl_Create service operation by sending an HTTP POST request to the ""UE Policy Associations"" resource as defined in clause 4.2.2.1 of 3GPP TS 29.525 [31].
2-3.	If the PCF does not have the subscription data or the latest list of UPSIs for the UE, it invokes the Nudr_DataRepository_Query service operation to the UDR by sending an HTTP GET request to the ""UEPolicySet"" resource. The UDR sends an HTTP ""200 OK"" response to the PCF with the latest UPSIs and its content, and/or the subscription data.
Additionally, if the ""EnhancedBackgroundDataTransfer"" feature defined in 3GPP TS 29.504 [27] is supported, the PCF invokes the Nudr_DataRepository_Query service operation to the UDR by sending the HTTP GET request to the ""Applied BDT Policy Data"" resource to retrieve the applied BDT Policy Data. The UDR sends an HTTP ""200 OK"" response with the stored applied BDT Policy Data. And then, if the corresponding transfer policy is not locally stored in the PCF, the PCF invokes the Nudr_DataRepository_Query service operation by sending the HTTP GET request to the ""IndividualBdtData"" resource or the ""BdtData"" collection resource with the URI query parameter ""bdt-ref-ids"" as specified in 3GPP TS 29.519 [12], to retrieve the related Background Data Transfer policy information (i.e. Time window and Location criteria) stored in the UDR. The UDR sends an HTTP ""200 OK"" response to the PCF.
Additionally, if the ""AfGuideURSP"" feature is supported and URSPs are influenced by the AF, and/or V2XP and/or the ""ProSe"" feature is supported and ProSeP policies may be delivered to the UE, the PCF invokes the Nudr_DataRepository_Query service operation to the UDR by sending the HTTP GET request to the ""Service Parameter Data"" resource to retrieve the service parameter data. The UDR sends an HTTP ""200 OK"" response with the stored service parameter data.
Additionally, the PCF invokes the Nudr_DataRepository_Query service operation to the UDR by sending the HTTP GET request to the ""5GVnGroupsInternal"" resource to retrieve the group configuration of the received 5G VN Group Id as specified in 3GPP TS 29.505 [47], if not internally available.
NOTE 1:	The PCF can internally store the retrieved 5G VN group configuration data for later use for other SUPIs that belong to the same Internal-Group-Id.
4-5.	The PCF may request notifications from the UDR on changes in the policy data subscription information (e.g, UE Policy Set resource), and in this case, the PCF shall invoke the Nudr_DataRepository_Subscribe service operation by sending an HTTP POST request to the ""PolicyDataSubscriptions"" resource. The UDR sends an HTTP ""201 Created"" response to acknowledge the subscription.
Additionally, if the ""EnhancedBackgroundDataTransfer"" feature defined in 3GPP TS 29.504 [27] is supported, to request notifications from the UDR on changes in the applied BDT Policy Data, the PCF invokes the Nudr_DataRepository_Subscribe service operation by sending an HTTP POST request to the ""ApplicationDataSubscriptions"" resource. The UDR sends an HTTP ""201 Created"" response to acknowledge the subscription.
Additionally, if the PCF requests notifications from the UDR on changes in the service parameter data, the PCF invokes the Nudr_DataRepository_Subscribe service operation by sending an HTTP POST request to the ""ApplicationDataSubscriptions"" resource. The UDR sends an HTTP ""201 Created"" response to acknowledge the subscription.
Additionally, to request notifications from the UDR on changes in the 5G VN group configuration data associated to each of the Internal-Group-Id provided to the PCF, the PCF invokes the Nudr_DataRepository_Subscribe service operation by sending an HTTP POST request to the ""SubscriptionDataSubscriptions"" resource as specified in 3GPP TS 29.505 [47], if not internally available. The UDR sends an HTTP ""201 Created"" response to acknowledge the subscription.
6.	The PCF determines whether and which UE policy has to be provisioned or updated as defined in clause 4.2.2.2.1 of 3GPP TS 29.525 [31], and may determine applicable Policy Control Request Trigger(s).
The PCF determines whether and which ANDSP and/or URSP has to be provisioned or updated based on the received list of UPSIs from the UE, if available, the UE Policy Sections stored in the UDR, if available, other received UE parameters, if available, the policy subscription and application data retrieved from UDR, if available, and local policies as defined in clauses 4.2.2.2.1.1, 4.2.2.2.2 (for ANDSP) and/or 4.2.2.2.3 (for URSP) of 3GPP TS 29.525 [31].
If the ""V2X"" feature is supported, the PCF determines whether the V2XP and the V2X N2 PC5 policy have to be provisioned as defined in clauses 4.2.2.2.1.2 and 4.2.2.3 of 3GPP TS 29.525 [31].
If the ""ProSe"" feature is supported, the PCF determines whether the ProSeP and the 5G ProSe N2 PC5 policy have to be provisioned as defined in clauses 4.2.2.2.1.3 and 4.2.2.4 of 3GPP TS 29.525 [31].
In addition, the PCF checks if the size of determined UE policy exceeds a predefined limit.
NOTE 2:	NAS messages from AMF to UE do not exceed the maximum size limit allowed in NG-RAN (PDCP layer), so the predefined size limit in PCF is related to that limitation.
-	If the size is under the limit then the UE policy information is included in a single Namf_Communication_N1N2MessageTransfer service operation and messages 10 to 13 are thus executed one time.
-	If the size exceeds the predefined limit, the PCF splits the UE policy information in smaller logical independent UE policy information fragments and ensures the size of each is under the predefined limit. Each UE policy information fragment will be then sent in separated Namf_Communication_N1N2MessageTransfer service operations and messages 10 to 13 are thus executed several times, one time for each UE policy information fragment.
7.	The PCF sends an HTTP ""201 Created"" response to the AMF with the Policy Control Request Trigger(s) if applicable.
8-9.	If the ""ProSe"" feature is supported for the Npcf_UEPolicyControl service, the PCF may register with the BSF as the PCF serving this UE, if not already registered at the AM Policy Association establishment. This is performed by using the Nbsf_Management_Register operation, providing as inputs the SUPI, the GPSI, if available, and the PCF end points related to the Npcf_AMPolicyAuthorization service.
10.	To subscribe to notifications of N1 message for UE Policy Delivery Result, or subsequent UE policy requests (e.g. for V2XP and/or ProSeP), the PCF invokes Namf_Communication_N1N2MessageSubscribe service operation to the AMF by sending the HTTP POST method with the URI of the ""N1N2 Subscriptions Collection for Individual UE Contexts"" resource.
11.	The AMF sends an HTTP ""201 Created"" response to the PCF.
12.	If the PCF determines to provision or update the UE policy in step 6, the PCF sends the UE policy to the UE via the AMF by invoking the Namf_Communication_N1N2MessageTransfer service operation.
If the ""V2X"" feature is supported and the PCF determines to provision V2XP and V2X N2 PC5 policy in step 6, the PCF sends the V2XP to the UE and the V2X N2 PC5 policy to the NG-RAN via the AMF by invoking the Namf_Communication_N1N2MessageTransfer service operation.
If the ""ProSe"" feature is supported and the PCF determines to provision ProSeP and 5G ProSe N2 PC5 policy in step 6, the PCF sends the ProSeP to the UE and the5G ProSe N2 PC5 policy to the NG-RAN via the AMF by invoking the Namf_Communication_N1N2MessageTransfer service operation.
The PCF can provision the UE policy (including V2XP and/or ProSeP) and V2X N2 PC5 policy and/or 5G ProSe N2 PC5 Policy in the same message.
13.	The AMF sends a response to the Namf_Communication_N1N2MessageTransfer service operation.
14.	When receiving the UE Policy container, the AMF forwards the response of the UE to the PCF using Namf_Communication_N1MessageNotify service operation.
15.	The PCF sends a response to the Namf_Communication_N1MessageNotify service operation.
16-17.	The PCF maintains the latest list of UE policy sections delivered to the UE (in step 8) and updates the UE policy information for the subscriber including the latest list of UPSIs and its content in the UDR by invoking the Nudr_DataRepository_Update service operation.
-	If there is no UE policy information retrieved in step 3, the PCF sends an HTTP PUT request to the ""UEPolicySet"" resource, and the UDR sends an HTTP ""201 Created"" response.
-	Otherwise, the PCF sends an HTTP PUT/PATCH request to the ""UEPolicySet"" resource, and the UDR sends an HTTP ""200 OK"" or ""204 No Content"" response accordingly.",TS 29.513,5.6.1.2,all_images/image_1054.jpeg,UE Policy Association Establishment procedure - Non-roaming
"Figure 5.6.1.3-1: UE Policy Association Establishment procedure - Roaming
1.	The AMF receives the registration request from the AN.
Based on local policy, and the capabilities received from the UE  (e.g. V2X capabilities) , as defined in clause 4.2.2.1 of 3GPP TS 29.525 [31], the AMF decides to establish UE Policy Association with the V-PCF. The AMF invokes the Npcf_UEPolicyControl_Create service operation by sending an HTTP POST request to the ""UE Policy Associations"" resource as defined in clause 4.2.2.1 of 3GPP TS 29.525 [31].
2.	The V-PCF invokes the Npcf_UEPolicyControl_Create service operation by sending an HTTP POST request to the ""UE Policy Associations"" resource to forward the information received from AMF to the H-PCF. The request includes the parameters received in step 1. The V-PCF also provides the H-PCF the Notification URI where to send a notification when the policy is updated.
3-6.	These steps are the same as steps 2-5 in clause 5.6.1.2, except the description of ""EnhancedBackgroundDataTransfer"" feature is not applicable.
7. The H-PCF determines whether and which ANDSP and/or URSP has to be provisioned or updated based on the received list of UPSIs from the UE, if available, the UE Policy Sections stored in the UDR, if available, other received UE parameters, if available, the policy subscription and application data retrieved from UDR, if available, and local policies as defined in clauses 4.2.2.2.1.1, 4.2.2.2.2 (for ANDSP) and/or 4.2.2.2.3 (for URSP) of 3GPP TS 29.525 [31].
If the ""V2X"" feature is supported, the H-PCF determines whether the V2XP and the V2X N2 PC5 policy have to be provisioned as defined in clause s 4.2.2.2.1.2 and 4.2.2.3 of 3GPP TS 29.525 [31].
If the ""ProSe"" feature is supported, the H-PCF determines whether the ProSeP and the 5G ProSe N2 PC5 policy have to be provisioned as defined in clauses 4.2.2.2.1.3 and 4.2.2.4 of 3GPP TS 29.525 [31].
In addition, the H-PCF checks if the size of determined UE policy exceeds a predefined limit.
NOTE 1:	NAS messages from AMF to UE do not exceed the maximum size limit allowed in NG-RAN (PDCP layer), so the predefined size limit in H-PCF is related to that limitation.
If the size is under the limit then the UE policy information is included in Npcf_UEPolicyControl_Create response service operation.
-	If the size exceeds the predefined limit, the H-PCF splits the UE policy information in smaller logical independent UE policy information fragments and ensures the size of each is under the predefined limit. One fragment will be sent in Npcf_UEPolicyControl_Create response service operation, and others will be sent by initiating the PCF-initiated UE Policy Association Modification procedure specified in clause 5.6.2.2.3.
8.	The H-PCF sends an HTTP ""201 Created"" response to the V-PCF with the decided UE policy, Policy Control Request Trigger(s) and N2 PC5 policy if available.
9-10.	If the ""ProSe"" feature is supported for the Npcf_UEPolicyControl service, the H-PCF may register with the BSF as the PCF serving this UE. This is performed by using the Nbsf_Management_Register operation, providing as inputs the SUPI, the GPSI, if available, and the PCF end points related to the Npcf_AMPolicyAuthorization service.
11.	The V-PCF invokes Nudr_DataRepository_Query service operation to the UDR by sending an HTTP GET request to the ""PlmnUePolicySet"" resource to retrieve the list of UPSIs and its content stored in the V-UDR for the PLMN ID of this UE. Alternatively, the V-PCF can have this information configured locally.
12.	The V-UDR sends an HTTP ""200 OK"" response to the V-PCF with the UE policy information.
13.	The V-PCF may request notifications from the V-UDR on changes in UE policy information, and in this case, the PCF shall invoke the Nudr_DataRepository_Subscribe service operation by sending an HTTP POST request to the ""PolicyDataSubscriptions"" resource.
14.	The V-UDR sends an HTTP ""201 Created"" response to acknowledge the subscription from the V-PCF.
15.	The V-PCF determines whether and which UE policy has to be provisioned or updated as defined in clause 4.2.2.2.1 of 3GPP TS 29.525 [31], and may determine applicable Policy Control Request Trigger(s).
The V-PCF determines whether and which visited ANDSP has to be provisioned based on the received list of UPSIs from the UE, if available, the UE Policy Sections locally configured or stored in the UDR for the UE PLMN, other received UE parameters, if available, and local polices as defined in clauses 4.2.2.2.1.1, and 4.2.2.2.2 of 3GPP TS 29.525 [31].
If the ""V2X"" feature is supported and the V-PCF received the V2XP and the V2X N2 PC5 policy, the V-PCF sends the V2XP to the UE and the V2X N2 PC5 policy to the NG-RAN via the AMF by invoking the Namf_Communication_N1N2MessageTransfer service operation.
If the ""ProSe"" feature is supported and the V-PCF received the ProSeP and the 5G ProSe N2 PC5 policy, the V-PCF sends the ProSeP to the UE and the 5G ProSe N2 PC5 policy to the NG-RAN via the AMF by invoking the Namf_Communication_N1N2MessageTransfer service operation.
The PCF can provision the UE policy (including V2XP and/or ProSeP) and V2X N2 PC5 policy and/or 5G ProSe N2 PC5 Policy in the same message.
In addition, the V-PCF checks if the size of determined UE policy exceeds a predefined limit.
NOTE 2:	NAS messages from AMF to UE do not exceed the maximum size limit allowed in NG-RAN (PDCP layer), so the predefined size limit in V-PCF is related to that limitation.
-	If the size is under the limit then the UE policy information is included in a single Namf_Communication_N1N2MessageTransfer service operation and messages 19 to 24 are thus executed one time.
-	If the size exceeds the predefined limit, the V-PCF splits the UE policy information in smaller logical independent UE policy information fragments and ensures the size of each is under the predefined limit. Each UE policy information fragment will be then sent in separated Namf_Communication_N1N2MessageTransfer service operations and messages 19 to 24 are thus executed several times, one time for each UE policy information fragment.
16.	The V-PCF sends an HTTP ""201 Created"" response to the AMF with the Policy Control Request Trigger(s) if available.
17.	To subscribe to notifications of N1 message for UE Policy Delivery Result, or subsequent UE policy requests (e.g. for V2XP and/or ProSeP), the V-PCF invokes Namf_Communication_N1N2MessageSubscribe service operation to the AMF by sending the HTTP POST method with the URI of the ""N1N2 Subscriptions Collection for Individual UE Contexts"" resource.
18.	The AMF sends an HTTP ""201 Created"" response to the V-PCF.
19. The V-PCF invokes the Namf_Communication_N1N2MessageTransfer service operation to send the policy decided locally in step 13 and to forward the policy received from the H-PCF in step 8.
20.	The AMF sends a response to the Namf_Communication_N1N2MessageTransfer service operation.
21.	When receiving the UE Policy container for the result of the UE policy, the AMF forwards the response of the UE to the V-PCF using Namf_Communication_N1MessageNotify service operation.
22. The V-PCF sends a response to the Namf_Communication_N1MessageNotify service operation.
23.	Upon receipt of the UE Policy container belonging to the H-PLMN in step 19, the V-PCF invokes the Npcf_UEPolicyControl_Update service operation by sending an HTTP POST request to the ""Individual UE Policy Association"" resource to forward the response of the UE to the H-PCF.
24.	The H-PCF sends an HTTP ""200 OK"" response to the V-PCF.
25-26.	The H-PCF maintains the latest list of UE policy information delivered to the UE and updates UE policy including the latest list of UPSIs and its content in the H-UDR by invoking the Nudr_DataRepository_Update service operation.
-	If there is no UE policy information retrieved in step 4, the H-PCF sends an HTTP PUT request to the ""UEPolicySet"" resource, and the UDR sends an HTTP ""201 Created"" response.
-	Otherwise, the H-PCF sends an HTTP PUT/PATCH request to the ""UEPolicySet"" resource, and the H-UDR sends an HTTP ""200 OK"" or ""204 No Content"" response accordingly.",TS 29.513,5.6.1.3,all_images/image_1055.jpeg,UE Policy Association Establishment procedure - Roaming
"Figure 5.6.2.1.2-1: AMF-initiated UE Policy Association Modification procedure – Non-roaming
1.	When the AMF detects a Policy Control Request Trigger condition is met or, when during AMF relocation, the new AMF decides to reuse the UE Policy Association established by the old AMF with thePCF, it invokes the Npcf_UEPolicyControl_Update service operation to the PCF by sending an HTTP POST request to the ""Individual UE Policy Association"" resource with information on the conditions that have changed.
2.	The PCF makes the policy decision including the applicable updated Policy Control Request Trigger(s) and/or updated UE Policy and/or updated V2X N2 PC5 policy, if the ""V2X"" feature is supported, and/or, if the ""ProSe"" feature is supported, updated ProSeP within the updated UE Policy and/or 5G ProSe N2 PC5 policy. The PCF checks if the size of determined UE policy exceeds a predefined limit the same as step 6 in clause 5.6.1.2.
The PCF determines whether and which ANDSP and/or URSP has to be provisioned or updated based on policy subscription and application data, if available, the UE Policy Sections previously delivered to the UE, if available, other UE parameters previously received from the UE, if available, the reported information by the AMF and local policies, as defined in clauses 4.2.2.2.1.1, 4.2.2.2.2 (for ANDSP) and/or 4.2.2.2.3 (for URSP) of 3GPP TS 29.525 [31].
3.	The PCF sends an HTTP ""200 OK"" response to the AMF with the applicable updated Policy Control Request Trigger(s).
4.	If the PCF decided to update the UE policy, and/or N2 PC5 policy and/or 5G ProSe N2 PC5 policy in step 2, steps 12-15 as specified in Figure 5.6.1.2-1 are executed.
5-6.	If the PCF decided to update the UE policy in step 2, the PCF maintains the latest list of UE policy information delivered to the UE and updates UE policy including the latest list of UPSIs and its content in the UDR by invoking the Nudr_DataRepository_Update service operation. The PCF sends an HTTP PUT/PATCH request to the ""UEPolicySet"" resource, and the UDR sends an HTTP ""204 No Content"" response.",TS 29.513,5.6.2.1.2,all_images/image_1056.jpeg,AMF-initiated UE Policy Association Modification procedure – Non-roaming
"Figure 5.6.2.1.3-1: AMF-initiated UE Policy Association Modification procedure - Roaming
1.	When the AMF detects a Policy Control Request Trigger condition is met or, when during AMF relocation, the new AMF decides to reuse the UE Policy Association established by the old AMF with the PCF, it invokes the Npcf_UEPolicyControl_Update service operation to the V-PCF by sending an HTTP POST request to the ""Individual UE Policy Association"" resource with information on the conditions that have changed.
2.	The V-PCF forwards the information received from AMF in step 1 to the H-PCF by sending an HTTP POST request to the ""Individual UE Policy Association"" resource if the H-PCF has subscribed the notification.
If the V-PCF received a Namf_Communication_N1MessageNotify service request with a UE Policy container, the V-PCF forwards the received container to the H-PCF by sending an HTTP POST request to the ""Individual UE Policy Association"" resource.
3.	The H-PCF makes the policy decision including the applicable updated Policy Control Request Trigger(s) and/or updated UE Policy and/or, if the ""V2X"" feature is supported, updated V2XP within the updated UE Policy and/or V2X N2 PC5 policy, and/or, if the ""ProSe"" feature is supported, updated ProSeP within the updated UE Policy and/or 5G ProSe N2 PC5 policy.
The H-PCF determines whether and which ANDSP and/or URSP has to be provisioned or updated based on policy subscription and application data, if available, the UE Policy Sections previously delivered to the UE, if available, other UE parameters previously received from the UE, if available, the reported information by the V-PCF and local policies, as defined in clauses 4.2.2.2.1.1, 4.2.2.2.2 (for ANDSP) and/or 4.2.2.2.3 (for URSP) of 3GPP TS 29.525 [31].
In addition, the H-PCF checks if the size of determined UE policy exceeds a predefined limit.
NOTE:	NAS messages from AMF to UE do not exceed the maximum size limit allowed in NG-RAN (PDCP layer), so the predefined size limit in H-PCF is related to that limitation.
-	If the size is under the limit then the UE policy information is included in Npcf_UEPolicyControl_Update response service operation.
-	If the size exceeds the predefined limit, the H-PCF splits the UE policy information in smaller logical independent UE policy information fragments and ensures the size of each is under the predefined limit. One fragment will be sent in Npcf_UEPolicyControl_Update response service operation, and others will be then sent by initiating the PCF-initiated UE Policy Association Modification procedure specified in clause 5.6.2.2.3.
4.	The H-PCF sends an HTTP ""200 OK"" response to the V-PCF with the updated policy information decided in step 3.
5. 	The V-PCF makes the policy decision including the applicable updated Policy Control Request Trigger(s) and/or updated UE Policy, if applicable. The V-PCF checks if the size of determined UE policy exceeds a predefined limit the same as step 13 in clause 5.6.1.3.
The V-PCF determines whether VPLMN ANDSP has to be provisioned or updated based on policy subscription for the UE PLMN, other UE parameters previously received from the UE, if available, and local policies, as defined in clauses 4.2.2.2.1.1, 4.2.2.2.2 (for ANDSP) of 3GPP TS 29.525 [31].
6.	The V-PCF sends an HTTP ""200 OK"" response to the AMF with the applicable updated Policy Control Request Trigger(s).
7.	If the V-PCF decided to update the UE policy in step  5 or the V-PCF received the UE Policy, V2X N2 PC5 policy and/or 5G ProSe N2 PC5 policy in step  4, steps 19-24 as specified in Figure 5.6.1.3-1 are executed.
8-9.	If the H-PCF decided to update the UE policy in step 3, the H-PCF maintains the latest list of UE policy information delivered to the UE and updates UE policy including the latest list of UPSIs and its content in the H-UDR by invoking the Nudr_DataRepository_Update service operation. The PCF sends an HTTP PUT/PATCH request to the ""UEPolicySet"" resource, and the UDR sends an HTTP ""204 No Content"" response.",TS 29.513,5.6.2.1.3,all_images/image_1057.jpeg,AMF-initiated UE Policy Association Modification procedure - Roaming
"Figure 5.6.2.2.2-1: PCF-initiated UE Policy Association Modification procedure – Non-roaming
1.	The PCF receives an external trigger, e.g. the subscriber policy data of a UE is changed, the applied BDT Policy Data is changed, or subscription data for the 5G VN group data is changed, or application detection, or the PCF receives an internal trigger, e.g. operator policy is changed, to re-evaluate UE policy decision for a UE.
NOTE 1:	When the external trigger affects more than one UE (e.g. when Network Performance is degraded in a network area info) the PCF will apply the next steps to all the affected active UE Policy Associations.
2-3. If the applied BDT policy Data is changed in step1, and if the corresponding transfer policy is not locally stored in the PCF, the PCF sends the HTTP GET request to the ""IndividualBdtData"" resource to retrieve the related Background Data Transfer policy information (i.e. Time window and Location criteria) stored in the UDR. The UDR sends an HTTP ""200 OK"" response to the PCF.
4.	The PCF makes the policy decision including the applicable updated Policy Control Request Trigger(s) and/or updated UE Policy and/or updated V2X N2 PC5 policy, if the ""V2X"" feature is supported, and/or updated 5G ProSe N2 PC5 policy, if the ""ProSe"" feature is supported. The PCF checks if the size of determined UE policy exceeds a predefined limit the same as step 6 in clause 5.6.1.2.
5.	If the PCF decided to update the Policy Control Request Trigger(s) in step4, the V-PCF shall invoke the Npcf_UEPolicyControl_UpdateNotify service operation by sending an HTTP POST request to the callback URI ""{notificationUri}/update"".
6.	The AMF sends an HTTP ""204 No Content"" response to the PCF.
7.	If the PCF decided to update the UE policy, V2X N2 PC5 policy and/or 5G ProSe N2 PC5 policy in step 4, steps 12-15 as specified in Figure 5.6.1.2-1 are executed.
8-9.	If the PCF decided to update the UE policy in step 4, steps 5-6 in clause 5.6.2.1.2 are executed.
NOTE 2:	When the trigger to update the UE policy is AF-based service parameter provisioning as described in clause 5.5.8, the AF requested to be notified of the outcome of the UE Policy delivery and the PCF initiated step 7 based on the AF request, then steps 7 - 10 specified in clause 5.5.8 are executed.",TS 29.513,5.6.2.2.2,all_images/image_1058.jpeg,PCF-initiated UE Policy Association Modification procedure – Non-roaming
"Figure 5.6.2.2.3-1: PCF-initiated UE Policy Association Modification procedure – Roaming
If the H-PCF receives a trigger, steps 1 to 4 and 10 to 11 are executed and steps 5 to 8 are omitted.
If the V-PCF receives a trigger, steps 1 to 4 and 10 to 11 are omitted and steps 5 to 8 are executed.
1.	The H-PCF receives an external trigger, e.g. the subscriber policy data of a UE is changed, or the PCF receives an internal trigger, e.g. operator policy is changed, to re-evaluate UE policy decision for a UE.
2.	The H-PCF makes the policy decision including the applicable updated Policy Control Request Trigger(s) and/or updated UE Policy and/or updated V2X N2 PC5 policy, if the ""V2X"" feature is supported, and/or updated 5G ProSe N2 PC5 policy, if the ""ProSe"" feature is supported.
The H-PCF determines whether and which ANDSP and/or URSP has to be provisioned or updated based on policy subscription and application data, if available, the UE Policy Sections previously delivered to the UE, if available, other UE parameters previously received from the UE, if available, and local policies, as defined in clauses 4.2.2.2.1.1, 4.2.2.2.2 (for ANDSP) and/or 4.2.2.2.3 (for URSP) of 3GPP TS 29.525 [31].
In addition, the H-PCF checks if the size of determined UE policy exceeds a predefined limit.
NOTE 1:	NAS messages from AMF to UE do not exceed the maximum size limit allowed in NG-RAN (PDCP layer), so the predefined size limit in H-PCF is related to that limitation.
-	If the size is under the limit then the UE policy information is included in a single Npcf_UEPolicyControl_UpdateNotify service operation and messages 3 to 4 are thus executed one time.
-	If the size exceeds the predefined limit, the PCF splits the UE policy information in smaller logical independent UE policy information fragments and ensures the size of each is under the predefined limit. Each UE policy information fragment will be then sent in separated Npcf_UEPolicyControl_UpdateNotify service operations and messages 3 to 4, and 9 are thus executed several times, one time for each UE policy information fragment.
3.	The H-PCF invokes the Npcf_UEPolicyControl_UpdateNotify service operation by sending an HTTP POST request to the callback URI ""{notificationUri}/update"" with the updated UE policy and/or the updated V2X N2 PC5 policy and/or the updated 5G ProSe N2 PC5 policy and/or Policy Control Request Trigger(s) if applicable.
4.	The V-PCF sends an HTTP ""204 No Content"" response to the H-PCF.
5.	The V-PCF receives an external trigger, e.g. operator policy in the V-UDR for the PLMN ID of this UE is changed, or the V-PCF receives an internal trigger, e.g. local policy is changed, to re-evaluate UE policy decision for a UE.
NOTE 2:	When the V-PCF receives an internal or external trigger to re-evaluate the UE policy decision for the roaming UEs of a PLMN ID, the PCF applies control mechanisms to avoid signalling storms and potential network overload, as e.g. limiting the number of simultaneous updates distributing the base of visiting UEs in a time dispersion interval.
6.	The V-PCF makes the policy decision including the applicable updated Policy Control Request Trigger(s) and/or updated UE Policy.
In addition, the V-PCF checks if the size of determined UE policy and received UE policy from H-PCF in step 3 exceeds a predefined limit.
NOTE 3:	NAS messages from AMF to UE do not exceed the maximum size limit allowed in NG-RAN (PDCP layer), so the predefined size limit in V-PCF is related to that limitation.
-	If the size is under the limit then the UE policy information is included in a single Namf_Communication_N1N2MessageTransfer service operation and message 9 is thus executed one time.
-	If the size exceeds the predefined limit, the V-PCF splits the UE policy information in smaller logical independent UE policy information fragments and ensures the size of each is under the predefined limit. Each UE policy information fragment will be then sent in separated Namf_Communication_N1N2MessageTransfer service operations and message 9 is thus executed several times, one time for each UE policy information fragment.
7.	If the V-PCF needs to update the Policy Control Request Trigger(s) or forward the Policy Control Request Trigger(s) received from the H-PCF in step 3, the V-PCF shall invoke the Npcf_UEPolicyControl_UpdateNotify service operation by sending an HTTP POST request to the callback URI ""{notificationUri}/update"".
8.	The AMF sends an HTTP ""204 No Content"" response to the PCF.
9.	If the V-PCF decided to update the UE policy in step 6 or the V-PCF received the UE Policy and/or V2X N2 PC5 policy, if the ""V2X"" feature is supported, and/or 5G ProSe N2 PC5 policy, if the ""ProSe"" feature is supported, in step 3, steps 19-24 as specified in Figure 5.6.1.3-1 are executed.
10-11.	If the H-PCF decided to update the UE policy in step 2, the steps 8-9 in clause 5.6.2.1.3 are executed.",TS 29.513,5.6.2.2.3,all_images/image_1059.png,PCF-initiated UE Policy Association Modification procedure – Roaming
"Figure 5.6.3.1.2-1: AMF-initiated UE Policy Association Termination procedure – Non-roaming
1.	The AMF invokes the Npcf_UEPolicyControl_Delete service operation by sending the HTTP DELETE request to the ""Individual UE Policy Association"" resource to delete the policy context in the PCF.
2.	The PCF removes the policy context for the UE and sends an HTTP ""204 No Content"" response to the AMF.
3-4.	If the PCF has previously registered to the BSF as the PCF that is serving this UE, the PCF deregisters from the BSF if no AM Policy Association nor UE Policy Association for this UE exists anymore. This is performed by using the Nbsf_Management_Deregister service operation.
5.	To unsubscribe to notifications of N1 message for UE Policy Delivery Result, the PCF invokes Namf_Communication_N1N2MessageUnsubscribe service operation to the AMF by sending the HTTP DELETE method with the URI of the ""N1N2 Individual Subscription"" resource.
6.	The AMF sends an HTTP ""204 No Content"" response to the PCF.
7.	The PCF unsubscribes the notification of subscriber policy data modification from the UDR by invoking Nudr_DataRepository_Unsubscribe service operation by sending the HTTP DELETE request to the ""IndividualPolicyDataSubscription"" resource if it has subscribed such notification.
-	The PCF invokes also the Nudr_DataRepository_Unsubscribe service operation to unsubscribe from notifications about applied BDT Policy Data changes and service parameter data changes at the UDR by sending an HTTP DELETE request to the ""IndividualApplicationDataSubscription"" resource if it has subscribed such notifications.
-	The PCF invokes also the Nudr_DataRepository_Unsubscribe service operation to unsubscribe from notifications about 5G VN group configuration data changes at the UDR by sending an HTTP DELETE request to the ""IndividualSubscriptionDataSubscription"" resource as specified in 3GPP TS 29.505 [47] if it has subscribed such notification.
NOTE:	The PCF will not invoke the Nudr_DataRepository_Unsubscribe service operation when the PCF has internally stored the retrieved 5G VN group configuration data for later use for other SUPIs that belong to the same Internal-Group-Id.
8.	The UDR sends an HTTP ""204 No Content"" response to the PCF.",TS 29.513,5.6.3.1.2,all_images/image_1060.jpeg,AMF-initiated UE Policy Association Termination procedure – Non-roaming
"Figure 5.6.3.1.3-1: AMF-initiated UE Policy Association Termination procedure – Roaming
1.	The AMF invokes the Npcf_UEPolicyControl_Delete service operation by sending the HTTP DELETE request to the ""Individual UE Policy Association"" resource to delete the policy context in the V-PCF. The V-PCF interacts with the H-PCF.
2.	The V-PCF removes the policy context for the UE and sends an HTTP ""204 No Content"" response to the AMF.
3.	The V-PCF invokes the Npcf_UEPolicyControl_Delete service operation by sending the HTTP DELETE request to the ""Individual UE Policy Association"" resource to delete the policy context in the H-PCF.
4.	The H-PCF removes the policy context for the UE and sends an HTTP ""204 No Content"" response to the V-PCF.
5-6.	If the H-PCF has previously registered to the BSF as the PCF that is serving this UE, the H-PCF shall deregister from the BSF if no AM Policy Association nor UE Policy Association for this UE exists anymore. This is performed by using the Nbsf_Management_Deregister service operation.
7.	To unsubscribe to notifications of N1 message for UE Policy Delivery Result, the V-PCF invokes Namf_Communication_N1N2MessageUnsubscribe service operation to the AMF by sending the HTTP DELETE method with the URI of the ""N1N2 Individual Subscription"" resource.
8.	The AMF sends an HTTP ""204 No Content"" response to the V-PCF.
9.	The V-PCF invokes the Nudr_DataRepository_Unsubscribe service operation by sending the HTTP DELETE request to the ""IndividualPolicyDataSubscription"" resource to unsubscribe the notification from the V-UDR on changes in UE policy information if it has subscribed such notification.
10.	The V-UDR sends an HTTP ""204 No Content"" response to the V-PCF.
11.	The H-PCF unsubscribes the notification of subscriber policy data modification from the H-UDR by invoking Nudr_DataRepository_Unsubscribe service operation by sending the HTTP DELETE request to the ""IndividualPolicyDataSubscription"" resource if it has subscribed such notification.
-	The PCF invokes also the Nudr_DataRepository_Unsubscribe service operation to unsubscribe from notifications about service parameter data changes at the UDR by sending an HTTP DELETE request to the ""IndividualApplicationDataSubscription"" resource if it has subscribed such notification.
-	The PCF invokes also the Nudr_DataRepository_Unsubscribe service operation to unsubscribe from notifications about 5G VN group configuration data changes at the UDR by sending an HTTP DELETE request to the ""IndividualSubscriptionDataSubscription"" resource as specified in 3GPP TS 29.505 [47] if it has subscribed such notification.
NOTE:	The PCF will not invoke the Nudr_DataRepository_Unsubscribe service operation when the PCF has internally stored the retrieved 5G VN group configuration data for later use for other SUPIs that belong to the same Internal-Group-Id.
12.	The H-UDR sends an HTTP ""204 No Content"" response to the H-PCF.",TS 29.513,5.6.3.1.3,all_images/image_1061.jpeg,AMF-initiated UE Policy Association Termination procedure – Roaming
"Figure 5.6.3.2.2-1: PCF-initiated UE Policy Association Termination procedure – Non-roaming
1.	The subscriber policy control data is removed from the UDR.
2.	The UDR invokes the Nudr_DataRepository_Notify service operation by sending the HTTP POST request to callback URI ""{notificationUri}"" to notify the PCF that the policy profile is removed if PCF has subscribed such notification.
3.	The PCF sends HTTP ""204 No Content"" response to confirm reception and the result to UDR.
4.	The PCF may, depending on operator policies, invoke the Npcf_UEPolicyControl_UpdateNotify service operation to the AMF of the removal of the UE policy control information by sending the HTTP POST request to the callback URI ""{notificationUri}/terminate"".
Alternatively, the PCF may decide to maintain the UE Policy Association if a default profile is applied, and then step 4 through 6 are not executed.
5.	The AMF sends an HTTP ""204 No Content"" response to the PCF.
6.	Steps 1 to 4 as specified in Figure 5.6.3.1.2-1 are executed.",TS 29.513,5.6.3.2.2,all_images/image_1062.jpeg,PCF-initiated UE Policy Association Termination procedure – Non-roaming
"Figure 5.6.3.2.3-1: PCF-initiated UE Policy Association Termination procedure – Roaming
1.	The subscriber policy control data is removed from the H-UDR.
2.	The H-UDR invokes the Nudr_DataRepository_Notify service operation by sending the HTTP POST request to callback URI ""{notificationUri}"" to notify the H-PCF that the policy profile is removed if H-PCF has subscribed such notification.
3.	The H-PCF sends HTTP ""204 No Content"" response to confirm reception and the result to H-UDR.
4.	The H-PCF may, depending on operator policies, invoke the Npcf_UEPolicyControl_UpdateNotify service operation to the AMF of the removal of the UE policy control information by sending the HTTP POST request to the callback URI ""{notificationUri}/terminate"".
Alternatively, the H-PCF may decide to maintain the UE Policy Association if a default profile is applied, and then step 4 through 10 are not executed.
5.	The AMF sends an HTTP ""204 No Content"" response to the V-PCF.
6.	The V-PCF invokes the Npcf_UEPolicyControl_UpdateNotify service operation to the AMF of the removal of the UE policy control information by sending the HTTP POST request to the callback URI ""{notificationUri}/terminate"".
7.	The AMF sends an HTTP ""204 No Content"" response to the V-PCF.
8.	The V-PCF invokes the Nudr_DataRepository_Unsubscribe service operation by sending the HTTP DELETE request to the ""IndividualPolicyDataSubscription"" resource to unsubscribe the notification from the V-UDR on changes in UE policy information if it has subscribed such notification.
9.	The V-UDR sends an HTTP ""204 No Content"" response to the V-PCF.
10.	Steps 1 to 6 as specified in Figure 5.6.3.1.3-1 are executed.",TS 29.513,5.6.3.2.3,all_images/image_1063.jpeg,PCF-initiated UE Policy Association Termination procedure – Roaming
"This case is not describe in IETF draft-ietf-quic-http [7].
In this scenario:
-	NF service consumer supports QUIC and has established a QUIC transport connection with its next hop HTTP proxy;
-	NF service consumer discovers that NF service producer supports only TCP.
-	The URI scheme of the API exposed by the NF service producer is http
In this case, the NF service consumer has the following options:
-	Option#1: The NF service consumer uses TCP transport towards the proxy as well. This implies the proxy also supports TCP transport (which is a reasonable assumption considering that during the migration from TCP to QUIC many HTTP entities will support both transports).
-	Option#2: The NF service consumer uses QUIC transport towards the HTTP proxy and the proxy uses TCP transport towards the NF service producer. The HTTP proxy discovers whether the NF service producer supports TCP or QUIC based on apriori connection setup. For example, in the case of SEPP all NFs in a PLMN connect to the SEPP and establish a HTTP/2 or HTTP/3 connection depending on what transport is supported by both the SEPP and the NF service producer. IETF draft-ietf-quic-http [7], clause 2.3 specifies that HTTP/3 clients shall indicate the target domain name during the TLS handshake of QUIC connection setup. The certificate provided at connection setup shall be valid for the target domain name.
Editor's Notes: It is unclear what domain name shall be used for the target domain name when the connection is with a proxy (proxy domain name or the origin server one).
The draft also says in clause 2.4 that a connection to a server endpoint may be reused for requests with multiple different URI authority components. The client may send any requests for which the client considers the server (the one at the existing connection endpoint) authoritative.
Editor's Notes: In our case the client knows that existing QUIC connection ends at a proxy and not at a server. So it is unclear if we can reuse an existing QUIC connection to a proxy endpoint. Also it is unclear if a client can consider a proxy as an authoritative server as proxies and servers are essentially different HTTP entities.
The draft loosely specifies in clause 2.4 how the client knows that the server at the endpoint of the reused QUIC connection (the proxy in our case) is authoritative for requests directed to other domains. It mentions that typically the client discovers that a particular server is the authoritative HTTP/3 endpoint based on the client having received Alt-Svc HTTP response header or the HTTP/2 ALTSVC frame (see IETF RFC 7838 [20]).
Editor's Note:	Whether other mechanisms other than use of IETF RFC 7838 [20] can be considered to discover a particular HTTP/3 endpoint is the authoritative endpoint for a URI authoritative component is FFS.
Finally, the clients shall check that the nominated server can present a valid certificate for the Origin Server before considering it authoritative. Therefore, the HTTP proxy has to present a certificate to the HTTP/3 client on behalf of the HTTP Origin Server (NF service producer) that is valid for multiple domain names and signed by the client network's own certificate authority. In roaming, the client network owner (the VPLMN) and the origin server network owner (the HPLMN) are different authorities and such a certificate is impossible to issue by a regular certification authority (e.g. Verisign). The only possibility is that the HTTP client should be configured to trust the HTTP proxy as the certificate authority. Only then this option#2 will work.
-	Option#3: The NF service consumer uses QUIC transport towards the HTTP proxy. The proxy provides a certificate only valid for itself at QUIC connection setup. When the NF service consumer needs to send a request to an NF Service producer it first establishes a tunnel through the proxy by sending an HTTP CONNECT message in a new stream with an "":authority"" pseudo-header field identifying the NF Service producer. The proxy then creates a TCP connection towards the NF service producer. Once the TCP connection is completed, a tunnel is created between the NF service consumer and producer. This tunnel is used by the NF service consumer to create a direct HTTP/2 connection (without an end to end TLS) with the NF service producer. HTTP/2 messages can now flow between the two entities. This is illustrated by the figure below.
Figure 6.2.2.1-1: http via HTTP/3 Proxy to NF Service Producer Supporting TCP
NOTE 1:	Option 3 is not described by IETF draft-ietf-quic-http [7] which only describes the use of the CONNECT method to setup a TLS session between an HTTP client and an Origin server.Most of the existing implementation also restricts the usage of CONNECT to https URIs. This option excludes the use of current implementations available on the market. However for 3GPP NF services, the HTTP clients will be the HTTP client libraries supported in various programming languages. One could program in such a way to use HTTP CONNECT via a proxy for http URI too.
NOTE 2: IETF draft-ietf-quic-http [7] doesn't explicitly say if the verifications listed in clause 2.4 of the draft that authorize the reuse of an existing QUIC connection are applicable to the CONNECT method.",TR 29.893,6.2.2.1,all_images/image_1067.png,http via HTTP/3 Proxy to NF Service Producer Supporting TCP
"In this scenario:
-	NF service consumer supports QUIC and has established a QUIC transport connection with its next hop HTTP proxy;
-	NF service consumer discovers that NF service producer also supports QUIC.
-	The URI scheme of the API exposed by the NF service producer is http
In this case the NF service consumer uses QUIC transport towards the HTTP proxy and the HTTP proxy also uses QUIC transport towards the NF service producer. The QUIC connections on the both side of the leg of HTTP proxy are separate QUIC connections. As TLS is integrated in QUIC, this means this setup would also terminate the TLS at the proxy which is undesirable. In case of proxying with HTTP/2 only the TCP connection is terminated at the proxy but the TLS connection on top of TCP is end-to-end.
The figure below illustrates the case where the HTTP client and server are connected with two QUIC connections through an HTTP proxy.
The connection with the HTTP proxy would be reused for requests sent to multiple domains. When the proxy needs to forward a message to a new HTTP server, it establishes a new QUIC connection with it. The server provides a valid certificate for itself.
Figure 6.2.2.2-1: http via HTTP/3 Proxy to NF Service Producer Supporting QUIC
Case B is not described in IETF draft-ietf-quic-http [7] and the same questions regarding the QUIC connection with the proxy as specified for Case A remains open with Case B.
As per IETF draft-ietf-quic-http [7], clause 2.4, a HTTP client MUST verify if the nominated HTTP server it is communicating with (i.e. HTTP proxy in this case) can present a valid certificate for the origin before considering it authoritative. Hence in order to setup an end to end QUIC connection between the HTTP client and the HTTP server via a HTTP/3 proxy, an equivalent of HTTP CONNECT to setup a tunnel is required. Currently such an option does not exist. HTTP CONNECT is used only when the URI scheme is https and upon getting a HTTP CONNECT request a HTTP/3 proxy establishes a TCP connection with the HTTP server (and not a QUIC connection) as specified in clause 5.2 of IETF draft-ietf-quic-http [7].
NOTE:	The use of HTTP CONNECT by HTTP clients when accessing https URI via a proxy is not mandated in IETF RFC 7231 [22]. However many browsers by default use HTTP CONNECT when accessing https URIs via a proxy. For 3GPP NF services, the HTTP clients will be the HTTP client libraries supported in various programming languages. One could program in such a way not to use HTTP CONNECT via a proxy and trust the certificates issued by the proxy effectively allowing the proxy to act as man in the middle.
IETF draft-pardue-httpbis-http-network-tunnelling-01 [21] tries to provide a solution that permits a UDP-based HTTP/3 client behind an HTTP proxy to establish an HTTP/3 session with the origin. As the successor approach, IETF is reviewing a working group formation proposal to work on a HTTP based proxying solution for end to end encrypted traffic, named MASQUE [35]. This result of this working group will allow the end point to communicate with end to end QUIC encryption while use the proxy on the path. This means the HTTP client (consumer) will maintain a QUIC tunnelling connection towards the HTTP/3 proxy and inside that tunnel the consumer will have an end to end QUIC connection towards the HTTP server (provider).",TR 29.893,6.2.2.2,all_images/image_1068.jpeg,http via HTTP/3 Proxy to NF Service Producer Supporting QUIC
"In this scenario:
-	NF service consumer supports QUIC and has established a QUIC transport connection with its next hop HTTP proxy;
-	NF service consumer discovers that NF service producer also supports only TCP.
-	The URI scheme of the API exposed by the NF service producer is https
In this case the following sequence of events happen
-	HTTP client establishes a QUIC connection with the HTTP proxy, if not setup earlier.
-	HTTP client sends a HTTP CONNECT request to the proxy with "":authority"" pseudo-header set to the NF service producer FQDN or IP address.
-	HTTP proxy sets up a TCP connection with NF service producer (HTTP server).
-	HTTP proxy sends a HTTP CONNECT response to the HTTP client.
-	HTTP client does end to end TLS connection setup with the NF service producer. An encrypted tunnel between the client and the server is now setup and HTTP/2 connection can be setup on top.
NOTE 1:	The HTTP client has to do encryption twice - one for the TLS tunnel and one for the QUIC connection with proxy.
NOTE 2:	The current design of CONNECT-based tunnelling reserves an ordered byte stream (HTTP/2 and HTTP/3) for the client-to-proxy hop. This is subject to head of-line (HoL) blocking. See IETF draft-pardue-httpbis-http-network-tunnelling-01 [21] clause 3.6.
This scenario is illustrated in the figure below
Figure 6.2.2.3-1: https via HTTP/3 Proxy to NF Service Producer Supporting TCP
According to RFC 7230 [23] clause 2.7.3, the client shall ensure that its connection to the origin server is secured through the use of strong encryption, end-to-end, prior to sending the first HTTP request when the https URI scheme is used.
When an HTTP proxy is deployed, end-to-end security is ensured by setting-up a tunnel between the client and the Origin server using the HTTP CONNECT method which is then secured with TLS.
A HTTP client implementation may decide not to enforce E2E security with TLS though the https URI scheme is used and connection to the Origin server is done via a proxy. IETF RFC 7231 [22] does not mandate the use of HTTP CONNECT for accessing https URI via a proxy. If a HTTP client decides not to use CONNECT, then it may trust the certificates issued by the HTTP/3 proxy on behalf of the HTTP/TCP server signed by the proxy's certificate authority, thus allowing the HTTP/3 proxy to act as man in the middle. This would violate the requirement for the HTTP client in RFC 7230 [23] clause 2.7.3.
Alternatively the NF service consumer may decide to use TCP transport towards the HTTP/proxy similar to option#1 provided in clause 6.2.2.1. In this case, the NF service consumer avoids double ciphering.",TR 29.893,6.2.2.3,all_images/image_1069.png,https via HTTP/3 Proxy to NF Service Producer Supporting TCP
"3GPP TS 23.222 [2], clause 6 specifies the functional entities and domains of the functional model, which is depicted in Figure 4.2-1, in detail.
Figure 4.2-1: CAPIF Functional Model
CAPIF-1 and CAPIF-1e reference points connect an API invoker inside the PLMN Trust Domain and an API invoker outside the PLMN Trust Domain respectively, with the CAPIF core function.
CAPIF-2 and CAPIF-2e reference points connect an API invoker inside the PLMN Trust Domain and an API invoker outside the PLMN Trust Domain respectively, with the API exposing function.
CAPIF-3 reference point connects an API exposing function inside the PLMN Trust Domain with the CAPIF core function.
CAPIF-4 reference point connects an API publishing function inside the PLMN Trust Domain with the CAPIF core function.
CAPIF-5 reference point connects an API management function inside the PLMN Trust Domain with the CAPIF core function.
NOTE:	The API exposing function, API publishing function and API management function are part the API provider domain which can be implemented by the Service Capability Exposure Function (SCEF) and/or the Network Exposure Function (NEF).
3GPP TS 23.222 [2], clause 6 specifies functional model for the CAPIF to support 3rd party API providers, which is depicted in Figure 4.2-2 in detail
Figure 4.2-2: Functional model for the CAPIF to support 3rd party API providers
The CAPIF core function in the PLMN trust domain supports service APIs from both the PLMN trust domain and the 3rd party trust domain having business relationship with PLMN Trust Domain. The API invokers may exist within the PLMN trust domain, or within the 3rd party trust domain or outside of both the PLMN trust domain and the 3rd party trust domain.
CAPIF-3e reference point connects an API exposing function outside PLMN Trust Domain with the CAPIF core function.
CAPIF-4e reference point connects an API publishing function outside PLMN Trust Domain with the CAPIF core function.
CAPIF-5e reference point connects an API management function outside PLMN Trust Domain with the CAPIF core function.
CAPIF-7 and CAPIF-7e reference points connect API exposing functions within PLMN Trust Domain and outside PLMN Trust Domains respectively. 3GPP TS 23.222 [2] specifies functional model for interactions between API exposing functions.
NOTE:	CAPIF-7 reference point is not represented in the Figure 4.2-2 which is aligning to TS 23.222 [2].
3GPP TS 23.222 [2], clause 6 specifies functional model to support CAPIF interconnection, which is depicted in Figure 4.2-3 in detail.
Figure 4.2-3: CAPIF interconnection functional model
CAPIF-6 and CAPIF-6e reference points connect two CAPIF core functions located in the same or different PLMN trust domains, respectively. The reference points allows API invokers of a CAPIF provider to utilize the service APIs from the 3rd party CAPIF provider or another CAPIF provider within trust domain.",TS 29.222,4.2,all_images/image_1071.jpeg,Functional model for the CAPIF to support 3rd party API providers
"The mapping of procedures for this scenario is shown in figure 7.10.1-1:
Figure 7.10.1-1: Mapping of Trace Activation Procedure for scenario with one IWF
1.	The IWF receives an ActivateTraceMode message from the HSS.
2.	The IWF shall construct an IDR message and send it to the MME, SGSN, or combined MME/SGSN.
3.	The IWF receives IDA from the MME, SGSN, or combined MME/SGSN.
4.	The IWF shall send an ActivateTraceMode Ack to the HSS.",TS 29.305,7.10.1,all_images/image_1074.jpeg,Mapping of Trace Activation Procedure for scenario with one IWF
"Figure 7.10.2-1: Mapping of Trace Activation Procedure for scenario with two IWFs
1.	The IWF2 receives an IDR message from the HSS.
2.	If the IWF2 finds that Trace Data is included in the IDR, it shall open a MAP v3 dialogue towards IWF1 by sending ActivateTraceMode.
3.	The IWF1 shall construct an IDR message and shall send it to the MME, SGSN, or combined MME/SGSN.
4.	The IWF1 receives IDA from the MME, SGSN, or combined MME/SGSN.
5.	The IWF1 shall send an ActivateTraceMode Ack to IWF2.
6.	IWF2 shall send an IDA to the HSS.",TS 29.305,7.10.2,all_images/image_1075.jpeg,Mapping of Trace Activation Procedure for scenario with two IWFs
"The mapping of procedures for this scenario is shown in figure 7.11.1-1:
Figure 7.11.1-1: Mapping of Trace Deactivation Procedure for scenario with one IWF
1.	The IWF receives a DeactivateTraceMode message from the HSS.
2.	The IWF shall construct a DSR message and shall send it to the MME, SGSN, or the combined MME/SGSN.
3.	The IWF receives DSA from the MME, SGSN, or combined MME/SGSN.
4.	The IWF shall send a DeactivateTraceMode Ack to the HSS.",TS 29.305,7.11.1,all_images/image_1076.jpeg,Mapping of Trace Deactivation Procedure for scenario with one IWF
"Figure 7.11.2-1: Mapping of Trace Deactivation Procedure for scenario with two IWFs
1.	The IWF2 receives a DSR message from the HSS.
2.	If the IWF2 finds that a Trace Data Withdrawal indication is included in the DSR, it shall open a MAP v3 dialogue towards IWF1 by sending DeactivateTraceMode.
3.	The IWF1 shall construct a DSR message and shall send it to the MME, SGSN, or the combined MME/SGSN.
4.	The IWF1 receives DSA from the MME, SGSN, or combined MME/SGSN.
5.	The IWF1 shall send a DeactivateTraceMode Ack to the IWF2.
6.	The IWF2 shall send a DSA to the HSS.",TS 29.305,7.11.2,all_images/image_1077.jpeg,Mapping of Trace Deactivation Procedure for scenario with two IWFs
"Within this basic approach 3 traversal scenarios exist which are shown in table 4.3.1.3-1.
Table 4.3.1.3-1: Traversal scenarios for basic IMS roaming scenario without loopback
Figure 4.3.1.3-1: IOI information exchange for the ""Basic IMS"" roaming case with home routing of media
In order to meet the requirements of 3GPP TS 24.229 [4] there needs to be an IOI exchange including originating IOI, transit IOIs, and terminating IOI for each of the three signalling paths crossing network boundaries.",TR 29.949,4.3.1.3,all_images/image_1078.jpeg,"IOI information exchange for the ""Basic IMS"" roaming case with home routing of"
"Within the loopback approach 4 traversal scenarios exist which are shown in table 4.3.1.4-1.
Table 4.3.1.4-1: Traversal scenarios for ""Originating visited network with loopback routeing scenario""
For roaming with loopback the ""Originating visited network with loopback routing scenario"" introduces the case where the SIP signalling and the media are routed from the originating visited network to the destination and where the SIP signalling is first routed to the originating home network for a service execution and then back to the originating visited network to allow the originating visited network to route both SIP signalling and media to the destination.
The complete sequence of IOI exchanges for the IMS roaming scenario with originating visited network routing option is depicted in figure 4.3.1.4-1.
Figure 4.3.1.4-1: IOI exchange for IMS roaming with originating visited network with loopback routing
In order to meet the requirements of 3GPP TS 24.229 [4] there needs to be an IOI exchange including originating IOI, transit IOIs, and terminating IOI for each of four signalling paths crossing network boundaries.",TR 29.949,4.3.1.4,all_images/image_1079.jpeg,IOI exchange for IMS roaming with originating visited network with loopback routing
"3GPP TS 24.229 [4] describes that for transit networks based on local policy the additional routeing function in the transit network adds in requests and in responses the P-Charging-Vector header field a ""transit-ioi"" header field parameter with an entry which identifies the operator network which the request or response is transiting or with a void entry.
When the index is calculated then ""void"" entries are taken into account.
Based on local policy the additional routeing function deletes or void in requests and in responses in the P-Charging-Vector header field any received ""transit-ioi"" header field parameter value.
Specific ruling may also apply to IBCF:
1. IBCF acting as entry point:
Based on local policy, the IBCF acting as an entry point adds in requests in the P-Charging-Vector header field a ""transit-ioi"" header field parameter with an entry which identifies the operator network which the request is transiting or with a void entry.
Based on local policy the IBCF deletes or void in requests in the P-Charging-Vector header field any received ""transit-ioi"" header field parameter value.
Only one ""transit-ioi"" header field parameter entry is added per transit network.
2. IBCF acting as exit point:
Based on local policy, the IBCF acting as an exit point adds in responses in the P-Charging-Vector header field a ""transit-ioi"" header field parameter with an entry which identifies the operator network which the response is transiting or with a void entry.
Based on local policy the IBCF deletes or void in responses in the P-Charging-Vector header field any received ""transit-ioi"" header field parameter value.
Considering figure 4.3.1.5-1 either the IBCF-entryA1 in combination with the IBCF-exitA1 or the transit function can do the setting of the transit-ioi. But also due to 3GPP TS 24.229 [4], subsection 4.5.4A, the transit function can control if a transit-ioi will be deleted or voided.
Figure 4.3.1.5-1: IOI exchange for IMS roaming transit
1.	The IBCF-entryA1 receives an INVITE request containing the ""transit-ioi"" header field parameter in the P-Charging-Vector header field and sends the INVITE request towards the transit function.
NOTE 1:	If no ""transit-ioi"" header field parameter is included or if the included ""transit-ioi"" header field parameter is missing a preceeding interconnection network and the preceding network is an interconnection network, the IBCF-entryA1 can based on local policy, add the transit-ioi"" header field parameter with an entry identifying the preceding interconnection network.
2.	The transit function stores and removes the ""transit-ioi"" header field parameter from the P-Charging-Vector header field, adds the Relayed-Charge header field with the content received in the ""transit-ioi"" and forwards the INVITE request to the AS.
3.	The AS stores the content of the Relayed-Charge header field and sends the INVITE request to the transit function.
4.	The transit function removes the Relayed-Charge header field and includes the stored ""transit-ioi"" header field parameter in the P-Charging-Vector header field. The transit function also appends an entry in the ""transit-ioi"". Based on local policy, the appended entry can identify the interconnection network or be set to void. The INVITE request is sent to the IBCF-exitA1.
NOTE 2:	Based on local policy, the transit function can also void entries in the received ""transit-ioi"" header field parameter.
5.	Upon receipt of a provisional response (in this case the 183 (Session Progress) response) containing the P-Charging-Vector header field, the IBCF-exitA1 sends the response to the transit function.
NOTE 3:	If no ""transit-ioi"" header field parameter is included or if the included ""transit-ioi"" header field parameter is missing a preceding interconnection network and the preceding network is an interconnection network, the IBCF-exitA1 can based on local policy, add the transit-ioi"" header field parameter with an entry identifying the preceding interconnection network.
6.	The transit function stores and removes the ""transit-ioi"" header field parameter from the P-Charging-Vector header field, adds the Relayed-Charge header field with the content received in the ""transit-ioi"" and forwards the 183 (Session Progress) response to the AS.
7.	The AS stores the content of the Relayed-Charge header field and sends the 183 (Session Progress) response to the transit function.
8.	The transit function removes the Relayed-Charge header field and includes the stored ""transit-ioi"" header field parameter in the P-Charging-Vector header field. The transit function also appends an entry in the ""transit-ioi"". Based on local policy, the appended entry can identify the interconnection network or be set to void. The 183 (Session Progress) response is sent to the IBCF-entryA1.
NOTE 4:	Based on local policy, the transit function can also void entries in the received ""transit-ioi"" header field parameter.",TR 29.949,4.3.1.5,all_images/image_1080.jpeg,IOI exchange for IMS roaming transit
"The registration procedure between the visited network and the home network uses an IC network which provides SIP proxy nodes to relay SIP traffic between these networks.
For the registration the UE addresses an FQDN in the home network domain which reflects the registrar (i.e. the S-CSCF of the home network). With this FQDN the IBCF acting as an exit point in the visited network chooses an IC provider and routes to a SIP proxy of the selected IC provider.
The SIP layer signalling is served by the IC provider's SIP proxy. The SIP proxy decides on the next SIP proxy towards the home network and routes to the next SIP proxy or to the IBCF acting as an entry point in the home network, if no further SIP proxy is required.
NOTE 1:	The call flows just show scenarios with a single IC network and a single SIP proxy.
The user A at UE-A is roaming into a visited network vA. The user A is a subscriber of operator hA.
Figure 5.2.2-1: Message flow for Registration via IC SIP proxy
Call flow details:
1.	REGISTER request (UE-A to P-CSCF-vA1) - see example in table 5.2.2-1.
The user A at UE-A initiates registration. The UE-A sends an initial REGISTER request to the P-CSCF-vA1 according to 3GPP TS 24.229 [4].
Table 5.2.2-1: REGISTER request (UE-A to P-CSCF-vA1)
REGISTER sip:home-A.net SIP/2.0
P-Access-Network-Info: 3GPP-E-UTRAN-TDD; utran-cell-id-3gpp=234151D0FCE11
From: <sip:userA_public1@home-A.net>;tag=4fa3
To: <sip:userA_public1@home-A.net>
Contact: <sip:[5555::aaa:bbb:ccc:ddd]>;reg-id=1; +sip.instance=""<urn:gsma:imei:90420156-025763-0>"";expires=600000
Via: SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd];branch=z9hG4bKnashds7
CSeq: 1 REGISTER
Supported: path
Other SIP header fields are set according to 3GPP TS 24.229 [4].
Request-URI:	The Request-URI sip:home-A.net (the URI that follows the method name, ""REGISTER"", in the first line) indicates the destination domain of this REGISTER request which is the home network.
From:	Set to the SIP URI that is the default public user identity of the user A i.e. userA_public1@home-A.net.
To:	Set to the SIP URI that is the default public user identity of the user A i.e. userA_public1@home-A.net.
Supported:	The UE-A inserts the Supported header field containing the option-tag ""path"".
2.	REGISTER request (P-CSCF-vA1 to IBCF-vA1) - see example in table 5.2.2-2.
When the P-CSCF-vA1 receives the initial REGISTER request the P-CSCF-vA1 adds the P-Visited-Network-ID header field containing the identifier of the P-CSCF network. This may be the visited network domain name or any other identifier that identifies the visited network at the home network.
The P-CSCF-vA1 needs to be in the path for all terminating requests for this user. To ensure this, the P-CSCF-vA1 adds itself to the Path header field for future requests.
The P-CSCF-vA1 selects an IBCF (IBCF-vA1) to be the IBCF acting as an exit point towards the home network hA of the user A and sends the REGISTER request according to 3GPP TS 24.229 [4] to IBCF-vA1.
Table 5.2.2-2: REGISTER request (P-CSCF-vA1 to IBCF-vA1)
REGISTER sip:home-A.net SIP/2.0
P-Access-Network-Info: 3GPP-E-UTRAN-TDD; utran-cell-id-3gpp=234151D0FCE11, 3GPP-E-UTRAN-TDD; utran-cell-id-3gpp=234151D0FCE11;network-provided;local-time-zone=""UTC+01:00"";daylight-saving-time=""01""
From:
To:
Contact:
CSeq:
Supported:
Require: path
Path: <sip:visit-xyz@pcscf-vA1.visited-A.net:5070;lr;iotl=homeB-visitedB>
Route: <sip:reg@ibcf-vA1.visited-A.net;lr>
P-Visited-Network-ID: ""Visited Network Number A""
P-Charging-Vector: icid-value=""AyretyU0dm+6O2IrT5tAFrbHLso=023551024"";orig-ioi=""Type 1visited-a""
Via: SIP/2.0/UDP pcscf-vA1.visited-A.net:5060;branch=z9hG4bKnas56565,
SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd];branch=z9hG4bKnashds7
...
Other SIP header fields are set according to 3GPP TS 24.229 [4].
Route:	P-CSCF-vA1 includes the selected IBCF-vA1 URI.
P-Charging-Vector:	The P-CSCF-vA1 provides an ICID value and adds a type 1 ""orig-ioi"" header field parameter with the IOI value identifying the visited network (i.e. ""visited-a"").
Path:	This is the address of the P-CSCF-vA1 and is included to inform the S-CSCF where to route terminating requests. The Path header field includes traffic leg information in the ""iotl"" SIP URI parameter according to IETF RFC 7549 [26].
Require:	The P-CSCF-vA adds the Require header field containing the option-tag ""path"" to ensure that the recipient correctly handles the Path header field. If the recipient does not support the Path header field, a SIP response will be received with a status code of 420 and an Unsupported header field indicating the option-tag ""path"". Such a response indicates a wrong configuration of the routing tables and the request has been routed outside the IM CN subsystem.
Via:	The P-CSCF-vA1 adds a Via header field with the address to receive the response to the REGISTER request.
P-Access-Network-Info:	The P-CSCF-vA1 adds a network provided location, time-zone and daylight saving time. If it doesn't indicate that it is a network provided location, the P-Access-Network-Info header field containing the location provided by the UE-A is kept in the INVITE request.
3.	REGISTER request (IBCF-vA1 to IC-A1) - see example in table 5.2.2-3.
The IBCF-vA1 receives the initial REGISTER request and analyses the request line and forwards registration to preferred VoIP IC provider (i.e. to IC A). The IBCF-vA1 determines the next hop IP address from the request URI either by configured information or using a DNS query according to IETF RFC 3263 [13]. If the subsequent interconnection network is SIP-aware, the determined IP address will belong to the SIP proxy IC-A1. Otherwise the determined IP address will point to IBCF-hA1 and step 4 is skipped (not reflected in message details below).
The IBCF-vA1 adds its own address to the Path header field.
Table 5.2.2-3: REGISTER request (IBCF-vA1 to IC-A1)
REGISTER sip:home-A.net SIP/2.0
P-Access-Network-Info:
From:
To:
Contact:
CSeq:
Supported:
Require:
Path: <sip:visit-abc@ibcf-vA1.visited-A.net:5070;lr>,<sip:visit-xyz@pcscf-vA1.visited-A.net:5070;lr;iotl=homeB-visitedB>
Route: <sip:reg@ic-A1.interconnection-A.net;lr>
P-Visited-Network-ID:
P-Charging-Vector:
Via: SIP/2.0/UDP ibcf-vA1.visited-A.net;branch=z9hG4bK351g45.1,
SIP/2.0/UDP pcscf-vA1.visited-A.net:5060;branch=z9hG4bKnas56565,
SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd];branch=z9hG4bKnashds7
...
Other SIP header fields are set according to 3GPP TS 24.229 [4].
Path:	Based on topology hiding functionality the IBCF-vA1 will either forward the Path header field with:
-	one visible IBCF-vA1 entry and the remaining collected entries as one hidden entry. If the SIP URI in the bottommost hidden Path header field contains an ""iotl"" SIP URI parameter then IBCF-vA1will append an ""iotl"" SIP URI parameter with the same value to its own SIP URI in the Path header field; or
-	one IBCF-vA1 entry and the whole content of already collected entries as visible entries.
Route:	The IBCF-vA1 adds a Route header field identifying the selected node in the IC network A.
Via:	Based on topology hiding functionality the IBCF-vA1 will either forward the Via header field with:
-	one visible IBCF-vA1 entry and the remaining collected entries as one hidden entry; or
-	one IBCF-vA1 entry and the whole content of already collected entries as visible entries.
4.	REGISTER request (IC-A1 to IBCF-hA1) - see example in table 5.2.2-4.
NOTE 2:	If the subsequent interconnection network is SIP-unaware, step 4 is skipped (not reflected in message details below).
The IC-A1 receives the initial REGISTER request and analyses the request line and forwards registration to the IBCF-hA1 of the home network of user A. The routing could either apply via DSN or any other routeing mechanism.
Table 5.2.2-4: REGISTER request (IC-A1 to IBCF-hA1)
REGISTER sip:home-A.net SIP/2.0
P-Access-Network-Info:
From:
To:
CSeq:
Supported:
Require:
Contact:
Path: <sip:proxy-abc@ic-A1.interconnection-A.net:5070;lr>,<sip:visit-abc@ibcf-vA1.visited-A.net:5070;lr>,<sip:visit-xyz@pcscf-vA1.visited-A.net:5070;lr;iotl=homeB-visitedB>
Route: <sip:reg@ibcf-hA1.home-A.net;lr>
P-Visited-Network-ID:
P-Charging-Vector: icid-value=""AyretyU0dm+6O2IrT5tAFrbHLso=023551024"";
orig-ioi=""Type 1visited-a"";transit-ioi=""ICa.1""
Via: SIP/2.0/UDP ic-A1.interconnection-A.net;branch=z9hG4bK351g45.2,
SIP/2.0/UDP ibcf-vA1.visited-A.net;branch=z9hG4bK351g45.1,
SIP/2.0/UDP pcscf-vA1.visited-A.net:5060;branch=z9hG4bKnas56565,
SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd];branch=z9hG4bKnashds7
...
Other SIP header fields are set according to 3GPP TS 24.229 [4].
P-Charging-Vector:	In this example the IC-A1 adds the identity of the IC-A1 VoIP provider (i.e. ""ICa"") in the ""transit-ioi"" header field parameter. However, if the REGISTER request is routed via more than one IC VoIP provider network each IC VoIP provider receiving the REGISTER request adds a ""transit-ioi"" header field entry containing the IC VoIP provider identity.
Path:	Based on SLA between IC partners and roaming partners the address of the IC-A1 will be added or not added by IC-A1.
Route:	The IC-A1 adds a Route header field identifying the selected entry point in the home network hA.
Via:	The Via header field is added by each proxy in IC networks, in this example the Via header field is only added by IC-A1.
5.	REGISTER request (IBCF-hA1 to I-CSCF-hA1) - see example in table 5.2.2-5.
The IBCF-hA1 receives the initial REGISTER request and analyses the request line and forwards registration to the I-CSCF-hA1. The IBCF-hA1 adds a Route header field with the address of the I-CSCF-hA1 of the home network of user A. In this example, the IBCF-hA1 does not add any ""transit-ioi"" header field parameter in the P-Charging-Vector header field. However, the IBCF-hA1 adds the ""transit-ioi"" header field parameter based on local policy, when the ""transit-ioi"" identifying the preceding interconnection network is not included in the received request (e.g. when the preceding interconnection network is not an IMS transit network).
For performance reasons this I-CSCF-hA1 could be used only for registration traffic for roaming user which is due to local policy of the home network operator.
Table 5.2.2-5: REGISTER request (IBCF-hA1 to I-CSCF-hA1)
REGISTER sip:home-A.net SIP/2.0
P-Access-Network-Info:
From:
To:
Contact:
CSeq:
Supported:
Require:
Path: <sip:home-abc@ibcf-hA1.home-A.net:5070;lr>,<sip:proxy-abc@ic-A1.interconnection-	A.net:5070;lr>,<sip:visit-abc@ibcf-vA1.visited-A.net:5070;lr>,<sip:visit-xyz@pcscf-vA1.visited-	A.net:5070;lr;iotl=homeB-visitedB>
Route: <sip:reg@icscf-hA1.home-A.net;lr>
P-Visited-Network-ID:
P-Charging-Vector:
Via: SIP/2.0/UDP ibcf-hA1.home-A.net;branch=z9hG4bK351g45.3,
SIP/2.0/UDP ic-A1.interconnection-A.net;branch=z9hG4bK351g45.2,
SIP/2.0/UDP ibcf-vA1.visited-A.net;branch=z9hG4bK351g45.1,
SIP/2.0/UDP pcscf-vA1.visited-A.net:5060;branch=z9hG4bKnas56565,
SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd];branch=z9hG4bKnashds7
...
Other SIP header fields are set according to 3GPP TS 24.229 [4].
Path:	The IBCF-hA1 adds a Path header field with the address to receive terminating dialog creating or stand-alone requests.
Route:	The IBCF-hA1 adds a Route header field identifying the I-CSCF-hA1 of the home network of user A.
Via:	The IBCF-hA1 adds a Via header field.
6.	REGISTER request (I-CSCF-hA1 to S-CSCF-hA1) - see example in table 5.2.2-6.
The I-CSCF-hA1 receives the REGISTER request and makes a request for information related to the subscriber registration status by sending the private user identity, public user identity and visited domain name to the HSS. The HSS returns the S-CSCF required capabilities and the I-CSCF-hA1 uses this information to select a suitable S-CSCF.
Due to the fact that the I-CSCF-hA1 only identifies the home S-CSCF which is responsible for the roaming user A, the I-CSCF-hA1 is not needed for future requests to be kept in the path, thus an I-CSCF entry is not needed within the Path header field.
But for the response to the REGISTER message the I-CSCF-hA1 has to be added in the Via header field.
Table 5.2.2-6: REGISTER request (I-CSCF-hA1 to S-CSCF-hA1)
REGISTER sip:home-A.net SIP/2.0
P-Access-Network-Info:
From:
To:
Contact:
CSeq:
Supported:
Require:
Path:
Route: <sip:reg@scscf-hA1.home-A.net;lr>
P-Visited-Network-ID:
P-Charging-Vector:
Via: SIP/2.0/UDP icscf-hA1.home-A.net;branch=z9hG4bK351g45.4,
SIP/2.0/UDP ibcf-hA1.home-A.net;branch=z9hG4bK351g45.3,
SIP/2.0/UDP ic-A1.interconnection-A.net;branch=z9hG4bK351g45.2,
SIP/2.0/UDP ibcf-vA1.visited-A.net;branch=z9hG4bK351g45.1,
SIP/2.0/UDP pcscf-vA1.visited-A.net:5060;branch=z9hG4bKnas56565,
SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd];branch=z9hG4bKnashds7
...
Other SIP header fields are set according to 3GPP TS 24.229 [4].
Route:	The I-CSCF-hA1 adds the address of the selected S-CSCF.
Via:	The I-CSCF-hA1 adds a Via header field with the address to receive the response to the REGISTER request.
7.	401 (Unauthorized) response (S-CSCF-hA1 to I-CSCF-hA1) - see example in table 5.2.2-7.
As the REGISTER request arrived without integrity protection to the P-CSCF, the S-CSCF-hA1 shall challenge the request. For this, the S-CSCF-hA1 requires at least one authentication vector to be used in the challenge to the user. If a valid authentication vector is not available, then the S-CSCF-hA1 requests at least one authentication vector from the HSS.
Table 5.2.2-7: 401 (Unauthorized) response (S-CSCF-hA1 to I-CSCF-hA1)
SIP/2.0 401 Unauthorized
Via: SIP/2.0/UDP icscf-hA1.home-A.net;branch=z9hG4bK351g45.4,
SIP/2.0/UDP ibcf-hA1.home-A.net;branch=z9hG4bK351g45.3,
SIP/2.0/UDP ic-A1.interconnection-A.net;branch=z9hG4bK351g45.2,
SIP/2.0/UDP ibcf-vA1.visited-A.net;branch=z9hG4bK351g45.1,
SIP/2.0/UDP pcscf-vA1.visited-A.net:5060;branch=z9hG4bKnas56565,
SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd];branch=z9hG4bKnashds7
From:
To: <sip:userA_public1@home-A.net>;tag=5ef4
CSeq:
P-Charging-Vector: icid-value=""AyretyU0dm+6O2IrT5tAFrbHLso=023551024"";orig-ioi=""Type 1visited-a"";term-ioi=""Type 1home-a""
WWW-Authenticate: Digest realm=""registrar.home-A.net"", nonce=""A34Cm+Fva37UYWpGNB34JP"", algorithm=AKAv1-MD5, ik=""00112233445566778899aabbccddeeff"", ck=""ffeeddccbbaa11223344556677889900""
Other SIP header fields are set according to 3GPP TS 24.229 [4].
P-Charging-Vector:	The P-Charging-Vector header field containing the ""orig-ioi"" header field parameter, if received in the REGISTER request and a type 1 ""term-ioi"" header field parameter. The S-CSCF-hA1 shall set the type 1 ""term-ioi"" header field parameter to a value that identifies the sending network of the response and the ""orig-ioi"" header field parameter is set to the previously received value of ""orig-ioi"" header field parameter.
The ""icid-value"" header field parameter is set to the previously received value of ""icid-value"" header field parameter in the request.
WWW-Authenticate:	The S-CSCF-hA1 includes the WWW-Authenticate header field with:
-	the ""realm"" header field parameter containing a globally unique name of the S-CSCF-hA1; 
-	the ""nonce"" header field parameter containing the quoted string, base64 encoded value of	the concatenation of the RANDom challenge (RAND) and Authentication TokeN (AUTN)	parameters and optional server specific data for the UE;
-	the security mechanism in the ""algorithm"" header field parameter;
-	the Integrity Key parameter for the P-CSCF in the ""ik"" header field parameter; and
-	the Cipher Key parameter for the P-CSCF in the ""ck"" header field parameter.
NOTE 3:	If the interconnection network is SIP-unaware, step 10 is skipped.
8-12.	401 (Unauthorized) response (I-CSCF-hA1 to UE-A).
Normal response routing procedure as described within 3GPP TS 24.229 [4] applies. No specific roaming procedures apply.
NOTE 4:	If the interconnection network is SIP-unaware, step 10 is skipped.
13-17.	REGISTER request (UE-A to I-CSCF-hA1).
The authentication challenge response is calculated by the UE-A and then put into the Authorization header field and sent back to the registrar in the REGISTER request. Procedures are described within 3GPP TS 24.229 [4].
UE-A registers a second time with an authentication response.
With the exception of the Authorization header field, the CSeq header field value and the ICID value in the P-Charging-Vector header field, the REGISTER message will contain the same information and the Path header fields and the Via header fields will be set as described within steps 1-5 of this call flow.
NOTE 5:	If the interconnection network is SIP-unaware, step 16 is skipped.
18.	REGISTER request (I-CSCF-hA1 to S-CSCF-hA1).
I-CSCF-hA1 queries IMS-HSS (LIR/LIA) as described within 3GPP TS 29.228 [14] and routes to the previously assigned S-CSCF-hA1. It is the same procedure as described within step 6 of this call flow.
The Path header field will be set as described within step 6 of this call flow.
19-22.	200 OK response (S-CSCF-hA1 to IBCF-vA1) - see example in table 5.2.2-19.
S-CSCF-hA1 confirms the registration as described within 3GPP TS 24.229 [4]. There are no roaming specific procedures that apply in addition.
The table 5.2.2-19 shows the content of the 200 (OK) response when sent by S-CSCF-hA1.
Table 5.2.2-19: 200 OK response (S-CSCF-hA1 to IBCF-vA1)
SIP/2.0 200 OK
Via: SIP/2.0/UDP icscf-hA1.home-A.net;branch=z9hG4bK351g45.4,
SIP/2.0/UDP ibcf-hA1.home-A.net;branch=z9hG4bK351g45.3,
SIP/2.0/UDP ic-A1.interconnection-A.net;branch=z9hG4bK351g45.2,
SIP/2.0/UDP ibcf-vA1.visited-A.net;branch=z9hG4bK351g45.1,
SIP/2.0/UDP pcscf-vA1.visited-A.net:5060;branch=z9hG4bKnas56565,
SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd];branch=z9hG4bKnashds7
From:
Service-Route: <sip:home-abc@scscf-hA1.home-A.net;lr;iotl=visitedA-homeA>
To:
CSeq: 2 REGISTER
Contact:
P-Associated-URI: <sip:userA_public1@home-A.net>,<tel:+1-237-555-1111>
P-Charging-Vector: icid-value=""AyretyU0dm+6O2IrT5tAFrbHLso=023551024"";orig-ioi=""Type 1visited-a"";term-ioi=""Type 1home-a""
Path: <sip:home-abc@ibcf-hA1.home-A.net:5070;lr>,
<sip:proxy-abc@ic-A1.interconnection-A.net:5070;lr>,
<sip:visit-abc@ibcf-vA1.visited-A.net:5070;lr>,
<sip:visit-xyz@pcscf-vA1.visited-A.net:5070;lr;iotl=homeB-visitedB>
Other SIP header fields are set according to 3GPP TS 24.229 [4].
Path:	List of Path header field received in the REGISTER request will be included. (IBCF-hA1, IC-A1, IBCF-vA1, P-CSCF-vA1).
P-Associated-URI:	Containing the list of the registered distinct public user identity and its associated set of implicitly registered distinct public user identities. The first URI in the list of public user identities supplied by the HSS to the S-CSCF will indicate the default public user identity to be used by the S-CSCF.
Service-Route:	Contains the SIP URI identifying the S-CSCF (S-CSCF-hA1) containing an indication that subsequent requests routed via this service route (i.e. from the P-CSCF to the S-CSCF). In case network topology hiding is required by the home network, a visible SIP URI identifying the IBCF (IBCF-hA1) will be added by the IBCF acting as an entry point as the topmost entry and a hidden SIP URI identifying the S-CSCF (S-CSCF-hA1) in the bottom. The Service-Route header field includes traffic leg information in the ""iotl"" SIP URI parameter according to IETF RFC 7549 [26].
P-Charging-Vector:	The P-Charging-Vector header field containing the ""orig-ioi"" header field parameter, if received in the REGISTER request and a type 1 ""term-ioi"" header field parameter. The S-CSCF-hA1 shall set the type 1 ""term-ioi"" header field parameter to a value that identifies the sending network of the response and the ""orig-ioi"" header field parameter is set to the previously received value of ""orig-ioi"" header field parameter.
The ""icid-value"" header field parameter is set to the previously received value of ""icid-value"" header field parameter in the request.
23.	200 OK response (IBCF-vA1 to P-CSCF-vA1).
If topology hiding is required by the visited network and the IBCF-vA1 applied topology hiding on the Path and Via header fields contained in the REGISTER request, the IBCF-vA1 performs a decryption procedure on the received Path and Via header fields, as described in clause 5.10.4.3of 3GPP TS 24.229 [4], and inserts a ""+g.3gpp.thig-path"" Feature-Caps header field parameter set to the same IBCF-vA1's SIP URI value as included in the Path header field of the REGISTER request sent to the home network.
24.	200 OK response (P-CSCF-vA1 to UE-A).
The P-CSCF-vA1 stores the value of received ""+g.3gpp.thig-path"" Feature-Caps header field parameter and removes the ""+g.3gpp.thig-path"" Feature-Caps header field parameter before forwarding the 200 (OK) response to the UE-A.",TR 29.949,5.2.2,all_images/image_1081.png,Message flow for Registration via IC SIP proxy
"After that the registration in clause 5.2.2 is successfully completed the UE subscribes to the registration-state event package as described in 3GPP TS 24.229 [4] clause 5.1.1.3.
Figure 5.2.3.2-1 shows how the UE-A sends the SUBSCRIBE request using the registration path.
Figure 5.2.3.2-1:	Subscription to the registration-state event package by the UE-A
The steps of the flow are as follows:
1.	The UE successfully registers as described in clause 5.2.2.
2.	SUBSCRIBE request (UE-A to P-CSCF-vA1) - see example in table 5.2.3.2-2.
The UE-A sends the SUBSCRIBE request as specified in 3GPP TS 24.229 [4] using the registration path created by the registration in clause 5.2.2.
Table 5.2.3.2-2: SUBSCRIBE request (UE-A to P-CSCF-vA1)
SUBSCRIBE sip:userA_public1@home-A.net SIP/2.0
From: <sip:userA_public1@home-A.net>;tag=4fa3
To: <sip:userA_public1@home-A.net>
Route: <sip:pcscf-vA1.visited-A.net;lr>,<sip:home-abc@scscf-hA1.home-A.net;lr;iotl=visitedA-homeA>
P-Preferred-Identity: <sip:userA_public1@home-A.net>
Contact: <sip:[5555::aaa:bbb:ccc:ddd]>
CSeq: 1 SUBSCRIBE
Event: reg
Expires: 600000
Accept: application/reginfo+xml
P-Access-Network-Info: 3GPP-E-UTRAN-TDD; utran-cell-id-3gpp=234151D0FCE11
Via: SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd];branch=z9hG4bKnashds7
Other SIP header fields are set according to 3GPP TS 24.229 [4].
Request-URI:	Set to the SIP URI that is the default public user identity of the user A i.e. userA_public1@home-A.net.
From:	Set to the SIP URI that is the default public user identity of the user A i.e. userA_public1@home-A.net.
To:	Set to the SIP URI that is the default public user identity of the user A i.e. userA_public1@home-A.net.
Route:	The UE-A builds a proper preloaded route set for the SUBSCRIBE dialog containing the IP address or the FQDN learnt through the P-CSCF discovery procedures and P-CSCF port based on the security mechanism in use. In addition the values received in the Service-Route header field saved from the 200 (OK) response to the last registration or re-registration of the public user identity with associated contact address are added. The content of the received Service-Route header filed is due to operator policy. In this example only the S-CSCF-hA1 (including traffic leg information in the ""iotl"" SIP URI parameter according to IETF RFC 7549 [26]) will be included.
P-Preferred-Identity:	Set to the SIP URI that is the default public user identity of the user A i.e. userA_public1@home-A.net.
Event:	The value of the Event header field is set to the value ""reg"" to specify the use of the registration state package.
Accept:	The value of the Accept header field is set to ""application/reginfo+xml"".
3.	SUBSCRIBE request (P-CSCF-vA1 to IBCF-vA1) – see example in table 5.2.3.2-3.
When the P-CSCF-vA1 receives the SUBSCRIBE request and the P-CSCF-vA1 verifies that the resulting list of Route header fields matches the list of URIs received in the Service-Route header field (during the last successful registration or re-registration). This verification is done on a per URI basis, not as a whole string.
The P-CSCF-vA1 selects an IBCF (IBCF-vA1) to be the exit IBCF towards the home network hA and sends the SUBSCRIBE request according to 3GPP TS 24.229 [4] to IBCF-vA1.
Table 5.2.3.2-3: SUBSCRIBE request (P-CSCF-vA1 to IBCF-vA1)
SUBSCRIBE sip:userA_public1@home-A.net SIP/2.0
From:
To:
P-Asserted-Identity: <sip:userA_public1@home-A.net>
Route: <sip:ibcf-vA1.visited-A.net;lr>,<sip:home-abc@scscf-hA1.home-A.net;lr;iotl=visitedA-homeA>
Record-Route: <sip:pcscf-vA1.visited-A.net;lr>
Contact:
CSeq:
Event:
Expires:
Accept:
P-Access-Network-Info: 3GPP-E-UTRAN-TDD;utran-cell-id-3gpp=234151D0FCE11,
3GPP-E-UTRAN-TDD; utran-cell-id-3gpp=234151D0FCE11;
network-provided;local-time-zone=""UTC+01:00"";daylight-saving-time=""01""
P-Charging-Vector: icid-value=""AyretyU0dm+6O2IrT5tAFrbHLso=023551024"";orig-ioi=""Type 1visited-a""
Via: SIP/2.0/UDP pcscf-vA1.visited-A.net:5060;branch=z9hG4bKnas56565
Via: SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd];branch=z9hG4bKnashds7
Other SIP header fields are set according to 3GPP TS 24.229 [4].
P-Asserted-Identity:	The value is set to the default public user identity i.e. userA_public1@home-A.net.
P-Charging-Vector:	The P-CSCF-vA1 adds the P-Charging-Vector header field containing a new ICID value in the ""icid"" header field parameter and an ""orig-ioi"" header field parameter. The IOI value is of type 1 and identifies the visited network vA (i.e. visited-a).
P-Access-Network-Info:	The P-CSCF adds a network provided location and daylight saving information. If the received P-Access-Network-Info header field doesn't indicate that it is a network provided location, the P-Access-Network-Info header field containing the location provided by the UE-A is kept in the INVITE request.
Route:	The P-CSCF adds a Route header field identifying the selected IBCF-vA1.
Record-Route:	The P-CSCF adds a Record-Route header field.
Via:	The P-CSCF adds a Via header field.
4.	SUBSCRIBE request (IBCF-vA1 to IC-A1) – see example in table 5.2.3.2-4.
When the IBCF-vA1 receives the SUBSCRIBE request the IBCF-vA1 selects, based on local policy, to route the SUBSCRIBE request via IC network A and sends the SUBSCRIBE request according to 3GPP TS 24.229 [4] to the IC-A1. The IBCF-vA1 determines the next hop IP address from the URI in the first Route header field entry either by configured information or using a DNS query according to IETF RFC 3263 [13]. If the subsequent interconnection network is SIP-aware, the determined IP address will belong to the SIP proxy IC-A1. Otherwise the determined IP address will point to IBCF-hA1 and step 5 is skipped (not reflected in message details below).
Table 5.2.3.2-4: SUBSCRIBE request (IBCF-vA1 to IC-A1)
SUBSCRIBE sip:userA_public1@home-A.net SIP/2.0
From:
To:
P-Asserted-Identity:
Route: <sip:ic-A1.interconnection-A.net;lr>,<sip:home-abc@scscf-hA1.home-A.net;lr;iotl=visitedA-homeA>
Record-Route:<sip:ibcf-vA1.visited-A.net;lr>,<sip:pcscf-vA1.visited-A.net;lr>
Contact:
CSeq:
Event:
Expires:
Accept:
P-Access-Network-Info:
P-Charging-Vector:
Via: SIP/2.0/UDP ibcf-vA1.visited-A.net;branch=z9hG4bK351g45.1
Via: SIP/2.0/UDP pcscf-vA1.visited-A.net:5060;branch=z9hG4bKnas56565
Via: SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd];branch=z9hG4bKnashds7
Other SIP header fields are set according to 3GPP TS 24.229 [4].
Route:	The IBCF-vA1 adds a Route header field identifying the selected node in the IC network A.
Record-Route:	Based on topology hiding functionality the IBCF-vA1 will either forward the Record-Route header field with:
-	one visible IBCF-vA1 entry and the remaining collected entries as one hidden entry; or
-	an IBCF-vA1 entry and whole content of already collected entries as visible entries.
Via:	Based on topology hiding functionality the IBCF-vA1 will either forward the Via header field with:
-	one visible IBCF-vA1 entry and the remaining collected entries as one hidden entry; or
-	an IBCF-vA1 entry and whole content of already collected entries as visible entries.
5.	SUBSCRIBE request (IC-A1 to IBCF-hA1) – see example in table 5.2.3.2-5.
NOTE 1:	If the interconnection network is SIP-unaware, step 5 is skipped (not reflected in message details below).
When the IC-A1 receives the SUBSCRIBE request the IC-A1 selects an entry point (IBCF-hA1) of the home network hA and sends the SUBSCRIBE request according to 3GPP TS 24.229 [4] to the IBCF-hA1.
The IC-A1 can add a Route header field pointing to the entry point of the home network hA. This is shown in the example in table 5.2.3-5.
Table 5.2.3.2-5: SUBSCRIBE request (IC-A1 to IBCF-hA1)
SUBSCRIBE sip:userA_public1@home-A.net SIP/2.0
From:
To:
P-Asserted-Identity:
Route: <sip:ibcf-hA1.home-A.net;lr>,<sip:home-abc@scscf-hA1.home-A.net;lr;iotl=visitedA-homeA>
Record-Route: <sip:ic-A1.interconnection-A.net;lr>,<sip:ibcf-vA1.visited-A.net;lr>,<sip:pcscf-vA1.visited-A.net;lr>
Contact:
CSeq:
Event:
Expires:
Accept:
P-Access-Network-Info:
P-Charging-Vector: icid-value=""AyretyU0dm+6O2IrT5tAFrbHLso=023551024"";orig-ioi=""Type 1visited-a"";transit-ioi=""ICa.1""
Via: SIP/2.0/UDP ic-A1.interconnection-A.net;branch=z9hG4bK351g45.2
Via: SIP/2.0/UDP ibcf-vA1.visited-A.net;branch=z9hG4bK351g45.1
Via: SIP/2.0/UDP pcscf-vA1.visited-A.net:5060;branch=z9hG4bKnas56565
Via: SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd];branch=z9hG4bKnashds7
Other SIP header fields are set according to 3GPP TS 24.229 [4].
P-Charging-Vector:	The IC-A1 adds the ""transit-ioi"" header field parameter identifying the interconnection network (i.e. ICa.1).
Route:	The IC-A1 adds a Route header field identifying the selected entry point in the home network hA.
Record-Route:	Based on interconnection operator SLA the IC-A1 adds an entry to the Record-Route header field or not.
Via:	The IC-A1 adds a Via header field.
6.	SUBSCRIBE request (IBCF-hA1 to S-CSCF-hA1) – see example in table 5.2.3.2-6.
When the IBCF-hA1 receives the SUBSCRIBE request the IBCF-hA1 sends the SUBSCRIBE request according to 3GPP TS 24.229 [4] to the S-CSCF-hA1.
In this example, the IBCF-hA1 does not add any ""transit-ioi"" header field parameter in the P-Charging-Vector header field. However, the IBCF-hA1 adds the ""transit-ioi"" header field parameter based on local policy, when the ""transit-ioi"" identifying the preceding interconnection network is not included in the received request (e.g. when the preceding interconnection network is not an IMS transit network).
Table 5.2.3.2-6: SUBSCRIBE request (IBCF-hA1 to S-CSCF-hA1)
SUBSCRIBE sip:userA_public1@home-A.net SIP/2.0
From:
To:
P-Asserted-Identity:
Route: <sip:home-abc@scscf-hA1.home-A.net;lr;iotl=visitedA-homeA>
Record-Route: <sip:ibcf-hA1.home-A.net:5070;lr>,<sip:ic-A1.interconnection-A.net;lr>,<sip:ibcf-vA1.visited-A.net;lr>,<sip:pcscf-vA1.visited-A.net;lr>
Contact:
CSeq:
Event:
Expires:
Accept:
P-Access-Network-Info:
P-Charging-Vector:
Via: SIP/2.0/UDP ibcf-hA1.home-A.net;branch=z9hG4bK351g45.3
Via: SIP/2.0/UDP ic-A1.interconnection-A.net;branch=z9hG4bK351g45.2
Via: SIP/2.0/UDP ibcf-vA1.visited-A.net;branch=z9hG4bK351g45.1
Via: SIP/2.0/UDP pcscf-vA1.visited-A.net:5060;branch=z9hG4bKnas56565
Via: SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd];branch=z9hG4bKnashds7
Other SIP header fields are set according to 3GPP TS 24.229 [4].
Via:	The IBCF-hA1 adds a Via header field.
Record-Route:	The IBCF-hA1 adds a Record-Route header field.
7-11.	200 (OK) response (S-CSCF-hA1 to UE-A).
The S-CSCF-hA1 acknowledges a successful subscription to the registration-state event package where:
-	the S-CSCF-hA1 includes a P-Charging-Vector header field containing the same ICID value and ""orig-ioi"" header field parameter as received in the SUBSCRIBE request. In addition the S-CSCF-hA1 adds the ""term-ioi"" header field parameter with the IOI value set to a value identifying the home network A (i.e. home-a).
-	the IC-A1 adds to the P-Charging-Vector header field the ""transit-ioi"" set to a value identifying the interconnection network (i.e. ICa.1).
NOTE 2:	If the interconnection network is SIP-unaware, step 9 is skipped.
12.	NOTIFY request (S-CSCF-hA1 to IBCF-hA1) – see example in table 5.2.3.2-12.
The S-CSCF-hA1 immediately after sending the 200 (OK) to the SUBSCRIBE request sends a NOTIFY request containing the registration-state event package in an application/reginfo+xml MIME body.
The NOTIFY request is sent along the path created by the routes received in the Record-Route header field.
Table 5.2.3.2-12: NOTIFY request (S-CSCF-hA1 to IBCF-hA1)
NOTIFY sip:[5555::aaa:bbb:ccc:ddd] SIP/2.0
To:<sip:userA_public1@home-A.net>
From:<sip:userA_public1@home-A.net>;tag=3fa5
Route:<sip:ibcf-hA1.home-A.net;lr>,<sip:ic-A1.interconnection-A.net;lr>,<sip:ibcf-vA1.visited-A.net;lr>,<sip:pcscf-vA1.visited-A.net;lr>
Call-ID:cb03a0s09a2sdfglkj490333
CSeq:25 NOTIFY
Contact:sip:[5555::aaa:ccc:eee:aaa]
Event:reg
Subscription-State:active;expires=600000
P-Charging-Vector:icid-value=""AyretyU0dm+6O2IrT5tAFrbHLso=45678901"";orig-ioi=""Type 1home-a""
Via: SIP/2.0/UDP scscf-hA1.home-A.net;branch=z9hG4bK23456.1
Content-Type:application/reginfo+xml
Content-Length:(…)
For an example of the content of the SDP application/reginfo+xml see 3GPP TS 24.229 [4] subclause 5.4.2.1.2.
Other SIP header fields are set according to 3GPP TS 24.229 [4].
Request-URI:	The S-CSCF-hA1 uses the contact address of the UE received during registration as the Request-URI.
Route:	The routes in the Record-Route header field are used as the route set.
Event:	The S-CSCF-hA1 adds the Event header field containing the ""reg"" value.
Subscription-State:	The S-CSCF-hA1 adds the Subscription-State header field set to ""active"" and indicates the expiration time in the ""expires"" header field parameter.
P-Charging-Vector:	The S-CSCF-hA1 adds the P-Charging-Vector header field containing a new ICID value and the ""ioi-orig"" header field parameter set to a type 1 IOI value (i.e. home-A).
Via:	The S-CSCF-hA1 adds a Via header field.
Content-Type:	The S-CSCF-hA1 sets the value of the Content-Type header field to ""application/reginfo+xml"".
13.	NOTIFY request (IBCF-hA1 to IC-A1) – see example in table 5.2.3.2-13.
The IBCF-hA1 sends the NOTIFY request according to 3GPP TS 24.229 [4] to the IC-A1.
NOTE 3:	If the subsequent interconnection network is SIP-unaware, the IBCF-hA1 sends the NOTIFY request according to 3GPP TS 24.229 [4] to the IBCF-vA1 (not reflected in message details below).
Table 5.2.3.2-13: NOTIFY request (IBCF-hA1 to IC-A1)
NOTIFY sip:[5555::aaa:bbb:ccc:ddd] SIP/2.0
To:
From:
Route:<sip:ic-A1.interconnection-A.net;lr>,<sip:ibcf-vA1.visited-A.net;lr>,<sip:pcscf-vA1.visited-A.net;lr>
Record-Route: <sip:ibcf-hA1.home-A.net:5070;lr>
Call-ID:
CSeq:
Contact:
Event:
Subscription-State:
P-Charging-Vector:
Via:SIP/2.0/UDP ibcf-hA1.home-A.net;branch=z9hG4bK23456.2
Via:SIP/2.0/UDP scscf-hA1.home-A.net;branch=z9hG4bK23456.1
Content-Type:
Content-Length: (…)
For an example of the content of the SDP application/reginfo+xml see 3GPP TS 24.229 [4] subclause 5.4.2.1.2.
Other SIP header fields are set according to 3GPP TS 24.229 [4].
Record-Route:	The IBCF-hA1 adds a Record-Route header field.
Via:	Based on topology hiding functionality the IBCF-hA1 will either forward the Via header field with:
-	one visible IBCF-hA1 entry and the remaining collected entries as one hidden entry; or
-	an IBCF-hA1 entry and whole content of already collected entries as visible entries.
14.	NOTIFY request (IC-A1 to IBCF-vA1) – see example in table 5.2.3.2-14.
NOTE 4:	If the interconnection network is SIP-unaware, step 14 is skipped (not reflected in message details below).
The IC-A1 sends the NOTIFY request according to 3GPP TS 24.229 [4] to the IBCF-vA1.
Table 5.2.3.2-14: NOTIFY request (IC-A1 to IBCF-vA1)
NOTIFY sip:[5555::aaa:bbb:ccc:ddd] SIP/2.0
To:
From:
Route:<sip:ibcf-vA1.visited-A.net;lr>,<sip:pcscf-vA1.visited-A.net;lr>
Record-Route: <sip:ic-A1.interconnection-A.net;lr>,<sip:ibcf-hA1.home-A.net:5070;lr>
Call-ID:
CSeq:
Contact:
Event:
Subscription-State:
P-Charging-Vector: icid-value=""AyretyU0dm+6O2IrT5tAFrbHLso=45678901"";orig-ioi=""Type 1home-a"";transit-ioi=""ICa.1""
Via: SIP/2.0/UDP ic-A1.interconnection-A.net;branch=z9hG4bK23456.3
Via: SIP/2.0/UDP ibcf-hA1.home-A.net;branch=z9hG4bK23456.2
Via: SIP/2.0/UDP scscf-hA1.home-A.net;branch=z9hG4bK23456.1
Content-Type:
Content-Length: (…)
For an example of the content of the SDP application/reginfo+xml see 3GPP TS 24.229 [4] subclause 5.4.2.1.2.
Other SIP header fields are set according to 3GPP TS 24.229 [4].
P-Charging-Vector:	The IC-A1 adds the ""transit-ioi"" header field parameter identifying the interconnection network (i.e. ICa.1).
Record-Route:	The IC-A1 adds a Record-Route header field.
Via:	The IC-A1 adds a Via header field.
15.	NOTIFY request (IBCF-vA1 to P-CSCF-vA1) – see example in table 5.2.3.2-15.
The IBCF-vA1 sends the NOTIFY request according to 3GPP TS 24.229 [4] to the P-CSCF-vA1.
In this example, the IBCF-vA1 does not add any ""transit-ioi"" header field parameter in the P-Charging-Vector header field. However, the IBCF-vA1 adds the ""transit-ioi"" header field parameter based on local policy, when the ""transit-ioi"" identifying the preceding interconnection network is not included in the received request (e.g. when the preceding interconnection network is not an IMS transit network).
Table 5.2.3.2-15: NOTIFY request (IBCF-vA1 to P-CSCF-vA1)
NOTIFY sip:[5555::aaa:bbb:ccc:ddd] SIP/2.0
To:
From:
Route:<sip:pcscf-vA1.visited-A.net;lr>
Record-Route:<sip:ibcf-vA1.visited-A.net:5070;lr>,<sip:ic-A1.interconnection-A.net;lr>,<sip:ibcf-hA1.home-A.net:5070;lr>
Call-ID:
CSeq:
Contact:
Event:
Subscription-State:
P-Charging-Vector:
Via: SIP/2.0/UDP ibcf-vA1.visited-A.net;branch=z9hG4bK23456.4
Via: SIP/2.0/UDP ic-A1.interconnection-A.net;branch=z9hG4bK23456.3
Via: SIP/2.0/UDP ibcf-hA1.home-A.net;branch=z9hG4bK23456.2
Via: SIP/2.0/UDP scscf-hA1.home-A.net;branch=z9hG4bK23456.1
Content-Type:
Content-Length: (…)
For an example of the content of the SDP application/reginfo+xml see 3GPP TS 24.229 [4] subclause 5.4.2.1.2.
Other SIP header fields are set according to 3GPP TS 24.229 [4].
Record-Route:	The IBCF-vA1 adds a Record-Route header field.
Via:	The IBCF-vA1 adds a Via header field.
16.	NOTIFY request (P-CSCF-vA1 to UE-A) – see example in table 5.2.3.2-16.
The P-CSCF-vA1 removes the protocol elements that cannot be sent to outside the trust domain (e.g. the P-Charging-Vector) and sends the NOTIFY request according to 3GPP TS 24.229 [4] to the UE-A.
Table 5.2.3.2-16: NOTIFY request (P-CSCF-vA1 to UE-A)
NOTIFY sip:[5555::aaa:bbb:ccc:ddd] SIP/2.0
To:
From:
Record-Route:<sip:p-cscf-vA1.visited-A.net:5070;lr>,<sip:ibcf-vA1.visited-A.net:5070;lr>,<sip:ic-A1.interconnection-A.net;lr>,<sip:ibcf-hA1.home-A.net:5070;lr>
Call-ID:
CSeq:
Contact:
Event:
Subscription-State:
Via: SIP/2.0/UDP pcscf-vA1.visited-A.net;branch=z9hG4bK23456.5
Via: SIP/2.0/UDP ibcf-vA1.visited-A.net;branch=z9hG4bK23456.4
Via: SIP/2.0/UDP ic-A1.interconnection-A.net;branch=z9hG4bK23456.3
Via: SIP/2.0/UDP ibcf-hA1.home-A.net;branch=z9hG4bK23456.2
Via: SIP/2.0/UDP scscf-hA1.home-A.net;branch=z9hG4bK23456.1
Content-Type:
Content-Length: (…)
For an example of the content of the SDP application/reginfo+xml see 3GPP TS 24.229 [4] subclause 5.4.2.1.2.
Other SIP header fields are set according to 3GPP TS 24.229 [4].
Record-Route:	The P-CSCF-vA1 adds a Record-Route header field.
Via:	The P-CSCF-vA1 adds a Via header field.
17-21.	200 (OK) response (UE-A to S-CSCF-hA1).
The UE-A acknowledges the receipt of the NOTIFY request where:
-	the P-CSCF-vA1 includes a P-Charging-Vector header field containing the same ICID value and ""orig-ioi"" header field parameter as received in the NOTIFY request. In addition the P-CSCF-vA1 adds the ""term-ioi"" header field parameter with the IOI value set to a value identifying the visited network A (i.e. visited-a).
-	the IC-A1 adds to the P-Charging-Vector header field the ""transit-ioi"" set to a value identifying the interconnection network (i.e. ICa.1).
NOTE 5:	If the interconnection network is SIP-unaware, step 20 is skipped.",TR 29.949,5.2.3.2,all_images/image_1082.png,Subscription to the registration-state event package by the UE-A
"After that the registration in clause 5.2.2 is successfully completed the P-CSCF-vA1 subscribes to the registration-state event package as described in 3GPP TS 24.229 [4] clause 5.2.3.
The information received in the registration-state event package can be used by the P-CSCF to determine if a registration is still valid.
Figure 5.2.3.3-1 shows how the P-CSCF-vA1 sends the SUBSCRIBE request without using the registration path hence it will appear as the SUBSCRIBE request is sent between two home networks.
Figure 5.2.3.3-1:	Subscription to the registration-state event package by the P-CSCF-vA1
The steps of the flow are as follows:
1.	The UE successfully registers as described in clause 5.2.2.
2.	SUBSCRIBE request (P-CSCF-vA1 to IBCF-vA1) - see example in table 5.2.3.3-2.
When the registration is successfully completed, i.e. the 200 (OK) to the REGISTER request sent is to the UE-A) the P-CSCF-vA1 subscribes to the registration-state event package in the home network hA.
The P-CSCF-vA1 selects an IBCF (IBCF-vA1) to be the IBCF acting as the exit point towards the home network hA and forwards a SUBSCRIBE request according to 3GPP TS 24.229 [4] to the IBCF-vA1.
Table 5.2.3.3-2: SUBSCRIBE request (P-CSCF-vA1 to IBCF-vA1)
SUBSCRIBE sip:userA_public1@home-A.net;iotl=visitedA-homeA SIP/2.0
From:<sip:p-cscf@visited-A.net>;tag=4ea2
To:<sip:userA_public1@home-A.net>
P-Asserted-Identity: <sip:visit-xyz@pcscf-vA1.visited-A.net>
Route: <sip:ibcf-vA1.visited-A.net;lr>
Contact:<sip:[5555::ddd:aaa:ccc:bbb]>
CSeq: 36 SUBSCRIBE
Event:reg
Expires:600000
Accept:application/reginfo+xml
P-Access-Network-Info:3GPP-E-UTRAN-TDD; utran-cell-id-3gpp=234151D0FCE11;network-provided;local-time-zone=""UTC+01:00"";daylight-saving-time=""01""
P-Charging-Vector: icid-value=""AyretyU0dm+6O2IrT5tAFrbHLso=5467327"";orig-ioi=""Type 1visited-a""
Via: SIP/2.0/UDP [5555::ddd:aaa:ccc:bbb];branch=z9hG4bKnas12baad
Other SIP header fields are set according to 3GPP TS 24.229 [4].
Request-URI:	Set to the default public user identity of the user, i.e. userA_public1@home-A.net. P-CSCF appends traffic leg information in the ""iotl"" SIP URI parameter according to IETF RFC 7549 [26].
From:	Set to the P-CSCF's SIP URI.
To:	Set to the SIP URI that is the default public user identity of the user i.e. userA_public1@home-A.net.
P-Asserted-Identity:	Set to the value of the received ""+g.3gpp.thig-path"" Feature-Caps header field parameter if the received 200 (OK) response to the REGISTER request contained a ""+g.3gpp.thig-path"" Feature-Caps header field parameter or otherwise, as shown in this example, to the SIP URI of the P-CSCF, which was inserted into the Path header field during the registration of the user to whose registration state the P-CSCF subscribes to.
Event:	The value of the Event header field is set to the value ""reg"" to specify the use of the registration state package.
Accept:	The value of the Accept header field is set to ""application/reginfo+xml"".
P-Access-Network-Info:	The P-CSCF adds the P-Access-Network-Info header field with a network provided location and daylight saving information.
P-Charging-Vector:	The P-CSCF-vA1 includes an ICID value and a type 1 ""orig-ioi"" header field parameter. The P-CSCF-vA1 shall set the type 1 ""orig-ioi"" header field parameter to a value that identifies the sending network of the request (i.e. visited-A).
3.	SUBSCRIBE request (IBCF-vA1 to IC-A1) - see example in table 5.2.3.3-3.
When the IBCF-vA1 receives the SUBSCRIBE request the IBCF-vA1 selects, based on local policy, to route the SUBSCRIBE request via IC network A and sends the SUBSCRIBE request according to 3GPP TS 24.229 [4] to the IC-A1. The IBCF-vA1 determines the next hop IP address from the URI in the first entry of the Route header field either by configured information or using a DNS query according to IETF RFC 3263 [13]. If the subsequent interconnection network is SIP-aware, the determined IP address will belong to the SIP proxy IC-A1. Otherwise the determined IP address will point to IBCF-hA1 and step 4 is skipped (not reflected in message details below).
Table 5.2.3.3-3: SUBSCRIBE request (IBCF-vA1 to IC-A1)
SUBSCRIBE sip:userA_public1@home-A.net;iotl=visitedA-homeA SIP/2.0
From:
To:
P-Asserted-Identity:
Route: <sip:ic-A1.interconnection-A.net;lr>
Record-Route:<sip:ibcf-vA1.visited-A.net;lr>
Contact:
CSeq:
Event:
Expires:
Accept:
P-Access-Network-Info:
P-Charging-Vector:
Via: SIP/2.0/UDP ibcf-vA1.visited-A.net;branch=z9hG4bKnas12baad.1
Via: SIP/2.0/UDP [5555::ddd:aaa:ccc:bbb];branch=z9hG4bKnas12baad
Other SIP header fields are set according to 3GPP TS 24.229 [4].
Route:	The IBCF-vA1 adds a Route header field identifying the selected node in the IC network A.
Record-Route:	The IBCF-vA1 adds a Record-Route header field.
Via:	Based on topology hiding functionality the IBCF-vA1 will either forward the Via header field with:
-	one visible IBCF-vA1 entry and the remaining collected entries as one hidden entry; or
-	one IBCF-vA1 entry and the whole content of already collected entries as visible entries.
4.	SUBSCRIBE request (IC-A1 - to IBCF-hA1) - see example in table 5.2.3.3-4.
NOTE 1:	If the interconnection network is SIP-unaware, step 4 is skipped (not reflected in message details below).
The IC-A1 selects an entry point (IBCF-hA1) of the home network hA and sends the SUBSCRIBE request according to 3GPP TS 24.229 [4] to the IBCF-hA1.
The IC-A1 may add a Route header field entry pointing to the entry point of home network hA. This is shown in example in table 5.3.3.3-4.
Table 5.2.3.3-4: SUBSCRIBE request (IC-A1 - to IBCF-hA1)
SUBSCRIBE sip:userA_public1@home-A.net;iotl=visitedA-homeA SIP/2.0
From:
To:
P-Asserted-Identity:
Route: <sip:ibcf-hA1.home-A.net;lr>
Record-Route:<sip:ic-A1.interconnection-A.net;lr>,<sip:ibcf-vA1.visited-A.net;lr>
Contact:
CSeq:
Event:
Expires:
Accept:
P-Charging-Vector: icid-value=""AyretyU0dm+6O2IrT5tAFrbHLso=5467327"";orig-ioi=""Type 1visited-a"";transit-ioi=""ICa.1""
P-Charging-Vector:
Via: SIP/2.0/UDP ic-A1.interconnection-A.net;branch=z9hG4bKnas12baad.2
Via: SIP/2.0/UDP ibcf-vA1.visited-A.net;branch=z9hG4bKnas12baad.1
Via: SIP/2.0/UDP [5555::ddd:aaa:ccc:bbb];branch=z9hG4bKnas12baad
Other SIP header fields are set according to 3GPP TS 24.229 [4].
P-Charging-Vector:	The IC-A1 adds the ""transit-ioi"" header field parameter identifying the interconnection network (i.e. ICa.1).
Route:	The IC-A1 adds a Route header field identifying the selected entry point in the home network hA.
Record-Route:	Based on interconnection operator SLA the IC-A1 adds an entry to the Record-Route header field or not.
Via:	The IC-A1 adds a Via header field.
5.	SUBSCRIBE request (IBCF-hA1 to I-CSCF-hA1) - see example in table 5.2.3.3-5.
The IBCF-hA1 receives the SUBSCRIBE request and analyses the request line and the request to the I-CSCF-hA1. The IBCF-hA1 adds a Route header field with the address of the I-CSCF-hA1 of the home network of user A.
In this example, the IBCF-hA1 does not add any ""transit-ioi"" header field parameter in the P-Charging-Vector header field. However, the IBCF-hA1 adds the ""transit-ioi"" header field parameter based on local policy, when the ""transit-ioi"" identifying the preceding interconnection network is not included in the received request (e.g. when the preceding interconnection network is not an IMS transit network).
Table 5.2.3.3-5: SUBSCRIBE request (IBCF-hA1 to I-CSCF-hA1)
SUBSCRIBE sip:userA_public1@home-A.net;iotl=visitedA-homeA SIP/2.0
From:
To:
P-Asserted-Identity:
Route: <sip:icscf-hA1.home-A.net;lr>
Record-Route:<sip:ibcf-hA1.home-A.net;lr>,<sip:ic-A1.interconnection-A.net;lr>,<sip:ibcf-vA1.visited-A.net;lr>
Contact:
CSeq:
Event:
Expires:
Accept:
P-Access-Network-Info:
P-Charging-Vector:
Via: SIP/2.0/UDP ibcf-hA1.home-A.net;branch=z9hG4bKnas12baad.3
Via: SIP/2.0/UDP ic-A1.interconnection-A.net;branch=z9hG4bKnas12baad.2
Via: SIP/2.0/UDP ibcf-vA1.visited-A.net;branch=z9hG4bKnas12baad.1
Via: SIP/2.0/UDP [5555::ddd:aaa:ccc:bbb];branch=z9hG4bKnas12baad
Other SIP header fields are set according to 3GPP TS 24.229 [4].
Via:	The IBCF-hA1 adds a Via header field.
Route:	The IBCF-hA1 adds a Route header field with the address of the I-CSCF-hA1 of the home network of user A.
Record-Route:	The IBCF-hA1 adds a Record-Route header field.
6.	SUBSCRIBE request (I-CSCF-hA1 to S-CSCF-hA1) - see example in table 5.2.3.3-6.
The I-CSCF-hA1 receives the SUBSCRIBE request and makes a request for information related to the subscriber registration status by sending the public user identity and visited domain name to the HSS. The HSS returns the S-CSCF address.
Due to the fact that the I-CSCF-hA1 only identifies the home S-CSCF which is responsible for the roaming user A, the I-CSCF-hA1 is not needed for future requests to be kept in the path, thus an I-CSCF entry is not needed within the Record-Route header field.
But for the response to the SUBCRIBE request the I-CSCF-hA1 has to be added in the Via header field.
Table 5.2.3.3-6: SUBSCRIBE request (I-CSCF-hA1 to S-CSCF-hA1)
SUBSCRIBE sip:userA_public1@home-A.net;iotl=visitedA-homeA SIP/2.0
From:
To:
P-Asserted-Identity:
Route: <sip:home-abc@scscf-hA1.home-A.net;lr>
Record-Route:<sip:ibcf-hA1.home-A.net;lr>,<sip:ic-A1.interconnection-A.net;lr>,<sip:ibcf-vA1.visited-A.net;lr>
Contact:
CSeq:
Event:
Expires:
Accept:
P-Access-Network-Info:
P-Charging-Vector:
Via: SIP/2.0/UDP icscf-hA1.home-A.net;branch=z9hG4bKnas12baad.4
Via: SIP/2.0/UDP ibcf-hA1.home-A.net;branch=z9hG4bKnas12baad.3
Via: SIP/2.0/UDP ic-A1.interconnection-A.net;branch=z9hG4bKnas12baad.2
Via: SIP/2.0/UDP ibcf-vA1.visited-A.net;branch=z9hG4bKnas12baad.1
Via: SIP/2.0/UDP [5555::ddd:aaa:ccc:bbb];branch=z9hG4bKnas12baad
Other SIP header fields are set according to 3GPP TS 24.229 [4].
Route:	The I-CSCF-hA1 adds the address of the selected S-CSCF.
Via:	The I-CSCF-hA1 adds a Via header field.
7-11.	200 (OK) response (S-CSCF to P-CSCF-vA1).
The S-CSCF-hA1 acknowledges a successful subscription to the registration-state event package where:
-	the S-CSCF-hA1 includes a P-Charging-Vector header field containing the ICID value and ""orig-ioi"" header field parameter as received in the SUBSCRIBE request. In addition the S-CSCF-hA1 adds the ""term-ioi"" header field parameter with the IOI value set to a value identifying the home network A (i.e. home-a); and
-	the IC-A1 adds to the P-Charging-Vector header field the ""transit-ioi"" set to a value identifying the interconnection network (i.e. ""ICa.1"").
NOTE 2:	If the interconnection network is SIP-unaware, step 10 is skipped.
12.	NOTIFY request (S-CSCF-hA1 to IBCF-hA1) - see example in table 5.2.3.3-12.
The S-CSCF-hA1 immediately after sending the 200 (OK) to the SUBSCRIBE request sends a NOTIFY request containing the registration-state event package in an application/reginfo+xml MIME body.
The NOTIFY request is sent along the path created by the routes received in the Record-Route header field.
Table 5.2.3.3-12: NOTIFY request (S-CSCF-hA1 to IBCF-hA1)
NOTIFY sip:[5555::ddd:aaa:ccc:bbb] SIP/2.0
To:<sip:visit-xyz@pcscf-vA1.visited-A.net>;tag=4ea2
From:<sip:userA_public1@home-A.net>;tag=3e1f
Route:<sip:ibcf-hA1.home-A.net;lr>,<sip:ic-A1.interconnection-A.net;lr>,<sip:ibcf-vA1.visited-A.net;lr>
CSeq:35 NOTIFY
Contact:<sip:[5555::aaa:ccc:eee:aaa]>
Event:reg
Subscription-State:active;expires=600000
P-Charging-Vector:icid-value=""AyretyU0dm+6O2IrT5tAFrbHLso=45678901"";orig-ioi=""Type 1home-a""
Via: SIP/2.0/UDP [5555::aaa:ccc:eee:aaa];branch=z9hG4bK23456
Content-Type:application/reginfo+xml
Content-Length:(…)
For an example of the content of the SDP application/reginfo+xml see 3GPP TS 24.229 [4] subclause 5.4.2.1.2.
Other SIP header fields are set according to 3GPP TS 24.229 [4].
Request-URI:	Set to the contact address of the P-CSCF-vA1.
Route:	The routes in the Record-Route header field are used as the route set.
Event:	The S-CSCF-hA1 adds the Event header field containing the ""reg"" value.
Subscription-State:	The S-CSCF-hA1 adds the Subscription-State header field set to ""active"" and indicates the expiration time in the ""expires"" header field parameter.
P-Charging-Vector:	A new ICID value (i.e. different from the ICID value in the SUBSCRIBE request) and a type 1 ""orig-ioi"" header field parameter. The S-CSCF-hA1 shall set the type 1 ""orig-ioi"" header field parameter to a value that identifies the sending network of the request (i.e. home-A).
Via:	The S-CSCF-hA1 adds a Via header field.
Content-Type:	The S-CSCF-hA1 sets the value of the Content-Type header field to ""application/reginfo+xml"".
13.	NOTIFY request (IBCF-hA1 to IC-A1) - see example in table 5.2.3.3-13.
The IBCF-hA1 sends the NOTIFY request according to 3GPP TS 24.229 [4] to the IC-A1.
NOTE 3:	If the subsequent interconnection network is SIP-unaware, the IBCF-hA1 sends the NOTIFY request according to 3GPP TS 24.229 [4] to the IBCF-vA1 (not reflected in message details below).
Table 5.2.3.3-13: NOTIFY request (IBCF-hA1 to IC-A1)
NOTIFY sip:[5555::ddd:aaa:ccc:bbb] SIP/2.0
To:
From:
Route:<sip:ic-A1.interconnection-A.net;lr>,<sip:ibcf-vA1.visited-A.net;lr>
Record-Route:<sip:ibcf-hA1.home-A.net:5070:lr>
CSeq:
Contact:
Event:
Subscription-State:
P-Charging-Vector:
Via: SIP/2.0/UDP ibcf-hA1.home-A.net;branch=z9hG4bK23456.1
Via: SIP/2.0/UDP [5555::aaa:ccc:eee:aaa];branch=z9hG4bK23456
Content-Type:
Content-Length:(…)
For an example of the content of the SDP application/reginfo+xml see 3GPP TS 24.229 [4] subclause 5.4.2.1.2.
Other SIP header fields are set according to 3GPP TS 24.229 [4].
Record-Route:	The IBCF-hA1 adds a Record-Route header field.
Via:	Based on topology hiding functionality the IBCF-hA1 will either forward the Via header field with:
-	one visible IBCF-hA1 entry and the remaining collected entries as one hidden entry; or
-	one IBCF-hA1 entry and the whole content of already collected entries as visible entries.
14.	NOTIFY request (IC-A1 to IBCF-vA1) - see example in table 5.2.3.3-14.
NOTE 4:	If the interconnection network is SIP-unaware, step 14 is skipped (not reflected in message details below).
The IC-A1 sends the NOTIFY request according to 3GPP TS 24.229 [4] to the IBCF-vA1.
Table 5.2.3.3-14: NOTIFY request (IC-A1 to IBCF-vA1)
NOTIFY sip:[5555::ddd:aaa:ccc:bbb] SIP/2.0
To:
From:
Route:<sip:ibcf-vA1.visited-A.net;lr>
Record-Route:<sip:ic-A1.interconnection-A.net;lr>,<sip:ibcf-hA1.home-A.net:5070:lr>
CSeq:
Contact:
Event:
Subscription-State:
P-Charging-Vector:icid-value=""AyretyU0dm+6O2IrT5tAFrbHLso=45678901"";orig-ioi=""Type 1home-a"";transit-ioi=""ICa.1""
Via: SIP/2.0/UDP ic-A1.interconnection-A.net;branch=z9hG4bK23456.2
Via: SIP/2.0/UDP ibcf-hA1.home-A.net;branch=z9hG4bK23456.1
Via: SIP/2.0/UDP [5555::aaa:ccc:eee:aaa];branch=z9hG4bK23456
Content-Type:
Content-Length:(…)
For an example of the content of the SDP application/reginfo+xml see 3GPP TS 24.229 [4] subclause 5.4.2.1.2.
Other SIP header fields are set according to 3GPP TS 24.229 [4].
P-Charging-Vector:	The IC-A1 adds the ""transit-ioi"" header field parameter identifying the interconnection network (i.e. ICa.1).
Record-Route:	Based on interconnection operator SLA the IC-A1 adds an entry to the Record-Route header field or not.
Via:	The IC-A1 adds a Via header field.
15.	NOTIFY request (IBCF-vA1 to P-CSCF-vA1) - see example in table 5.2.3.3-15.
The IBCF-vA1 sends the NOTIFY request according to 3GPP TS 24.229 [4] to the P-CSCF-vA1.
In this example, the IBCF-vA1 does not add any ""transit-ioi"" header field parameter in the P-Charging-Vector header field. However, the IBCF-vA1 adds the ""transit-ioi"" header field parameter based on local policy, when the ""transit-ioi"" identifying the preceding interconnection network is not included in the received request (e.g. when the preceding interconnection network is not an IMS transit network).
Table 5.2.3.3-15: NOTIFY request (IBCF-vA1 to P-CSCF-vA1)
NOTIFY sip:[5555::ddd:aaa:ccc:bbb] SIP/2.0
To:
From:
Record-Route:<sip:ibcf-vA1.visited-A.net;lr>,<sip:ic-A1.interconnection-A.net;lr>,<sip:ibcf-hA1.home-A.net:5070:lr>
CSeq:
Contact:
Event:
Subscription-State:
P-Charging-Vector:
Via: SIP/2.0/UDP ibcf-vA1.visited-A.net;branch=z9hG4bK23456.3
Via: SIP/2.0/UDP ic-A1.interconnection-A.net;branch=z9hG4bK23456.2
Via: SIP/2.0/UDP ibcf-hA1.home-A.net;branch=z9hG4bK23456.1
Via: SIP/2.0/UDP [5555::aaa:ccc:eee:aaa];branch=z9hG4bK23456
Content-Type:
Content-Length:(…)
For an example of the content of the SDP application/reginfo+xml see 3GPP TS 24.229 [4] subclause 5.4.2.1.2.
Other SIP header fields are set according to 3GPP TS 24.229 [4].
Record-Route:	The IBCF-vA1 adds a Record-Route header field entry.
Via:	The IBCF-vA1 adds a Via header field.
16-19.	200 (OK) response (P-CSCF-vA1 to S-CSCF-hA1).
The P-CSCF-vA1 acknowledges the receipt of the NOTIFY request where:
-	the P-CSCF-vA1 includes a P-Charging-Vector header field containing the ICID value and ""orig-ioi"" header field parameter as received in the NOTIFY request. In addition the P-CSCF-vA1 adds the ""term-ioi"" header field parameter with the IOI value set to a value identifying the visited network A (i.e. visited-a); and
-	the IC-A1 adds to the P-Charging-Vector header field the ""transit-ioi"" set to a value identifying the interconnection network (i.e. ICa.1).
NOTE 5:	If the interconnection network is SIP-unaware, step 18 is skipped.",TR 29.949,5.2.3.3,all_images/image_1083.png,Subscription to the registration-state event package by the P-CSCF-vA1
"This clause describes routeing from the terminating home network to the terminating visited network including the traversal of transit network between the terminating home network and the terminating visited network.
Preconditions:
-	The UE-A is registered as described in clause 5.2.
-	In the originating side the call can be routed either as a call without loopback as described in clause 5.3 or with loopback as described in clause 5.4.
-	The coding examples assume that the originating network, the interconnection network and the terminating network are within the trust domain.
Figure 5.9-1: Mobile terminating call from terminating home network to terminating visited network
The steps of the flow are as follows:
1.	INVITE request (IBCF-hA2 to I-CSCF-hA1) - see example in table 5.9-1.
An initial INVITE request is received by the IBCF-hA2. Due to bilateral agreement all relevant SIP header fields are included. The IBCF-hA2 removes any received Route header field pointing to itself and forwards the call to the I-CSCF-hA1 according to 3GPP TS 24.229 [4].
Table 5.9-1: INVITE request (IBCF-hA2 to I-CSCF-hA1)
INVITE sip:+12375551111@home-A.net;user=phone;iotl=homeA-homeB SIP/2.0
To: <tel:+12375551111>
From: < tel:+4687197378>;tag=4fa3
P-Asserted-Identity: <tel:+4687197378>,<sip:+4687197378@home-A.net;user=phone>;
P-Asserted-Service: urn:urn-7:3gpp-service.ims.icsi.mmtel
Contact: <sip:[5555::bbb:ccc:ddd:aaa]>
CSeq: 1 INVITE
Supported: 100rel,precondition
Route: <sip:icscf-hA1.home-A.net;lr>
Record-Route: <sip:ibcf-hA2.home-A.net;lr>,<ic-T1.interconnection-T.net;lr>,<One or more entries with entities of the originating network>
P-Access-Network-Info: 3GPP-E-UTRAN-TDD;utran-cell-id-3gpp=234151D0FCE22,3GPP-E-UTRAN-TDD; utran-cell-id-3gpp=234151D0FCE22;network-provided;local-time-zone=""UTC+01:00"";daylight-saving-time=""01""
P-Charging-Vector: icid-value=""AyretyU0dm+6O2IrT5tAFrbHLso=023551024"";orig-ioi=""home-r"";transit-ioi=""ICt.1""
Via: SIP/2.0/UDP ibcf-hA2.home-R.net;branch=z9hG4bK351g45.13
Via: SIP/2.0/UDP ic-T1.interconnection-T.net;branch=z9hG4bK351g45.12
Via: <One or more entries with entities of the originating network>
Other SIP header fields and SDP according to 3GPP TS 24.229 [4]
Request-URI:	Contains the destination address for the INVITE request. In this example a SIP URI with user=phone is used. It could be also a tel URI. The ""iotl"" SIP URI parameter indicates that this is call between two home networks and that the URI in the Request-URI is the destination. If the remote UE is roaming and loopback routeing is used, the ""iotl"" SIP URI parameter would be set to ""visitedA-homeB"".
Supported:	The Supported header field contains the option-tag ""100rel"" indicating support of the reliable provisional responses and the option-tag ""precondition"" indicating support of the precondition mechanism.
P-Charging-Vector:	The P-Charging-Vector contains the type 2 ""orig-ioi"" of the call which is either the remote UE's home network or the remote UE's visited network when loopback applies. In this example the ""orig-ioi"" contains the remote UE's home network. Contains the ""transit-ioi"" header field parameter identifying the interconnection network.
Contact:	The Contact header field contains in this example the IP address of the remote UE. But due to network rules it could be also the IP address a downstream B2BUA.
Route:	The IBCF-hA2 adds a Route header field which points to I-CSCF-hA1 in the home network hA.
Record-Route:	Depending on the policy of the intermediate network the content of the Record-Route header field can vary. The Record-Route header field includes all entries included in the received INVITE request plus an entry of the incoming IBCF-hA2.
Via:	The Via header field includes all entries included in the received INVITE request plus the entry of the incoming IBCF-hA2.
2.	INVITE request (I-CSCF-hA1 to S-CSCF-hA1) - see example in table 5.9-2.
When the I-CSCF-hA1 receives the initial INVITE request it queries the SLF/HSS to identify the correct S-CSCF where the call has to be routed to. Due to normal routing procedures the S-CSCF will be allocated by the HSS procedures as described in 3GPP TS 24.229 [4].
Table 5.9-2: INVITE request (I-CSCF-hA1 to S-CSCF-hA1)
INVITE tel:+12375551111 SIP/2.0
To:
From:
P-Asserted-Identity:
P-Asserted-Service:
Contact:
CSeq:
Supported:
Route: <sip:home-abc@scscf-hA1.home-A.net:5070;lr>
Record-Route: <sip:ibcf-hA2.home-A.net;lr>,<sip:ic-T1.interconnection-T.net;lr>,<One or more entries with entities of the originating network>
P-Access-Network-Info:
P-Charging-Vector:
or when loopback in the originating path apply then:
P-Charging-Vector:
Via: SIP/2.0/UDP icscf-hA1.home-A.net;branch=z9hG4bK351g45.13a
Via: SIP/2.0/UDP ibcf-hA2.home-A.net;branch=z9hG4bK351g45.13
Via: SIP/2.0/UDP ic-T1.interconnection-T.net;branch=z9hG4bK351g45.12
Via: <One or more entries with entities of the originating network>
Other SIP header fields and SDP according to 3GPP TS 24.229 [4].
Request-URI:	Contains the destination address for the INVITE request. In this case the I-CSCF-hA1 changes the URI from a SIP URI user=phone to a tel URI as described in 3GPP TS 24.229 [4].
Via:	The I-CSCF-hA1 adds a Via header field.
3.-4.	INVITE request (S-CSCF-hA1 to AS-hA1 to S-CSCF-hA1).
The S-CSCF applies the filter criteria to involve the AS for terminating services.
Record-Route:	The entries to this header field need to be added based on the related dip's to the AS. The AS could behave as B2BUA. In such case the AS could store the entries and setup a new Record-Route header field only with the AS URI as an entry. Both the AS-hA1 and the S-CSCF-hA1 adds Record-Route header fields.
P-Charging-Vector:	Towards the AS-hA1 the P-Charging-Vector header field contains the type 3 ""orig-ioi"" identifying the network of the S-CSCF-hA1 sending the request. Towards the S-CSCF-hA1 the P-Charging-Vector header field contains the type 3 ""orig-ioi"" identifying the network of the AS-hA1 sending the request.
Route:	The S-CSCF-hA1 adds a Route header field identifying the selected AS-hA1 and S-CSCF-hA1 for routing back.
Via:	Both the AS-hA1 and the S-CSCF-hA1 adds Via header fields.
Editor's note: The behaviour of the transit-ioi value is currently discussed and needs further consideration how the S-CSCF to AS correlation is describes.
5.	INVITE request (S-CSCF-hA1 to IBCF-hA1) - see example in table 5.9-5.
Since the call is a terminating call no further specific information is needed for termination of the call.
The S-CSCF-hA1 sends the INVITE request according to 3GPP TS 24.229 [4] to the IBCF-hA1.
Table 5.9-5: INVITE request (S-CSCF-hA1 to IBCF-hA1)
INVITE sip:[5555::ddd:aaa:ccc:bbb] SIP/2.0
To:
From:
P-Asserted-Identity:
P-Asserted-Service:
Contact:
CSeq:
Supported:
Route:<sip:home-abc@ibcf-hA1.home-A.net:5070;lr>,
<sip:proxy-abc@ic-A1.interconnection-A.net:5070;lr>,
<sip:visit-abc@ibcf-vA1.visited-A.net:5070;lr>,
<sip:visit-xyz@pcscf-vA1.visited-A.net:5070;lr;iotl=homeB-visitedB>
Record-Route: <sip:scscf-hA1.home-A.net;lr>,
<sip:as-hA1.home-A.net;lr>,<sip:scscf-hA1.home-A.net;lr>,
<sip:ibcf-hA2.home-A.net;lr>,<sip:ic-T1.interconnection-T.net;lr>,<One or more entries with entities of the originating network>
P-Access-Network-Info:
P-Charging-Vector: icid-value=""AyretyU0dm+6O2IrT5tAFrbHLso=023551024"";orig-ioi=""Type 1home-a""
Via: SIP/2.0/UDP scscf-hA1.home-A.net;branch=z9hG4bK351g45.16
Via: SIP/2.0/UDP as-hA1.home-A.net;branch=z9hG4bK351g45.15
Via: SIP/2.0/UDP scscf-hA1.home-A.net;branch=z9hG4bK351g45.14
Via: SIP/2.0/UDP icscf-hA1.home-A.net;branch=z9hG4bK351g45.13a
Via: SIP/2.0/UDP ibcf-hA2.home-A.net;branch=z9hG4bK351g45.13
Via: SIP/2.0/UDP ic-T1.interconnection-T.net;branch=z9hG4bK351g45.12
Via: <One or more entries with entities of the originating network>
Other SIP header fields and SDP according to 3GPP TS 24.229 [4].
Request-URI:	The S-CSCF-hA1 replaces the received tel URI with the SIP URI received in the Contact header field from the UE-A during the registration.
Route:	The S-CSCF includes a Route header field with the routeing information received in the Path header field during registration.
P-Charging-Vector:	The S-CSCF-hA1 replaces the received IOI type 3 value in the ""orig-ioi"" header field parameter with a IOI type 1 value identifying the home network of the UE-A.
Via:	The S-CSCF-hA1 adds a Via header field.
Record-Route:	The S-CSCF-hA1 adds a Record-Route header field.
6.	INVITE request (IBCF-hA1 to IC-A1) see example in table 5.9-6.
The IBCF-hA1 applies local policy which is dependent on the operator policy for roaming calls with that specific visited network and the intermediate transit network. Header fields can be deleted or anonymized.
The IBCF-hA1 selects, based on the Route header field as shown table 5.9-5 or in cases where the Path header field received during registration only points to the visited network, based on local policy, to route the INVITE request via IC network A and sends the INVITE request according to 3GPP TS 24.229 [4] to the IC-A1.
The IBCF-hA1 determines the next hop IP address from the URI in the first entry of the Route header field either by configured information or using a DNS query according to IETF RFC 3263 [13]. If the subsequent interconnection network is SIP-aware, the determined IP address will belong to the SIP proxy IC-A1. Otherwise the determined IP address will point to IBCF-vA1 and step 7 is skipped (not reflected in message details below).
The procedures apply to 3GPP TS 24.229 [4].
Table 5.9-6: INVITE request (IBCF-hA1 to IC-A1)
INVITE sip:[5555::ddd:aaa:ccc:bbb] SIP/2.0
To:
From:
P-Asserted-Identity:
P-Asserted-Service:
Contact:
CSeq:
Supported:
Route:<sip:proxy-abc@ic-A1.interconnection-A.net:5070;lr>,
<sip:visit-abc@ibcf-vA1.visited-A.net:5070;lr>,
<sip:visit-xyz@pcscf-vA1.visited-A.net:5070;lr;iotl=homeB-visitedB>
Record-Route:<sip:ibcf-hA1.home-A.net;lr>,
<sip:scscf-hA1.home-A.net;lr>,
<sip:as-hA1.home-A.net;lr>,<sip:scscf-hA1.home-A.net;lr>,
<sip:ibcf-hA2.home-A.net;lr>,<sip:ic-T1.interconnection-T.net;lr>,<One or more entries with entities of the originating network>
P-Access-Network-Info:
P-Charging-Vector:
Via: SIP/2.0/UDP ibcf-hA1.home-A.net;branch=z9hG4bK351g45.17
Via: SIP/2.0/UDP scscf-hA1.home-A.net;branch=z9hG4bK351g45.16
Via: SIP/2.0/UDP as-hA1.home-A.net;branch=z9hG4bK351g45.15
Via: SIP/2.0/UDP scscf-hA1.home-A.net;branch=z9hG4bK351g45.14
Via: SIP/2.0/UDP icscf-hA1.home-A.net;branch=z9hG4bK351g45.13a
Via: SIP/2.0/UDP ibcf-hA2.home-A.net;branch=z9hG4bK351g45.13
Via: SIP/2.0/UDP ic-T1.interconnection-T.net;branch=z9hG4bK351g45.12
Via: <One or more entries with entities of the originating network>
Other SIP header fields and SDP according to 3GPP TS 24.229 [4].
Via:	The IBCF-hA1 adds a Via header field.
Record-Route:	The IBCF-hA1 adds a Record-Route header field.
7.	INVITE request (IC-A1 to IBCF-vA1) - see example in table 5.9-7.
NOTE 1:	If the interconnection network is SIP-unaware, step 7 is skipped (not reflected in message details below).
Based on the Route header field, the IC-T1 selects an entry point (IBCF-vA1) of the visited IMS network vA and sends the INVITE request according to 3GPP TS 24.229 [4] to the IBCF-vA1.
In our example the entry point of visited network vA is already included in the received Route header field. However, the IC- A1 can add a Route header field entry pointing to the entry point of the visited network vA if the entry point is missing.
Table 5.9-7: INVITE request (IC-A1 to IBCF-vA1)
INVITE sip:[5555::ddd:aaa:ccc:bbb] SIP/2.0
To:
From:
P-Asserted-Identity:
P-Asserted-Service:
Contact:
CSeq:
Supported:
Route:<sip:visit-abc@ibcf-vA1.visited-A.net:5070;lr>,
<sip:visit-xyz@pcscf-vA1.visited-A.net:5070;lr;iotl=homeB-visitedB>
Record-Route: <sip:ic-A1.interconnection-A.net;lr>,
<sip:ibcf-hA1.home-A.net;lr>,<sip:scscf-hA1.home-A.net;lr>,
<sip:as-hA1.home-A.net;lr>,<sip:scscf-hA1.home-A.net;lr>,
<sip:ibcf-hA2.home-A.net;lr>,<ic-T1.interconnection-T.net;lr>,<One or more entries with entities of the originating network>
P-Access-Network-Info:
P-Charging-Vector: icid-value=""AyretyU0dm+6O2IrT5tAFrbHLso=023551024"";orig-ioi=""Type 1home-a"";transit-ioi=""ICa.1""
Via: SIP/2.0/UDP ic-A1.interconnection-A.net;branch=z9hG4bK351g45.18
Via: SIP/2.0/UDP ibcf-hA1.home-A.net;branch=z9hG4bK351g45.17
Via: SIP/2.0/UDP scscf-hA1.home-A.net;branch=z9hG4bK351g45.16
Via: SIP/2.0/UDP as-hA1.home-A.net;branch=z9hG4bK351g45.15
Via: SIP/2.0/UDP scscf-hA1.home-A.net;branch=z9hG4bK351g45.14
Via: SIP/2.0/UDP icscf-hA1.home-A.net;branch=z9hG4bK351g45.13a
Via: SIP/2.0/UDP ibcf-hA2.home-A.net;branch=z9hG4bK351g45.13
Via: SIP/2.0/UDP ic-T1.interconnection-T.net;branch=z9hG4bK351g45.12
Via: <One or more entries with entities of the originating network>
Other SIP header fields and SDP according to 3GPP TS 24.229 [4].
P-Charging-Vector:	The IC-A1 adds the ""transit-ioi"" header field parameter identifying the interconnection network (i.e. ICa.1).
Via:	The IC-A1 adds a Via header field (i.e. ic-A1.interconnection-A.net).
Record-Route:	The IC-A1 adds a Record-Route header field (i.e. ic-A1.interconnection-A.net).
8.	INVITE request (IBCF-vA1 to P-CSCF-vA1) - see example in table 5.9-8.
The IBCF-vA1 routes the call to the P-CSCF-vA1 as stated within the Route header field.
IBCF-vA1 applies local policy based on trust relationship with the transit network and SLA between home network carrier and visited network carrier.
If a ""transit-ioi"" header field parameter value exists within the P-Charging-Vector header field then the values can be forwarded or made void.
In this example, the IBCF-vA1 does not add any ""transit-ioi"" header field parameter in the P-Charging-Vector header field. However, the IBCF-vA1 adds the ""transit-ioi"" header field parameter based on local policy, when the ""transit-ioi"" identifying the preceding interconnection network is not included in the received request (e.g. when the preceding interconnection network is not an IMS transit network).
Table 5.9-8: INVITE request (IBCF-vA1 to P-CSCF-vA1)
INVITE sip:[5555::ddd:aaa:ccc:bbb] SIP/2.0
To:
From:
P-Asserted-Identity:
P-Asserted-Service:
Contact:
CSeq:
Supported:
Route:<sip:visit-xyz@pcscf-vA1.visited-A.net:5070;lr;iotl=homeB-visitedB>
Record-Route: <sip:ibcf-vA1.visited-A.net;lr>,<sip:ic-A1.interconnection-A.net;lr>,
<sip:ibcf-hA1.home-B.net;lr>,<sip:scscf-hA1.home-A.net;lr>,
<sip:as-hA1.home-B.net;lr>,<sip:scscf-hA1.home-A.net;lr>,
<sip:ibcf-hA2.home-A.net;lr>,
<sip:ic-T1.interconnection-T.net;lr>,
<One or more entries with entities of the originating network>
P-Access-Network-Info:
P-Charging-Vector:
Via: SIP/2.0/UDP ibcf-vA1.visited-A.net;branch=z9hG4bK351g45.19
Via: SIP/2.0/UDP ic-A1.interconnection-A.net;branch=z9hG4bK351g45.18
Via: SIP/2.0/UDP ibcf-hA2.home-A.net;branch=z9hG4bK351g45.17
Via: SIP/2.0/UDP scscf-hA1.home-A.net;branch=z9hG4bK351g45.16
Via: SIP/2.0/UDP as-hA1.home-A.net;branch=z9hG4bK351g45.15
Via: SIP/2.0/UDP scscf-hA1.home-A.net;branch=z9hG4bK351g45.14
Via: SIP/2.0/UDP icscf-hA1.home-A.net;branch=z9hG4bK351g45.13a
Via: SIP/2.0/UDP ibcf-hA2.home-A.net;branch=z9hG4bK351g45.13
Via: SIP/2.0/UDP ic-T1.interconnection-T.net;branch=z9hG4bK351g45.12
Via: <One or more entries with entities of the originating network>
Other SIP header fields and SDP according to 3GPP TS 24.229 [4].
Record-Route:	The IBCF-vA1 adds a Record-Route header field (i.e. IBCF-vA1).
Via:	The IBCF-vA1 adds a Via header field (i.e. IBCF-vA1).
9.	INVITE request (P-CSCF-vA1 to UE-A) - see example in table 5.9-9.
The P-CSCF-vA1 routes the call to the UE-A as stated within Request-URI which contains the address of the UE-A.
Based on privacy settings within the INVITE request, the P-CSCF-vA1 applies privacy according to IETF RFC 3323 [27] and IETF RFC 3325 [28].
The P-CSCF-vA1 applies trust domain according to 3GPP TS 24.229 [4] clause 4.4. This will result in that some header fields will be removed. In our example the P-Charging-Vector header field and the P-Access-Network-Info header field are removed from the outgoing INVITE request.
The P-CSCF-vA1 sends the INVITE request according to 3GPP TS 24.229 [4] to the UE-A.
Table 5.9-9: INVITE request (P-CSCF-vA1 to UE-A)
INVITE sip:[5555::ddd:aaa:ccc:bbb] SIP/2.0
To:
From:
P-Asserted-Identity:
P-Asserted-Service:
Contact:
CSeq:
Supported:
Record-Route: <sip:pcscf-vA1.visited-A.net;lr>,
<sip:ibcf-vA1.visited-A.net;lr>,<sip:ic-A1.interconnection-A.net;lr>,
<sip:ibcf-hA1.home-A.net;lr>,<sip:scscf-hA1.home-A.net;lr>,
<sip:as-hA1.home-A.net;lr>,<sip:scscf-hA1.home-A.net;lr>,
<sip:ibcf-hA2.home-A.net;lr>,
<sip:ic-T1.interconnection-T.net;lr>,
<One or more entries with entities of the originating network>
Via: SIP/2.0/UDP pcscf-vA1.visited-A.net:5060;branch=z9hG4bKnas56565
Via: SIP/2.0/UDP ibcf-vA1.visited-A.net;branch=z9hG4bK351g45.19
Via: SIP/2.0/UDP ic-A1.interconnection-A.net;branch=z9hG4bK351g45.18
Via: SIP/2.0/UDP ibcf-hA1.home-A.net;branch=z9hG4bK351g45.17
Via: SIP/2.0/UDP scscf-hA1.home-A.net;branch=z9hG4bK351g45.16
Via: SIP/2.0/UDP as-hA1.home-A.net;branch=z9hG4bK351g45.15
Via: SIP/2.0/UDP scscf-hA1.home-A.net;branch=z9hG4bK351g45.14
Via: SIP/2.0/UDP icscf-hA1.home-A.net;branch=z9hG4bK351g45.13a
Via: SIP/2.0/UDP ibcf-hA2.home-A.net;branch=z9hG4bK351g45.13
Via: SIP/2.0/UDP ic-T1.interconnection-T.net;branch=z9hG4bK351g45.12
Via: <One or more entries with entities of the originating network>
Other SIP header fields and SDP according to 3GPP TS 24.229 [4].
Via:	The P-CSCF-vA1 adds a Via header field.
Record-Route:	The P-CSCF-vA1 adds a Record-Route header field.
10-18.	183 (Session Progress) response (UE-A to IBCF-hA2 via all intermediate nodes in the Via header fields) - see example in table 5.9-10.
The UE-A sends a 183 (Session Progress) response since 100rel and preconditions are supported by the remote UE.
The routing towards the IBCF-hA2 is based on the Via header fields received by the UE-A in the initial INVITE request.
When the IBCF-hA2 receives the 183 (Session Progress) response, the IBCF-hA2 sends the 183 (Session Progress) response according to 3GPP TS 24.229 [4] towards the remote UE as described within clause 5.3 or clause 5.4 of this document and regarding the rules defined in 3GPP TS 24.229 [4].
The table 5.9-10 shows the content of the 183 (Session Progress) response when sent by IBCF-hA1.
Table 5.9-10: SIP 183 (Session Progress) response (UE-A to IBCF-hA1) in step 14
SIP/2.0 183 Session Progress
To: <tel:+12375551111>;tag=654a
From: <tel:+4687197378>;tag=4fa3
P-Asserted-Identity: <tel:+4687197378>
Contact: <sip:[5555::ddd:aaa:ccc:bbb]>
CSeq: 1 INVITE
Require:100rel,precondition
Via: SIP/2.0/UDP scscf-hA1.home-A.net;branch=z9hG4bK351g45.16
Via: SIP/2.0/UDP as-hA1.home-A.net;branch=z9hG4bK351g45.15
Via: SIP/2.0/UDP scscf-hA1.home-A.net;branch=z9hG4bK351g45.14
Via: SIP/2.0/UDP icscf-hA1.home-A.net;branch=z9hG4bK351g45.13a
Via: SIP/2.0/UDP ibcf-hA2.home-A.net;branch=z9hG4bK351g45.13
Via: SIP/2.0/UDP ic-T1.interconnection-T.net;branch=z9hG4bK351g45.12
Via: <One or more entries with entities of the originating network>
Record-Route: <sip:pcscf-vA1.visited-A.net;lr>,
<sip:ibcf-vA1.visited-A.net;lr>,<sip:ic-A1.interconnection-A.net;lr>,
<sip:ibcf-hA2.home-A.net;lr>,<sip:scscf-hA1.home-A.net;lr>,
<sip:as-hA1.home-A.net;lr>,<sip:scscf-hA1.home-A.net;lr>,
<sip:ibcf-hA2.home-A.net;lr>,<sip:ic-T1.interconnection-T.net;lr>,
<One or more entries with entities of the originating network>
P-Charging-Vector: icid-value=""AyretyU0dm+6O2IrT5tAFrbHLso=023551024"";orig-ioi=""Type 1home-a"";transit-ioi=""ICa.1"";term-ioi=""Type 1visited-a""
Other SIP header fields and SDP according to 3GPP TS 24.229 [4].
Require:	The UE-A inserts the Require header field containing the option-tag ""100rel"" indicating reliable sending of the 183 (Session Progress) response and the option-tag ""precondition"" indicating the usage of the precondition mechanism.
P-Charging-Vector:	The settings of the IOI values are important:
-	in step 11 the ""term-ioi"" header field parameter includes a type 1 IOI value which identifies the visited network of the terminating user (i.e. ""visited-a""). The ""orig-ioi"" header field parameter is set to the same type 1 IOI value that was included in the initial INVITE request by the home network hA (i.e. ""home-a"") towards the terminating user;
-	in step 12 no change of ioi values;
-	in step 13-14 the ""transit-ioi"" header field parameter includes one or more values identifying the transit networks passed between the visited network A and home network A; In our example only one value identifying the interconnect network A is included. If no ""transit-ioi"" header field parameter is included in step 13, the IBCF-hA1 can include a ""transit-ioi"" header field parameter value identifying the preceding inteconnect network.
-	in step 15-16 the ""term-ioi"" header field parameter includes a type 3 IOI value (prefix ""Type 3"") which identifies the AS-hA1 network. The ""orig-ioi"" header field parameter is set to the same type 3 IOI value that was included in the initial INVITE request from the S-CSCF-hA1 to the AS-hA1, the ""transit-ioi"" is deleted by the S-CSCF based on the operator policy; and
-	in steps 17-18 the ""term-ioi"" header field parameter includes a type 2 IOI value which identifies the home network hA. The ""transit-ioi"" header field parameter is not appearing. The S-CSCF removes received ""transit-ioi"" values, the IOI Type 1 or Type 3 in ""orig-ioi"" and ""term-ioi"" header field parameters. The ""orig-ioi"" header field parameter is set to the same type 2 IOI value that was included in the initial INVITE request from the remote home network or, in case of loopback, from the remote visited network. The ""term-ioi"" header field parameter is set to a Type 2 IOI value identifying the home network A.
NOTE 2:	If the interconnection network is SIP-unaware, step 13 is skipped.
19.	PRACK requests (IBCF-hA2 to UE-A via all intermediate nodes) and SIP 200 (OK) response to the SIP PRACK request (UE-A to IBCF-hA2 via all intermediate nodes).
The PRACK request and the 200 (OK) response to the PRACK request are sent without any SDP offer/SDP answer between the IBCF-hA2 and the UE-A according to 3GPP TS 24.229 [4]. The messages are sent via all intermediate nodes with the exception of I-CSCF-hA1.
20.	UPDATE requests (IBCF-hA2 to UE-A via all intermediate nodes) and SIP 200 (OK) response to the SIP UPDATE request (UE-A to IBCF-hA2 via all intermediate nodes).
When resources are reserved in the access network of the remote UE, the IBCF-hA2 receives an UPDATE request from the remote network. The IBCF-hA2 forwards the request towards the UE-A. The messages are sent via all intermediate nodes with the exception of I-CSCF-hA1.
22-30.	180 (Ringing) response to the SIP INVITE request (UE-A to IBCF-hA2 via all intermediate nodes).
NOTE 3:	If the interconnection network is SIP-unaware, step 24 is skipped. The messages are sent via all intermediate nodes including the I-CSCF-hA1.
31.	PRACK requests (IBCF-hA2 to UE-A via all intermediate nodes) and SIP 200 (OK) response to the SIP PRACK request (UE-A to IBCF-hA2 via all intermediate nodes).
The PRACK request and the 200 (OK) response to the PRACK request are sent without any SDP offer/SDP answer between the UE-A and the IBCF-hA2 according to 3GPP TS 24.229 [4]. The messages are sent via all intermediate nodes with the exception of I-CSCF-hA1.
32-39.	200 (OK) response to the SIP INVITE request (IBCF-hA2 to UE-A).
NOTE 4:	If the interconnection network is SIP-unaware, step 34 is skipped.
40-48.	ACK requests (IBCF-hA2 to UE-A via all intermediate nodes).
The IBCF-hA2 receives an ACK request which acknowledges the 200 (OK) final response, from the remote network. The IBCF-hA2 forwards the ACK request to the UE-A according to 3GPP TS 24.229 [4].
NOTE 5:	If the interconnection network is SIP-unaware, step 46 is skipped.",TR 29.949,5.9,all_images/image_1086.png,Mobile terminating call from terminating home network to terminating visited network
"Figure 5.10.2-1: Announcement started during the establishment of a communication
The calling party initiates a communication by means of an INVITE request. The INVITE request is forwarded toward the called party.
Along the signalling path, created by the INVITE request, some service logic in an application server (AS) wants to send an announcement towards the calling party.
The flow is based on the assumptions that the Supported header field includes the option-tag ""100rel"", option-tag ""precondition"" and option-tag ""199"" indicating support of the reliable provisional responses, the precondition mechanism and the 199 (Early Dialog Terminated) provisional responses, respectively.
NOTE 1:	If precondition mechanism is used, the procedures according to 3GPP TS 24.229 [4] apply.
The steps of the signalling flow are as follows:
1-5.	INVITE request (UE-A to S-CSCF-hA1 via P-CSCF-vA1, IBCF-vA1, IC-A1 and IBCF-hA1).
The INVITE request is sent as described within clause 5.4.2.
NOTE 2:	Upon generating an initial INVITE request using the precondition mechanism, the UE-A will indicate the support for the precondition mechanism and specify it using the Supported header field mechanism. If the desired QoS resources have not been reserved at the UE-A when constructing the SDP offer, the UE-A will indicate the related local preconditions for QoS as not met.
NOTE 3:	If the interconnection network is SIP-unaware, step 4 is skipped.
6.	Evaluation of initial filter criteria.
The S-CSCF-hA1 validates the service profile of this subscriber and evaluates the initial filter criteria. For this example, assume an application server/MRFC involvement.
7.	INVITE request (S-CSCF-hA1 to AS-hA1 /MRFC) - see example in table 5.3.2-6.
The S-CSCF-hA1 applies the same procedure as in step 6 in clause 5.3.2.
8.	Service logic in AS-hA1 /MRFC.
Service logic in the AS-hA1 decides to send an announcement to the calling party. In such a case the AS-hA1 acts as a B2BUA. Thus an early dialog for the announcement and two dialogs will be created in the final call state one from UE-A to the AS-hA1 and one from the AS-hA1 to the terminating UE which allows end-to-end communication.
9.	MRFC-MRFP interaction.
The MRFC interacts with the MRFP in order to reserve resources for the announcement. As part of the interaction with MRFP the AS-hA1 receives the necessary media parameters e.g. IP address and port numbers and provide the IP address and port number for the calling party to the MRFP.
10-15.	183 (Session Progress) response (AS-hA1 to UE-A via S-CSCF-hA1, IBCF-hA1, IC-A1, IBCF-vA1 and P-CSCF-vA1).
The AS-hA1 sends a 183 (Session progress) response to S-CSCF-hA1. The response includes:
a)	an answer to the SDP received in the INVITE request;
NOTE 4:	The AS-hA1 will include in the 183 (Session progress) response the Require header field with the option-tag ""100rel"" to indicate reliable sending of the 183 (Session Progress) response. If precondition mechanism is used, the AS-hA1 will include in the SDP answer an indication that the related local preconditions for QoS are fulfilled and will include in the Require header field the option-tag ""precondition"" to indicate the usage of the precondition mechanism.
b)	a P-Early-Media header field set to ""sendonly"" in case where only announcement will be played. For invoking an interactive voice response system a P-Early-Media header field is set to ""sendrecv""; and
c)	the Require header field set to ""100rel"".
NOTE 5:	If the interconnection network is SIP-unaware, step 13 is skipped.
16.	PRACK request /200 (OK) response to the PRACK request (UE-A to AS-hA1 / AS-hA1 to UE-A).
NOTE 6:	If precondition mechanism is used and the UE-A indicated in the initial SDP offer the related local preconditions for QoS as not met the UE-A will include in the SDP offer sent within the PRACK request an indication that the local preconditions for QoS are fulfilled. Otherwise, if local preconditions for QoS are not fulfilled when sending the PRACK request, the UE-A will use the UPDATE request to send the SDP offer indicating that the local preconditions for QoS are fulfilled, but that case is outside the scope of the present example.
17.	MRFC-MRFP interaction to start the announcement.
The MRFC interacts with the MRFP in order to start the announcement.
18.	Announcement sending (MRFP-hA to UE-A).
The MRFP sends the announcement towards the calling party.
19.	MRFC-MRFP interaction to stop the announcement.
The complete announcement is sent and the MRFP interacts with the AS-hA1/MRFC in order to inform that the announcement is terminated.
20.	MRFC-MRFP interaction to release the resources used for the announcement.
The MRFC interacts with the MRFP in order to release the resources used for the announcement.
21-26.	199 (Early Dialog Terminated) response (AS-hA1 to UE-A via S-CSCF-hA1, IBCF-hA1, IC-A1, IBCF-vA1 and P-CSCF-vA1) (optional).
If the originating UE-A has indicated support of the 199 (Early Dialog Terminated) response code, the AS-hA1 sends a 199 (Early Dialog Terminated) provisional response towards the originating UE-A to terminate the early dialog between itself and the UE-A.
NOTE 7:	If the interconnection network is SIP-unaware, step 24 is skipped.
27.	INVITE request (AS-hA1 to S-CSCF-hA1).
The AS-hA1 sends the INVITE request towards the S-CSCF-hA1. The INVITE request contains the same information as the INVITE request shown in table 5.4.2.-7, see step 7 in clause 5.4.2.
28-33.	INVITE request (S-CSCF-hA1 to IC-T1 via IBCF-hA1, IC-A1, IBCF-vA1, TRF-vA1 and IBCF-vA1).
The S-CSCF-hA1 decides to loopback the INVITE request and forwards the call to the terminating home network via the originating visited network vA.
The SDP contained within the INVITE will be manipulated along the signalling path as shown in the example in 3GPP TS 29.079 [5] clause A.6.
NOTE 8:	If the interconnection network is SIP-unaware, step 30 is skipped and step 33 is executed between IBCF-vA1 and IBCF-hB instead.
34.	180 (Ringing) response /200 (OK) response to the INVITE request / ACK request (IC-T1 to UE-A via IBCF-vA1, TRF-vA1, IBCF-vA1, IC-A1, IBCF-hA1, S-CSCF-hA1, AS-hA1, S-CSCF-hA1, IBCF-hA1, IC-A1, IBCF-vA1 and P-CSCF-vA1).
When the UE-A of the calling party receives the 200 (OK) response to the INVITE request and optional steps 21- 26 were not performed, the UE-A can regard the early dialog created for the announcement between the UE-A and the AS-hA1 as terminated. The UE-A sends the ACK request to acknowledge the reception of the 200 (OK) final response to the INVITE request.
NOTE 9:	The loopback-indicaton header field parameter is included in the P-Charging-Vector header field.",TR 29.949,5.10.2,all_images/image_1087.png,Announcement started during the establishment of a communication
"This clause describes the PS to CS SRVCC access transfer of a call in the active phase.
Preconditions to this call flow:
1.	a call is established between a UE-A and a remote UE as described in clause 5.3. The UE-A is attached to a 4G radio access network (E-UTRAN);
2.	media is anchored in:
a.	the P-CSCF-vA1, the ATCF-vA1 and IBCF-vA1 in the visited network vA;
b.	the IC-A1 in the IC network A; and
c.	the IBCF-hA1 and the IBCF-hA2 in the home network hA; and
3.	SIP signalling is anchored in SCC AS-hA1.
NOTE 1:	The signalling flow is the same for PS to CS SRVCC access transfer for a call in the active phase regardless if the UE-A or the remote UE initiated the call.
Figure 5.11.3-1 shows the SIP message flow when PS to CS SRVCC access transfer of a call in the active phase occurs.
NOTE:	For clarity, the SIP 100 (Trying) messages are not shown in the signalling flow.
Figure 5.11.3-1: SRVCC without loop back message flow
The steps of the flow are as follows:
1.	A call is established as described in clause 5.3 between UE-A and a remote UE.
-	The remote UE can be a UE connected to IMS or an UE connected to CS and the difference compared to the description in clause 5.3 and this PS to CS SRVCC access transfer scenario is that an ATCF in the visited originated network participated in the call establishment of the call and that the general AS-hA1 in figure 5.3.2-1 is replaced by the access transfer specific AS i.e. the SCC AS-hA1.
-	The media path is UE-A – P-CSCF-vA1 – ATCF-vA1 – IBCF-vA1 – IC-A1 – IBCF-hA1 – IBCF-hA2 – remote network – remote UE.
NOTE 2:	If the interconnection network is SIP-unaware, or if IC-A1 is only a SIP proxy rather than a SIP-ALG with attached SIP-AGW, IC-A1 is not in the media path.
2.	SRVCC handover occurs.
During the ongoing call the UE-A is performing measurements on signalling strength in neighbouring cells and sends continuously the measurement results to the core network. Due to decreasing signalling strength in the 4G radio access network the core network takes a decision that the UE shall be handed over to a 3G radio access network and sends a PS to CS SRVCC request to the MSC server-vA1.
3.	INVITE request due to STN-SR (MSC server-vA1 to ATCF-vA1) - see example in table 5.11.3-3.
-	When the MSC server-vA1 receives the PS to CS SRVCC request from the core network in the visited network, the MSC server-vA1 sends an INVITE request to the ATCF-vA1. This INVITE request is referred to as an ""INVITE request due to STN-SR"" in the 3GPP TS 24.237 [20].
Table 5.11.3-3: INVITE request due to STN-SR (MSC server-vA1 to ATCF-vA1)
INVITE tel:+1-237-555-3333 SIP/2.0
From: <tel:+1-237-555-1111>;tag=171828
To: <tel:+1-237-555-3333>
P-Asserted-Identity: <tel:+1-237-555-1111>
P-Access-Network-Info: 3GPP-UTRAN-TDD;utran-cell-id-3gpp=151234D0EAF22;network-provided;local-time-zone=""UTC+01:10"";daylight-saving-time=""01""
P-Charging-Vector: icid-value=""023551024""; orig-ioi=""Type 1visited-a"";icid-generated-at=""msc-vA1.visited-A.net""
Contact: <sip: msc-vA1.visited-A.net:1357>;+g.3gpp.icsi-ref=""urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel"";+g.3gpp.srvcc-alerting;+g.3gpp.mid-call;+ps2cs-srvss-orig-pre-alerting
CSeq: 11 INVITE
Accept: ""application/vnd.3gpp.state-and-event-info+xml""
Recv-Info: g.3gpp.state-and-event
Supported:norefersub,100rel, precondition
Via:SIP/2.0/UDP msc-vA1.visited-A.net;branch=z9hG4bk7987fe
Other SIP header fields and SDP according to 3GPP TS 24.229 [4] and 3GPP TS 24.237 [20].
Request-URI /To:	The tel URI (referred to as STN-SR) identifies the ATCF-vA1. The STN-SR is stored by SCC AS-hA1 in HSS during registration of the user as described in clause 5.11.2 and sent to the MSC server-vA1 in the PS to CS SRVCC request from the core network.
P-Access-Network-Info:	This header field identifies the location of the UE in the 3G access network, the time-zone and daylight saving on that location.
P-Charging-Vector:	The MSC server-vA1 adds the P-Charging-Vector header field containing a new ICID value in the ""icid"", ""icid-generated-at"" and ""orig-ioi"" header field parameters. The IOI value is of type 1 and identifies the visited network vA.
P-Asserted-Identity/From:	The P-Asserted identity and the From header fields is the C-MSISDN and that is not necessary the same identity used in the original call. For example: In the original call the P-Asserted-Identity header field could be adam@homenetwork.net.
Contact:	The Contact header field can, additional to the contact address, include a number of media feature tags. In this example the g.3gpp.icsi-ref indicates that this is an MMTel call, the g.3gpp.srvcc-alerting indicates that the MSC server-vA1 supports PS to CS access transfer for call in alerting phase, the g.3gpp.mid-call indicates that the MSC server-vA1 supports transfer of held calls and conference calls and the ps2cs-srvss-orig-pre-alerting indicates that the MSC server-vA1 supports PS to CS SRVCC access transfer for calls in the originating pre-alerting phase. The media-feature tags will be used by the SCC AS-vA1 to determine which sessions to be transferred.
Accept:	The MSC server-vA1 adds an Accept header field containing the MIME type application/vnd.3gpp.state-and-event-info+xml.
Recv-Info:	The MSC server-vA1 adds a Recv-Info header field containing the g.3gpp.state-and-event package name.
Supported:	The MSC server indicates option tags to indicate supported feature.
4.	200 (OK) response (ATCF-vA1 to MSC server-vA1) – see example in table 5.11.3-4.
When the ATCF-vA1 receives the INVITE due to STN-SR the ATCF-vA1 checks if there is a session that fulfils conditions for being transferred and detects that there is a call in an active phase ongoing between UE-A and a remote UE. To avoid speech gaps, the ATCF-vA1 returns a 200 (OK) response towards the MSC server-vA1 containing media parameters retrieved from the ATGW.
The ATCF-vA1 also adds the ""related-icid"" header field parameter containing the ""icid-value"" header fields parameter used in the original call and can be used for charging correlation of generated CDR records in the visited network A (i.e. ""visited-a"").
Table 5.11.3-4: 200 (OK) response (ATCF-vA1 to MSC server-vA1)
SIP/2.0 200 OK
From: <tel:+12375551111>;tag=171828
To: <tel:+12375553333>;tag=271818
Record-Route: <sip:atcf-vA1.visited-A.net:5070;lr>
P-Charging-Vector: icid-value=""023551024"";icid-generated-at=""msc-vA1.visited-A.net"";orig-ioi=""Type 1visited-a"";term-ioi=""Type 1home-a"";related-icid=""AyretyU0dm+6O2IrT5tAFrbHLso=023551024""
Feature-Caps:*;+g.3gpp.srvcc-alerting,*;+g.3gpp.mid-call,*;+ps2cs-srvss-orig-pre-alerting
Contact: <sip:[5555::bbb:ccc:ddd:aaa]>
CSeq: 11 INVITE
P-Asserted-Identity: <tel:+4687197378>,<sip:+4687197378@home-R.net;user=phone>
Via: SIP/2.0/UDP msc-vA1.visited-A.net;branch=z9hG4bk7987fe
Other SIP header fields and SDP according to 3GPP TS 24.229 [4] and 3GPP TS 24.237 [20].
Record-Route:	The ATCF adds its own address in the header field which will be used by the MSC server-vA1 for subsequent SIP requests.
P-Charging-Vector:	The P-Charging-Vector contains the parameters received in the INVITE due to STN-SR and the related-icid header field parameter containing the ICID value received in the session to be transferred.
Editor's note:	Whether the P-Charging-Vector shall contain term-ioi and/or transit-ioi or not is FFS. At the moment the term-ioi and transit-ioi is not currently specified in 3GPP TS 24.237 [20].
Feature-Caps:	The feature-capability indicators as received on the home leg in the session to be transferred.
Contact:	The contact address of the remote UE is included.
P-Asserted-Identity:	The public user identity of the remote UE is included.
5.	ACK request (MSC-vA1 to ATCF-vA1).
The MSC server-vA1 sends the ACK to the ATCF-vA1 according to 3GPP TS 24.229 [4]. The ACK request does not contain any SRVCC specific information.
6.	INVITE request due to ATU-STI (ATCF-vA1 to IBCF-vA1) - see example in table 5.11.3-6.
The ATCF-vA1 creates a new dialog towards SCC AS-hA1 by sending an INVITE due to ATU-STI. Everything except the Request line and the Via header field is copied from the received INVITE due to STN-SR.
Table 5.11.3-6: INVITE request due to ATU-STI (ATCF-vA1 to IBCF-vA1)
INVITE sip:ps2cs@sccas1.home-A.net;iotl=visitedA-homeA SIP/2.0
From: <tel:+12375551111>;tag=171828
To: <tel:+12375553333>
Route: <sip:ibcf-vA1.visited-A.net;lr>
P-Asserted-Identity: <tel:+12375551111>
P-Access-Network-Info: 3GPP-UTRAN-TDD;utran-cell-id-3gpp=151234D0EAF22;network-provided;
local-time-zone=""UTC+01:10"";daylight-saving-time=""01""
P-Charging-Vector: icid-value=""023551024""; orig-ioi=""Type 1visited-a"";
icid-generated-at=""msc-vA1.visited-A.net""
Record-Route: <sip:atcf-vA1.visited-A.net:5070;lr>
Contact: <sip:msc-vA1.visited-A1net:1357>;+g.3gpp.icsi-ref=""urn%3Aurn-7%3A3gpp-service.ims.icsi.mmtel"";+g.3gpp.srvcc-alerting;+g.3gpp.mid-call;+ps2cs-srvss-orig-pre-alerting
CSeq: 11 INVITE
Accept: ""application/vnd.3gpp.state-and-event-info+xml""
Recv-Info: g.3gpp.state-and-event
Target-Dialog: me03a0s09a2sdfgjkl491777; remote-tag=774321; local-tag=4fa3
Required: tdialog
Supported:norefersub
Via: SIP/2.0/UDP atcf-vA1.visited-A.net;branch=z9hG4bk731b87
Other SIP header fields and SDP according to 3GPP TS 24.229 [4] and 3GPP TS 24.237 [20].
Request-URI:	The SIP URI (referred to as ATU-STI) identifies the SCC AS-hA1. The ATU-STI is sent by SCC AS-hA1 to ATCF-vA1 during registration as described in clause 5.11.2. The Request-URI includes traffic information in an ""iotl"" SIP URI parameter according to IETF RFC 7549 [26].
Record-Route:	The address that the ATCF-vA1 wants to receive subsequent in-dialog requests from the SCC AS-hA1.
Target-Dialog:	The identity of the dialog selected by ATCF-vA1.
Required:	The ""tdialog"" option tag indicates that the support for Target-Dialog header field is required.
Via:	The ATCF-vA1 adds a Via header field.
7.	INVITE request due to ATU-STI (IBCF-vA1 to IC-A1) - see example in table 5.11.3-7.
When the IBCF-vA1 receives the INVITE due to ATU-STI, the IBCF-vA1 updates the SDP as described within 3GPP TS 29.079 [5].
The IBCF-vA1 selects, based on local policy, to route the INVITE request due to ATU-STI via interconnect network A and sends the request according to 3GPP TS 24.229 [4] to the IC-A1. The IBCF-vA1 determines the next hop IP address from the SIP request URI, either by configured information or using a DNS query according to IETF RFC 3263 [13]. If the subsequent interconnection network is SIP-aware, the determined IP address will belong to the SIP proxy IC-A1. Otherwise the determined IP address will point to IBCF-vA1 and step 22 is skipped (not reflected in message details below).
Table 5.11.3-7: INVITE request due to ATU-STI (IBCF-vA1 to IC-A1)
INVITE sip:ps2cs@sccas1.home-A.net;iotl=visitedA-homeA SIP/2.0
From:
To:
Route: <sip:ic-A1.interconnection-A.net;lr>
P-Access-Network-Info:
P-Charging-Vector:
Record-Route: <sip:ibcf-vA1.visited-A.net;lr>,<sip:atcf-vA1.visited-A.net:5070;lr>
P-Asserted-Identity:
Contact:
CSeq:
Accept:
Recv-Info:
Target-Dialog:
Require:
Supported:
Via: SIP/2.0/UDP ibcf-vA1.visited-A.net;branch=z9hG4bk79c54a
Via: SIP/2.0/UDP atcf-vA1.visited-A.net;branch=z9hG4bk7987fe
Other SIP headerfields and SDP according to 3GPP TS 24.229 [4] and 3GPP TS 29.079 [5].
Record-Route:	Based on topology hiding functionality the IBCF-vA1 will either forward the Record-Route header field with:
-	one visible IBCF-vA1 entry and the ATCF-vA1 entry as one hidden entry; or
-	both the IBCF-vA1 entry and the ATCF-vA1 entry as visible entries.
Via:	Based on topology hiding functionality the IBCF-vA1 will either forward the Via header fields with:
-	one visible IBCF-vA1 entry and the ATCF-vA1 entry as one hidden entry; or
-	both the IBCF-vA1 entry and the ATCF-vA1 entry as visible entries.
NOTE 3:	In the example above both the IBCF-vA1 entry and the ATCF-vA1 entry are forwarded as visible entries in the Via and Record-Route header fields.
8.	INVITE request due to ATU-STI (IC-A1 to IBCF-hA1) - see example in table 5.11.3-8.
NOTE 4:	If the interconnection network is SIP-unaware, step 8 is skipped.
When the IC-A1 receives the initial INVITE request due to ATU-STI and since the IC-A1 according to local policy allows itself to be bypassed by media then the IC-A1 updates the SDP as described within 3GPP TS 29.079 [5].
The IC-A1 selects an entry point (IBCF-hA1) of the home IMS network hA and sends the INVITE request according to 3GPP TS 24.229 [4] to the IBCF-hA1.
NOTE 5:	The IC-A1 can add a Route header field entry pointing to the entry point of home network hA. However, since this is not necessary for routeing the call it is not shown in table 5.11.3-8.
Table 5.11.3-8: INVITE request due to ATU-STI (IC-A1 to IBCF-hA1)
INVITE sip:ps2cs@sccas1.home-A.net;iotl=visitedA-homeA SIP/2.0
From:
To:
P-Access-Network-Info:
P-Charging-Vector: icid-value=""023551024"";orig-ioi=""Type 1visited-a"";
icid-generated-at=""msc-vA1.visited-A.net"";transit-ioi=""ICa.1""
Target-Dialog:
Require:
Record-Route: <sip:ic-A1.interconnection-A.net;lr>,<sip:ibcf-vA1.visited-A.net;lr>,
<sip:atcf-vA1.visited-A.net:5070;lr>
P-Asserted-Identity:
Contact:
CSeq:
Accept:
Recv-Info:
Supported:
Via: SIP/2.0/UDP ic-A1.interconnection-A.net;branch=z9hG4bk73eb11
Via: SIP/2.0/UDP ibcf-vA1.visited-A.net;branch=z9hG4bk79c54a
Via: SIP/2.0/UDP atcf-vA1.visited-A.net;branch=z9hG4bk7987fe
Other SIP header fields and SDP according to 3GPP TS 24.229 [4] and 3GPP TS 29.079 [5].
P-Charging-Vector:	The IC-A1 adds the ""transit-ioi"" header field parameter with an IOI value identifying the transit network (i.e. ""ICa"").
Record-Route:	Based on interconnection operator SLA the IC-A1 adds an entry to the Record-Route header field or not.
Via:	The IC-A1 adds a Via header field.
9.	INVITE request due to ATU-STI (IBCF-hA1 to SCC AS-hA1 via I-CSCF) - see example in table 5.11.3-9.
When the IBCF-hA1 receives the INVITE request due to ATU-STI the IBCF-hA1 updates the SDP as described in 3GPP TS 29.079 [5].
Since there is no Route header field guiding the IBCF-hA1 where to route the call the IBCF-hA1 selects an I-CSCF in the home network and sends the INVITE request due to ATU-STI to the selected I-CSCF according to 3GPP TS 24.229 [4].
In this example, the IBCF-hA1 does not add any ""transit-ioi"" header field parameter in the P-Charging-Vector header field. However, the IBCF-hA1 adds the ""transit-ioi"" header field parameter based on local policy, when the ""transit-ioi"" identifying the preceding interconnection network is not included in the received request (e.g. when the preceding interconnection network is not an IMS transit network).
The I-CSCF uses PSI routeing to route the call and sends the INVITE request due to ATU-STI directly to SCC AS-hA1.
The table 5.11.3.9 shows the content of the INVITE request due to ATU-STI when received in the SCC AS-hA1.
Table 5.11.3-9: INVITE request due to ATU-STI (IBCF-hA1 to SCC AS-hA1 via I-CSCF)
INVITE sip:ps2cs@sccas1.home-A.net;iotl=visitedA-homeA SIP/2.0
From:
To:
P-Access-Network-Info:
P-Charging-Vector:
Target-Dialog:
Require:
Record-Route: <sip:ibcf-hA1.home-A.net;lr>,<sip:ic-A1.interconnection-A.net;lr>,
<sip:ibcf-vA1.visited-A.net;lr>,<sip:atcf-vA1.visited-A.net:5070;lr>
P-Asserted-Identity:
Contact:
CSeq:
Accept:
Recv-Info:
Supported:
Via: SIP/2.0/UDP icscf-hA1.home-A.net;branch=z9hG4bk7e75ca1
Via: SIP/2.0/UDP ibcf-hA1.home-A.net;branch=z9hG4bk769aff3
Via: SIP/2.0/UDP ic-A1.interconnection-A.net;branch=z9hG4bk73eb11
Via: SIP/2.0/UDP ibcf-vA1.visited-A.net;branch=z9hG4bk79c54a
Via: SIP/2.0/UDP atcf-vA1.visited-A.net;branch=z9hG4bk7987fe
Other SIP header fields and SDP according to 3GPP TS 24.229 [4], 3GPP TS 24.237 [20] and 3GPP TS 29.079 [5].
Record-Route:	The IBCF-hA1 adds a Record-Route header field.
Via:	The IBCF-hA1 adds a Via header field.
The I-CSCF-hA1 adds a Via header field.
10.	INVITE request (SCC AS-hA1 to S-CSCF-hA1) - see example in table 5.11.3-10.
When the SCC AS-hA1 receives the INVITE request due to ATU-STI the SCC AS-hA1 compares the received SDP with the SDP negotiated in the existing session. The conclusion is that it differs so the SCC AS-hA1 needs to send a re-INVITE request towards the remote UE.
NOTE 6:	The AS can either remove the OMR attributes in the SDP or keep them depending on if the AS supports OMR and local policy. In this example the OMR attributes are removed.
NOTE 7:	When a user is roaming and media is anchored in IBCF the IP addresses will be different in the SDP received in the INVITE request due to ATU-STI compared to those negotiated in the existing session towards the remote UE and that will always result in that a re-INVITE request is needed towards the remote UE.
Table 5.11.3-10: INVITE request (SCC AS-hA1 to S-CSCF-hA1)
INVITE sip:[5555::bbb:ccc:ddd:aaa] SIP/2.0
From: <sip:userA_public1@home-A.net>;tag=4fa3
To: <tel:+4687197378>;tag=987651
CSeq: 1000 INVITE
Route: <sip:scscf-hA1.home-A.net:5070;lr>,<sip:ibcf-hA2.home-A.net:5070;lr>,<The set of routes recorded when the call was established>
Via: SIP/2.0/UDP sccas-hA1.home-A.net;branch=z9hG4bK3a4f92
Other SIP header fields and updated SDP according to 3GPP TS 24.229 [4] and 3GPP TS 24.237 [20].
Request-URI:	Set to the contact address of the remote UE.
From:	Set to the SIP URI that is the default public user identity of the user A i.e. userA_public1@home-A.net.
To:	Set to the public user identity of the remote UE.
Via:	The SCC AS-hA1 adds a Via header field.
11.	INVITE request (S-CSCF-hA1 to IBCF-hA2) - see example in table 5.11.3-11.
The S-CSCF-hA1 forwards the re-INVITE request according to procedures in 3GPP TS 24.229 [4].
Table 5.11.3-11: INVITE request (S-CSCF-hA1 to IBCF-hA2)
INVITE sip:[5555::bbb:ccc:ddd:aaa] SIP/2.0
From:
To:
CSeq:
Route: <sip:ibcf-hA2.home-A.net:5070;lr>,<The set of routes recorded when the call was established>
Via: SIP/2.0/UDP scscf-hA1.home-A.net;branch=z9hG4bK354321
Via: SIP/2.0/UDP sccas-hA1.home-A.net;branch=z9hG4bK3a4f92
Other SIP header fields and updated SDP according to 3GPP TS 24.229 [4] and 3GPP TS 24.237 [20].
Via:	The S-CSCF-hA1 adds a Via header field.
12-13.	200 (OK) response (IBCF-hA2 to SCC AS-hA1 via S-CSCF-hA1).
When the IBCF-hA2 receives the 200 (OK) response to the re-INVITE request sent towards the remote UE, the IBCF-hA2 forwards the 200 (OK) response to SCC AS-hA1 according to 3GPP TS 24.229 [4]. The 200 (OK) response does not contain any SRVCC specific information.
14-15.	ACK request (SCC AS-hA1 to IBCF-hA2 via S-CSCF-hA1).
The SCC AS-hA1 sends the ACK to the IBCF-hA2 according to 3GPP TS 24.229 [4]. The ACK request does not contain any SRVCC specific information.
16-20.	200 (OK) response (SCC AS-hA1 to ATCF-vA1 via S-CSCF-hA1, IBCF-hA1, IC-A1 and IBCF-vA1) - see example in table 5.11.3-20.
The SCC AS-hA1 uses the received SDP response and sends a 200 OK response to the INVITE request due to ATU-STI towards the ATCF-vA1.
The table 5.11.3-20 shows the content of the 200 (OK) response when received in ATCF-vA1.
Table 5.11.3-20: 200 (OK) response (IBCF-vA1 to ATCF-vA1)
SIP/2.0 200 OK
From: <tel:+1-237-555-1111>;tag=171828
To: <tel:+1-237-555-3333>;tag=828171
CSeq: 11 INVITE
Record-Route: <sip:ibcf-hA1.home-A.net;lr>,<sip:ic-A1.interconnection-A.net;lr>,
<sip:ibcf-vA1.visited-A.net;lr>,<sip:atcf-vA1.visited-A.net;lr>
P-Charging-Vector: icid-value=""023551024"";orig-ioi=""Type 1visited-a"";icid-generated-at=""msc-vA1.visited-A.net"";term-ioi=""Type 1home-a"";related-icid=""AyretyU0dm+6O2IrT5tAFrbHLso=023551024""
Via: SIP/2.0/UDP atcf-vA1.visited-A.net;branch=z9hG4bk7987fe
Other SIP header fields and SDP according to 3GPP TS 24.229 [4].
P-Charging-Vector:	The SCC AS added the P-Charging-Vector with the ""icid-value"", the ""orig-ioi"" value and the ""icid-generated-at"" as received in the INVITE due to ATU-STI. Additionally the SCC AS-hA1 added the ""related-icid"" header field parameter. The ""related-icid"" header field parameter contains the ""icid-value"" header field parameter of the original call and can be used for charging correlation of generated CDR records in the interconnect network A.
NOTE 8:	If the interconnection network is SIP-unaware, step 19 is skipped.
21-24.	ACK request (ATCF-vA1 to SCC AS-hA1 via IBCF-vA1, IC-A1, IBCF-hA1 and S-CSCF-hA1).
The ATCF-vA1 sends the ACK to the SCC AS-hA1 according to 3GPP TS 24.229 [4]. The ACK request does not contain any SRVCC specific information.
NOTE 9:	If the interconnection network is SIP-unaware, step 22 is skipped.",TR 29.949,5.11.3,all_images/image_1090.png,SRVCC without loop back message flow
"Figure 6.2.1-1: DIT Structure for UDC with alternative A
For definition of End User see 3GPP TS 32.182 [3].",TR 29.935,6.2.1,all_images/image_1093.jpeg,DIT Structure for UDC with alternative A
"In this alternative, the parent of the different domain data entities is a Subscription entity. This Subscription entity may be not limited to one user, for example, IMS data belongs to a IMS subscription that, according to TS 23.228, may be multiuser. How to support subscription with several IMS users is not described in the present clause.
It introduces privateIdentityAlias and publicIdentityAlias entities that cover Private and Public Service Identities as well as Private and Public User Identities.
Figure 6.2.2-1: DIT Structure for UDC with alternative B",TR 29.935,6.2.2,all_images/image_1094.jpeg,DIT Structure for UDC with alternative B 
"In alternative C, as for alternative B, the diagram contains Subscription, privateIdentityAlias and publicIdentityAlias entities. How to support subscription with several IMS users is not described in the present clause.
The different domains for data are organised differently. This alternative allows attributes that are applicable to several domains to be defined once. For example:
-	an attribute that is the same in the GPRS and EPS domains should be defined in the entity PS-Data
-	an attribute that is the same in the CS and PS domains should be defined in the entity Access-Data.
The compatibility with new 3GPP releases extending the use of data defined for a domain to other domains is out of the scope of the present document.
Figure 6.2.3-1: DIT Structure for UDC with alternative C",TR 29.935,6.2.3,all_images/image_1095.jpeg,DIT Structure for UDC with alternative C
"In this alternative, the parent of the different domain data entities is a Subscription entity. This Subscription entity may not limited to one user, for example, IMS data belongs to a IMS subscription that, according to 3GPP TS 23.228, may be multiuser.
The RDN of the Individual user data classes AuC-Data, CS-Data, PS-Data and EPS-Data is defined with the IMSI + svcType in order to allow for multiuser.
The Alias MSISDN class, in addition to providing a reference to the Subscription object, also contain an IMSI attribute. This is done to assist in MSISDN based message processing, such as MAP Send Routing Info. i.e., such a request would have to search for the Alias MSISDN object to obtain the subscriber's IMSI prior to obtaining the specific SvcType class associated with the IMSI.
Figure 6.2.4-1: DIT Structure for UDC with alternative D",TR 29.935,6.2.4,all_images/image_1096.jpeg,DIT Structure for UDC with alternative D 
"Figure 11.2.1-1: DIT Structure for IMS-Data with Alternative A
The dotted arrow indicates the relationship between PublicIdentity and PrivateIdentity which is expressed by the attributes PrivateIdList and PublicIdList.
The superior OCL description of the ImsData object class and some more detailed description of object classes and attributes are FFS.",TR 29.935,11.2.1,all_images/image_1097.jpeg,DIT Structure for IMS-Data with Alternative A
"Figure 11.2.2-1: DIT Structure for IMS-Data with Alternative B
CoreNet-SubscribedMediaProfileId, CoreNet-ServiceIdList and SharedFilterCriteriaSets are optional attributes in Service Profile entry.
The dotted arrow indicates the relationship between PublicIdentity and PrivateIdentity which is expressed by the attributes PrivateIdList and PublicIdList.
Multiple instances of ReferenceLocInfo (refLocInfo=xxx) is for future releases.",TR 29.935,11.2.2,all_images/image_1098.jpeg,DIT Structure for IMS-Data with Alternative B
"Figure 11.2.3-1: DIT Structure for IMS-Data with Alternative C
If an ImplicitRegistrationSet contains a PublicIdentity which is a PSI then it shall not contain any other PublicIdentity.
If an ImplicitRegistrationSet contains a single PublicIdentity, this Public Identity is not implicitly registered with any other Public Identity and therefore in stage 2 terms is not considered to belong to an Implicit Registration Set.
The concept of multiple IMS-Subscriptions within IMS-Data is not described in the present document.",TR 29.935,11.2.3,all_images/image_1099.jpeg,DIT Structure for IMS-Data with Alternative C
Figure 11.2.4-1: DIT Structure for IMS-Data with Alternative D,TR 29.935,11.2.4,all_images/image_1100.jpeg,DIT Structure for IMS-Data with Alternative D
,TS 29.556,5.2.3.2,all_images/image_1101.png,"Overview of DNS contexts, DNS rules and Baseline DNS Patterns"
,TS 29.556,5.2.3.2,all_images/image_1102.png,DNS Query processing flow in the EASDF
,TS 29.556,5.2.3.2,all_images/image_1103.png,DNS Response processing flow in the EASDF
"The 5G System Architecture is defined in 3GPP TS 23.501 [2]. The Policy and Charging related 5G architecture is also described in 3GPP TS 23.503 [4] and 3GPP TS 29.513 [5].
The Binding Support Management Service (Nbsf_Management) is exhibited by the Binding Support Function (BSF).
The known consumers of the Nbsf_Management service are:
-	Policy Control Function (PCF)
-	Network Exposure Function (NEF)
-	Application Function (AF);
-	Multicast/Broadcast Service Function (MBSF);
-	5G Direct Discovery Name Management Function (5G DDNMF);
-	Network Data Analytics Function (NWDAF); and
-	Time Sensitivy Communication and Time Synchronization Function (TSCTSF).
As described in 3GPP TS 23.503 [4], the BSF is a function that can be deployed standalone or as a functionality provided by other network functions, such as PCF, UDR, NRF, SMF.
NOTE 1:	The PCF accesses the Nbsf_Management service at the BSF via an internal interface when it is collocated with BSF.
NOTE 2:	The DRA decides to select a BSF based on user IP address range when the DRA has no binding information for the subscriber to get the relevant PCF for a PDU session address. DRA and BSF coexistence is described in 3GPP TS 29.513 [5], Annex A.
Figure 4.1.2-1: Reference Architecture for the Nbsf_Management service; SBI representation
NOTE 3:	The PCF in the figure represents both, the PCF for a UE and the PCF for a PDU session. The PCF for a UE and the PCF for a PDU session separately and independently register themselves at the BSF, regardless they are deployed in the same NF instance or separately in different NF instances.",TS 29.521,4.1.2,all_images/image_1104.jpeg,Reference Architecture for the Nbsf_Management service; SBI representation
"Figure 7.1-1: The user plane protocol stack without security protocols on the MB2-U reference point and in the EPC
Figure 7.1-1 depicts the MB2-U protocol stack without security protocols. The stack shall include:
-	User plane data, for instance an IP layer and UDP layer. The user plane data are transparently transported between the GCS AS and the UE unless the BM-SC applies FEC (see IETF RFC 6363 [31]) and/or ROHC (see IETF RFC 5795 [29] and IETF RFC 3095 [30]). The BM-SC shall forward these protocol layers transparently unless the GCS AS instructs the BM-SC to apply FEC and/or ROHC.
NOTE:	The user plane data can contain data related to several services, which are transported in the same MBMS bearer. The multiplexing protocol is transparent to the BM-SC.
-	UDP according to IETF RFC 768 [12]. UDP shall be terminated at the GCS AS and BM-SC.
-	IP transported by lower layers L1 and L2. These layers shall be terminated at the GCS AS and BM-SC.
Figure 7.1-1 also depicts the SGi-mb protocol stack defined in TS 29.061 [6] and the M1 protocol stack as defined in TS 29.274 [8] and TS 29.281 [9] for informational purposes.
The security solutions for the MB2-U reference point in Annex N.3 of TS 33.246 [10] shall apply. The MB2-U protocol stack is augmented depending on the selected security protocol:
-	If DTLS (IETF RFC 6347 [21]) is used, it resides in the MB2-U protocol stack between UDP and the user plane data as shown on Figure 7.1-2.
-	If IPSec is used without UDP encapsulation for NAT traversal, IKE (IETF RFC 5996 [17]), is transported on top of UDP during the security association establishment, and ESP (IETF RFC 4303 [20]), resides in the MB2-U protocol stack between IP and UDP, as shown on Figure 7.1-3.
-	If IPSec is used with possible UDP encapsulation for NAT traversal, IKE (IETF RFC 5996 [17]), is transported on top of UDP during the security association establishment. IKE is used according to IETF RFC 3947 [18] to negotiate if UDP encapsulating of ESP is used for NAT-Traversal. If UDP encapsulating of ESP ( IETF RFC 3948 [19]), is used, a lower IP layer, a lower UDP layer and ESP reside in the MB2-U protocol stack between L1/L2 and the IP layer shown in Figure 7.1-1; see Figure 7.1-4. Otherwise, ESP (IETF RFC 4303 [20]), resides in the MB2-U protocol stack between IP and UDP.
Figure 7.1-2: MB2-U Protocol stack with DTLS Security
Figure 7.1-3: MB2-U Protocol stack with IPSec Security without UDP encapsulation
Figure 7.1-4: MB2-U Protocol stack with IPSec Security with UDP encapsulation",TS 29.468,7.1,all_images/image_1105.jpeg,MB2-U Protocol stack with DTLS Security
The floor control server arbitration logic in the floor control server in the IWF shall behave according to the state diagram in Figure 6.3.4.1-1 and state transitions specified in this clause. The present clause is applicable for floor control of groups homed in the IWF.. Figure 6.3.4.1-1: Floor control server state transition diagram for 'general floor control operation'. The floor control arbitration logic in the floor control server shall keep one instance of the 'general floor control operation' state machine per MCPTT call.. If floor control messages or RTP media packets arrives in a state where there is no procedure specified in the following clauses the floor control arbitration logic in the IWF floor control server:. 1.	shall discard the floor control message;. 2.	shall request the media distributor in the IWF to discard any received RTP media packet; and. 3.	shall remain in the current state.. State details are explained in the following clauses.,TS 29.380,6.3.4.1,all_images/image_1107.jpeg,Floor control server state transition diagram for 'general floor control operation'
Editor's Note:	The procedures of the IWF performing the non-controlling role are FFS.. Dual floor control is used when a floor participant requests floor with a pre-emptive floor priority allowing the floor control in clause 6.3.4 to continue without revoking the floor from the floor participant permitted to send media as specified in 3GPP TS 23.379 [5] clause 10.9.1.3.2.2.. The floor control server arbitration logic in the IWF floor control server shall behave according to the state diagram and state transitions specified in this clause.. Figure 6.3.6.1-1 shows the 'dual floor control operation' states (D states) and the state transition diagram.. Figure 6.3.6.1-1: Floor control server state transition diagram for 'dual floor control operation'. The floor control arbitration logic in the IWF floor control server shall keep one instance of the 'dual floor control operation' state machine for a floor participant with pre-emptive floor priority where this MCPTT user or user homed in the IWF is allowed to talk without revoking a current speaker with lower floor priority.. NOTE:	Only one media endpoint with this type of pre-emptive floor priority can exist within an MCPTT call.. The floor participant associated to the 'dual floor control operation' state machine is in the following clauses referred to as the overriding media endpoint.. If floor control messages or RTP media packets arrive in a state where there is no procedure specified in the following clauses the floor control arbitration logic in the IWF floor control server:. 1.	shall discard the floor control message;. 2.	shall request the media distributor in the IWF to discard any received RTP media packet; and. 3.	shall remain in the current state.. State details are explained in the following clauses.,TS 29.380,6.3.6.1,all_images/image_1108.jpeg,Floor control server state transition diagram for 'dual floor control operation'
"Figure 5.2.2.2.4-1 shows a scenario where the NF service consumer (e.g. AMF) sends a request to the UDM to receive the UE's SMF Selection Subscription data (see also 3GPP TS 23.502 [3] figure 4.2.2.2.2-1 step 14). The request contains the UE's identity (/{supi}), the type of the requested information (/smf-select-data) and query parameters (supported-features, plmn-id).
Figure 5.2.2.2.4-1: Requesting a UE's SMF Selection Subscription Data
1.	The NF service consumer (e.g. AMF) sends a GET request to the resource representing the UE's SMF Selection Subscription Data, with query parameters indicating the supported-features and/or plmn-id.
2a.	On success, the UDM responds with ""200 OK"" with the message body containing the UE's SMF Selection Subscription Data as relevant for the requesting NF service consumer.
2b.	If there is no valid subscription data for the UE, HTTP status code ""404 Not Found"" shall be returned including additional error information in the response body (in the ""ProblemDetails"" element).
On failure, the appropriate HTTP status code indicating the error shall be returned and appropriate additional error information should be returned in the GET response body.",TS 29.503,5.2.2.2.4,all_images/image_1112.png,Requesting a UE's SMF Selection Subscription Data
"Figure 5.2.2.2.12-1 shows a scenario where the NF service consumer (e.g. AMF) sends a request to the UDM to receive the UE's Context In SMSF data. The request contains the UE's identity (/{supi}), the type of the requested information (/ue-context-in-smsf-data) and query parameters (supported-features).
Figure 5.2.2.2.12-1: Requesting a UE's Context in SMSF Data
1.	The NF service consumer (e.g. AMF) shall send a GET request to the resource representing the UE's Context In SMSF Data, with query parameters indicating the supported-features.
2a.	On Success, the UDM shall respond with ""200 OK"" with the message body containing the UE's Context In SMSF Data as relevant for the requesting NF service consumer.
2b.	If there is no valid subscription data for the UE, HTTP status code ""404 Not Found"" shall be returned including additional error information in the response body (in the ""ProblemDetails"" element).
On failure, the appropriate HTTP status code indicating the error shall be returned and appropriate additional error information should be returned in the GET response body.",TS 29.503,5.2.2.2.12,all_images/image_1113.jpeg,Requesting a UE's Context in SMSF Data
"Figure 5.2.2.6.3-1 shows a scenario where the NF service consumer (e.g. AMF) sends the UE acknowledgement to the UDM (see also 3GPP TS 23.502 [3]). The request contains the UE's identity (/{supi}), the type of the acknowledgement information (/am-data/upu-ack), and the UPU-MAC-Iue.
Figure 5.2.2.6.3-1: Providing acknowledgement of UE parameters update
1.	The NF service consumer (e.g. AMF) sends a PUT request to the resource representing the UE's Access and Mobility Subscription Data, with the AcknowledgeInfo(UPU-MAC-IUE received from the UE, or UE not reachable indication).
2.	The UDM responds with ""204 No Content"".
On failure, the appropriate HTTP status code indicating the error shall be returned and appropriate additional error information should be returned in the PUT response body.",TS 29.503,5.2.2.6.3,all_images/image_1114.jpeg,Providing acknowledgement of UE parameters update
"Figure 5.2.2.6.5-1 shows a scenario where the NF service consumer (e.g. AMF) sends the UE acknowledgement to the UDM (see also 3GPP TS 23.502 [3]). The request contains the UE's identity (/{supi}) and the type of the acknowledgement information (/am-data/cag-ack).
Figure 5.2.2.6.5-1: Providing acknowledgement of UE for CAG configuration change
1.	The NF service consumer (e.g. AMF) sends a PUT request to the resource representing the UE's Access and Mobility Subscription Data, with the AcknowledgeInfo.
2.	The UDM responds with ""204 No Content"".
On failure, the appropriate HTTP status code indicating the error shall be returned and appropriate additional error information should be returned in the PUT response body.",TS 29.503,5.2.2.6.5,all_images/image_1115.jpeg,Providing acknowledgement of UE for CAG configuration change
"Figure 5.2.2.7.2-1 shows a scenario where the NF service consumer sends a request to the UDM to modify a subscription to notifications of data changes. The request contains the URI previously received in the Location HTTP header of the response to the subscription.
Figure 5.2.2.7.2-1: NF service consumer modifies a subscription to notifications
1.	The NF service consumer sends a PATCH request to the resource identified by the URI previously received during subscription creation.
The NF service consumer may include ""monitoredResourceUris"" to replace the existing monitored resource URIs, e.g. to add/remove specific resource URIs from the monitored resource URI list.
2a.	On success, the UDM responds with ""200 OK"".
2b.	If there is no valid subscription available (e.g. due to an unknown subscriptionId value), HTTP status code ""404 Not Found"" should be returned including additional error information in the response body (in the ""ProblemDetails"" element).
On failure, the appropriate HTTP status code indicating the error shall be returned and appropriate additional error information should be returned in the PATCH response body.",TS 29.503,5.2.2.7.2,all_images/image_1116.png,NF service consumer modifies a subscription to notifications
"Figure 5.4.2.2.2-1 shows a scenario where the NF service consumer (AUSF) retrieves authentication information for the UE from the UDM (see also 3GPP TS 33.501 [6] clause 6.1.2). The request contains the UE's identity (supi or suci), the serving network name, and may contain resynchronization info.
Figure 5.4.2.2.2-1: NF service consumer requesting authentication information
1.	The NF service consumer sends a POST request (custom method: generate-auth-data) to the resource representing the UE's security information.
2a.	The UDM responds with ""200 OK"" with the message body containing the authentication data information.
The AUSF shall store the authentication data information for subsequent authentication processing. If the AUSF is configured to store Kausf (e.g. based on its support of SoRProtection / UPUProtection service operations / deriving AKMA key after primary authentication), the AUSF shall preserve the Kausf and related information (e.g. SUPI) after the completion of the primary authentication. If the UDM decides that the primary authentication by an AAA server in a Credentials Holder is required, the AUSF shall perform the authentication with the AAA Server. In case the UDM receives an anonymous SUCI that contains the realm part, the UDM authorizes the UE based on realm part of SUCI, and send anonymous SUPI and the indicator to indicate to the AUSF to run primary authentication with an external Credentials holder (see 3GPP TS 33.501 [6], clause I.2.2). If the Default Credentials Server (DCS) provides UDM with the information of a Provisioning Server (PVS FQDN(s) and/or IP address(es)), the UDM provides the PVS info to the AUSF.
2b.	If the operation cannot be authorized due to e.g UE does not have required subcription data, none of the CAG IDs in the CAG cell match any of the CAG IDs in the allowed CAG list, access barring or roaming restrictions, UDM receives an anonymous SUCI that does not contain the realm part, HTTP status code ""403 Forbidden"" should be returned including additional error information in the response body (in ""ProblemDetails"" element). If the cellCagInfo is not received, the UDM shall not assume the UE is accessing from the PLMN and shall not stop the authenthcation if the UE is allowed to access 5GS via CAG cell(s) only.
On failure, the appropriate HTTP status code indicating the error shall be returned and appropriate additional error information should be returned in the POST response body.",TS 29.503,5.4.2.2.2,all_images/image_1119.png,NF service consumer requesting authentication information
"Figure 5.5.2.2.2-1 shows a scenario where the NF service consumer sends a request to the UDM to subscribe to notifications of event occurrence (see also 3GPP TS 23.502 [3] figure 4.15.3.2.2-1 step 1 and 3GPP TS 23.502 [3] Figure 4.15.3.2.3b-1 step 1). The request contains a callback URI, the type of event that is monitored and additional information e.g. event filters and reporting options.
Figure 5.5.2.2.2-1: NF service consumer subscribes to notifications
1.	The NF service consumer sends a POST request to the parent resource (collection of subscriptions) (.../{ueIdentity}/ee-subscriptions), to create a subscription as present in message body. The values ueIdentity shall take are specified in Table 6.4.3.2.2-1. The request may contain an expiry time, suggested by the NF Service Consumer, representing the time upto which the subscription is desired to be kept active and the time after which the subscribed event(s) shall stop generating notifications, the indication on whether the subscription applies also to EPC.

If MTC Provider information and/or AF ID are received in the request, the UDM shall check whether the MTC Provider and/or the AF is allowed to perform this operation for the UE or for the group of UEs or Any UE which is indicated in the Resource URI variable ueIdentity; otherwise, the UDM shall skip the MTC provider and/or AF authorization check.
2a.	On success, the UDM responds with ""201 Created"" with the message body containing a representation of the created subscription. The Location HTTP header shall contain the URI of the created subscription. If the event subscription was for a group of UEs:
-	The ""maxNumOfReports"" in the ""reportingOptions"" IE shall be applicable to each UE in the group;
-	The UDM shall return the number of UEs in that group in the ""numberOfUes"" IE.
The NF service consumer shall keep track of the maximum number of reports reported for each UE in the event report and when ""maxNumOfReports*numberOfUes"" limit is reached, the NF service consumer shall initiate the unsubscription of the notification towards the UDM (see clause 5.5.2.3.2).
If the event subscription was for a list events, the ""maxNumOfReports"" in the ""reportingOptions"" IE shall be applicable to each event. The NF service consumer shall keep track of the maximum number of reports reported for each event in the event report and when ""maxNumOfReports*number of events"" limit is reached, the NF service consumer shall initiate the unsubscription of the notification towards the UDM (see clause 5.5.2.3.2).
The response, based on operator policy, may contain the expiry time, as determined by the UDM, after which the subscription becomes invalid. Before the subscription is going to expire, if the NF Service Consumer wants to keep receiving notifications, it shall modify the subscription in the UDM with a new expiry time. The NF Service Producer shall not provide the same expiry time for many subscriptions in order to avoid all of them expiring and recreating the subscription at the same time. If the expiry time is not included in the response, the NF Service Consumer shall not associate an expiry time for the subscription.
If the indication on whether the subscription applies also to EPC is included and set to true in the request, the response shall include the indication on whether the subscription was also successful in EPC domain. If the subscription also applies to the EPC domain, the only the Event Types below shall apply to the EPC domain,
-	The event type ""LOSS_OF_CONNECTIVITY"", it shall be map to event type ""LOSS_OF_CONNECTIVITY"" on Nhss
-	The event type ""UE_REACHABILITY_FOR_DATA"" and the reportCfg in reachabilityForDataCfg set to ""DIRECT_REPORT"", it shall be mapped to event type ""UE_REACHABILITY_FOR_DATA"" on Nhss
-	The event type ""LOCATION_REPORTING"", and dddTrafficDes or Dnn is not included in the request, it shall be mapped to event type ""LOCATION_REPORTING"" on Nhss
-	The event type ""COMMUNICATION_FAILURE"", it shall be mapped to event type ""COMMUNICATION_FAILURE"" on Nhss
-	The event type ""AVAILABILITY_AFTER_DDN_FAILURE"", it shall be mapped to event type ""AVAILABILITY_AFTER_DDN_FAILURE"" on Nhss
-	The event type ""PDN_CONNECTIVITY_STATUS"", it shall be mapped to event type ""PDN_CONNECTIVITY_STATUS"" on Nhss
-	The event type ""UE_REACHABILITY_FOR_SMS"" and reachabilityForSmsCfg set to ""REACHABILITY_FOR_SMS_OVER_NAS"", it shall be mapped to event type ""UE_REACHABILITY_FOR_SMS"" on Nhss
-	The event type ""UE_MEMORY_AVAILABLE_FOR_SMS"", it shall be mapped to event type "" UE_MEMORY_AVAILABLE_FOR_SMS "" on Nhss
If some of the requested monitoring configurations fails, the response may include the failedMonitoringConfigs to indicate the failed cause of the failed monitoring configurations.
If some of the requested monitoring configurations fails in the EPC domain or the EE subscription fails in the EPC domain, the response may include the failedMoniConfigsEPC to indicate the failed cause of the failed monitoring configurations or the failed cause of the EE subscription in the EPC domain.
If the NF Service Consumer has included the immediateFlag with value as ""true"" in the event subscription for an individual UE and the event requested for immediate reporting is reported by the UDM (e.g. ""CHANGE_OF_SUPI_PEI_ASSOCIATION"" or ""ROAMING_STATUS""), the UDM may include the current status of the event if available in the response.
If the NF Service Consumer has included the immediateFlag with value as ""true"" in the event subscription for an individual UE and the event requested for immediate reporting is reported by the AMF (e.g. LOCATION_REPORT) and the NF service consumer has indicated supporting of ""IERSR"" feature (see clause 6.4.8), the UDM shall indicate the support of ""IERSR"" feature when subscribing to the event on the AMF (see clause 6.2.8 of 3GPP TS 29.518 [36]). UDM shall include the current status of the event if received from the AMF in subscription creation response.
If the NF Service Consumer has included the immediateFlag with value as ""true"" in the event subscription for an individual UE, the indication on whether the subscription applies also to EPC is included and set to ""true"" in the request and the NF service consumer has indicated supporting of ""IERSR"" feature (see clause 6.4.8), the UDM shall indicate the support of ""ERIR"" feature when subscribing to the event on the HSS (see clause 6.4.8 of 3GPP TS 29.563 [62]). UDM shall include the current status of the event in EPC if received from the HSS in subscription creation response.
NOTE:	IERSR feature is not applicable to events detected by the SMF.
2b.	If the user does not exist, HTTP status code ""404 Not Found"" shall be returned including additional error information in the response body (in the ""ProblemDetails"" element).
2c.	If there is no valid subscription data for the UE, i.e. based on the UE's subscription information monitoring of the requested EventType is not allowed, or the requested EventType is not supported, or when MTC Provider or AF are not allowed to perform this operation for the UE, HTTP status code ""403 Forbidden"" shall be returned including additional error information in the response body (in the ""ProblemDetails"" element).
On failure, the appropriate HTTP status code indicating the error shall be returned and appropriate additional error information should be returned in the POST response body.",TS 29.503,5.5.2.2.2,all_images/image_1120.png,NF service consumer subscribes to notifications
"Figure 5.6.2.2.2-1 shows a scenario where the NF service consumer (e.g. NEF, AMF) sends a request to the UDM to update a UE's subscription data (see 3GPP TS 23.502 [3] figure 4.15.6.2-1 step 2 and also 3GPP TS 23.273 [38] Figure 6.12.1-1 step 2). The request contains the identifier of the UE's parameter provision data ( .../{ueId}/pp-data) and the modification instructions. The values ueId shall take are specified in Table 6.5.3.2.2-1.
Figure 5.6.2.2.2-1: NF service consumer updates subscription data
1.	The NF service consumer (e.g. NEF, AMF) sends a PATCH request to the resource that represents a UE's modifiable subscription data.

If MTC Provider information and/or AF ID are received in the request, the UDM shall check whether the MTC Provider and/or the AF is allowed to perform this operation for the UE; otherwise, the UDM shall skip the MTC provider and/or AF authorization check.
2a.	The UDM responds with ""204 No Content"".
2b. If MTC Provider or AF are not allowed to perform this operation for the UE, HTTP status code ""403 Forbidden"" shall be returned including additional error information in the response body (in the ""ProblemDetails"" element).
NOTE:	Upon reception of an update or removal of maximum latency, maximum response time or DL Buffering Suggested Packet Count, UDM may need to adjust the value of active time and/or periodic registration timer and/or DL Buffering Suggested Packet Count and the UDM shall notify AMF and/or SMF if the values are updated (see clause 4.15.6.3a of 3GPP TS 23.502 [3]).
On failure, the appropriate HTTP status code indicating the error shall be returned and appropriate additional error information should be returned in the PATCH response body.",TS 29.503,5.6.2.2.2,all_images/image_1122.jpeg,NF service consumer updates subscription data
"The architecture for support of Location Services in GSM, UMTS and EPS has been defined in 3GPP TS 23.271 [2] and the relevant network elements and interfaces are shown in the figure 4.2-1.
Figure 4.2-1: Overview of the LCS Functional Architecture
In this architecture, the SLh interface is defined between the Gateway Mobile Location Center (GMLC) and the Home Subscriber Server (HSS) to allow the GMLC to request routing information from the HLR or HSS.",TS 29.173,4.2,all_images/image_1123.jpeg,Overview of the LCS Functional Architecture
"The requirements for Zpn interface are defined in 3GPP TS 33.223 [23].
The protocol Zpn retrieves the GPI, key material and possibly user security settings data by NAF from BSF.  When the NAF wants to send data to the UE, but the NAF has no valid NAF-key available, the following steps are executed as depicted in Figure 5.4. The basic procedure is:
In general, the UE and the NAF will not yet share the key(s) required to protect protocol Ua. If they already do, there is no need for the NAF to invoke protocol Zpn.
It is assumed that the NAF has sufficient information available, i.e. user identity and the address of BSF.
A) The NAF starts protocol Zpn with BSF
-	The NAF requests GBA-Push-Info (GPI), NAF specific key material corresponding to the user identity.
-	The BSF fetches AVs from the HSS, generates and supplies to the NAF the requested GPI, NAF specific key material, the expiry time, the bootstrapinfo creation time, and the appropriate User Security Settings defined for received application identifiers.
B) The NAF sends GPI over protocol Upa to the UE (see 3GPP TS 33.223 [23])
Once the run of protocol Upa is completed the purpose of bootstrapping is fulfilled and it will enable the UE and NAF to run protocol Ua in a secure way.
The  GBA push procedure over Zpn is presented in Figure 5.4.
Figure 5.4-1: The Diameter based GBA push procedure over Zpn
The steps of the GBA push procedure in Figure 5.4-1 are:
- Step 1
The NAF shall send a GBA-Push-Info-Request message to the BSF.  The content of the message is given here in the same format as in 3GPP TS 29.229 [3]. The curly brackets indicate mandatory AVPs. The square brackets indicate optional AVP. The address refers to the Fully Qualified Domain Name (FQDN).
< GBA-Push-Info-Request> ::=<Diameter Header: xxx, REQ, PXY, xxxxxxxx >
< Session-Id >
{ Vendor-Specific-Application-Id }
{ Origin-Host }	; Address of NAF
{ Origin-Realm }	; Realm of NAF
{ Destination-Realm }	; Realm of BSF
[ Destination-Host ]	; Address of the BSF 
{ UE-Id }	; User identity
{ UE-Id-Type }	; Public or private identity
{ UICC-App-Label }	; UICC application label
* [ GAA-Service-Identifier ]	; Service identifiers
{ NAF-SA-Identifier }	; P-TID
{ NAF-Id }	; NAF_ID
{ UICC-ME }	; Use of GBA_ME or GBA_U
{ Requested-Key-Lifetime }	; Requested NAF-Key lifetime
{ Private-Identity-Request }	; Request private identity
[ GBA_U-Awareness-Indicator ]	; GBA_U awareness of the NAF
[ Security-Feature-Request ]	; Sec. feature request
*[ AVP ]
*[ Proxy-Info ]
*[ Route-Record ]
The content of Vendor-Specific-Application-ID according IETF RFC 6733 [33] is:
<Vendor-Specific-Application-Id>::=<AVP header: 260>
1*  [Vendor-Id]	; 3GPP is 10415
0*1 {Auth-Application-Id}	; xxxxxxxx
0*1 {Acct-Application-Id}	; Omitted
The Destination-Realm AVP and Destination-Host AVP are set to subscriber’s BSF.
NOTE:	In the case the NAF is in a visited network, the NAF contacts the subscriber's home BSF through a Diameter based Proxy (Zn-Proxy) that is located in the same network as the NAF. In this case the Destination-Host shall not be included.The local BSF and the Zn-Proxy may be co-located. See 3GPP TS 33.220 [6].
The NAF indicates the GAA services for which the information is retrieved by GAA-Service-Identifier AVPs.
With UE-Id and UE-Id-Type AVPs the NAF indicates the user identity and its type, i.e. private or public. The NAF uses UICC-ME and UICC-App-Label AVPs to identity which UICC application is to be used and if GBA-ME or GBA_U should be used. Private-Identity-Request indicates if he NAF requests the BSF to send the private user identity. Requested-Key-Lifetime AVP indicates the requested key lifetime for the NAF keys. NAF-SA-Identifier (P-TID) is sent to the BSF so that BSF can include it to the encrypted GPI. See 3GPP TS 33.223 [23]).
The NAF may request information on the availability of security features using the Security-Features-Resquest AVP. The AVP may contain a semicolumn-separated list of security features that are available ordered by preference.
- Step 2
When the BSF receives the GPI request it checks that the requested key lifetime  in the GPI request is less than the allowed max value in the system. If checking fails the BSF sends an Answer  message with Experimental-Result set to indicate the error type 5402. In successful case the Result-Code is set to 2xxx as defined in IETF RFC 6733 [33].
The BSF includes the received user identity (public of private) to the Zh protocol request.
If GBA_U was requested by the NAF, the BSF queries its database to find out if the private user identity is registered and if a valid Ks already exists. If a valid Ks exists, the BSF shall invalidate this Ks
The BSF derives the key material for the ME (i.e., Ks_NAF in the case of GBA_ME, and Ks_ext_NAF in the case of GBA_U) and possibly the key material for the UICC (i.e., Ks_int_NAF in the case of GBA_U)  according to the NAF-ID and packs them into ME-Key-Material AVP and possible UICC-Key-Material AVP. The ME-Key-Material contains Ks_(ext)_NAF and the UICC-key-Material contains the Ks_int_NAF key. The BSF select correct user’s Security Settings according the request’s GAA-Service-Identifier AVP to GBA-UserSecSettings AVP. If NAF grouping is used by the operator and there are one or more USSs corresponding to the requested GSID, then also the nafGroup attribute of USS is checked. If the NAF has sent a GAA-Service-Identifier that does not have corresponding user’s security settings, and the BSF is locally configured to reject those requests from the NAF, then the error 5402 is raised. If the NAF has sent a GAA-Service-Identifier that have corresponding user's security settings, but the BSF is locally configured to reject those from that NAF, then the error 5402 is raised too.
The BSF generates the GPI according to TS 33.223 [23].
The BSF shall check if this NAF-Id is allowed to be used for the NAF. If the NAF identified by its Origin-Host AVP is configured in the BSF not to be authorized to use the given NAF-Id, the BSF may raise the error situation 5402. The BSF may also be configured so that a certain NAF is not authorized to use a certain GAA-Service-Identifier. This situation may be also indicated by error code 5402.
- Step 3
After that the BSF shall send a GBA-Push-Info-Answer message back to the NAF. The BSF deletes the used Ks according to 3GPP TS 33.223 [23].
< GBA-Push-Info-Answer> ::= < Diameter Header: xxx, PXY, xxxxxxxx >
< Session-Id >
{ Vendor-Specific-Application-Id }
[ Result-Code ]	
[ Experimental-Result]
{ Origin-Host }	; Address of BSF
{ Origin-Realm }	; Realm of BSF
[ User-Name ]	; IMPI
[ ME-Key-Material ]	; Required
[ UICC-Key-Material ]	; Conditional
[ Key-ExpiryTime ]	; Time of expiry
[ BootstrapInfoCreationTime ]	; Bootstrapinfo creation time
[ GBA-UserSecSettings ]	; Selected USSs
[ GBA-Type ]	; GBA type used in bootstrapping
[ GBA-Push-Info ]	; GBA Push Info
[ Security-Feature-Response ]	; Sec. feature response
*[ AVP ]
*[ Proxy-Info ]
*[ Route-Record ]
The BSF may or may not send the User-name AVP (IMPI) It is only returned if requested and public user identity was used in the GBA-Push-Info-Request message according its configuration.
The mandatory common key material with the ME (Ks_NAF or Ks_ext_NAF) is sent in the ME-Key-Material AVP. The common key material with the UICC (Ks_int_NAF) is optionally sent in the UICC-Key-Material AVP only if the ""uiccType"" tag in bsfInfo from the HSS is set to ""GBA_U"".
The Key-ExpiryTime AVP contains the expiry time of the Bootstrapping information in the BSF according its configuration. The expiry time is represented according the Diameter Time data format in seconds that have passed since 0h on January 1, 1900 UTC . If a special key lifetime value is given in the ""lifeTime"" tag inside the bsfInfo from the HSS in bootstraping procedure, it is used instead of the BSF default configuration value when the expiry time is calculated.
The BootstrapInfoCreationTime AVP contains the bootstrapinfo creation time, i.e., creation time of the Bootstrapping information in the BSF. The bootstrapinfo creation time is represented in seconds that have passed since January 1, 1900 00:00:00.000 UTC.
The BSF selects the appropriate User Security Settings (if any) to the GBA-UserSecSettings AVP from stored GAA-UserSecSettings in Bootstrapping information according the GBA-Service-Identifier AVPs in the request message.
The BSF shall indicate the type of used authentication in the bootstrapping procedure to the NAF in GBA-Type, if other than 3G GBA type has been performed.
The GBA-Push-Info AVP includes the GPI. The contents of GPI are defined in 3GPP TS 33.223 [23].
If the BSF supports the usage of securityFeature and the NAF has requested the securityFeatures from the BSF in the request, the BSF shall extract securityFeatures element from the bsfInfo element in subscriber's GUSS and add those security features to the Security-Features-Response AVP in the response which are common in the received securityFeatures request from the NAF and in the extracted information from the bsfInfo element. The common security features are added to the Security-Features-Response AVP in the order as they appear in the bsfInfo element. If securityFeatures element is not defined in the GUSS,or there is no common securityFeature, the BSF shall include an empty string to the Security-Features-Response AVP in the response.
When the NAF receives the GBA-Push-Info-Answer message, the NAF shall check the value of the GBA-Type AVP if it is included in the message. If the NAF does not support the GBA-Type the NAF shall stop processing the message and should indicate an error via the O&M subsystem. The further procedure in the NAF when the GBA-Push-Info-Answer message is received is described in 3GPP TS 33.223 [23], 3GPP TS 24.109 [7].",TS 29.109,5.4,all_images/image_1125.jpeg,The Diameter based GBA push procedure over Zpn
"The TCP Port Service Multiplexer (TCPMUX) is defined in IETF RFC 1078 [10]. The specification describes a multiplexing service that may be accessed with a network protocol to contact any one of a number of available TCP services of a host on a single, well-known port number.
The same principle is applied to SCTP applications.
An SCTP (IETF RFC 4960 [4]) packet is composed of a common header and chunks.
The SCTP common header contains:
-	The SCTP Source Port Number that can be used by the receiver in combination with the source IP address, the SCTP destination port, and possibly the destination IP address to identify the association to which this packet belongs.
-	The SCTP Destination Port Number that can be used by the receiving host to de-multiplex the SCTP packet to the correct receiving endpoint/application.
A SCTP chunk represents a protocol message, which can be used by the protocol itself or can contain user data. User data are contained in DATA chunks that include a Payload Protocol Identifier. The Payload Protocol Identifier is used to identify the application which uses the services of SCTP.
As it is contained in each DATA chunk, the Payload Protocol Identifier identifies the protocol being carried over SCTP independently of the port numbers being used. The Payload Protocol Identifier can be used therefore to de-multiplex the SCTP packet to the correct receiving endpoint/application above SCTP instead of the SCTP Destination Port Number.
The proposed solution based on the Payload Protocol Identifier parsing would then allow to contact multiple applications on a single well-known STCP port using the SCTP Payload Protocol Identifier instead of requesting IANA for allocation of a new well-known SCTP number each time a new application is defined.
The SCTP multiplexer is implemented as a stand-alone process above the SCTP layer, listening at the well-known SCTP port, used to initiate and manage associations with remote SCTP endpoints and distribute received SCTP messages to upper-layer applications based on the Payload Protocol Identifier. From the SCTP layer, the SCTP multiplexer is seen as a regular SCTP user. There is no impact on the SCTP stack.
The well-known port can be:
-	The port already allocated for TCPMUX (port 1);
-	A port already allocated for another SCTP application defined by 3GPP;
-	A new port dedicated to SCTP multiplexing allocated in a port range locally administrated by 3GPP.
-	A new port dedicated to SCTP multiplexing allocated by IANA.
In the figure below, a single SCTP host is supporting 4 new applications in addition of an existing W1 application. The port number used to identify the multiplexer is 47002 (given only as possible unassigned User Port that can be used).
Figure 6.8.1-1: SCTP server-side illustration for SCTP Multiplexer (port)
When DTLS over SCTP, as described in IETF RFC 6083 [x], is used to provide mutual authentication, integrity protection, replay protection and confidentiality protection, only SCTP user data are integrity protected and encrypted using DTLS. The Payload Data (DATA) header, in which the SCTP Payload Protocol Identifier is indicated, is therefore sent as clear text. The SCTP Multiplexer can still use the SCTP Payload Protocol Identifier to distribute SCTP messages to upper-layer applications. Moreover, the SCTP associations being managed by the SCTP Multiplexer and the DTLS connections being handled by the applications (identified by the SCTP Payload Protocol Identifier) above the SCTP Multiplexer, it is possible to have multiple DTLS connections over a the same SCTP association, one DTLS connection per application (or per SCTP Payload Protocol Identifier).
In the figure below, a single SCTP host is supporting 4 new applications in addition of an existing W1 application. The port number used to identify the multiplexer is 47002 (given only as possible unassigned User Port that can be used). DTLS over SCTP is used to provide communications privacy for applications above the SCTP Multiplexer.
Figure 6.8.1-2: SCTP server-side illustration for SCTP Multiplexer (port) with used of DTLS over SCTP",TR 29.835,6.8.1,all_images/image_1127.png,SCTP server-side illustration for SCTP Multiplexer (port) with used of DTLS over SCTP
"This is an alternative to the solution#7.
A new SCTP application (see IETF RFC 4960 [4]) is specified by 3GPP and a new well-known SCTP port is allocated by IANA for this SCTP application. As an alternative, the SCTP port for this new application could be managed by 3GPP.
This SCTP application is used to:
-	Advertise the list of SCTP application required by a client
-	Retrieve the list of SCTP application supported by a server
-	Multiplex and de-multiplex SCTP applications over a single well-known port
The following SCTP messages are defined:
-	Required Payload Protocol ID list: This DATA chunk provides the SCTP application identifier required by the client.
-	Supported Payload Protocol ID list: This DATA chunk indicates if the required SCTP application identifier is supported and may provide the list of SCTP application identifiers supported by the server.
The messages above are used to negotiation the SCTP application that can be used between peers over SCTP.
If there is at least one application supported by both the client and the server, the SCTP peers can exchange user data related to the supported application(s).
If there is no application in common, the SCTP association is aborted.
The SCTP Multiplexer Application is seen as a regular SCTP user by the SCTP user. There is no impact on the SCTP stack.
In the figure below, a single SCTP host is supporting the new SCTP Multiplexer Application of an existing W1 application. The SCTP Multiplexer Application supports 4 different applications. The port number used to identify the SCTP Multiplexer Application is 47002 (given only as possible unassigned User Port that can be used).
Figure 6.9.1-1: SCTP server-side illustration for SCTP Multiplexer Application",TR 29.835,6.9.1,all_images/image_1128.png,SCTP server-side illustration for SCTP Multiplexer Application
"The structure of the Resource URIs of the Nlmf_Location service is shown in figure 6.1.3.1-1.
Figure 6.1.3.1-1: Resource URI structure of the Nlmf_Location API",TS 29.572,6.1.3.1,all_images/image_1129.png,Resource URI structure of the Nlmf_Location API
"The parameter exchange procedure for protection policy exchange may be performed after the Parameter Exchange Procedure for Cipher Suite Negotiation (see clause 5.2.3.2). If a HTTP/2 connection does not exist towards the peer SEPP at the time of initiating this procedure, the HTTP/2 connection shall be established. If there is a change in the protection policy exchange and the SEPP wants to renegotiate it, then the SEPP may reuse the parameter exchange procedure for the protection policy exchange to override what was exchanged before. If the parameter exchange procedure for the protection policy exchange is not performed then the protection policies between the SEPP shall be exchanged out of bands.
The procedure is described in Figure 5.2.3.3-1 below.
Figure 5.2.3.3-1: Parameter Exchange Procedure for Protection Policy Exchange
1.	The initiating SEPP issues a HTTP POST request towards the responding SEPP with the request body containing the ""SecParamExchReqData"" IE carrying the following information
-	Protection policy information
The protection policy information contains:
-	API to IE mapping containing the mapping information of list of leaf IEs for each:
-	Request/response and Subscribe / Unsubscribe service operation, identified by the API URI and method; and/or
-	Callbacks (e.g Notification service operation), identified by the value of the 3GPP custom HTTP header ""3gpp-Sbi-Callback"" (see clause 5.2.3 of 3GPP TS 29.500 [4]).
-	List of IE types that are to be protected across N32-f (i.e the data type encryption policy as specified in clause 13.2.3.2 of 3GPP TS 33.501 [6]); and
-	Modification policy: Against each leaf IE in the API to IE mapping information, a boolean flag indicating whether that IE is allowed to be modified by an IPX on the side of the SEPP sending the protection policy information.
2a.	On successful processing of the request, the responding SEPP shall respond to the initiating SEPP with a ""200 OK"" status code and a POST response body that contains the following information
-	Selected protection policy information
The Selected protection policy information contains the IEs allowed to be modified by an IPX on the side of the responding SEPP. If the responding SEPP connects to several IPXs, an isModifiable IE may be included to indicate an IE is allowed to be modified by all IPX(s) or an map type of isModifiableByIpx IE may be included to indicate an IE is allowed to be modified by an IPX identified by the key of ipxProviderId IE if this IE is allowed to be modified by some of (but not all) the IPX(s), as specified in clause 13.2.3.4 of 3GPP TS 33.501 [6].
The initiating SEPP shall store the modification policy which are sent from responding SEPP in selected protection policy information and the responding SEPP shall store the modification policy which are sent from the initiating SEPP in the protection policy information. The SEPP receving the subsequent message transfers over N32-f shall check whether the modifications performed by the IPXs were permitted by the respective modification policy.
The SEPPs shall store the encryption policy in selected protection policy information and shall apply this policy for subsequent message transfers over N32-f. The encryption policy in selected protection policy is applicable for both the directions of communication between the SEPPs.
If the receiving SEPP already has a previously negotiated protection policy information, the SEPP shall overwrite it with the new one.
The HTTP/2 connection used for the N32 handshake procedures may be terminated after the completion of this procedure.
2b.	On failure, the responding SEPP shall respond to the initiating SEPP with an appropriate 4xx/5xx status code as specified in clause 6.1.4.3. If the SEPP already has previously negotiated protection policy information, the SEPP shall continue to use the same.
NOTE :	If a SEPP already has a previously negotiated cipher suite and a new cipher suite is also received, the SEPP starts applying the new cipher suite immediately and also continues with the old cipher suite for a limited time period. This allows messages with old policies to be completed gracefully.
An illustration of how the protection policy is stored and looked up in the SEPP is provided in figure 5.2.3.3-2
Figure 5.2.3.3-2: Protection Policy Storage and Lookup in SEPP
During the N32-f message forwarding, the SEPP looks at a HTTP request or response it receives from an NF service consumer or NF service producer and then uses the above tables to decide which IEs and headers in the message it shall cipher and integrity protect and which IEs it shall allow the IPXes to modify.",TS 29.573,5.2.3.3,all_images/image_1130.jpeg,Protection Policy Storage and Lookup in SEPP
"N6 PtP tunnelling based on UDP/IPv6 may be used to deliver unstructured PDU type data to the AS.
The PtP tunnel is set up by configuration of tunnel parameters in both end of the tunnel. The following parameters are pre-configured in the UPF per DNN:
-	the UDP destination port number to use when sending unstructured PDU type data;
-	the UDP port number it wants to receive unstructured PDU type data;
-	the destination IP address to be used for sending unstructured PDU type data.
The following is pre-configured in the AS:
-	the UDP destination port number to use when sending unstructured PDU type data;
-	the UDP port number it wants to receive unstructured PDU type data.
NOTE 1:	The UPF as well as the AS can use any UDP port numbers not assigned by IANA. The port numbers used need to be aligned between peers.
IP address allocation procedures for the UE (i.e. PDU session) are performed by the SMF as described in clause 6.3.2, but the IPv6 prefix is not provided to the UE, i.e. Router Advertisements and DHCPv6 are not performed. The SMF assigns a suffix (i.e. IPv6 Interface Identifier) for the PDU session. For the N6 PtP tunnel, the IPv6 prefix allocated for the PDU session plus suffix assigned for the PtP tunnel is used as source address for the uplink data and as destination address for the downlink data.
During the PDU session establishment, the UPF associates the GTP-U tunnel for the PDU session with the N6 PtP tunnel.
The UPF acts as a transparent forwarding node between the UE and the AS.
For uplink delivery, if the uplink data is received from the GTP-U tunnel, the UPF shall forward the received data to the AS over the N6 PtP tunnel associated with the GTP-U tunnel with the destination address of the AS and the configured UDP destination port number for unstructured PDU type data.
For downlink delivery, the AS shall send the data using UDP/IP encapsulation with the IPv6 prefix plus suffix as destination address and the configured UDP destination port number for unstructured PDU type data.
NOTE 2:	The UPF decapsulates the received data (i.e. removes the UDP/IPv6 headers) and forwards the data on the GTP-U tunnel identified by the IPv6 prefix of the UE (i.e. PDU session) for delivery to the UE.
Figure 9.2-1: Protocol configuration for unstructured PDU type data (user plane) using N6 UDP/IPv6 PtP tunneling",TS 29.561,9.2,all_images/image_1132.jpeg,Protocol configuration for unstructured PDU type data (user plane) using N6 UDP/IPv6
"The SMF also represents the H-SMF in the home routed scenario in this clause unless specified otherwise.
When an SMF receives an initial access request (i.e. the SMF receives the Nsmf_PDUSession_CreateSMContext request with type ""Initial request"" for non-roaming case or local breakout case, or the H-SMF receives the Nsmf_PDUSession_Create Request with type ""Initial request"" for home routed case) message for a given DNN, the SMF may (depending on the configuration for this DNN) send a RADIUS Access-Request message with EAP extension to a DN-AAA server. The SMF may also (depending on the configuration for this DNN) send the S-NSSAI and the PDU Session ID that are associated with the PDU Session, respectively in the 3GPP-Session-S-NSSAI VSA and the 3GPP-Session-Id VSA, to a DN-AAA server. Upon receipt of the Access-Request message, the DN-AAA server shall respond with an Access-Challenge message. Multi-round authentication using the Access-Challenge (sent by DN-AAA) and Access-Request messages may be used. The DN-AAA server finally authenticates and authorizes the user by replying with an Access Accept message. If the DN-AAA server is also responsible for IPv4 address and/or IPv6 prefix allocation, the DN-AAA server shall return the allocated IPv4 address and/or IPv6 prefix in the Access-Accept message.
For re-authentication and re-authorization, the SMF shall send a RADIUS Access-Request message with EAP extension and the DN-AAA shall respond with an Access-Challenge message. Multi-round authentication using the Access-Challenge (sent by DN-AAA) and Access-Request messages may be used. The DN-AAA server finally authenticates and authorizes the user by replying with an Access Accept message.
The SMF may initiate RADIUS re-authorization procedures for the purpose of IPv4 address and/or IPv6 prefix allocation (or renew the lease). In this case, the SMF shall set the Service-Type attribute to ""Authorize Only"" and the 3GPP-Allocate-IP-Type subattribute to the type of IP address to be allocated in the Access-Request message sent to the DN-AAA server. If the SMF is using DHCP signalling towards the UE and the DN-AAA server includes the Session-Timeout attribute in the Access-Accept, the SMF may use the Session-Timeout value as the DHCP lease time. The SMF shall not set the DHCP lease time value higher than the Session-Timeout value. The SMF may renew the DHCP lease to the UE without re-authorization towards the DN-AAA server providing that the new lease expiry is no later than the Session-Timeout timer expiry. If the SMF wishes to extend the lease time beyond the current Session-Timeout expiry, it shall initiate a new AAA re-authorization.
Even if the SMF was not involved in user authentication, it may send a RADIUS Accounting-Request (START) message to a DN-AAA server. This message may contain parameters, e.g. the tuple which includes the user ID and IPv4 address and/or IPv6 prefix, to be used by application servers (e.g. WAP gateway) in order to identify the user, the 3GPP-Charging-Id VSA or 3GPP-Charging-Id-v2 VSA according to the length of the Charging Id for the user session. This message may also (depending on the configuration for the DNN) contains the S-NSSAI and the PDU Session ID that are associated with the PDU Session, respectively in the 3GPP-Session-S-NSSAI VSA and the 3GPP-Session-Id VSA, and/or AF traffic influence PCC rule provisioned and then SMF used DNAI in the 3GPP-DNAI VSA, to a DN-AAA server. This message also indicates to the AAA server that the user session has started. The user session is uniquely identified by the Acct-Session-Id that is composed of the Charging ID and the SMF IP address.
NOTE:	If the accounting session is required by the DN-AAA server to be created per QoS flow, how to identify the different accounting sessions is implementation specific. The SMF can include the Acct-Session-Id which is extended to include the QFI of the QoS flow or the Acct-Session-Id without QFI extension and with 3GPP-NSAPI combination in the RADIUS Accounting-Request (START).
If some external applications require RADIUS Accounting-Request (START) information before they can process user packets, then the selected DNN (SMF) may be configured in such a way that the UPF is instructed to drop user data until the Accounting-Response (START) is received from the AAA server. The SMF may wait for the Accounting-Response (START) before sending the final authentication response message in Namf_Communication_N1N2MessageTransfer service operation. The SMF may reject the initial access request if the Accounting-Response (START) is not received. The authentication and accounting servers may be separately configured for each DNN.
For IPv4 PDU type, if IPv4 address is allocated via DHCPv4 signalling between the UE and the DN-AAA after PDU session establishment, the SMF may wait to send the Accounting-Request (START) message until the UE receives its IPv4 address in a DHCPACK.
When the SMF receives a message indicating a QoS flow or PDU session release request and providing a RADIUS Accounting-Request (START) message was sent previously, the SMF shall send a RADIUS Accounting-Request (STOP) message to the DN-AAA server, which indicates the termination of this particular QoS flow or PDU session. The SMF shall immediately send the corresponding response (e.g. Nsmf_PDUSession_UpdateSMContext response) to the AMF, without waiting for an Accounting-Response (STOP) message from the DN-AAA server.
The DN-AAA server shall deallocate the IPv4 address and/or IPv6 prefix initially allocated to the subscriber, if there is no session for the subscriber.
Accounting-Request (ON) and Accounting-Request (OFF) messages may be sent from the SMF to the DN-AAA server to ensure the correct synchronization of the session information in the SMF and the DN-AAA server.
The SMF may send an Accounting-Request (ON) message to the DN-AAA server to indicate that a restart has occurred. The DN-AAA server may then release the associated resources.
Prior to a scheduled restart, the SMF may send Accounting-Request (OFF) message to the DN-AAA server. The DN-AAA server may then release the associated resources.
The following figure 11.2.1-1 is an example message flow to show the procedure of RADIUS Authentication and Accounting between an SMF and a DN-AAA server:
1.	UE initiates the PDU Session Establishment procedure, including authentication/authorization information.
2.	The AMF sends Nsmf_PDUSession_CreateSMContext Request including the authentication/authorization information to the SMF and the SMF responds to the service operation.
According to the configuration in the SMF, step 6 to step 9 are executed before step 3 if the SMF needs to send an EAP-Request message to the UE.
In the case of home routed, the AMF sends Nsmf_PDUSession_CreateSMContext Request including the authentication/authorization information to the V-SMF and the V-SMF sends Nsmf_PDUSession_Create Request including the authentication/authorization information to the H-SMF.
3.	If the N4 session has not been established before, the SMF triggers the N4 Session Establishment procedure to the UPF.
In the case of home routed, the V-SMF triggers the N4 Session Establishment procedure to the V-UPF and the H-SMF triggers the N4 Session Establishment procedure to the H-UPF.
4.	The SMF sends the Access-Request message to the DN-AAA via the UPF, the message is forwarded from the SMF to the DN-AAA by the UPF in N4 user plane message.
In the case of home routed, the H-SMF sends the Access-Request message to the DN-AAA via the H-UPF, the message is forwarded from the H-SMF to the DN-AAA by the H-UPF in N4 user plane message.
5-10.	The DN-AAA responds with the Access-Challenge message to the SMF via the UPF, the message is forwarded from the DN-AAA to the SMF by the UPF in N4 user plane message. The authentication/authorization information is further transferred to UE via Namf_Communication_N1N2MessageTransfer service and NAS SM Transport message. UE responds to the received authentication/authorization data and such information is transferred in NAS SM Transport message and Nsmf_PDUSession_UpdateSMContext service, then finally sent to the DN-AAA by the SMF, via the UPF, in the Access-Request message.
In the case of home routed, the DN-AAA responds with the Access-Challenge message to the H-SMF via the H-UPF, the message is forwarded from the DN-AAA to the H-SMF by the H-UPF in N4 user plane message. The authentication/authorization information is transferred to V-SMF via Nsmf_PDUSession_Update service and is further transferred to UE via Namf_Communication_N1N2MessageTransfer service and NAS SM Transport message. UE responds to the received authentication/authorization data and such information is transferred in NAS SM Transport message, Nsmf_PDUSession_UpdateSMContext service and Nsmf_PDUSession_Update servic, then finally sent to the DN-AAA by the H-SMF, via the H-UPF, in the Access-Request message.
NOTE:	Step 5 to step 10 can be repeated depending on the authentication/authorization mechanism used (e.g. EAP-TLS).
11.	The SMF receives the final result of authentication/authorization from the DN-AAA in the Access-Accept message, via the UPF.
12.	The SMF requests to start accounting by sending the Accounting-Request (START) message to the DN-AAA via the UPF.
13.	The SMF proceeds with the PDU session establishment procedure and includes the authentication/authorization information in Namf_Communication_N1N2MessageTransfer service.
In the case of home routed, the H-SMF proceeds with the PDU session establishment procedure and includes the authentication/authorization information is transferred to V-SMF via Nsmf_PDUSession_Update service and is further transferred to the AMF via Namf_Communication_N1N2MessageTransfer service.
14.	The DN-AAA responds with the Accounting-Response (START) message. The SMF may wait for the Accounting-Response (START) before sending the Namf_Communication_N1N2MessageTransfer request in step 13.
In the case of home routed, the H-SMF may wait for the Accounting-Response (START) before sending the Nsmf_PDUSession_Update service in step 13.
15.	The AMF sends the NAS PDU Session Establishment Request with the authentication/authorization information to the UE.
16.	The UE sends a NAS message Deregistration Request to the AMF.
17.	The AMF sends Nsmf_PDUSession_ReleaseSMContext Request to the SMF and the SMF responds to the service operation.
In the case of home routed, the AMF sends Nsmf_PDUSession_ReleaseSMContext Request to the V-SMF and the V-SMF sends the Nsmf_PDUSession_Release Request to the H-SMF.
18-19. The SMF requests to stop accounting by sending the Accounting-Request (STOP) message to the DN-AAA via the UPF and the DN-AAA responds with the Accounting-Response (STOP) message.
Figure 11.2.1-1: RADIUS Authentication and Accounting example (successful case)
When PAP/CHAP is used as the authentication protocol with the external DN-AAA server which does not support EAP for the 5GS or for the 5GC and EPC interworking scenarios, the RADIUS Authentication procedures refer to the non transparent access procedures in clause 11.2.1 and the related RADIUS Authentication description in clause 16.3a.1 in 3GPP TS 29.061 [5] are reused with the following differences:
-	the SMF or SMF+PGW-C performs the actions specified for the P-GW;
-	the external DN-AAA server performs the actions specified for AAA;
-	PDU Session Establishment request is sent from the UE to the SMF or SMF+PGW-C instead of the Activate PDN connection request being sent from the UE to the S-GW and the Create Session request being sent from S-GW to P-GW;
-	PDU Session Establishment accept is sent from the SMF or SMF+PGW-C to the UE instead of the Create Session Response message being sent from the P-GW to S-GW and the Activate PDN Connection Accept being sent from S-GW to the UE; and
-	PDU Session Establishment reject is sent from the SMF or SMF+PGW-C to the UE instead of the Create Session Response message being sent from the P-GW to the S-GW and the Activate PDN Connection Reject being sent from S-GW to the UE.",TS 29.561,11.2.1,all_images/image_1133.jpeg,RADIUS Authentication and Accounting example (successful case)
"The SMF also represents the H-SMF in the home routed scenario in this clause unless specified otherwise.
When an SMF receives an initial access request (i.e. the SMF receives the Nsmf_PDUSession_CreateSMContext request with type ""Initial request"" for non-roaming case or local breakout case, or the H-SMF receives the Nsmf_PDUSession_Create Request with type ""Initial request"" for home routed case) message for a given DNN, the SMF may (depending on the configuration for this DNN) send a Diameter DER message to a DN-AAA server. The SMF may also (depending on the configuration for this DNN) send the S-NSSAI and the PDU Session ID that are associated with the PDU Session, respectively in the 3GPP-Session-S-NSSAI AVP and the 3GPP-Session-Id AVP, to a DN-AAA server. Upon receipt of the DER message, the DN-AAA server shall respond with an DEA message. Multi-round authentication using the DEA and DER messages may be used. The DN-AAA server finally authenticates and authorizes the user by replying with the DEA message. If the DN-AAA server is also responsible for IPv4 address and/or IPv6 prefix allocation, the DN-AAA server shall return the allocated IPv4 address and/or IPv6 prefix in the DEA message.
For re-authentication and re-authorization, the SMF shall send a DER message to the DN-AAA server and the DN-AAA server shall respond with a DEA message. Multi-round authentication using the DEA and DER messages may be used. The DN-AAA server finally authenticates and authorizes the user by replying with the DEA message.
The SMF may initiate Diameter re-authorization procedures for the purpose of IPv4 address and/or IPv6 prefix allocation (or renew the lease). In this case, the SMF shall set the Session-Id to the value used in the initial request, the Auth-Request-Type AVP to ""AUTHORIZE_ONLY"" and the 3GPP-Allocate-IP-Type AVP to the type of IP address to be allocated in the AA-Request message sent to the AAA server. If the SMF is using DHCP signalling towards the UE and the DN-AAA server includes the Session-Timeout attribute in the Access-Accept, the SMF may use the Session-Timeout value as the DHCP lease time. The SMF shall not set the DHCPv4 lease time value higher than the Session-Timeout value. The SMF may renew the DHCP lease to the UE without re-authorization towards the DN-AAA server providing that the new lease expiry is no later than the Session-Timeout timer expiry. If the SMF wishes to extend the lease time beyond the current Session-Timeout expiry, it shall initiate a new AAA re-authorization.
Even if the SMF was not involved in user authentication, it may send a Diameter Accounting-Request (START) message to a DN-AAA server. If no Diameter session is already open for the same PDU session a Diameter session needs to be activated, otherwise the existing Diameter session is used to send the Accounting-Request (START). If accounting is used per QoS flow, the QFI will identify the particular bearer this accounting message refers to. This message contains parameters, e.g. the tuple which includes the user ID and IPv4 address and/or IPv6 prefix, to be used by application servers (e.g. WAP gateway) in order to identify the user, the 3GPP-Charging-Id AVP or 3GPP-Charging-Id-v2 AVP according to the length of the Charging Id for the user session. This message may also (depending on the configuration for the DNN) contains the S-NSSAI and the PDU Session ID that are associated with the PDU Session, respectively in the 3GPP-Session-S-NSSAI AVP and the 3GPP-Session-Id AVP, and/or AF traffic influence PCC rule provisioned and then SMF used DNAI in the 3GPP-DNAI AVP, to a DN-AAA server. This message also indicates to the DN-AAA server that the user session has started.
If some external applications require Diameter Accounting-Request (START) information before they can process user packets, then the selected DNN (SMF) may be configured in such a way that the SMF drops user data until an Accounting-Answer (START) indicating success is received from the DN-AAA server. The SMF may wait for the Accounting-Answer (START) before sending the final authentication response message in Namf_Communication_N1N2MessageTransfer service operation. The SMF may reject the initial access request if the Accounting-Answer (START) is not received. The authentication and accounting servers may be separately configured for each DNN.
For IPv4 PDU type, if IPv4 address is allocated via DHCPv4 signalling between the UE and the DN-AAA after PDU session establishment, the SMF may wait to send the Accounting-Request START message until the UE receives its IPv4 address in a DHCPACK.
When the SMF receives a message indicating a QoS flow or PDU session release request and providing a Diameter Accounting-Request START message was sent previously, the SMF shall send a Diameter Accounting-Request (STOP) message to the DN-AAA server, which indicates the termination of this particular QoS flow or PDU session. The SMF shall immediately send the corresponding response (e.g. Nsmf_PDUSession_UpdateSMContext response) to the AMF, without waiting for an Accounting-Answer (STOP) message from the DN-AAA server.
If the last QoS flow of a PDU session is deactivated, the SMF shall additionally send an STR message to the DN-AAA server. The DN-AAA server shall reply with an STA message and shall deallocate the IPv4 address and/or IPv6 prefix initially allocated to the subscriber.
The following figure 12.2.1-1 is an example message flow to show the procedure of Diameter Authentication and Accounting between an SMF and a DN-AAA server:
1.	UE initiates the PDU Session Establishment procedure, including authentication/authorization information.
2.	The AMF sends Nsmf_PDUSession_CreateSMContext Request including the authentication/authorization information to the SMF and the SMF responds to the service operation.
According to the configuration in the SMF, step 6 to step 9 are executed before step 3 if the SMF needs to send an EAP-Request message to the UE.
In the case of home routed, the AMF sends Nsmf_PDUSession_CreateSMContext Request including the authentication/authorization information to the V-SMF and the V-SMF sends Nsmf_PDUSession_Create Request including the authentication/authorization information to the H-SMF.
3.	If the N4 session has not been established before, the SMF triggers the N4 Session Establishment procedure to the UPF.
In the case of home routed, the V-SMF triggers the N4 Session Establishment procedure to the V-UPF and the H-SMF triggers the N4 Session Establishment procedure to the H-UPF.
4.	The SMF sends the DER message to the DN-AAA via the UPF, the message is forwarded from the SMF to the DN-AAA by the UPF in N4 user plane message.
In the case of home routed, the H-SMF sends the Access-Request message to the DN-AAA via the H-UPF, the message is forwarded from the H-SMF to the DN-AAA by the H-UPF in N4 user plane message.
5-10.	The DN-AAA responds with the DEA message to the SMF via the UPF, the message is forwarded from the DN-AAA to the SMF by the UPF in N4 user plane message. The authentication/authorization information is further transferred to UE via Namf_Communication_N1N2MessageTransfer service and NAS SM Transport message. UE responds to the received authentication/authorization data and such information is transferred in NAS SM Transport message and Nsmf_PDUSession_UpdateSMContext service, then finally sent to the DN-AAA by the SMF, via the UPF, in the DER message.
In the case of home routed, the DN-AAA responds with the Access-Challenge message to the H-SMF via the H-UPF, the message is forwarded from the DN-AAA to the H-SMF by the H-UPF in N4 user plane message. The authentication/authorization information is transferred to V-SMF via Nsmf_PDUSession_Update service and is further transferred to UE via Namf_Communication_N1N2MessageTransfer service and NAS SM Transport message. UE responds to the received authentication/authorization data and such information is transferred in NAS SM Transport message, Nsmf_PDUSession_UpdateSMContext service and Nsmf_PDUSession_Update servic, then finally sent to the DN-AAA by the H-SMF, via the H-UPF, in the Access-Request message.
NOTE:	Step 5 to step 10 can be repeated depending on the authentication/authorization mechanism used (e.g. EAP-TLS).
11.	The SMF receives final result of authentication/authorization from the DN-AAA in the DEA message, via the UPF.
12.	The SMF requests to start accounting by sending the Accounting-Request (START) message to the DN-AAA via the UPF.
13.	The SMF proceeds with the PDU session establishment procedure and includes the authentication/authorization information in Namf_Communication_N1N2MessageTransfer service.
In the case of home routed, the H-SMF proceeds with the PDU session establishment procedure and includes the authentication/authorization information is transferred to V-SMF via Nsmf_PDUSession_Update service and is further transferred to the AMF via Namf_Communication_N1N2MessageTransfer service.
14.	The DN-AAA responds with the Accounting-Response (START) message. The SMF may wait for the Accounting-Response (START) before sending the Namf_Communication_N1N2MessageTransfer request in step 13.
In the case of home routed, the H-SMF may wait for the Accounting-Response (START) before sending the Nsmf_PDUSession_Update service in step 13.
15.	The AMF sends the NAS PDU Session Establishment Request with the authentication/authorization information to the UE.
16.	The UE sends a NAS message Deregistration Request to the AMF.
17.	The AMF sends Nsmf_PDUSession_ReleaseSMContext Request to the SMF and the SMF responds to the service operation.
In the case of home routed, the AMF sends Nsmf_PDUSession_ReleaseSMContext Request to the V-SMF and the V-SMF sends the Nsmf_PDUSession_Release Request to the H-SMF.
18-19. The SMF requests to stop accounting by sending the Accounting-Request (STOP) message to the DN-AAA via the UPF and the DN-AAA responds with the Accounting-Response (STOP) message.
Figure 12.2.1-1: Diameter Authentication and Accounting example (successful case)
When PAP/CHAP is used as the authentication protocol with the external DN-AAA server which does not support EAP for the 5GS or for the 5GC and EPC interworking scenarios, the Diameter Authentication procedures refer to the non transparent access procedures in clause 11.2.1 and related Diameter Authentication descriptions in clause 16a.3a.1 in 3GPP TS 29.061 [5] are reused with the following differences:
-	the SMF SMF+PGW-C performs the actions specified for the P-GW;
-	the external DN-AAA server performs the actions specified for AAA;
-	PDU Session Establishment request is sent from the UE to the SMF or SMF+PGW-C instead of or the Activate PDN connection request being sent from the UE to the S-GW and the Create Session request being sent from S-GW to P-GW;
-	PDU Session Establishment accept is sent from the SMF or SMF+PGW-C to the UE instead of the Create Session Response message being sent from the P-GW to S-GW and the Activate PDN Connection Accept being sent from S-GW to the UE; and
-	PDU Session Establishment reject is sent from the SMF or SMF+PGW-C to the UE instead of the Create Session Response message being sent from the P-GW to the S-GW and the Activate PDN Connection Reject being sent from S-GW to the UE.",TS 29.561,12.2.1,all_images/image_1134.jpeg,Diameter Authentication and Accounting example (successful case)
"When support of Ethernet PDU type data is provided at the N6 interface, the SMF and UPF may support ARP proxying as specified in IETF RFC 1027 [35] and/or IPv6 Neighbour Solicitation Proxying as specified in IETF RFC 4861 [33] functionality. Based on operator configuration, during the PDU session establishment, the SMF may request the UPF acting as the PDU Session Anchor to proxy ARP/IPv6 Neighbour Solicitation or to forward the ARP/IPv6 Neighbour Solicitation traffic from the UPF to the SMF.
Ethernet Preamble, Start Frame Delimiter (SFD) and Frame Check Sequence (FCS) are not sent over 5GS:
-	For UL traffic the UE strips the Preamble, SFD and FCS from the Ethernet frame, those fields shall be added by the UPF acting as the PDU Session Anchor.
-	For DL traffic the UPF acting as the PDU Session Anchor shall strip the Preamble, SFD and FCS from the Ethernet frame.
IP address is not allocated by the SMF to the UE for this PDU Session. The UPF shall store the MAC addresses, received from the UE, and associate those with the appropriate PDU Session.
NOTE 1:	The UE can operate in bridge mode with regard to a LAN it is connecting to the 5GS, thus different MAC addresses can be used as source address of different frames sent UL over a single PDU Session (and destination MAC address of different frames sent DL over the same PDU Session)
NOTE 2:	Entities on the LAN connected to the 5GS by the UE can have an IP address allocated by the external DN, but the IP layer is considered as an application layer which is not part of the Ethernet PDU Session.
NOTE 3:	In this Release of the specification, only the UE connected to the 5GS is authenticated, not the devices behind such UE.
When a PDU Session of Ethernet PDU type is authorized by a DN, the DN-AAA server may, as part of authorization data, provide the SMF with a list of allowed MAC addresses (maximum 16) for this PDU Session. When such a list has been provided for a PDU Session, the SMF sets corresponding filtering rules in the UPF(s) acting as PDU Session Anchor for the PDU Session and the UPF discards any UL traffic that does not contain any of these MAC addresses as a source address.
Figure 14-1: Protocol stacks for Ethernet PDU type data (user plane) for N6 reference point",TS 29.561,14,all_images/image_1135.jpeg,Protocol stacks for Ethernet PDU type data (user plane) for N6 reference point
"When the NSSAAF receives Nnssaaf_NSSAA_Authenticate request from AMF, it shall send a RADIUS Access-Request message with EAP extension to an NSS-AAA server directly or via an AAA-P if AAA-P is involved. The Access-Request message shall include GPSI in Calling-Station-Id or External-Identifier attribute and network slice information in 3GPP-S-NSSAI attribute. Upon receipt of the Access-Request message, the NSS-AAA server shall respond with an Access-Challenge message. Multi-round authentication using the Access-Challenge (sent by NSS-AAA) and Access-Request messages may be used. The NSS-AAA server finally authenticates and authorizes the user and the network slice by replying with an Access Accept message.
For re-authentication and re-authorization, the NSSAAF shall send a RADIUS Access-Request message with EAP extension to the NSS-AAA server directly or via the AAA-P if AAA-P is used and the NSS-AAA shall respond with an Access-Challenge message. Multi-round authentication using the Access-Challenge (sent by NSS-AAA) and Access-Request messages may be used. The NSS-AAA server finally authenticates and authorizes the user and the network slice by replying with an Access Accept message.
The following figure 16.2.1-1 is an example message flow to show the procedure of RADIUS Authentication and Authorization between an AMF and a NSS-AAA server:
1.	AMF decides to trigger the start of the Network Slice Specific Authentication and Authorization procedure.
2.	The AMF may send an EAP Identity Request in a NAS Network Slice-Specific Authentication Command message.
3.	The UE provides the EAP Identity Response in a NAS Network Slice-Specific Authentication Complete message towards the AMF.
4. The AMF sends Nnssaaf_NSSAA_Authenticate Request to the NSSAAF including the authentication/authorization information.
5-6.	If the AAA-P is present (e.g. because the NSS-AAA belongs to a third party and the operator deploys a proxy towards third parties), the NSSAAF sends the Access-Request message to the NSS-AAA via the AAA-P to forward the authentication/authorization information, otherwise the NSSAAF sends the Access-Request message directly to the NSS-AAA.
7-14.	The NSS-AAA responds with the Access-Challenge message to the NSSAAF directly or via the AAA-P. The authentication/authorization information is further transferred to UE via AMF by Nnssaaf_NSSAA_Authenticate service and NAS Network Slice-Specific Authentication Command message. UE responds to the received authentication/authorization data and such information is transferred in NAS Network Slice-Specific Authentication Complete message and Nnssaaf_NSSAA_Authenticate service, then finally sent to the NSS-AAA by the NSSAAF, via the AAA-P if the AAA-P is used, in the Access-Request message.
NOTE:	Step 7 to step 14 can be repeated depending on the authentication/authorization mechanism used (e.g. EAP-TLS).
15-16. If the AAA-P is used, the NSS-AAA sends a Access-Accept message with the final result of authentication/authorization to the NSSAAF via the AAA-P, otherwise the NSS-AAA sends the Access-Accept message directly to the NSSAAF.
17.	The NSSAAF sends a Nnssaaf_NSSAA_Authenticate Response with the final result of authentication/authorization information to the AMF.
18.	The AMF transfers the final result of authentication/authorization information in a NAS Network Slice-Specific Authentication Result message to the UE.
Figure 16.2.1-1: Network slice specific authentication and Authorization procedure (RADIUS)",TS 29.561,16.2.1,all_images/image_1136.jpeg,Network slice specific authentication and Authorization procedure (RADIUS)
"For network slice specific authentication and authorization, when the NSSAAF receives Nnssaaf_NSSAA_Authenticate request from AMF, it shall send a Diameter DER message with GPSI in Calling-Station-Id or External-Identifier attribute and network slice information in 3GPP-S-NSSAI attribute to a NSS-AAA server directly or via AAA-P if AAA-P is involved. Upon receipt of the DER message, the DN-AAA server shall respond with an DEA message. Multi-round authentication using the DEA and DER messages may be used. The NSS-AAA server finally authenticates and authorizes the user and the network slice by replying with a Diameter DEA message.
For re-authentication and re-authorization, the NSSAAF shall send a DER message to the NSS-AAA server directly or via AAA-P if AAA-P is used and the NSS-AAA server shall respond with a DEA message. Multi-round authentication using the DEA and DER messages may be used. The NSS-AAA server finally authenticates and authorizes the user and the network slice by replying with a Diameter DEA message.
If the network slice specific authentication is not required, the NSSAAF shall send a Diameter STR message to the NSS-AAA server directly or via AAA-P if AAA-P is involved. The NSS-AAA server shall reply with a Diameter STA message.The following figure 17.2.1-1 is an example message flow to show the procedure of Diameter Authentication and Authorization between an AMF and a NSS-AAA server:
1.	AMF decides to trigger the start of the Network Slice Specific Authentication and Authorization procedure.
2.	The AMF may send an EAP Identity Request in a NAS Network Slice-Specific Authentication Command message.
3.	The UE provides the EAP Identity Response in a NAS Network Slice-Specific Authentication Complete message towards the AMF.
4. The AMF sends Nnssaaf_NSSAA_Authenticate Request to the NSSAAF including the authentication/authorization information.
5-6.	If the AAA-P is present (e.g. because the NSS-AAA belongs to a third party and the operator deploys a proxy towards third parties), the NSSAAF sends the DER message to the NSS-AAA via the AAA-P to forward the authentication/authorization information, otherwise the NSSAAF sends the DER message directly to the NSS-AAA.
7-14.	The NSS-AAA responds with the DEA message to the NSSAAF directly or via the AAA-P. The authentication/authorization information is further transferred to UE via AMF by Nnssaaf_NSSAA_Authenticate service and NAS MM Transport message. UE responds to the received authentication/authorization data and such information is transferred in NAS Network Slice-Specific Authentication Complete message and Nnssaaf_NSSAA_Authenticate service, then finally sent to the NSS-AAA by the NSSAAF, via the AAA-P if the AAA-P is used, in the DER message.
NOTE:	Step 7 to step 14 can be repeated depending on the authentication/authorization mechanism used (e.g. EAP-TLS).
15-16. If the AAA-P is used, the NSS-AAA sends a DEA message with the final result of authentication/authorization to the NSSAAF via the AAA-P, otherwise the NSS-AAA sends the DEA message directly to the NSSAAF.
17.	The NSSAAF sends a Nnssaaf_NSSAA_Authenticate Response with the final result of authentication/authorization information to the AMF.
18.	The AMF transfers the final result of authentication/authorization information in a NAS Network Slice-Specific Authentication Result message to the UE.
Figure 17.2.1-1: Network slice specific authentication and Authorization procedure (Diameter)",TS 29.561,17.2.1,all_images/image_1137.jpeg,Network slice specific authentication and Authorization procedure (Diameter)
"L2TP (described in IETF RFC 2661 [57]) is a standard method for tunneling encapsulated Point-to-Point Protocol (PPP) frames over an IP network. L2TP operates between two L2TP endpoints (LAC and LNS), and tunnels PPP-encapsulated IP traffic between these endpoints. L2TP runs over UDP/IP and was originally defined for systems where PPP is used by an end-device to connect to a network (e.g. via DSL connections, or 2G/3G PPP PDP context). In these cases, a LAC could be deployed in the network (e.g. in a BNG or GGSN/PGW) to tunnel the PPP traffic to a server (LNS) over an IP network.
For 5GC with the UE using IP PDU Session, the PPP functionality that is required to use L2TP is instead supported by the UPF or UPF+PGW-U, as illustrated in below figure. Upon receiving a PDU Session/PDN Connection establishment request from the UE via AMF or MME, SMF or SMF+PGW-C may depend on local L2TP configuration per DNN or the received L2TP information from a DN AAA server in Access-Accept message, request the UPF or UPF+PGW-U to setup L2TP tunnel towards an L2TP network server (LNS) in the external DN and tunnel the PDU Session user plane traffic in this L2TP tunnel. In this case the UPF or UPF+PGW-U acts as a L2TP access concentrator (LAC).
To enable this, the SMF or SMF+PGW-C may provide L2TP information to the UPF or UPF+PGW-U as LAC, such as LNS IP address or FQDN, as described in 3GPP TS 29.244 [58]. This L2TP information may be configured on the SMF or SMF+PGW-C as part of the DNN configuration or received from the DN-AAA server. Alternatively, the L2TP tunnel parameters may be configured in the UPF or UPF+PGW-U. The L2TP tunnel parameters include necessary parameters for setting up L2TP tunnel towards the LNS (e.g. LNS address, tunnel password).
In addition, the SMF or SMF+PGW-C may provide PAP/CHAP authentication information to the UPF or UPF+PGW-U, for use in L2TP session establishment, in case it was received from the UE in the ePCO IE of the PDU Session Establishment Request.
When L2TP is to be used for a PDU Session, the SMF or SMF+PGW-C may select a UPF or UPF+PGW-U and requests the UE IP address to be allocated by LNS according to 3GPP TS 29.244 [58], the UPF (LAC) may retrieve this IP address from the LNS.
Figure 18.1-1: L2TP Tunnel between 5GC and external DN
Below figure describes the L2TP connection procedures between 5GC and external DN, upon the UE is accessed in 5GC and the SMF or SMF+PGW-C and UPF or UPF+PGW-U has been negotiated supporting L2TP feature.
Figure 18.1-2: L2TP connection procedures between 5GC and external DN
0.	The SMF or SMF+PGW-C and the UPF or UPF+PGW-U negotiated supporting L2TP feature as specified in 3GPP TS 29.244 [114].
1.	The SMF or SMF+PGW-C receives a PDU Session or PDN Connection establishment request from the UE via AMF or MME and SGW.
The UE may include the authentication information for PAP and/or CHAP in ePCO IE. The SMF or SMF+PGW-C may locally configure the UE authentication information for a given DNN.
The SMF or SMF+PGW-C may determine that an L2TP session is required for the PDU Session based on local configured L2TP parameters per DNN.
2.	The SMF or SMF+PGW-C may receive the L2TP Tunnel parameters (e.g. LNS IP address or FQDN, tunnel password) from the DN-AAA server in Access-Accept message or Diameter AAA message, or local configured.
NOTE:	If EAP based secondary authentication is used (e.g. DER/DEA), L2TP Proxy Authenticate Extensions for EAP is not supported in this release of the specification.
3.	If L2TP protocol is determined to support the PDU Session, the SMF or SMF+PGW-C selects a UPF or UPF+PGW-U supporting L2TP and be configured with the LAC name/addresses and then requests the UPF or UPF+PGW-U to setup an L2TP tunnel if needed and/or L2TP session towards the L2TP network server (LNS).
The SMF or SMF+PGW-C sends PFCP Session Establishment Request to the UPF or UPF+PGW-U, which may include L2TP Tunnel Information for setting up a L2TP tunnel and L2TP session information to setup a L2TP session, together with the information for authentication used during L2TP Tunnel setup, as well as for L2TP session.
The L2TP Tunnel Information includes LNS IPv4 address or IPv6 address of LNS, Tunnel Password.
The L2TP Session Information includes specific information related to the PDU Session, e.g. a Calling Number which may be set to UE's GPSI, an indication to instruct that the UPF or UPF+PGW-U shall request the LNS to allocate an IP address for the PDU Session, indications to instruct that the UPF or UPF+PGW-U shall request the LNS to provide DNS server addresses or NBNS server addresses etc. as specified in 3GPP TS 29.244 [114].
4.	The UPF or UPF+PGW-U checks if any existing L2TP tunnel can be used to serve the PDU Session according to the information provided in the L2TP Tunnel Information.
If the UPF or UPF+PGW-U decides to setup a new L2TP tunnel, it initiates L2TP Tunnel establishment by sending an SCCRQ (Start-Control-Connection-Request) message towards the LNS, the UPF or UPF+PGW-U will allocate a Tunnel ID, and it may include a CHAP Challenge to authenticate the LNS. The Challenge and Challenge Response (to be included in SCCCN) is produced by the UPF or UPF+PGW-U using the Tunnel Password received from the SMF or SMF+PGW-C.
The LNS responds with an SCCRP (Start-Control-Connection-Reply) message, containing its allocated Tunnel ID and a CHAP Challenge Response to the Challenge in SCCRQ.
The UPF or UPF+PGW-U then responds with a Challenge response for tunnel authentication in the SCCCN (Start-Control-Connection-Connected) message. An L2TP tunnel is established after the tunnel authentication is successful, with the reception of the SCCCN message sent by the LAC to the LNS.
If the UPF or UPF+PGW-U decides to use an already existing L2TP tunnel for the requested PDU Session from the UPF or UPF+PGW-C, it proceeds with step 8 below directly without current step.
5.	If the L2TP tunnel is not successfully established, then the UPF or UPF+PGW-U may respond to the SMF or SMF+PGW-C  with PFCP Session Establishment Response with error cause IE value set to either 87 or 89 as specified in clause 8.2.1 of TS 29.244 [114]. The SMF, SMF+PGW-C may decide how to handle the failure associated with the received cause code based on local policy and/or O&M procedures.
6.	SMF or SMF+PGW-C may reject the PDU Session/PDN Connection Establishment Request according to step 5.
7.	Once the L2TP Tunnel is established (or already present) between the LAC and the LNS for the PDU Session/PDN Connection requested by the UE, the UPF or UPF+PGW-U proceeds with L2TP session setup towards the LNS.
The UPF or UPF+PGW-U sends an ICRQ (Incoming-Call-Request) message towards the LNS, which contains the Tunnel ID assigned by the LNS, its assigned Session ID, and optionally, the Calling Number and Called Number. The LNS responds with an ICRP (Incoming-Call-Reply) message and provides the Session ID assigned by it to the LAC.
The LAC then sends an ICCN (Incoming-Call-Connected) message. If proxy LCP and authentication are employed, the ICCN message includes link control parameters (e.g. MRU) and the UE authentication information sent from the SMF or SMF+PGW-C which was received via ePCO IE in step 1. In addition, the UPF or UPF+PGW-U (LAC) will act as a PPP endpoint to use IPCP to request UE IP Address, DNS server address and/or NBNS server address(es).
The LCP renegotiation may by triggered by the LNS after receiving the ICCN message. If so, the LAC and LNS will use PPP LCP to communicate link specific control parameter, and indicate authentication type, then either PPP PAP/CHAP takes place. The PPP IPCP transactions takes places to retrieve UE IP Address, DNS server address and/or NBNS server address.
8.	The status of the L2TP session setup is sent by the UPF or UPF+PGW-U to the SMF or SMF+PGW-C  in a PFCP Session Establishment Response.
9.	The SMF or SMF+PGW-C sends a PDU Session Establishment Response to the UE and the user data session is initiated, which may contain the DNS and NBNS Server information.",TS 29.561,18.1,all_images/image_1138.jpeg,L2TP connection procedures between 5GC and external DN
"The flows for 5G connection and mobility charging would be the same as in clause 5.2.2.5 of TS 32.256 [5], with the exception that the there is no need to interact with the home PLMN’s CHF and that only PEC is required. The CDRs generated in the CHF in VPLMN would in this case be used as input to the wholesale charging of the HPLMN. The following figure 7.1.4.2.2-1 describes a Registration charging message flow in PEC in VPLMN scenario for roaming, based on figure 4.2.2.2.2-1 of TS 23.502 [6] description
Figure 7.1.4.2.3-1: Roaming Registration – PEC in VPLMN
1-20a.	Registration procedure initiated by UE per steps 1 to 20a of figure 4.2.2.2.2-1 of TS 23.502 [6], with PCF, AUSF and UDM in HPLMN.
21.	Upon successful procedure, Registration Accept sent to the UE.
21ch-a. The AMF in VPLMN sends Charging Data Request [Event] to the CHF in VPLMN for the UE successful registration, indicating ""roamer in"".
21ch-b. The CHF in VPLMN creates the CDR for this registration.
21ch-c. The CHF in VPLMN acknowledges by sending Charging Data Response [Event] to the AMF in VPLMN.
21b to 24. Same steps as in figure 4.2.2.2.2-1 of TS 23.502 [6].",TR 28.827,7.1.4.2.3,all_images/image_1142.jpeg,Roaming Registration – PEC in VPLMN 
"For local breakout roaming, the flows for 5G data connectivity charging are present as the following figure 7.1.4.3.3-1.
Figure 7.1.4.3.3-1: Local breakout roaming for 5G data connectivity charging
1-3a.	UE initiates a new PDU session. V-SMF selection by the AMF.
4ch-a. The UE is identified as a roamer (PLMN ID of the received SUPI is different from VPLMN PLMN ID), the V-CHF is selected accordingly. A Charging Data Request [Initial, Roaming Charging profile] is sent to V-CHF, indicating ""in-bound roamer"".
4ch-b. The V-CHF opens a CDR (indicating ""in-bound roamer"")
4ch-c. The V-CHF acknowledges by sending Charging Data Response [Initial, Roaming Charging profile] to the V-SMF.
7ch-a. A Charging Data Request [Update] is sent to V-CHF with charging information received from V-SMF.
7ch-b. The V-CHF updates the CDR.
7ch-c. The V-CHF acknowledges by sending Charging Data Response [Update] to the V-SMF.
10ch-a. A Charging Data Request [Termination] is sent to V-CHF.
10ch-b. The V-CHF closes the CDR
10ch-c. The V-CHF acknowledges by sending Charging Data Response [Termination] to the V-SMF.
Step 5, Step 8 and Step 11 are detailed in Figure 7.2.4.2.1-2 clause 7.2.",TR 28.827,7.1.4.3.3,all_images/image_1143.png,Local breakout roaming for 5G data connectivity charging 
"Figure 4.2-1 depicts a procedure that describes how the 3GPP NF performanc measurements related VR threshold crossing notification is generated. If the threshold is created to monitor a performance measurement directly without association with a PM job, then step 1 to 4 are not needed:
1.	NM sends a request to EM to create a measurement job (see clause 7.3.1 of [2]) to collect the 3GPP NF performanc measurements related VR. The job is defined by the parameters, such as iOCName and iOCInstanceList … etc. as listed in clause 7.3.1.2 of [2].
2.	EM sends a request with sourceSelector, performanceMetric, performanceMetricGroup, collectionPeriod, reportingPeriod, reportingBoundary (see clause 7.6.2.2 of [3]), to VNFM to create a PM job to collect VNF/VNFC PM data related to VR.
3. VNFM sends a response with pmJobId (see clause 7.6.2.3 of [3]) to EM to indicate the PM job that has been created.
4. EM sends a response to NM with jobId that is mapped from pmJobId, and status = Success (see clause 7.3.1.3 of [2]).
5.	NM sends a request to EM to create thresholds (see clause 7.4.1 of [2]) that are defined by parameters, such as iOCName, iOCInstanceList, and thresholdInfoList (see clause 7.4.1.2 of [2]) to monitor the 3GPP NF performance measurements related VR.
6. EM sends a request to VNFM with sourceSelector, performanceMetric, thresholdType, thresholdDetails (see clause 7.6.7.2 of [3]), to create the thresholds for monitoring the measurement types specified in sourceSelector.
7. VNFM sends a response to EM with thresholdId (see clause 7.6.7.3 of [3]) to indicate the identifiers of thresholds that have been created.
8. EM sends a response to NM with monitorId, and status = Success (see clause 7.4.1.3 of [2]).
9.	NM sends a request to EM to subscribe the 3GPP NF performance measurements related VR threshold crossing notification (see clause 6.3.1 of [4]).
10.	EM sends a request with filter (see clause 7.6.4.2 of [3]) to VNFM to subscribe the VNF/VNFC performance information related VR threshold crossing notification.
11.	VNFM sends a response with subscriptionId (see clause 7.6.4.3 of [3]) to EM to indicate the notification subscription that has been subscribed.
12.	EM sends a response to NM to indicate that the 3GPP NF performance measurements related VR threshold crossing notification has been subscribed (see clause 6.3.1 of [4]).
13.	VNFM sends a notification with thresholdId, crossingDirection, objectInstanceId, performanceMetric, performanceValue (see clause 9.7.9.3 of [3]) to EM to indicate the threshold identified by objectInstanceId has been crossed.
14.	EM sends a notification with the object instance ID to NM to indicate that the threshold identified by object instance has been crossed.
Figure 4.2-1: 3GPP NF performance measurements related VR threshold crossing notification procedure",TS 28.521,4.2,all_images/image_1155.png,3GPP NF performance measurements related VR threshold crossing notification
"Traditional energy saving (ES) solutions include centralized energy saving solution and distributed energy saving solution. These solutions are mainly targeting for the scenarios illustrated as Figure 5.1.3.2.1-1 NR capacity booster cell partially overlaid by candidate cells and Figure 5.1.3.3-1 gNB capacity booster cell fully overlaid by candidate cell(s), see TS 28.310 [12]. No specific consideration for the case of area based ES which means there are multiple capacity booster cells in the area to consider ES at the same time as a whole so far.. Considering ES from an area aspect would be beneficial for improving ES efficiency and effect. For example, see figure 4.7.1-1, separate cell activation/deactivation decisions for capacity cell B1, B2 and B3 may lead to Ping-Pong activation/deactivation effect on the related cells (i.e. some capacity cells and coverage cells) in an area in some special cases.. Figure 4.7.1-1: Example of area based energy saving. This key issue studies whether and how to support an area based ES which means there are multiple capacity booster cells in the geographical area to consider ES as a whole. In particular, this KI addresses:. -	How does 3GPP management system divide the managed network into appropriate areas? For example, suppose there are 1 000 capacity booster cells in the whole managed network, the 3GPP management system needs to divide the 1 000 capacity booster cells into different geographical areas, and in each of the allocated ES area there are corresponding capacity booster cells and coverage cells to improve ES efficiency and effect.. -	How does 3GPP management system decide the activation/deactivation on the related cells inside each ES area?",TR 28.813,4.7.1,all_images/image_1162.jpeg,Example of area based energy saving
"Figure 4.7.2.1.2-1 describes the 3GPP management system provides centralized ES for RAN domain area:. Figure 4.7.2.1.2-1: 3GPP management system provides centralized ES for RAN domain area. In this figure:. -	RAN Network Function (NF) corresponds to RAN domain area in which there are multiple capacity booster cells and coverage cells which provide basic coverage for the whole area.. -	To provide centralized ES for RAN domain area, 3GPP management system performs the following functionalities:. -	Monitoring: 3GPP management system, for ES purpose, collects the information of the capacity booster cells and coverage cells inside the RAN domain area, which may include current load information, historical load information which was logged, cell priority information, or traffic service type information of the capacity booster cells and coverage cells. Other than traditional ES solutions which consider the capacity booster cells and their first-level (direct) neighboring cells as candidate cells for ES, to provide centralized ES for RAN domain area, 3GPP management system considers capacity booster cells with their multiple-level neighboring cells as candidate cells for ES. The first-level neighboring cell is the direct neighboring cell of source cell, the second-level neighboring cell is the direct neighboring cell of the first-level neighboring cell of source cell, etc.. -	Analysis and Decision: For capacity booster cells and coverage cells in the area, based on the monitoring information of current load information, historical load information, cell priority information, or traffic service type information of those cells, 3GPP management system makes the analysis and decision for ES based on the full view of the corresponding cells in the area.. - For example, neighboring cells of capacity booster cell B3 are cell B2, A12, A20, A21, A30 and A31. A21 is first-level neighbor of B3. A20, A31 and B2 are first-level neighbours of A21 and are therefore second-level neighbours of B3. A30 and A12 are third-level neighbours of B3. Based on the historical load information, cell priorities, or traffic service types of those neighboring cells B2, A12, A20, A21, A30 and A31, 3GPP management system may determine the ES candidate cells of B3 are cells B2, A20, A21 and A31. At moment T1, the capacity booster cell B3 is in low load state and may be qualified for 3GPP management system to determine to enter into energy saving state. However, according to analysis of the historical load information of the candidate capacity booster cell B2, 3GPP management system concludes that cell B2 will also be in a low load state shortly after T1. In this case, 3GPP management system determines whether or not to allow energy saving for cell B2 and cell B3 based on the analysis of historical load information, current load status, priority or traffic service type of corresponding candidate cells A20, A21 and A31. As an example, in case the 3GPP management system estimates that, according to historical load information of cell A21, the load of cell A21 will soon increase high at moment T3 which is shorter after moment T2 which is between moment T1 and T3, the decision from the 3GPP management system regarding the allowing energy saving of cell B2 and B3 may vary including one of the following cases:. 1)	Only cell B2 is allowed to enter into the energy saving state and no energy saving of cell B3. In this case, cell B3, A20, or A31 provides network services for some UEs from the high load cell A21 at T3.. 2)	Only cell B3 is allowed to enter into energy saving state. In this case, cell B2, A20 or A31 provides network services for some UEs from the high load cell A21 at T3.. 3)	Both cell B2 and cell B3 enter into energy saving state. In this case, cell A20 or A31 provides network services for some UEs from the high load cell A21 at T3.. 4)	Both cell B2 and cell B3 do not enter into the energy saving state. In this case, cell B2 and cell B3 need to provide network services for some UEs from the high load cell A21 at T3.. -	Execution: 3GPP management system decides the activation and/or deactivation on the related cells inside RAN domain area. For example, see figure 4.7.2.1.2-1, coordinated cell activation/deactivation decisions made from 3GPP management system for capacity cell B1, B2 and B3 avoids Ping-Pong ES activation/deactivation effect on the related cells (i.e. some capacity cells of B1, B2 and B3 and corresponding coverage cells) in the RAN domain area.. -	Evaluation: 3GPP management system evaluates whether the ES actions have been optimized, and may apply further ES management actions.. By introducing AI (Artificial Intelligence) technology, 3GPP management system can provide centralized ES for RAN domain area with following improvements while keeping KPIs (e.g. RRC connections setup success rate, E-RAB setup success rate, Handover success rate, UE throughput) stable:. -	ES in more areas: ES can be applied to more areas in a network depending on various situations, more cells can be decided as candidate ES cells.. -	ES in more accurate time periods: based on historical traffic data and predicted traffic data, more accurate time periods for cell energy saving can be decided.. Figure 4.7.2.1.2-2, as an example, shows 3GPP management system providing additional ES periods with adaptive AI ES threshold setting comparing with manual ES threshold setting:. Figure 4.7.2.1.2-2: Additional ES periods by adaptive ES threshold setting with AI. In this figure:. With AI technology, 3GPP management system can set different ES thresholds for different cells in the ES targeting area adaptively. Using cell PRB usage as an example for traffic load threshold for ES, comparing with manual PRB usage threshold setting, additional ES time periods, as the result of more accurate PRB usage threshold setting from AI, can be identified to save more energy for the cells while keeping basic KPIs stable for SLA assurance.",TR 28.813,4.7.2.1.2,all_images/image_1163.jpeg,Additional ES periods by adaptive ES threshold setting with AI
"An Intent driven MnS allows its consumer to express desired intent for managing the network and services. The Intent driven MnS producer paraphrases the intent to executable actions for service assurance and deployment.. The executable actions can be one or more of the following:. -	Perform network management tasks. -	Identifying, formulating and activating network management policies. The following figure 4.1.2.1-1 shows the model elements of the MnS and usage of the Intent driven MnS between consumer and producer. Figure 4.1.2.1-1: Model elements of MnS and Intent driven MnS. The combination of management service components (see subclause 4.3 in TS 28.533 [6]) for Intent driven MnS is described as follows:. -	MnS component type A, the operations and/or notifications agnostic of specified intent type, for example, a generic operation to transfer intent from Consumer to Producer.. -	MnS component type B, the model of intent, which is used to modelling the intent expression information described in clause 4.1.3. As examples described in clause 4.1.3, the intent driven model may include 'Action' and 'Object'.. -	MnS component type C, performance information and fault information related to the intent. The MnS of various kinds are specified for deployment over many standardized reference interfaces. So, the Intent driven MnS could in principle, be specified for deployment over the same set of standardized reference interfaces, as a replacement of or as an addition to the deployed MnS, where the consumer focuses on the 'what' and the producer is concerned about the 'how'.. The following figure 4.1.2.1-2 shows an example using Intent driven MnS to provision a service.. Figure 4.1.2.1-2: An example of using Intent driven management service for network provisioning",TR 28.812,4.1.2.1,all_images/image_1164.jpeg,Model elements of MnS and Intent driven MnS
"The Intent driven MnS producer may utilize management closed-loop automation mechanisms (e.g. continuously monitor the intent fulfilment status, analyse the service and network information and meet the intent automatically etc.). The closed-loop automation mechanisms to achieve the intent are the implementation of the producer and are not standardized. The closed-loop automation of Intent driven MnS Producer is shown in the figure 4.3-1.. For example, to satisfy the Intent-NOP for NEP, after Intent-NOP MnS Producer translates the received intent to network equipment management requirements, the Intent-NOP MnS Producer may continuously monitoring the intent fulfilment status, making analysis and adjust the network automatically to meet the intent requirements. Some SON automatic mechanisms could be reused by the producer if needed.. Figure 4.3-1: Closed-loop automation of Intent driven MnS producer",TR 28.812,4.3,all_images/image_1169.jpeg,Closed-loop automation of Intent driven MnS producer
"A policy is a function that governs the choices in behavior of a system. It specifies the action(s) to be taken when specified condition(s) occur. See IETF RFC 3198 [7] for details about definition and terminologies for policy driven management.. An intent defines to what position (in what state) the consumer wants as specific entity to be. The necessary steps to get to this position is not defined by the intent but by policy.. The relation between the policy driven management (rule based) and intent driven management is shown in the figure below.. Figure 4.4-1: Intent driven management vs Policy driven management. This figure describes the ""What-How"" view. As it now stands, the systems are mainly focused on ""How"" and ""less What"". The networks like 5G brings more operational complexities, which is driving systems to shift the focus from ""How"" to ""What"". The first step towards that shift, has been ""Policy driven management"", with more focus on ""How"" and less on ""What"" covering domain specific issues/aspects. As technologies are evolving and the level of complexity exceeds, the need for an abstraction level (Intent) becomes more apparent. An intent driven system will be able to learn the behavior of networks and services and allows an operator to provide the desired state, without detailed knowledge of how to get to the desired state.",TR 28.812,4.4,all_images/image_1170.jpeg,Intent driven management vs Policy driven management
"An NSI which includes CN part and RAN part is created, taking into account the specific characteristics of the satellite RAN.",TR 28.812,5.1.1.3,all_images/image_1171.jpeg,Enable MBB Service to Priority Customers
"The NSI consumer as performance assurance MnS consumer expresses his intent for a NSI performance assurance (e.g. high-level abstraction of the SLA for performance assurance, granularity of performance assurance report notifications, etc.) to performance assurance MnS Producer. The NSI consumer does not care about what the details of mechanisms to assure the performance.. The MnS Producer translates the intent from the MnS consumer to the implementable NSI performance assurance related requirements and provisions target resources, deploy performance monitoring management services, and perform periodic optimization operations to ensure the target KPIs through the associated performance assurance related management services. It also generates performance assurance reports and notifies to the MnS consumers.. All implementable NSI performance assurance related requirements and associated procedures are defined in TS 28.531 [2], 28.550 [3], 28.552 [4], 28.554 [5].. Figure 5.2.4.2-1: An example of intent driven NSI performance assurance scenario",TR 28.812,5.2.4.2,all_images/image_1173.jpeg,An example of intent driven NSI performance assurance scenario
"A NOP operates a 5G network.
The 5G network as operated by the NOP satellite RAN supporting NR",TR 28.812,5.3.2.2,all_images/image_1175.jpeg,An example of area load balance scenario
"Due to some user complaint information received, the operator as MnS Consumer expresses his intent that the network in the specified area needs to be optimized to satisfy certain user experience related performance requirements (e.g. the percentage of users with low experienced data rate (e.g. < 5 Mbps) should be less than certain value (e.g. 1 %), the average experienced data rate should be greater than 7 Mbps).. Based on the intent received, the MnS Producer detects the potential network issues which lead to this poor user experience related performance requirements (e.g. low experienced data rate (e.g. < 5 Mbps)), for example, the handover is happened frequently between some neighbour Cells, some weak coverage area with large number of users, etc.. The MnS Producer decides the network optimization method (e.g. CCO, HO, machine learning, etc) to be used and derives the corresponding requirements (e.g. policy for HO) for the selected network optimization method. For example, MnS Producer decide to trigger coverage and capacity optimization to enhance the coverage for the weak areas and trigger the handover optimization to reduce the frequency of handover between certain neighbour Cells. Another example, MnS producer may configure admission control policies for the RAN Node(s) in the specified area to ensure the user experience related performance requirements.. MnS Producer adjust and monitor the network iteratively until the specified user experience related performance requirements are satisfied.. MnS Producer may notify the MnS Consumer the fulfilment information of the network optimization intent (e.g. fulfil or not, percentage of users with low experienced data rate in the specified area).. Figure 5.3.5.2-1: An example of utilizing user experience related performance requirements for network optimization scenario",TR 28.812,5.3.5.2,all_images/image_1176.jpeg,An example of utilizing user experience related performance requirements for
"Area based deployment scenario is a potential deployment scenario for which the intent driven management can be applied. In this deployment scenario, the operator's network can be divided into several areas and managed based on area granularity. The network equipment in one area are from one producer. MnS Producer who is responsible for management of network in the specified area is responsible for the closed loop automation in this area. One MnS Producer can manage network in one or multiple area(s).. In an Intent driven management service, the consumer, expresses the intent for the specified area to the MnS Producer which is responsible for this network management in this area. MnS Producer translates the intent for the specified area to the detailed management tasks for managed network equipment's in this specified area, and continuously monitor the managed network equipment to ensure the intent.. The intent for area-based deployment scenario can either be:. -	""Provisioning of the network in a specified area with some area network characteristics (e.g. provisioning radio access network in the specified area with specified frequency, user experience throughput, user number, isolation requirements)"", or ""Enabling certain service in the specified area for certain user group (e.g. enable V2X service for enterprise A in the area X)"".. -	""Optimization of the network in a specified area with some area optimization target (e.g. Load Balance in the area X, Admission control in the area X with admission control requirements)"".. Figure 5.3.9-1: Example of intent driven management for area based deployment scenario",TR 28.812,5.3.9,all_images/image_1180.jpeg,Example of intent driven management for area based deployment scenario 
"1.	Intent driven MnS Consumer deliver the following area load balance intent to Intent driven MnS Producer.. Intent expression information is illustrated in the following table:. Table 6.4.1-1: Content for area load balance intent. The load information specifying which load information needs to be balanced may be specified in the intent, load information can be PRB usage, user number or other load information.. 2.	When received the area load balance, Intent driven MnS Produce may execute the following management tasks:. Figure 6.4.1-1: Example of Intent driven MnS Producer utilizing LBO to satisfy AreaLoadBalance Intent. 2.1	Intent driven MnS Producer analyses information for all Cells in the specified area and identify overlapping coverage, hierarchical coverage and neighbouring overage Load Balance scenarios for Cells as described in clause 5.4.1 in TS 28.627.. 2.2 Intent driven MnS Producer analyses load balancing allowed/prohibited from each cell to other cells as described in clause 6.4.2 in TS 28.627, and configures all corresponding SON Control Function IOC instance (which is name contained by ManagedFunction) with lboSwitch attribute to enable switching on all necessary LBO Functions. Intent driven MnS Producer may create new SON Control Function IOC instance.. 2.3 For each identified LBO Function instance needed, Intent driven MnS Producer analyses and decides corresponding SON target IOC related to LBO Function for each related cell (e.g. EutranGenericCell, NRCellCU), SON target IOC for LTE is defined in clause 5.3.1 in 3GPP TS 28.628[13]. Intent driven MnSmay create corresponding LBO Function IOC instances or reconfigure existing LBO Function IOC instance.. 2.4 Intent driven MnSProducer analyses and configures the SON coordination policies IOC for different LBO Function instances, and also SON coordination policies for LBO Function instance with other SON Function instances. SONCoordinationPolicies IOC is defined in 3GPP TS 28.628[13].. 2.5 Intent driven MnSProducer may do other analysis and management tasks to fulfil the intent.. 3.	Intent driven MnSProducer continuously collect performance measurements defined in clause 4.2.5 in 3GPP TS 28.628 [13] to evaluate the effect for each LBO Function instances, then evaluate the effect for area load balance intent based on the evaluation for each LBO Function instance. If the area load balance cannot be satisfied, Intent driven MnSProducer may execute step 2 recursively to ensure the area load balance fulfilled.. 4. Intent driven MnSProducer may notify Intent driven MnSConsumer about the fulfil information of area load balance during intent execution.",TR 28.812,6.4.1,all_images/image_1181.jpeg,Example of Intent driven MnS Producer utilizing LBO to satisfy AreaLoadBalance
"Cell Rehoming scenario (i.e. re-home a selected Cell from source RAN Node to destination RAN Node) is described in clause 5.3.1. So following procedure illustrates the solution for cell rehoming.. 1.	Intent driven MnS Consumer delivers the following cell rehoming intent to Intent driven MnS Producer. Cell Rehoming intent information is illustrated in the following table:. Table 6.4.2-1 Content for Cell Rehoming intent. 2.	When receive the cell rehoming intent, Intent driven MnS Producer may execute several management tasks to satisfy the intent. Following is an example:. 2.1	Intent Driven MnS Producer analyses the received cell rehoming intent and configuration information of the corresponding MOIs (e.g. Cell MOI and corresponding child MOIs, ExternalCellMOI(s), CellRelationMOI(s)).	2.2	Intent Driven MnS Producer creates a new MOI tree of rehomed cell (i.e. rehomed Cell MOI and its child MOI(s)) contained by destination RAN Node MOI, and configure these MOI(s) with same attributes captured in the original MOI tree.. 2.3	Intent Driven MnS Producer modify existing CellRelation IOC (which associated to rehomed Cell MOI) contained in tree of source and destination RAN Node MOIs to the new created rehomed Cell MOI.. 2.4	Intent Driven MnS Producer modify existing CellRelation IOC (which associated to rehomed Cell MOI) contained in tree of other RAN Node MOI(s) to the new created rehomed Cell MOI.. 2.5	Intent Driven MnS Producer delete existing MOI tree of rehomed cell contained by the source RAN Node MOI.. 2.6 Intent Driven MnS Producer may do other analysis (e.g. PCI collision analysis) and management tasks to fulfil the cell rehomed intent.. 3. Intent Driven MnS Producer may notify Intent Driven MnS Consumer about the fulfil information of cell rehoming intent during intent execution.. Figure 6.4.2-1 shows a simple example of cell rehoming scenario (which MOI tree only contains two ENBFunction MOIs, three EUtranGenericCell(s) and EUtranRelationMOI(s)), in real deployment scenario, the MOI tree is more complex, which may contain hundreds of RAN Node MOIs, thousands of Cell MOIs and CellRelation MOIs.. Figure 6.4.2-1: Simple example of cell rehoming scenario",TR 28.812,6.4.2,all_images/image_1182.png,Simple example of cell rehoming scenario
"1. 	Intent driven MnS Consumer sends the following network provisioning intent to Intent driven MnS Producer.. Table 6.4.4-1: Content of network provisioning intent. 2. When received the network provisioning intent, Intent driven MnS Producer may execute the several management tasks to satisfy the intent. Following is an example:. Figure 6.4.4-1: Example of Intent driven MnS Producer satisfying network provisioning intent. 2.1	 Intent driven MnS Producer analyses the network requirements (e.g. Maximum number of UEs, DL/UL throughput per UE) indicated in the network provisioning intent and decides to use network with or without slicing to satisfy the intent.. 2.2	 If using a network with slicing, Intent driven MnS Producer derives the network slice related requirements as described in TS 28.531 based on the network requirement indicated in the network provisioning intent, and create Network Slice IOC instance including ServiceProfile DataType to create a network slice instance or reconfigure existing Network Slice IOC instance including ServiceProfile DataType to reuse an existing network slice instance. The detailed procedure for Network Slice Creation including Network Slice SubNetwork Creation is described in TS 28.531.. 2.3	 If using a network without slicing, Intent driven MnS Producer derives the requirements for SubNetwork and MF as described in TS 28.622 and TS 28.541 based on the network requirement indicated in the network provisioning intent, and create SubNetwork IOC instance (including corresponding child IOC) to create a new subnetwork instance or reconfigure SubNetwork IOC instance (including corresponding child IOC) to use existing subnetwork instance.. 2.4	 Intent driven MnS Producer may configure other IOCs to fulfil the intent.. 3. 	Intent driven MnS Producer may notify Intent driven MnS Consumer about the fulfilment information of network provisioning intent after the intent execution.",TR 28.812,6.4.4,all_images/image_1184.jpeg,Example of Intent driven MnS Producer satisfying network provisioning intent
"Level 0:
-	All the tasks in the fault management workflow (Task A, Task B, Task C, Task D, Task E, Task F, Task G, Task H,  Task I,  Task J, Task K) are accomplished by human.
Level 1:
-	Telecom system executes the tasks of fault related information collection to collect part of fault related information (including alarm information, performance metric, configuration data) (Task C) automatically based on predefined data collection control information, and the tasks of fault management action execution (Task K) based on specified fault recovery control information. Telecom system can also execute the tasks of alarm filtering (Task D) based on specified alarm filtering control information.
-	All the other tasks in the fault management workflow (Task A, Task B, Task E, Task F, Task G, Task H,  Task I, Task J) are accomplished by human.
Level 2:
-	Compared to Level 1, telecom system can additionally executes the tasks of fault recognition (Task E) and fault demarcation (Task G) based on specified fault recognition and demarcation control information. In this level, telecom system can collect all fault related information (including environment data) based on specified data collection control information (Task C).The tasks of fault management action execution (Task J) is fully accomplished by telecom system.
-	All the other tasks (Task A, Task B, Task F, Task H, Task I, Task J) are accomplished by human.
Level 3:
-	Compared to Level 2, telecom system can additionally execute the tasks of fault root cause analysis based on specified fault root cause analysis control information (Task H). For certain network faults, telecom system can also additionally execute the tasks of fault prediction (Task F), fault recovery mechanism analysis (Task H) and action evaluation and determination(Task I) based on specified fault management control information (i.e. control information for fault prediction, fault recovery mechanism analysis, fault recovery mechanism decision). The tasks of fault related information collection (Task C),alarm filtering (Task D), fault recognition (Task E) and fault demarcation (Task G) are fully accomplished by telecom system.
-	All the other tasks (Task A, Task B) are accomplished by human.
Level 4:
-	Compared to Level 3, for certain scenario, telecom system additionally execute the tasks of fault management control information generation (Task A) and fault management intent fulfilment information evaluation (Task B) based on specified intent handling control information. The tasks of fault prediction (Task F), fault root cause analysis (Task H), fault recovery mechanism analysis (Task I) and action generation (Task J) are accomplished automatically by telecom system without human intervention.
-	Intent handling control information can be pre-defined and specified by human.
Level 5:
-	The entire fault management workflows is accomplished by telecom system without human intervention and human predefined control information.
-	Human can optionally supervise the fault management action generated by telecom system.
Figure 7.3.2-1: Generic classification of autonomous network level for fault management",TS 28.100,7.3.2,all_images/image_1186.png,Generic classification of autonomous network level for fault management
"In order to delegate the support of policy control for virtualized NFs such as automatic scale in/out under certain condition , 3GPP management system would use the ETSI NFV defined related policy features/services. Consequently, two important logical functions are needed for the definition of the 3GPP policy management architecture.
1) 	Policy Administration Function (PAF) provides the services as follows:
- 	Allows the operator to define and administrate the network policy
2) 	Policy Function (PF) makes the decision for policy execution and provides the services as follows:
-	 Activating/deactivating the network policy
- 	Event subscription/notification of the network policy execution
- 	Providing relevant data and parameters during the process of policy execution (e.g. execution time consuming)
The 3GPP global policy management system would affect the behavior of all 3GPP defined nodes and would delegate the support of policy for virtualized NFs in ETSI MANO systems [2]. For NFV related policy management, 3GPP mainly focus on NM acting as PAF and EM acted as PF, and the interface between the NM and EM can be updated to support policy related operations. Hence, 3GPP policy management architecture under NFV scenario is as follows.
Figure 5-1: NFV policy management architecture in reference point presentation
NFV related policy interfaces between 3GPP management system and MANO such as Os-Ma-nfvo and Ve-Vnfm-em have been defined by ETSI.",TS 28.311,5,all_images/image_1187.jpeg,NFV policy management architecture in reference point presentation
"It is proposed to enhance the 5G NRM to support management data isolation for different NSCs/Tenants/Slice Groups. The management data isolation policies are defined in following table. It could be part of isolation profile, in this case the groupId is same to id of isolation group the isolation profile associates to. It could be part of service/slice profile, in this case, groupId is not needed.
Table 7.6-1: Data isolation policy
-	groupId is used to identify a group of slices.
Note 1:	The group can be organized for a specific tenant, specific service type, specific region, etc.
-	dataTypeList is used to categorize the data to different types,
Note 2: 	dataType could be, e.g. CM, PM, FM, MDT, QoE, trace data, etc.
-	dataClass is used to define the classification of the management data in the dataTypeList.
Note 3: 	dataClass could be, e.g. secret, confidential, business sensitive, normal, etc.
-	dataStage is used to define the stage/phase of the data,
Note 4: 	dataStage could be, e.g. data in use, in transit, at rest, etc.
-	analyticType is used to define the usage of the analytics function which takes the management data as input and output.
Note 5: 	E.g. the analytics function could be used by operator for business promotion, performance optimization or trouble shooting, etc. or by tenant for trouble shooting, etc. It is optional
-	isolationRule is defined to isolate the data of a tenant/group for specific data types, and optionally in specific data stages.
Note 6: 	The isolationRule could be described as that dedicated DB allocated to the data. The data is MDT and QoE data (data types) in the rest (data stage) of tenant-1/slice group-1 (tenant/group).
-	protectionReq is used to decide the security control to protect the isolated data of a tenant/group for specific data types, and optionally in specific data stages.
Note 7: 	ProtectionReq could be e.g. integration protect, confidentiality protect, privacy protect, etc. The technologies used for the protection is implementation dependent.
With the extended NRM, specific management function/service and corresponding transport, storage/DB/table and analytics function may be allocated to an NSC/tenant/group, isolated and protected according to data isolation policies of the tenant/slice group. See figure 7.6-1 for isolation of management data at rest, in transit and in use.
Figure 7.6-1: isolation of management data of different NSCs/tenants/groups
An example procedure for management data isolation:
Figure 7.6-2: example workflow for management data isolation
1. Through management portal or other tool, operator administrator creates an isolation group for a network slice customer, associates an isolation profile to the group, and defines management data isolation policies for the group for an NSC/tenant.
2. A network slice producer, e.g. NSMF, may call management service provided by network slice subnet producer, e.g. NSSMF, to create corresponding network slice subnet group, translate the isolation profile and policies accordingly if needed, and attach the corresponding isolation profile to the network slice subnet group.
3. An administrator or MnS producer, e.g. NSMF or NSSMF, may trigger to create dedicated monitoring MnSs, even MnS producer, for the network slice (subnet) group to collect monitoring data, e.g. PM, FM data, according to management data isolation policies in the isolation profile associated to the group.
4. The common or dedicated monitoring MnS producer may subscribe to PM, FM or other data notification which belong to the network slices of the group.
5. After the monitoring MnS producer received monitoring data, it allocates storage/database for the data if needed, associates the storage/database to the network slice (subnet) group, isolate and protect the storage according to management data isolation policy defined in the isolation profile for the group.
6. The monitoring MnS producer may send the collected management data to authorized MnS consumer (the MnS consumer could be another MnS producer, e.g. an analytics function deployed by the operator, or the MnS consumer could be acting on behalf of a tenant) through common or dedicated MnSs (and corresponding transport network), protect the MnSs and transports based on management data isolation policies in the isolation profile associated to the group.",TR 28.811,7.6,all_images/image_1188.jpeg,isolation of management data of different NSCs/tenants/groups
"The architectural options for network slice performance and analytics converged charging are depicted in figure 4.2.2-1.
Figure 4.2.2-1: Network slice performance and analytics converged charging architecture
The Charging Enablement Function (CEF):
-	subscribes to notifications by consuming management services or services exposed by other functions, for receiving required charging information from the services.
-	unsubscribes to notifications by consuming management services or services exposed by other functions, for cancelling the subscription to performance and analytics information.
-	determines the occurrence of chargeable events. When it determines that a chargeable event has occurred it then triggers charging by consuming the Nchf services.
Charging information addressed by the CEF in the present document, are related to performance and analytics for network slices.
The MnS producer is defined in TS 28.533 [250]: the MnS producer in the present document is the producer of performance MnS.
For network slice performance and analytics converged charging the CEF is a consumer of either one or both:
-	performance management service (MnS) for network slice exposed by the MnS Producer, specified in TS 28.532 [253];
-	Network Data Analytics service (Nnwdaf) for network slice exposed by the Network Data Analytics Function (NWDAF), described in TS 23.288 [150].
And the CEF is a consumer of:
-	charging (Nchf) service.
The general architecture components can be found in TS 32.240 [1].
Ga is described in clause 5.2.4 and Bns in clause 5.2.5 of the present document, and Nchf is described in TS 32.290 [50].",TS 28.201,4.2.2,all_images/image_1190.jpeg,Network slice performance and analytics converged charging architecture
"For AAS, there are several options for the location of the SON for AAS algorithm:
The SON for AAS algorithm is located in the eNB(s).
The SON for AAS algorithm is located in the EM/DM level, the AAS optimization decision is made by the EM/DM centralized SON for AAS algorithm.
The SON for AAS algorithm is located in the NM level, the AAS optimization decision is made by the NM centralized SON for AAS algorithm.
An example for the first option is shown in figure 4.8.4.2-1:
Figure 4.8.4.2-1: Example when the SON for AAS algorithm is located in the eNB(s)
The detailed SON functionalities in eNB are out of scope of this specification.",TS 28.628,4.8.4.2,all_images/image_1191.png,Example when the SON for AAS algorithm is located in the eNB(s)
"This subclause depicts the set of classes (e.g. IOCs) that encapsulates the information relevant for this IRP. This subclause provides the overview of the relationships of relevant classes in UML. Subsequent subclauses provide more detailed specification of various aspects of these classes.
NOTE 1:	IOC SONControl shall be instantiated whenever one or more IOC SONTargets are instantiated.
Figure 5.2.1-1: Cell view of SON Policy NRM
Figure 5.2.1-2: ES Policies NRM IOCs (Containment Relationship)
NOTE 2:	Also IOC SONControl is used for intra-LTE ES purposes – see clause 5.3.2.2 – but is not shown in Figure 5.2.1-2 to avoid the impression that there would an additional instance of this IOC be needed for intra-LTE ES.
Figure 5.2.1-3: IOCs to control SON on cell level (Containment Relationship)
Figure 5.2.1-4: IOCs for SON coordination (Containment Relationship)
Figure 5.2.1-5: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 1)
NOTE 3:	Also IOC SONControl is used for inter-RAT ES purposes – see clause 5.3.2.2 – but is not shown in Figure 5.2.1-5 to avoid the impression that there would an additional instance of this IOC be needed for inter-RAT ES.
Figure 5.2.1-6: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 2)
Figure 5.2.1-7: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 3)
NOTE 4:	Also IOC SONControl is used for inter-RAT ES purposes – see clause 5.3.2.2 – but is not shown in Figure5.2.1-7 to avoid the impression that there would an additional instance of this IOC be needed for inter-RAT ES. SONControl is contained by Subnetwork or RncFunction when esSwitch attribute is applied in SONControl.
Figure 5.2.1-8: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 4)
Figure 5.2.1-9: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 5)
Figure 5.2.1-10: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 6)",TS 28.628,5.2.1,all_images/image_1192.png,Cell view of SON Policy NRM
"This subclause depicts the set of classes (e.g. IOCs) that encapsulates the information relevant for this IRP. This subclause provides the overview of the relationships of relevant classes in UML. Subsequent subclauses provide more detailed specification of various aspects of these classes.
NOTE 1:	IOC SONControl shall be instantiated whenever one or more IOC SONTargets are instantiated.
Figure 5.2.1-1: Cell view of SON Policy NRM
Figure 5.2.1-2: ES Policies NRM IOCs (Containment Relationship)
NOTE 2:	Also IOC SONControl is used for intra-LTE ES purposes – see clause 5.3.2.2 – but is not shown in Figure 5.2.1-2 to avoid the impression that there would an additional instance of this IOC be needed for intra-LTE ES.
Figure 5.2.1-3: IOCs to control SON on cell level (Containment Relationship)
Figure 5.2.1-4: IOCs for SON coordination (Containment Relationship)
Figure 5.2.1-5: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 1)
NOTE 3:	Also IOC SONControl is used for inter-RAT ES purposes – see clause 5.3.2.2 – but is not shown in Figure 5.2.1-5 to avoid the impression that there would an additional instance of this IOC be needed for inter-RAT ES.
Figure 5.2.1-6: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 2)
Figure 5.2.1-7: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 3)
NOTE 4:	Also IOC SONControl is used for inter-RAT ES purposes – see clause 5.3.2.2 – but is not shown in Figure5.2.1-7 to avoid the impression that there would an additional instance of this IOC be needed for inter-RAT ES. SONControl is contained by Subnetwork or RncFunction when esSwitch attribute is applied in SONControl.
Figure 5.2.1-8: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 4)
Figure 5.2.1-9: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 5)
Figure 5.2.1-10: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 6)",TS 28.628,5.2.1,all_images/image_1193.png,ES Policies NRM IOCs (Containment Relationship)
"This subclause depicts the set of classes (e.g. IOCs) that encapsulates the information relevant for this IRP. This subclause provides the overview of the relationships of relevant classes in UML. Subsequent subclauses provide more detailed specification of various aspects of these classes.
NOTE 1:	IOC SONControl shall be instantiated whenever one or more IOC SONTargets are instantiated.
Figure 5.2.1-1: Cell view of SON Policy NRM
Figure 5.2.1-2: ES Policies NRM IOCs (Containment Relationship)
NOTE 2:	Also IOC SONControl is used for intra-LTE ES purposes – see clause 5.3.2.2 – but is not shown in Figure 5.2.1-2 to avoid the impression that there would an additional instance of this IOC be needed for intra-LTE ES.
Figure 5.2.1-3: IOCs to control SON on cell level (Containment Relationship)
Figure 5.2.1-4: IOCs for SON coordination (Containment Relationship)
Figure 5.2.1-5: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 1)
NOTE 3:	Also IOC SONControl is used for inter-RAT ES purposes – see clause 5.3.2.2 – but is not shown in Figure 5.2.1-5 to avoid the impression that there would an additional instance of this IOC be needed for inter-RAT ES.
Figure 5.2.1-6: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 2)
Figure 5.2.1-7: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 3)
NOTE 4:	Also IOC SONControl is used for inter-RAT ES purposes – see clause 5.3.2.2 – but is not shown in Figure5.2.1-7 to avoid the impression that there would an additional instance of this IOC be needed for inter-RAT ES. SONControl is contained by Subnetwork or RncFunction when esSwitch attribute is applied in SONControl.
Figure 5.2.1-8: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 4)
Figure 5.2.1-9: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 5)
Figure 5.2.1-10: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 6)",TS 28.628,5.2.1,all_images/image_1194.png,IOCs for SON coordination (Containment Relationship)
"This subclause depicts the set of classes (e.g. IOCs) that encapsulates the information relevant for this IRP. This subclause provides the overview of the relationships of relevant classes in UML. Subsequent subclauses provide more detailed specification of various aspects of these classes.
NOTE 1:	IOC SONControl shall be instantiated whenever one or more IOC SONTargets are instantiated.
Figure 5.2.1-1: Cell view of SON Policy NRM
Figure 5.2.1-2: ES Policies NRM IOCs (Containment Relationship)
NOTE 2:	Also IOC SONControl is used for intra-LTE ES purposes – see clause 5.3.2.2 – but is not shown in Figure 5.2.1-2 to avoid the impression that there would an additional instance of this IOC be needed for intra-LTE ES.
Figure 5.2.1-3: IOCs to control SON on cell level (Containment Relationship)
Figure 5.2.1-4: IOCs for SON coordination (Containment Relationship)
Figure 5.2.1-5: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 1)
NOTE 3:	Also IOC SONControl is used for inter-RAT ES purposes – see clause 5.3.2.2 – but is not shown in Figure 5.2.1-5 to avoid the impression that there would an additional instance of this IOC be needed for inter-RAT ES.
Figure 5.2.1-6: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 2)
Figure 5.2.1-7: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 3)
NOTE 4:	Also IOC SONControl is used for inter-RAT ES purposes – see clause 5.3.2.2 – but is not shown in Figure5.2.1-7 to avoid the impression that there would an additional instance of this IOC be needed for inter-RAT ES. SONControl is contained by Subnetwork or RncFunction when esSwitch attribute is applied in SONControl.
Figure 5.2.1-8: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 4)
Figure 5.2.1-9: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 5)
Figure 5.2.1-10: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 6)",TS 28.628,5.2.1,all_images/image_1195.png,"Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 1)"
"This subclause depicts the set of classes (e.g. IOCs) that encapsulates the information relevant for this IRP. This subclause provides the overview of the relationships of relevant classes in UML. Subsequent subclauses provide more detailed specification of various aspects of these classes.
NOTE 1:	IOC SONControl shall be instantiated whenever one or more IOC SONTargets are instantiated.
Figure 5.2.1-1: Cell view of SON Policy NRM
Figure 5.2.1-2: ES Policies NRM IOCs (Containment Relationship)
NOTE 2:	Also IOC SONControl is used for intra-LTE ES purposes – see clause 5.3.2.2 – but is not shown in Figure 5.2.1-2 to avoid the impression that there would an additional instance of this IOC be needed for intra-LTE ES.
Figure 5.2.1-3: IOCs to control SON on cell level (Containment Relationship)
Figure 5.2.1-4: IOCs for SON coordination (Containment Relationship)
Figure 5.2.1-5: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 1)
NOTE 3:	Also IOC SONControl is used for inter-RAT ES purposes – see clause 5.3.2.2 – but is not shown in Figure 5.2.1-5 to avoid the impression that there would an additional instance of this IOC be needed for inter-RAT ES.
Figure 5.2.1-6: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 2)
Figure 5.2.1-7: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 3)
NOTE 4:	Also IOC SONControl is used for inter-RAT ES purposes – see clause 5.3.2.2 – but is not shown in Figure5.2.1-7 to avoid the impression that there would an additional instance of this IOC be needed for inter-RAT ES. SONControl is contained by Subnetwork or RncFunction when esSwitch attribute is applied in SONControl.
Figure 5.2.1-8: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 4)
Figure 5.2.1-9: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 5)
Figure 5.2.1-10: Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 6)",TS 28.628,5.2.1,all_images/image_1196.png,"Inter-RAT ES Policies NRM IOCs (Containment Relationship, part 2)"
"Generally, There are always huge number of heterogeneous management systems in big operator's data centre. Administrators of the operator access the systems for daily management and operation, while management functions of the systems could interact with each other for network and resource management. Access control, including Authentication, Authorization and Audit, should be supported by each management system to avoid potential unauthorized accessing. To save OPEX and minimize administration burden, centralized Authentication, Authorization and Audit (AAA) system is always built in the operator's data centre for common AAA functions of diversity management systems. The common AAA functions include, e.g. identity lifecycle management, user provisioning and role assignment, access request review and approval, security policies (e.g. password rotation policy, multi-factor authentication policy) management, and Single Sign On (SSO), etc.
Similarly, 5G network (including network slice) management system needs to be enhanced to integrate its access control functionalities with centralized AAA platform of operator, e.g. specify interfaces to enable centralized AAA platform to sync identity information or security policies with access control functions of 5G network management system, or collect security logs from 5G network management system for audit and accountability, as shown in the figure 5.7.1-1. Authentication request of 5G network management system could be redirect to centralized AAA system for single sign on, then identity information including security policies for the identity could be synced to 5G network management system for fine grained authorization. Operations on 5G network could be logged by 5G network management system and sent to centralized AAA system for audit.
Figure 5.7.1-1: Integrate 5G network management system with centralized AAA system of operator",TR 28.817,5.7.1,all_images/image_1197.png,Integrate 5G network management system with centralized AAA system of operator
"With regard to the control and monitoring of their Power, Energy and Environmental (PEE) parameters, base stations can be of two different types:
# either they have built-in sensors, which communicate with DM through Type-1 interface. In turn, DM communicates with the NM-RMS (see figure 4.1.1);
# or they have external sensors, which communicate with the NM-RMS via:
- either XCU/DGU (see figure 4.1.1)
- or vendor-specific RMS (VS RMS) (see figure 4.1.1).
The NM-RMS collects PEE parameters from part or whole of the radio access network and may also control PEE related parameters through either DM(s) and/or XCU/DGU(s) and/or VS-RMS(s).
For this reason, it is beneficial to standardize the interface to control and monitor PEE parameters between the NM-RMS on the one hand and DM, XCU/DGU and VS-RMS on the other hand. This TS series specifies this Type-2 interface (see TS 32.101 [2]).
Figure 4.1.1: Overall architecture for the control and monitoring of PEE parameters",TR 28.814,4.1,all_images/image_1198.jpeg,5GS providing access to EAS with UL CL/BP for non-roaming scenario
"The following procedures creates/instantiate EES on a particular EDN.. Figure 7.4.2-1: EES lifecycle management via provisioning MnS. 1.   Provisioning MnS Producer receives a request (this will use createMOI operation defined in TS 28.532) with EES related requirements. The following are the list of requirements, which can be provided with the request as part of attributeListIn parameter of createMOI operation.. a.   EDNidentifier: Identifying the host EDN to instantiate the EES on.. b.   EASIdentifiers: Identifying the list of EAS registered with the EES.. 2.   The NF instance creation procedure as described in 7.10 of [5] is reused to instantiate the EES VNF instance with the requirements captured in the EESFunction IOC. The request is to create the MOI for EESFunction IOC.. 3.   The producer creates the MOI (Managed Object Instance) for EESFunction class. The MOI shall contain attributes as defined in EESFunction IOC.. 4.   The producer configures the new created MOI with corresponding configuration information.. 5.   The producer sends the CreateEES response (this will use createMOI operation defined in TS 28.532) to the consumer with identifier of MOI.",TR 28.814,7.4.2,all_images/image_1200.jpeg,EES lifecycle management via provisioning MnS
"The Figure 7.2-1 illustrates the procedure of creating a new NSI or using an existing NSI to satisfy the required network slice related requirements.
Figure 7.2-1: Network Slice Instance Allocation Request procedure
1)	Network Slice Management Service Provider (NSMS_Provider) receives an AllocateNsi request (see AllocateNsi operation defined in clause 6.5.1) from Network Slice Management Service Consumer (NSMS_Consumer) with network slice related requirements (the network slice related requirements are defined as the attributes in the ServiceProfile see clause 6.3.3 in TS 28.541 [6]).
2)	Based on the network slice related requiremen and the knowledge of the capabilities of existing deployed network slices, the NSMS_Provider compare/match the provided requirements against all the candidate NetworkSlice instances, and then decides whether to use an existing NSI or create a new NSI. If the network slice related requirements allow the requested NSI to be shared and if an existing suitable NSI can be reused, the NSMS_Provider may decide to use the existing NSI.
3a) If using an existing NSI and the existing NSI needs to be modified to satisfy the network slice related requirements, the NSMS_Provider invokes the procedure to modify the existing NSI as described in clause 7.6.
3b-1) If creating a new NSI, the NSMS_Provider derives the network slice subnet related requirements from the received network slice related requirements. Before NSMS_Provider derives the network slice subnet related requirements, NSMS_Provider may invoke corresponding network slice subnet capability information querying procedure as described in clause 7.8.
3b-2)	The NSMS_Provider invokes the NSSI allocation procedure as described in clause 7.3.Before NSMS_Provider invokes the NSSI allocation procedure, NSMS_Provider may invoke corresponding network slice subnet feasibility check procedure as described in clause 7.14.
3b-3)	The NSMS_Provider creates the MOI for NetworkSlice and configures the MOI with the DN of MOI for the NetworkSliceSubnet, other configuration information may be configured for the created MOI.
Note:	The detailed configuration information is described in network slice NRM (see NetworkSlice IOC defined in clause 6.3.1 in TS 28.541 [6]).
4) The NSMS_Provider sends NSI allocation result (see AllocateNsi operation defined in clause 6.5.1) to the NSMS_Consumer. If an existing NSI is modified or a new NSI is created successfully to satisfy the network slice related requirements, the result includes the relevant network slice instance information (see NetworkSlice IOC defined in clause 6.3.1 in TS 28.541 [6]):
-	DN of the NetworkSlice.
Otherwise the result may include the reason of failure, for example, the required latency or user number cannot be satisfied, or the physical resource is not enough.",TS 28.531,7.2,all_images/image_1202.png,Network Slice Instance Allocation Request procedure
"The Figure 7.3-1 illustrates the procedure of creating a new network slice subnet instance or using an existing network slice subnet instance to satisfy the required network slice subnet related requirements.
Figure 7.3-1: Network Slice Subnet Instance Allocation Request procedure
1)	Network Slice Subnet Management Service Provider (NSSMS_P) receives an AllocateNssi request (see AllocateNssi operation defined in clause 6.5.2) from Network Slice Subnet Management Service Consumer (NSSMS_C) with network slice subnet related requirements (network slice subnet related requirements defined in SliceProfile see clause 6.3.4 in TS 28.541 [6]).
2) NSSMS_P check the feasibility of network slice subnet related requirements. If the network slice subnet related requirements can be satisfied, the following step 3) are needed, else go to step 5).
3)	Based on the network slice subnet related requirements and the existing NSSI capabilities, NSSMS_P decides whether to use an existing NSSI or create a new NSSI. If the network slice subnet related requirements allow the requested NSSI to be shared and if an existing suitable NSSI can be reused, the NSSMS_P decides to use the existing NSSI.
4.1a) If using an existing NSSI and the existing NSSI needs to be modified to satisfy the network slice subnet related requirements, the NSSMS_P invokes the procedure to modify the existing NSSI as described in clause 7.7.
4.1b.1) If creating a new NSSI, the NSSMS_P creates the NetworkSliceSubnet MOI. NSSMS_P derives the corresponding network slice subnet constituent (i.e. NF, constituent NSS) related requirements and transport network related requirements (e.g. 3GPP endpoint information, latency requirements, bandwidth requirements and isolation requirements) from the received network slice subnet related requirements. Part of these requirements may be referenced by attribute ""epTransportRef"" as defined in clause 6.3.2.2 in TS 28.541[6]. Before NSSMS_Provider derives the constituent network slice subnet related requirements, NSMS_Provider may invoke corresponding network slice subnet capability information querying procedure as described in clause 7.8.2.
4.1b.2)	If the NSSI to be created contains virtualisation part (i.e. VNF or VL), NSSMS_P derives the NS instance instantiation information (the NS instance instantiation information is described in clause 7.3.2.2 and clause 7.3.3.2 [3]) based on network slice subnet related requirements. NSSMS_P determines new VNF instance(s) that need to be deployed and the existing VNF instance(s) that need to be reused according to the necessary network function(s) and then derives the profile of virtual link(s) according to the connection requirements between the network functions. NSSMS_P chooses a proper NSD deployment flavour and creates data concerning the SAPs of the NS instance. NSSMS_P invokes the NS instantiation procedures to create a NS instance. NSSMS_P configures the NSS MOI with the NS instance identifier.
Note:	NS instantiation procedure is described in TS 28.526 [7].
4.1b.3) For each required NSSI constituent, the following step 4.1b.3a) and 4.1b.3b) are needed:
4.1b.3a) If the required NSSI constituent is constituent NSSI, NSSMS_P invokes NSSI Allocation Procedure.
4.1b.3b) If the required NSSI constituent is NF instance, NSSMS_P invokes NF Creation Procedure as described in clause 7.10 or NF Modification Procedure as described in clause 7.11.
4.1b.4)	NSSMS_P configures the NetworkSliceSubnet MOI with the DN of the MOI for NSSI constituent (i.e. ManagedFunction MOI, NetworkSliceSubnet MOI).
4.1b.5)	For each required transport network related requirements, NSSMS_P invokes corresponding procedure of coordination with relevant TN Manager to handle the TN part as described in clause 7.9.
5)	The NSSMS_P sends the NSSI allocation result (see AllocateNssi operation defined in clause 6.5.2) to the NSSMS_C. If the NSSI is created successfully, the result includes the relevant constituent network slice subnet instance information (see NetworkSliceSubnet IOC defined in clause 6.3.2 in TS 28.541 [6]):
-	DN of the NetworkSliceSubnet MOI.
-	NS instance Info (e.g. NSinstanceId)
Otherwise the result may include the reason of failure, for example, the required latency or user Number cannot be satisfied, or the physical resource is not enough.",TS 28.531,7.3,all_images/image_1203.png,Network Slice Subnet Instance Allocation Request procedure
"Figure 7.5-1 depicts the procedure of deallocating a network slice subnet instance by the network slice subnet management service provider to satisfy the NSSI deallocation request received from an authorized consumer.
Figure 7.5-1: Network slice subnet instance deallocation procedure
1) The network slice subnet management service provider (NSSMS_P) receives NSSI deallocation request (see DeallocateNssi operation defined in clause 6.5.4) from network slice subnet management service consumer (NSSMS_C) indicating that the NetworkSliceSubnet MOI is no longer needed for the given requirements i.e SliceProfile.
2) NSSMS_P sends response (see DeallocateNssi operation defined in clause 6.5.4) of NSSI deallocation service to NSSMS_C.
3-a) NSSMS_P may decide to terminate the NSSI, it invokes (constituent) NSSI deallocation procedure as described in clause 7.5 if the NSSI consists of constituent NSSI.
3-b) NSSMS_P invokes NF deletion procedure as described in clause 7.12 only if the NF is dedicated for this NSSI and not being used by any other NSSI in the network, otherwise, NSSMS_P invokes  NF modification procedure as described in clause 7.11.
3-c) NSSMS_P invokes TN related coordination procedure with responsible manager as described in clause 7.9 if the NSSI consists of TN part.
3-d) NSSMS_P invokes NS termination procedure if the NSSI contains virtualized part.
Note:	NS termination procedure is described in TS 28.526 [7].
4) NSSMS_P may decide not to terminate the NSSI, it invokes NSSI modification procedure as described in clause 7.7.",TS 28.531,7.5,all_images/image_1204.png,Network slice subnet instance deallocation procedure
"The Figure 7.7-1 illustrates the procedure of modifying an existing NSSI.
Figure 7.7-1: Network Slice Subnet Instance Modification Request procedure
1)	Network Slice Subnet Management Service Provider (NSSM_SP) receives a modifyMOIAttributes operation defined in TS 28.532 [8] from Network Slice Subnet Management Service Consumer (NSSM_SC) with the DN of NetworkSliceSubnet MOI and the new network slice subnet related requirements (see SliceProfile defined in clause 6.3.3 in TS 28.541[6]).
2)	Based on the new network slice subnet related requirements, NSSM_SP invokes the feasibility check procedure. If the modification requirements can be satisfied, go to step 3), else go to step 5).
3) NSSM_SP decomposes the NetworkSliceSubnet MOI modification request into modification requests for each NSSI constituent.
4a) If the requested NSSI constituent is constituent NSSI, NSSM_SP invokes NSSI modification procedure as described in clause 7.7.
4b) If the requested NSSI constituent is NF instance, NSSM_SP invokes NF creation procedure as described in clause 7.10 or NF modification procedure as described in clause 7.11.
4c)	If the NSSI contains the virtualized part, NSSM_SP invokes the NS instance scaling and/or NS instance updating and/or NS instance instantiation procedure as described in TS 28.526 [7].
4d) If the NSSI contains the TN part, NSSM_SP invokes the TN related coordination procedure as described in clause 7.9.
5) NSSM_SP sends NSSI modification results (see modifyMOIAttributes operation defined in TS 28.532 [8]) to NSSM_SC.",TS 28.531,7.7,all_images/image_1205.png,Network Slice Subnet Instance Modification Request procedure
"This clause depicts the set of classes that encapsulate information relevant for this service. This clause provides the overview of all classes in UML.  Subsequent clauses provide more detailed specification of various aspects of these classes.
The figures below show the containment/naming hierarchy and the associations of the GERAN NRM.
NOTE 1:	The listed cardinality numbers represent transient as well as steady-state numbers, and reflect all managed object creation and deletion scenarios.
NOTE 2:	The ExternalBSSFunction is used in the Core Network NRM.
Figure 4.2.1-1: GERAN NRM Containment/Naming and Association diagram
Each Managed Object is identified with a Distinguished Name (DN) according to 3GPP TS 32.300 [13] that expresses its containment hierarchy. As an example, the DN of an IOC representing a cell could have a format like:
SubNetwork =Sweden, MeContext =MEC-Gbg-1, ManagedElement =RNC-Gbg-1, BSSFunction=BSS1.
NOTE 1:	The listed cardinality numbers represent transient as well as steady-state numbers, and reflect all managed object creation and deletion scenarios.
NOTE 2:	Each instance of the VsDataContainer shall only be contained under one IOC. The VsDataContainer can be contained under IOCs defined in other NRMs.
Figure 4.2.1-2: GERAN NRM Containment/Naming and Association diagram
The VsDataContainer is only used for the Bulk CM IRP.",TS 28.655,4.2.1,all_images/image_1206.jpeg,GERAN NRM Containment/Naming and Association diagram
"When a new failure occurs from the virtualized resource and it impacts the corresponding NE application, EM can make the alarm correlation based on the virtualized resource failure report sent from VNFM and VNF application alarms.
The figure 4.2.1-1 illustrates the procedure of EM makes NE alarms correlation in a mobile network that includes virtualized network functions.
Figure 4.2.1-1: Procedure of NE alarm correlation made by EM in the context of NFV
1)	A new failure occurs from the virtualized resource and it impacts the corresponding NE application.
2)	VNFM received virtualized resource alarms as described in ETSI NFV ISG.
3)	VNFM sends VNF instance alarms related to virtualized resource to EM. The VNF and/or VNFC alarms related to virtualized resource include AlarmId, affected VNF identifier, affected VNFC identifiers, and FaultDetails which provides additional information about the virtualized resource fault, for example the resource identifier which causes the fault (e.g. VM identifier, vNIC identifier or vPORT identifier). The Alarm information element see clause 9.3.4 of [3].
4)	NE/VNF sends VNF application alarms to EM through proprietary interface, the corresponding VNF instance identifier and/or VNFC identifier should be included.
Note: 	There is no sequence restriction on EM receives VNF instance alarms related virtualized resource and EM receives VNF application alarms.
5)	EM correlates the received VNF instance alarms related to virtualized resource with the received VNF application alarms.
6)	EM sends the correlated alarm information to NM over Itf-N. The alarm information that carries correlated alarm information is specified in TS 32.111-2 [2].",TS 28.516,4.2.1,all_images/image_1208.jpeg,Procedure of NE alarm correlation made by EM in the context of NFV
"When a new failure occurred from the virtualized resource and it impacts corresponding NE application, NM can make the alarm correlation based on the virtualized resource failure report sent from VNFM and VNF application alarms.
The figure 4.2.2-1 illustrates the procedure of NM makes NE alarms correlation in a mobile network that includes virtualized network functions.
Figure 4.2.2-1: Procedure of NE alarm correlation made by NM in the context of NFV
1)	A new failure occurs from the virtualized resource and it impacts corresponding NE application.
2)	VNFM receives virtualized resource alarms as described in [3].
3)	VNFM sends VNF instance alarms related to virtualized resource to EM. The VNF and/or VNFC alarms related to virtualized resource include AlarmId, affected VNF identifier, affected VNFC identifiers, and FaultDetails which provides additional information about the virtualized resource fault, for example the resource identifier which causes the fault (e.g. VM identifier, vNIC identifier or vPORT identifier). The Alarm information element see clause 9.3.4 of [3].
4)	EM sends VNF instance alarms related to virtualized resource to NM.
5)	NE/VNF sends VNF application alarms to EM through proprietary interface, the corresponding VNF instance identifier and/or VNFC identifier should be included.
6)	EM sends VNF application failure report of a NE to NM over Itf-N. The information in the failure report sees alarm information in TS 32.111-2 [2].
Note:	There is no sequence restriction on EM receives VNF instance alarms related virtualized resource and NM receives VNF application failure report.
7)	Based on the VNF instance alarms related to virtualized resource sent from VNFM and VNF application failure report, NM makes the alarm correlation.",TS 28.516,4.2.2,all_images/image_1209.jpeg,Procedure of NE alarm correlation made by NM in the context of NFV
"The figure 4.3.2-1 illustrates the procedure of notifying the EM about a virtualization-specific failure of a virtualized network function.
Figure 4.3.2-1: Procedure of virtualization-specific aspect failure detection and notification by EM
1)	A new virtualization-specific failure occurs and is detected by VNF virtualization-specific component.
2)	VNF sends virtualization-specific fault notification to EM through proprietary interfaces, the corresponding VNF instance identifier and/or VNFC identifier should be included.",TS 28.516,4.3.2,all_images/image_1210.png,Procedure of virtualization-specific aspect failure detection and notification by EM
"This clause depicts the set of IOCs that encapsulate information relevant for this service. This clause provides the overview of the relationships of relevant classes in UML. Subsequent clauses provide more detailed specification of various aspects of these classes.
The figures below show the containment/naming hierarchy and the associations of the information object classes defined in the present document.
NOTE:	The listed cardinality numbers represent transient as well as steady-state numbers, and reflect all managed object creation and deletion scenarios in all figures.
Each IOC is identified with a Distinguished Name (DN) according to 3GPP TS 32.300 [4] that expresses its containment hierarchy. As an example, the DN of an IOC representing a MME (3GPP TS 23.401 [9]) could have a format like:
SubNetwork=China, MeContext =MEC-Gbg-1, ManagedElement =MME-Gbg-1, MMEFunction=MME-1.
Figure 4.2.1-1: EPC NRM Containment/Naming Relationships
Figure 4.2.1-2: EPC NRM Containment/Naming and Association_1
Figure 4.2.1-3: EPC NRM Containment/Naming and Association_2
Figure 4.2.1-4: EPC NRM Containment/Naming and Association3
Figure 4.2.1-5 MME Pool Object Model of EPC NRM
NOTE:	Void.
Figure 4.2.1-6: EPC NRM Containment/Naming and Association 3
Figure 4.2.1-7: EPC NRM Containment/Naming and Association 4
Figure 4.2.1-8: EPC NRM Containment/Naming and Association 4 for EPC CUPS
Figure 4.2.1-9: EPC NRM Containment/Naming and Association 5 for EPC CUPS",TS 28.708,4.2.1,all_images/image_1213.png,EPC NRM Containment/Naming and Association 4
"This clause depicts the inheritance relationships that exist between IOCs.
The figures below show the inheritance hierarchy for the EPC NRM.
Figure 4.2.2-1: EPC NRM Inheritance Hierarchy_1
Figure 4.2.2-2: EPC NRM Inheritance Hierarchy_2
Figure 4.2.2-3: EPC NRM Inheritance Hierarchy_3
Figure 4.2.2-4: EPC NRM Inheritance Hierarchy_4
Figure 4.2.2-5: E-UTRAN NRM Inheritance Hierarchy_5
Figure 4.2.2-6: EPC NRM Inheritance Hierarchy 6 for EPC CUPS",TS 28.708,4.2.2,all_images/image_1216.png,EPC NRM Inheritance Hierarchy 6 for EPC CUPS
"Figure 12.5.1.3.1-1 shows the resource structure of the Streaming data reporting service.
Figure 12.5.1.3.1-1: Resource URI structure of the Streaming data reporting service
Table 12.5.1.3.1-1 provides an overview of the resources and applicable HTTP methods.",TS 28.532,12.5.1.3.1,all_images/image_1217.jpeg,Resource URI structure of the Streaming data reporting service
"Figure 4.2.2.3-1 depicts a procedure of providing the IP address of the managing EM to the VNF in instantiation. As a result of this procedure, the new VNF instance is not associated to any NS (see NOTE in clause 7.2.3.4 in [4]). The figure uses UML notation to show multiple options available.
1.	EM sends CreateVnfIdentifierRequest with parameters vnfdId, and optionally vnfInstanceName and vnfInstanceDescription to VNFM (see clause 7.2.2 [4]).
2.	VNFM creates a new VnfInfo object
3.	VNFM sends CreateVnfIdentifierResponse with the new VNF identifier to EM (see clause 7.2.2 [4]).
If the Multi-vendor Plug and Play connection to the network method is not used and managing EM IP address is provided as VNF configuration data, the steps 4.1.1 through 4.1.4 are executed.
4.1.1.	EM sends ModifyVnfConfigurationRequest with parameters vnfInstanceId, vnfConfigurationData, extVirtualLink and vnfcConfigurationData to VNFM (see clause 7.6.2 [4]). The managing EM IP address value used in parameter vnfConfigurationData.
4.1.2.	VNFM sets the vnfConfigurationData in the vnfInfo object.
4.1.3.	VNFM sends ModifyVnfConfigurationResponse to EM (see clause 7.6.2 [4]).
4.1.4.	EM sends InstantiateVnfRequest with parameters vnfInstanceId, flavourId, instantiationLevelId, extVirtualLink, extManagedVirtualLink, localizationLanguage and additionalParam to VNFM (see clause 7.2.3 [4]).
Note: The extVirtualLink may be known to the EM (e.g. provided by another entity).
If the Multi-vendor Plug and Play connection to the network method is not used and managing EM IP address is provided as additional parameter for instantiation, the steps 4.2.1 through 4.2.3 are executed.
4.2.1.	EM sends InstantiateVnfRequest with parameters vnfInstanceId, flavourId, instantiationLevelId, extVirtualLink, extManagedVirtualLink, localizationLanguage and additionalParam to VNFM (see clause 7.2.3 [4]). The managing EM IP address value used in parameter additionalParam.
4.2.2.	VNFM maps the managing EM IP address value received in parameter additionalParam of InstantiateVnfRequest to vnfConfigurationData (see Note 1).
NOTE 1: the specific mechanism for this mapping (e.g. vendor specific LCM script or specific VNFM) is out of scope of 3GPP
4.2.3.	VNFM sets the vnfConfigurationData in the vnfInfo object.
If the Multi-vendor Plug and Play connection to the network method is used to provide the managing EM IP address to VNF, step 4.3.1 is executed.
4.3.1.	EM sends InstantiateVnfRequest with parameters vnfInstanceId, flavourId, instantiationLevelId, extVirtualLink, extManagedVirtualLink, localizationLanguage and additionalParam to VNFM (see clause 7.2.3 [4]).
5.	VNFM initiates the VNF instantiation process.
6.	VNFM sends InstantiateVnfResponse with the new lifecycleOperationOccurrenceId to EM (see clause 7.2.3 [4]).
7.	VNFM sends SetInitialConfigurationRequest with parameters vnfInstanceId, vnfConfigurationData and vnfcConfigurationData to VNF (see clause 6.2.2 [4]).
8.	VNF sends SetInitialConfigurationResponse with parameters vnfConfigurationData and vnfcConfigurationData to VNFM (see clause 6.2.2 [4]).
9. If Multi-vendor Plug and Play connection to the network method is used to provide the managing EM IP address to VNF, VNF performs the EM discovery (see ""Establishing connection to Element Manager"" procedure in clause 5.5 of TS 32.508 [6]).
10.	VNF connects to the managing EM.
11.	""Normal"" NE management by the EM over Type-1 interface (e.g. s/w update, configuration) begins.
Figure 4.2.2.3-1: Provide IP address of the managing EM in VNF instantiation procedure",TS 28.526,4.2.2.3,all_images/image_1218.png,Provide IP address of the managing EM in VNF instantiation procedure
"MDA MnS (also referred to as MDAS) in the context of SBMA enables any authorized consumer to request and receive analytics as illustrated in Figure 5.1-1.
Figure 5.1-1: MDA functional overview and service framework
A management function (MDAF) may play the roles of MDA MnS producer, MDA MnS consumer, other MnS consumer, NWDAF consumer and LMF service consumer, and may also interact with other non-3GPP management systems.
The internal business logic related to MDA leverages the current and historical data related to:
-	Performance Measurements (PM) as per TS 28.552 [4] and Key Performance Indicators (KPIs) as per TS 28.554 [5].
-	Trace data, including MDT/RLF/RCEF, as per TS 32.422 [6] and TS 32.423 [7].
-	QoE and service experience data as per TS 28.405 [8] and TS 28.406 [9].
-	Analytics data offered by NWDAF as per TS 23.288 [10] including 5GC data and external web/app-based information (e.g. web crawler that provides online news) from AF.
-	Alarm information and notifications as per TS 28.532 [11].
-	CM information and notifications.
-	UE location information provided by LMF as per TS 23.273 [14].
-	MDA reports from other MDA MnS producers.
-	Management data from non-3GPP systems.
Analytics output from the MDA internal business logic are made available by the management functions (MDAFs) playing the role of MDA MnS producers to the authorized consumers, (including but not limited to other management functions, network functions/entities, NWDAF, SON functions, optimization tools and human operators).",TS 28.104,5.1,all_images/image_1219.jpeg,MDA functional overview and service framework
"This clause provides the relationships of relevant classes in UML.
NOTE:	When the MDAEntity represents the ManagedElement or ManagedFunction, it means the MDAF is located in the NE/NF that the ManagedElement or ManagedFunction represents, but it does not mean the MDA is the feature of the NE/NF.
Figure 9.2.1-1: NRM fragment for MDA request and MDA report",TS 28.104,9.2.1,all_images/image_1221.png,NRM fragment for MDA request and MDA report
"Figure 4.2-1 shows the PM data collection methods for virtualized networks.
When it is necessary to collect the PM data (i.e. PM data related to 3GPP Network Function and 3GPP NF PM data related to VR), NM needs to create a PM collection task at EM. So EM knows the measurement types, the measured resources, the recording periods and collection times wanted (see TS 32.401 [2]).
For PM data related to 3GPP Network Function collection, EM will request VNF(s) to collect the PM data related to 3GPP Network Function as specified by NM.
For VNF PM data related to VR collection, EM will create a PM collection task at VNFM to collect VNF/VNFC PM data related to VR, based on the information provided by NM, so VNFM knows the measurement types, the measured resources, the recording periods, and collection times wanted. Then, VNFM will create a PM collection task at VIM, based on the information provided by EM (see clause 7.7.2 [8]). VIM will request NFVI to collect the VR PM data as specified by VNFM.
The various PM data collected are stored in data repositories. Data stored in data repositories may be fetched by NM (or any authorized user).
Figure 4.2-1: PM data collection methods for virtualized networks",TS 28.520,4.2,all_images/image_1225.jpeg,PM data collection methods for virtualized networks
"A State Machine, consisting of 17 States can describe the TFO_Protocol Process, see the following figure.
Figure 9-1: TFO_Protocol State Machine with most important transitions
There are five main States:
-	Initialisation	( Not_Active,    Wakeup)
-	Establishment	( First_Try,   Continuous_Retry,   Periodic_Retry,   Monitor,   Mismatch)
-	Contact	( Contact)
-	Preparation	( Wait_RC,  Konnect)
-	Operation	( Operation)
Exception handling needs further States (see figure 9-1):
-	Local Handover	( Fast_Try,   Fast_Contact).
-	Distant Handover	( Sync_Lost,   Re_Konnect).
-	Misbehaviour	( Failure).
-	Termination	( TFO_Term).
It is assumed that Events (Conditions checking), Actions and Transitions to another State are handled almost instantaneous and in any case significantly faster than the time required to complete the transmission of any TFO Message or TFO Frame.",TS 28.062,9,all_images/image_1226.jpeg,TFO_Protocol State Machine with most important transitions
"Figure 11.2.4-1: Flowchart for AMR-NB TFO Establishment at Call Set-Up
Figure 11.2.4-2: Flowchart for AMR-WB TFO Establishment at Call Set-Up",TS 28.062,11.2.4,all_images/image_1228.jpeg,Flowchart for AMR-NB TFO Establishment at Call Set-Up
"Figure 11.2.4-1: Flowchart for AMR-NB TFO Establishment at Call Set-Up
Figure 11.2.4-2: Flowchart for AMR-WB TFO Establishment at Call Set-Up",TS 28.062,11.2.4,all_images/image_1229.jpeg,Flowchart for AMR-WB TFO Establishment at Call Set-Up
"The parameters for the network request session are sent from the management system to the RNCs that host the cells that are included in the collection job request in the activateAreaQMCJob operation [3]. The RNC starts a network request session, with the Network request session id [3] given in activateAreaQMCJob operation [3]. For the duration of the network request session, the RNC(s) checks for connections where the UE has the UE Application Layer Measurement Capability [10]. The UE Application Layer Measurement Capability is sent from the UE to RNC (via the core network) in message INITIAL UE MESSAGE [10].. When a session is found that has a UE with the UE Application Layer Measurement Capability, the RNC starts a UE request session by sending a MEASUREMENT CONTROL message [4] to the UE via the NB.. The AT command +CAPPLEVMC [5] activates provisioning of measurement reporting from the lower layers to the application within the UE by an unsolicited result code +CAPPLEVMC. When information about a measurement report is received in the UE from the network, the unsolicited result code +CAPPLEVMC contains the relevant parameters (service_type, start_stop-indication and config-file & config-file length if applicable) that are provided from the lower layers in the UE to the application.. Figure 4.1.1-1: QMC activation and reporting in UTRAN. 1.	The NM sends activateAreaQMCJob to DM/EM that controls the impacted RNC(s), and includes the parameters: serviceType, areaScope, qoECollectionEntityAddress, pLMNTarget, qMCTarget, qoEReference and QMC configuration file.. 2.	The DM/EM forwards activateAreaQMCJob to impacted RNC(s), and includes the parameters: serviceType, areaScope, qoECollectionEntityAddress, pLMNTarget, qMCTarget, qoEReference and QMC configuration file.. 3.	The RNC checks for connections where the UE has the UE Application Layer Measurement Capability [10] that match the criteria for serviceType in the activateAreaQMCJob.. 4.	When a connection is found that has the UE Application Layer Measurement Capability [10], the RNC start a UE request session and stores the associated QoECollectionEntityAddress, sends the message RRCConnectionReconfiguration to the UE, and includes the following: serviceType, qoEReference and QMC configuration file.. 5.	The access stratum in the UE sends the AT command +CAPPLEVMC to application level and includes the following: serviceType, qoEReference and QMC configuration file.. 6.	When the application in the serviceType starts, the QMC is initiated.. 7.	The application layer sends the AT command +CAPPLEVMR including a recording session indication that a session has started to the access stratum.. 8.	The UE sends the message MeasurementReport including the recording session indication to the RNC.. 9.	The RNC sends a notification including the recording session indication to the NM.. 10.	When the QMC is completed, the recorded information is collected in a QMC report [6], [7], including qoEReference and recordingSessionId. The qoEReference, Client Id [6], [7] in the reporting container (that represent the UE request session), and recordingSessionId are needed in the QMC collection entity for post processing purposes.. 11.	The application layer sends the AT command +CAPPLEVMR including qoEReference and the QMC report to the access stratum.. 12.	The UE sends the message MeasurementReport including qoEReference and the QMC report to the RNC.. 13.	The RNC sends the QMC report to the MCE associated to the qoEReference.",TS 28.405,4.1.1,all_images/image_1230.png,QMC activation and reporting in UTRAN
"The figure 4.1.2.2-1 and the text below describes the handling at handover between RNCs.. Figure 4.1.2.2-1: Handling of QMC activation in case of handover in UTRAN. 1.	Source RNC sends the message HandoverRequest to Target RNC and includes areaScope, qoECollectionEntityAddress and a recording session indication indicating whether a recording session has started.. 2.	If a recording session has not started, the target RNC checks if the target cell is inside the areaScope or not.. 3.	The target RNC sends the message Handover Request Ack to the source RNC.. 4.	The source RNC sends the message RRCReconfiguration to the UE.. 5.	The access stratum in the UE sends the AT command +CAPPLEVMC to application level.. 6.	The UE sends the message RRCReconfigurationComplete to the RNC.. 7.	When the application becomes active, QMC is initiated if the UE is inside the areaScope.. 8.	The application layer sends the AT command +CAPPLEVMR including a recording session indication to the access stratum.. 9.	The UE sends the message MeasurementReport including the recording session indication to the RNC.. 10.	The RNC sends a notification including the recording session indication to the NM.. 11.	When the QMC is completed, the recorded information is collected in a QMC report [6] and [7]. including qoEReference and recordingSessionId. The qoEReference, Client Id [6] and [7] in the reporting container (that represent the UE request session) and recordingSessionId are needed in the QoE collection entity for post processing purposes.. 12.	The application layer sends the AT command +CAPPLEVMR including qoEReference and the QMC report to the access stratum.. 13.	The UE sends the message MeasurementReport including qoEReference and the QMC report to the RNC.. 14.	The RNC sends the QMC report to the MCE associated to the qoEReference.",TS 28.405,4.1.2.2,all_images/image_1231.png,Handling of QMC activation in case of handover in UTRAN
"The parameters for the network request session are sent from the management system to the eNBs that host the cells that are included in the collection job request in the activateAreaQMCJob operation [3]. The eNB starts a network request session, with the Network request session id [3] given in activateAreaQMCJob operation [3]. For the duration of the network request session, the eNB(s) checks for connections where the UE has the QoE-MeasReport capability [8] for collection of streaming services or the QoE-MTSI-MeasReport capability [8] for collection of MTSI services. The UE capability is sent from the UE to eNB via the core network in message UE CAPABILITY INFO INDICATION [9].. When a session is found that has a UE with the wanted UE capability, the eNB starts a UE request session and sends a RRCConnectionReconfiguration [8] to the UE.. The AT command +CAPPLEVMC [5] activates provisioning of measurement reporting from the lower layers to the application within the UE by an unsolicited result code +CAPPLEVMC. When information about a measurement report is received in the UE from the network, the unsolicited result code +CAPPLEVMC contains the relevant parameters (service_type, start_stop-indication and config-file & config-file length if applicable) that are provided from the lower layers in the UE to the application.. Figure 4.2.1-1: QMC activation and reporting in LTE. 1.	The NM sends activateAreaQMCJob to DM/EM that controls the impacted eNB(s), and includes the parameters: serviceType, areaScope, qoECollectionEntityAddress, pLMNTarget, qoETarget, qoEReference and QMC configuration file.. 2.	The DM/EM forwards activateAreaQMCJob to impacted eNB(s), and includes the parameters: serviceType, areaScope, qoECollectionEntityAddress, pLMNTarget, qoETarget, qoEReference and QMC configuration file.. 3.	The eNB checks for connections where the UE has the UE capability [9] that match the criteria for serviceType in the activateAreaQMCJob.. 4.	When a connection is found that has the wanted UE capability [9], the eNB starts a UE request session and stores the associated QoECollectionEntityAddress, sends the message RRCConnectionReconfiguration to the UE, and includes the following: serviceType, qoEReference and QMC configuration file.. 5.	The access stratum in the UE sends the AT command +CAPPLEVMC to application level and includes the following: serviceType, qoEReference and QMC configuration file.. 6.	When the application in the serviceType starts, the QMC is initiated.. 7.	The application layer sends the AT command +CAPPLEVMR including a recording session indication that indicates that a session is started to the access stratum.. 8.	The UE sends the message MeasReportAppLayer including the recording session indication to the eNB.. 9.	The eNB sends a notification including the recording session indication to the NM.. 10.	When the QMC is completed, the recorded information is collected in a QMC report [6], [7], including qoEReference and recordingSessionId. The qoEReference, Client Id [6] and [7] in the reporting container (that represent the UE request session), and recordingSessionId are needed in the QMC collection entity for post processing purposes.. 11.	The application layer sends the AT command +CAPPLEVMR including qoEReference and the QMC report to the access stratum.. 12.	The UE sends the message MeasReportAppLayer including qoEReference and the QMC report to the eNB.. 13.	The eNB sends the QMC report to the MCE associated to the qoEReference.",TS 28.405,4.2.1,all_images/image_1232.png,QMC activation and reporting in LTE
"The figure 4.2.2.2-1 and the text below describes the handling at handover between eNBs.. Figure 4.2.2.2-1: Handling of QMC activation in case of handover in LTE. 1.	Source eNB sends the message HandoverRequest to Target eNB and includes areaScope and qoECollectionEntityAddress.. 2.	The target eNB checks if the target cell is inside the areaScope or not.. 3.	The target eNB sends the message HandoverRequestAcknowledge to the source eNB.. 4.	The source eNB sends the message RRCConnectionReconfiguration to the UE.. 5.	The access stratum in the UE sends the AT command +CAPPLEVMC to application level.. 6.	The UE sends the message RRCConnectionReconfigurationComplete to the eNB.. 7.	When the application becomes active, QMC is initiated if the UE is inside the areaScope.. 8.	The application layer sends the AT command +CAPPLEVMR including a recording session indication indicating that a session has started to the access stratum.. 9.	The UE sends the message MeasReportAppLayer including the recording session indication to the eNB.. 10.	The eNB sends a notification including the recording session indication to the NM.. 11.	When the QMC is completed, the recorded information is collected in a QMC report [6], [7]. including qoEReference and recordingSessionId. The qoEReference, Client Id [6] and [7] in the reporting container (that represent the UE request session) and recordingSessionId are needed in the QoE collection entity for post processing purposes.. 12.	The application layer sends the AT command +CAPPLEVMR including qoEReference and the QMC report to the access stratum.. 13.	The UE sends the message MeasReportAppLayer including qoEReference and the QMC report to the eNB.. 14.	The eNB sends the QMC report to the MCE associated to the qoEReference.",TS 28.405,4.2.2.2,all_images/image_1233.png,Handling of QMC activation in case of handover in LTE
"This clause depicts the set of classes (e.g. IOCs) that encapsulates the information relevant for this gNB and en-gNB. For the UML semantics, see 3GPP TS 32.156 [43]. Subsequent clauses provide more detailed specification of various aspects of these classes.
The model fragments are for management representation of gNB and en-gNB for all NG-RAN deployment scenario as listed below.
-	Non-split NG-RAN deployment scenario, represents the gNB defined in TS 38.401[4]. In this scenario, a gNB is represented by a combination of a GNBCUCPFunction, one or more GNBCUUPFunctions and one or more GNBDUFunctions.
-	2-split NG-RAN deployment scenario, represents the gNB consist of gNB-CU and gNB-DU defined in TS 38.401[4] clause 6.1.1. In this scenario, a gNB-CU is represented by a combination of a GNBCUCPFunction and one or more GNBCUUPFunctions, whereas a gNB-DU is represented by a GNBDUFunction.
-	3-split NG-RAN deployment scenario, represents the gNB consist of gNB-CU-CP, gNB-CU-UP and gNB-DU defined in TS 38.401[4] clause 6.1.2. In this scenario, a gNB-CU-CP is represented by a GNBCUCPFunction, a gNB-CU-UP is represented by a GNBCUUPFunction, and a gNB-DU is represented by a GNBDUFunction.
Figure 4.2.1.1-1: NRM for all deployment scenarios
Figure 4.2.1.1-2: NRM for EPs for all deployment scenarios
Figure 4.2.1.1-3: NRM for <<IOC>>NRSectorCarrier and <<IOC>>BWP for all deployment scenarios
Figure 4.2.1.1-4: Cell Relation view for all deployment scenarios
NOTE 1:	The above NRM fragment uses SubNetwork to hold both NR and LTE external entities and frequencies.
Figure 4.2.1.1-5: Cell Relation view for all deployment scenarios
NOTE 2:	The above NRM fragment uses NRNetwork to hold NR external entities and frequency and using EUtraNetwork to hold LTE external entities and frequency. The NRNetwork and EUtraNetwork are subclasses of SubNetwork (defined in TS 28.622 [30]) with no additional attributes. The reason using NRNetwork and EUtraNetwork is for a clean separation of NR external entities and frequency and LTE external entities and frequency.
Figure 4.2.1.1-6: NRM fragment for abstract RRM Policies
Figure 4.2.1.1-6a: NRM fragment for RRMPolicyRatio
Figure 4.2.1.1-7: NRM fragment to support RIM
The Figure 4.2.1.1-8 shows the NRM fragment for pre-configured 5QIs in NG-RAN.
Figure 4.2.1.1-8: NRM fragment for pre-configured 5QIs in NG-RAN
Figure 4.2.1.1-9: NRM fragment for DANR Management
Figure 4.2.1.1-10: NRM fragment for DES Management
Figure 4.2.1.1-11: NRM fragment for DRACH Management
Figure 4.2.1.1-12: NRM fragment for DMRO Management
Figure 4.2.1.1-13: NRM fragment for DPCI Management
Figure 4.2.1.1-14: NRM fragment for CES Management
Figure 4.2.1.1-15: NRM fragment for CPCI Management
The Figure 4.2.1.1-16 shows the NRM fragment for dynamic 5QIs in NG-RAN.
Figure 4.2.1.1-16: NRM fragment for dynamically assigned 5QIs in NG-RAN
Figure 4.2.1.1-17: NRM fragment for NG-RAN MOCN network sharing with multiple cell identity broadcast feature
Figure 4.2.1.1-18: NRM fragment for F1 related EPs to support individual F1 interface for NG-RAN MOCN network sharing with multiple cell identity broadcast feature
Figure 4.2.1.1-19: NRM fragment for DLBO Management
Figure 4.2.1.1-20: NRM fragment for CCO Management",TS 28.541,4.2.1.1,all_images/image_1237.jpeg,NRM for <<IOC>>NRSectorCarrier and <<IOC>>BWP for all deployment scenarios
"This clause depicts the inheritance relationships that exist between IOCs.
Figure 5.2.1.2-1 shows the inheritance hierarchy from IOC ManagedFunction related to the 5GC NF NRM.
Figure 5.2.1.2-1: Inheritance hierarchy from IOC ManagedFunction related to the 5GC NF NRM
Figure 5.2.1.2-2 shows the inheritance hierarchy from IOC EP_RP related to 5GC NF NRM.
Figure 5.2.1.2-2: Inheritance hierarchy from IOC EP_RP related to the 5GC NF NRM
Figure 5.2.1.2-3: Inheritance hierarchy for IOC QFQoSMonitoringControl
Figure 5.2.1.2-4: Inheritance hierarchy for IOC GtpUPathQoSMonitoringControl
Figure 5.2.1.2-5: Inheritance hierarchy for IOC Configurable5QISet
Figure 5.2.1.2-6: Inheritance hierarchy for IOC FiveQiDscpMapping
Figure 5.2.1.2-7: Inheritance hierarchy for predefined PCC rule modeling
Figure 5.2.1.2-8: Inheritance hierarchy for IOC Dynamic5QISet
Figure 5.2.1.2-9: Inheritance hierarchy for EcmConnectionInfo
Figure 5.2.1.2-10: FiveQICharacteristics Inheritance",TS 28.541,5.2.1.2,all_images/image_1246.png,Inheritance hierarchy from IOC ManagedFunction related to the 5GC NF NRM 
"This clause depicts the inheritance relationships that exist between IOCs.
Figure 5.2.1.2-1 shows the inheritance hierarchy from IOC ManagedFunction related to the 5GC NF NRM.
Figure 5.2.1.2-1: Inheritance hierarchy from IOC ManagedFunction related to the 5GC NF NRM
Figure 5.2.1.2-2 shows the inheritance hierarchy from IOC EP_RP related to 5GC NF NRM.
Figure 5.2.1.2-2: Inheritance hierarchy from IOC EP_RP related to the 5GC NF NRM
Figure 5.2.1.2-3: Inheritance hierarchy for IOC QFQoSMonitoringControl
Figure 5.2.1.2-4: Inheritance hierarchy for IOC GtpUPathQoSMonitoringControl
Figure 5.2.1.2-5: Inheritance hierarchy for IOC Configurable5QISet
Figure 5.2.1.2-6: Inheritance hierarchy for IOC FiveQiDscpMapping
Figure 5.2.1.2-7: Inheritance hierarchy for predefined PCC rule modeling
Figure 5.2.1.2-8: Inheritance hierarchy for IOC Dynamic5QISet
Figure 5.2.1.2-9: Inheritance hierarchy for EcmConnectionInfo
Figure 5.2.1.2-10: FiveQICharacteristics Inheritance",TS 28.541,5.2.1.2,all_images/image_1247.png,Inheritance hierarchy from IOC EP_RP related to the 5GC NF NRM 
"Figure 6.2.1-1: Network slice NRM fragment relationship
NOTE 1:	The <<OpenModelClass>> NetworkService and <<OpenModelClass>> VNF are defined in [40].
NOTE 2:	The target Network Service (NS) instance represents a group of VNFs and PNFs that are supporting the source network slice subnet instance.
NOTE 3:	The instance tree of this NRM fragment would not contain the instances of NetworkService and VNF. However, the NetworkSliceSubNet instances would have an attribute holding the identifiers of NetworkService instances and the ManagedFunction instance would have an attribute holding identifiers of VNF instances.
NOTE 4: NOTE 4: Any instance of the NetworkSliceSubnet IOC is associated to 0 to 1 instance of the NetworkSlice IOC:
- 1: applies to the top/root NetworkSliceSubnet IOC instance directly associated to a NetworkSlice IOC instance.
- 0: applies to all non-top/non-root NetworkSliceSubnet IOC instances, also known as constituent network slice subnets, not directly associated to a NetworkSlice IOC instance.
Any instance of the NetworkSlice IOC is associated to exactly one instance of NetworkSliceSubnet IOC (i.e. the top/root NetworkSliceSubnet IOC instance).
Figure 6.2.1-2: Transport EP NRM fragment relationship
Figure 6.2.1-3: containment relationship for network slice fragment
Figure 6.2.1-4: containment relationship for feasibility check and resource reservation NRM fragment",TS 28.541,6.2.1,all_images/image_1248.jpeg,containment relationship for feasibility check and resource reservation NRM fragment
"ZSM framework reference architecture is described in ETSI GS ZSM 002 [29]. The ZSM framework reference architecture defines a set of architectural building blocks that collectively enable construction of more complex management services and management functions using a consistent set of composition and interoperation patterns. So it is important to show the 3GPP Management Service deployment based on ZSM Framework.Figure 5.3-1 shows an example of 3GPP Management Service deployment based on ZSM framework reference architecture. In this example:
-	3GPP Cross Management Domain (A bundle of Cross Domain MnFs) provides a set of MnS(s) for Cross Domain Network (including Network Slice) and consumes MnSs provided by the RAN Management Domain and the CN Management Domain. 3GPP Cross Management Domain can implement close loop (s) within the domain.  3GPP Cross Management Domain is a part of E2E Service Management Domain in ETSI ZSM Framework.
-	RAN Management Domain (A bundle of RAN MnFs) provides a set of MnS(s) for the RAN SubNetwork and NF. RAN Management Domain can implement close loop(s) within the domain.  RAN Management Domain is a Management Domain in ETSI ZSM Framework.
-	CN Management Domain (A bundle of CN MnFs) provides a set of MnS(s) for the CN SubNetwork and NF. CN Management Domain can implement close loop(s) within the domain. CN Management Domain is a Management Domain in ETSI ZSM Framework.
-	A 3GPP Management Framework Consumer (e.g. vertical OT system, BSS) can consume MnS(s) provided by the 3GPP Cross Management Domain, RAN Management Domain,CN Management Domain. 3GPP Management Framework Consumer is a ZSM framework consumer in ETSI ZSM Framework.
Figure 5.3-1: An example of Management Service deployment framework.
The closed control loop SLS assurance (COSLA) is an example of the closed loop in ZSM framework. COSLA can be deployed at domain level or cross domain level. A domain COSLA provides domain specific assurance, e.g. closed control loop assurance in a RAN management domain, CN management domain. A cross domain COSLA can provide a part of end-to-end SLS assurance service, e.g. to assure the service experience in 3GPP cross management domain.",TS 28.533,5.3,all_images/image_1249.jpeg,An example of Management Service deployment framework.
"An NG-RAN node, which connects with 5GC to provide boost capacity, may enter into energySaving state if there is radio coverage by other radio systems – be another NG-RAN node or an entity of another radio access technology - for the whole coverage area of the NG-RAN node in question, see figure 5.1.3.3-1 for gNB capacity booster cell fully overlaid by candidate cell(s) case.
Figure 5.1.3.3-1: gNB capacity booster cell fully overlaid by candidate cell(s)
This use case applies both for Intra- and Inter-RAT Energy Saving.
Inter-frequency Intra-RAT gNB Coverage
Two gNB cells (Cell A, Cell B) with separate frequency bands cover the same geographical area. Cell B has a smaller size than Cell A and is covered totally by Cell A. Generally, Cell A is deployed to provide continuous coverage of the area, while Cell B increases the capacity of the special sub-areas, such as hot spots. The ES activation procedure in the coverage of Cell B (ES area) may be triggered in case that light traffic in Cell B is detected. Cell B ES activation may also be triggered when the traffic of ES area (measured by candidate Cell A) resumes to a high level. A Cell B capable of ES probing can execute the ES probing procedure and based on Cell B measurements the centralized or distributed ES management can decide if the Cell B needs to be activated and take portion of the traffic from Cell A.
Inter-RAT gNB Coverage
Two IRAT cells (Cell A, Cell B) cover the same geographical area. gNB Cell B is totally covered by inter-RAT Cell A (such as legacy system UMTS or LTE). Cell A is deployed to provide continuous coverage of basic eMBB services in the area, while Cell B enhances the capability of the area to support eMBB services with high data rate or URLLC services. The ES activation in the coverage of Cell B (ES area) may be triggered in case that no eMBB services with high data rate or URLLC traffic in Cell B is detected or load threshold for going into energySaving state is reached. Cell B ES deactivation may be triggered when the eMBB services with high data rate or URLLC service request in ES area is restarted again or load threshold for going out of energySaving state (i.e. going into notEnergySaving state) is reached. A Cell B capable of ES probing can execute the ES probing procedure and based on Cell B measurements the centralized or distributed ES management can decide if the Cell B needs to be activated and take portion of the traffic from Cell A.
Different scenarios of gNB capacity booster cell fully overlaid by candidate cell(s) are listed in below table 5.1.3.3-1.
Table 5.1.3.3-1: Different scenarios of gNB capacity booster cell fully overlaid by candidate cell(s)
Traceability: REQ-ESCOL-FUN-1, REQ-ESCOL-FUN-2, REQ-ESCOL-FUN-3, REQ-ESCOL-FUN-4, REQ-ESCOL-FUN-5, REQ-ESCOL-FUN-6, REQ-ESCOL-FUN-7.",TS 28.310,5.1.3.3,all_images/image_1250.jpeg,gNB capacity booster cell fully overlaid by candidate cell(s)
"The NPN-SP/OP follows the mechanisms used for the control and configuration of the Trace and MDT as described in TS 32.422 [16], including:
-	the MDT/trace activation procedures in clause 4.1 of TS 32.422 [16] for MDT/trace configuration, and,
-	the MDT/trace reporting procedures in clause 4.6 and 4.7 of TS 32.422 [16] for UE related data reporting.
Figure 6.1.1-1: Procedures of UE related data collection
Figure 6.1.1-1 shows the procedure of UE related data collection.
It is assumed that the NPN-SP and NPN-OP roles are played by the same actor in figure 6.1.1-1. The work flow between NPN-SP and NPN-SC for the pre-defined agreements is out of scope of the present document.
1)	Based on the pre-defined agreements, NPN-SC sends ""Create MDT collection task"" request to NPN-SP/OP.
2)	The NPN-SP/OP sends a Trace Session activation request to the NE. This request includes the parameters for configuring MDT data collection such as area, job type and list of measurements.
3)	After receiving the MDT collection request, NE performs the UE selection based on the input information derived from NPN-SP/OP, such as device capability information and area scope.
4)	NE shall activate the MDT functionality and send configuration information to the selected UEs (see clause 4.1 of clause of TS 32.422 [16]).
5)	When UE receives the MDT activation, it shall start the MDT functionality based on the received configuration parameters. The MDT related measurements are then reported to NE.
6)	Then NE reports the related data to NPN-SP/OP (see clauses 4.6 and 4.7 of TS 32.422 [16]).
7)	According to pre-defined agreements among the NPN roles, some specific UE related data can be provided to authorized NPN customer (see clause 7.2 of TS 28.537 [17]) such data may be processed or masked based on collected data such as MDT or trace. For example, GNSS information can be extracted from MDT to locate assets in NPN.",TS 28.557,6.1.1,all_images/image_1260.jpeg,Procedures of UE related data collection
"An SNPN, which includes 3GPP segment only, may need to be created for use of an NPN-SC. It is illustrated as provisioning a SNPN in figure 6.2.1-1 which can be used for create SNPN in the MNO Managed Mode and Vertical Managed Mode (see clause 4.3.2).
Figure 6.2.1-1: Procedure of SNPN provisioning with 3GPP segments only
1)	NPN-SP receives SLA requirements of the requested SNPN from NPN-SC. The SLA requirements specifies NPN related SLA according to different vertical industry requirements (e.g. coverage requirement within a specific geographic area, downlink/uplink throughput requirements, latency requirement, etc.) together with other business related information (e.g. NPN lifetime, etc.). The work flow between NPN-SP and NPN-SC is out of scope of present specification.
2)	Based on the requirements from NPN-SC, NPN-SP maps SLS into 3GPP-related NPN requirements including RAN/CN/TN part-related requirements.
3)	 The NPN-SP sends the 3GPP-related NPN requirements in form of NRM fragments (e.g. ServiceProfile <dataType>) to NPN-OP.
4)	The NPN-OP determines the constituent network resources and topology needed for the SNPN creation. The related Managed Object instance (reference to related information models for NR, 5GC in TS 28.541 [7] and generic NRM in TS 28.622 [15], e.g., GNBCUCPFunction IOC, GNBDUFunction IOC, GNBCUUPFunction IOC, SubNetwork IOC, Top IOC and etc.) would be created for the requested SNPN using the operations (e.g. createMOI operations) of generic provisioning MnS in TS 28.532 [14].
The NPN-OP determines to reuse an existing 3GPP segment or create a new 3GPP segment for the requested NPN. If a 3GPP segment from an existing stand-alone NPN can be reused, the NPN-OP may reconfigure that SNPN:
a)	In case of creating a new 3GPP segment for the SNPN:
-	Based on RAN part-related requirements, the 3GPP network management system determines to utilize new RAN NE(s).
-	Based on CN part-related requirements, the 3GPP network management system determines to utilize new CN NF(s) or CN NF service(s).
-	Based on TN part-related requirements, the NPN operator configures the underlying transport network, considering the information on SNPN topology (e.g. external connection points of AN and CN) and performance (e.g. latency, bandwidth).
5)	The NPN-OP notifies the created 3GPP segment information (e.g. the DN of created MOI) to the NPN-SP which subscribes the provisioning notification by re-using the notifications (e.g. NotifyMOICreation notifications) of generic provisioning MnS in TS 28.532 [14].",TS 28.557,6.2.1,all_images/image_1261.png,Procedure of SNPN provisioning with 3GPP segments only
"LTE is typically deployed in areas with dense population in an attempt to mitigate traffic congestion during the peak hours. Therefore, initial LTE deployment may be patchy with underlaid UTRAN/GERAN networks that provide basic coverage. Figure 5.4.4.3-1 shows that there may be coverage holes between LTE cells.
Figure 5.4.4.3-1: LTE coverage hole with underlaid UTRAN/GERAN
The LTE coverage holes may be detected by the Inter-RAT measurements. The network can capture measurements (e.g. RSRP, RSRQ, cell ID, location, time stamp at the time of Inter-RAT handover), which can be collected for the CCO function and used to identify coverage holes in the LTE network.
The LTE coverage holes may be detected also using measurements performed by UEs in the idle mode. 
When an UE is in ""any cell selection"" or ""camped on any cell"" state, the periodic logging stops. 
When the UE re-enters ""camped normally"" state and the duration timer has not expired, the periodic logging is restarted (see clause 5.1.1.2 of 3GPP TS 37.320 [7]). 
Figure 5.4.4.3-2 is an example to show that an LTE coverage hole can be detected when an UE stops and resumes logging MDT measurements.
Figure 5.4.4.3-2: LTE coverage holes with and without underlaid UTRAN detected by logged MDT",TS 28.627,5.4.4.3,all_images/image_1262.jpeg,LTE coverage hole with underlaid UTRAN/GERAN
"The possible solutions to support the potential requirements REQ-CH_EC_5GS-03 and Key Issue #1c could be based on the 5G data connectivity converged charging architecture defined in TS 32.255 [6], with the extension of including monitored QoS result for URLLC service on Edge Computing in the usage report, as described below.
Solution #1g: Including the monitored QoS result in the usage report
Figure 7.1.4.1.2-1: Subscriber charging for 5GS usage for edge computing based on monitored QoS
The CHF of MNO is configured with quota and reporting threshold for subscriber charging for usage of 5GS capabilities supporting edge computing.
1)	UE starts using an edge application: Triggers is are according to TS 32.255 [6] and TS 32.290 [5].
2)	Charging Data Request [Initial, Quota Requested]: the SMF sends the request to the CHF to reserve a number of units if determined.
3)	Account, Rating, Reservation Control: the CHF checks if corresponding funds can be reserved on the edge application's account balance, for each Rating Group. If the account has sufficient funds, the CHF rates the request and performs the corresponding reservation for each Rating Group.
4)	Open CDR: based on policies, the CHF opens a CDR related to the service for edge application.
5)	Charging Data Response [Initial, Quota Granted]: the CHF grants the reserved number of units to SMF for each Rating Group.
6)	Granted Units Supervision: The SMF monitors the consumption of the granted units and the delivered QoS if the monitored QoS result for URLLC service on Edge Computing is requested for charging.
NOTE: how to request the monitored QoS results for charging is not addressed in the present document.
7)	UE edge application usage ongoing: the SMF continues to deliver the service.
8)	Quota management Trigger: A Trigger associated to Quota management is met. Units determination is performed when applicable.
9)	Charging Data Request [Update, Quota Requested, Usage Reporting]: the SMF sends the request to the CHF, to be granted with more unit for the service to continue, and also for reporting the used units. For the usage reporting, the monitored QoS result (e2e packet delay in 5GS) is included.
10)	Account, Rating, Reservation Control: same as step 4, with the option to also deduct the funds corresponding to the usage on the account balance.
11)	Update CDR: based on policies, the CHF updates the CDR with charging data related to the service.
12)	Charging Data Response [Update, Quota Granted]: The CHF grants quota to SMF for the service, with the reserved number of units for each Rating Group.
13)	Service delivery ongoing: the  NF (CTF) continues to deliver the service.
14)	UE stops using the edge application: the SMF is requested to end the service delivery and does this.
15)	Charging Data Request [Termination]: the SMF sends the request to the CHF, for charging data related to the service termination with the final consumed units for each Rating Group.
16)	Account, Rating Control: the CHF performs the service termination process which involve using the reported charging data to rate the usage and deduct the funds corresponding to the usage on the account balance.
17)	Close CDR: based on policies, the CHF closes the CDR with charging data related to the service termination and the last reported units for each Rating Group.
18)	Charging Data Response [Termination]: The CHF informs the SMF on the result of the request.",TR 28.815,7.1.4.1.2,all_images/image_1266.png,Subscriber charging for 5GS usage for edge computing based on monitored QoS
,TR 28.815,7.1.4.2,all_images/image_1267.png,5GS Inter-provider charging for edge computing (aggregation of SMF reported
"Solution #1l: The possible solutions to support the subscriber based charging related potential requirements REQ-CH_EC_5GS-02, and Key Issue #1b could be the following architecture.
The solution is appliable to the scenario where EAS is provided by the MNO.
Figure 7.1.4.3-1: EAS based solution
The solution with CTF embedded in the EAS is illustrated in Figure 7.1.4.3-2.
Figure 7.1.4.3-2: duration based charging for 5GS capabilities (with EAS supporting CTF)
The CHF of MNO is configured with quota and reporting threshold for duration charging.
The operations is the same with the 7.1.4.2-2, with EAS instead of the SMF.",TR 28.815,7.1.4.3,all_images/image_1268.png,duration based charging for 5GS capabilities (with EAS supporting CTF)
"The possible solutions for charging for edge enabling infrastructure resources are based on the following potential converged charging architectures. In these architectures, it is assumed that all the entities are owned by the same enterprise.
Figure 7.2.4.1-1: Converged charging architecture for edge enabling infrastructure resource with MnS producer supporting CTF
Figure 7.2.4.1-2: Converged charging architecture for edge enabling infrastructure resource with MnS producer
NOTE: the MnSs for managing edge computing are described in TR 28.814 [12].",TR 28.815,7.2.4.1,all_images/image_1269.jpeg,Converged charging architecture for edge enabling infrastructure resource with MnS
"The charging for edge enabling infrastructure resources could be supported with CTF embedded in the MnS producer or with CEF to enable the charging for MnS producer.
The solutions are only applicable to the case that the EAS is implemented as VNF.
Solution #2a: Edge enabling infrastructure resource usage charging - CTF embedded in the MnS producer
The solution with CTF embedded in the MnS producer is illustrated in Figure 7.2.4.2-1.
Figure 7.2.4.2-1: Edge enabling infrastructure resource usage (with MnS producer supporting CTF)
This solution uses performance data to report the usage of edge enabling infrastructure resources.
1)	Generate performance data for resource usage for EAS: performance assurance MnS producer generates performance data (measurements or KPI) about usage of edge enabling infrastructure resource supporting the EAS based on the mapping of VR usage measurements received from ETSI NFV MANO system as specified in TS 28.522 [18]. The performance data about edge enabling infrastructure resource could be related to data volume transferred for the EAS, virtual CPU usage of the EAS, virtual memory usage of the EAS, virtual disk usage of the EAS, or the virtual storage of the EAS.
1ch-a)	Charging Data Request [Event]: performance assurance MnS Producer generates charging data related to the collected resource usage and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
1ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
1ch-c)	Charging Data Response [Event]: The CHF informs the performance assurance MnS Producer on the result of the request.
2)	Report the CDR to BD: The CHF reports the CDR to BD (via CGF).
Solution #2b: Edge enabling infrastructure resource usage charging – with CEF enabling charging for MnS producer
The solution with CEF enabling charging for MnS producer is illustrated in Figure 7.2.4.2-2.
Figure 7.2.4.2-2: Edge enabling infrastructure resource usage (with CEF enabling charging for MnS producer)
This solution uses performance data to report the usage of edge enabling infrastructure resources.
1)	Create measurement job: The CEF creates measurement job to collect the performance data related to VR resource usage for EAS to performance assurance MnS producer (see TS 28.550 [15]).
1a)	Subscribe to performance data file notifications: If file reporting method is chosen for the measurement job, the CEF subscribes to the performance data file notifications.
2)	Generate performance data for resource usage for EAS: performance assurance MnS producer generates the performance data (measurements or KPI) about usage of edge enabling infrastructure resource supporting the EAS based on the mapping of the VR usage measurements received from ETSI NFV MANO system as specified in TS 28.522 [18], the MnS producer reports the performance data to the CEF. The performance data about edge enabling infrastructure resource could be related to data volume transferred for the EAS, virtual CPU usage of the EAS, virtual memory usage of the EAS, virtual disk usage of the EAS, or the virtual storage of the EAS.
3)	Performance data report to CEF: the performance assurance MnS producer reports the performance data to the CEF according the reporting method selected by the CEF for the measurement job.
If the file data reporting method is selected:
3a)	The performance data are reported by a notifyFileReady notification (see TS 28.532 [17]);
3b)	CEF fetches the file containing the performance data.
If the streaming data reporting method is selected:
3c) and 3d)	The performance assurance MnS producer establishes the streaming connection with the CEF if the connection has not been established (see TS 28.532 [17]);
3e)	The performance data are reported by the reportStreamData operation (see TS 28.532 [17]).
3ch-a)	Charging Data Request [Event]: The CEF generates charging data related to the collected resource usage and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
3ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
3ch-c)	Charging Data Response [Event]: The CHF informs the CEF on the result of the request.
4)	Report the CDR to BD: The CHF reports the CDR to BD (via CGF).
For both solutions, the reported usage may be used by BSS for interactions with OAM. For example if the limit of the authorized usage is reached, the BSS may request OAM to disable the operational state of the EAS (e.g., by consuming the provisioning MnS via modifyMOIAttributes operation) and OAM may request ETSI NFV MANO to stop the corresponding VNF/VNFC instances (e.g., via OperateVnfRequest operation, see ETSI GS NFV-IFA 008 [19]). The interactions between BSS and OAM are out of scope of the present document.",TR 28.815,7.2.4.2,all_images/image_1270.jpeg,Edge enabling infrastructure resource usage (with CEF enabling charging for MnS
"The possible solutions for charging for edge enabling infrastructure resources and services are based on the following potential converged charging architectures. In these architectures, it is assumed that the MnS producer, CHF, CEF and Billing Domain are owned by the same ECSP.
Figure 7.3.4.1-1: Converged charging architecture for edge application server deployment with MnS producer supporting CTF
Figure 7.3.4.1-2: Converged charging architecture for edge application server deployment with MnS producer not supporting CTF
NOTE: the MnSs for managing edge computing are described in TR 28.814 [12].",TR 28.815,7.3.4.1,all_images/image_1271.jpeg,Converged charging architecture for edge application server deployment with MnS
"The charging for EAS deployment could be supported with CTF embedded in the MnS producer or with CEF to enable the charging for MnS producer.
Solution #3a: EAS deployment charging - CTF embedded in the MnS producer
The solution with CTF embedded in the MnS producer is illustrated in Figure 7.3.4.2-1.
Figure 7.3.4.2-1: Charging for EAS deployment (with MnS producer supporting CTF) - PEC
1)	Chargeable event trigger configuration: The MnS Producer (CTF) is configured for which events there is a need to have charging interaction.
2)	EAS deployment request: The MnS consumer sends the EAS deployment request (i.e., instantiation, update, or termination) to the MnS producer.
3)	EAS deployment process: the MnS producer processes and executes the EAS deployment request according to the request.
4)	EAS deployment response: The MnS consumer sends the EAS deployment request to the MnS producer.
4ch-a)	Charging Data Request [Event]: The MnS Producer generates charging data related to the EAS deployment request and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
4ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
4ch-c)	Charging Data Response [Event]: The CHF informs the MnS Producer on the result of the request.
Solution #3b: EAS deployment charging - with CEF enabling charging for MnS producer
The solution with CEF enabling charging for MnS producer is illustrated in Figure 7.3.4.2 -2.
Figure 7.3.4.2-2: Charging for EAS deployment (with CEF enabling charging for MnS producer) - PEC
1)	CEF consumes the MnS: The CEF consumes the MnS (see TS 28.622 [16]) and subscribes to notifications for the EAS deployment reporting.
2)	EAS deployment request: The MnS consumer sends the EAS deployment request (i.e., instantiation, update, or termination) to the MnS producer.
3)	EAS deployment process: the MnS producer processes and executes the EAS deployment request according to the request.
4)	EAS deployment response: The MnS producer sends the EAS deployment request to the MnS consumer.
5)	EAS deployment notification: The MnS producer sends the EAS deployment notification to the CEF. That means the CEF needs to subscribe to the EAS deployment notification from the MnS producer beforehand.
5ch-a)	Charging Data Request [Event]: The CEF generates charging data related to the EAS deployment notification and sends the charging data request.
5ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
5ch-c)	Charging Data Response [Event]: The CHF informs the CEF on the result of the request.",TR 28.815,7.3.4.2,all_images/image_1272.jpeg,Charging for EAS deployment (with MnS producer supporting CTF) - PEC
"The charging for EAS deployment could be supported with CTF embedded in the MnS producer or with CEF to enable the charging for MnS producer.
Solution #3a: EAS deployment charging - CTF embedded in the MnS producer
The solution with CTF embedded in the MnS producer is illustrated in Figure 7.3.4.2-1.
Figure 7.3.4.2-1: Charging for EAS deployment (with MnS producer supporting CTF) - PEC
1)	Chargeable event trigger configuration: The MnS Producer (CTF) is configured for which events there is a need to have charging interaction.
2)	EAS deployment request: The MnS consumer sends the EAS deployment request (i.e., instantiation, update, or termination) to the MnS producer.
3)	EAS deployment process: the MnS producer processes and executes the EAS deployment request according to the request.
4)	EAS deployment response: The MnS consumer sends the EAS deployment request to the MnS producer.
4ch-a)	Charging Data Request [Event]: The MnS Producer generates charging data related to the EAS deployment request and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
4ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
4ch-c)	Charging Data Response [Event]: The CHF informs the MnS Producer on the result of the request.
Solution #3b: EAS deployment charging - with CEF enabling charging for MnS producer
The solution with CEF enabling charging for MnS producer is illustrated in Figure 7.3.4.2 -2.
Figure 7.3.4.2-2: Charging for EAS deployment (with CEF enabling charging for MnS producer) - PEC
1)	CEF consumes the MnS: The CEF consumes the MnS (see TS 28.622 [16]) and subscribes to notifications for the EAS deployment reporting.
2)	EAS deployment request: The MnS consumer sends the EAS deployment request (i.e., instantiation, update, or termination) to the MnS producer.
3)	EAS deployment process: the MnS producer processes and executes the EAS deployment request according to the request.
4)	EAS deployment response: The MnS producer sends the EAS deployment request to the MnS consumer.
5)	EAS deployment notification: The MnS producer sends the EAS deployment notification to the CEF. That means the CEF needs to subscribe to the EAS deployment notification from the MnS producer beforehand.
5ch-a)	Charging Data Request [Event]: The CEF generates charging data related to the EAS deployment notification and sends the charging data request.
5ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
5ch-c)	Charging Data Response [Event]: The CHF informs the CEF on the result of the request.",TR 28.815,7.3.4.2,all_images/image_1273.jpeg,Charging for EAS deployment (with CEF enabling charging for MnS producer) - PEC
"Solution #4a: The solution for EAS registration charging based on IEC is illustrated in the Figure 7.4.4.2-1.
Figure 7.4.4.2-1: Charging for EAS registration - IEC
1.	The EAS sends the Edge Application Server Registration request (see TS 23.558 [4]) to the EES.
1ch-a)	Charging Data Request [Event]: The CEF generates charging data related to the Edge Application Server Registration request and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
1ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
1ch-c)	Charging Data Response [Event]: The CHF informs the CEF on the result of the request.
2.	The EES sends Edge Application Server Registration response (see TS 23.558 [4]) to the EAS.
Solution #4b: The solution for EAS registration charging based on PEC is illustrated in the Figure 7.4.4.2-2.
Figure 7.4.4.2-2: Charging for EAS registration - PEC
1.	The EAS sends the Edge Application Server Registration request (see TS 23.558 [4]) to the EES.
2.	The EES sends Edge Application Server Registration response (see TS 23.558 [4]) to the EAS.
2ch-a)	Charging Data Request [Event]: The CEF generates charging data related to the Edge Application Server Registration and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
2ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
2ch-c)	Charging Data Response [Event]: The CHF informs the CEF on the result of the request.",TR 28.815,7.4.4.2,all_images/image_1274.jpeg,Charging for EAS registration - IEC
"Solution #4c: The solution for EAS discovery charging based on IEC is illustrated in the Figure 7.4.4.3-1.
Figure 7.4.4.3-1: Charging for EAS discovery - IEC
1.	The EEC sends the Edge Application Server discovery request (see TS 23.558 [4]) to the EES.
1ch-a)	Charging Data Request [Event]: The CEF generates charging data related to the Edge Application Server discovery request and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
1ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
1ch-c)	Charging Data Response [Event]: The CHF informs the CEF on the result of the request.
2.	The EES sends Edge Application Server discovery response (see TS 23.558 [4]) to the EEC.
Solution #4d: The solution for EAS discovery charging based on PEC is illustrated in the Figure 7.4.4.3-2.
Figure 7.4.4.3-2: Charging for EAS discovery - PEC
1.	The EEC sends the Edge Application Server discovery request (see TS 23.558 [4]) to the EES.
2.	The EES sends Edge Application Server discovery response (see TS 23.558 [4]) to the EEC.
2ch-a)	Charging Data Request [Event]: The CEF generates charging data related to the Edge Application Server discovery and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
2ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
2ch-c)	Charging Data Response [Event]: The CHF informs the CEF on the result of the request.",TR 28.815,7.4.4.3,all_images/image_1275.jpeg,Charging for EAS discovery - IEC
"Solution #4e: The solution for EAS application context transfer charging based on IEC is illustrated in the Figure 7.4.4.4-1.
Figure 7.4.4.4-1: Charging for EAS application context transfer - IEC
1.	The EEC sends the Application Context Relocation request (see TS 23.558 [4]) to the S-EES.
1ch-a)	Charging Data Request [Event]: The CEF generates charging data related to the Application Context Relocation request and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
1ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
1ch-c)	Charging Data Response [Event]: The CHF informs the CEF on the result of the request.
2.	The S-EES sends Application Context Relocation Notify (see TS 23.558 [4]) to the S-EAS.
3.	The S-EAS sends Application Context Relocation Complete (see TS 23.558 [4]) to the S-EES.
4.	The S-EES sends Application Context Relocation Complete (see TS 23.558 [4]) to the EEC.
Solution #4f: The solution for EAS application context transfer charging based on PEC is illustrated in the Figure 7.4.4.4-2.
Figure 7.4.4.4-2: Charging for EAS application context transfer - PEC
1.	The EEC sends the Application Context Relocation request (see TS 23.558 [4]) to the S-EES.
2.	The S-EES sends Application Context Relocation Notify (see TS 23.558 [4]) to the S-EAS.
3.	The S-EAS sends Application Context Relocation Complete (see TS 23.558 [4]) to the S-EES.
3ch-a)	Charging Data Request [Event]: The CEF generates charging data related to the Application Context Relocation and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
3ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
3ch-c)	Charging Data Response [Event]: The CHF informs the CEF on the result of the request.
4.	The S-EES sends Application Context Relocation Complete (see TS 23.558 [4]) to the EEC.
Solution #4g: The solution for EAS application context transfer charging based on ECUR is illustrated in the Figure 7.4.4.4-3.
Figure 7.4.4.4-3: Charging for EAS application context transfer - ECUR
1.	The EEC sends the Application Context Relocation request (see TS 23.558 [4]) to the S-EES.
1ch-a)	Charging Data Request (initial, quota request): The S-EES generates charging data related to the Application Context Relocation request and sends the charging data request to the CHF for quota request and CDR opening purpose.
1ch-b)	Create CDR: the CHF stores received information, conducts the account, rating and reservation control and opens a CDR related to the Application Context Relocation procedure.
1ch-c)	Charging Data Response (initial, quota granted): The CHF informs the S-EES on the result of the request.
2.	If the quota request was granted, the S-EES sends Application Context Relocation Notify (see TS 23.558 [4]) to the S-EAS.
3.	The S-EAS sends Application Context Relocation Complete (see TS 23.558 [4]) to the S-EES.
4.	The S-EES sends Application Context Relocation Complete (see TS 23.558 [4]) to the EEC.
4ch-a)	Charging Data Request (termination, used quota): The S-EES generates charging data related to the Application Context Relocation Complete and sends the charging data request to the CHF for CDR closing purpose.
4ch-b)	Close CDR: the CHF stores received information conducts the account and rating control and closes the CDR related to the Application Context Relocation procedure.
4ch-c)	Charging Data Request (termination): The CHF informs the S-EES on the result of the request.",TR 28.815,7.4.4.4,all_images/image_1276.jpeg,Charging for EAS application context transfer - IEC
"Solution #4e: The solution for EAS application context transfer charging based on IEC is illustrated in the Figure 7.4.4.4-1.
Figure 7.4.4.4-1: Charging for EAS application context transfer - IEC
1.	The EEC sends the Application Context Relocation request (see TS 23.558 [4]) to the S-EES.
1ch-a)	Charging Data Request [Event]: The CEF generates charging data related to the Application Context Relocation request and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
1ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
1ch-c)	Charging Data Response [Event]: The CHF informs the CEF on the result of the request.
2.	The S-EES sends Application Context Relocation Notify (see TS 23.558 [4]) to the S-EAS.
3.	The S-EAS sends Application Context Relocation Complete (see TS 23.558 [4]) to the S-EES.
4.	The S-EES sends Application Context Relocation Complete (see TS 23.558 [4]) to the EEC.
Solution #4f: The solution for EAS application context transfer charging based on PEC is illustrated in the Figure 7.4.4.4-2.
Figure 7.4.4.4-2: Charging for EAS application context transfer - PEC
1.	The EEC sends the Application Context Relocation request (see TS 23.558 [4]) to the S-EES.
2.	The S-EES sends Application Context Relocation Notify (see TS 23.558 [4]) to the S-EAS.
3.	The S-EAS sends Application Context Relocation Complete (see TS 23.558 [4]) to the S-EES.
3ch-a)	Charging Data Request [Event]: The CEF generates charging data related to the Application Context Relocation and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
3ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
3ch-c)	Charging Data Response [Event]: The CHF informs the CEF on the result of the request.
4.	The S-EES sends Application Context Relocation Complete (see TS 23.558 [4]) to the EEC.
Solution #4g: The solution for EAS application context transfer charging based on ECUR is illustrated in the Figure 7.4.4.4-3.
Figure 7.4.4.4-3: Charging for EAS application context transfer - ECUR
1.	The EEC sends the Application Context Relocation request (see TS 23.558 [4]) to the S-EES.
1ch-a)	Charging Data Request (initial, quota request): The S-EES generates charging data related to the Application Context Relocation request and sends the charging data request to the CHF for quota request and CDR opening purpose.
1ch-b)	Create CDR: the CHF stores received information, conducts the account, rating and reservation control and opens a CDR related to the Application Context Relocation procedure.
1ch-c)	Charging Data Response (initial, quota granted): The CHF informs the S-EES on the result of the request.
2.	If the quota request was granted, the S-EES sends Application Context Relocation Notify (see TS 23.558 [4]) to the S-EAS.
3.	The S-EAS sends Application Context Relocation Complete (see TS 23.558 [4]) to the S-EES.
4.	The S-EES sends Application Context Relocation Complete (see TS 23.558 [4]) to the EEC.
4ch-a)	Charging Data Request (termination, used quota): The S-EES generates charging data related to the Application Context Relocation Complete and sends the charging data request to the CHF for CDR closing purpose.
4ch-b)	Close CDR: the CHF stores received information conducts the account and rating control and closes the CDR related to the Application Context Relocation procedure.
4ch-c)	Charging Data Request (termination): The CHF informs the S-EES on the result of the request.",TR 28.815,7.4.4.4,all_images/image_1278.jpeg,Charging for EAS application context transfer - ECUR
"Solution #4h: The solution for one-time UE location request charging based on IEC is illustrated in the Figure 7.4.4.5.1-1.
Figure 7.4.4.5.1-1: Charging for one-time UE location request - IEC
1.	The EAS sends the UE location request (see TS 23.558 [4]) to the EES.
1ch-a)	Charging Data Request [Event]: The EES generates charging data related to UE location request and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
1ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
1ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.
2.	The EES checks the UE location with 3GPP network (see TS 23.558 [4]).
3.	The EES sends the UE location response (see TS 23.558 [4]) to the EAS.
Solution #4i: The solution for one-time UE location request charging based on PEC is illustrated in the Figure 7.4.4.5.1-2.
Figure 7.4.4.5.1-2: Charging for one-time UE location request - PEC
1.	The EAS sends the UE location request (see TS 23.558 [4]) to the EES.
2.	The EES checks the UE location with 3GPP network (see TS 23.558 [4]).
3.	The EES sends the UE location response (see TS 23.558 [4]) to the EAS.
3ch-a)	Charging Data Request [Event]: The EES generates charging data related to UE location request and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
3ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
3ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.",TR 28.815,7.4.4.5.1,all_images/image_1279.jpeg,Charging for one-time UE location request - PEC
"Solution #4j: The solution for UE location subscription charging based on IEC is illustrated in the Figure 7.4.4.5.2-1.
Figure 7.4.4.5.2-1: Charging for UE location subscription - IEC
1.	The EAS sends the UE location subscribe request (see TS 23.558 [4]) to the EES.
1ch-a)	Charging Data Request [Event]: The EES generates charging data related to UE location subscribe request and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
1ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
1ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.
2.	The EES subscribes to UE location from 3GPP Core Network (see TS 23.558 [4]).
3.	The EES may subscribe to UE expected behaviour analytics (UE mobility) from 3GPP Core Network (see TS 23.558 [4]).
4.	The EES sends the UE location subscribe response (see TS 23.558 [4]) to the EAS.
Solution #4k: The solution for UE location subscription charging based on PEC is illustrated in the Figure 7.4.4.5.2-2.
Figure 7.4.4.5.2-2: Charging for UE location subscription - PEC
1.	The EAS sends the UE location subscribe request (see TS 23.558 [4]) to the EES.
2.	The EES subscribes to UE location from 3GPP Core Network (see TS 23.558 [4]).
3.	The EES may subscribe to UE expected behaviour analytics (UE mobility) from 3GPP Core Network (see TS 23.558 [4]).
4.	The EES sends the UE location subscribe response (see TS 23.558 [4]) to the EAS.
4ch-a)	Charging Data Request [Event]: The EES generates charging data related to UE location subscription and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
4ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
4ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.
Solution #4l: The solution for UE location notification charging based on PEC is illustrated in the Figure 7.4.4.5.2-3.
Figure 7.4.4.5.2-3: Charging for UE location notification - PEC
1.	The EES detects the UE location (see TS 23.558 [4]).
2.	The EES sends the UE location notification (see TS 23.558 [4]) to the EAS.
2ch-a)	Charging Data Request [Event]: The EES generates charging data related to UE location notification and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
2ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
2ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.",TR 28.815,7.4.4.5.2,all_images/image_1280.jpeg,Charging for UE location subscription - PEC
"Solution #4p: The solution for ACR management events subscription charging based on IEC is illustrated in the Figure 7.4.4.7-1.
Figure 7.4.4.7-1: Charging for ACR management event subscription - IEC
1.	The EAS sends the ACR management event subscribe request (see TS 23.558 [4]) to the EES.
1ch-a)	Charging Data Request [Event]: The EES generates charging data related to ACR management event subscribe request and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
1ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
1ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.
2.	The EES checks the user plane path management event of the requesting UE with 3GPP Core Network (see TS 23.558 [4]).
3.	The EES may subscribe to UE expected behaviour analytics (UE mobility) from 3GPP Core Network (see TS 23.558 [4]).
4.	The EES sends the ACR management event subscribe response (see TS 23.558 [4]) to the EAS.
Solution #4q: The solution for ACR management event subscription charging based on PEC is illustrated in the Figure 7.4.4.7-2.
Figure 7.4.4.7-2: Charging for ACR management events subscription - PEC
1.	The EAS sends the ACR management event subscribe request (see TS 23.558 [4]) to the EES.
2.	The EES checks the user plane path management event of the requesting UE with 3GPP Core Network (see TS 23.558 [4]).
3.	The EES may subscribe to UE expected behaviour analytics (UE mobility) from 3GPP Core Network (see TS 23.558 [4]).
4.	The EES sends the ACR management event subscribe response (see TS 23.558 [4]) to the EAS.
4ch-a)	Charging Data Request [Event]: The EES generates charging data related to ACR management event subscription and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
4ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
4ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.",TR 28.815,7.4.4.7,all_images/image_1281.jpeg,Charging for ACR management event subscription - IEC
"Solution #4p: The solution for ACR management events subscription charging based on IEC is illustrated in the Figure 7.4.4.7-1.
Figure 7.4.4.7-1: Charging for ACR management event subscription - IEC
1.	The EAS sends the ACR management event subscribe request (see TS 23.558 [4]) to the EES.
1ch-a)	Charging Data Request [Event]: The EES generates charging data related to ACR management event subscribe request and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
1ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
1ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.
2.	The EES checks the user plane path management event of the requesting UE with 3GPP Core Network (see TS 23.558 [4]).
3.	The EES may subscribe to UE expected behaviour analytics (UE mobility) from 3GPP Core Network (see TS 23.558 [4]).
4.	The EES sends the ACR management event subscribe response (see TS 23.558 [4]) to the EAS.
Solution #4q: The solution for ACR management event subscription charging based on PEC is illustrated in the Figure 7.4.4.7-2.
Figure 7.4.4.7-2: Charging for ACR management events subscription - PEC
1.	The EAS sends the ACR management event subscribe request (see TS 23.558 [4]) to the EES.
2.	The EES checks the user plane path management event of the requesting UE with 3GPP Core Network (see TS 23.558 [4]).
3.	The EES may subscribe to UE expected behaviour analytics (UE mobility) from 3GPP Core Network (see TS 23.558 [4]).
4.	The EES sends the ACR management event subscribe response (see TS 23.558 [4]) to the EAS.
4ch-a)	Charging Data Request [Event]: The EES generates charging data related to ACR management event subscription and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
4ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
4ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.",TR 28.815,7.4.4.7,all_images/image_1282.jpeg,Charging for ACR management events subscription - PEC
"Solution #4r: for key issue #4b on charging for creation of Session with QoS based on IEC is illustrated in the Figure 7.4.4.8-1.
Figure 7.4.4.8-1: Charging for creation of Session with QoS - IEC
1.	The EAS sends the Session with QoS create request (see TS 23.558 [4]) to the EES.
1ch-a)	Charging Data Request [Event]: The EES generates charging data related to Session with QoS create request and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
1ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
1ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.
2.	The EES subscribes to PDU session status monitoring and request data session with specific QoS from 3GPP 5G Core Network (see TS 23.558 [4]).
3.	The EES sends Session with QoS create response (see TS 23.558 [4]) to the EAS.
Solution #4s: for key issue #4b on charging for creation of Session with QoS based on PEC is illustrated in the Figure 7.4.4.8-2.
Figure 7.4.4.8-2: Charging for creation of Session with QoS - PEC
1.	The EAS sends the Session with QoS create request (see TS 23.558 [4]) to the EES.
2.	The EES subscribes to PDU session status monitoring and request data session with specific QoS from 3GPP 5G Core Network (see TS 23.558 [4]).
3.	The EES sends Session with QoS create response (see TS 23.558 [4]) to the EAS.
3ch-a)	Charging Data Request [Event]: The EES generates charging data related to Session with QoS creation and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
3ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
3ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.
Solution #4t: for key issue #4b on charging for update of Session with QoS based on IEC is illustrated in the Figure 7.4.4.8-3.
Figure 7.4.4.8-3: Charging for update of Session with QoS - IEC
1.	The EAS sends the Session with QoS update request (see TS 23.558 [4]) to the EES.
1ch-a)	Charging Data Request [Event]: The EES generates charging data related to Session with QoS update request and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
1ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
1ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.
2.	The EES updates data session with specific QoS with 3GPP 5G Core Network (see TS 23.558 [4]).
3.	The EES sends Session with QoS update response (see TS 23.558 [4]) to the EAS.
Solution #4u: for key issue #4b on charging for update of Session with QoS based on PEC is illustrated in the Figure 7.4.4.8-4.
Figure 7.4.4.8-4: Charging for update of Session with QoS - PEC
1.	The EAS sends the Session with QoS update request (see TS 23.558 [4]) to the EES.
2.	The EES updates data session with specific QoS with 3GPP 5G Core Network (see TS 23.558 [4]).
3.	The EES sends Session with QoS update response (see TS 23.558 [4]) to the EAS.
3ch-a)	Charging Data Request [Event]: The EES generates charging data related to Session with QoS update and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
3ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
3ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.
Solution #4v: for key issue #4b on charging for Session with QoS notification based on PEC is illustrated in the Figure 7.4.4.x-5.
Figure 7.4.4.8-5: Charging for Session with QoS notification - PEC
1.	The EES detects User Plane event for Session with QoS from 3GPP 5G Core Network (see TS 23.558 [4]).
2.	The EES sends Session with QoS notification to EAS (see TS 23.558 [4]).
2ch-a)	Charging Data Request [Event]: The EES generates charging data related to Session with QoS notification and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
2ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
2ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.",TR 28.815,7.4.4.8,all_images/image_1284.jpeg,Charging for creation of Session with QoS - IEC
"Solution #4r: for key issue #4b on charging for creation of Session with QoS based on IEC is illustrated in the Figure 7.4.4.8-1.
Figure 7.4.4.8-1: Charging for creation of Session with QoS - IEC
1.	The EAS sends the Session with QoS create request (see TS 23.558 [4]) to the EES.
1ch-a)	Charging Data Request [Event]: The EES generates charging data related to Session with QoS create request and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
1ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
1ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.
2.	The EES subscribes to PDU session status monitoring and request data session with specific QoS from 3GPP 5G Core Network (see TS 23.558 [4]).
3.	The EES sends Session with QoS create response (see TS 23.558 [4]) to the EAS.
Solution #4s: for key issue #4b on charging for creation of Session with QoS based on PEC is illustrated in the Figure 7.4.4.8-2.
Figure 7.4.4.8-2: Charging for creation of Session with QoS - PEC
1.	The EAS sends the Session with QoS create request (see TS 23.558 [4]) to the EES.
2.	The EES subscribes to PDU session status monitoring and request data session with specific QoS from 3GPP 5G Core Network (see TS 23.558 [4]).
3.	The EES sends Session with QoS create response (see TS 23.558 [4]) to the EAS.
3ch-a)	Charging Data Request [Event]: The EES generates charging data related to Session with QoS creation and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
3ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
3ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.
Solution #4t: for key issue #4b on charging for update of Session with QoS based on IEC is illustrated in the Figure 7.4.4.8-3.
Figure 7.4.4.8-3: Charging for update of Session with QoS - IEC
1.	The EAS sends the Session with QoS update request (see TS 23.558 [4]) to the EES.
1ch-a)	Charging Data Request [Event]: The EES generates charging data related to Session with QoS update request and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
1ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
1ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.
2.	The EES updates data session with specific QoS with 3GPP 5G Core Network (see TS 23.558 [4]).
3.	The EES sends Session with QoS update response (see TS 23.558 [4]) to the EAS.
Solution #4u: for key issue #4b on charging for update of Session with QoS based on PEC is illustrated in the Figure 7.4.4.8-4.
Figure 7.4.4.8-4: Charging for update of Session with QoS - PEC
1.	The EAS sends the Session with QoS update request (see TS 23.558 [4]) to the EES.
2.	The EES updates data session with specific QoS with 3GPP 5G Core Network (see TS 23.558 [4]).
3.	The EES sends Session with QoS update response (see TS 23.558 [4]) to the EAS.
3ch-a)	Charging Data Request [Event]: The EES generates charging data related to Session with QoS update and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
3ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
3ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.
Solution #4v: for key issue #4b on charging for Session with QoS notification based on PEC is illustrated in the Figure 7.4.4.x-5.
Figure 7.4.4.8-5: Charging for Session with QoS notification - PEC
1.	The EES detects User Plane event for Session with QoS from 3GPP 5G Core Network (see TS 23.558 [4]).
2.	The EES sends Session with QoS notification to EAS (see TS 23.558 [4]).
2ch-a)	Charging Data Request [Event]: The EES generates charging data related to Session with QoS notification and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
2ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
2ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.",TR 28.815,7.4.4.8,all_images/image_1285.jpeg,Charging for update of Session with QoS - IEC
"Solution #4r: for key issue #4b on charging for creation of Session with QoS based on IEC is illustrated in the Figure 7.4.4.8-1.
Figure 7.4.4.8-1: Charging for creation of Session with QoS - IEC
1.	The EAS sends the Session with QoS create request (see TS 23.558 [4]) to the EES.
1ch-a)	Charging Data Request [Event]: The EES generates charging data related to Session with QoS create request and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
1ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
1ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.
2.	The EES subscribes to PDU session status monitoring and request data session with specific QoS from 3GPP 5G Core Network (see TS 23.558 [4]).
3.	The EES sends Session with QoS create response (see TS 23.558 [4]) to the EAS.
Solution #4s: for key issue #4b on charging for creation of Session with QoS based on PEC is illustrated in the Figure 7.4.4.8-2.
Figure 7.4.4.8-2: Charging for creation of Session with QoS - PEC
1.	The EAS sends the Session with QoS create request (see TS 23.558 [4]) to the EES.
2.	The EES subscribes to PDU session status monitoring and request data session with specific QoS from 3GPP 5G Core Network (see TS 23.558 [4]).
3.	The EES sends Session with QoS create response (see TS 23.558 [4]) to the EAS.
3ch-a)	Charging Data Request [Event]: The EES generates charging data related to Session with QoS creation and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
3ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
3ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.
Solution #4t: for key issue #4b on charging for update of Session with QoS based on IEC is illustrated in the Figure 7.4.4.8-3.
Figure 7.4.4.8-3: Charging for update of Session with QoS - IEC
1.	The EAS sends the Session with QoS update request (see TS 23.558 [4]) to the EES.
1ch-a)	Charging Data Request [Event]: The EES generates charging data related to Session with QoS update request and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
1ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
1ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.
2.	The EES updates data session with specific QoS with 3GPP 5G Core Network (see TS 23.558 [4]).
3.	The EES sends Session with QoS update response (see TS 23.558 [4]) to the EAS.
Solution #4u: for key issue #4b on charging for update of Session with QoS based on PEC is illustrated in the Figure 7.4.4.8-4.
Figure 7.4.4.8-4: Charging for update of Session with QoS - PEC
1.	The EAS sends the Session with QoS update request (see TS 23.558 [4]) to the EES.
2.	The EES updates data session with specific QoS with 3GPP 5G Core Network (see TS 23.558 [4]).
3.	The EES sends Session with QoS update response (see TS 23.558 [4]) to the EAS.
3ch-a)	Charging Data Request [Event]: The EES generates charging data related to Session with QoS update and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
3ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
3ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.
Solution #4v: for key issue #4b on charging for Session with QoS notification based on PEC is illustrated in the Figure 7.4.4.x-5.
Figure 7.4.4.8-5: Charging for Session with QoS notification - PEC
1.	The EES detects User Plane event for Session with QoS from 3GPP 5G Core Network (see TS 23.558 [4]).
2.	The EES sends Session with QoS notification to EAS (see TS 23.558 [4]).
2ch-a)	Charging Data Request [Event]: The EES generates charging data related to Session with QoS notification and sends the charging data request for the CHF to process the related charging data for CDR generation purpose.
2ch-b)	Create CDR: the CHF stores received information and creates a CDR related to the event.
2ch-c)	Charging Data Response [Event]: The CHF informs the EES on the result of the request.",TR 28.815,7.4.4.8,all_images/image_1286.jpeg,Charging for Session with QoS notification - PEC
"Solution #4w: this is an alternative solution to support the key issue #4a and #4b based on the following potential converged charging architecture.
Figure 7.4.4.9-1: Converged charging architecture with ECS supporting CEF
In this architecture, the CEF could be deployed with the ECS as depicted in Figure 7.4.4.9-1, the CEF within ECS:
-	subscribes notification from the EES to receive required information for charging.
-	aggregate the information for charging received from the EES.
-	generates charging event when the trigger conditions are met.
Alternatively, the CEF could be deployed as standalone functionality and the CEF:
-	subscribes notification from the EES to receive required information for charging.
-	aggregate the information for charging received from the EES.
-	generates charging event when the trigger conditions are met.
The possible solutions to support key issue #4x is illustrated in the Figure 7.4.4.9-2. In this solution, the CEF is deployed with the ECS.
Figure 7.4.4.9-2: Aggregated charging for edge enabling services
1)	The CEF subscribes notification from the EES to receive required information for charging. The subscription request may include EAS ID and a reporting rule of how a certain measurement shall be reported (e.g., when detecting a service/event had been invoked by the EAS for N times).
2)	The EAS invokes edge enabling service as defined in clause 7.4.1.
3)	The EES sends notification to the CEF when the reporting rule is met.
4)	The CEF aggregates the information for charging (e.g., amount of event) reported by one or multiple EES.
5ch-a. Charging Data Request [Event]: The CEF generates charging information related to the collected information and sends the charging data request to the CHF when the triggers condition is met.
5ch-b. Create CDR: The CHF stores received charging information, creates a CDR related to the event.
5ch-c. Charging Data Response [Event]:  The CHF sends the response to the CEF on the result of the request.",TR 28.815,7.4.4.9,all_images/image_1287.jpeg,Aggregated charging for edge enabling services
"This clause depicts the set of IOCs that encapsulate information relevant for this service. This clause provides the overview of all information object classes in UML. Subsequent clauses provide more detailed specification of various aspects of these information object classes.
The inventory NRM contains two alternatives for inventory data modeling. Alternative 1 is for NE structure and hardware inventory. Alternative 2 is an extended version for inventory information modeling consisting of NE structure, hardware, software and license data inventory.
Alternative 1, hardware inventory model
NOTE:	The listed cardinality numbers represent transient as well as steady-state numbers, and reflect all managed object creation and deletion scenarios.
Figure 4.2.1-1: Alternative 1 - Inventory Management NRM Containment/Naming and Association diagram
Each IOC instance is identified with a Distinguished Name (DN) according to 3GPP TS 32.300 [7] that expresses its containment hierarchy. As an example, the DN of a IOC representing a InventoryUnit could have a format like:
SubNetwork=Sweden,meContext=MEC-Gbg-1,ManagedElement=RNC-Gbg-1,InventoryUnit=Inv-1.
Alternative 2, extended model for hardware, software and licence inventory:
Figure 4.2.1-2: Alternative 2 - Inventory Management NRM Containment/Naming and Association diagram
NOTE:	Inventory information upload in alternative 2 is done using the FT IRP and related FT IRP notification capabilities",TS 28.632,4.2.1,all_images/image_1291.jpeg,Alternative 1 - Inventory Management NRM Containment/Naming and Association
"This clause depicts the set of IOCs that encapsulate information relevant for this service. This clause provides the overview of all information object classes in UML. Subsequent clauses provide more detailed specification of various aspects of these information object classes.
The inventory NRM contains two alternatives for inventory data modeling. Alternative 1 is for NE structure and hardware inventory. Alternative 2 is an extended version for inventory information modeling consisting of NE structure, hardware, software and license data inventory.
Alternative 1, hardware inventory model
NOTE:	The listed cardinality numbers represent transient as well as steady-state numbers, and reflect all managed object creation and deletion scenarios.
Figure 4.2.1-1: Alternative 1 - Inventory Management NRM Containment/Naming and Association diagram
Each IOC instance is identified with a Distinguished Name (DN) according to 3GPP TS 32.300 [7] that expresses its containment hierarchy. As an example, the DN of a IOC representing a InventoryUnit could have a format like:
SubNetwork=Sweden,meContext=MEC-Gbg-1,ManagedElement=RNC-Gbg-1,InventoryUnit=Inv-1.
Alternative 2, extended model for hardware, software and licence inventory:
Figure 4.2.1-2: Alternative 2 - Inventory Management NRM Containment/Naming and Association diagram
NOTE:	Inventory information upload in alternative 2 is done using the FT IRP and related FT IRP notification capabilities",TS 28.632,4.2.1,all_images/image_1292.jpeg,Alternative 2 - Inventory Management NRM Containment/Naming and Association
"Figure 6.1.1-1 illustrates the management architecture of mobile networks that include virtualized network functions.
Figure 6.1.1-1: The mobile network management architecture mapping relationship between 3GPP and NFV-MANO architectural framework
Physical mobile network management mainly relies on the interface Itf-N. With the introduction of NFV, mobile network management needs to also specify the virtualized network functions management. It involves not only one interface Itf-N, but also the interaction with NFV-MANO through defined reference points.
The management architecture in present document aligns with the NFV-MANO framework (ETSI NFV-MAN 001 [3]) with emphasis on the following aspects:
1) 	Mobile network is composed of physical and virtualized network elements. Application-specific aspects of both VNFs and PNFs, corresponding to physical NEs, shall be managed by 3GPP management system.
2) 	The architecture identifies the following entities which are defined in TS 32.101 [5], both of them are needed to extend the management functionalities for virtualized network and VNF:
-	NM, which plays one of the roles of OSS/BSS and is the consumer of reference point Os-Ma-nfvo.
-	DM/EM, if the EM includes the extended functionality, it can manage both PNF(s) and VNF(s).
3) 	The architecture identifies the following entities that share interfaces with NM, DM/EM and VNF:
-	NFV Orchestrator (NFVO)
-	VNF Manager (VNFM)
4)	 The architecture identifies the following main interfaces/reference points:
-	Itf-N, the interface between NM and DM/EM
-	Os-Ma-nfvo, the reference point between OSS/BSS and NFVO.
Note: 	In 3GPP specification, NM plays one of the roles of OSS/BSS.
-	Ve-Vnfm-em, the reference point between EM and VNFM.
-	Ve-Vnfm-vnf, the reference point between VNF and VNFM.",TS 28.500,6.1.1,all_images/image_1303.jpeg,The mobile network management architecture mapping relationship between 3GPP
"In this scenario, the following organizations play aforementioned roles as follows:
- Company-V plays the role of NSC
- Company-A plays the role of NSP and NOP
- As NSP, it has:
- a BSS, e.g. to manage its customers, products, contracts, and
- a SML, to manage the services that support its products
- As NOP, it has:
- its own 5G network (RAN + core). In this sub-use case, Company-A owns the whole set of network resources used by the service required to support the product ordered by Vertical V
- a NML, to manage the network resources used by services
Figure 5.5.1.1-1: Sub-use case 1 - NSP and NOP played by the same organization
Company-A product catalogue proposes the following product offerings:
- Network Slice eMBB with different flavours: Silver, Gold, Platinum
- Network Slice URLLC with different flavours: Silver, Gold, Platinum
Network Slice MIoT with different flavours: Silver, Gold, Platinum.
In this sub-use case 1:
1. Company-V (as the NSC) chooses a product from Company-A product offerings
2. Company-V sends a request to Company-A (as the NSP) to order the product ‘Network Slice eMBB Platinum’. To achieve this, a candidate API is TMF API 622 (Product Ordering)
2.1 Company-A BSS determines which service supports the product being ordered by Company-V and issues a request to its OSS/SML to order this service. This service can be e.g. a network slice. To achieve this, a candidate API is TMF API 641 (Service Ordering)
2.2 OSS / SML determines which network resources support the service being ordered and issues a request to the OSS / NML to allocate required network resources, e.g. network slice subnet(s), network functions, etc. To achieve this, candidate APIs are from 3GPP TS 28.531 and TS 28.532
2.3 OSS / NML allocates network resources required to support the service and informs OSS / SML back about the characteristics of the network resources being allocated
2.4 OSS / SML associates the allocated network resources to the service and informs its BSS back about the characteristics of the service supporting the product
3. Company-A (as the NSP) sends a reply to Company-V to inform that the product ordered is now available to Company-V.
NOTE: in this use case, aspects related to Transport Network(s) are not addressed as they are out of 3GPP scope.",TR 28.824,5.5.1.1,all_images/image_1304.jpeg,Sub-use case 1 - NSP and NOP played by the same organization
"In this scenario, the following organizations play aforementioned roles as follows:
- Company-V plays the role of NSC
- Company-A plays the role of NSP and NOP
- As NSP, it has:
- a BSS, e.g. to manage its customers, products, contracts, and
- a SML, to manage the services that support its products
- As NOP, it has:
- its own 5G core network. In this sub-use case, Company-A owns the whole set of 5G core network resources used by the service required to support the product ordered by Vertical-V
- a NML, to manage the 5G core network resources used by services
As Company-A has no RAN in all requested areas, it relies on external organizations, namely Company-X and Company-Y, to provide RAN coverage in the US and in Spain respectively. Therefore:
- Company-A plays the role of Communication Service Customer (CSC) wrt. Company-X and Company-Y who both play the role of Communication Service Provider (CSP)
- Both Company-X and Company-Y have their own catalogue of products to offer RAN coverage in their respective countries
- Both Company-X and Company-Y play the role of CSP (for their respective product offerings) and NOP (for their respective RAN).
Figure 5.5.1.2-1: Sub-use case 2 - NOP role played simultaneously by different organizations
Company-A product catalogue proposes the following product offerings:
- Network Slice eMBB with different flavours: Silver, Gold, Platinum
- Network Slice URLLC with different flavours: Silver, Gold, Platinum
Network Slice MIoT with different flavours: Silver, Gold, Platinum.
In this sub-use case 2:
1. Company-V (as the NSC) chooses a product from Company-A product offerings
2. Company-V sends a request to Company-A (as the NSP) to order the product ‘Network Slice eMBB Platinum’. To achieve this, a candidate API is TMF API 622 (Product Ordering)
2.1 Company-A BSS determines which service supports the product being ordered by Company-V and issues a request to its OSS/SML to order this service. This service can be e.g. a network slice. To achieve this, a candidate API is TMF API 641 (Service Ordering)
2.2 Company-A OSS / SML determines which network resources support the service being ordered and:
2.2.1 based on its knowledge that required 5G core network resources are available internally, it issues a request to its own OSS / NML to allocate required 5G core network resources, e.g. network slice subnet(s) for its 5G core network, etc. To achieve this, candidate APIs are from 3GPP TS 28.531 and TS 28.532
2.2.2 Company-A OSS / NML allocates 5G core network resources required to support the service and informs OSS / SML about the characteristics of the network resources being allocated
2.2.3 based on its knowledge that required RAN resources are not available internally, it informs Company-A BSS about missing RAN resources
2.3 Company-A BSS:
2.3.1 acting as a CSC, issues a request to Company-X to order product X-1 (e.g. from the Wholesale offerings) to get RAN coverage in the US. To achieve this, a candidate API is TMF AP 622 (Product ordering). Company-X, as the CSP, receives the product order. Company-X BSS determines which service supports the product being ordered by Company-A and issues a request to its OSS/SML to order this service. This service can be e.g. a network slice. To achieve this, a candidate API is TMF API 641 (Service Ordering). Company-X OSS / SML determines which network resources support the service being ordered, etc. Once completed, Company-X BSS informs Company-A BSS that the product which has been ordered is now available to Company-A
2.3.2 acting as a CSC, issues a request to Company-Y to order product Y-1 (e.g. from the inter-operator network slice offerings) to get RAN coverage in Spain. To achieve this, a candidate API is TMF AP 622 (Product ordering). Company-Y, as the CSP, receives the product order. Company-Y BSS determines which service supports the product being ordered by Company-A and issues a request to its OSS/SML to order this service. This service can be e.g. a network slice. To achieve this, a candidate API is TMF API 641 (Service Ordering). Company-Y OSS / SML determines which network resources support the service being ordered, etc. Once completed, Company-Y BSS informs Company-A BSS that the product which has been ordered is now available to Company-A
2.3.3 informs its own OSS/SML that required RAN resources are available
2.4 Company-A OSS / SML associates the network resources allocated either internally or externally (by Company-X or Company-Y) to the service and informs its BSS about the characteristics of the service supporting the product
3. Company-A (as the NSP) sends a reply to Company-V to inform that the product ordered is now available to Vertical-V.
NOTE: in this use case, aspects related to Transport Network(s) are not addressed as they are out of 3GPP scope.",TR 28.824,5.5.1.2,all_images/image_1305.jpeg,Sub-use case 2 - NOP role played simultaneously by different organizations
"The reference architecture depicted in figure 4.4.1-1 considers the case of a 3GPP RAN integrating a satellite NR-RAT, possibly together with a Terrestrial RAT. The NOP operates the 5G network interfacing through API's with Communication Service Customers or Verticals on the one hand and delivering services to UEs on the other hand. The 3GPP Management system manages the 3GPP RAN.
Figure 4.1.1-1: Reference architecture for the management of a satellite NR-RAT",TR 28.808,4.1.1,all_images/image_1306.jpeg,Reference architecture for the management of a satellite NR-RAT
"The reference architecture depicted in the following figure considers the case of a non-3GPP satellite RAN integrated in a 5G network. The NOP operates the 5G network interfacing through API's with Communication Service Customers or Verticals on the one hand and delivering services to UEs on the other hand. The 3GPP management system manages the 3GPP RAN and the non-3GPP RAN.
Figure 4.1.2-1: Reference architecture for the management of a non-3GPP satellite RAN",TR 28.808,4.1.2,all_images/image_1307.jpeg,Reference architecture for the management of a non-3GPP satellite RAN
"Consider two separate 3GPP networks, one 3GPP network with a satellite access network and one 3GPP network with a terrestrial access network. Both networks have their own PLMN ID and have a roaming agreement in place with each other. Roaming is used by the terrestrial operator to use the 3GPP network with a satellite access. Both the satellite and terrestrial network have their own separate 3GPP management domain.. NOTE: 	This scenario follows the architecture identified in the Satellite access class scenario in clause 4.1.3 from 3GPP TR 23.737 [5].. Figure 4.2.1-1: Architecture of satellite 3GPP network (green) 
as roaming network to a terrestrial 3GPP network (blue). NOTE: 	The green and blue networks are separate management domains.",TR 28.808,4.2.1,all_images/image_1308.jpeg,Architecture of satellite 3GPP network (green) 
"In this scenario a 3GPP network is composed out of a 3GPP core network, a terrestrial 3GPP access network and a satellite 3GPP access network, where the satellite component is also integrated as a 3GPP access network. The satellite network and the terrestrial network both share the same PLMN and both access networks are managed by the same 3GPP management system. This architecture scenario follows the Satellite access class scenario in clause 4.1.1 from 3GPP TR 23.737 [5].
Figure 4.2.2-1: Architecture of 3GPP network with a satellite 3GPP access network and a terrestrial 3GPP access network
Note: 	Both access networks are in the same management domains.",TR 28.808,4.2.2,all_images/image_1309.jpeg,Architecture of 3GPP network with a satellite 3GPP access network and a terrestrial
,TR 28.808,5.1.4,all_images/image_1310.jpeg,An NSI spanning both a Satellite RAN and a terrestrial RAN with two examples of
,TR 28.808,5.3.3,all_images/image_1311.jpeg,Capabilities for Multi-RATs load-balancing for Satellite and terrestrial RANs
"Based on roles related to 5G networks and network slicing management defined in clause 4.8 in 3GPP TS 28.530 [4], different kinds of intents are applicable for different kinds of standardized reference interfaces.
Figure 4.1.2-1: High-level model of different kind of intents expressed by different roles
-	Intent from Communication Service Customer (Intent-CSC): Intent from Communication Service Customer enables Communication Service Customer (CSC) to express which properties of a communication service the CSC may request from CSP without knowing how to do the detailed management for communication service. For example, Intent-CSC can be 'Enable a V2X communication service for a group of vehicles in certain time'.
-	Intent from Communication Service Provider (Intent-CSP): Intent from Communication Service Provider enables Communication Service Provider (CSP) to express an intent about what CSP would like to do for network without knowing how to do the detailed management for network. For example, Intent-CSP can be 'Provide a network service supporting V2X communications for highway-417 to support 500 vehicles simultaneously'.
-	Intent from Network Operator (Intent-NOP): Intent from Network Operator enables Network Operator (NOP) to provide what NOP would like to do for group of network elements (i.e. subnetwork) management and control without knowing how to do the detailed management for the network elements. For example, Intent-NOP can be 'Provide a radio network service to satisfy the specified coverage requirements and UE throughput requirement in certain area'.",TS 28.312,4.1.2,all_images/image_1312.jpeg,High-level model of different kind of intents expressed by different roles
"Each of the detailed task in clause 5.1.2 can be accomplished either manually by the operator or automatically by the telecom system. Following are the potential classifications of network autonomy for fault recovery based on the participation degree of the human operator and the telecom system:. Level 0:. -	All the tasks in the fault recovery workflow in clause 5.1.2 are accomplished by human.. Level 1:. -	Fault related information are collected (Task B) automatically by telecom system based on human predefined rules. Fault recovery actions (Task H) which can be executed without human intervention (e.g. system initialisations, activation of a backup or fall back software load) are triggered by human and executed by telecom system based on human defined execution rules.. -	All the other tasks in the fault recovery workflow are accomplished by human.. Level 2:. -	Compared to Level 1, telecom system additionally assist human operator to filter the alarms (Task C) based on the filtering rules predefined by human operator. Fault recovery execution (only for the actions that can be executed without human intervention) (Task H) are triggered by human and fully executed by telecom system based on human defined rules.. -	All the other tasks (Task A, Task D, Task E, Task F and Task G) are accomplished by human.. Level 3:. -	Compared to Level 2, telecom system can additionally identify the fault domain and type (Task D except for fault prediction) and analyse the root cause of the network fault (Task E). For certain network faults, telecom system can accomplish the fault recovery mechanism analysis (Task F) and action generation (Task G) based on the fault recovery policies pre-defined and specified by human.. -	Fault recovery intent translation (Task A) is accomplished by human, and all the other tasks (Task F and Task G) are accomplished by human operator for most of the faults except several conventional ones.. Level 4:. -	Compared to Level 3, the fault recovery mechanism analysis (Task F) and action generation (Task G) are accomplished automatically by telecom system without human intervention. Telecom system also can predict the fault based on service performance (e.g. QoE, call drop ratio, user experience). For certain scenario, telecom system additionally assist human operator to translate the fault recovery intent to the detailed fault recovery policies (Task A) based on human predefined policies.. -	Intent translation policies can be pre-defined and specified by human.. Level 5:. -	The entire fault RCA and recovery workflow is accomplished automatically by telecom system without human intervention and human predefined rules or policies.. -	Human can optionally supervise the fault recovery decision generated by telecom system.. Figure 5.1.3-1 illustrate the classification of network autonomy for fault recovery.. Figure 5.1.3-1: Classification of network autonomy for fault recovery",TR 28.810,5.1.3,all_images/image_1319.png,Classification of network autonomy for fault recovery
"Figure 4.3.1-1 illustrates the procedure for configuring the periodicity of heartbeat notifications using operations and notifications of the provisioning MnS (see clause 11.1.1 of [2]).
Figure 4.3.1-1: Procedure for configuring heartbeat notification periodicity",TS 28.537,4.3.1,all_images/image_1320.png,Procedure for configuring heartbeat notification periodicity
"This procedure shows how to update corresponding MOI(s) after a VNF is scaled. The procedure can be triggered by NM or EM.
Scenario 1: Triggered by NM
The use case for scenario 1 is in clause 6.4.5 of [2]. In this case, the main steps of the procedure are:
1)	NM receives the message indicating the VNF instance has been scaled from NFVO (refer to step 3 of procedure in clause 4.2.3.3 of TS 28.526 [4]).
2)	NM decides the MOI(s) corresponding to the subject VNF instance need to be updated.
3)	NM sends a request to EM to update the MOI(s) corresponding to the subject VNF instance.
4)	EM updates the attributes of the MOI(s) corresponding to the subject VNF instance.
5)	EM sends the notification to NM about the update of the MOI(s).
Note: 	The assumption of this scenario is that NM can know the relationship between VNF instance and corresponding MOI(s).
Figure 4.3-1: Procedure of updating MOI(s) after a VNF is scaled (Triggered by NM)
Scenario 2: Triggered by EM
The use case for scenario 2 is in clause 6.4.6 of [2]. In this case, the main steps of the procedure are:
1)	EM receives the message indicating the subject VNF has been scaled from VNFM.
2)	EM decides the MOI(s) corresponding to the subject VNF instance need to be updated.
3)	EM updates the attributes of the MOI(s) corresponding to the subject VNF instance.
4)	EM sends the notification to NM about the update of the MOI(s) plus the related information abstained in step 1.
Figure 4.3-2: Procedure of updating MOI(s) after a VNF is scaled (Triggered by EM)",TS 28.511,4.3,all_images/image_1322.jpeg,Procedure of updating MOI(s) after a VNF is scaled (Triggered by NM)
"This procedure shows the action of EM when it receives the VNF lifecycle change notification indicating a VNF instance has been terminated. It is assumed that a MO has been created to represent a VNF instance, and EM has subscribed to receive the VNF lifecycle change notification from VNFM:
1)	VNFM sends a Notify (see clause 7.3.3 [3]), carrying VnfLifecycleChangeNotification to EM (see clause 9.5.2 [3]) to indicate the result of VNF termination, when the VNF termination operation is completed.
2)	EM detects that a VNF instance has been terminated by checking the attributes status = ""result"" and operation = ""termination"", and decides to modify the MO attribute to remove the association with the VNF instance identified by vnfInstanceId.
3)	EM sends a notifyAttributeValueChange [6] to NM to indicate the MO attribute value has been changed.
Figure 4.5-1: VNF termination triggers MO attribute value change",TS 28.511,4.5,all_images/image_1323.jpeg,VNF termination triggers MO attribute value change
"There are two types of data analytics services, one is the network data analytics service provided by NWDAF, another is the MDAS provided by 3GPP management system. The MDAS producer provides the analytics data for management purposes based on the data related to different types of NFs or entities in the network, e.g., data reported from gNB and other core network functions. Depending on the scenario and when needed, the MDAS producer may use the analytics results of NWDAF as input.
MDAS Producer may be deployed as 3GPP domain-specific (e.g., RAN or CN) or as 3GPP cross-domain. Figure 5.2-1 shows an example of the coordination between NWDAF, gNB and MDAS producer(s) for data analytics purpose.
1.	The NWDAF may consume the MDAS for identified scenarios and provide analytics service for 5GC NF for control purpose.
2.	The CN Domain MDAS producer may consume the service provided by NWDAF and other 5GC NFs and provide analytics data for management purpose.
3.  The gNB many consume the MDAS for identified scenarios for RAN control purpose.
4.	The RAN Domain MDAS producer may consume the service provided by gNB and provide analytics data for management purpose.
5.  The 3GPP cross domain MDAS Producer may consume (acting as Domain MDAS consumer) MDAS provided by domain-specific (RAN and/or CN) MDAS producer(s), and produce MDAS that may be consumed by 3GPP cross-domain MDAS consumer(s).
Figure 5.2-1: Example of coordination between NWDAF, gNB and MDAS producer for data analytics
Figure 5.2-2 shows another example of the coordination between NWDAF and MDAS producer for data analytics purpose.
1.	The NWDAF may consume the MDAS for identified scenarios and provide analytics service for 5GC NF for control purpose.
2.	The gNB may consume the MDAS for identified scenarios for RAN control purpose.
3.	The Domain MDAS producer may consume the service provided by NWDAF, other 5GC NFs and gNB, provide analytic data for management purpose.
Figure 5.2-2: Example of coordination between NWDAF, gNB and MDAS producer for data analytics",TR 28.809,5.2,all_images/image_1325.jpeg,"Example of coordination between NWDAF, gNB and MDAS producer for data analytics "
"There are two types of data analytics services, one is the network data analytics service provided by NWDAF, another is the MDAS provided by 3GPP management system. The MDAS producer provides the analytics data for management purposes based on the data related to different types of NFs or entities in the network, e.g., data reported from gNB and other core network functions. Depending on the scenario and when needed, the MDAS producer may use the analytics results of NWDAF as input.
MDAS Producer may be deployed as 3GPP domain-specific (e.g., RAN or CN) or as 3GPP cross-domain. Figure 5.2-1 shows an example of the coordination between NWDAF, gNB and MDAS producer(s) for data analytics purpose.
1.	The NWDAF may consume the MDAS for identified scenarios and provide analytics service for 5GC NF for control purpose.
2.	The CN Domain MDAS producer may consume the service provided by NWDAF and other 5GC NFs and provide analytics data for management purpose.
3.  The gNB many consume the MDAS for identified scenarios for RAN control purpose.
4.	The RAN Domain MDAS producer may consume the service provided by gNB and provide analytics data for management purpose.
5.  The 3GPP cross domain MDAS Producer may consume (acting as Domain MDAS consumer) MDAS provided by domain-specific (RAN and/or CN) MDAS producer(s), and produce MDAS that may be consumed by 3GPP cross-domain MDAS consumer(s).
Figure 5.2-1: Example of coordination between NWDAF, gNB and MDAS producer for data analytics
Figure 5.2-2 shows another example of the coordination between NWDAF and MDAS producer for data analytics purpose.
1.	The NWDAF may consume the MDAS for identified scenarios and provide analytics service for 5GC NF for control purpose.
2.	The gNB may consume the MDAS for identified scenarios for RAN control purpose.
3.	The Domain MDAS producer may consume the service provided by NWDAF, other 5GC NFs and gNB, provide analytic data for management purpose.
Figure 5.2-2: Example of coordination between NWDAF, gNB and MDAS producer for data analytics",TR 28.809,5.2,all_images/image_1326.jpeg,"Example of coordination between NWDAF, gNB and MDAS producer for data analytics"
"Figure 4.2-1 provides an example of 3GPP – WLAN mapping function. The mapping function is to map the relevant management data produced by WLAN AP in a form suitable for distribution via the Type-2 interface to IRPManager(s). The mapping function is a logical function. Its location, as well as its internal and external interfaces, if any, are out the scope of 3GPP specification.
Figure 4.2-1: Example of 3GPP – WLAN Mapping Function",TS 28.680,4.2,all_images/image_1329.jpeg,Example of 3GPP – WLAN Mapping Function
"This clause depicts the set of classes (e.g. IOCs) that encapsulates the information relevant for this IRP. This clause provides the overview of the relationships of relevant classes in UML. Subsequent clauses provide more detailed specification of various aspects of these classes.
The figure below shows the name-containment relation and other types of relations of the STN NRM.
Figure 4.2.1-1 : Signalling Transport Network NRM Containment/Naming and Association diagram 1
Figure 4.2.1-2 : Signalling Transport Network NRM Containment/Naming and Association diagram 2
Figure 4.2.1-3 : VsDataContainer Containment/Naming and Association in STN NRM diagram
Figure 4.2.1-4: M3UA view of STN NRM Containment/Naming and Association diagram 1
Figure 4.2.1-5: M3UA view of STN NRM Containment/Naming and Association diagram 2
Figure 4.2.1-6: VsDataContainer Containment/Naming and Association in M3UA STN NRM diagram",TS 28.735,4.2.1,all_images/image_1332.jpeg,M3UA view of STN NRM Containment/Naming and Association diagram 1
"This clause depicts the set of classes (e.g. IOCs) that encapsulates the information relevant for this IRP. This clause provides the overview of the relationships of relevant classes in UML. Subsequent clauses provide more detailed specification of various aspects of these classes.
The figure below shows the name-containment relation and other types of relations of the STN NRM.
Figure 4.2.1-1 : Signalling Transport Network NRM Containment/Naming and Association diagram 1
Figure 4.2.1-2 : Signalling Transport Network NRM Containment/Naming and Association diagram 2
Figure 4.2.1-3 : VsDataContainer Containment/Naming and Association in STN NRM diagram
Figure 4.2.1-4: M3UA view of STN NRM Containment/Naming and Association diagram 1
Figure 4.2.1-5: M3UA view of STN NRM Containment/Naming and Association diagram 2
Figure 4.2.1-6: VsDataContainer Containment/Naming and Association in M3UA STN NRM diagram",TS 28.735,4.2.1,all_images/image_1334.jpeg,VsDataContainer Containment/Naming and Association in M3UA STN NRM diagram
"This clause depicts the inheritance relationships that exist between IOCs.
The following figure shows the inheritance hierarchy for the STN NRM.
Figure 4.2.2-1 : Signalling Transport Network NRM Inheritance Hierarchy
Figure 4.2.2-2: M3UA view of Signalling Transport Network Resource Model Inheritance Hierarchy",TS 28.735,4.2.2,all_images/image_1336.jpeg,M3UA view of Signalling Transport Network Resource Model Inheritance Hierarchy
,TR 36.763,6.2,all_images/image_1337.jpeg,Illustration of beam layout and elevation angles for IoT NTN
"Problem Statement
As outlined in 38.821 [17], satellites may provide very large cells, covering hundreds of kilometres, and consequently would lead to large tracking areas. In this scenario the tracking area updates (TAUs) are minimal, however the paging load could be high because it then relates to the number of devices in the tracking area.
Moving cells and consequently moving tracking areas would be difficult to manage in the network as the contrast between the TAU and the paging signalling load would be too extreme to find a practical compromise.
On one hand, small tracking areas would lead to massive TAU signalling for UE at the boundary between 2 TAs as illustrated in figure 7.3.1.1-1.
Figure 7.3.1.1-1: Moving Cells and Small tracking areas leading to massive TAU signalling
On the other hand, wide tracking areas would lead to high paging load in the satellite beams as illustrated in figure 7.3.1.1-2.
Figure 7.3.1.1-2: Moving Cells and wide tracking areas leading to higher Paging load
However, tracking areas must be dimensioned to minimise the TAUs as this is more signalling-intensive than paging on the network.
In practical tracking area design, one of the criteria affecting the performance and capacity is the limiting capabilities of MME/AMF platforms and the radio channel capacity.
Ping-pong effect generating excessive TAU, and it can be minimised by ensuring 10-20% overlaps between the adjacent cells and appropriate allocation of TAI List to UEs especially at the edge of cells/TAs.
Solution Overview
In order not to have TAU performed frequently by the UE triggered by the satellite motion, the tracking area is designed to be fixed on ground (i.e. earth-fixed TA similar to NR NTN). For NTN LEO, this implies that while the cells sweep on the ground, the tracking area code (i.e. TAC) broadcasted is changed, when the cell arrives to the area of next planned earth fixed tracking area location. The TAC broadcasted by the eNB needs to be updated as a cell beam enters to the area of next planned tracking area. When the UE detects entering a tracking area that is not in the list of tracking areas that the UE previously registered in the network, a mobility registration update procedure will be triggered.
Figure 7.3.1.1-3: An example of updating TAC and PLMN ID in real-time for LEO with moving beams
As shown in Figure 7.3.1.1-3, network updates the broadcast TAC in real time according to the ephemeris and confirms that the broadcast TAC is associated with the geographical area covered by the satellite beam. UE listens to TAI = PLMN ID + TAC and determines to trigger registration area update procedure based on the broadcast TAC and PLMN ID when it moves out of the registration area.
The two signalling options to update the broadcast TAC for IoT NTN are described as follows:
(1)	""Hard switch"" option:
One cell broadcast only one TAC per PLMN. The new TAC replaces the old TAC and there may be some fluctuation at the border area. As shown in Figure 7.3.1.1-4, the UE will see its TAC changing like TAC-2 -> TAC-1 -> TAC-2 from T1 to T3.
Figure 7.3.1.1-4: TAC fluctuation at the border area
(2)	""Soft switch"" option:
One cell can broadcast more than one TAC per PLMN. The cell adds the new TAC in its system information in addition to the old TAC, and subsequently removes the old TAC. If there is a chain of Tracking Areas, the TA list adds one TAC more and removes one old TAC while the cell sweeps the ground. This also reduces the amount of TAUs for UEs that happen to be located at the border area. However, for the ""soft switch"" option, the more TACs a cell broadcast, the heavier paging load it experiences, which usually leads to a significant imbalance distribution of paging load among cells. Thus, there is a trade-off between paging load and balancing the fluctuation of actual TA area enabled by the soft switch to be considered in network planning and implementation.
NOTE:	For the TA handling, the details are expected to be settled in the Work Item phase, e.g. the requirements for UE to update/re-read System Information.",TR 36.763,7.3.1.1,all_images/image_1338.jpeg,Moving Cells and Small tracking areas leading to massive TAU signalling
"Problem Statement
As outlined in 38.821 [17], satellites may provide very large cells, covering hundreds of kilometres, and consequently would lead to large tracking areas. In this scenario the tracking area updates (TAUs) are minimal, however the paging load could be high because it then relates to the number of devices in the tracking area.
Moving cells and consequently moving tracking areas would be difficult to manage in the network as the contrast between the TAU and the paging signalling load would be too extreme to find a practical compromise.
On one hand, small tracking areas would lead to massive TAU signalling for UE at the boundary between 2 TAs as illustrated in figure 7.3.1.1-1.
Figure 7.3.1.1-1: Moving Cells and Small tracking areas leading to massive TAU signalling
On the other hand, wide tracking areas would lead to high paging load in the satellite beams as illustrated in figure 7.3.1.1-2.
Figure 7.3.1.1-2: Moving Cells and wide tracking areas leading to higher Paging load
However, tracking areas must be dimensioned to minimise the TAUs as this is more signalling-intensive than paging on the network.
In practical tracking area design, one of the criteria affecting the performance and capacity is the limiting capabilities of MME/AMF platforms and the radio channel capacity.
Ping-pong effect generating excessive TAU, and it can be minimised by ensuring 10-20% overlaps between the adjacent cells and appropriate allocation of TAI List to UEs especially at the edge of cells/TAs.
Solution Overview
In order not to have TAU performed frequently by the UE triggered by the satellite motion, the tracking area is designed to be fixed on ground (i.e. earth-fixed TA similar to NR NTN). For NTN LEO, this implies that while the cells sweep on the ground, the tracking area code (i.e. TAC) broadcasted is changed, when the cell arrives to the area of next planned earth fixed tracking area location. The TAC broadcasted by the eNB needs to be updated as a cell beam enters to the area of next planned tracking area. When the UE detects entering a tracking area that is not in the list of tracking areas that the UE previously registered in the network, a mobility registration update procedure will be triggered.
Figure 7.3.1.1-3: An example of updating TAC and PLMN ID in real-time for LEO with moving beams
As shown in Figure 7.3.1.1-3, network updates the broadcast TAC in real time according to the ephemeris and confirms that the broadcast TAC is associated with the geographical area covered by the satellite beam. UE listens to TAI = PLMN ID + TAC and determines to trigger registration area update procedure based on the broadcast TAC and PLMN ID when it moves out of the registration area.
The two signalling options to update the broadcast TAC for IoT NTN are described as follows:
(1)	""Hard switch"" option:
One cell broadcast only one TAC per PLMN. The new TAC replaces the old TAC and there may be some fluctuation at the border area. As shown in Figure 7.3.1.1-4, the UE will see its TAC changing like TAC-2 -> TAC-1 -> TAC-2 from T1 to T3.
Figure 7.3.1.1-4: TAC fluctuation at the border area
(2)	""Soft switch"" option:
One cell can broadcast more than one TAC per PLMN. The cell adds the new TAC in its system information in addition to the old TAC, and subsequently removes the old TAC. If there is a chain of Tracking Areas, the TA list adds one TAC more and removes one old TAC while the cell sweeps the ground. This also reduces the amount of TAUs for UEs that happen to be located at the border area. However, for the ""soft switch"" option, the more TACs a cell broadcast, the heavier paging load it experiences, which usually leads to a significant imbalance distribution of paging load among cells. Thus, there is a trade-off between paging load and balancing the fluctuation of actual TA area enabled by the soft switch to be considered in network planning and implementation.
NOTE:	For the TA handling, the details are expected to be settled in the Work Item phase, e.g. the requirements for UE to update/re-read System Information.",TR 36.763,7.3.1.1,all_images/image_1340.jpeg,An example of updating TAC and PLMN ID in real-time for LEO with moving beams
"The general protocol model for E-UTRAN interfaces is depicted in figure 11.1-1, and described in detail in the following subclauses. The structure is based on the principle that the layers and planes are logically independent of each other. Therefore, as and when required, the standardization body can easily alter protocol stacks and planes to fit future requirements.
Figure 11.1-1: General protocol model for E-UTRAN interfaces",TS 36.401,11.1,all_images/image_1342.jpeg,General protocol model for E-UTRAN interfaces
"LMU requirements are for the channel bandwidths listed in Table 5.3-1.
Table 5.3-1: Transmission bandwidth configuration NRB in E-UTRA channel bandwidths
Figure 5.3-1 shows the relation between the Channel bandwidth (BWChannel) and the Transmission bandwidth configuration (NRB). The channel edges are defined as the lowest and highest frequencies of the carrier separated by the channel bandwidth, i.e. at FC +/- BWChannel /2.
Figure 5.3-1: Definition of Channel Bandwidth and Transmission Bandwidth Configuration 
for one E-UTRA carrier.
Figure 5.3-2 illustrates the aggregated channel bandwidth for intra-band carrier aggregation.
Figure 5.3-2: Definition of Aggregated Channel Bandwidth for intra-band carrier aggregation
The lower edge of the Aggregated Channel Bandwidth (BWChannel_CA) is defined as Fedge_low = FC_low - Foffset. The upper edge of the aggregated channel bandwidth is defined as Fedge_high = FC_high + Foffset. The Aggregated Channel Bandwidth, BWChannel_CA, is defined as follows:
BWChannel_CA = Fedge_high - Fedge_low [MHz]",TS 36.112,5.3,all_images/image_1343.jpeg,Definition of Channel Bandwidth and Transmission Bandwidth Configuration 
"LMU requirements are for the channel bandwidths listed in Table 5.3-1.
Table 5.3-1: Transmission bandwidth configuration NRB in E-UTRA channel bandwidths
Figure 5.3-1 shows the relation between the Channel bandwidth (BWChannel) and the Transmission bandwidth configuration (NRB). The channel edges are defined as the lowest and highest frequencies of the carrier separated by the channel bandwidth, i.e. at FC +/- BWChannel /2.
Figure 5.3-1: Definition of Channel Bandwidth and Transmission Bandwidth Configuration 
for one E-UTRA carrier.
Figure 5.3-2 illustrates the aggregated channel bandwidth for intra-band carrier aggregation.
Figure 5.3-2: Definition of Aggregated Channel Bandwidth for intra-band carrier aggregation
The lower edge of the Aggregated Channel Bandwidth (BWChannel_CA) is defined as Fedge_low = FC_low - Foffset. The upper edge of the aggregated channel bandwidth is defined as Fedge_high = FC_high + Foffset. The Aggregated Channel Bandwidth, BWChannel_CA, is defined as follows:
BWChannel_CA = Fedge_high - Fedge_low [MHz]",TS 36.112,5.3,all_images/image_1344.png,Definition of Aggregated Channel Bandwidth for intra-band carrier aggregation
"E-UTRA defines two MAC entities; one in the UE and one in the E-UTRAN. These MAC entities handle the following transport channels:
-	Broadcast Channel (BCH);
-	Downlink Shared Channel(s) (DL-SCH);
-	Paging Channel (PCH);
-	Uplink Shared Channel(s) (UL-SCH);
-	Random Access Channel(s) (RACH);
-	Multicast Channel(s) (MCH);
-	Sidelink Broadcast Channel (SL-BCH);
-	Sidelink Discovery Channel (SL-DCH);
-	Sidelink Shared Channel (SL-SCH).
The exact functions performed by the MAC entities are different in the UE from those performed in the E-UTRAN.
The RN includes both types of MAC entities; one type for communication with UEs and one type for communication with the E-UTRAN.
In Dual Connectivity, two MAC entities are configured in the UE: one for the MCG and one for the SCG. In DAPS handover, two MAC entities are configured in the UE: one MAC entity for the source cell (source MAC entity) and one MAC entity for the target cell (target MAC entity). Each MAC entity is configured by RRC with a serving cell supporting PUCCH transmission and contention based Random Access. In this specification, the term SpCell refers to such cell, whereas the term SCell refers to other serving cells. The term SpCell either refers to the PCell of the MCG or the PSCell of the SCG depending on if the MAC entity is associated to the MCG or the SCG, respectively. A Timing Advance Group containing the SpCell of a MAC entity is referred to as pTAG, whereas the term sTAG refers to other TAGs.
The functions of the different MAC entities in the UE operate independently if not otherwise indicated. The timers and paramenters used in each MAC entity are configured independently if not otherwise indicated. The Serving Cells, C-RNTI, radio bearers, logical channels, upper and lower layer entities, LCGs, and HARQ entities considered by each MAC entity refer to those mapped to that MAC entity if not otherwise indicated.
If the MAC entity is configured with one or more SCells, there are multiple DL-SCH and there may be multiple UL-SCH and RACH per MAC entity; one DL-SCH, one UL-SCH, and one RACH on the SpCell, one DL-SCH, zero or one UL-SCH and zero or one RACH for each SCell.
The physical layer may perform a listen-before-talk procedure, according to which transmissions are not performed if the channel is identified as being occupied or the physical layer may monitor for PUSCH trigger, as specified in TS 36.213 [2], according to which transmissions are not performed if PUSCH trigger B is not received. In both cases a MAC entity considers the transmission to have been performed anyway, unless stated otherwise.
Figure 4.2.1-1 illustrates one possible structure for the UE side MAC entity when SCG is not configured and for each MAC entity during DAPS handover, and it should not restrict implementation.
Figure 4.2.1-1: MAC structure overview, UE side
Figure 4.2.1-2 illustrates one possible structure for the UE side MAC entities when MCG and SCG are configured, and it should not restrict implementation. MBMS reception and SC-PTM reception are excluded from this figure for simplicity.
Figure 4.2.1-2: MAC structure overview with two MAC entities, UE side
Figure 4.2.1-3 illustrates one possible structure for the UE side MAC entity when sidelink is configured, and it should not restrict implementation.
Figure 4.2.1-3: MAC structure overview for sidelink, UE side",TS 36.321,4.2.1,all_images/image_1347.png,"MAC structure overview for sidelink, UE side"
"Figure 4.6.1-1 shows a logical architecture for the HeNB that has a set of S1 interfaces to connect the HeNB to the EPC.
The configuration and authentication entities as shown here should be common to HeNBs and HNBs.
Figure 4.6.1-1: E-UTRAN HeNB Logical Architecture
The E-UTRAN architecture may deploy a Home eNB Gateway (HeNB GW) to allow the S1 interface between the HeNB and the EPC to support a large number of HeNBs in a scalable manner. The HeNB GW serves as a concentrator for the C-Plane, specifically the S1-MME interface. The S1-U interface from the HeNB may be terminated at the HeNB GW, or a direct logical U-Plane connection between HeNB and S-GW may be used (as shown in Figure 4.6.1-1).
The S1 interface is defined as the interface:
-	Between the HeNB GW and the Core Network;
-	Between the HeNB and the HeNB GW;
-	Between the HeNB and the Core Network;
-	Between the eNB and the Core Network.
The HeNB GW appears to the MME as an eNB. The HeNB GW appears to the HeNB as an MME. The S1 interface between the HeNB and the EPC is the same, regardless whether the HeNB is connected to the EPC via a HeNB GW or not.
The HeNB GW shall connect to the EPC in a way that inbound and outbound mobility to cells served by the HeNB GW shall not necessarily require inter MME handovers. One HeNB serves only one cell.
The functions supported by the HeNB shall be the same as those supported by an eNB (with possible exceptions e.g. NNSF) and the procedures run between a HeNB and the EPC shall be the same as those between an eNB and the EPC (with possible exceptions e.g. S5 procedures in case of LIPA support).
X2-based HO involving HeNBs is allowed as shown in Table 4.6.1-1.
Table 4.6.1-1: X2-based HO support
This version of the specification supports X2-connectivity between HeNBs, independent of whether any of the involved HeNBs is connected to a HeNB GW.
The overall E-UTRAN architecture with deployed HeNB GW and X2 GW is shown below.
Figure 4.6.1-2: Overall E-UTRAN Architecture with deployed HeNB GW and X2 GW.
NOTE:	In the figure above, a HeNB operating in LIPA mode has been represented with its S5 interface. X2-based HO involving HeNBs is supported according to Table 4.6.1-1.
If the HeNB supports the LIPA function, it shall support an S5 interface towards the S-GW and an SGi interface towards the residential/IP network. See clause 4.6.5 for the details of the architecture and functions in case of LIPA support.
If the HeNB supports SIPTO@LN with collocated L-GW, it shall support an S5 interface towards the S-GW and an SGi interface towards the IP network. The S5 interface does not go via the HeNB GW, even when present. All other functions are described in clause 4.8.2.",TS 36.300,4.6.1,all_images/image_1349.jpeg,Overall E-UTRAN Architecture with deployed HeNB GW and X2 GW.
"The RN connects to the DeNB via the Un interface using the same radio protocols and procedures as a UE connecting to an eNB. The control plane protocol stack is shown in Figure 4.7.5-1 and the user plane protocol stack is shown in Figure 4.7.5-2.
The following relay-specific functionalities are supported:
-	the RRC layer of the Un interface has functionality to configure and reconfigure an RN subframe configuration through the RN reconfiguration procedure (e.g. DL subframe configuration and an RN-specific control channel) for transmissions between an RN and a DeNB. The RN may request such a configuration from the DeNB during the RRC connection establishment, and the DeNB may initiate the RRC signalling for such configuration. The RN applies the configuration immediately upon reception;
NOTE:	The RN subframe configuration on the Un interface can be temporarily misaligned with the MBSFN subframes configured in the RN cell due to the RN subframe configuration; i.e. a new subframe configuration can be applied earlier by the RN on Un than in the RN cell.
-	the RRC layer of the Un interface has functionality to send updated system information in a dedicated message to an RN with an RN subframe configuration. The RN applies the received system information immediately;
-	the PDCP layer of the Un interface has functionality to provide integrity protection for the user plane. The integrity protection is configured per DRB.
To support PWS towards UEs, the RN receives the relevant information over S1. The RN should hence ignore DeNB system information relating to PWS.
Figure 4.7.5-1: Radio control plane protocol stack for supporting RNs
Figure 4.7.5-2: Radio user plane protocol stack for supporting RNs",TS 36.300,4.7.5,all_images/image_1351.jpeg,Radio control plane protocol stack for supporting RNs
"Figure 4.8.2-1 shows the logical architecture for the eNB when it supports SIPTO@LN with a collocated L-GW.
Figure 4.8.2-1: E-UTRAN - SIPTO@LN with collocated L-GW - Logical Architecture
For a SIPTO@LN PDN connection, the eNB sets up and maintains an S5 connection to the EPC.
The mobility of the SIPTO@LN PDN connection is not supported in this release of the specification. The SIPTO@LN PDN connection is released after a handover is performed, and the collocated L-GW in the source eNB triggers the release over the S5 interface, as described in TS 23.401 [17].
In case of SIPTO@LN with collocated L-GW support, the eNB supports the following additional functions:
-	transfer of the collocated L-GW IP address of the eNB over S1-MME to the EPC at every idle-active transition;
-	transfer of the collocated L-GW IP address of the eNB over S1-MME to the EPC within every Uplink NAS Transport procedure;
-	support of basic P-GW functions in the collocated L-GW such as support of the SGi interface corresponding to SIPTO@LN;
-	additional support of first packet sending, buffering of subsequent packets, internal direct L-GW-eNB user path management and in sequence packet delivery to the UE;
-	support of the necessary restricted set of S5 procedures corresponding to the support of SIPTO@LN function as specified in TS 23.401 [17];
-	notification to the EPC of the collocated L-GW uplink TEID(s) or GRE key(s) for the SIPTO@LN bearer(s) over S5 interface within the restricted set of procedures to be forwarded over S1-MME and further used by the eNB as ""SIPTO correlation id"" for correlation purposes between the collocated L-GW and the eNB;
-	triggering SIPTO@LN PDN connection release by the collocated L-GW after a handover is performed, as specified in TS 23.401 [17].
In case of SIPTO@LN with collocated L-GW support, the MME supports the following additional functions:
-	SIPTO@LN activation for the requested APN based on SIPTO permissions in the subscription data and received collocated L-GW IP address;
-	transfer of the ""SIPTO correlation id"" to the eNB via the initial context setup procedure and E-RAB setup procedure;
-	release of the SIPTO@LN PDN connection of an idle-mode UE when the UE moves away from the coverage area of the eNB, as specified in TS 23.401 [17].",TS 36.300,4.8.2,all_images/image_1355.jpeg,E-UTRAN - SIPTO@LN with collocated L-GW - Logical Architecture
"The figure below depicts the mapping between downlink logical channels and downlink transport channels:
Figure 6.1.3.2-1: Mapping between downlink logical channels and downlink transport channels
In Downlink, the following connections between logical channels and transport channels exist:
-	BCCH can be mapped to BCH;
-	BCCH can be mapped to DL-SCH;
-	BR-BCCH can be mapped to DL-SCH;
-	PCCH can be mapped to PCH;
-	CCCH can be mapped to DL-SCH;
-	DCCH can be mapped to DL-SCH;
-	DTCH can be mapped to DL-SCH;
-	MTCH can be mapped to MCH;
-	MCCH can be mapped to MCH;
-	SC-MTCH can be mapped to DL-SCH;
-	SC-MCCH can be mapped to DL-SCH.",TS 36.300,6.1.3.2,all_images/image_1359.jpeg,Mapping between downlink logical channels and downlink transport channels
"In case of CA, the multi-carrier nature of the physical layer is only exposed to the MAC layer for which one HARQ entity is required per serving cell;
-	In both uplink and downlink, there is one independent hybrid-ARQ entity per serving cell and one transport block is generated per TTI per serving cell in the absence of spatial multiplexing. Each transport block and its potential HARQ retransmissions are mapped to a single serving cell;
-	HARQ operation is asynchronous for Licensed-Assisted Access (LAA) SCells.
Figure 6.4-1: Layer 2 Structure for DL with CA configured
Figure 6.4-2: Layer 2 Structure for UL with CA configured
In case of CA in sidelink, which applies to V2X sidelink communication, there is one independent HARQ entity per carrier used for V2X sidelink communication and one transport block is generated per TTI per carrier. Each transport block and its potential HARQ retransmissions are mapped to a single carrier.
Figure 6.4-3: Layer 2 Structure for Sidelink with CA configured",TS 36.300,6.4,all_images/image_1361.jpeg,Layer 2 Structure for UL with CA configured
"In case of DC, the UE is configured with two MAC entities: one MAC entity for MeNB and one MAC entity for SeNB. Figure 6.5-1 below describes the layer 2 structure for the downlink when both CA and DC are configured. In order to simplify the figure, the BCH, PCH, MCH and corresponding logical channels are not included. Also, only UEn is shown as having DC configured.
Figure 6.5-1: Layer 2 Structure for DL with CA and DC configured
Figure 6.5-2 below describes the layer 2 structure for the uplink when both CA and DC are configured. As explained in clause 4.9.2, SRBs are always handled by the MeNB and as a result, CCCH is only shown for the MeNB. For a split bearer, UE is configured over which link (or both) the UE transmits UL PDCP PDUs by the MeNB. On the link which is not responsible for UL PDCP PDUs transmission, the RLC layer only transmits corresponding ARQ feedback for the downlink data.
Figure 6.5-2: Layer 2 Structure for UL with CA and DC configured",TS 36.300,6.5,all_images/image_1362.png,Layer 2 Structure for DL with CA and DC configured
"The SeNB Modification procedure may be initiated either by the MeNB or by the SeNB and be used to modify, establish or release bearer contexts, to transfer bearer contexts to and from the SeNB or to modify other properties of the UE context within the same SeNB.
The SeNB modification procedure does not necessarily need to involve signalling towards the UE.
MeNB initiated SeNB Modification
Figure 10.1.2.8.2-1: SeNB Modification procedure - MeNB initiated
The MeNB uses the procedure to initiate configuration changes of the SCG within the same SeNB, e.g. the addition or release of SCG SCells, the addition, modification or release of SCG bearer(s) and the SCG part of split bearer(s) and to trigger PSCell change involving PSCell release. The SeNB may reject the request, except if it concerns the release of SCG cells, of SCG bearer(s) or the SCG part of split bearer(s). Figure 10.1.2.8.2-1 shows an example signalling flow for a MeNB initiated SeNB Modification procedure.
1.	The MeNB sends the SeNB Modification Request message, which may contain bearer context related or other UE context related information, data forwarding address information (if applicable) and SCG-ConfigInfo which contains the MCG configuration and the entire UE capabilities for UE capability coordination to be used as basis for the reconfiguration by the SeNB. In case of SCG SCell addition request, the MeNB can provide the latest measurement results for the SCG cell(s) requested to be added and SCG serving cell(s). In case of SCG Change, SCG Change Indication is included.
NOTE:	MeNB may request the establishment or release of SCG or Split bearer while not reconfiguration to MCG bearer, which can be performed without SCG change.
2.	The SeNB responds with the SeNB Modification Request Acknowledge message, which may contain radio configuration information within SCG-Config message and data forwarding address information (if applicable). In this step, the SeNB does not initiate an SCG change i.e. the SCG-Config message indicates an SCG Change only if the MeNB included the SCG Change Indication in the SeNB Modification Request message (as an SCG change initiated by the SeNB would subsequently require an SCG counter from the MeNB). In case of SCG Change, for E-RABs configured with the split bearer option for which no bearer type change is performed, the SeNB provides a new DL GTP TEID to the MeNB. The MeNB shall continue sending DL PDCP PDUs to the SeNB with the previous DL GTP TEID until it performs PDCP re-establishment or PDCP data recovery, and use the new DL GTP TEID starting with the PDCP re-establishment or data recovery.
3/4.	The MeNB initiates the RRC connection reconfiguration procedure. The UE applies the new configuration and replies with RRCConnectionReconfigurationComplete. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
5.	Upon successful completion of the reconfiguration, the success of the procedure is indicated in the SeNB Reconfiguration Complete message.
6.	If instructed, the UE performs synchronisation towards the PSCell of the SeNB as described in SeNB addition procedure. Otherwise, the UE may perform UL transmission after having applied the new configuration.
7/8.	If applicable, data forwarding between MeNB and the SeNB takes place (Figure 10.1.2.8.2-1 depicts the case where a bearer context is transferred from the MeNB to the SeNB).
9.	If applicable, a path update is performed.
SeNB initiated SeNB Modification
Figure 10.1.2.8.2-2: SeNB Modification procedure - SeNB initiated
The SeNB uses the procedure to perform configuration changes of the SCG within the same SeNB, e.g. to trigger the release of SCG SCell(s) (other than PSCell), SCG bearer(s) and the SCG part of split bearer(s) (upon which the MeNB may release the bearer or reconfigure it to an MCG bearer), and to trigger PSCell change. The MeNB cannot reject the release request of SCG SCells (other than PSCell), SCG bearer and the SCG part of split bearer. The SeNB cannot initiate an SCG SCell addition except for the case of SI update of an SCG SCell. Figure 10.1.2.8.2-2 shows an example signalling flow for an SeNB initiated SeNB Modification procedure.
1.	The SeNB sends the SeNB Modification Required message, which may contain bearer context related, other UE context related information and SCG-Config which contains the new radio resource configuration of SCG. For bearer release or modification a corresponding E-RAB list is included in the SeNB Modification Required message. In case of SCG Change, SCG Change Indication together with SCG-Config are included. In case of release of bearer served by SeNB, SCG-Config is not included.
The SeNB can decide whether the Random Access procedure is required, i.e. SCG change.
2./3.	If data forwarding and/or SeNB security key change needs to be applied, the MeNB triggers the preparation of the MeNB initiated SeNB Modification procedure and provides forwarding address and/or a new SeNB security key information within the SeNB Modification Request message, respectively. If the SeNB requested to release a bearer in step 1, and the MeNB decides to reconfigure it to an MCG bearer, the MeNB provides the SCG Change Indication within the SeNB Modification Request message and the SeNB provides respective RRC information in the SCG-Configuration within the SeNB Modification Request Acknowledgement message.
NOTE:	When the SeNB Modification Required message contains SCG-Config in step 1, the following MeNB initiated SeNB Modification procedure triggered by the MeNB in step 2 cannot be used for anything that would require a new SCG configuration (as SCG-Config cannot be subsequently signalled by the SeNB).
NOTE:	If only SeNB security key (i.e. without SCG Change Indication) is provided in step 2, the MeNB does not need to wait for the reception of step 3 to initiate the RRC connection reconfiguration procedure.
4.	If MeNB accepts the SeNB request, the MeNB sends the RRCConnectionReconfiguration message to the UE including the new radio resource configuration of SCG according to the SCG-Config.
5.	The UE applies the new configuration and replies the RRCConnectionReconfigurationComplete message. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
6.	Upon successful completion of the reconfiguration, the success of the procedure related to SCG-Config is indicated in the SeNB Modification Confirm message.
7.	If instructed, the UE performs synchronisation towards the PSCell of the SeNB as described in SeNB addition procedure. Otherwise, the UE may perform UL transmission after having applied the new configuration.
8/9.	If applicable, data forwarding between MeNB and the SeNB takes place (Figure 10.1.2.8.2-2 depicts the case where a bearer context is transferred from the SeNB to the MeNB).
10.	If applicable, a path update is performed.",TS 36.300,10.1.2.8.2,all_images/image_1366.jpeg,SeNB Modification procedure - MeNB initiated
"The SeNB Modification procedure may be initiated either by the MeNB or by the SeNB and be used to modify, establish or release bearer contexts, to transfer bearer contexts to and from the SeNB or to modify other properties of the UE context within the same SeNB.
The SeNB modification procedure does not necessarily need to involve signalling towards the UE.
MeNB initiated SeNB Modification
Figure 10.1.2.8.2-1: SeNB Modification procedure - MeNB initiated
The MeNB uses the procedure to initiate configuration changes of the SCG within the same SeNB, e.g. the addition or release of SCG SCells, the addition, modification or release of SCG bearer(s) and the SCG part of split bearer(s) and to trigger PSCell change involving PSCell release. The SeNB may reject the request, except if it concerns the release of SCG cells, of SCG bearer(s) or the SCG part of split bearer(s). Figure 10.1.2.8.2-1 shows an example signalling flow for a MeNB initiated SeNB Modification procedure.
1.	The MeNB sends the SeNB Modification Request message, which may contain bearer context related or other UE context related information, data forwarding address information (if applicable) and SCG-ConfigInfo which contains the MCG configuration and the entire UE capabilities for UE capability coordination to be used as basis for the reconfiguration by the SeNB. In case of SCG SCell addition request, the MeNB can provide the latest measurement results for the SCG cell(s) requested to be added and SCG serving cell(s). In case of SCG Change, SCG Change Indication is included.
NOTE:	MeNB may request the establishment or release of SCG or Split bearer while not reconfiguration to MCG bearer, which can be performed without SCG change.
2.	The SeNB responds with the SeNB Modification Request Acknowledge message, which may contain radio configuration information within SCG-Config message and data forwarding address information (if applicable). In this step, the SeNB does not initiate an SCG change i.e. the SCG-Config message indicates an SCG Change only if the MeNB included the SCG Change Indication in the SeNB Modification Request message (as an SCG change initiated by the SeNB would subsequently require an SCG counter from the MeNB). In case of SCG Change, for E-RABs configured with the split bearer option for which no bearer type change is performed, the SeNB provides a new DL GTP TEID to the MeNB. The MeNB shall continue sending DL PDCP PDUs to the SeNB with the previous DL GTP TEID until it performs PDCP re-establishment or PDCP data recovery, and use the new DL GTP TEID starting with the PDCP re-establishment or data recovery.
3/4.	The MeNB initiates the RRC connection reconfiguration procedure. The UE applies the new configuration and replies with RRCConnectionReconfigurationComplete. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
5.	Upon successful completion of the reconfiguration, the success of the procedure is indicated in the SeNB Reconfiguration Complete message.
6.	If instructed, the UE performs synchronisation towards the PSCell of the SeNB as described in SeNB addition procedure. Otherwise, the UE may perform UL transmission after having applied the new configuration.
7/8.	If applicable, data forwarding between MeNB and the SeNB takes place (Figure 10.1.2.8.2-1 depicts the case where a bearer context is transferred from the MeNB to the SeNB).
9.	If applicable, a path update is performed.
SeNB initiated SeNB Modification
Figure 10.1.2.8.2-2: SeNB Modification procedure - SeNB initiated
The SeNB uses the procedure to perform configuration changes of the SCG within the same SeNB, e.g. to trigger the release of SCG SCell(s) (other than PSCell), SCG bearer(s) and the SCG part of split bearer(s) (upon which the MeNB may release the bearer or reconfigure it to an MCG bearer), and to trigger PSCell change. The MeNB cannot reject the release request of SCG SCells (other than PSCell), SCG bearer and the SCG part of split bearer. The SeNB cannot initiate an SCG SCell addition except for the case of SI update of an SCG SCell. Figure 10.1.2.8.2-2 shows an example signalling flow for an SeNB initiated SeNB Modification procedure.
1.	The SeNB sends the SeNB Modification Required message, which may contain bearer context related, other UE context related information and SCG-Config which contains the new radio resource configuration of SCG. For bearer release or modification a corresponding E-RAB list is included in the SeNB Modification Required message. In case of SCG Change, SCG Change Indication together with SCG-Config are included. In case of release of bearer served by SeNB, SCG-Config is not included.
The SeNB can decide whether the Random Access procedure is required, i.e. SCG change.
2./3.	If data forwarding and/or SeNB security key change needs to be applied, the MeNB triggers the preparation of the MeNB initiated SeNB Modification procedure and provides forwarding address and/or a new SeNB security key information within the SeNB Modification Request message, respectively. If the SeNB requested to release a bearer in step 1, and the MeNB decides to reconfigure it to an MCG bearer, the MeNB provides the SCG Change Indication within the SeNB Modification Request message and the SeNB provides respective RRC information in the SCG-Configuration within the SeNB Modification Request Acknowledgement message.
NOTE:	When the SeNB Modification Required message contains SCG-Config in step 1, the following MeNB initiated SeNB Modification procedure triggered by the MeNB in step 2 cannot be used for anything that would require a new SCG configuration (as SCG-Config cannot be subsequently signalled by the SeNB).
NOTE:	If only SeNB security key (i.e. without SCG Change Indication) is provided in step 2, the MeNB does not need to wait for the reception of step 3 to initiate the RRC connection reconfiguration procedure.
4.	If MeNB accepts the SeNB request, the MeNB sends the RRCConnectionReconfiguration message to the UE including the new radio resource configuration of SCG according to the SCG-Config.
5.	The UE applies the new configuration and replies the RRCConnectionReconfigurationComplete message. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
6.	Upon successful completion of the reconfiguration, the success of the procedure related to SCG-Config is indicated in the SeNB Modification Confirm message.
7.	If instructed, the UE performs synchronisation towards the PSCell of the SeNB as described in SeNB addition procedure. Otherwise, the UE may perform UL transmission after having applied the new configuration.
8/9.	If applicable, data forwarding between MeNB and the SeNB takes place (Figure 10.1.2.8.2-2 depicts the case where a bearer context is transferred from the SeNB to the MeNB).
10.	If applicable, a path update is performed.",TS 36.300,10.1.2.8.2,all_images/image_1367.jpeg,SeNB Modification procedure - SeNB initiated
"This procedure is used to perform handover within the same MeNB while keeping the SCG in the same SeNB.
Figure 10.1.2.8.2.1-1: Intra-MeNB handover procedure with SeNB configuration
1.	The MeNB sends the SeNB Modification Request message, which may contain bearer context related or other UE context related information, data forwarding address information (if applicable) and SCG-ConfigInfo which contains the MCG configuration and the entire UE capabilities for UE capability coordination to be used as basis for the reconfiguration by the SeNB. In case of SCG SCell addition request, the MeNB can provide the latest measurement results for the SCG cell(s) requested to be added and SCG serving cell(s). For E-RABs configured with the split bearer option for which no bearer type change is performed during the SCG Change procedure the MeNB provides a new UL GTP TEID to the SeNB. The SeNB shall continue sending UL PDCP PDUs to the MeNB with the previous UL GTP TEID until it re-establishes the RLC and use the new UL GTP TEID after RLC re-establishment.
2.	The SeNB responds with the SeNB Modification Request Acknowledge message, which may contain radio configuration information within SCG-Config message and data forwarding address information (if applicable).
3.	The MeNB triggers the UE to apply the new configuration including SCG configuration.
4/5.	The UE synchronizes to the MeNB.
6.	Upon successful completion of the reconfiguration, the success of the procedure is indicated in the SeNB Reconfiguration Complete message.
7.	The UE performs synchronisation towards the PSCell of the SeNB as described in SeNB addition procedure.
8/9.	Data forwarding between MeNB and the SeNB may take place.
10.	If applicable, a path update is performed.",TS 36.300,10.1.2.8.2.1,all_images/image_1368.jpeg,Intra-MeNB handover procedure with SeNB configuration
"The SeNB Release procedure may be initiated either by the MeNB or by the SeNB and is used to initiate the release of the UE context at the SeNB. The recipient node of this request cannot reject.
It does not necessarily need to involve signalling towards the UE, e.g., RRC connection re-establishment due to Radio Link Failure in MeNB.
MeNB initiated SeNB Release
Figure 10.1.2.8.3-1: SeNB Release procedure – MeNB initiated
Figure 10.1.2.8.3-1 shows an example signalling flow for the MeNB initiated SeNB Release procedure.
1.	The MeNB initiates the procedure by sending the SeNB Release Request message. If data forwarding is requested, the MeNB provides data forwarding addresses to the SeNB.
2/3.	If required, the MeNB indicates in the RRCConnectionReconfiguration message towards the UE that the UE shall release the entire SCG configuration. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
NOTE:	If data forwarding is applied, timely coordination between steps 1 and 2 may minimize gaps in service provision, this is however regarded to be an implementation matter.
4/5.	Data forwarding from the SeNB to the MeNB takes place.
6.	If applicable, the path update procedure is initiated.
7.	Upon reception of the UE Context Release message, the SeNB can release radio and C-plane related resource associated to the UE context. Any ongoing data forwarding may continue.
SeNB initiated SeNB Release
Figure 10.1.2.8.3-2: SeNB Release procedure – SeNB initiated
Figure 10.1.2.8.3-2 shows an example signalling flow for the SeNB initiated SeNB Release procedure.
1.	The SeNB initiates the procedure by sending the SeNB Release Required message which does not contain inter-node message.
2.	If data forwarding is requested, the MeNB provides data forwarding addresses to the SeNB in the SeNB Release Confirm message. The SeNB may start data forwarding and stop providing user data to the UE as early as it receives the SeNB Release Confirm message.
3/4.	If required, the MeNB indicates in the RRCConnectionReconfiguration message towards the UE that the UE shall release the entire SCG configuration. In case the UE is unable to comply with (part of) the configuration included in the RRCConnectionReconfiguration message, it performs the reconfiguration failure procedure.
NOTE:	If data forwarding is applied, timely coordination between steps 2 and 3 may minimize gaps in service provision. This is however regarded to be an implementation matter.
5/6.	Data forwarding from the SeNB to the MeNB takes place.
7.	If applicable, the path update procedure is initiated.
8.	Upon reception of the UE Context Release message, the SeNB can release radio and C-plane related resource associated to the UE context. Any ongoing data forwarding may continue.",TS 36.300,10.1.2.8.3,all_images/image_1369.jpeg,SeNB Release procedure – MeNB initiated
"Figure 10.1.2.8.9-1: Addition of a hybrid cell as serving cell of the SeNB
Figure 10.1.2.8.9-1 shows the signalling flow for the addition of the hybrid cell as serving cell of the SeNB procedure:
1a.	The UE is connected to an MeNB and detects a potential candidate cell for dual connectivity.
1b.	The UE reads System Information from the candidate cell (csg-Indication, csg-Identity).
1c.	The MeNB receives CSG related information from the UE (csg-MemberStatus, csg-Identity).
2.	The MeNB initiates the SeNB Addition preparation procedure including Memebership Status of the UE in the hybrid HeNB.
3.	The SeNB takes the membership information provided by the MeNB into account (even if this was not yet verified with the MME).
4-7.	No difference to the SeNB Addition Preparation procedure as described in 10.2.1.1.
8/9.	The MeNB requests the MME to verify the membership status of the UE for the CSG-ID reported by the UE.
-	For SCG bearer, the MeNB triggers the E-RAB Modification Indication procedure.
-	For split bearer, the MeNB triggers the UE Context Modification Indication procedure.
10-13.	If the result of the membership verification requires an update of the UE context at the SeNB, the MeNB triggers the MeNB initiated SeNB Modification Preparation procedure. If the membership verification fails, it is up to the SeNB to decide on further actions.",TS 36.300,10.1.2.8.9,all_images/image_1375.jpeg,Addition of a hybrid cell as serving cell of the SeNB
"While the UE is in RRC_CONNECTED state, the UE performs normal measurement and mobility procedures based on configuration provided by the network.
The UE is not required to support manual selection of CSG IDs while in RRC_CONNECTED state.
Handover to a HNB/HeNB follows the framework of UE assisted network controlled handover as described in 10.1.2.1. Handover to a HNB/HeNB is different from the normal handover procedure in four aspects:
1.	Proximity Estimation: in case the UE is able to determine, using autonomous search procedures, that it is near a CSG member cell, the UE may provide to the source eNB an indication of proximity. The proximity indication may be used as follows:
-	If a measurement configuration is not present for the concerned frequency/RAT, the source eNB may configure the UE to perform measurements and reporting for the concerned frequency/RAT.
-	The source eNB may determine whether to perform other actions related to handover to HNB/HeNBs based on having received a proximity indication (for example, the source eNB may not configure the UE to acquire system information of the HNB/HeNB unless it has received a proximity indication).
2.	PSC/PCI Confusion: due to the typical cell size of HNB/HeNBs being much smaller than macro cells, there can be multiple HNBs/HeNBs within the coverage of the source eNB that have the same PSC/PCI. This leads to a condition referred to as PSC/PCI confusion, wherein the source eNB is unable to determine the correct target cell for handover from the PSC/PCI included in the measurement reports from the UE. PSC/PCI confusion is solved by the UE reporting the global cell identity of the target HNB/HeNB.
3.	Access Control: if the target cell is a hybrid cell, prioritization of allocated resources may be performed based on the UE's membership status. Access control is done by a two step process, where first the UE reports whether the target cell is a CSG member cell based on the UE's Permitted CSG list, and then the network verifies the reported status. When the UE has an emergency call the MME allows inbound mobility to CSG cells even if the access control fails as specified in TS 23.401[17].
4.	PLMN Selection: If the target cell is a shared CSG/hybrid cell, the UE reports the subset of the broadcasted PLMN identities passing PLMN ID check and the Permitted CSG list of the UE includes an entry comprising of the concerned PLMN identity and the CSG ID broadcast by the target cell. The source eNB performs PLMN ID check for the PLMNs reported by the UE and selects one if multiple pass the PLMN ID check. Finally the MME verifies the CSG membership according to the received CSG ID, the selected PLMN ID and stored subscription CSG information of the UE.
Mobility from eNB/HeNB to a HeNB's CSG/hybrid cell may take place with the S1 Handover procedure. In the following call flow the source cell can be an eNB or a HeNB.
The current version of the specification also supports mobility involving HeNBs by using X2 handover in some cases (see clause 4.6.1). If membership verification is required for X2 mobility, the procedure described in clause 10.1.2.1 applies, with the following additions to the steps described in clause 10.1.2.1.1:
-	In Step 4, the source eNB/HeNB includes the CSG membership status reported by the UE handed over in the X2AP HANDOVER REQUEST message to the target HeNB; the target HeNB performs admission control based on the CSG membership status reported by the UE;
-	In Step 12, the target HeNB includes the CSG membership status of the UE handed over in the PATH SWITCH REQUEST message to the MME;
-	In Step 16, after the MME has performed membership verification for the UE handed over, the MME includes its verified CSG membership status in the PATH SWITCH REQUEST ACKNOWLEDGE message to the target HeNB; the target HeNB updates its membership information if needed.
The procedure below applies to any scenario where the CSG ID is provided by the UE or provided by the source eNB.
Figure 10.5.1.2-1: Mobility to HeNB's CSG and hybrid cells.
1)	The source eNB configures the UE with proximity indication control.
2)	The UE sends an ""entering"" proximity indication when it determines it may be near a CSG member cell (based on autonomous search procedures). The proximity indication includes the RAT and frequency of the cell.
3)	If a measurement configuration is not present for the concerned frequency/RAT the source eNB configures the UE with relevant measurement configuration including measurement gaps as needed, so that the UE can perform measurements on the reported RAT and frequency. The network may also use the proximity indication to minimize the requesting of handover preparation information of CSG/hybrid cells by avoiding requesting such information when the UE is not in the geographical area where its CSG member cells are located.
4)	The UE sends a measurement report including the PCI (e.g., due to triggered event A3).
5)	The source eNB configures the UE to perform SI acquisition and reporting of a particular PCI.
6)	The UE performs SI acquisition using autonomous gaps, i.e., the UE may suspend reception and transmission with the source eNB within the limits defined in TS 36.133 [21] to acquire the relevant system information from the target HeNB.
7)	The UE sends a measurement report including (E-)CGI, TAI, CSG ID and ""member/non-member"" indication. If the target cell is a shared CSG/hybrid cell, the measurement report also includes the subset of the broadcast PLMN identities that pass PLMN ID check and for which the Permitted CSG list of the UE includes an entry comprising the cell's CSG ID and the respective PLMN identity.
8)	The source eNB includes the target E-CGI and the CSG ID in the Handover Required message sent to the MME. If the target is a hybrid cell the Cell Access Mode of the target is included.
9)	The MME performs UE access control to the CSG cell based on the CSG ID and the selected target PLMN received in the Handover Required message and the stored CSG subscription data for the UE (see TS 23.401 [17]). If the access control procedure fails, the MME ends the handover procedure by replying with the Handover Preparation Failure message. If the Cell Access Mode is present, the MME determines the CSG Membership Status of the UE handing over to the hybrid cell and includes it in the Handover Request message.
10-11)	The MME sends the Handover Request message to the target HeNB including the target CSG ID received in the Handover Required message. If the target is a hybrid cell the CSG Membership Status will be included in the Handover Request message.
12)	The target HeNB verifies that the CSG ID received in the Handover Request message matches the CSG ID broadcast in the target cell and if such validation is successful it allocates appropriate resources. UE prioritisation may also be applied if the CSG Membership Status indicates that the UE is a member.
13-14)	The target HeNB sends the Handover Request Acknowledge message to the MME via the HeNB GW if present.
15)	The MME sends the Handover Command message to the source eNB.
16)	The source eNB transmits the Handover Command (RRC Connection Reconfiguration message including mobility control information) to the UE.
NOTE:	Steps 1-9, 15 and 16 also apply to inter-RAT mobility from LTE to HNB.
After sending an ""entering"" proximity indication (step 2), if the UE determines that it is no longer near a CSG member cell, the UE sends a ""leaving"" proximity indication to the source eNB. Upon reception of this indication, the source eNB may reconfigure the UE to stop measurements on the reported RAT and frequency.
In the above procedure, steps 2 and 3 may not be performed in case the UE has not previously visited the HeNB, e.g., when the UE first visits a hybrid cell.
The PCI confusion is resolved by steps 5, 6 and 7. The source eNB can request SI acquisition and reporting for any PCI, not limited to PSCs/PCIs of CSG or hybrid cells.",TS 36.300,10.5.1.2,all_images/image_1377.jpeg,Mobility to HeNB's CSG and hybrid cells.
"The Initial Context Setup procedure establishes the necessary overall initial UE context in the eNB in case of an Idle-to Active transition. The Initial Context Setup procedure is initiated by the MME.
The Initial Context Setup procedure comprises the following steps:
-	The MME initiates the Initial Context Setup procedure by sending INITIAL CONTEXT SETUP REQUEST to the eNB. This message may include general UE Context (e.g. security context, roaming and access restrictions, UE capability information, UE S1 signalling connection ID, CN assistance information, etc.), E-RAB context (Serving GW TEID, QoS information, Correlation id i.e. collocated L-GW TEID or GRE key in case of LIPA support or in case of SIPTO@LN with collocated L-GW support), and may be piggy-backed with the corresponding NAS messages. When there are multiple NAS messages in the INITIAL CONTEXT SETUP REQUEST message, the MME shall ensure that the NAS messages in the E-RAB to be Setup List are aligned in the order of reception from the NAS layer to ensure the in-sequence delivery of the NAS messages.
-	Upon receipt of INITIAL CONTEXT SETUP REQUEST, the eNB setup the context of the associated UE, and perform the necessary RRC signalling towards the UE, e.g. Radio Bearer Setup procedure. When there are multiple NAS messages to be sent in the RRC message, the order of the NAS messages in the RRC message shall be kept the same as that in the INITIAL CONTEXT SETUP REQUEST message. If present, the eNB uses the CN assistance information as defined in TS 23.401[17] and propagates it during inter-eNB mobility.
-	The eNB responds with INITIAL CONTEXT SETUP RESPONSE to inform a successful operation, and with INITIAL CONTEXT SETUP FAILURE to inform an unsuccessful operation.
NOTE:	In case of failure, eNB and MME behaviours are not mandated. Both implicit release (local release at each node) and explicit release (MME-initiated UE Context Release procedure) may in principle be adopted. The eNB should ensure that no hanging resources remain at the eNB.
Figure 19.2.2.3-1: Initial Context Setup procedure (highlighted in blue) in Idle-to-Active procedure",TS 36.300,19.2.2.3,all_images/image_1382.jpeg,Initial Context Setup procedure (highlighted in blue) in Idle-to-Active procedure
"This clause complements TR 25.922 [27] clause 5.1.7.2 regarding the E-UTRAN handling of containers.
Most RRC information is carried by means of containers across interfaces other than Uu. The following sequence diagrams illustrate which RRC information should be included within these containers used across the different network interfaces.
NOTE:	In order to maintain independence between protocols, no requirements are included in the interface protocols that are used to transfer the RRC information.
SRVCC (see TS 23.216 [28]) is supported from EUTRAN to UTRAN or GERAN A/Gb mode and from UTRAN or GERAN A/Gb mode to EUTRAN.
There is no support for interworking between EUTRAN and GERAN Iu-mode and between EUTRAN and GAN.
Figure 19.2.2.5.6-1 and 19.2.2.5.6-1a illustrate the message sequence for handover from GERAN to EUTRAN procedure:
Figure 19.2.2.5.6-1. Handover of PS domain service from GERAN A/Gb mode to EUTRAN, normal flow
UE is not requested to provide E-UTRAN UE capabilities while in GERAN. Hence the HANDOVER REQUEST does not contain E-UTRAN UE capabilities, and the capabilities are fetched by Target eNB from UE after handover is completed.
Figure 19.2.2.5.6-1a. Handover of CS domain service from GERAN A/Gb mode to PS-domain service in EUTRAN, normal flow
UE is not requested to provide E-UTRAN UE capabilities while in GERAN. Hence the HANDOVER REQUEST does not contain E-UTRAN UE capabilities, and the capabilities are fetched by Target eNB from UE after completed handover.
Figure 19.2.2.5.6-2 illustrates the message sequence for PS handover and CS handover from UTRAN to EUTRAN procedure:
Figure 19.2.2.5.6-2: Handover of PS domain service and handover of CS domain service from UTRAN to EUTRAN, normal flow
Figure 19.2.2.5.6-3 to Figure 19.2.2.5.6-5 illustrate the message sequence for the handover from EUTRAN to GERAN A/Gb mode procedure:
Figure 19.2.2.5.6-3: Handover of CS domain service from EUTRAN to GERAN A/Gb mode, normal flow
Figure 19.2.2.5.6-4. Handover of PS domain service from EUTRAN to GERAN A/Gb mode, normal flow
Figure 19.2.2.5.6-5: Handover of CS and PS domain services from EUTRAN to GERAN A/Gb mode, normal flow
Figure 19.2.2.5.6-6 and Figure 19.2.2.5.6-7 illustrate the message sequence for the handover from EUTRAN to UTRAN procedure:
Figure 19.2.2.5.6-6. Handover of PS or CS domain service from EUTRAN to UTRAN, normal flow
Figure 19.2.2.5.6-7. Handover of PS and CS domain service from EUTRAN to UTRAN, normal flow",TS 36.300,19.2.2.5.6,all_images/image_1387.jpeg,Handover of PS domain service and handover of CS domain service from UTRAN
"This clause complements TR 25.922 [27] clause 5.1.7.2 regarding the E-UTRAN handling of containers.
Most RRC information is carried by means of containers across interfaces other than Uu. The following sequence diagrams illustrate which RRC information should be included within these containers used across the different network interfaces.
NOTE:	In order to maintain independence between protocols, no requirements are included in the interface protocols that are used to transfer the RRC information.
SRVCC (see TS 23.216 [28]) is supported from EUTRAN to UTRAN or GERAN A/Gb mode and from UTRAN or GERAN A/Gb mode to EUTRAN.
There is no support for interworking between EUTRAN and GERAN Iu-mode and between EUTRAN and GAN.
Figure 19.2.2.5.6-1 and 19.2.2.5.6-1a illustrate the message sequence for handover from GERAN to EUTRAN procedure:
Figure 19.2.2.5.6-1. Handover of PS domain service from GERAN A/Gb mode to EUTRAN, normal flow
UE is not requested to provide E-UTRAN UE capabilities while in GERAN. Hence the HANDOVER REQUEST does not contain E-UTRAN UE capabilities, and the capabilities are fetched by Target eNB from UE after handover is completed.
Figure 19.2.2.5.6-1a. Handover of CS domain service from GERAN A/Gb mode to PS-domain service in EUTRAN, normal flow
UE is not requested to provide E-UTRAN UE capabilities while in GERAN. Hence the HANDOVER REQUEST does not contain E-UTRAN UE capabilities, and the capabilities are fetched by Target eNB from UE after completed handover.
Figure 19.2.2.5.6-2 illustrates the message sequence for PS handover and CS handover from UTRAN to EUTRAN procedure:
Figure 19.2.2.5.6-2: Handover of PS domain service and handover of CS domain service from UTRAN to EUTRAN, normal flow
Figure 19.2.2.5.6-3 to Figure 19.2.2.5.6-5 illustrate the message sequence for the handover from EUTRAN to GERAN A/Gb mode procedure:
Figure 19.2.2.5.6-3: Handover of CS domain service from EUTRAN to GERAN A/Gb mode, normal flow
Figure 19.2.2.5.6-4. Handover of PS domain service from EUTRAN to GERAN A/Gb mode, normal flow
Figure 19.2.2.5.6-5: Handover of CS and PS domain services from EUTRAN to GERAN A/Gb mode, normal flow
Figure 19.2.2.5.6-6 and Figure 19.2.2.5.6-7 illustrate the message sequence for the handover from EUTRAN to UTRAN procedure:
Figure 19.2.2.5.6-6. Handover of PS or CS domain service from EUTRAN to UTRAN, normal flow
Figure 19.2.2.5.6-7. Handover of PS and CS domain service from EUTRAN to UTRAN, normal flow",TS 36.300,19.2.2.5.6,all_images/image_1388.jpeg,"Handover of CS domain service from EUTRAN to GERAN A/Gb mode, normal flow"
"This clause complements TR 25.922 [27] clause 5.1.7.2 regarding the E-UTRAN handling of containers.
Most RRC information is carried by means of containers across interfaces other than Uu. The following sequence diagrams illustrate which RRC information should be included within these containers used across the different network interfaces.
NOTE:	In order to maintain independence between protocols, no requirements are included in the interface protocols that are used to transfer the RRC information.
SRVCC (see TS 23.216 [28]) is supported from EUTRAN to UTRAN or GERAN A/Gb mode and from UTRAN or GERAN A/Gb mode to EUTRAN.
There is no support for interworking between EUTRAN and GERAN Iu-mode and between EUTRAN and GAN.
Figure 19.2.2.5.6-1 and 19.2.2.5.6-1a illustrate the message sequence for handover from GERAN to EUTRAN procedure:
Figure 19.2.2.5.6-1. Handover of PS domain service from GERAN A/Gb mode to EUTRAN, normal flow
UE is not requested to provide E-UTRAN UE capabilities while in GERAN. Hence the HANDOVER REQUEST does not contain E-UTRAN UE capabilities, and the capabilities are fetched by Target eNB from UE after handover is completed.
Figure 19.2.2.5.6-1a. Handover of CS domain service from GERAN A/Gb mode to PS-domain service in EUTRAN, normal flow
UE is not requested to provide E-UTRAN UE capabilities while in GERAN. Hence the HANDOVER REQUEST does not contain E-UTRAN UE capabilities, and the capabilities are fetched by Target eNB from UE after completed handover.
Figure 19.2.2.5.6-2 illustrates the message sequence for PS handover and CS handover from UTRAN to EUTRAN procedure:
Figure 19.2.2.5.6-2: Handover of PS domain service and handover of CS domain service from UTRAN to EUTRAN, normal flow
Figure 19.2.2.5.6-3 to Figure 19.2.2.5.6-5 illustrate the message sequence for the handover from EUTRAN to GERAN A/Gb mode procedure:
Figure 19.2.2.5.6-3: Handover of CS domain service from EUTRAN to GERAN A/Gb mode, normal flow
Figure 19.2.2.5.6-4. Handover of PS domain service from EUTRAN to GERAN A/Gb mode, normal flow
Figure 19.2.2.5.6-5: Handover of CS and PS domain services from EUTRAN to GERAN A/Gb mode, normal flow
Figure 19.2.2.5.6-6 and Figure 19.2.2.5.6-7 illustrate the message sequence for the handover from EUTRAN to UTRAN procedure:
Figure 19.2.2.5.6-6. Handover of PS or CS domain service from EUTRAN to UTRAN, normal flow
Figure 19.2.2.5.6-7. Handover of PS and CS domain service from EUTRAN to UTRAN, normal flow",TS 36.300,19.2.2.5.6,all_images/image_1389.jpeg,"Handover of CS and PS domain services from EUTRAN to GERAN A/Gb mode,"
"The purpose of the Retrieve UE Context procedure is to retrieve the UE context for a UE which attempts to resume its RRC connection in an eNB (the new eNB) different from the eNB (the old eNB) where the RRC connection was suspended or for a UE which attempts to re-establish its RRC connection in an eNB (the new eNB) different from the eNB (the old eNB) where the RRC connection failed, e.g. due to RLF.
If the new eNB is able to identify the old eNB based on the Resume ID or based on the Physical Cell ID received from the UE, it triggers the Retrieve UE Context procedure towards the old eNB.
If the old eNB is able to match the UE context with the Resume ID or with the ShortMAC-I, C-RNTI, failed PCI and new E-UTRAN Cell Identifier included in the RETRIEVE UE CONTEXT REQUEST message it responds with the RETRIEVE UE CONTEXT RESPONSE message containing UE context information.
Upon resumption of the UE Context in the new eNB, the new eNB resumes/re-establishes the RRC connection and performs the S1-AP Path Switch procedure to establish a S1 UE associated signalling connection to the serving MME and to request the MME to resume the UE context and related bearer contexts in the EPC (for resuming UEs) and update the downlink path (for resuming and re-establishing UEs). In case of re-establishment of the RRC connection, the new eNB may provide a data forwarding address per re-established E-RAB to the old eNB by means of the X2-AP Data Forwarding Address Indication procedure if DL forwarding was proposed by the old eNB. After the S1-AP Path Switch procedure the new eNB triggers release of the UE Context at the old eNB by means of the X2-AP UE Context Release procedure.
Figure 20.2.2.19-1: Retrieve UE Context procedure (highlighted in blue) for cases of UE context resumption. Successful case
Figure 20.2.2.19-1A: Retrieve UE Context procedure (highlighted in blue) for cases of UE re-establishment. Successful case
In case the old eNB cannot find UE Context Information corresponding to the Resume ID or to the ShortMAC-I, C-RNTI, failed PCI and new E-UTRAN Cell Identifier received from the UE, it responds with the RETRIEVE UE CONTEXT FAILURE message and the new eNB fails the RRC connection resume/re-establishment procedure as specified in TS 36.331 [16].
Figure 20.2.2.19-2: Retrieve UE Context procedure (highlighted in blue) for cases of UE context resumption. Unsuccessful case
Figure 20.2.2.19-3: Retrieve UE Context procedure (highlighted in blue) for cases of UE re-establishment. Unsuccessful case",TS 36.300,20.2.2.19,all_images/image_1391.jpeg,Retrieve UE Context procedure (highlighted in blue) for cases of UE context
"Figure 22.3.4-1: Automatic Neighbour Relation Function in case of e.g. UTRAN detected cell
For Inter-RAT and Inter-Frequency ANR, each cell contains an Inter Frequency Search list. This list contains all frequencies that shall be searched.
For Inter-RAT cells, the NoX2 attribute in the NCRT is absent, as X2 is only defined for E-UTRAN.
The function works as follows:
The eNB serving cell A has an ANR function. During connected mode, the eNB can instruct a UE to perform measurements and detect cells on other RATs/frequencies. The eNB may use different policies for instructing the UE to do measurements, and when to report them to the eNB.
1	The eNB instructs a UE to look for neighbour cells in the target RATs/frequencies. To do so the eNB may need to schedule appropriate idle periods to allow the UE to scan all cells in the target RATs/frequencies.
2	The UE reports the PCI of the detected cells in the target RATs/frequencies. The PCI is defined by the carrier frequency and the Primary Scrambling Code (PSC) in case of UTRAN FDD cell, by the carrier frequency and the cell parameter ID in case of UTRAN TDD cell, by the Band Indicator + BSIC + BCCH ARFCN in case of GERAN cell, by the PN Offset in case of CDMA2000 cell, and by the NR PSS/SSS in case of NR cell.
When the eNB receives UE reports containing PCIs of cell(s) the following sequence may be used.
3	The eNB instructs the UE, using the newly discovered PCI as parameter, to read the CGI and the RAC of the detected neighbour cell in case of GERAN detected cells, CGI, LAC, RAC and all broadcasted PLMN-ID(s) in case of UTRAN detected cells, CGI in case of CDMA2000 detected cells, and NCGI(s), TAC(s), RANAC(s), all available PLMN ID(s), gNB identity length(s) and all available NR frequency band(s) in case of NR detected cells. For the Inter-frequency case, the eNB instructs the UE, using the newly discovered PCI as parameter, to read the ECGI, TAC and all available PLMN ID(s) of the inter-frequency detected cell. The UE ignores transmissions from the serving cell while finding the requested information transmitted in the broadcast channel of the detected inter-system/inter-frequency neighbour cell. To do so, the eNB may need to schedule appropriate idle periods to allow the UE to read the requested information from the broadcast channel of the detected inter-RAT/inter-frequency neighbour cell.
4	After the UE has read the requested information in the new cell, it reports the detected CGI and RAC (in case of GERAN detected cells) or CGI, LAC, RAC and all broadcasted PLMN-ID(s) (in case of UTRAN detected cells) or CGI (in case of CDMA2000 detected cells) or all broadcast NCGI(s), TAC(s), RANAC(s), PLMN-ID(s), gNB identity length(s) and NR frequency band(s) (in case of NR detected cells) to the serving cell eNB. In the inter-RAT NR case, the UE may report noSIB1 indication in case the detected NR cell does not broadcast SIB1, as described in TS 36.331 [16]. In the inter-frequency case, the UE reports the ECGI, the, tracking area code and all PLMN-ID(s) that have been detected. If the detected cell is a CSG or hybrid cell, the UE also reports the CSG ID to the serving cell eNB.
5	The eNB updates its inter-RAT/inter-frequency Neighbour Cell Relation Table.
In the inter-frequency case and if needed, the eNB can use the PCI and ECGI for a new X2 interface setup towards this eNB. The setup of the X2 interface is described in clause 22.3.2.
NOTE:	The eNB may differentiate the open access HeNB from the other types of (H)eNB by the PCI configuration or ECGI configuration.",TS 36.300,22.3.4,all_images/image_1393.jpeg,Automatic Neighbour Relation Function in case of e.g. UTRAN detected cell
"When a UE experiences IDC problems that it cannot solve by itself and a network intervention is required, it sends an IDC indication via dedicated RRC signalling to report the IDC problems to the eNB. The UE may rely on existing LTE measurements and/or UE internal coordination to assess the interference and the details are left up to UE implementation.
NOTE:	For instance, the interference is applicable over several subframes/slots where not necessarily all the subframes/slots are affected and consists of interference caused by the aggressor radio to the victim radio during either active data exchange or upcoming data activity which is expected in up to a few hundred milliseconds.
A UE that supports IDC functionality indicates related capabilities to the network, and the network can then configure by dedicated signalling whether the UE is allowed to send an IDC indication. The IDC indication can only be triggered for frequencies for which a measurement object is configured and when:
-	for the primary frequency, the UE is experiencing IDC problems that it cannot solve by itself;
-	for a secondary frequency, regardless of the activation state of the corresponding SCell, the UE is experiencing or expects to experience upon activation IDC problems that it cannot solve by itself;
-	for a non-serving frequency, the UE expects to experience IDC problems that it cannot solve by itself if that non-serving frequency becomes a serving one.
When notified of IDC problems through an IDC indication from the UE, the eNB can choose to apply a Frequency Division Multiplexing (FDM) solution or a Time Division Multiplexing (TDM) solution:
-	The basic concept of an FDM solution is to move the LTE signal away from the ISM band by e.g., performing inter-frequency handover within E-UTRAN, removing SCells from the set of serving cells or de-activation of affected SCells, or in case of uplink CA operations, allocate uplink PRB resources on CC(s) whose inter-modulation distortion and harmonics does not fall into the frequency range of the victim system receiver.
-	The basic concept of a TDM solution is to ensure that transmission of a radio signal does not coincide with reception of another radio signal. LTE DRX mechanism is used to provide TDM patterns (i.e. periods during which the LTE UE may be scheduled or is not scheduled) to resolve the IDC issues. DRX based TDM solution should be used in a predictable way, i.e. the eNB should ensure a predictable pattern of unscheduled periods by means of e.g. DRX mechanism or de-activation of affected SCells.
To assist the eNB in selecting an appropriate solution, all necessary/available assistance information for both FDM and TDM solutions is sent together in the IDC indication to the eNB. The IDC assistance information contains the list of E-UTRA carriers suffering from IDC problems, the direction of the interference and, depending on the scenario (see TR 36.816 [50]), it also contains TDM patterns or parameters to enable appropriate DRX configuration for TDM solutions on the serving E-UTRA carrier. Furthermore, the IDC indication can also be configured to include uplink CA related assistance information containing the victim system as well as the list of supported uplink CA combinations suffering from IDC problems. Furthermore, the IDC indication can also be configured to indicate that the cause of IDC problems is hardware sharing between LAA and WLAN operation, in which case the UE may omit the TDM assistance information. The IDC indication is also used to update the IDC assistance information, including for the cases when the UE no longer suffers from IDC problems. In case of inter-eNB handover, the IDC assistance information is transferred from the source eNB to the target eNB.
IDC interference situation can be divided into following three phases as shown in Figure -1:
-	Phase 1: The UE detects start of IDC interference but does not initiate the transmission of the IDC indication to the eNB yet.
-	Phase 2: The UE has initiated the transmission of the IDC indication to the eNB and no solution is yet configured by the eNB to solve the IDC issue.
-	Phase 3: The eNB has provided a solution that solved the IDC interference to the UE.
Figure -1: Different phases of IDC interference related operations by UE
In different phases, UE behaviours related to RRM, RLM, and CSI measurements are shown in Table -1.
Table -1: RRM/RLM/CSI measurements in different phases of IDC interference
In addition, once configured by the network, the UE can autonomously deny LTE UL transmission in all phases to protect ISM in rare cases if other solutions cannot be used. Conversely, it is assumed that the UE also autonomously denies ISM transmission in order to ensure connectivity with the eNB to perform necessary LTE procedures, e.g., RRC connection reconfiguration and paging reception, etc. The network may configure a long-term denial rate by dedicated RRC signalling to limit the amount of LTE UL autonomous denials. Otherwise, the UE shall not perform any LTE UL autonomous denials.",TS 36.300,23.4.2,all_images/image_1394.jpeg,Different phases of IDC interference related operations by UE
"Figure 5-1 shows the architecture in EPS applicable to positioning of a UE with E-UTRAN access.
The MME receives a request for some location service associated with a particular target UE from another entity (e.g., GMLC or UE) or the MME itself decides to initiate some location service on behalf of a particular target UE (e.g., for an IMS emergency call from the UE) as described in TS 23.271 [2]. The MME then sends a location services request to an E-SMLC. The E-SMLC processes the location services request which may include transferring assistance data to the target UE to assist with UE-based and/or UE-assisted positioning and/or may include positioning of the target UE. For the Uplink method, the E-SMLC processes the location services request which includes transferring configuration data to the selected LMU(s). The E-SMLC then returns the result of the location service back to the MME (e.g., a position estimate for the UE and/or an indication of any assistance data transferred to the UE). In the case of a location service requested by an entity other than the MME (e.g., UE or E-SMLC), the MME returns the location service result to this entity.
The SLP is the SUPL entity responsible for positioning over the user plane. Further details of the relationship of the user-plane positioning entities to the E-UTRAN control-plane positioning architecture are described in Annex B.
An eNodeB may control several TPs, such as remote radio heads, or PRS-only TPs for support of PRS-based TBS.
Figure 5-1: UE Positioning Architecture applicable to E-UTRAN",TS 36.305,5,all_images/image_1395.jpeg,UE Positioning Architecture applicable to E-UTRAN
"Figure 6.4.1-1 shows the protocol layering used to support transfer of LPP messages between an E-SMLC and UE. The LPP PDU is carried in NAS PDU between the MME and the UE.
Figure 6.4.1-1: Protocol Layering for E-SMLC to UE Signalling",TS 36.305,6.4.1,all_images/image_1397.png,Protocol Layering for E-SMLC to UE Signalling
"Figure 6.5.1-1 shows the protocol layering used to support transfer of LPPa PDUs between an E-SMLC and eNode B.
The LPPa protocol is transparent to the MME. The MME routes the LPPa PDUs transparently based on a short Routing ID which corresponds to the involved E-SMLC node over the S1 interface without knowledge of the involved LPPa transaction. It carries the LPPa PDUs over S1 interface either in UE associated mode or non-UE associated mode.
Figure 6.5.1-1: Protocol Layering for E-SMLC to eNode B Signalling",TS 36.305,6.5.1,all_images/image_1398.jpeg,Protocol Layering for E-SMLC to eNode B Signalling
"Figure 6.5.3-1 shows LPPa PDU transfer between an E-SMLC and eNodeB when related to gathering data from the eNodeB for positioning support for all UEs.
Figure 6.5.3-1: LPPa PDU Transfer between an E-SMLC and eNodeB for obtaining eNodeB Data
0.	An eNodeB may communicate with several TPs (including PRS-only TPs in case of PRS-based TBS is supported) to configure TPs, obtain TP configuration information, etc.
	NOTE: eNodeB-TP signalling and configuration is outside the scope of this specification.
1.	Steps 1 and 2 are triggered when the E-SMLC needs to send an LPPa message to an eNodeB to obtain data related to the eNodeB, and possibly associated TPs. The E-SMLC determines an MME with access to the eNodeB and then sends an LCS-AP PDU (as specified in TS 29.171 [27]) to the MME carrying an LPPa PDU, the global identity of the eNodeB and the identity of the E-SMLC.
2.	The MME forwards the LPPa PDU to the identified eNode B in an S1AP Downlink Non UE Associated LPPa Transport message and includes the Routing ID related to the E-SMLC. The MME need not retain state information for this transfer – e.g. can treat any response in step 3 as a separate non-associated transfer.
3.	Steps 3 and 4 are triggered when an eNode B needs to send an LPPa PDU to an E-SMLC containing data applicable to the eNodeB, and possibly associated TPs. The eNodeB determines an MME with access to the E-SMLC and then sends an LPPa PDU to the MME in an S1AP Uplink Non UE Associated LPPa Transport message. The eNodeB includes the Routing ID related to the E-SMLC received at step 2.
4.	The MME forwards the LPPa PDU to the E-SMLC associated to the Routing ID indicated in step 3 and includes the global identity of the eNodeB and the identity of the E-SMLC in an LCS-AP PDU (as specified in TS 29.171 [27]). Steps 1 to 4 may be repeated.",TS 36.305,6.5.3,all_images/image_1399.jpeg,LPPa PDU Transfer between an E-SMLC and eNodeB for obtaining eNodeB Data
"Figure 7.3.2-1 shows the sequence of operations for an MO-LR service, starting at the point where an LCS Client in the UE or the user has requested some location service (e.g., retrieval of the UE's location or transfer of the UE's location to a third party).
Figure 7.3.2-1: UE Positioning Operations to support an MO-LR
1.	The UE sends a NAS level MO-LR location service request message to the MME. The MO-LR location service request message may carry an LPP PDU to instigate one or more LPP procedures to transfer capabilities, request assistance data and/or transfer location information (e.g. location measurements).
2.	The MME sends a location request to the E-SMLC and includes any LPP PDU received in step 1.
3.	The E-SMLC may obtain location related information from the UE and/or from the serving eNode B. In the former case or if an immediate response is needed to any LPP procedure instigated by the UE in step 1 (e.g., a request for assistance data), the E-SMLC instigates one or more LPP procedures to transfer UE positioning capabilities, provide assistance data to the UE and/or obtain location information from the UE. The UE may also instigate further LPP procedures after the first LPP message is received from the E-SMLC (e.g., to request assistance data or to request further assistance data).
4.	If the E-SMLC needs location related information for the UE from the eNode B, the E-SMLC instigates one or more LPPa procedures. Step 4 may also precede step 3 or occur in parallel with it.
5.	The E-SMLC returns a location response to the MME with any location estimate obtained as a result of steps 3 and 4.
6.	If the UE requested location transfer to a third party the MME transfers the location received from the E-SMLC in step 5 to the third party as defined in TS 23.271 [2].
7.	The MME sends a NAS level MO-LR location service response message to the UE.",TS 36.305,7.3.2,all_images/image_1400.jpeg,UE Positioning Operations to support an MO-LR
"The general procedures for broadcast of positioning assistance data and delivery of ciphering keys to UEs is described in TS 23.271 [2]. This clause defines the overall sequences of operations that occur in the E-SMLC, E-UTRAN and UE.
Figure 7.6.2-1: Procedures to support broadcast of assistance data.
1.	The E-SMLC sends an LPPa Assistance Data Information Control message to the eNB with an indication to start broadcasting assistance information. The message includes one or more System Information groups, where each group contains the broadcast periodicity and one or more posSIB types together with meta data. Each posSIB type may be ciphered and/or segmented at the E-SMLC. The meta data may include an indication whether the posSIB type in the System Information group is ciphered or not, as well as an indication of an applicable GNSS type.
2.	The eNB includes the received System Information groups in RRC System Information Messages and corresponding scheduling information in SIB1 as described in [12]. The UE applies the system information acquisition procedure according to [12] for acquiring the assistance data information that is broadcasted.
3.	If the posSIB types were ciphered by the E-SMLC, the E-SMLC provides the used ciphering keys, together with a validity time and validity area for each key, to the MME using an LCS-AP Ciphering Key Data message described in TS 29.171 [27]. The MME returns a LCS-AP Ciphering Key Data Result message back to the E-SMLC indicating whether the MME was able to successfully store the ciphering data sets. The MME may then distribute successfully stored ciphering keys and their validity times and validity areas to suitably subscribed UEs using a mobility management message as described in TS 23.271 [2]. The E-SMLC repeats this procedure whenever a ciphering key changes.
4.	At any time after Step 1, the eNB may send a LPPa Assistance Information Feedback message to the E-SMLC providing feedback on assistance information broadcasting. The message may include an assistance information failure list indicating that certain posSIB types could not be configured for broadcasting by the eNB.
5.	If the assistance information in a System Information group changes, the E-SMLC provides updated information in a LPPa Assistance Information Control message.
6.	The eNB replaces the previously stored System Information groups with the new information received at Step 5 and includes the new System Information groups in RRC System Information Messages.
7.	If the E-SMLC wants to abort the broadcast of a System Information Group, it sends a LPPa Assistance Information Control message to the eNB including an indication to stop broadcasting the assistance information.",TS 36.305,7.6.2,all_images/image_1402.jpeg,Procedures to support broadcast of assistance data.
"Figure 8.4.3.1-1 shows the location information acquisition operation for the downlink positioning method when information is needed on demand in real time.
Figure 8.4.3.1-1: E-SMLC-initiated On Demand Procedure for Location Information Applicable to Downlink
(1)	The E-SMLC sends an LPPa message of type Request Location Information to the eNodeB. This request includes an indication of the downlink related information requested.
(2)	The eNodeB obtains the information requested in step 1 using previously configured or stored information and/or real time measurements in the case of a request for timing information where recent timing information is not already available. The eNodeB then sends an LPPa message of type Provide Location Information to the E-SMLC. If the eNodeB is unable to obtain any of the requested information, the eNodeB sends an LPPa failure message, providing the error reason.",TS 36.305,8.4.3.1,all_images/image_1404.jpeg,E-SMLC-initiated On Demand Procedure for Location Information Applicable to
"A UE is in RRC_CONNECTED when an RRC connection has been established or in RRC_INACTIVE (if the UE is connected to 5GC) when RRC connection is suspended. If this is not the case, i.e. no RRC connection is established, the UE is in RRC_IDLE state. The RRC states can further be characterised as follows:
-	RRC_IDLE:
-	A UE specific DRX may be configured by upper layers;
-	UE controlled mobility;
-	The UE:
-	Monitors a Paging channel to detect incoming calls (by CN paging), system information change, for ETWS capable UEs, ETWS notification, and for CMAS capable UEs, CMAS notification;
-	Performs neighbouring cell measurements and cell (re-)selection;
-	Acquires system information;
-	Performs logging of available measurements together with location and time for logged measurement configured UEs;
-	May perform EDT;
-	May perform transmission using PUR;
-	Performs idle/inactive measurements for idle/inactive measurement configured UEs.
-	RRC_INACTIVE:
-	A UE specific DRX may be configured by upper layers or by RRC layer;
-	A RAN-based notification area is configured by RRC layer;
-	The UE stores the UE Inactive AS context;
-	The UE:
-	Applies RRC_IDLE procedures unless specified otherwise;
-	Monitors a Paging channel for CN paging using 5G-S-TMSI and RAN paging using fullI-RNTI;
-	Performs periodic RAN-based notification area update;
-	Performs RAN-based notification area update when moving out of the configured RAN-based notification area.
-	RRC_CONNECTED:
-	Transfer of unicast data to/from UE;
-	At lower layers, the UE may be configured with a UE specific DRX;
-	For UEs supporting CA, use of one or more SCells, aggregated with the PCell, for increased bandwidth;
-	For UEs supporting DC, use of one SCG, aggregated with the MCG, for increased bandwidth;
-	For UEs supporting (NG)EN-DC, option to configure one NR SCG in conjunction with the MCG for DRBs and SRBs, for improved performance (SRBs) and increased bandwidth (DRBs);
-	For UEs supporting NE-DC, option to configure one SCG in conjunction with the NR MCG for DRBs and SRBs, for improved performance (SRBs) and increased bandwidth (DRBs);
-	Network controlled mobility, i.e. handover and cell change order with optional network assistance (NACC) to GERAN (not applicable for NB-IoT);
-	The UE:
-	Monitors a Paging channel and/ or System Information Block Type 1 contents to detect system information change, for ETWS capable UEs, ETWS notification, and for CMAS capable UEs, CMAS notification (not applicable for BL UEs, UEs in CE and NB-IoT UEs);
-	Monitors control channels associated with the shared data channel to determine if data is scheduled for it;
-	For UEs in CE supporting reception of ETWS/CMAS indication in RRC_CONNECTED mode, monitors control channels associated with the shared data channel to acquire ETWS notification and/or CMAS notification;
-	Provides channel quality and feedback information (not applicable for NB-IoT);
-	Performs neighbouring cell measurements and measurement reporting (not applicable for NB-IoT);
-	Acquires system information (not applicable for BL UEs, UEs in CE and NB-IoT UEs), except for ETWS/CMAS reception where applicable.
NOTE:	The term ""UE is connected to 5GC"" covers the scenarios that the UE is connected to 5GC and the UE is requesting to connect with 5GC.
Figure 4.2.1-1 not only provides an overview of the RRC states in E-UTRA/EPC, but also illustrates the mobility support between E-UTRA/EPC, UTRAN and GERAN.
Figure 4.2.1-1: E-UTRA/EPC states and inter RAT mobility procedures, 3GPP
Figure 4.2.1-2 illustrates the mobility support between E-UTRA/EPC, CDMA2000 1xRTT and CDMA2000 HRPD. The details of the CDMA2000 state models are out of the scope of this specification.
Figure 4.2.1-2: Mobility procedures between E-UTRA/EPC and CDMA2000
Figure 4.2.1-3 not only provides an overview of the RRC states in E-UTRA/5GC, but also illustrates the mobility support between E-UTRA/5GC, UTRAN and GERAN.
Figure 4.2.1-3: E-UTRA/5GC states and inter RAT mobility procedures, 3GPP
Figure 4.2.1-4 illustrates the mobility procedures supported between E-UTRA/5GC, CDMA2000 1xRTT and CDMA2000 HRPD. The details of the CDMA2000 state models are out of the scope of this specification.
Figure 4.2.1-4: Mobility procedures between E-UTRA/5GC and CDMA2000
Figure 4.2.1-5 illustrates the mobility procedures supported between E-UTRA/5GC and E-UTRA/EPC.
Figure 4.2.1-5: Mobility procedures between E-UTRA/5GC and E-UTRA/EPC
Figure 4.2.1-6 illustrates the mobility procedures supported between E-UTRA/EPC, E-UTRA/5GC and NR.
Figure 4.2.1-6:	Mobility procedures between E-UTRA/EPC, E-UTRA/5GC and NR
The inter-RAT handover procedure(s) supports the case of signalling, conversational services, non-conversational services and combinations of these.
In addition to the state transitions shown in figures above, there is support for connection release with redirection information from E-UTRA RRC_CONNECTED to GERAN, UTRAN, CDMA2000 (HRPD Idle/ 1xRTT Dormant mode) and NR. A UE in RRC_INACTIVE enters RRC_IDLE when it enters another RAT or switches to another CN type.
For NB-IoT, mobility between E-UTRA and UTRAN, GERAN and between E-UTRA and CDMA2000 1xRTT and CDMA2000 HRPD is not supported at AS level and hence only the E-UTRA states depicted in Figure 4.2.1-1 are applicable.",TS 36.331,4.2.1,all_images/image_1406.jpeg,"E-UTRA/EPC states and inter RAT mobility procedures, 3GPP"
"A UE is in RRC_CONNECTED when an RRC connection has been established or in RRC_INACTIVE (if the UE is connected to 5GC) when RRC connection is suspended. If this is not the case, i.e. no RRC connection is established, the UE is in RRC_IDLE state. The RRC states can further be characterised as follows:
-	RRC_IDLE:
-	A UE specific DRX may be configured by upper layers;
-	UE controlled mobility;
-	The UE:
-	Monitors a Paging channel to detect incoming calls (by CN paging), system information change, for ETWS capable UEs, ETWS notification, and for CMAS capable UEs, CMAS notification;
-	Performs neighbouring cell measurements and cell (re-)selection;
-	Acquires system information;
-	Performs logging of available measurements together with location and time for logged measurement configured UEs;
-	May perform EDT;
-	May perform transmission using PUR;
-	Performs idle/inactive measurements for idle/inactive measurement configured UEs.
-	RRC_INACTIVE:
-	A UE specific DRX may be configured by upper layers or by RRC layer;
-	A RAN-based notification area is configured by RRC layer;
-	The UE stores the UE Inactive AS context;
-	The UE:
-	Applies RRC_IDLE procedures unless specified otherwise;
-	Monitors a Paging channel for CN paging using 5G-S-TMSI and RAN paging using fullI-RNTI;
-	Performs periodic RAN-based notification area update;
-	Performs RAN-based notification area update when moving out of the configured RAN-based notification area.
-	RRC_CONNECTED:
-	Transfer of unicast data to/from UE;
-	At lower layers, the UE may be configured with a UE specific DRX;
-	For UEs supporting CA, use of one or more SCells, aggregated with the PCell, for increased bandwidth;
-	For UEs supporting DC, use of one SCG, aggregated with the MCG, for increased bandwidth;
-	For UEs supporting (NG)EN-DC, option to configure one NR SCG in conjunction with the MCG for DRBs and SRBs, for improved performance (SRBs) and increased bandwidth (DRBs);
-	For UEs supporting NE-DC, option to configure one SCG in conjunction with the NR MCG for DRBs and SRBs, for improved performance (SRBs) and increased bandwidth (DRBs);
-	Network controlled mobility, i.e. handover and cell change order with optional network assistance (NACC) to GERAN (not applicable for NB-IoT);
-	The UE:
-	Monitors a Paging channel and/ or System Information Block Type 1 contents to detect system information change, for ETWS capable UEs, ETWS notification, and for CMAS capable UEs, CMAS notification (not applicable for BL UEs, UEs in CE and NB-IoT UEs);
-	Monitors control channels associated with the shared data channel to determine if data is scheduled for it;
-	For UEs in CE supporting reception of ETWS/CMAS indication in RRC_CONNECTED mode, monitors control channels associated with the shared data channel to acquire ETWS notification and/or CMAS notification;
-	Provides channel quality and feedback information (not applicable for NB-IoT);
-	Performs neighbouring cell measurements and measurement reporting (not applicable for NB-IoT);
-	Acquires system information (not applicable for BL UEs, UEs in CE and NB-IoT UEs), except for ETWS/CMAS reception where applicable.
NOTE:	The term ""UE is connected to 5GC"" covers the scenarios that the UE is connected to 5GC and the UE is requesting to connect with 5GC.
Figure 4.2.1-1 not only provides an overview of the RRC states in E-UTRA/EPC, but also illustrates the mobility support between E-UTRA/EPC, UTRAN and GERAN.
Figure 4.2.1-1: E-UTRA/EPC states and inter RAT mobility procedures, 3GPP
Figure 4.2.1-2 illustrates the mobility support between E-UTRA/EPC, CDMA2000 1xRTT and CDMA2000 HRPD. The details of the CDMA2000 state models are out of the scope of this specification.
Figure 4.2.1-2: Mobility procedures between E-UTRA/EPC and CDMA2000
Figure 4.2.1-3 not only provides an overview of the RRC states in E-UTRA/5GC, but also illustrates the mobility support between E-UTRA/5GC, UTRAN and GERAN.
Figure 4.2.1-3: E-UTRA/5GC states and inter RAT mobility procedures, 3GPP
Figure 4.2.1-4 illustrates the mobility procedures supported between E-UTRA/5GC, CDMA2000 1xRTT and CDMA2000 HRPD. The details of the CDMA2000 state models are out of the scope of this specification.
Figure 4.2.1-4: Mobility procedures between E-UTRA/5GC and CDMA2000
Figure 4.2.1-5 illustrates the mobility procedures supported between E-UTRA/5GC and E-UTRA/EPC.
Figure 4.2.1-5: Mobility procedures between E-UTRA/5GC and E-UTRA/EPC
Figure 4.2.1-6 illustrates the mobility procedures supported between E-UTRA/EPC, E-UTRA/5GC and NR.
Figure 4.2.1-6:	Mobility procedures between E-UTRA/EPC, E-UTRA/5GC and NR
The inter-RAT handover procedure(s) supports the case of signalling, conversational services, non-conversational services and combinations of these.
In addition to the state transitions shown in figures above, there is support for connection release with redirection information from E-UTRA RRC_CONNECTED to GERAN, UTRAN, CDMA2000 (HRPD Idle/ 1xRTT Dormant mode) and NR. A UE in RRC_INACTIVE enters RRC_IDLE when it enters another RAT or switches to another CN type.
For NB-IoT, mobility between E-UTRA and UTRAN, GERAN and between E-UTRA and CDMA2000 1xRTT and CDMA2000 HRPD is not supported at AS level and hence only the E-UTRA states depicted in Figure 4.2.1-1 are applicable.",TS 36.331,4.2.1,all_images/image_1407.jpeg,Mobility procedures between E-UTRA/EPC and CDMA2000
"A UE is in RRC_CONNECTED when an RRC connection has been established or in RRC_INACTIVE (if the UE is connected to 5GC) when RRC connection is suspended. If this is not the case, i.e. no RRC connection is established, the UE is in RRC_IDLE state. The RRC states can further be characterised as follows:
-	RRC_IDLE:
-	A UE specific DRX may be configured by upper layers;
-	UE controlled mobility;
-	The UE:
-	Monitors a Paging channel to detect incoming calls (by CN paging), system information change, for ETWS capable UEs, ETWS notification, and for CMAS capable UEs, CMAS notification;
-	Performs neighbouring cell measurements and cell (re-)selection;
-	Acquires system information;
-	Performs logging of available measurements together with location and time for logged measurement configured UEs;
-	May perform EDT;
-	May perform transmission using PUR;
-	Performs idle/inactive measurements for idle/inactive measurement configured UEs.
-	RRC_INACTIVE:
-	A UE specific DRX may be configured by upper layers or by RRC layer;
-	A RAN-based notification area is configured by RRC layer;
-	The UE stores the UE Inactive AS context;
-	The UE:
-	Applies RRC_IDLE procedures unless specified otherwise;
-	Monitors a Paging channel for CN paging using 5G-S-TMSI and RAN paging using fullI-RNTI;
-	Performs periodic RAN-based notification area update;
-	Performs RAN-based notification area update when moving out of the configured RAN-based notification area.
-	RRC_CONNECTED:
-	Transfer of unicast data to/from UE;
-	At lower layers, the UE may be configured with a UE specific DRX;
-	For UEs supporting CA, use of one or more SCells, aggregated with the PCell, for increased bandwidth;
-	For UEs supporting DC, use of one SCG, aggregated with the MCG, for increased bandwidth;
-	For UEs supporting (NG)EN-DC, option to configure one NR SCG in conjunction with the MCG for DRBs and SRBs, for improved performance (SRBs) and increased bandwidth (DRBs);
-	For UEs supporting NE-DC, option to configure one SCG in conjunction with the NR MCG for DRBs and SRBs, for improved performance (SRBs) and increased bandwidth (DRBs);
-	Network controlled mobility, i.e. handover and cell change order with optional network assistance (NACC) to GERAN (not applicable for NB-IoT);
-	The UE:
-	Monitors a Paging channel and/ or System Information Block Type 1 contents to detect system information change, for ETWS capable UEs, ETWS notification, and for CMAS capable UEs, CMAS notification (not applicable for BL UEs, UEs in CE and NB-IoT UEs);
-	Monitors control channels associated with the shared data channel to determine if data is scheduled for it;
-	For UEs in CE supporting reception of ETWS/CMAS indication in RRC_CONNECTED mode, monitors control channels associated with the shared data channel to acquire ETWS notification and/or CMAS notification;
-	Provides channel quality and feedback information (not applicable for NB-IoT);
-	Performs neighbouring cell measurements and measurement reporting (not applicable for NB-IoT);
-	Acquires system information (not applicable for BL UEs, UEs in CE and NB-IoT UEs), except for ETWS/CMAS reception where applicable.
NOTE:	The term ""UE is connected to 5GC"" covers the scenarios that the UE is connected to 5GC and the UE is requesting to connect with 5GC.
Figure 4.2.1-1 not only provides an overview of the RRC states in E-UTRA/EPC, but also illustrates the mobility support between E-UTRA/EPC, UTRAN and GERAN.
Figure 4.2.1-1: E-UTRA/EPC states and inter RAT mobility procedures, 3GPP
Figure 4.2.1-2 illustrates the mobility support between E-UTRA/EPC, CDMA2000 1xRTT and CDMA2000 HRPD. The details of the CDMA2000 state models are out of the scope of this specification.
Figure 4.2.1-2: Mobility procedures between E-UTRA/EPC and CDMA2000
Figure 4.2.1-3 not only provides an overview of the RRC states in E-UTRA/5GC, but also illustrates the mobility support between E-UTRA/5GC, UTRAN and GERAN.
Figure 4.2.1-3: E-UTRA/5GC states and inter RAT mobility procedures, 3GPP
Figure 4.2.1-4 illustrates the mobility procedures supported between E-UTRA/5GC, CDMA2000 1xRTT and CDMA2000 HRPD. The details of the CDMA2000 state models are out of the scope of this specification.
Figure 4.2.1-4: Mobility procedures between E-UTRA/5GC and CDMA2000
Figure 4.2.1-5 illustrates the mobility procedures supported between E-UTRA/5GC and E-UTRA/EPC.
Figure 4.2.1-5: Mobility procedures between E-UTRA/5GC and E-UTRA/EPC
Figure 4.2.1-6 illustrates the mobility procedures supported between E-UTRA/EPC, E-UTRA/5GC and NR.
Figure 4.2.1-6:	Mobility procedures between E-UTRA/EPC, E-UTRA/5GC and NR
The inter-RAT handover procedure(s) supports the case of signalling, conversational services, non-conversational services and combinations of these.
In addition to the state transitions shown in figures above, there is support for connection release with redirection information from E-UTRA RRC_CONNECTED to GERAN, UTRAN, CDMA2000 (HRPD Idle/ 1xRTT Dormant mode) and NR. A UE in RRC_INACTIVE enters RRC_IDLE when it enters another RAT or switches to another CN type.
For NB-IoT, mobility between E-UTRA and UTRAN, GERAN and between E-UTRA and CDMA2000 1xRTT and CDMA2000 HRPD is not supported at AS level and hence only the E-UTRA states depicted in Figure 4.2.1-1 are applicable.",TS 36.331,4.2.1,all_images/image_1409.jpeg,Mobility procedures between E-UTRA/5GC and CDMA2000
"A UE is in RRC_CONNECTED when an RRC connection has been established or in RRC_INACTIVE (if the UE is connected to 5GC) when RRC connection is suspended. If this is not the case, i.e. no RRC connection is established, the UE is in RRC_IDLE state. The RRC states can further be characterised as follows:
-	RRC_IDLE:
-	A UE specific DRX may be configured by upper layers;
-	UE controlled mobility;
-	The UE:
-	Monitors a Paging channel to detect incoming calls (by CN paging), system information change, for ETWS capable UEs, ETWS notification, and for CMAS capable UEs, CMAS notification;
-	Performs neighbouring cell measurements and cell (re-)selection;
-	Acquires system information;
-	Performs logging of available measurements together with location and time for logged measurement configured UEs;
-	May perform EDT;
-	May perform transmission using PUR;
-	Performs idle/inactive measurements for idle/inactive measurement configured UEs.
-	RRC_INACTIVE:
-	A UE specific DRX may be configured by upper layers or by RRC layer;
-	A RAN-based notification area is configured by RRC layer;
-	The UE stores the UE Inactive AS context;
-	The UE:
-	Applies RRC_IDLE procedures unless specified otherwise;
-	Monitors a Paging channel for CN paging using 5G-S-TMSI and RAN paging using fullI-RNTI;
-	Performs periodic RAN-based notification area update;
-	Performs RAN-based notification area update when moving out of the configured RAN-based notification area.
-	RRC_CONNECTED:
-	Transfer of unicast data to/from UE;
-	At lower layers, the UE may be configured with a UE specific DRX;
-	For UEs supporting CA, use of one or more SCells, aggregated with the PCell, for increased bandwidth;
-	For UEs supporting DC, use of one SCG, aggregated with the MCG, for increased bandwidth;
-	For UEs supporting (NG)EN-DC, option to configure one NR SCG in conjunction with the MCG for DRBs and SRBs, for improved performance (SRBs) and increased bandwidth (DRBs);
-	For UEs supporting NE-DC, option to configure one SCG in conjunction with the NR MCG for DRBs and SRBs, for improved performance (SRBs) and increased bandwidth (DRBs);
-	Network controlled mobility, i.e. handover and cell change order with optional network assistance (NACC) to GERAN (not applicable for NB-IoT);
-	The UE:
-	Monitors a Paging channel and/ or System Information Block Type 1 contents to detect system information change, for ETWS capable UEs, ETWS notification, and for CMAS capable UEs, CMAS notification (not applicable for BL UEs, UEs in CE and NB-IoT UEs);
-	Monitors control channels associated with the shared data channel to determine if data is scheduled for it;
-	For UEs in CE supporting reception of ETWS/CMAS indication in RRC_CONNECTED mode, monitors control channels associated with the shared data channel to acquire ETWS notification and/or CMAS notification;
-	Provides channel quality and feedback information (not applicable for NB-IoT);
-	Performs neighbouring cell measurements and measurement reporting (not applicable for NB-IoT);
-	Acquires system information (not applicable for BL UEs, UEs in CE and NB-IoT UEs), except for ETWS/CMAS reception where applicable.
NOTE:	The term ""UE is connected to 5GC"" covers the scenarios that the UE is connected to 5GC and the UE is requesting to connect with 5GC.
Figure 4.2.1-1 not only provides an overview of the RRC states in E-UTRA/EPC, but also illustrates the mobility support between E-UTRA/EPC, UTRAN and GERAN.
Figure 4.2.1-1: E-UTRA/EPC states and inter RAT mobility procedures, 3GPP
Figure 4.2.1-2 illustrates the mobility support between E-UTRA/EPC, CDMA2000 1xRTT and CDMA2000 HRPD. The details of the CDMA2000 state models are out of the scope of this specification.
Figure 4.2.1-2: Mobility procedures between E-UTRA/EPC and CDMA2000
Figure 4.2.1-3 not only provides an overview of the RRC states in E-UTRA/5GC, but also illustrates the mobility support between E-UTRA/5GC, UTRAN and GERAN.
Figure 4.2.1-3: E-UTRA/5GC states and inter RAT mobility procedures, 3GPP
Figure 4.2.1-4 illustrates the mobility procedures supported between E-UTRA/5GC, CDMA2000 1xRTT and CDMA2000 HRPD. The details of the CDMA2000 state models are out of the scope of this specification.
Figure 4.2.1-4: Mobility procedures between E-UTRA/5GC and CDMA2000
Figure 4.2.1-5 illustrates the mobility procedures supported between E-UTRA/5GC and E-UTRA/EPC.
Figure 4.2.1-5: Mobility procedures between E-UTRA/5GC and E-UTRA/EPC
Figure 4.2.1-6 illustrates the mobility procedures supported between E-UTRA/EPC, E-UTRA/5GC and NR.
Figure 4.2.1-6:	Mobility procedures between E-UTRA/EPC, E-UTRA/5GC and NR
The inter-RAT handover procedure(s) supports the case of signalling, conversational services, non-conversational services and combinations of these.
In addition to the state transitions shown in figures above, there is support for connection release with redirection information from E-UTRA RRC_CONNECTED to GERAN, UTRAN, CDMA2000 (HRPD Idle/ 1xRTT Dormant mode) and NR. A UE in RRC_INACTIVE enters RRC_IDLE when it enters another RAT or switches to another CN type.
For NB-IoT, mobility between E-UTRA and UTRAN, GERAN and between E-UTRA and CDMA2000 1xRTT and CDMA2000 HRPD is not supported at AS level and hence only the E-UTRA states depicted in Figure 4.2.1-1 are applicable.",TS 36.331,4.2.1,all_images/image_1411.jpeg,"Mobility procedures between E-UTRA/EPC, E-UTRA/5GC and NR"
"Frame structure type 2 is applicable to TDD only. Each radio frame of length  consists of two half-frames of length each. Each half-frame consists of five subframes of length. Each subframe is defined as two slots, and, of length  each. Subframe  in frame  has an absolute subframe number  where  is the system frame number.
The uplink-downlink configuration in a cell may vary between frames and controls in which subframes uplink or downlink transmissions may take place in the current frame. The uplink-downlink configuration in the current frame is obtained according to Clause 13 in [4].
The supported uplink-downlink configurations are listed in Table 4.2-2 where, for each subframe in a radio frame, ""D"" denotes a downlink subframe reserved for downlink transmissions, ""U"" denotes an uplink subframe reserved for uplink transmissions and ""S"" denotes a special subframe with the three fields DwPTS, GP and UpPTS. The length of DwPTS and UpPTS is given by Table 4.2-1 subject to the total length of DwPTS, GP and UpPTS being equal to where X is the number of additional SC-FDMA symbols in UpPTS provided by the higher layer parameter srs-UpPtsAdd if configured otherwise X is equal to 0. The UE is not expected to be configured with 2 additional UpPTS SC-FDMA symbols for special subframe configurations {3, 4, 7, 8} for normal cyclic prefix in downlink and special subframe configurations {2, 3, 5, 6} for extended cyclic prefix in downlink and 4 additional UpPTS SC-FDMA symbols for special subframe configurations {1, 2, 3, 4, 6, 7, 8} for normal cyclic prefix in downlink and special subframe configurations {1, 2, 3, 5, 6} for extended cyclic prefix in downlink.
Uplink-downlink configurations with both 5 ms and 10 ms downlink-to-uplink switch-point periodicity are supported.
-	In case of 5 ms downlink-to-uplink switch-point periodicity, the special subframe exists in both half-frames.
-	In case of 10 ms downlink-to-uplink switch-point periodicity, the special subframe exists in the first half-frame only.
Subframes 0 and 5 and DwPTS are always reserved for downlink transmission. For special subframe configurations 1, 2, 3, 4, 6, 7 and 8, DwPTS is split into two parts, of which the first part is a slot and the second part is of X-symbol duration within the second slot. Downlink subframes, downlink slots in the downlink subframe and DwPTS, and the X–symbol duration in the second slot of DwPTS are available for downlink transmission. The X-symbol transmission opportunity is only available for special subframe configuration 3,4 and 8.
UpPTS and the subframe immediately following the special subframe are always reserved for uplink transmission. Uplink subframes, uplink slots and UpPTS with special subframe configuration 10 are available for uplink transmission. Note that UpPTS with special subframe configuration 10 are not available for SPUCCH transmission.
In case multiple cells are aggregated, the UE may assume that the guard period of the special subframe in the cells using frame structure type 2 have an overlap of at least .
In case multiple cells with different uplink-downlink configurations in the current radio frame are aggregated and the UE is not capable of simultaneous reception and transmission in the aggregated cells, the following constraints apply:
-	if the subframe in the primary cell is a downlink subframe, the UE shall not transmit any signal or channel on a secondary cell in the same subframe
-	if the subframe in the primary cell is an uplink subframe, the UE is not expected to receive any downlink transmissions on a secondary cell in the same subframe
-	if the subframe in the primary cell is a special subframe and the same subframe in a secondary cell is a downlink subframe, the UE is not expected to receive PDSCH/EPDCCH/PMCH/PRS transmissions in the secondary cell in the same subframe, and the UE is not expected to receive any other signals on the secondary cell in OFDM symbols that overlaps with the guard period or UpPTS in the primary cell.
For frame structure type 2, the higher-layer parameters for symbol-level resource reservation for BL/CE UEs (symbolBitmap1 and symbolBitmap2) do not apply to special subframes.
Figure 4.2-1: Frame structure type 2 (for 5 ms switch-point periodicity)
Table 4.2-1: Configuration of special subframe (lengths of DwPTS/GP/UpPTS)
Table 4.2-2: Uplink-downlink configurations",TS 36.211,4.2,all_images/image_1413.jpeg,Frame structure type 2 (for 5 ms switch-point periodicity)
"The baseband signal representing the physical uplink shared channel is defined in terms of the following steps:
-	scrambling
-	modulation of scrambled bits to generate complex-valued symbols
-	mapping of the complex-valued modulation symbols onto one or several transmission layers
-	transform precoding to generate complex-valued symbols
-	precoding of the complex-valued symbols
-	mapping of precoded complex-valued symbols to resource elements
-	generation of complex-valued time-domain SC-FDMA signal for each antenna port
Figure 5.3-1: Overview of uplink physical channel processing",TS 36.211,5.3,all_images/image_1415.jpeg,Overview of uplink physical channel processing
"The UE test loop function provides access to isolated functions of the UE via the radio interface without introducing wherever possible new physical interfaces just for the reason of conformance testing.
NOTE 0:	One exception from the rule above is the UE test loop mode E and UTC time reset when used for V2X out-of-coverage test scenarios which require an additional physical interface for the transmission of AT commands. This has been based on the assumption that V2X devices will normally provide such interface for other than testing purposes e.g. for device configuration.
NOTE 1:	It should be emphasised that the UE test loop function only describes the functional behaviour of the UE with respect to its external interfaces; physical implementation of the UE test loop function is completely left open to the manufacturer.
The UE test loop function is activated by transmitting the appropriate TC message to the UE, see clause 6.
The UE test loop function can be operated in different loopback modes:
-	UE test loop mode A;
-	UE test loop mode B;
-	UE test loop mode C;
-	UE test loop mode D;
-	UE test loop mode E;
-	UE test loop mode F;
-	UE test loop mode G;
-	UE test loop mode H;
-	UE test loop mode I.
UE test loop mode A provides loopback of PDCP SDUs for bi-directional data radio bearers while UE is operating in E-UTRA or NB-IoT mode. The downlink PDCP SDUs received by the UE on each bi-directional data radio bearer are returned on the same radio bearer regardless of the PDCP SDU contents and of the TFT of the associated EPS bearer context [36].
UE test loop mode B provides loopback of PDCP SDUs (E-UTRA and UTRA), SNDCP PDUs (GSM/GPRS) and RLP PDUs (CDMA2000) for bi-directional EPS bearers while UE is operated in E-UTRA, NB-IoT, UTRA, GSM/GPRS or CDMA2000 modes. When operating in E-UTRA, NB-IoT, UTRA or GSM/GPRS then the downlink PDCP SDUs or SNDCP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer associated with an EPS bearer context with a TFT matching the TCP/UDP/IP protocol information within the PDCP SDU or SNDCP SDU [36]. When operating in CDMA2000 modes, the downlink RLP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer with the smallest identity, regardless of the RLP PDU content and of the TFT of the associated EPS bearer context.
NOTE 2:	When multiple PDN connections are established (or multiple Primary PDP Contexts are active), it is assumed that different IP addresses are allocated to the UE by the SS on each PDN.
UE test loop mode C provides counting of successfully received MBMS Packets on a given MTCH while UE is operating in E-MBMS/E-UTRA mode. For E-MBMS then one or more MTCHs are multiplexed on a MCH. MBMS packets for a MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode D provides means for announcing or monitoring of ProSe Direct Discovery messages on SL-DCH, as specified by the test loop mode D setup IE in the CLOSE UE TEST LOOP message. In particular, for discovery monitor operation, UE test loop mode D provides counting of successfully received SL-DCH MAC SDUs while the UE is operating in ProSe Direct Discovery/E-UTRA mode. For discovery announce operation, UE test loop mode D provides trigger for transmission of ProSe Direct Discovery message on SL-DCH.
NOTE 3:	UE test loop mode D is intended for RF/RRM testing purposes.
NOTE 4:	ProSe Direct Discovery messages on the PC5 interface are delivered as one MAC SDU per ProSe Direct Discovery message.
UE test loop mode E provides means for either transmit or receive of ProSe Direct or V2X Communication packets, as specified by the test loop mode E setup IE in the CLOSE UE TEST LOOP message. In particular, for communication receive operation, UE test loop mode E provides counting of successfully received STCH PDCP SDUs, PSCCH PHY transport blocks and PSSCH PHY transport blocks while the UE is operating in ProSe Direct or V2X Communication/E-UTRA mode. For communication transmit operation, UE test loop mode E provides trigger for transmission of ProSe Direct or V2X Communication packets. For the V2X out-of-coverage scenarios this trigger utilises AT commands and requires an appropriate physical interface.
NOTE 5:	Void
NOTE 6:	The Application trigger required to force the UE to start or stop a particular ProSe Service is out of the scope of the test loop modes D and E.
UE test loop mode F provides counting of successfully received MBMS Packets on a given SC-MTCH while UE is operating in SC-PTM/E-UTRA mode. For SC-PTM one SC-MTCH is transmitted on a DL-SCH. MBMS packets for a SC-MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode G provides loopback of the User data container content of any received downlink ESM DATA TRANSPORT message in uplink. The received data can be configured to be either returned via the UE EMM entity (before the UE uplink rate control entity) or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode G may be configured to delay the uplink loopback of user data. UE test loop mode G may also be configured to repeat the received user data of the User data container in uplink to generate higher data rates in uplink.
UE test loop mode H provides loopback of the TP-User-Data field (including the SMS user data) of any received downlink TPDU (SMS-DELIVER) in uplink. The received data can be configured to be either returned via the UE SM-TL entity or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode H may be configured to delay the uplink loopback of SMS user data. UE test loop mode H may also be configured to repeat the received SMS user data in uplink to generate higher data rates in uplink.
NOTE 7:	UE test loop mode G and H are intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
NOTE 8:	The delay timer for UE test loop mode G and H is triggered by the first reception of user data after the reception of a CLOSE UE TEST LOOP TC message. While the delay timer is running only the user data received in the latest ESM DATA TRANSPORT or SMS message is buffered.
NOTE 9:	The repetition of uplink transmission of uplink messages carrying data can be configured as 0 (no data returned), 1 (the same content and size of user date as received in downlink is returned) or value N > 1 (user data corresponding to N times repetition of the received user data is returned in uplink).
UE test loop mode I provides loopback of the IP PDUs received in User data container content of downlink ESM DATA TRANSPORT message in uplink via the UE uplink TFT hander and the UE EMM entity (before the UE uplink rate control entity).
NOTE 10:	UE test loop mode I is intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
UE test loop mode A is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in E-UTRA mode is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in UTRA mode is mandatory to all E-UTRA UEs supporting UTRA radio access.
UE test loop mode B for operation in GSM/GPRS mode is mandatory to all E-UTRA UEs supporting GSM/GPRS radio access.
UE test loop mode B for operation in CDMA2000 mode is mandatory to all E-UTRA UEs supporting CDMA2000 radio access.
UE test loop mode C is mandatory for E-UTRA UEs supporting E-MBMS.
UE test loop mode D is mandatory for E-UTRA UEs supporting ProSe Direct Discovery.
UE test loop mode E is mandatory for E-UTRA UEs supporting ProSe Direct or V2X Communication.
UE test loop mode F is mandatory for E-UTRA UEs supporting SC-PTM.
UE test loop mode G is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
UE test loop mode H is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using SMS.
UE test loop mode I is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
Support of UPDATE UE LOCATION INFORMATION is optional for all E-UTRA UEs with the exception of E-UTRA UEs supporting ProSe Direct Communication for which it is mandatory.
For E-UTRA UE supporting multiple radio access technologies then UE reception of Test Control messages is limited to UE operating in E-UTRA mode, while continuation of loopback of user data is provided over the change to other UE supported radio access technologies.
UE test loop mode B for operation in UTRA, GSM/GPRS and CDMA2000 mode is only applicable for loopback of user data in PS domain.
The TC entity may be seen as a L3 or a NAS entity.
Figure 5.1-1 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode A. The loopback of PDCP SDUs for UE test loop mode A is specified in sub clause 5.4.3.
Figure 5.1-2 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode B. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in E-UTRA mode is specified in subclauses 5.4.4.2 and 5.4.4.3.
Figure 5.1-3 shows a functional block diagram of UE test loop function for UE test loop mode B and UE operating in UTRA mode. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in UTRA mode is specified in subclauses 5.4.4.4 and 5.4.4.5.
Figure 5.1-4 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in GSM/GPRS mode. The loopback of IP PDUs/SNDCP SDUs for UE test loop mode B and UE in GSM/GPRS mode is specified in subclauses 5.4.4.6 and 5.4.4.7.
Figure 5.1-5 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in CDMA2000 mode. The loopback of IP PDUs/RLP SDUs for UE test loop mode B and UE in CDMA2000 mode is specified in subclauses 5.4.4.8 and 5.4.4.9.
Figure 5.1-6 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode C. The MBMS Packet Counter function for UE test loop mode C is specified in sub clause 5.4.4.a. The MBMS Packet Counter function is limited to count successfully received MBMS packets on one MTCH configured by the SS when UE test loop mode C is activated.
Figure 5.1-7 and Figure 5.1-8 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode D. The ProSe Direct Discovery Packet Counter function for UE test loop mode D is specified in clause 5.4.4b. The ProSe Direct Discovery packet counter function is limited to count successfully received SL-DCH MAC SDUs when UE test loop mode D is activated.
Figure 5.1-9 and Figure 5.1-10 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting ProSe Direct, or, V2X when UE is in in-coverage state. Figure 5.1-9a and Figure 5.1-10a show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting V2X when UE is in out-of-coverage state; the Electrical Man Machine Interface (EMMI) required for facilitating the AT commands transmission is specified in clause 8. The ProSe Direct or V2X Communication Packet Counter function for UE test loop mode E is specified in clause 5.4.4c. The ProSe Direct or V2X Communication packet counter function is limited to count successfully received STCH PDCP SDUs, PSCCH PHY Transport blocks and PSSCH PHY Transport blocks when the UE test loop mode E is activated.
Figure 5.1-11 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode F. The SC-PTM Packet Counter function for UE test loop mode F is specified in sub clause 5.4.4.d. The SC-PTM Packet Counter function is limited to count successfully received MBMS packets on one SC-MTCH configured by the SS when UE test loop mode F is activated.
Figure 5.1-12 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink via the EMM entity. Figure 5.1-13 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode G mode of operation is specified in sub clause 5.4.4e.
Figure 5.1-14 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink via the SM-TL entity (in a TPDU (SMS-SUBMIT)).
Figure 5.1-15 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode H mode of operation is specified in sub clause 5.4.4f.
Figure 5.1-16 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode I when IP PDU received in User data container content in a downlink ESM DATA TRANSFER message is returned in uplink via the EMM entity. The UE test loop mode I mode of operation is specified in sub clause 5.4.4g.
NOTE 7:	ROHC functionality in PDCP Layer 2 is optional for UE implementations.
Figure 5.1-1: Model for Test Control and UE Test Loop Mode A on UE side for E-UTRA and NB-IoT
Figure 5.1-2: Model for Test Control and UE Test Loop Mode B on UE side for E-UTRA and NB-IoT
Figure 5.1-3: Model for UE Test Loop Mode B on UE side for UTRA
Figure 5.1-4: Model for UE Test Loop Mode B on UE side for GSM/GPRS
Figure 5.1-5: Model for UE Test Loop Mode B on UE side for CDMA2000
Figure 5.1-6: Model for UE test loop mode C on UE side
Figure 5.1-7: Model for UE test loop mode D on UE side
(when Discovery monitor is indicated in the UE test loop mode D setup IE)
Figure 5.1-8: Model for UE test loop mode D on UE side 
(when Discovery announce is indicated in the UE test loop mode D setup IE)
Figure 5.1-9: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-9a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-10: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-10a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-11: Model for UE test loop mode F on UE side
Figure 5.1-12: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the EMM entity (before the UE uplink rate control entity)
Figure 5.1-13: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-14: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SM-TL entity
Figure 5.1-15: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-16: Model for UE test loop mode I on UE side configured to return downlink IP PDUs received in a ESM DATA TRANSFER message in uplink via the UE UL TFT handler to the EMM entity (before the UE uplink rate control entity)",TS 36.509,5.1,all_images/image_1416.jpeg,Model for Test Control and UE Test Loop Mode A on UE side for E-UTRA and NB-IoT
"The UE test loop function provides access to isolated functions of the UE via the radio interface without introducing wherever possible new physical interfaces just for the reason of conformance testing.
NOTE 0:	One exception from the rule above is the UE test loop mode E and UTC time reset when used for V2X out-of-coverage test scenarios which require an additional physical interface for the transmission of AT commands. This has been based on the assumption that V2X devices will normally provide such interface for other than testing purposes e.g. for device configuration.
NOTE 1:	It should be emphasised that the UE test loop function only describes the functional behaviour of the UE with respect to its external interfaces; physical implementation of the UE test loop function is completely left open to the manufacturer.
The UE test loop function is activated by transmitting the appropriate TC message to the UE, see clause 6.
The UE test loop function can be operated in different loopback modes:
-	UE test loop mode A;
-	UE test loop mode B;
-	UE test loop mode C;
-	UE test loop mode D;
-	UE test loop mode E;
-	UE test loop mode F;
-	UE test loop mode G;
-	UE test loop mode H;
-	UE test loop mode I.
UE test loop mode A provides loopback of PDCP SDUs for bi-directional data radio bearers while UE is operating in E-UTRA or NB-IoT mode. The downlink PDCP SDUs received by the UE on each bi-directional data radio bearer are returned on the same radio bearer regardless of the PDCP SDU contents and of the TFT of the associated EPS bearer context [36].
UE test loop mode B provides loopback of PDCP SDUs (E-UTRA and UTRA), SNDCP PDUs (GSM/GPRS) and RLP PDUs (CDMA2000) for bi-directional EPS bearers while UE is operated in E-UTRA, NB-IoT, UTRA, GSM/GPRS or CDMA2000 modes. When operating in E-UTRA, NB-IoT, UTRA or GSM/GPRS then the downlink PDCP SDUs or SNDCP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer associated with an EPS bearer context with a TFT matching the TCP/UDP/IP protocol information within the PDCP SDU or SNDCP SDU [36]. When operating in CDMA2000 modes, the downlink RLP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer with the smallest identity, regardless of the RLP PDU content and of the TFT of the associated EPS bearer context.
NOTE 2:	When multiple PDN connections are established (or multiple Primary PDP Contexts are active), it is assumed that different IP addresses are allocated to the UE by the SS on each PDN.
UE test loop mode C provides counting of successfully received MBMS Packets on a given MTCH while UE is operating in E-MBMS/E-UTRA mode. For E-MBMS then one or more MTCHs are multiplexed on a MCH. MBMS packets for a MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode D provides means for announcing or monitoring of ProSe Direct Discovery messages on SL-DCH, as specified by the test loop mode D setup IE in the CLOSE UE TEST LOOP message. In particular, for discovery monitor operation, UE test loop mode D provides counting of successfully received SL-DCH MAC SDUs while the UE is operating in ProSe Direct Discovery/E-UTRA mode. For discovery announce operation, UE test loop mode D provides trigger for transmission of ProSe Direct Discovery message on SL-DCH.
NOTE 3:	UE test loop mode D is intended for RF/RRM testing purposes.
NOTE 4:	ProSe Direct Discovery messages on the PC5 interface are delivered as one MAC SDU per ProSe Direct Discovery message.
UE test loop mode E provides means for either transmit or receive of ProSe Direct or V2X Communication packets, as specified by the test loop mode E setup IE in the CLOSE UE TEST LOOP message. In particular, for communication receive operation, UE test loop mode E provides counting of successfully received STCH PDCP SDUs, PSCCH PHY transport blocks and PSSCH PHY transport blocks while the UE is operating in ProSe Direct or V2X Communication/E-UTRA mode. For communication transmit operation, UE test loop mode E provides trigger for transmission of ProSe Direct or V2X Communication packets. For the V2X out-of-coverage scenarios this trigger utilises AT commands and requires an appropriate physical interface.
NOTE 5:	Void
NOTE 6:	The Application trigger required to force the UE to start or stop a particular ProSe Service is out of the scope of the test loop modes D and E.
UE test loop mode F provides counting of successfully received MBMS Packets on a given SC-MTCH while UE is operating in SC-PTM/E-UTRA mode. For SC-PTM one SC-MTCH is transmitted on a DL-SCH. MBMS packets for a SC-MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode G provides loopback of the User data container content of any received downlink ESM DATA TRANSPORT message in uplink. The received data can be configured to be either returned via the UE EMM entity (before the UE uplink rate control entity) or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode G may be configured to delay the uplink loopback of user data. UE test loop mode G may also be configured to repeat the received user data of the User data container in uplink to generate higher data rates in uplink.
UE test loop mode H provides loopback of the TP-User-Data field (including the SMS user data) of any received downlink TPDU (SMS-DELIVER) in uplink. The received data can be configured to be either returned via the UE SM-TL entity or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode H may be configured to delay the uplink loopback of SMS user data. UE test loop mode H may also be configured to repeat the received SMS user data in uplink to generate higher data rates in uplink.
NOTE 7:	UE test loop mode G and H are intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
NOTE 8:	The delay timer for UE test loop mode G and H is triggered by the first reception of user data after the reception of a CLOSE UE TEST LOOP TC message. While the delay timer is running only the user data received in the latest ESM DATA TRANSPORT or SMS message is buffered.
NOTE 9:	The repetition of uplink transmission of uplink messages carrying data can be configured as 0 (no data returned), 1 (the same content and size of user date as received in downlink is returned) or value N > 1 (user data corresponding to N times repetition of the received user data is returned in uplink).
UE test loop mode I provides loopback of the IP PDUs received in User data container content of downlink ESM DATA TRANSPORT message in uplink via the UE uplink TFT hander and the UE EMM entity (before the UE uplink rate control entity).
NOTE 10:	UE test loop mode I is intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
UE test loop mode A is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in E-UTRA mode is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in UTRA mode is mandatory to all E-UTRA UEs supporting UTRA radio access.
UE test loop mode B for operation in GSM/GPRS mode is mandatory to all E-UTRA UEs supporting GSM/GPRS radio access.
UE test loop mode B for operation in CDMA2000 mode is mandatory to all E-UTRA UEs supporting CDMA2000 radio access.
UE test loop mode C is mandatory for E-UTRA UEs supporting E-MBMS.
UE test loop mode D is mandatory for E-UTRA UEs supporting ProSe Direct Discovery.
UE test loop mode E is mandatory for E-UTRA UEs supporting ProSe Direct or V2X Communication.
UE test loop mode F is mandatory for E-UTRA UEs supporting SC-PTM.
UE test loop mode G is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
UE test loop mode H is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using SMS.
UE test loop mode I is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
Support of UPDATE UE LOCATION INFORMATION is optional for all E-UTRA UEs with the exception of E-UTRA UEs supporting ProSe Direct Communication for which it is mandatory.
For E-UTRA UE supporting multiple radio access technologies then UE reception of Test Control messages is limited to UE operating in E-UTRA mode, while continuation of loopback of user data is provided over the change to other UE supported radio access technologies.
UE test loop mode B for operation in UTRA, GSM/GPRS and CDMA2000 mode is only applicable for loopback of user data in PS domain.
The TC entity may be seen as a L3 or a NAS entity.
Figure 5.1-1 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode A. The loopback of PDCP SDUs for UE test loop mode A is specified in sub clause 5.4.3.
Figure 5.1-2 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode B. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in E-UTRA mode is specified in subclauses 5.4.4.2 and 5.4.4.3.
Figure 5.1-3 shows a functional block diagram of UE test loop function for UE test loop mode B and UE operating in UTRA mode. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in UTRA mode is specified in subclauses 5.4.4.4 and 5.4.4.5.
Figure 5.1-4 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in GSM/GPRS mode. The loopback of IP PDUs/SNDCP SDUs for UE test loop mode B and UE in GSM/GPRS mode is specified in subclauses 5.4.4.6 and 5.4.4.7.
Figure 5.1-5 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in CDMA2000 mode. The loopback of IP PDUs/RLP SDUs for UE test loop mode B and UE in CDMA2000 mode is specified in subclauses 5.4.4.8 and 5.4.4.9.
Figure 5.1-6 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode C. The MBMS Packet Counter function for UE test loop mode C is specified in sub clause 5.4.4.a. The MBMS Packet Counter function is limited to count successfully received MBMS packets on one MTCH configured by the SS when UE test loop mode C is activated.
Figure 5.1-7 and Figure 5.1-8 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode D. The ProSe Direct Discovery Packet Counter function for UE test loop mode D is specified in clause 5.4.4b. The ProSe Direct Discovery packet counter function is limited to count successfully received SL-DCH MAC SDUs when UE test loop mode D is activated.
Figure 5.1-9 and Figure 5.1-10 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting ProSe Direct, or, V2X when UE is in in-coverage state. Figure 5.1-9a and Figure 5.1-10a show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting V2X when UE is in out-of-coverage state; the Electrical Man Machine Interface (EMMI) required for facilitating the AT commands transmission is specified in clause 8. The ProSe Direct or V2X Communication Packet Counter function for UE test loop mode E is specified in clause 5.4.4c. The ProSe Direct or V2X Communication packet counter function is limited to count successfully received STCH PDCP SDUs, PSCCH PHY Transport blocks and PSSCH PHY Transport blocks when the UE test loop mode E is activated.
Figure 5.1-11 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode F. The SC-PTM Packet Counter function for UE test loop mode F is specified in sub clause 5.4.4.d. The SC-PTM Packet Counter function is limited to count successfully received MBMS packets on one SC-MTCH configured by the SS when UE test loop mode F is activated.
Figure 5.1-12 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink via the EMM entity. Figure 5.1-13 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode G mode of operation is specified in sub clause 5.4.4e.
Figure 5.1-14 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink via the SM-TL entity (in a TPDU (SMS-SUBMIT)).
Figure 5.1-15 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode H mode of operation is specified in sub clause 5.4.4f.
Figure 5.1-16 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode I when IP PDU received in User data container content in a downlink ESM DATA TRANSFER message is returned in uplink via the EMM entity. The UE test loop mode I mode of operation is specified in sub clause 5.4.4g.
NOTE 7:	ROHC functionality in PDCP Layer 2 is optional for UE implementations.
Figure 5.1-1: Model for Test Control and UE Test Loop Mode A on UE side for E-UTRA and NB-IoT
Figure 5.1-2: Model for Test Control and UE Test Loop Mode B on UE side for E-UTRA and NB-IoT
Figure 5.1-3: Model for UE Test Loop Mode B on UE side for UTRA
Figure 5.1-4: Model for UE Test Loop Mode B on UE side for GSM/GPRS
Figure 5.1-5: Model for UE Test Loop Mode B on UE side for CDMA2000
Figure 5.1-6: Model for UE test loop mode C on UE side
Figure 5.1-7: Model for UE test loop mode D on UE side
(when Discovery monitor is indicated in the UE test loop mode D setup IE)
Figure 5.1-8: Model for UE test loop mode D on UE side 
(when Discovery announce is indicated in the UE test loop mode D setup IE)
Figure 5.1-9: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-9a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-10: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-10a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-11: Model for UE test loop mode F on UE side
Figure 5.1-12: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the EMM entity (before the UE uplink rate control entity)
Figure 5.1-13: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-14: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SM-TL entity
Figure 5.1-15: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-16: Model for UE test loop mode I on UE side configured to return downlink IP PDUs received in a ESM DATA TRANSFER message in uplink via the UE UL TFT handler to the EMM entity (before the UE uplink rate control entity)",TS 36.509,5.1,all_images/image_1417.jpeg,Model for Test Control and UE Test Loop Mode B on UE side for E-UTRA and NB-IoT
"The UE test loop function provides access to isolated functions of the UE via the radio interface without introducing wherever possible new physical interfaces just for the reason of conformance testing.
NOTE 0:	One exception from the rule above is the UE test loop mode E and UTC time reset when used for V2X out-of-coverage test scenarios which require an additional physical interface for the transmission of AT commands. This has been based on the assumption that V2X devices will normally provide such interface for other than testing purposes e.g. for device configuration.
NOTE 1:	It should be emphasised that the UE test loop function only describes the functional behaviour of the UE with respect to its external interfaces; physical implementation of the UE test loop function is completely left open to the manufacturer.
The UE test loop function is activated by transmitting the appropriate TC message to the UE, see clause 6.
The UE test loop function can be operated in different loopback modes:
-	UE test loop mode A;
-	UE test loop mode B;
-	UE test loop mode C;
-	UE test loop mode D;
-	UE test loop mode E;
-	UE test loop mode F;
-	UE test loop mode G;
-	UE test loop mode H;
-	UE test loop mode I.
UE test loop mode A provides loopback of PDCP SDUs for bi-directional data radio bearers while UE is operating in E-UTRA or NB-IoT mode. The downlink PDCP SDUs received by the UE on each bi-directional data radio bearer are returned on the same radio bearer regardless of the PDCP SDU contents and of the TFT of the associated EPS bearer context [36].
UE test loop mode B provides loopback of PDCP SDUs (E-UTRA and UTRA), SNDCP PDUs (GSM/GPRS) and RLP PDUs (CDMA2000) for bi-directional EPS bearers while UE is operated in E-UTRA, NB-IoT, UTRA, GSM/GPRS or CDMA2000 modes. When operating in E-UTRA, NB-IoT, UTRA or GSM/GPRS then the downlink PDCP SDUs or SNDCP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer associated with an EPS bearer context with a TFT matching the TCP/UDP/IP protocol information within the PDCP SDU or SNDCP SDU [36]. When operating in CDMA2000 modes, the downlink RLP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer with the smallest identity, regardless of the RLP PDU content and of the TFT of the associated EPS bearer context.
NOTE 2:	When multiple PDN connections are established (or multiple Primary PDP Contexts are active), it is assumed that different IP addresses are allocated to the UE by the SS on each PDN.
UE test loop mode C provides counting of successfully received MBMS Packets on a given MTCH while UE is operating in E-MBMS/E-UTRA mode. For E-MBMS then one or more MTCHs are multiplexed on a MCH. MBMS packets for a MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode D provides means for announcing or monitoring of ProSe Direct Discovery messages on SL-DCH, as specified by the test loop mode D setup IE in the CLOSE UE TEST LOOP message. In particular, for discovery monitor operation, UE test loop mode D provides counting of successfully received SL-DCH MAC SDUs while the UE is operating in ProSe Direct Discovery/E-UTRA mode. For discovery announce operation, UE test loop mode D provides trigger for transmission of ProSe Direct Discovery message on SL-DCH.
NOTE 3:	UE test loop mode D is intended for RF/RRM testing purposes.
NOTE 4:	ProSe Direct Discovery messages on the PC5 interface are delivered as one MAC SDU per ProSe Direct Discovery message.
UE test loop mode E provides means for either transmit or receive of ProSe Direct or V2X Communication packets, as specified by the test loop mode E setup IE in the CLOSE UE TEST LOOP message. In particular, for communication receive operation, UE test loop mode E provides counting of successfully received STCH PDCP SDUs, PSCCH PHY transport blocks and PSSCH PHY transport blocks while the UE is operating in ProSe Direct or V2X Communication/E-UTRA mode. For communication transmit operation, UE test loop mode E provides trigger for transmission of ProSe Direct or V2X Communication packets. For the V2X out-of-coverage scenarios this trigger utilises AT commands and requires an appropriate physical interface.
NOTE 5:	Void
NOTE 6:	The Application trigger required to force the UE to start or stop a particular ProSe Service is out of the scope of the test loop modes D and E.
UE test loop mode F provides counting of successfully received MBMS Packets on a given SC-MTCH while UE is operating in SC-PTM/E-UTRA mode. For SC-PTM one SC-MTCH is transmitted on a DL-SCH. MBMS packets for a SC-MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode G provides loopback of the User data container content of any received downlink ESM DATA TRANSPORT message in uplink. The received data can be configured to be either returned via the UE EMM entity (before the UE uplink rate control entity) or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode G may be configured to delay the uplink loopback of user data. UE test loop mode G may also be configured to repeat the received user data of the User data container in uplink to generate higher data rates in uplink.
UE test loop mode H provides loopback of the TP-User-Data field (including the SMS user data) of any received downlink TPDU (SMS-DELIVER) in uplink. The received data can be configured to be either returned via the UE SM-TL entity or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode H may be configured to delay the uplink loopback of SMS user data. UE test loop mode H may also be configured to repeat the received SMS user data in uplink to generate higher data rates in uplink.
NOTE 7:	UE test loop mode G and H are intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
NOTE 8:	The delay timer for UE test loop mode G and H is triggered by the first reception of user data after the reception of a CLOSE UE TEST LOOP TC message. While the delay timer is running only the user data received in the latest ESM DATA TRANSPORT or SMS message is buffered.
NOTE 9:	The repetition of uplink transmission of uplink messages carrying data can be configured as 0 (no data returned), 1 (the same content and size of user date as received in downlink is returned) or value N > 1 (user data corresponding to N times repetition of the received user data is returned in uplink).
UE test loop mode I provides loopback of the IP PDUs received in User data container content of downlink ESM DATA TRANSPORT message in uplink via the UE uplink TFT hander and the UE EMM entity (before the UE uplink rate control entity).
NOTE 10:	UE test loop mode I is intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
UE test loop mode A is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in E-UTRA mode is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in UTRA mode is mandatory to all E-UTRA UEs supporting UTRA radio access.
UE test loop mode B for operation in GSM/GPRS mode is mandatory to all E-UTRA UEs supporting GSM/GPRS radio access.
UE test loop mode B for operation in CDMA2000 mode is mandatory to all E-UTRA UEs supporting CDMA2000 radio access.
UE test loop mode C is mandatory for E-UTRA UEs supporting E-MBMS.
UE test loop mode D is mandatory for E-UTRA UEs supporting ProSe Direct Discovery.
UE test loop mode E is mandatory for E-UTRA UEs supporting ProSe Direct or V2X Communication.
UE test loop mode F is mandatory for E-UTRA UEs supporting SC-PTM.
UE test loop mode G is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
UE test loop mode H is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using SMS.
UE test loop mode I is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
Support of UPDATE UE LOCATION INFORMATION is optional for all E-UTRA UEs with the exception of E-UTRA UEs supporting ProSe Direct Communication for which it is mandatory.
For E-UTRA UE supporting multiple radio access technologies then UE reception of Test Control messages is limited to UE operating in E-UTRA mode, while continuation of loopback of user data is provided over the change to other UE supported radio access technologies.
UE test loop mode B for operation in UTRA, GSM/GPRS and CDMA2000 mode is only applicable for loopback of user data in PS domain.
The TC entity may be seen as a L3 or a NAS entity.
Figure 5.1-1 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode A. The loopback of PDCP SDUs for UE test loop mode A is specified in sub clause 5.4.3.
Figure 5.1-2 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode B. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in E-UTRA mode is specified in subclauses 5.4.4.2 and 5.4.4.3.
Figure 5.1-3 shows a functional block diagram of UE test loop function for UE test loop mode B and UE operating in UTRA mode. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in UTRA mode is specified in subclauses 5.4.4.4 and 5.4.4.5.
Figure 5.1-4 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in GSM/GPRS mode. The loopback of IP PDUs/SNDCP SDUs for UE test loop mode B and UE in GSM/GPRS mode is specified in subclauses 5.4.4.6 and 5.4.4.7.
Figure 5.1-5 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in CDMA2000 mode. The loopback of IP PDUs/RLP SDUs for UE test loop mode B and UE in CDMA2000 mode is specified in subclauses 5.4.4.8 and 5.4.4.9.
Figure 5.1-6 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode C. The MBMS Packet Counter function for UE test loop mode C is specified in sub clause 5.4.4.a. The MBMS Packet Counter function is limited to count successfully received MBMS packets on one MTCH configured by the SS when UE test loop mode C is activated.
Figure 5.1-7 and Figure 5.1-8 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode D. The ProSe Direct Discovery Packet Counter function for UE test loop mode D is specified in clause 5.4.4b. The ProSe Direct Discovery packet counter function is limited to count successfully received SL-DCH MAC SDUs when UE test loop mode D is activated.
Figure 5.1-9 and Figure 5.1-10 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting ProSe Direct, or, V2X when UE is in in-coverage state. Figure 5.1-9a and Figure 5.1-10a show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting V2X when UE is in out-of-coverage state; the Electrical Man Machine Interface (EMMI) required for facilitating the AT commands transmission is specified in clause 8. The ProSe Direct or V2X Communication Packet Counter function for UE test loop mode E is specified in clause 5.4.4c. The ProSe Direct or V2X Communication packet counter function is limited to count successfully received STCH PDCP SDUs, PSCCH PHY Transport blocks and PSSCH PHY Transport blocks when the UE test loop mode E is activated.
Figure 5.1-11 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode F. The SC-PTM Packet Counter function for UE test loop mode F is specified in sub clause 5.4.4.d. The SC-PTM Packet Counter function is limited to count successfully received MBMS packets on one SC-MTCH configured by the SS when UE test loop mode F is activated.
Figure 5.1-12 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink via the EMM entity. Figure 5.1-13 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode G mode of operation is specified in sub clause 5.4.4e.
Figure 5.1-14 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink via the SM-TL entity (in a TPDU (SMS-SUBMIT)).
Figure 5.1-15 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode H mode of operation is specified in sub clause 5.4.4f.
Figure 5.1-16 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode I when IP PDU received in User data container content in a downlink ESM DATA TRANSFER message is returned in uplink via the EMM entity. The UE test loop mode I mode of operation is specified in sub clause 5.4.4g.
NOTE 7:	ROHC functionality in PDCP Layer 2 is optional for UE implementations.
Figure 5.1-1: Model for Test Control and UE Test Loop Mode A on UE side for E-UTRA and NB-IoT
Figure 5.1-2: Model for Test Control and UE Test Loop Mode B on UE side for E-UTRA and NB-IoT
Figure 5.1-3: Model for UE Test Loop Mode B on UE side for UTRA
Figure 5.1-4: Model for UE Test Loop Mode B on UE side for GSM/GPRS
Figure 5.1-5: Model for UE Test Loop Mode B on UE side for CDMA2000
Figure 5.1-6: Model for UE test loop mode C on UE side
Figure 5.1-7: Model for UE test loop mode D on UE side
(when Discovery monitor is indicated in the UE test loop mode D setup IE)
Figure 5.1-8: Model for UE test loop mode D on UE side 
(when Discovery announce is indicated in the UE test loop mode D setup IE)
Figure 5.1-9: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-9a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-10: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-10a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-11: Model for UE test loop mode F on UE side
Figure 5.1-12: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the EMM entity (before the UE uplink rate control entity)
Figure 5.1-13: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-14: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SM-TL entity
Figure 5.1-15: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-16: Model for UE test loop mode I on UE side configured to return downlink IP PDUs received in a ESM DATA TRANSFER message in uplink via the UE UL TFT handler to the EMM entity (before the UE uplink rate control entity)",TS 36.509,5.1,all_images/image_1418.png,Model for UE Test Loop Mode B on UE side for GSM/GPRS
"The UE test loop function provides access to isolated functions of the UE via the radio interface without introducing wherever possible new physical interfaces just for the reason of conformance testing.
NOTE 0:	One exception from the rule above is the UE test loop mode E and UTC time reset when used for V2X out-of-coverage test scenarios which require an additional physical interface for the transmission of AT commands. This has been based on the assumption that V2X devices will normally provide such interface for other than testing purposes e.g. for device configuration.
NOTE 1:	It should be emphasised that the UE test loop function only describes the functional behaviour of the UE with respect to its external interfaces; physical implementation of the UE test loop function is completely left open to the manufacturer.
The UE test loop function is activated by transmitting the appropriate TC message to the UE, see clause 6.
The UE test loop function can be operated in different loopback modes:
-	UE test loop mode A;
-	UE test loop mode B;
-	UE test loop mode C;
-	UE test loop mode D;
-	UE test loop mode E;
-	UE test loop mode F;
-	UE test loop mode G;
-	UE test loop mode H;
-	UE test loop mode I.
UE test loop mode A provides loopback of PDCP SDUs for bi-directional data radio bearers while UE is operating in E-UTRA or NB-IoT mode. The downlink PDCP SDUs received by the UE on each bi-directional data radio bearer are returned on the same radio bearer regardless of the PDCP SDU contents and of the TFT of the associated EPS bearer context [36].
UE test loop mode B provides loopback of PDCP SDUs (E-UTRA and UTRA), SNDCP PDUs (GSM/GPRS) and RLP PDUs (CDMA2000) for bi-directional EPS bearers while UE is operated in E-UTRA, NB-IoT, UTRA, GSM/GPRS or CDMA2000 modes. When operating in E-UTRA, NB-IoT, UTRA or GSM/GPRS then the downlink PDCP SDUs or SNDCP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer associated with an EPS bearer context with a TFT matching the TCP/UDP/IP protocol information within the PDCP SDU or SNDCP SDU [36]. When operating in CDMA2000 modes, the downlink RLP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer with the smallest identity, regardless of the RLP PDU content and of the TFT of the associated EPS bearer context.
NOTE 2:	When multiple PDN connections are established (or multiple Primary PDP Contexts are active), it is assumed that different IP addresses are allocated to the UE by the SS on each PDN.
UE test loop mode C provides counting of successfully received MBMS Packets on a given MTCH while UE is operating in E-MBMS/E-UTRA mode. For E-MBMS then one or more MTCHs are multiplexed on a MCH. MBMS packets for a MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode D provides means for announcing or monitoring of ProSe Direct Discovery messages on SL-DCH, as specified by the test loop mode D setup IE in the CLOSE UE TEST LOOP message. In particular, for discovery monitor operation, UE test loop mode D provides counting of successfully received SL-DCH MAC SDUs while the UE is operating in ProSe Direct Discovery/E-UTRA mode. For discovery announce operation, UE test loop mode D provides trigger for transmission of ProSe Direct Discovery message on SL-DCH.
NOTE 3:	UE test loop mode D is intended for RF/RRM testing purposes.
NOTE 4:	ProSe Direct Discovery messages on the PC5 interface are delivered as one MAC SDU per ProSe Direct Discovery message.
UE test loop mode E provides means for either transmit or receive of ProSe Direct or V2X Communication packets, as specified by the test loop mode E setup IE in the CLOSE UE TEST LOOP message. In particular, for communication receive operation, UE test loop mode E provides counting of successfully received STCH PDCP SDUs, PSCCH PHY transport blocks and PSSCH PHY transport blocks while the UE is operating in ProSe Direct or V2X Communication/E-UTRA mode. For communication transmit operation, UE test loop mode E provides trigger for transmission of ProSe Direct or V2X Communication packets. For the V2X out-of-coverage scenarios this trigger utilises AT commands and requires an appropriate physical interface.
NOTE 5:	Void
NOTE 6:	The Application trigger required to force the UE to start or stop a particular ProSe Service is out of the scope of the test loop modes D and E.
UE test loop mode F provides counting of successfully received MBMS Packets on a given SC-MTCH while UE is operating in SC-PTM/E-UTRA mode. For SC-PTM one SC-MTCH is transmitted on a DL-SCH. MBMS packets for a SC-MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode G provides loopback of the User data container content of any received downlink ESM DATA TRANSPORT message in uplink. The received data can be configured to be either returned via the UE EMM entity (before the UE uplink rate control entity) or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode G may be configured to delay the uplink loopback of user data. UE test loop mode G may also be configured to repeat the received user data of the User data container in uplink to generate higher data rates in uplink.
UE test loop mode H provides loopback of the TP-User-Data field (including the SMS user data) of any received downlink TPDU (SMS-DELIVER) in uplink. The received data can be configured to be either returned via the UE SM-TL entity or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode H may be configured to delay the uplink loopback of SMS user data. UE test loop mode H may also be configured to repeat the received SMS user data in uplink to generate higher data rates in uplink.
NOTE 7:	UE test loop mode G and H are intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
NOTE 8:	The delay timer for UE test loop mode G and H is triggered by the first reception of user data after the reception of a CLOSE UE TEST LOOP TC message. While the delay timer is running only the user data received in the latest ESM DATA TRANSPORT or SMS message is buffered.
NOTE 9:	The repetition of uplink transmission of uplink messages carrying data can be configured as 0 (no data returned), 1 (the same content and size of user date as received in downlink is returned) or value N > 1 (user data corresponding to N times repetition of the received user data is returned in uplink).
UE test loop mode I provides loopback of the IP PDUs received in User data container content of downlink ESM DATA TRANSPORT message in uplink via the UE uplink TFT hander and the UE EMM entity (before the UE uplink rate control entity).
NOTE 10:	UE test loop mode I is intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
UE test loop mode A is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in E-UTRA mode is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in UTRA mode is mandatory to all E-UTRA UEs supporting UTRA radio access.
UE test loop mode B for operation in GSM/GPRS mode is mandatory to all E-UTRA UEs supporting GSM/GPRS radio access.
UE test loop mode B for operation in CDMA2000 mode is mandatory to all E-UTRA UEs supporting CDMA2000 radio access.
UE test loop mode C is mandatory for E-UTRA UEs supporting E-MBMS.
UE test loop mode D is mandatory for E-UTRA UEs supporting ProSe Direct Discovery.
UE test loop mode E is mandatory for E-UTRA UEs supporting ProSe Direct or V2X Communication.
UE test loop mode F is mandatory for E-UTRA UEs supporting SC-PTM.
UE test loop mode G is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
UE test loop mode H is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using SMS.
UE test loop mode I is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
Support of UPDATE UE LOCATION INFORMATION is optional for all E-UTRA UEs with the exception of E-UTRA UEs supporting ProSe Direct Communication for which it is mandatory.
For E-UTRA UE supporting multiple radio access technologies then UE reception of Test Control messages is limited to UE operating in E-UTRA mode, while continuation of loopback of user data is provided over the change to other UE supported radio access technologies.
UE test loop mode B for operation in UTRA, GSM/GPRS and CDMA2000 mode is only applicable for loopback of user data in PS domain.
The TC entity may be seen as a L3 or a NAS entity.
Figure 5.1-1 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode A. The loopback of PDCP SDUs for UE test loop mode A is specified in sub clause 5.4.3.
Figure 5.1-2 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode B. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in E-UTRA mode is specified in subclauses 5.4.4.2 and 5.4.4.3.
Figure 5.1-3 shows a functional block diagram of UE test loop function for UE test loop mode B and UE operating in UTRA mode. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in UTRA mode is specified in subclauses 5.4.4.4 and 5.4.4.5.
Figure 5.1-4 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in GSM/GPRS mode. The loopback of IP PDUs/SNDCP SDUs for UE test loop mode B and UE in GSM/GPRS mode is specified in subclauses 5.4.4.6 and 5.4.4.7.
Figure 5.1-5 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in CDMA2000 mode. The loopback of IP PDUs/RLP SDUs for UE test loop mode B and UE in CDMA2000 mode is specified in subclauses 5.4.4.8 and 5.4.4.9.
Figure 5.1-6 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode C. The MBMS Packet Counter function for UE test loop mode C is specified in sub clause 5.4.4.a. The MBMS Packet Counter function is limited to count successfully received MBMS packets on one MTCH configured by the SS when UE test loop mode C is activated.
Figure 5.1-7 and Figure 5.1-8 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode D. The ProSe Direct Discovery Packet Counter function for UE test loop mode D is specified in clause 5.4.4b. The ProSe Direct Discovery packet counter function is limited to count successfully received SL-DCH MAC SDUs when UE test loop mode D is activated.
Figure 5.1-9 and Figure 5.1-10 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting ProSe Direct, or, V2X when UE is in in-coverage state. Figure 5.1-9a and Figure 5.1-10a show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting V2X when UE is in out-of-coverage state; the Electrical Man Machine Interface (EMMI) required for facilitating the AT commands transmission is specified in clause 8. The ProSe Direct or V2X Communication Packet Counter function for UE test loop mode E is specified in clause 5.4.4c. The ProSe Direct or V2X Communication packet counter function is limited to count successfully received STCH PDCP SDUs, PSCCH PHY Transport blocks and PSSCH PHY Transport blocks when the UE test loop mode E is activated.
Figure 5.1-11 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode F. The SC-PTM Packet Counter function for UE test loop mode F is specified in sub clause 5.4.4.d. The SC-PTM Packet Counter function is limited to count successfully received MBMS packets on one SC-MTCH configured by the SS when UE test loop mode F is activated.
Figure 5.1-12 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink via the EMM entity. Figure 5.1-13 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode G mode of operation is specified in sub clause 5.4.4e.
Figure 5.1-14 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink via the SM-TL entity (in a TPDU (SMS-SUBMIT)).
Figure 5.1-15 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode H mode of operation is specified in sub clause 5.4.4f.
Figure 5.1-16 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode I when IP PDU received in User data container content in a downlink ESM DATA TRANSFER message is returned in uplink via the EMM entity. The UE test loop mode I mode of operation is specified in sub clause 5.4.4g.
NOTE 7:	ROHC functionality in PDCP Layer 2 is optional for UE implementations.
Figure 5.1-1: Model for Test Control and UE Test Loop Mode A on UE side for E-UTRA and NB-IoT
Figure 5.1-2: Model for Test Control and UE Test Loop Mode B on UE side for E-UTRA and NB-IoT
Figure 5.1-3: Model for UE Test Loop Mode B on UE side for UTRA
Figure 5.1-4: Model for UE Test Loop Mode B on UE side for GSM/GPRS
Figure 5.1-5: Model for UE Test Loop Mode B on UE side for CDMA2000
Figure 5.1-6: Model for UE test loop mode C on UE side
Figure 5.1-7: Model for UE test loop mode D on UE side
(when Discovery monitor is indicated in the UE test loop mode D setup IE)
Figure 5.1-8: Model for UE test loop mode D on UE side 
(when Discovery announce is indicated in the UE test loop mode D setup IE)
Figure 5.1-9: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-9a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-10: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-10a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-11: Model for UE test loop mode F on UE side
Figure 5.1-12: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the EMM entity (before the UE uplink rate control entity)
Figure 5.1-13: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-14: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SM-TL entity
Figure 5.1-15: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-16: Model for UE test loop mode I on UE side configured to return downlink IP PDUs received in a ESM DATA TRANSFER message in uplink via the UE UL TFT handler to the EMM entity (before the UE uplink rate control entity)",TS 36.509,5.1,all_images/image_1419.jpeg,Model for UE Test Loop Mode B on UE side for CDMA2000
"The UE test loop function provides access to isolated functions of the UE via the radio interface without introducing wherever possible new physical interfaces just for the reason of conformance testing.
NOTE 0:	One exception from the rule above is the UE test loop mode E and UTC time reset when used for V2X out-of-coverage test scenarios which require an additional physical interface for the transmission of AT commands. This has been based on the assumption that V2X devices will normally provide such interface for other than testing purposes e.g. for device configuration.
NOTE 1:	It should be emphasised that the UE test loop function only describes the functional behaviour of the UE with respect to its external interfaces; physical implementation of the UE test loop function is completely left open to the manufacturer.
The UE test loop function is activated by transmitting the appropriate TC message to the UE, see clause 6.
The UE test loop function can be operated in different loopback modes:
-	UE test loop mode A;
-	UE test loop mode B;
-	UE test loop mode C;
-	UE test loop mode D;
-	UE test loop mode E;
-	UE test loop mode F;
-	UE test loop mode G;
-	UE test loop mode H;
-	UE test loop mode I.
UE test loop mode A provides loopback of PDCP SDUs for bi-directional data radio bearers while UE is operating in E-UTRA or NB-IoT mode. The downlink PDCP SDUs received by the UE on each bi-directional data radio bearer are returned on the same radio bearer regardless of the PDCP SDU contents and of the TFT of the associated EPS bearer context [36].
UE test loop mode B provides loopback of PDCP SDUs (E-UTRA and UTRA), SNDCP PDUs (GSM/GPRS) and RLP PDUs (CDMA2000) for bi-directional EPS bearers while UE is operated in E-UTRA, NB-IoT, UTRA, GSM/GPRS or CDMA2000 modes. When operating in E-UTRA, NB-IoT, UTRA or GSM/GPRS then the downlink PDCP SDUs or SNDCP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer associated with an EPS bearer context with a TFT matching the TCP/UDP/IP protocol information within the PDCP SDU or SNDCP SDU [36]. When operating in CDMA2000 modes, the downlink RLP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer with the smallest identity, regardless of the RLP PDU content and of the TFT of the associated EPS bearer context.
NOTE 2:	When multiple PDN connections are established (or multiple Primary PDP Contexts are active), it is assumed that different IP addresses are allocated to the UE by the SS on each PDN.
UE test loop mode C provides counting of successfully received MBMS Packets on a given MTCH while UE is operating in E-MBMS/E-UTRA mode. For E-MBMS then one or more MTCHs are multiplexed on a MCH. MBMS packets for a MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode D provides means for announcing or monitoring of ProSe Direct Discovery messages on SL-DCH, as specified by the test loop mode D setup IE in the CLOSE UE TEST LOOP message. In particular, for discovery monitor operation, UE test loop mode D provides counting of successfully received SL-DCH MAC SDUs while the UE is operating in ProSe Direct Discovery/E-UTRA mode. For discovery announce operation, UE test loop mode D provides trigger for transmission of ProSe Direct Discovery message on SL-DCH.
NOTE 3:	UE test loop mode D is intended for RF/RRM testing purposes.
NOTE 4:	ProSe Direct Discovery messages on the PC5 interface are delivered as one MAC SDU per ProSe Direct Discovery message.
UE test loop mode E provides means for either transmit or receive of ProSe Direct or V2X Communication packets, as specified by the test loop mode E setup IE in the CLOSE UE TEST LOOP message. In particular, for communication receive operation, UE test loop mode E provides counting of successfully received STCH PDCP SDUs, PSCCH PHY transport blocks and PSSCH PHY transport blocks while the UE is operating in ProSe Direct or V2X Communication/E-UTRA mode. For communication transmit operation, UE test loop mode E provides trigger for transmission of ProSe Direct or V2X Communication packets. For the V2X out-of-coverage scenarios this trigger utilises AT commands and requires an appropriate physical interface.
NOTE 5:	Void
NOTE 6:	The Application trigger required to force the UE to start or stop a particular ProSe Service is out of the scope of the test loop modes D and E.
UE test loop mode F provides counting of successfully received MBMS Packets on a given SC-MTCH while UE is operating in SC-PTM/E-UTRA mode. For SC-PTM one SC-MTCH is transmitted on a DL-SCH. MBMS packets for a SC-MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode G provides loopback of the User data container content of any received downlink ESM DATA TRANSPORT message in uplink. The received data can be configured to be either returned via the UE EMM entity (before the UE uplink rate control entity) or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode G may be configured to delay the uplink loopback of user data. UE test loop mode G may also be configured to repeat the received user data of the User data container in uplink to generate higher data rates in uplink.
UE test loop mode H provides loopback of the TP-User-Data field (including the SMS user data) of any received downlink TPDU (SMS-DELIVER) in uplink. The received data can be configured to be either returned via the UE SM-TL entity or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode H may be configured to delay the uplink loopback of SMS user data. UE test loop mode H may also be configured to repeat the received SMS user data in uplink to generate higher data rates in uplink.
NOTE 7:	UE test loop mode G and H are intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
NOTE 8:	The delay timer for UE test loop mode G and H is triggered by the first reception of user data after the reception of a CLOSE UE TEST LOOP TC message. While the delay timer is running only the user data received in the latest ESM DATA TRANSPORT or SMS message is buffered.
NOTE 9:	The repetition of uplink transmission of uplink messages carrying data can be configured as 0 (no data returned), 1 (the same content and size of user date as received in downlink is returned) or value N > 1 (user data corresponding to N times repetition of the received user data is returned in uplink).
UE test loop mode I provides loopback of the IP PDUs received in User data container content of downlink ESM DATA TRANSPORT message in uplink via the UE uplink TFT hander and the UE EMM entity (before the UE uplink rate control entity).
NOTE 10:	UE test loop mode I is intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
UE test loop mode A is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in E-UTRA mode is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in UTRA mode is mandatory to all E-UTRA UEs supporting UTRA radio access.
UE test loop mode B for operation in GSM/GPRS mode is mandatory to all E-UTRA UEs supporting GSM/GPRS radio access.
UE test loop mode B for operation in CDMA2000 mode is mandatory to all E-UTRA UEs supporting CDMA2000 radio access.
UE test loop mode C is mandatory for E-UTRA UEs supporting E-MBMS.
UE test loop mode D is mandatory for E-UTRA UEs supporting ProSe Direct Discovery.
UE test loop mode E is mandatory for E-UTRA UEs supporting ProSe Direct or V2X Communication.
UE test loop mode F is mandatory for E-UTRA UEs supporting SC-PTM.
UE test loop mode G is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
UE test loop mode H is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using SMS.
UE test loop mode I is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
Support of UPDATE UE LOCATION INFORMATION is optional for all E-UTRA UEs with the exception of E-UTRA UEs supporting ProSe Direct Communication for which it is mandatory.
For E-UTRA UE supporting multiple radio access technologies then UE reception of Test Control messages is limited to UE operating in E-UTRA mode, while continuation of loopback of user data is provided over the change to other UE supported radio access technologies.
UE test loop mode B for operation in UTRA, GSM/GPRS and CDMA2000 mode is only applicable for loopback of user data in PS domain.
The TC entity may be seen as a L3 or a NAS entity.
Figure 5.1-1 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode A. The loopback of PDCP SDUs for UE test loop mode A is specified in sub clause 5.4.3.
Figure 5.1-2 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode B. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in E-UTRA mode is specified in subclauses 5.4.4.2 and 5.4.4.3.
Figure 5.1-3 shows a functional block diagram of UE test loop function for UE test loop mode B and UE operating in UTRA mode. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in UTRA mode is specified in subclauses 5.4.4.4 and 5.4.4.5.
Figure 5.1-4 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in GSM/GPRS mode. The loopback of IP PDUs/SNDCP SDUs for UE test loop mode B and UE in GSM/GPRS mode is specified in subclauses 5.4.4.6 and 5.4.4.7.
Figure 5.1-5 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in CDMA2000 mode. The loopback of IP PDUs/RLP SDUs for UE test loop mode B and UE in CDMA2000 mode is specified in subclauses 5.4.4.8 and 5.4.4.9.
Figure 5.1-6 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode C. The MBMS Packet Counter function for UE test loop mode C is specified in sub clause 5.4.4.a. The MBMS Packet Counter function is limited to count successfully received MBMS packets on one MTCH configured by the SS when UE test loop mode C is activated.
Figure 5.1-7 and Figure 5.1-8 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode D. The ProSe Direct Discovery Packet Counter function for UE test loop mode D is specified in clause 5.4.4b. The ProSe Direct Discovery packet counter function is limited to count successfully received SL-DCH MAC SDUs when UE test loop mode D is activated.
Figure 5.1-9 and Figure 5.1-10 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting ProSe Direct, or, V2X when UE is in in-coverage state. Figure 5.1-9a and Figure 5.1-10a show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting V2X when UE is in out-of-coverage state; the Electrical Man Machine Interface (EMMI) required for facilitating the AT commands transmission is specified in clause 8. The ProSe Direct or V2X Communication Packet Counter function for UE test loop mode E is specified in clause 5.4.4c. The ProSe Direct or V2X Communication packet counter function is limited to count successfully received STCH PDCP SDUs, PSCCH PHY Transport blocks and PSSCH PHY Transport blocks when the UE test loop mode E is activated.
Figure 5.1-11 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode F. The SC-PTM Packet Counter function for UE test loop mode F is specified in sub clause 5.4.4.d. The SC-PTM Packet Counter function is limited to count successfully received MBMS packets on one SC-MTCH configured by the SS when UE test loop mode F is activated.
Figure 5.1-12 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink via the EMM entity. Figure 5.1-13 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode G mode of operation is specified in sub clause 5.4.4e.
Figure 5.1-14 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink via the SM-TL entity (in a TPDU (SMS-SUBMIT)).
Figure 5.1-15 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode H mode of operation is specified in sub clause 5.4.4f.
Figure 5.1-16 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode I when IP PDU received in User data container content in a downlink ESM DATA TRANSFER message is returned in uplink via the EMM entity. The UE test loop mode I mode of operation is specified in sub clause 5.4.4g.
NOTE 7:	ROHC functionality in PDCP Layer 2 is optional for UE implementations.
Figure 5.1-1: Model for Test Control and UE Test Loop Mode A on UE side for E-UTRA and NB-IoT
Figure 5.1-2: Model for Test Control and UE Test Loop Mode B on UE side for E-UTRA and NB-IoT
Figure 5.1-3: Model for UE Test Loop Mode B on UE side for UTRA
Figure 5.1-4: Model for UE Test Loop Mode B on UE side for GSM/GPRS
Figure 5.1-5: Model for UE Test Loop Mode B on UE side for CDMA2000
Figure 5.1-6: Model for UE test loop mode C on UE side
Figure 5.1-7: Model for UE test loop mode D on UE side
(when Discovery monitor is indicated in the UE test loop mode D setup IE)
Figure 5.1-8: Model for UE test loop mode D on UE side 
(when Discovery announce is indicated in the UE test loop mode D setup IE)
Figure 5.1-9: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-9a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-10: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-10a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-11: Model for UE test loop mode F on UE side
Figure 5.1-12: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the EMM entity (before the UE uplink rate control entity)
Figure 5.1-13: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-14: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SM-TL entity
Figure 5.1-15: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-16: Model for UE test loop mode I on UE side configured to return downlink IP PDUs received in a ESM DATA TRANSFER message in uplink via the UE UL TFT handler to the EMM entity (before the UE uplink rate control entity)",TS 36.509,5.1,all_images/image_1420.jpeg,Model for UE test loop mode C on UE side
"The UE test loop function provides access to isolated functions of the UE via the radio interface without introducing wherever possible new physical interfaces just for the reason of conformance testing.
NOTE 0:	One exception from the rule above is the UE test loop mode E and UTC time reset when used for V2X out-of-coverage test scenarios which require an additional physical interface for the transmission of AT commands. This has been based on the assumption that V2X devices will normally provide such interface for other than testing purposes e.g. for device configuration.
NOTE 1:	It should be emphasised that the UE test loop function only describes the functional behaviour of the UE with respect to its external interfaces; physical implementation of the UE test loop function is completely left open to the manufacturer.
The UE test loop function is activated by transmitting the appropriate TC message to the UE, see clause 6.
The UE test loop function can be operated in different loopback modes:
-	UE test loop mode A;
-	UE test loop mode B;
-	UE test loop mode C;
-	UE test loop mode D;
-	UE test loop mode E;
-	UE test loop mode F;
-	UE test loop mode G;
-	UE test loop mode H;
-	UE test loop mode I.
UE test loop mode A provides loopback of PDCP SDUs for bi-directional data radio bearers while UE is operating in E-UTRA or NB-IoT mode. The downlink PDCP SDUs received by the UE on each bi-directional data radio bearer are returned on the same radio bearer regardless of the PDCP SDU contents and of the TFT of the associated EPS bearer context [36].
UE test loop mode B provides loopback of PDCP SDUs (E-UTRA and UTRA), SNDCP PDUs (GSM/GPRS) and RLP PDUs (CDMA2000) for bi-directional EPS bearers while UE is operated in E-UTRA, NB-IoT, UTRA, GSM/GPRS or CDMA2000 modes. When operating in E-UTRA, NB-IoT, UTRA or GSM/GPRS then the downlink PDCP SDUs or SNDCP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer associated with an EPS bearer context with a TFT matching the TCP/UDP/IP protocol information within the PDCP SDU or SNDCP SDU [36]. When operating in CDMA2000 modes, the downlink RLP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer with the smallest identity, regardless of the RLP PDU content and of the TFT of the associated EPS bearer context.
NOTE 2:	When multiple PDN connections are established (or multiple Primary PDP Contexts are active), it is assumed that different IP addresses are allocated to the UE by the SS on each PDN.
UE test loop mode C provides counting of successfully received MBMS Packets on a given MTCH while UE is operating in E-MBMS/E-UTRA mode. For E-MBMS then one or more MTCHs are multiplexed on a MCH. MBMS packets for a MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode D provides means for announcing or monitoring of ProSe Direct Discovery messages on SL-DCH, as specified by the test loop mode D setup IE in the CLOSE UE TEST LOOP message. In particular, for discovery monitor operation, UE test loop mode D provides counting of successfully received SL-DCH MAC SDUs while the UE is operating in ProSe Direct Discovery/E-UTRA mode. For discovery announce operation, UE test loop mode D provides trigger for transmission of ProSe Direct Discovery message on SL-DCH.
NOTE 3:	UE test loop mode D is intended for RF/RRM testing purposes.
NOTE 4:	ProSe Direct Discovery messages on the PC5 interface are delivered as one MAC SDU per ProSe Direct Discovery message.
UE test loop mode E provides means for either transmit or receive of ProSe Direct or V2X Communication packets, as specified by the test loop mode E setup IE in the CLOSE UE TEST LOOP message. In particular, for communication receive operation, UE test loop mode E provides counting of successfully received STCH PDCP SDUs, PSCCH PHY transport blocks and PSSCH PHY transport blocks while the UE is operating in ProSe Direct or V2X Communication/E-UTRA mode. For communication transmit operation, UE test loop mode E provides trigger for transmission of ProSe Direct or V2X Communication packets. For the V2X out-of-coverage scenarios this trigger utilises AT commands and requires an appropriate physical interface.
NOTE 5:	Void
NOTE 6:	The Application trigger required to force the UE to start or stop a particular ProSe Service is out of the scope of the test loop modes D and E.
UE test loop mode F provides counting of successfully received MBMS Packets on a given SC-MTCH while UE is operating in SC-PTM/E-UTRA mode. For SC-PTM one SC-MTCH is transmitted on a DL-SCH. MBMS packets for a SC-MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode G provides loopback of the User data container content of any received downlink ESM DATA TRANSPORT message in uplink. The received data can be configured to be either returned via the UE EMM entity (before the UE uplink rate control entity) or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode G may be configured to delay the uplink loopback of user data. UE test loop mode G may also be configured to repeat the received user data of the User data container in uplink to generate higher data rates in uplink.
UE test loop mode H provides loopback of the TP-User-Data field (including the SMS user data) of any received downlink TPDU (SMS-DELIVER) in uplink. The received data can be configured to be either returned via the UE SM-TL entity or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode H may be configured to delay the uplink loopback of SMS user data. UE test loop mode H may also be configured to repeat the received SMS user data in uplink to generate higher data rates in uplink.
NOTE 7:	UE test loop mode G and H are intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
NOTE 8:	The delay timer for UE test loop mode G and H is triggered by the first reception of user data after the reception of a CLOSE UE TEST LOOP TC message. While the delay timer is running only the user data received in the latest ESM DATA TRANSPORT or SMS message is buffered.
NOTE 9:	The repetition of uplink transmission of uplink messages carrying data can be configured as 0 (no data returned), 1 (the same content and size of user date as received in downlink is returned) or value N > 1 (user data corresponding to N times repetition of the received user data is returned in uplink).
UE test loop mode I provides loopback of the IP PDUs received in User data container content of downlink ESM DATA TRANSPORT message in uplink via the UE uplink TFT hander and the UE EMM entity (before the UE uplink rate control entity).
NOTE 10:	UE test loop mode I is intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
UE test loop mode A is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in E-UTRA mode is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in UTRA mode is mandatory to all E-UTRA UEs supporting UTRA radio access.
UE test loop mode B for operation in GSM/GPRS mode is mandatory to all E-UTRA UEs supporting GSM/GPRS radio access.
UE test loop mode B for operation in CDMA2000 mode is mandatory to all E-UTRA UEs supporting CDMA2000 radio access.
UE test loop mode C is mandatory for E-UTRA UEs supporting E-MBMS.
UE test loop mode D is mandatory for E-UTRA UEs supporting ProSe Direct Discovery.
UE test loop mode E is mandatory for E-UTRA UEs supporting ProSe Direct or V2X Communication.
UE test loop mode F is mandatory for E-UTRA UEs supporting SC-PTM.
UE test loop mode G is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
UE test loop mode H is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using SMS.
UE test loop mode I is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
Support of UPDATE UE LOCATION INFORMATION is optional for all E-UTRA UEs with the exception of E-UTRA UEs supporting ProSe Direct Communication for which it is mandatory.
For E-UTRA UE supporting multiple radio access technologies then UE reception of Test Control messages is limited to UE operating in E-UTRA mode, while continuation of loopback of user data is provided over the change to other UE supported radio access technologies.
UE test loop mode B for operation in UTRA, GSM/GPRS and CDMA2000 mode is only applicable for loopback of user data in PS domain.
The TC entity may be seen as a L3 or a NAS entity.
Figure 5.1-1 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode A. The loopback of PDCP SDUs for UE test loop mode A is specified in sub clause 5.4.3.
Figure 5.1-2 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode B. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in E-UTRA mode is specified in subclauses 5.4.4.2 and 5.4.4.3.
Figure 5.1-3 shows a functional block diagram of UE test loop function for UE test loop mode B and UE operating in UTRA mode. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in UTRA mode is specified in subclauses 5.4.4.4 and 5.4.4.5.
Figure 5.1-4 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in GSM/GPRS mode. The loopback of IP PDUs/SNDCP SDUs for UE test loop mode B and UE in GSM/GPRS mode is specified in subclauses 5.4.4.6 and 5.4.4.7.
Figure 5.1-5 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in CDMA2000 mode. The loopback of IP PDUs/RLP SDUs for UE test loop mode B and UE in CDMA2000 mode is specified in subclauses 5.4.4.8 and 5.4.4.9.
Figure 5.1-6 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode C. The MBMS Packet Counter function for UE test loop mode C is specified in sub clause 5.4.4.a. The MBMS Packet Counter function is limited to count successfully received MBMS packets on one MTCH configured by the SS when UE test loop mode C is activated.
Figure 5.1-7 and Figure 5.1-8 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode D. The ProSe Direct Discovery Packet Counter function for UE test loop mode D is specified in clause 5.4.4b. The ProSe Direct Discovery packet counter function is limited to count successfully received SL-DCH MAC SDUs when UE test loop mode D is activated.
Figure 5.1-9 and Figure 5.1-10 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting ProSe Direct, or, V2X when UE is in in-coverage state. Figure 5.1-9a and Figure 5.1-10a show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting V2X when UE is in out-of-coverage state; the Electrical Man Machine Interface (EMMI) required for facilitating the AT commands transmission is specified in clause 8. The ProSe Direct or V2X Communication Packet Counter function for UE test loop mode E is specified in clause 5.4.4c. The ProSe Direct or V2X Communication packet counter function is limited to count successfully received STCH PDCP SDUs, PSCCH PHY Transport blocks and PSSCH PHY Transport blocks when the UE test loop mode E is activated.
Figure 5.1-11 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode F. The SC-PTM Packet Counter function for UE test loop mode F is specified in sub clause 5.4.4.d. The SC-PTM Packet Counter function is limited to count successfully received MBMS packets on one SC-MTCH configured by the SS when UE test loop mode F is activated.
Figure 5.1-12 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink via the EMM entity. Figure 5.1-13 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode G mode of operation is specified in sub clause 5.4.4e.
Figure 5.1-14 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink via the SM-TL entity (in a TPDU (SMS-SUBMIT)).
Figure 5.1-15 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode H mode of operation is specified in sub clause 5.4.4f.
Figure 5.1-16 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode I when IP PDU received in User data container content in a downlink ESM DATA TRANSFER message is returned in uplink via the EMM entity. The UE test loop mode I mode of operation is specified in sub clause 5.4.4g.
NOTE 7:	ROHC functionality in PDCP Layer 2 is optional for UE implementations.
Figure 5.1-1: Model for Test Control and UE Test Loop Mode A on UE side for E-UTRA and NB-IoT
Figure 5.1-2: Model for Test Control and UE Test Loop Mode B on UE side for E-UTRA and NB-IoT
Figure 5.1-3: Model for UE Test Loop Mode B on UE side for UTRA
Figure 5.1-4: Model for UE Test Loop Mode B on UE side for GSM/GPRS
Figure 5.1-5: Model for UE Test Loop Mode B on UE side for CDMA2000
Figure 5.1-6: Model for UE test loop mode C on UE side
Figure 5.1-7: Model for UE test loop mode D on UE side
(when Discovery monitor is indicated in the UE test loop mode D setup IE)
Figure 5.1-8: Model for UE test loop mode D on UE side 
(when Discovery announce is indicated in the UE test loop mode D setup IE)
Figure 5.1-9: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-9a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-10: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-10a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-11: Model for UE test loop mode F on UE side
Figure 5.1-12: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the EMM entity (before the UE uplink rate control entity)
Figure 5.1-13: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-14: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SM-TL entity
Figure 5.1-15: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-16: Model for UE test loop mode I on UE side configured to return downlink IP PDUs received in a ESM DATA TRANSFER message in uplink via the UE UL TFT handler to the EMM entity (before the UE uplink rate control entity)",TS 36.509,5.1,all_images/image_1421.jpeg,Model for UE test loop mode D on UE side
"The UE test loop function provides access to isolated functions of the UE via the radio interface without introducing wherever possible new physical interfaces just for the reason of conformance testing.
NOTE 0:	One exception from the rule above is the UE test loop mode E and UTC time reset when used for V2X out-of-coverage test scenarios which require an additional physical interface for the transmission of AT commands. This has been based on the assumption that V2X devices will normally provide such interface for other than testing purposes e.g. for device configuration.
NOTE 1:	It should be emphasised that the UE test loop function only describes the functional behaviour of the UE with respect to its external interfaces; physical implementation of the UE test loop function is completely left open to the manufacturer.
The UE test loop function is activated by transmitting the appropriate TC message to the UE, see clause 6.
The UE test loop function can be operated in different loopback modes:
-	UE test loop mode A;
-	UE test loop mode B;
-	UE test loop mode C;
-	UE test loop mode D;
-	UE test loop mode E;
-	UE test loop mode F;
-	UE test loop mode G;
-	UE test loop mode H;
-	UE test loop mode I.
UE test loop mode A provides loopback of PDCP SDUs for bi-directional data radio bearers while UE is operating in E-UTRA or NB-IoT mode. The downlink PDCP SDUs received by the UE on each bi-directional data radio bearer are returned on the same radio bearer regardless of the PDCP SDU contents and of the TFT of the associated EPS bearer context [36].
UE test loop mode B provides loopback of PDCP SDUs (E-UTRA and UTRA), SNDCP PDUs (GSM/GPRS) and RLP PDUs (CDMA2000) for bi-directional EPS bearers while UE is operated in E-UTRA, NB-IoT, UTRA, GSM/GPRS or CDMA2000 modes. When operating in E-UTRA, NB-IoT, UTRA or GSM/GPRS then the downlink PDCP SDUs or SNDCP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer associated with an EPS bearer context with a TFT matching the TCP/UDP/IP protocol information within the PDCP SDU or SNDCP SDU [36]. When operating in CDMA2000 modes, the downlink RLP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer with the smallest identity, regardless of the RLP PDU content and of the TFT of the associated EPS bearer context.
NOTE 2:	When multiple PDN connections are established (or multiple Primary PDP Contexts are active), it is assumed that different IP addresses are allocated to the UE by the SS on each PDN.
UE test loop mode C provides counting of successfully received MBMS Packets on a given MTCH while UE is operating in E-MBMS/E-UTRA mode. For E-MBMS then one or more MTCHs are multiplexed on a MCH. MBMS packets for a MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode D provides means for announcing or monitoring of ProSe Direct Discovery messages on SL-DCH, as specified by the test loop mode D setup IE in the CLOSE UE TEST LOOP message. In particular, for discovery monitor operation, UE test loop mode D provides counting of successfully received SL-DCH MAC SDUs while the UE is operating in ProSe Direct Discovery/E-UTRA mode. For discovery announce operation, UE test loop mode D provides trigger for transmission of ProSe Direct Discovery message on SL-DCH.
NOTE 3:	UE test loop mode D is intended for RF/RRM testing purposes.
NOTE 4:	ProSe Direct Discovery messages on the PC5 interface are delivered as one MAC SDU per ProSe Direct Discovery message.
UE test loop mode E provides means for either transmit or receive of ProSe Direct or V2X Communication packets, as specified by the test loop mode E setup IE in the CLOSE UE TEST LOOP message. In particular, for communication receive operation, UE test loop mode E provides counting of successfully received STCH PDCP SDUs, PSCCH PHY transport blocks and PSSCH PHY transport blocks while the UE is operating in ProSe Direct or V2X Communication/E-UTRA mode. For communication transmit operation, UE test loop mode E provides trigger for transmission of ProSe Direct or V2X Communication packets. For the V2X out-of-coverage scenarios this trigger utilises AT commands and requires an appropriate physical interface.
NOTE 5:	Void
NOTE 6:	The Application trigger required to force the UE to start or stop a particular ProSe Service is out of the scope of the test loop modes D and E.
UE test loop mode F provides counting of successfully received MBMS Packets on a given SC-MTCH while UE is operating in SC-PTM/E-UTRA mode. For SC-PTM one SC-MTCH is transmitted on a DL-SCH. MBMS packets for a SC-MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode G provides loopback of the User data container content of any received downlink ESM DATA TRANSPORT message in uplink. The received data can be configured to be either returned via the UE EMM entity (before the UE uplink rate control entity) or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode G may be configured to delay the uplink loopback of user data. UE test loop mode G may also be configured to repeat the received user data of the User data container in uplink to generate higher data rates in uplink.
UE test loop mode H provides loopback of the TP-User-Data field (including the SMS user data) of any received downlink TPDU (SMS-DELIVER) in uplink. The received data can be configured to be either returned via the UE SM-TL entity or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode H may be configured to delay the uplink loopback of SMS user data. UE test loop mode H may also be configured to repeat the received SMS user data in uplink to generate higher data rates in uplink.
NOTE 7:	UE test loop mode G and H are intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
NOTE 8:	The delay timer for UE test loop mode G and H is triggered by the first reception of user data after the reception of a CLOSE UE TEST LOOP TC message. While the delay timer is running only the user data received in the latest ESM DATA TRANSPORT or SMS message is buffered.
NOTE 9:	The repetition of uplink transmission of uplink messages carrying data can be configured as 0 (no data returned), 1 (the same content and size of user date as received in downlink is returned) or value N > 1 (user data corresponding to N times repetition of the received user data is returned in uplink).
UE test loop mode I provides loopback of the IP PDUs received in User data container content of downlink ESM DATA TRANSPORT message in uplink via the UE uplink TFT hander and the UE EMM entity (before the UE uplink rate control entity).
NOTE 10:	UE test loop mode I is intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
UE test loop mode A is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in E-UTRA mode is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in UTRA mode is mandatory to all E-UTRA UEs supporting UTRA radio access.
UE test loop mode B for operation in GSM/GPRS mode is mandatory to all E-UTRA UEs supporting GSM/GPRS radio access.
UE test loop mode B for operation in CDMA2000 mode is mandatory to all E-UTRA UEs supporting CDMA2000 radio access.
UE test loop mode C is mandatory for E-UTRA UEs supporting E-MBMS.
UE test loop mode D is mandatory for E-UTRA UEs supporting ProSe Direct Discovery.
UE test loop mode E is mandatory for E-UTRA UEs supporting ProSe Direct or V2X Communication.
UE test loop mode F is mandatory for E-UTRA UEs supporting SC-PTM.
UE test loop mode G is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
UE test loop mode H is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using SMS.
UE test loop mode I is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
Support of UPDATE UE LOCATION INFORMATION is optional for all E-UTRA UEs with the exception of E-UTRA UEs supporting ProSe Direct Communication for which it is mandatory.
For E-UTRA UE supporting multiple radio access technologies then UE reception of Test Control messages is limited to UE operating in E-UTRA mode, while continuation of loopback of user data is provided over the change to other UE supported radio access technologies.
UE test loop mode B for operation in UTRA, GSM/GPRS and CDMA2000 mode is only applicable for loopback of user data in PS domain.
The TC entity may be seen as a L3 or a NAS entity.
Figure 5.1-1 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode A. The loopback of PDCP SDUs for UE test loop mode A is specified in sub clause 5.4.3.
Figure 5.1-2 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode B. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in E-UTRA mode is specified in subclauses 5.4.4.2 and 5.4.4.3.
Figure 5.1-3 shows a functional block diagram of UE test loop function for UE test loop mode B and UE operating in UTRA mode. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in UTRA mode is specified in subclauses 5.4.4.4 and 5.4.4.5.
Figure 5.1-4 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in GSM/GPRS mode. The loopback of IP PDUs/SNDCP SDUs for UE test loop mode B and UE in GSM/GPRS mode is specified in subclauses 5.4.4.6 and 5.4.4.7.
Figure 5.1-5 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in CDMA2000 mode. The loopback of IP PDUs/RLP SDUs for UE test loop mode B and UE in CDMA2000 mode is specified in subclauses 5.4.4.8 and 5.4.4.9.
Figure 5.1-6 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode C. The MBMS Packet Counter function for UE test loop mode C is specified in sub clause 5.4.4.a. The MBMS Packet Counter function is limited to count successfully received MBMS packets on one MTCH configured by the SS when UE test loop mode C is activated.
Figure 5.1-7 and Figure 5.1-8 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode D. The ProSe Direct Discovery Packet Counter function for UE test loop mode D is specified in clause 5.4.4b. The ProSe Direct Discovery packet counter function is limited to count successfully received SL-DCH MAC SDUs when UE test loop mode D is activated.
Figure 5.1-9 and Figure 5.1-10 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting ProSe Direct, or, V2X when UE is in in-coverage state. Figure 5.1-9a and Figure 5.1-10a show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting V2X when UE is in out-of-coverage state; the Electrical Man Machine Interface (EMMI) required for facilitating the AT commands transmission is specified in clause 8. The ProSe Direct or V2X Communication Packet Counter function for UE test loop mode E is specified in clause 5.4.4c. The ProSe Direct or V2X Communication packet counter function is limited to count successfully received STCH PDCP SDUs, PSCCH PHY Transport blocks and PSSCH PHY Transport blocks when the UE test loop mode E is activated.
Figure 5.1-11 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode F. The SC-PTM Packet Counter function for UE test loop mode F is specified in sub clause 5.4.4.d. The SC-PTM Packet Counter function is limited to count successfully received MBMS packets on one SC-MTCH configured by the SS when UE test loop mode F is activated.
Figure 5.1-12 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink via the EMM entity. Figure 5.1-13 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode G mode of operation is specified in sub clause 5.4.4e.
Figure 5.1-14 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink via the SM-TL entity (in a TPDU (SMS-SUBMIT)).
Figure 5.1-15 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode H mode of operation is specified in sub clause 5.4.4f.
Figure 5.1-16 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode I when IP PDU received in User data container content in a downlink ESM DATA TRANSFER message is returned in uplink via the EMM entity. The UE test loop mode I mode of operation is specified in sub clause 5.4.4g.
NOTE 7:	ROHC functionality in PDCP Layer 2 is optional for UE implementations.
Figure 5.1-1: Model for Test Control and UE Test Loop Mode A on UE side for E-UTRA and NB-IoT
Figure 5.1-2: Model for Test Control and UE Test Loop Mode B on UE side for E-UTRA and NB-IoT
Figure 5.1-3: Model for UE Test Loop Mode B on UE side for UTRA
Figure 5.1-4: Model for UE Test Loop Mode B on UE side for GSM/GPRS
Figure 5.1-5: Model for UE Test Loop Mode B on UE side for CDMA2000
Figure 5.1-6: Model for UE test loop mode C on UE side
Figure 5.1-7: Model for UE test loop mode D on UE side
(when Discovery monitor is indicated in the UE test loop mode D setup IE)
Figure 5.1-8: Model for UE test loop mode D on UE side 
(when Discovery announce is indicated in the UE test loop mode D setup IE)
Figure 5.1-9: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-9a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-10: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-10a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-11: Model for UE test loop mode F on UE side
Figure 5.1-12: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the EMM entity (before the UE uplink rate control entity)
Figure 5.1-13: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-14: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SM-TL entity
Figure 5.1-15: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-16: Model for UE test loop mode I on UE side configured to return downlink IP PDUs received in a ESM DATA TRANSFER message in uplink via the UE UL TFT handler to the EMM entity (before the UE uplink rate control entity)",TS 36.509,5.1,all_images/image_1422.jpeg,Model for UE test loop mode D on UE side 
"The UE test loop function provides access to isolated functions of the UE via the radio interface without introducing wherever possible new physical interfaces just for the reason of conformance testing.
NOTE 0:	One exception from the rule above is the UE test loop mode E and UTC time reset when used for V2X out-of-coverage test scenarios which require an additional physical interface for the transmission of AT commands. This has been based on the assumption that V2X devices will normally provide such interface for other than testing purposes e.g. for device configuration.
NOTE 1:	It should be emphasised that the UE test loop function only describes the functional behaviour of the UE with respect to its external interfaces; physical implementation of the UE test loop function is completely left open to the manufacturer.
The UE test loop function is activated by transmitting the appropriate TC message to the UE, see clause 6.
The UE test loop function can be operated in different loopback modes:
-	UE test loop mode A;
-	UE test loop mode B;
-	UE test loop mode C;
-	UE test loop mode D;
-	UE test loop mode E;
-	UE test loop mode F;
-	UE test loop mode G;
-	UE test loop mode H;
-	UE test loop mode I.
UE test loop mode A provides loopback of PDCP SDUs for bi-directional data radio bearers while UE is operating in E-UTRA or NB-IoT mode. The downlink PDCP SDUs received by the UE on each bi-directional data radio bearer are returned on the same radio bearer regardless of the PDCP SDU contents and of the TFT of the associated EPS bearer context [36].
UE test loop mode B provides loopback of PDCP SDUs (E-UTRA and UTRA), SNDCP PDUs (GSM/GPRS) and RLP PDUs (CDMA2000) for bi-directional EPS bearers while UE is operated in E-UTRA, NB-IoT, UTRA, GSM/GPRS or CDMA2000 modes. When operating in E-UTRA, NB-IoT, UTRA or GSM/GPRS then the downlink PDCP SDUs or SNDCP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer associated with an EPS bearer context with a TFT matching the TCP/UDP/IP protocol information within the PDCP SDU or SNDCP SDU [36]. When operating in CDMA2000 modes, the downlink RLP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer with the smallest identity, regardless of the RLP PDU content and of the TFT of the associated EPS bearer context.
NOTE 2:	When multiple PDN connections are established (or multiple Primary PDP Contexts are active), it is assumed that different IP addresses are allocated to the UE by the SS on each PDN.
UE test loop mode C provides counting of successfully received MBMS Packets on a given MTCH while UE is operating in E-MBMS/E-UTRA mode. For E-MBMS then one or more MTCHs are multiplexed on a MCH. MBMS packets for a MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode D provides means for announcing or monitoring of ProSe Direct Discovery messages on SL-DCH, as specified by the test loop mode D setup IE in the CLOSE UE TEST LOOP message. In particular, for discovery monitor operation, UE test loop mode D provides counting of successfully received SL-DCH MAC SDUs while the UE is operating in ProSe Direct Discovery/E-UTRA mode. For discovery announce operation, UE test loop mode D provides trigger for transmission of ProSe Direct Discovery message on SL-DCH.
NOTE 3:	UE test loop mode D is intended for RF/RRM testing purposes.
NOTE 4:	ProSe Direct Discovery messages on the PC5 interface are delivered as one MAC SDU per ProSe Direct Discovery message.
UE test loop mode E provides means for either transmit or receive of ProSe Direct or V2X Communication packets, as specified by the test loop mode E setup IE in the CLOSE UE TEST LOOP message. In particular, for communication receive operation, UE test loop mode E provides counting of successfully received STCH PDCP SDUs, PSCCH PHY transport blocks and PSSCH PHY transport blocks while the UE is operating in ProSe Direct or V2X Communication/E-UTRA mode. For communication transmit operation, UE test loop mode E provides trigger for transmission of ProSe Direct or V2X Communication packets. For the V2X out-of-coverage scenarios this trigger utilises AT commands and requires an appropriate physical interface.
NOTE 5:	Void
NOTE 6:	The Application trigger required to force the UE to start or stop a particular ProSe Service is out of the scope of the test loop modes D and E.
UE test loop mode F provides counting of successfully received MBMS Packets on a given SC-MTCH while UE is operating in SC-PTM/E-UTRA mode. For SC-PTM one SC-MTCH is transmitted on a DL-SCH. MBMS packets for a SC-MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode G provides loopback of the User data container content of any received downlink ESM DATA TRANSPORT message in uplink. The received data can be configured to be either returned via the UE EMM entity (before the UE uplink rate control entity) or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode G may be configured to delay the uplink loopback of user data. UE test loop mode G may also be configured to repeat the received user data of the User data container in uplink to generate higher data rates in uplink.
UE test loop mode H provides loopback of the TP-User-Data field (including the SMS user data) of any received downlink TPDU (SMS-DELIVER) in uplink. The received data can be configured to be either returned via the UE SM-TL entity or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode H may be configured to delay the uplink loopback of SMS user data. UE test loop mode H may also be configured to repeat the received SMS user data in uplink to generate higher data rates in uplink.
NOTE 7:	UE test loop mode G and H are intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
NOTE 8:	The delay timer for UE test loop mode G and H is triggered by the first reception of user data after the reception of a CLOSE UE TEST LOOP TC message. While the delay timer is running only the user data received in the latest ESM DATA TRANSPORT or SMS message is buffered.
NOTE 9:	The repetition of uplink transmission of uplink messages carrying data can be configured as 0 (no data returned), 1 (the same content and size of user date as received in downlink is returned) or value N > 1 (user data corresponding to N times repetition of the received user data is returned in uplink).
UE test loop mode I provides loopback of the IP PDUs received in User data container content of downlink ESM DATA TRANSPORT message in uplink via the UE uplink TFT hander and the UE EMM entity (before the UE uplink rate control entity).
NOTE 10:	UE test loop mode I is intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
UE test loop mode A is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in E-UTRA mode is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in UTRA mode is mandatory to all E-UTRA UEs supporting UTRA radio access.
UE test loop mode B for operation in GSM/GPRS mode is mandatory to all E-UTRA UEs supporting GSM/GPRS radio access.
UE test loop mode B for operation in CDMA2000 mode is mandatory to all E-UTRA UEs supporting CDMA2000 radio access.
UE test loop mode C is mandatory for E-UTRA UEs supporting E-MBMS.
UE test loop mode D is mandatory for E-UTRA UEs supporting ProSe Direct Discovery.
UE test loop mode E is mandatory for E-UTRA UEs supporting ProSe Direct or V2X Communication.
UE test loop mode F is mandatory for E-UTRA UEs supporting SC-PTM.
UE test loop mode G is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
UE test loop mode H is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using SMS.
UE test loop mode I is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
Support of UPDATE UE LOCATION INFORMATION is optional for all E-UTRA UEs with the exception of E-UTRA UEs supporting ProSe Direct Communication for which it is mandatory.
For E-UTRA UE supporting multiple radio access technologies then UE reception of Test Control messages is limited to UE operating in E-UTRA mode, while continuation of loopback of user data is provided over the change to other UE supported radio access technologies.
UE test loop mode B for operation in UTRA, GSM/GPRS and CDMA2000 mode is only applicable for loopback of user data in PS domain.
The TC entity may be seen as a L3 or a NAS entity.
Figure 5.1-1 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode A. The loopback of PDCP SDUs for UE test loop mode A is specified in sub clause 5.4.3.
Figure 5.1-2 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode B. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in E-UTRA mode is specified in subclauses 5.4.4.2 and 5.4.4.3.
Figure 5.1-3 shows a functional block diagram of UE test loop function for UE test loop mode B and UE operating in UTRA mode. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in UTRA mode is specified in subclauses 5.4.4.4 and 5.4.4.5.
Figure 5.1-4 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in GSM/GPRS mode. The loopback of IP PDUs/SNDCP SDUs for UE test loop mode B and UE in GSM/GPRS mode is specified in subclauses 5.4.4.6 and 5.4.4.7.
Figure 5.1-5 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in CDMA2000 mode. The loopback of IP PDUs/RLP SDUs for UE test loop mode B and UE in CDMA2000 mode is specified in subclauses 5.4.4.8 and 5.4.4.9.
Figure 5.1-6 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode C. The MBMS Packet Counter function for UE test loop mode C is specified in sub clause 5.4.4.a. The MBMS Packet Counter function is limited to count successfully received MBMS packets on one MTCH configured by the SS when UE test loop mode C is activated.
Figure 5.1-7 and Figure 5.1-8 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode D. The ProSe Direct Discovery Packet Counter function for UE test loop mode D is specified in clause 5.4.4b. The ProSe Direct Discovery packet counter function is limited to count successfully received SL-DCH MAC SDUs when UE test loop mode D is activated.
Figure 5.1-9 and Figure 5.1-10 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting ProSe Direct, or, V2X when UE is in in-coverage state. Figure 5.1-9a and Figure 5.1-10a show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting V2X when UE is in out-of-coverage state; the Electrical Man Machine Interface (EMMI) required for facilitating the AT commands transmission is specified in clause 8. The ProSe Direct or V2X Communication Packet Counter function for UE test loop mode E is specified in clause 5.4.4c. The ProSe Direct or V2X Communication packet counter function is limited to count successfully received STCH PDCP SDUs, PSCCH PHY Transport blocks and PSSCH PHY Transport blocks when the UE test loop mode E is activated.
Figure 5.1-11 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode F. The SC-PTM Packet Counter function for UE test loop mode F is specified in sub clause 5.4.4.d. The SC-PTM Packet Counter function is limited to count successfully received MBMS packets on one SC-MTCH configured by the SS when UE test loop mode F is activated.
Figure 5.1-12 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink via the EMM entity. Figure 5.1-13 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode G mode of operation is specified in sub clause 5.4.4e.
Figure 5.1-14 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink via the SM-TL entity (in a TPDU (SMS-SUBMIT)).
Figure 5.1-15 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode H mode of operation is specified in sub clause 5.4.4f.
Figure 5.1-16 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode I when IP PDU received in User data container content in a downlink ESM DATA TRANSFER message is returned in uplink via the EMM entity. The UE test loop mode I mode of operation is specified in sub clause 5.4.4g.
NOTE 7:	ROHC functionality in PDCP Layer 2 is optional for UE implementations.
Figure 5.1-1: Model for Test Control and UE Test Loop Mode A on UE side for E-UTRA and NB-IoT
Figure 5.1-2: Model for Test Control and UE Test Loop Mode B on UE side for E-UTRA and NB-IoT
Figure 5.1-3: Model for UE Test Loop Mode B on UE side for UTRA
Figure 5.1-4: Model for UE Test Loop Mode B on UE side for GSM/GPRS
Figure 5.1-5: Model for UE Test Loop Mode B on UE side for CDMA2000
Figure 5.1-6: Model for UE test loop mode C on UE side
Figure 5.1-7: Model for UE test loop mode D on UE side
(when Discovery monitor is indicated in the UE test loop mode D setup IE)
Figure 5.1-8: Model for UE test loop mode D on UE side 
(when Discovery announce is indicated in the UE test loop mode D setup IE)
Figure 5.1-9: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-9a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-10: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-10a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-11: Model for UE test loop mode F on UE side
Figure 5.1-12: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the EMM entity (before the UE uplink rate control entity)
Figure 5.1-13: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-14: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SM-TL entity
Figure 5.1-15: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-16: Model for UE test loop mode I on UE side configured to return downlink IP PDUs received in a ESM DATA TRANSFER message in uplink via the UE UL TFT handler to the EMM entity (before the UE uplink rate control entity)",TS 36.509,5.1,all_images/image_1423.png,"Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-"
"The UE test loop function provides access to isolated functions of the UE via the radio interface without introducing wherever possible new physical interfaces just for the reason of conformance testing.
NOTE 0:	One exception from the rule above is the UE test loop mode E and UTC time reset when used for V2X out-of-coverage test scenarios which require an additional physical interface for the transmission of AT commands. This has been based on the assumption that V2X devices will normally provide such interface for other than testing purposes e.g. for device configuration.
NOTE 1:	It should be emphasised that the UE test loop function only describes the functional behaviour of the UE with respect to its external interfaces; physical implementation of the UE test loop function is completely left open to the manufacturer.
The UE test loop function is activated by transmitting the appropriate TC message to the UE, see clause 6.
The UE test loop function can be operated in different loopback modes:
-	UE test loop mode A;
-	UE test loop mode B;
-	UE test loop mode C;
-	UE test loop mode D;
-	UE test loop mode E;
-	UE test loop mode F;
-	UE test loop mode G;
-	UE test loop mode H;
-	UE test loop mode I.
UE test loop mode A provides loopback of PDCP SDUs for bi-directional data radio bearers while UE is operating in E-UTRA or NB-IoT mode. The downlink PDCP SDUs received by the UE on each bi-directional data radio bearer are returned on the same radio bearer regardless of the PDCP SDU contents and of the TFT of the associated EPS bearer context [36].
UE test loop mode B provides loopback of PDCP SDUs (E-UTRA and UTRA), SNDCP PDUs (GSM/GPRS) and RLP PDUs (CDMA2000) for bi-directional EPS bearers while UE is operated in E-UTRA, NB-IoT, UTRA, GSM/GPRS or CDMA2000 modes. When operating in E-UTRA, NB-IoT, UTRA or GSM/GPRS then the downlink PDCP SDUs or SNDCP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer associated with an EPS bearer context with a TFT matching the TCP/UDP/IP protocol information within the PDCP SDU or SNDCP SDU [36]. When operating in CDMA2000 modes, the downlink RLP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer with the smallest identity, regardless of the RLP PDU content and of the TFT of the associated EPS bearer context.
NOTE 2:	When multiple PDN connections are established (or multiple Primary PDP Contexts are active), it is assumed that different IP addresses are allocated to the UE by the SS on each PDN.
UE test loop mode C provides counting of successfully received MBMS Packets on a given MTCH while UE is operating in E-MBMS/E-UTRA mode. For E-MBMS then one or more MTCHs are multiplexed on a MCH. MBMS packets for a MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode D provides means for announcing or monitoring of ProSe Direct Discovery messages on SL-DCH, as specified by the test loop mode D setup IE in the CLOSE UE TEST LOOP message. In particular, for discovery monitor operation, UE test loop mode D provides counting of successfully received SL-DCH MAC SDUs while the UE is operating in ProSe Direct Discovery/E-UTRA mode. For discovery announce operation, UE test loop mode D provides trigger for transmission of ProSe Direct Discovery message on SL-DCH.
NOTE 3:	UE test loop mode D is intended for RF/RRM testing purposes.
NOTE 4:	ProSe Direct Discovery messages on the PC5 interface are delivered as one MAC SDU per ProSe Direct Discovery message.
UE test loop mode E provides means for either transmit or receive of ProSe Direct or V2X Communication packets, as specified by the test loop mode E setup IE in the CLOSE UE TEST LOOP message. In particular, for communication receive operation, UE test loop mode E provides counting of successfully received STCH PDCP SDUs, PSCCH PHY transport blocks and PSSCH PHY transport blocks while the UE is operating in ProSe Direct or V2X Communication/E-UTRA mode. For communication transmit operation, UE test loop mode E provides trigger for transmission of ProSe Direct or V2X Communication packets. For the V2X out-of-coverage scenarios this trigger utilises AT commands and requires an appropriate physical interface.
NOTE 5:	Void
NOTE 6:	The Application trigger required to force the UE to start or stop a particular ProSe Service is out of the scope of the test loop modes D and E.
UE test loop mode F provides counting of successfully received MBMS Packets on a given SC-MTCH while UE is operating in SC-PTM/E-UTRA mode. For SC-PTM one SC-MTCH is transmitted on a DL-SCH. MBMS packets for a SC-MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode G provides loopback of the User data container content of any received downlink ESM DATA TRANSPORT message in uplink. The received data can be configured to be either returned via the UE EMM entity (before the UE uplink rate control entity) or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode G may be configured to delay the uplink loopback of user data. UE test loop mode G may also be configured to repeat the received user data of the User data container in uplink to generate higher data rates in uplink.
UE test loop mode H provides loopback of the TP-User-Data field (including the SMS user data) of any received downlink TPDU (SMS-DELIVER) in uplink. The received data can be configured to be either returned via the UE SM-TL entity or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode H may be configured to delay the uplink loopback of SMS user data. UE test loop mode H may also be configured to repeat the received SMS user data in uplink to generate higher data rates in uplink.
NOTE 7:	UE test loop mode G and H are intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
NOTE 8:	The delay timer for UE test loop mode G and H is triggered by the first reception of user data after the reception of a CLOSE UE TEST LOOP TC message. While the delay timer is running only the user data received in the latest ESM DATA TRANSPORT or SMS message is buffered.
NOTE 9:	The repetition of uplink transmission of uplink messages carrying data can be configured as 0 (no data returned), 1 (the same content and size of user date as received in downlink is returned) or value N > 1 (user data corresponding to N times repetition of the received user data is returned in uplink).
UE test loop mode I provides loopback of the IP PDUs received in User data container content of downlink ESM DATA TRANSPORT message in uplink via the UE uplink TFT hander and the UE EMM entity (before the UE uplink rate control entity).
NOTE 10:	UE test loop mode I is intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
UE test loop mode A is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in E-UTRA mode is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in UTRA mode is mandatory to all E-UTRA UEs supporting UTRA radio access.
UE test loop mode B for operation in GSM/GPRS mode is mandatory to all E-UTRA UEs supporting GSM/GPRS radio access.
UE test loop mode B for operation in CDMA2000 mode is mandatory to all E-UTRA UEs supporting CDMA2000 radio access.
UE test loop mode C is mandatory for E-UTRA UEs supporting E-MBMS.
UE test loop mode D is mandatory for E-UTRA UEs supporting ProSe Direct Discovery.
UE test loop mode E is mandatory for E-UTRA UEs supporting ProSe Direct or V2X Communication.
UE test loop mode F is mandatory for E-UTRA UEs supporting SC-PTM.
UE test loop mode G is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
UE test loop mode H is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using SMS.
UE test loop mode I is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
Support of UPDATE UE LOCATION INFORMATION is optional for all E-UTRA UEs with the exception of E-UTRA UEs supporting ProSe Direct Communication for which it is mandatory.
For E-UTRA UE supporting multiple radio access technologies then UE reception of Test Control messages is limited to UE operating in E-UTRA mode, while continuation of loopback of user data is provided over the change to other UE supported radio access technologies.
UE test loop mode B for operation in UTRA, GSM/GPRS and CDMA2000 mode is only applicable for loopback of user data in PS domain.
The TC entity may be seen as a L3 or a NAS entity.
Figure 5.1-1 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode A. The loopback of PDCP SDUs for UE test loop mode A is specified in sub clause 5.4.3.
Figure 5.1-2 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode B. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in E-UTRA mode is specified in subclauses 5.4.4.2 and 5.4.4.3.
Figure 5.1-3 shows a functional block diagram of UE test loop function for UE test loop mode B and UE operating in UTRA mode. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in UTRA mode is specified in subclauses 5.4.4.4 and 5.4.4.5.
Figure 5.1-4 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in GSM/GPRS mode. The loopback of IP PDUs/SNDCP SDUs for UE test loop mode B and UE in GSM/GPRS mode is specified in subclauses 5.4.4.6 and 5.4.4.7.
Figure 5.1-5 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in CDMA2000 mode. The loopback of IP PDUs/RLP SDUs for UE test loop mode B and UE in CDMA2000 mode is specified in subclauses 5.4.4.8 and 5.4.4.9.
Figure 5.1-6 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode C. The MBMS Packet Counter function for UE test loop mode C is specified in sub clause 5.4.4.a. The MBMS Packet Counter function is limited to count successfully received MBMS packets on one MTCH configured by the SS when UE test loop mode C is activated.
Figure 5.1-7 and Figure 5.1-8 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode D. The ProSe Direct Discovery Packet Counter function for UE test loop mode D is specified in clause 5.4.4b. The ProSe Direct Discovery packet counter function is limited to count successfully received SL-DCH MAC SDUs when UE test loop mode D is activated.
Figure 5.1-9 and Figure 5.1-10 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting ProSe Direct, or, V2X when UE is in in-coverage state. Figure 5.1-9a and Figure 5.1-10a show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting V2X when UE is in out-of-coverage state; the Electrical Man Machine Interface (EMMI) required for facilitating the AT commands transmission is specified in clause 8. The ProSe Direct or V2X Communication Packet Counter function for UE test loop mode E is specified in clause 5.4.4c. The ProSe Direct or V2X Communication packet counter function is limited to count successfully received STCH PDCP SDUs, PSCCH PHY Transport blocks and PSSCH PHY Transport blocks when the UE test loop mode E is activated.
Figure 5.1-11 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode F. The SC-PTM Packet Counter function for UE test loop mode F is specified in sub clause 5.4.4.d. The SC-PTM Packet Counter function is limited to count successfully received MBMS packets on one SC-MTCH configured by the SS when UE test loop mode F is activated.
Figure 5.1-12 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink via the EMM entity. Figure 5.1-13 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode G mode of operation is specified in sub clause 5.4.4e.
Figure 5.1-14 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink via the SM-TL entity (in a TPDU (SMS-SUBMIT)).
Figure 5.1-15 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode H mode of operation is specified in sub clause 5.4.4f.
Figure 5.1-16 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode I when IP PDU received in User data container content in a downlink ESM DATA TRANSFER message is returned in uplink via the EMM entity. The UE test loop mode I mode of operation is specified in sub clause 5.4.4g.
NOTE 7:	ROHC functionality in PDCP Layer 2 is optional for UE implementations.
Figure 5.1-1: Model for Test Control and UE Test Loop Mode A on UE side for E-UTRA and NB-IoT
Figure 5.1-2: Model for Test Control and UE Test Loop Mode B on UE side for E-UTRA and NB-IoT
Figure 5.1-3: Model for UE Test Loop Mode B on UE side for UTRA
Figure 5.1-4: Model for UE Test Loop Mode B on UE side for GSM/GPRS
Figure 5.1-5: Model for UE Test Loop Mode B on UE side for CDMA2000
Figure 5.1-6: Model for UE test loop mode C on UE side
Figure 5.1-7: Model for UE test loop mode D on UE side
(when Discovery monitor is indicated in the UE test loop mode D setup IE)
Figure 5.1-8: Model for UE test loop mode D on UE side 
(when Discovery announce is indicated in the UE test loop mode D setup IE)
Figure 5.1-9: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-9a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-10: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-10a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-11: Model for UE test loop mode F on UE side
Figure 5.1-12: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the EMM entity (before the UE uplink rate control entity)
Figure 5.1-13: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-14: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SM-TL entity
Figure 5.1-15: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-16: Model for UE test loop mode I on UE side configured to return downlink IP PDUs received in a ESM DATA TRANSFER message in uplink via the UE UL TFT handler to the EMM entity (before the UE uplink rate control entity)",TS 36.509,5.1,all_images/image_1425.jpeg,Model for UE test loop mode F on UE side
"The UE test loop function provides access to isolated functions of the UE via the radio interface without introducing wherever possible new physical interfaces just for the reason of conformance testing.
NOTE 0:	One exception from the rule above is the UE test loop mode E and UTC time reset when used for V2X out-of-coverage test scenarios which require an additional physical interface for the transmission of AT commands. This has been based on the assumption that V2X devices will normally provide such interface for other than testing purposes e.g. for device configuration.
NOTE 1:	It should be emphasised that the UE test loop function only describes the functional behaviour of the UE with respect to its external interfaces; physical implementation of the UE test loop function is completely left open to the manufacturer.
The UE test loop function is activated by transmitting the appropriate TC message to the UE, see clause 6.
The UE test loop function can be operated in different loopback modes:
-	UE test loop mode A;
-	UE test loop mode B;
-	UE test loop mode C;
-	UE test loop mode D;
-	UE test loop mode E;
-	UE test loop mode F;
-	UE test loop mode G;
-	UE test loop mode H;
-	UE test loop mode I.
UE test loop mode A provides loopback of PDCP SDUs for bi-directional data radio bearers while UE is operating in E-UTRA or NB-IoT mode. The downlink PDCP SDUs received by the UE on each bi-directional data radio bearer are returned on the same radio bearer regardless of the PDCP SDU contents and of the TFT of the associated EPS bearer context [36].
UE test loop mode B provides loopback of PDCP SDUs (E-UTRA and UTRA), SNDCP PDUs (GSM/GPRS) and RLP PDUs (CDMA2000) for bi-directional EPS bearers while UE is operated in E-UTRA, NB-IoT, UTRA, GSM/GPRS or CDMA2000 modes. When operating in E-UTRA, NB-IoT, UTRA or GSM/GPRS then the downlink PDCP SDUs or SNDCP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer associated with an EPS bearer context with a TFT matching the TCP/UDP/IP protocol information within the PDCP SDU or SNDCP SDU [36]. When operating in CDMA2000 modes, the downlink RLP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer with the smallest identity, regardless of the RLP PDU content and of the TFT of the associated EPS bearer context.
NOTE 2:	When multiple PDN connections are established (or multiple Primary PDP Contexts are active), it is assumed that different IP addresses are allocated to the UE by the SS on each PDN.
UE test loop mode C provides counting of successfully received MBMS Packets on a given MTCH while UE is operating in E-MBMS/E-UTRA mode. For E-MBMS then one or more MTCHs are multiplexed on a MCH. MBMS packets for a MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode D provides means for announcing or monitoring of ProSe Direct Discovery messages on SL-DCH, as specified by the test loop mode D setup IE in the CLOSE UE TEST LOOP message. In particular, for discovery monitor operation, UE test loop mode D provides counting of successfully received SL-DCH MAC SDUs while the UE is operating in ProSe Direct Discovery/E-UTRA mode. For discovery announce operation, UE test loop mode D provides trigger for transmission of ProSe Direct Discovery message on SL-DCH.
NOTE 3:	UE test loop mode D is intended for RF/RRM testing purposes.
NOTE 4:	ProSe Direct Discovery messages on the PC5 interface are delivered as one MAC SDU per ProSe Direct Discovery message.
UE test loop mode E provides means for either transmit or receive of ProSe Direct or V2X Communication packets, as specified by the test loop mode E setup IE in the CLOSE UE TEST LOOP message. In particular, for communication receive operation, UE test loop mode E provides counting of successfully received STCH PDCP SDUs, PSCCH PHY transport blocks and PSSCH PHY transport blocks while the UE is operating in ProSe Direct or V2X Communication/E-UTRA mode. For communication transmit operation, UE test loop mode E provides trigger for transmission of ProSe Direct or V2X Communication packets. For the V2X out-of-coverage scenarios this trigger utilises AT commands and requires an appropriate physical interface.
NOTE 5:	Void
NOTE 6:	The Application trigger required to force the UE to start or stop a particular ProSe Service is out of the scope of the test loop modes D and E.
UE test loop mode F provides counting of successfully received MBMS Packets on a given SC-MTCH while UE is operating in SC-PTM/E-UTRA mode. For SC-PTM one SC-MTCH is transmitted on a DL-SCH. MBMS packets for a SC-MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode G provides loopback of the User data container content of any received downlink ESM DATA TRANSPORT message in uplink. The received data can be configured to be either returned via the UE EMM entity (before the UE uplink rate control entity) or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode G may be configured to delay the uplink loopback of user data. UE test loop mode G may also be configured to repeat the received user data of the User data container in uplink to generate higher data rates in uplink.
UE test loop mode H provides loopback of the TP-User-Data field (including the SMS user data) of any received downlink TPDU (SMS-DELIVER) in uplink. The received data can be configured to be either returned via the UE SM-TL entity or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode H may be configured to delay the uplink loopback of SMS user data. UE test loop mode H may also be configured to repeat the received SMS user data in uplink to generate higher data rates in uplink.
NOTE 7:	UE test loop mode G and H are intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
NOTE 8:	The delay timer for UE test loop mode G and H is triggered by the first reception of user data after the reception of a CLOSE UE TEST LOOP TC message. While the delay timer is running only the user data received in the latest ESM DATA TRANSPORT or SMS message is buffered.
NOTE 9:	The repetition of uplink transmission of uplink messages carrying data can be configured as 0 (no data returned), 1 (the same content and size of user date as received in downlink is returned) or value N > 1 (user data corresponding to N times repetition of the received user data is returned in uplink).
UE test loop mode I provides loopback of the IP PDUs received in User data container content of downlink ESM DATA TRANSPORT message in uplink via the UE uplink TFT hander and the UE EMM entity (before the UE uplink rate control entity).
NOTE 10:	UE test loop mode I is intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
UE test loop mode A is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in E-UTRA mode is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in UTRA mode is mandatory to all E-UTRA UEs supporting UTRA radio access.
UE test loop mode B for operation in GSM/GPRS mode is mandatory to all E-UTRA UEs supporting GSM/GPRS radio access.
UE test loop mode B for operation in CDMA2000 mode is mandatory to all E-UTRA UEs supporting CDMA2000 radio access.
UE test loop mode C is mandatory for E-UTRA UEs supporting E-MBMS.
UE test loop mode D is mandatory for E-UTRA UEs supporting ProSe Direct Discovery.
UE test loop mode E is mandatory for E-UTRA UEs supporting ProSe Direct or V2X Communication.
UE test loop mode F is mandatory for E-UTRA UEs supporting SC-PTM.
UE test loop mode G is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
UE test loop mode H is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using SMS.
UE test loop mode I is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
Support of UPDATE UE LOCATION INFORMATION is optional for all E-UTRA UEs with the exception of E-UTRA UEs supporting ProSe Direct Communication for which it is mandatory.
For E-UTRA UE supporting multiple radio access technologies then UE reception of Test Control messages is limited to UE operating in E-UTRA mode, while continuation of loopback of user data is provided over the change to other UE supported radio access technologies.
UE test loop mode B for operation in UTRA, GSM/GPRS and CDMA2000 mode is only applicable for loopback of user data in PS domain.
The TC entity may be seen as a L3 or a NAS entity.
Figure 5.1-1 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode A. The loopback of PDCP SDUs for UE test loop mode A is specified in sub clause 5.4.3.
Figure 5.1-2 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode B. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in E-UTRA mode is specified in subclauses 5.4.4.2 and 5.4.4.3.
Figure 5.1-3 shows a functional block diagram of UE test loop function for UE test loop mode B and UE operating in UTRA mode. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in UTRA mode is specified in subclauses 5.4.4.4 and 5.4.4.5.
Figure 5.1-4 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in GSM/GPRS mode. The loopback of IP PDUs/SNDCP SDUs for UE test loop mode B and UE in GSM/GPRS mode is specified in subclauses 5.4.4.6 and 5.4.4.7.
Figure 5.1-5 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in CDMA2000 mode. The loopback of IP PDUs/RLP SDUs for UE test loop mode B and UE in CDMA2000 mode is specified in subclauses 5.4.4.8 and 5.4.4.9.
Figure 5.1-6 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode C. The MBMS Packet Counter function for UE test loop mode C is specified in sub clause 5.4.4.a. The MBMS Packet Counter function is limited to count successfully received MBMS packets on one MTCH configured by the SS when UE test loop mode C is activated.
Figure 5.1-7 and Figure 5.1-8 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode D. The ProSe Direct Discovery Packet Counter function for UE test loop mode D is specified in clause 5.4.4b. The ProSe Direct Discovery packet counter function is limited to count successfully received SL-DCH MAC SDUs when UE test loop mode D is activated.
Figure 5.1-9 and Figure 5.1-10 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting ProSe Direct, or, V2X when UE is in in-coverage state. Figure 5.1-9a and Figure 5.1-10a show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting V2X when UE is in out-of-coverage state; the Electrical Man Machine Interface (EMMI) required for facilitating the AT commands transmission is specified in clause 8. The ProSe Direct or V2X Communication Packet Counter function for UE test loop mode E is specified in clause 5.4.4c. The ProSe Direct or V2X Communication packet counter function is limited to count successfully received STCH PDCP SDUs, PSCCH PHY Transport blocks and PSSCH PHY Transport blocks when the UE test loop mode E is activated.
Figure 5.1-11 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode F. The SC-PTM Packet Counter function for UE test loop mode F is specified in sub clause 5.4.4.d. The SC-PTM Packet Counter function is limited to count successfully received MBMS packets on one SC-MTCH configured by the SS when UE test loop mode F is activated.
Figure 5.1-12 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink via the EMM entity. Figure 5.1-13 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode G mode of operation is specified in sub clause 5.4.4e.
Figure 5.1-14 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink via the SM-TL entity (in a TPDU (SMS-SUBMIT)).
Figure 5.1-15 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode H mode of operation is specified in sub clause 5.4.4f.
Figure 5.1-16 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode I when IP PDU received in User data container content in a downlink ESM DATA TRANSFER message is returned in uplink via the EMM entity. The UE test loop mode I mode of operation is specified in sub clause 5.4.4g.
NOTE 7:	ROHC functionality in PDCP Layer 2 is optional for UE implementations.
Figure 5.1-1: Model for Test Control and UE Test Loop Mode A on UE side for E-UTRA and NB-IoT
Figure 5.1-2: Model for Test Control and UE Test Loop Mode B on UE side for E-UTRA and NB-IoT
Figure 5.1-3: Model for UE Test Loop Mode B on UE side for UTRA
Figure 5.1-4: Model for UE Test Loop Mode B on UE side for GSM/GPRS
Figure 5.1-5: Model for UE Test Loop Mode B on UE side for CDMA2000
Figure 5.1-6: Model for UE test loop mode C on UE side
Figure 5.1-7: Model for UE test loop mode D on UE side
(when Discovery monitor is indicated in the UE test loop mode D setup IE)
Figure 5.1-8: Model for UE test loop mode D on UE side 
(when Discovery announce is indicated in the UE test loop mode D setup IE)
Figure 5.1-9: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-9a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-10: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-10a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-11: Model for UE test loop mode F on UE side
Figure 5.1-12: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the EMM entity (before the UE uplink rate control entity)
Figure 5.1-13: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-14: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SM-TL entity
Figure 5.1-15: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-16: Model for UE test loop mode I on UE side configured to return downlink IP PDUs received in a ESM DATA TRANSFER message in uplink via the UE UL TFT handler to the EMM entity (before the UE uplink rate control entity)",TS 36.509,5.1,all_images/image_1426.jpeg,Model for UE test loop mode G on UE side configured to return downlink User data
"The UE test loop function provides access to isolated functions of the UE via the radio interface without introducing wherever possible new physical interfaces just for the reason of conformance testing.
NOTE 0:	One exception from the rule above is the UE test loop mode E and UTC time reset when used for V2X out-of-coverage test scenarios which require an additional physical interface for the transmission of AT commands. This has been based on the assumption that V2X devices will normally provide such interface for other than testing purposes e.g. for device configuration.
NOTE 1:	It should be emphasised that the UE test loop function only describes the functional behaviour of the UE with respect to its external interfaces; physical implementation of the UE test loop function is completely left open to the manufacturer.
The UE test loop function is activated by transmitting the appropriate TC message to the UE, see clause 6.
The UE test loop function can be operated in different loopback modes:
-	UE test loop mode A;
-	UE test loop mode B;
-	UE test loop mode C;
-	UE test loop mode D;
-	UE test loop mode E;
-	UE test loop mode F;
-	UE test loop mode G;
-	UE test loop mode H;
-	UE test loop mode I.
UE test loop mode A provides loopback of PDCP SDUs for bi-directional data radio bearers while UE is operating in E-UTRA or NB-IoT mode. The downlink PDCP SDUs received by the UE on each bi-directional data radio bearer are returned on the same radio bearer regardless of the PDCP SDU contents and of the TFT of the associated EPS bearer context [36].
UE test loop mode B provides loopback of PDCP SDUs (E-UTRA and UTRA), SNDCP PDUs (GSM/GPRS) and RLP PDUs (CDMA2000) for bi-directional EPS bearers while UE is operated in E-UTRA, NB-IoT, UTRA, GSM/GPRS or CDMA2000 modes. When operating in E-UTRA, NB-IoT, UTRA or GSM/GPRS then the downlink PDCP SDUs or SNDCP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer associated with an EPS bearer context with a TFT matching the TCP/UDP/IP protocol information within the PDCP SDU or SNDCP SDU [36]. When operating in CDMA2000 modes, the downlink RLP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer with the smallest identity, regardless of the RLP PDU content and of the TFT of the associated EPS bearer context.
NOTE 2:	When multiple PDN connections are established (or multiple Primary PDP Contexts are active), it is assumed that different IP addresses are allocated to the UE by the SS on each PDN.
UE test loop mode C provides counting of successfully received MBMS Packets on a given MTCH while UE is operating in E-MBMS/E-UTRA mode. For E-MBMS then one or more MTCHs are multiplexed on a MCH. MBMS packets for a MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode D provides means for announcing or monitoring of ProSe Direct Discovery messages on SL-DCH, as specified by the test loop mode D setup IE in the CLOSE UE TEST LOOP message. In particular, for discovery monitor operation, UE test loop mode D provides counting of successfully received SL-DCH MAC SDUs while the UE is operating in ProSe Direct Discovery/E-UTRA mode. For discovery announce operation, UE test loop mode D provides trigger for transmission of ProSe Direct Discovery message on SL-DCH.
NOTE 3:	UE test loop mode D is intended for RF/RRM testing purposes.
NOTE 4:	ProSe Direct Discovery messages on the PC5 interface are delivered as one MAC SDU per ProSe Direct Discovery message.
UE test loop mode E provides means for either transmit or receive of ProSe Direct or V2X Communication packets, as specified by the test loop mode E setup IE in the CLOSE UE TEST LOOP message. In particular, for communication receive operation, UE test loop mode E provides counting of successfully received STCH PDCP SDUs, PSCCH PHY transport blocks and PSSCH PHY transport blocks while the UE is operating in ProSe Direct or V2X Communication/E-UTRA mode. For communication transmit operation, UE test loop mode E provides trigger for transmission of ProSe Direct or V2X Communication packets. For the V2X out-of-coverage scenarios this trigger utilises AT commands and requires an appropriate physical interface.
NOTE 5:	Void
NOTE 6:	The Application trigger required to force the UE to start or stop a particular ProSe Service is out of the scope of the test loop modes D and E.
UE test loop mode F provides counting of successfully received MBMS Packets on a given SC-MTCH while UE is operating in SC-PTM/E-UTRA mode. For SC-PTM one SC-MTCH is transmitted on a DL-SCH. MBMS packets for a SC-MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode G provides loopback of the User data container content of any received downlink ESM DATA TRANSPORT message in uplink. The received data can be configured to be either returned via the UE EMM entity (before the UE uplink rate control entity) or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode G may be configured to delay the uplink loopback of user data. UE test loop mode G may also be configured to repeat the received user data of the User data container in uplink to generate higher data rates in uplink.
UE test loop mode H provides loopback of the TP-User-Data field (including the SMS user data) of any received downlink TPDU (SMS-DELIVER) in uplink. The received data can be configured to be either returned via the UE SM-TL entity or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode H may be configured to delay the uplink loopback of SMS user data. UE test loop mode H may also be configured to repeat the received SMS user data in uplink to generate higher data rates in uplink.
NOTE 7:	UE test loop mode G and H are intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
NOTE 8:	The delay timer for UE test loop mode G and H is triggered by the first reception of user data after the reception of a CLOSE UE TEST LOOP TC message. While the delay timer is running only the user data received in the latest ESM DATA TRANSPORT or SMS message is buffered.
NOTE 9:	The repetition of uplink transmission of uplink messages carrying data can be configured as 0 (no data returned), 1 (the same content and size of user date as received in downlink is returned) or value N > 1 (user data corresponding to N times repetition of the received user data is returned in uplink).
UE test loop mode I provides loopback of the IP PDUs received in User data container content of downlink ESM DATA TRANSPORT message in uplink via the UE uplink TFT hander and the UE EMM entity (before the UE uplink rate control entity).
NOTE 10:	UE test loop mode I is intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
UE test loop mode A is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in E-UTRA mode is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in UTRA mode is mandatory to all E-UTRA UEs supporting UTRA radio access.
UE test loop mode B for operation in GSM/GPRS mode is mandatory to all E-UTRA UEs supporting GSM/GPRS radio access.
UE test loop mode B for operation in CDMA2000 mode is mandatory to all E-UTRA UEs supporting CDMA2000 radio access.
UE test loop mode C is mandatory for E-UTRA UEs supporting E-MBMS.
UE test loop mode D is mandatory for E-UTRA UEs supporting ProSe Direct Discovery.
UE test loop mode E is mandatory for E-UTRA UEs supporting ProSe Direct or V2X Communication.
UE test loop mode F is mandatory for E-UTRA UEs supporting SC-PTM.
UE test loop mode G is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
UE test loop mode H is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using SMS.
UE test loop mode I is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
Support of UPDATE UE LOCATION INFORMATION is optional for all E-UTRA UEs with the exception of E-UTRA UEs supporting ProSe Direct Communication for which it is mandatory.
For E-UTRA UE supporting multiple radio access technologies then UE reception of Test Control messages is limited to UE operating in E-UTRA mode, while continuation of loopback of user data is provided over the change to other UE supported radio access technologies.
UE test loop mode B for operation in UTRA, GSM/GPRS and CDMA2000 mode is only applicable for loopback of user data in PS domain.
The TC entity may be seen as a L3 or a NAS entity.
Figure 5.1-1 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode A. The loopback of PDCP SDUs for UE test loop mode A is specified in sub clause 5.4.3.
Figure 5.1-2 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode B. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in E-UTRA mode is specified in subclauses 5.4.4.2 and 5.4.4.3.
Figure 5.1-3 shows a functional block diagram of UE test loop function for UE test loop mode B and UE operating in UTRA mode. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in UTRA mode is specified in subclauses 5.4.4.4 and 5.4.4.5.
Figure 5.1-4 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in GSM/GPRS mode. The loopback of IP PDUs/SNDCP SDUs for UE test loop mode B and UE in GSM/GPRS mode is specified in subclauses 5.4.4.6 and 5.4.4.7.
Figure 5.1-5 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in CDMA2000 mode. The loopback of IP PDUs/RLP SDUs for UE test loop mode B and UE in CDMA2000 mode is specified in subclauses 5.4.4.8 and 5.4.4.9.
Figure 5.1-6 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode C. The MBMS Packet Counter function for UE test loop mode C is specified in sub clause 5.4.4.a. The MBMS Packet Counter function is limited to count successfully received MBMS packets on one MTCH configured by the SS when UE test loop mode C is activated.
Figure 5.1-7 and Figure 5.1-8 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode D. The ProSe Direct Discovery Packet Counter function for UE test loop mode D is specified in clause 5.4.4b. The ProSe Direct Discovery packet counter function is limited to count successfully received SL-DCH MAC SDUs when UE test loop mode D is activated.
Figure 5.1-9 and Figure 5.1-10 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting ProSe Direct, or, V2X when UE is in in-coverage state. Figure 5.1-9a and Figure 5.1-10a show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting V2X when UE is in out-of-coverage state; the Electrical Man Machine Interface (EMMI) required for facilitating the AT commands transmission is specified in clause 8. The ProSe Direct or V2X Communication Packet Counter function for UE test loop mode E is specified in clause 5.4.4c. The ProSe Direct or V2X Communication packet counter function is limited to count successfully received STCH PDCP SDUs, PSCCH PHY Transport blocks and PSSCH PHY Transport blocks when the UE test loop mode E is activated.
Figure 5.1-11 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode F. The SC-PTM Packet Counter function for UE test loop mode F is specified in sub clause 5.4.4.d. The SC-PTM Packet Counter function is limited to count successfully received MBMS packets on one SC-MTCH configured by the SS when UE test loop mode F is activated.
Figure 5.1-12 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink via the EMM entity. Figure 5.1-13 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode G mode of operation is specified in sub clause 5.4.4e.
Figure 5.1-14 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink via the SM-TL entity (in a TPDU (SMS-SUBMIT)).
Figure 5.1-15 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode H mode of operation is specified in sub clause 5.4.4f.
Figure 5.1-16 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode I when IP PDU received in User data container content in a downlink ESM DATA TRANSFER message is returned in uplink via the EMM entity. The UE test loop mode I mode of operation is specified in sub clause 5.4.4g.
NOTE 7:	ROHC functionality in PDCP Layer 2 is optional for UE implementations.
Figure 5.1-1: Model for Test Control and UE Test Loop Mode A on UE side for E-UTRA and NB-IoT
Figure 5.1-2: Model for Test Control and UE Test Loop Mode B on UE side for E-UTRA and NB-IoT
Figure 5.1-3: Model for UE Test Loop Mode B on UE side for UTRA
Figure 5.1-4: Model for UE Test Loop Mode B on UE side for GSM/GPRS
Figure 5.1-5: Model for UE Test Loop Mode B on UE side for CDMA2000
Figure 5.1-6: Model for UE test loop mode C on UE side
Figure 5.1-7: Model for UE test loop mode D on UE side
(when Discovery monitor is indicated in the UE test loop mode D setup IE)
Figure 5.1-8: Model for UE test loop mode D on UE side 
(when Discovery announce is indicated in the UE test loop mode D setup IE)
Figure 5.1-9: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-9a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-10: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-10a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-11: Model for UE test loop mode F on UE side
Figure 5.1-12: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the EMM entity (before the UE uplink rate control entity)
Figure 5.1-13: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-14: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SM-TL entity
Figure 5.1-15: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-16: Model for UE test loop mode I on UE side configured to return downlink IP PDUs received in a ESM DATA TRANSFER message in uplink via the UE UL TFT handler to the EMM entity (before the UE uplink rate control entity)",TS 36.509,5.1,all_images/image_1428.jpeg,Model for UE test loop mode H on UE side configured to return the SMS user data
"The UE test loop function provides access to isolated functions of the UE via the radio interface without introducing wherever possible new physical interfaces just for the reason of conformance testing.
NOTE 0:	One exception from the rule above is the UE test loop mode E and UTC time reset when used for V2X out-of-coverage test scenarios which require an additional physical interface for the transmission of AT commands. This has been based on the assumption that V2X devices will normally provide such interface for other than testing purposes e.g. for device configuration.
NOTE 1:	It should be emphasised that the UE test loop function only describes the functional behaviour of the UE with respect to its external interfaces; physical implementation of the UE test loop function is completely left open to the manufacturer.
The UE test loop function is activated by transmitting the appropriate TC message to the UE, see clause 6.
The UE test loop function can be operated in different loopback modes:
-	UE test loop mode A;
-	UE test loop mode B;
-	UE test loop mode C;
-	UE test loop mode D;
-	UE test loop mode E;
-	UE test loop mode F;
-	UE test loop mode G;
-	UE test loop mode H;
-	UE test loop mode I.
UE test loop mode A provides loopback of PDCP SDUs for bi-directional data radio bearers while UE is operating in E-UTRA or NB-IoT mode. The downlink PDCP SDUs received by the UE on each bi-directional data radio bearer are returned on the same radio bearer regardless of the PDCP SDU contents and of the TFT of the associated EPS bearer context [36].
UE test loop mode B provides loopback of PDCP SDUs (E-UTRA and UTRA), SNDCP PDUs (GSM/GPRS) and RLP PDUs (CDMA2000) for bi-directional EPS bearers while UE is operated in E-UTRA, NB-IoT, UTRA, GSM/GPRS or CDMA2000 modes. When operating in E-UTRA, NB-IoT, UTRA or GSM/GPRS then the downlink PDCP SDUs or SNDCP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer associated with an EPS bearer context with a TFT matching the TCP/UDP/IP protocol information within the PDCP SDU or SNDCP SDU [36]. When operating in CDMA2000 modes, the downlink RLP PDUs received by the UE on all bi-directional data radio bearers are returned by the UE on the data radio bearer with the smallest identity, regardless of the RLP PDU content and of the TFT of the associated EPS bearer context.
NOTE 2:	When multiple PDN connections are established (or multiple Primary PDP Contexts are active), it is assumed that different IP addresses are allocated to the UE by the SS on each PDN.
UE test loop mode C provides counting of successfully received MBMS Packets on a given MTCH while UE is operating in E-MBMS/E-UTRA mode. For E-MBMS then one or more MTCHs are multiplexed on a MCH. MBMS packets for a MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode D provides means for announcing or monitoring of ProSe Direct Discovery messages on SL-DCH, as specified by the test loop mode D setup IE in the CLOSE UE TEST LOOP message. In particular, for discovery monitor operation, UE test loop mode D provides counting of successfully received SL-DCH MAC SDUs while the UE is operating in ProSe Direct Discovery/E-UTRA mode. For discovery announce operation, UE test loop mode D provides trigger for transmission of ProSe Direct Discovery message on SL-DCH.
NOTE 3:	UE test loop mode D is intended for RF/RRM testing purposes.
NOTE 4:	ProSe Direct Discovery messages on the PC5 interface are delivered as one MAC SDU per ProSe Direct Discovery message.
UE test loop mode E provides means for either transmit or receive of ProSe Direct or V2X Communication packets, as specified by the test loop mode E setup IE in the CLOSE UE TEST LOOP message. In particular, for communication receive operation, UE test loop mode E provides counting of successfully received STCH PDCP SDUs, PSCCH PHY transport blocks and PSSCH PHY transport blocks while the UE is operating in ProSe Direct or V2X Communication/E-UTRA mode. For communication transmit operation, UE test loop mode E provides trigger for transmission of ProSe Direct or V2X Communication packets. For the V2X out-of-coverage scenarios this trigger utilises AT commands and requires an appropriate physical interface.
NOTE 5:	Void
NOTE 6:	The Application trigger required to force the UE to start or stop a particular ProSe Service is out of the scope of the test loop modes D and E.
UE test loop mode F provides counting of successfully received MBMS Packets on a given SC-MTCH while UE is operating in SC-PTM/E-UTRA mode. For SC-PTM one SC-MTCH is transmitted on a DL-SCH. MBMS packets for a SC-MTCH are delivered as one RLC SDU per MBMS packet segmented into one or more RLC UMD PDUs.
UE test loop mode G provides loopback of the User data container content of any received downlink ESM DATA TRANSPORT message in uplink. The received data can be configured to be either returned via the UE EMM entity (before the UE uplink rate control entity) or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode G may be configured to delay the uplink loopback of user data. UE test loop mode G may also be configured to repeat the received user data of the User data container in uplink to generate higher data rates in uplink.
UE test loop mode H provides loopback of the TP-User-Data field (including the SMS user data) of any received downlink TPDU (SMS-DELIVER) in uplink. The received data can be configured to be either returned via the UE SM-TL entity or as a RLC SDU to the SRB RLC entity (SRB1bis for NB-IoT UE or to SRB2 for E-UTRA UE). UE test loop mode H may be configured to delay the uplink loopback of SMS user data. UE test loop mode H may also be configured to repeat the received SMS user data in uplink to generate higher data rates in uplink.
NOTE 7:	UE test loop mode G and H are intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
NOTE 8:	The delay timer for UE test loop mode G and H is triggered by the first reception of user data after the reception of a CLOSE UE TEST LOOP TC message. While the delay timer is running only the user data received in the latest ESM DATA TRANSPORT or SMS message is buffered.
NOTE 9:	The repetition of uplink transmission of uplink messages carrying data can be configured as 0 (no data returned), 1 (the same content and size of user date as received in downlink is returned) or value N > 1 (user data corresponding to N times repetition of the received user data is returned in uplink).
UE test loop mode I provides loopback of the IP PDUs received in User data container content of downlink ESM DATA TRANSPORT message in uplink via the UE uplink TFT hander and the UE EMM entity (before the UE uplink rate control entity).
NOTE 10:	UE test loop mode I is intended for control plane data testing for UEs supporting EPS services with Control Plane CIoT EPS optimization.
UE test loop mode A is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in E-UTRA mode is mandatory to all E-UTRA UEs and all NB-IoT UEs supporting user plane data transfer.
UE test loop mode B for operation in UTRA mode is mandatory to all E-UTRA UEs supporting UTRA radio access.
UE test loop mode B for operation in GSM/GPRS mode is mandatory to all E-UTRA UEs supporting GSM/GPRS radio access.
UE test loop mode B for operation in CDMA2000 mode is mandatory to all E-UTRA UEs supporting CDMA2000 radio access.
UE test loop mode C is mandatory for E-UTRA UEs supporting E-MBMS.
UE test loop mode D is mandatory for E-UTRA UEs supporting ProSe Direct Discovery.
UE test loop mode E is mandatory for E-UTRA UEs supporting ProSe Direct or V2X Communication.
UE test loop mode F is mandatory for E-UTRA UEs supporting SC-PTM.
UE test loop mode G is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
UE test loop mode H is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using SMS.
UE test loop mode I is mandatory for UEs supporting Control Plane CIoT EPS optimization and control plane data transfer using the ESM DATA TRANSFER procedure.
Support of UPDATE UE LOCATION INFORMATION is optional for all E-UTRA UEs with the exception of E-UTRA UEs supporting ProSe Direct Communication for which it is mandatory.
For E-UTRA UE supporting multiple radio access technologies then UE reception of Test Control messages is limited to UE operating in E-UTRA mode, while continuation of loopback of user data is provided over the change to other UE supported radio access technologies.
UE test loop mode B for operation in UTRA, GSM/GPRS and CDMA2000 mode is only applicable for loopback of user data in PS domain.
The TC entity may be seen as a L3 or a NAS entity.
Figure 5.1-1 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode A. The loopback of PDCP SDUs for UE test loop mode A is specified in sub clause 5.4.3.
Figure 5.1-2 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode B. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in E-UTRA mode is specified in subclauses 5.4.4.2 and 5.4.4.3.
Figure 5.1-3 shows a functional block diagram of UE test loop function for UE test loop mode B and UE operating in UTRA mode. The loopback of IP PDUs/PDCP SDUs for UE test loop mode B and UE in UTRA mode is specified in subclauses 5.4.4.4 and 5.4.4.5.
Figure 5.1-4 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in GSM/GPRS mode. The loopback of IP PDUs/SNDCP SDUs for UE test loop mode B and UE in GSM/GPRS mode is specified in subclauses 5.4.4.6 and 5.4.4.7.
Figure 5.1-5 shows a functional block diagram of UE test loop function for UE test loop mode B for UE operating in CDMA2000 mode. The loopback of IP PDUs/RLP SDUs for UE test loop mode B and UE in CDMA2000 mode is specified in subclauses 5.4.4.8 and 5.4.4.9.
Figure 5.1-6 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode C. The MBMS Packet Counter function for UE test loop mode C is specified in sub clause 5.4.4.a. The MBMS Packet Counter function is limited to count successfully received MBMS packets on one MTCH configured by the SS when UE test loop mode C is activated.
Figure 5.1-7 and Figure 5.1-8 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode D. The ProSe Direct Discovery Packet Counter function for UE test loop mode D is specified in clause 5.4.4b. The ProSe Direct Discovery packet counter function is limited to count successfully received SL-DCH MAC SDUs when UE test loop mode D is activated.
Figure 5.1-9 and Figure 5.1-10 show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting ProSe Direct, or, V2X when UE is in in-coverage state. Figure 5.1-9a and Figure 5.1-10a show a functional block diagram of the UE test loop mode for TC entity and UE test loop mode E for UE supporting V2X when UE is in out-of-coverage state; the Electrical Man Machine Interface (EMMI) required for facilitating the AT commands transmission is specified in clause 8. The ProSe Direct or V2X Communication Packet Counter function for UE test loop mode E is specified in clause 5.4.4c. The ProSe Direct or V2X Communication packet counter function is limited to count successfully received STCH PDCP SDUs, PSCCH PHY Transport blocks and PSSCH PHY Transport blocks when the UE test loop mode E is activated.
Figure 5.1-11 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode F. The SC-PTM Packet Counter function for UE test loop mode F is specified in sub clause 5.4.4.d. The SC-PTM Packet Counter function is limited to count successfully received MBMS packets on one SC-MTCH configured by the SS when UE test loop mode F is activated.
Figure 5.1-12 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink via the EMM entity. Figure 5.1-13 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode G when User data container content received in a downlink ESM DATA TRANSFER message is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode G mode of operation is specified in sub clause 5.4.4e.
Figure 5.1-14 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink via the SM-TL entity (in a TPDU (SMS-SUBMIT)).
Figure 5.1-15 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode H when TP-User-Data (SMS user data) received in a downlink TPDU (SMS-DELIVER) is configured to be returned in uplink in a RLC SDU via the SRB1bis/SRB2 RLC AM entity. The UE test loop mode H mode of operation is specified in sub clause 5.4.4f.
Figure 5.1-16 shows a functional block diagram of UE test loop function for TC entity and UE test loop mode I when IP PDU received in User data container content in a downlink ESM DATA TRANSFER message is returned in uplink via the EMM entity. The UE test loop mode I mode of operation is specified in sub clause 5.4.4g.
NOTE 7:	ROHC functionality in PDCP Layer 2 is optional for UE implementations.
Figure 5.1-1: Model for Test Control and UE Test Loop Mode A on UE side for E-UTRA and NB-IoT
Figure 5.1-2: Model for Test Control and UE Test Loop Mode B on UE side for E-UTRA and NB-IoT
Figure 5.1-3: Model for UE Test Loop Mode B on UE side for UTRA
Figure 5.1-4: Model for UE Test Loop Mode B on UE side for GSM/GPRS
Figure 5.1-5: Model for UE Test Loop Mode B on UE side for CDMA2000
Figure 5.1-6: Model for UE test loop mode C on UE side
Figure 5.1-7: Model for UE test loop mode D on UE side
(when Discovery monitor is indicated in the UE test loop mode D setup IE)
Figure 5.1-8: Model for UE test loop mode D on UE side 
(when Discovery announce is indicated in the UE test loop mode D setup IE)
Figure 5.1-9: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-9a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication receive is indicated in UE test loop mode E setup IE)
Figure 5.1-10: Model for UE test loop mode E on UE side ProSe Direct, or, V2X when UE is in in-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-10a: Model for UE test loop mode E on UE side based on AT commands V2X when UE is in out-of-coverage state
(when Communication transmit is indicated in the UE test loop mode E setup IE)
Figure 5.1-11: Model for UE test loop mode F on UE side
Figure 5.1-12: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the EMM entity (before the UE uplink rate control entity)
Figure 5.1-13: Model for UE test loop mode G on UE side configured to return downlink User data container content received in ESM DATA TRANSFER message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-14: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SM-TL entity
Figure 5.1-15: Model for UE test loop mode H on UE side configured to return the SMS user data received in the TPDU (SMS-DELIVER) received in the downlink RP-DATA message in uplink via the SRB1bis/SRB2 RLC AM entity
Figure 5.1-16: Model for UE test loop mode I on UE side configured to return downlink IP PDUs received in a ESM DATA TRANSFER message in uplink via the UE UL TFT handler to the EMM entity (before the UE uplink rate control entity)",TS 36.509,5.1,all_images/image_1430.jpeg,Model for UE test loop mode I on UE side configured to return downlink IP PDUs
"This clause defines a client application for access to the ATF as an alternative to the layer 3 definition provided in clause 5.9.1.
The UE ATF client application (or simply the “ATF test application”) to support LTE over-the-air radiated performance testing allows the UE:
-	to receive the ANTENNA INFORMATION REQUEST from the Test Platform
-	to respond to the Test Platform with the ANTENNA INFORMATION RESPONSE
The application needs to be tailored to the specific device which needs to support the underlying RSAP and RSARP ATF measurements in the device chipset.
For data-centric devices, the ATF test application is designed to run on a host laptop, e.g., USB modem plugged into the laptop, or configured by a host laptop tethered to the UE only for initial configuration as shown in Figure 9.1-1.
Figure 9.1-1: Tethered UE ATF Client Application Connection Diagram
For phones, notebooks, and tablets, the ATF test application is embedded by the vendor on the devices provided to the test lab for over-the-air radiated performance testing as shown in Figure 9.1-2.
Figure 9.1-2: Embedded UE ATF Client Application Connection Diagram
On launch of the ATF test application, the DUT listens on the IP address and UDP port configured on the test platform and wait for the test platform to initiate communication with the ATF test application.
The ATF test application communicates with the test platform using the commands detailed in clause 9.1.2 “Message Definitions and Contents”.
The ATF test application needs to have a user interface through which the user can configure the IP address and port number defined for use by the test platform. This configuration is stored across DUT power cycles.
The ANTENNA INFORMATION RESPONSE is expected to be sent by the UE within 1 s of the ANTENNA INFORMATION REQUEST.",TS 36.509,9.1,all_images/image_1431.jpeg,Tethered UE ATF Client Application Connection Diagram
"The description in this sub clause is a model and does not specify or restrict implementations.
RRC is generally in control of the LWAAP configuration.
Functions of the LWAAP sublayer are performed by LWAAP entities. For an LWAAP entity configured at the eNB, there is a peer LWAAP entity configured at the UE and vice versa. For all LWA bearers, there is one LWAAP entity in the eNB and one LWAAP entity in the UE.
An LWAAP entity receives/delivers LWAAP SDUs from/to upper layers (i.e. PDCP) and sends/receives LWAAP PDUs to/from its peer LWAAP entity via WLAN:
-	At the transmitting side, when an LWAAP entity receives an LWAAP SDU from upper layers, it constructs the corresponding LWAAP PDU and delivers it to lower layers;
-	At the receiving side, when an LWAAP entity receives an LWAAP PDU from lower layers, it reassembles the corresponding LWAAP SDU and delivers it to upper layers.
Figure 4.2.1-1 illustrates the overview model of the LWAAP sublayer.
Figure 4.2.1-1: Overview model of the LWAAP sublayer
An LWAAP entity delivers/receives the following LWAAP PDU to/from a lower layer entity:
-	LWAAP data PDU.",TS 36.360,4.2.1,all_images/image_1432.png,Overview model of the LWAAP sublayer
"Figure 8.2.6.2-1: UTDOA Information Exchange procedure, successful operation
The E-SMLC initiates the procedure by sending a UTDOA INFORMATION REQUEST message to the eNB. This message may contain the bandwidth and number of SRS transmissions desired. If the E-SMLC requests a number of SRS transmissions, the eNB may take this information into account when configuring SRS transmissions for the UE. The eNB shall reply with the UTDOA INFORMATION RESPONSE message.
The UTDOA INFORMATION RESPONSE message contains the SRS configuration for the UE. The eNB shall include the deltaSS IE in the UTDOA INFORMATION RESPONSE message whenever SRS sequence hopping is enabled for the requested measurement. If the deltaSS IE is received by the E-SMLC in the UTDOA INFORMATION RESPONSE message, the E-SMLC shall consider that SRS sequence hopping is enabled for that particular measurement.",TS 36.455,8.2.6.2,all_images/image_1433.jpeg,"UTDOA Information Exchange procedure, successful operation"
"The description in this sub clause is a model and does not specify or restrict implementations.
RRC is in control of the LWIPEP configuration.
Functions of the LWIPEP sublayer are performed by LWIPEP entities. For an LWIPEP entity configured at the eNB, there is a peer LWIPEP entity configured at the UE and vice versa. The LWIPEP entity responsible for encapsulating LWIPEP SDUs is referred to as the transmitter. The LWIPEP entity responsible for decapsulating LWIPEP PDUs is referred to as the receiver.
An LWIPEP entity receives/delivers LWIPEP SDUs from/to upper layers (i.e. IP) and sends/receives LWIPEP PDUs to/from its peer LWIPEP entity via an LWIP Tunnel and E-UTRA.
-	At the transmitting side, when an LWIPEP entity receives an LWIPEP SDU from upper layers, it constructs the corresponding LWIPEP PDU and delivers it to lower layers;
-	At the receiving side, when an LWIPEP entity receives an LWIPEP PDU from lower layers, it reassembles the corresponding LWIPEP SDU and delivers it to upper layers.
Figure 4.2.1-1 illustrates the overview model of the LWIPEP sublayer.
Figure 4.2.1-1: Overview model of the LWIPEP sublayer
An LWIPEP entity delivers/receives the following LWIPEP PDU to/from a lower layer entity:
-	LWIPEP data PDU.",TS 36.361,4.2.1,all_images/image_1435.png,Overview model of the LWIPEP sublayer
"In this option, the eNB monitors the DL TCP packet. After the eNB receives the RLC ACK from the UE, the eNB generates the TCP ACK. To avoid the UE and eNB generates TCP ACK for a same TCP packet, the UE can request the eNB to activate/deactivate this function. This option mainly reduces the period for the UE to send the TCP ACK.
Figure 5.3.4-1: example for eNB generate TCP ACK on behalf of the UE",TR 36.933,5.3.4,all_images/image_1439.png,example for eNB generate TCP ACK on behalf of the UE
"This solution is based on the current specification of the 3GPP system. In current 3GPP system, PCC-level signalling can already accomplish the communication of network QoS information to the client device (user equipment or UE) and therefore the DASH client can locally (within the UE) obtain the QoS information via internal APIs. The DASH server act as Application, which have knowledge of the application Function, type and of the MPD.
Following figure depicts an example PCC architecture delivering end-to-end QoS support for DASH services with the capability to interpret the media presentation description (MPD) in order to gain information on the application-layer parameters for DASH content. In the current PCC architecture, the application function (AF) interacts with the applications requiring dynamic policy and charging control. Hence, in order to provide QoS for DASH services, the AF can extract DASH content information from the MPD, map it into the appropriate attribute-value pairs (AVPs), and provide the AVPs to the policy and charging rules function (PCRF) over the Rx reference point. TS 26.247 Annex I describes such mapping. The PCRF combines the DASH-related AVPs received over the Rx reference point and the input received from the Gx and Gxa/Gxc reference points with user-specific policies data from the subscriber profile repository (SPR) to form session-level policy decisions and provides those to the PCEF and BBERF. In other words, the PCRF takes the subscriber information into account when setting QoS. Access-specific QoS parameters are then communicated to the UE from PCEF/BBERF. In particular, TS23.401 describes how the UE acquires QoS information during dedicated bearer activation and bearer modification with bearer QoS update. It is also noted in TS23.401 that ""The UE may provide EPS Bearer QoS parameters to the application handling the traffic flow. The application usage of the EPS Bearer QoS is implementation dependent.""
Figure 5.4.2.1-1: An example policy and charging control (PCC) architecture to deliver QoS for DASH services",TR 36.933,5.4.2.1,all_images/image_1440.jpeg,An example policy and charging control (PCC) architecture to deliver QoS for DASH
"8.1.2.12.1.1	Applicability rule and antenna connection for single carrier PDSCH tests with 2Rx and 4Rx
For 8Rx capable UEs, all single carrier tests specified in 8.2 to 8.8 with 2Rx are tested on any of the 2Rx supported RF bands by connecting 2 out of the 8Rx with data source from system simulator, and the other 6 Rx are connected with zero input, depending on UE’s declaration and AP configuration. Same requirements specified with 2Rx should be applied.
For 8Rx capable UEs, all single carrier test cases specified in 8.10 with 4Rx are tested on any of the 4Rx supported RF bands by connecting 4 out of 8 Rx with data source from system simulator, and the other 4 Rx are connected with zero input, depending on UE’s declaration and AP configuration. Same requirements specified with 4Rx should be applied.
For 8Rx capable UEs without support of any 4Rx RF bands, all single carrier tests specified in 8.10 with 4Rx are tested on any of the 8Rx supported RF bands by duplicating the fading channel from each Tx antenna and add independent noise for each Rx antenna. The SNR requirements should be applied with 1.5 dB less than the number specified for 4Rx tests.
For 8Rx capable UEs without support of any 2Rx and 4Rx RF bands, all single carrier tests specified in 8.2 to 8.8 with 2Rx are tested on any of the 8Rx supported RF bands by duplicating the fading channel from each Tx antenna and add independent noise for each Rx antenna. The SNR requirements should be applied with 3 dB less than the number specified for 2Rx tests.
For 8Rx capable UEs without support of any 2Rx RF bands but with support of 4Rx RF bands, all single carrier tests specified in 8.2 to 8.8 with 2Rx are tested on any of the 4Rx supported RF bands by duplicating the fading channel from each Tx antenna and add independent noise for each Rx antenna. 4 out of 8 Rx are connected with data source from system simulator, and the other 4 Rx are connected with zero input, depending on UE’s declaration and AP configuration. SNR requirements should be applied with 1.5 dB less than the number specified for 2Rx tests.
Figure 8.1.2.12.1-1 ~ Figure 8.1.2.12.1-4 show examples of antenna connection for 8Rx capable UE in any one 8Rx supported RF band to perform a 2Rx or 4Rx performance test with antenna configuration as 2x2 or 4x2 for 2Rx tests and 2x4 or 4x4 for 4Rx tests without interference for information.
Figure 8.1.2.12.1-1: Antenna connection example for 2Rx tests with antenna configuration as 2x2 without interference (informative)
Figure 8.1.2.12.1-2: Antenna connection example for 2Rx tests with antenna configuration as 4x2 without interference (informative)
Figure 8.1.2.12.1-3: Antenna connection example for 4Rx tests with antenna configuration as 2x4 without interference (informative)
Figure 8.1.2.12.1-4: Antenna connection example for 4Rx tests with antenna configuration as 4x4 without interference (informative)
For 8Rx capable UEs without any 2Rx supported RF bands, for all single carrier tests listed in Table 8.1.2.12.1-1 specified from 8.2 to 8.8 with 2Rx can be skipped.
Table 8.1.2.12.1-1: Requirement lists with 2Rx not applicable to 8Rx capable UEs
For 8Rx capable UEs without any 4Rx supported RF bands, for all single carrier tests listed in Table 8.1.2.12.1-2 specified in 8.10 with 4Rx can be skipped.
Table 8.1.2.12.1-2: Requirement lists with 4Rx not applicable to 8Rx capable UEs
For 8Rx capable UEs, if corresponding tests listed from the 8Rx test lists from Table 8.1.2.12.1-3 are tested, the test coverage can be considered fulfilled without executing the corresponding tests listed from botht the 4Rx test lists and the 2Rx test lists from Table 8.1.2.12.1-3.
For 8Rx capable UEs, if corresponding tests listed from the 4Rx test lists from Table 8.1.2.12.1-3 are tested, the test coverage can be considered fulfilled without executing the corresponding tests listed from the 2Rx test lists from Table 8.1.2.12.1-3.
Table 8.1.2.12.1-3: Applicability rules for single carrier tests with 2Rx
8.1.2.12.1.2	Applicability rule and antenna connection for single carrier PDSCH tests with 8Rx
For 8Rx capable UEs all single carrier tests specified in 8.14 with 8Rx are tested on any of the 8Rx supported RF bands by connecting all 8Rx with data source from system simulator.",TS 36.101,8.1.2.12.1,all_images/image_1442.jpeg,Antenna connection example for 2Rx tests with antenna configuration as 2x2
"8.1.2.12.1.1	Applicability rule and antenna connection for single carrier PDSCH tests with 2Rx and 4Rx
For 8Rx capable UEs, all single carrier tests specified in 8.2 to 8.8 with 2Rx are tested on any of the 2Rx supported RF bands by connecting 2 out of the 8Rx with data source from system simulator, and the other 6 Rx are connected with zero input, depending on UE’s declaration and AP configuration. Same requirements specified with 2Rx should be applied.
For 8Rx capable UEs, all single carrier test cases specified in 8.10 with 4Rx are tested on any of the 4Rx supported RF bands by connecting 4 out of 8 Rx with data source from system simulator, and the other 4 Rx are connected with zero input, depending on UE’s declaration and AP configuration. Same requirements specified with 4Rx should be applied.
For 8Rx capable UEs without support of any 4Rx RF bands, all single carrier tests specified in 8.10 with 4Rx are tested on any of the 8Rx supported RF bands by duplicating the fading channel from each Tx antenna and add independent noise for each Rx antenna. The SNR requirements should be applied with 1.5 dB less than the number specified for 4Rx tests.
For 8Rx capable UEs without support of any 2Rx and 4Rx RF bands, all single carrier tests specified in 8.2 to 8.8 with 2Rx are tested on any of the 8Rx supported RF bands by duplicating the fading channel from each Tx antenna and add independent noise for each Rx antenna. The SNR requirements should be applied with 3 dB less than the number specified for 2Rx tests.
For 8Rx capable UEs without support of any 2Rx RF bands but with support of 4Rx RF bands, all single carrier tests specified in 8.2 to 8.8 with 2Rx are tested on any of the 4Rx supported RF bands by duplicating the fading channel from each Tx antenna and add independent noise for each Rx antenna. 4 out of 8 Rx are connected with data source from system simulator, and the other 4 Rx are connected with zero input, depending on UE’s declaration and AP configuration. SNR requirements should be applied with 1.5 dB less than the number specified for 2Rx tests.
Figure 8.1.2.12.1-1 ~ Figure 8.1.2.12.1-4 show examples of antenna connection for 8Rx capable UE in any one 8Rx supported RF band to perform a 2Rx or 4Rx performance test with antenna configuration as 2x2 or 4x2 for 2Rx tests and 2x4 or 4x4 for 4Rx tests without interference for information.
Figure 8.1.2.12.1-1: Antenna connection example for 2Rx tests with antenna configuration as 2x2 without interference (informative)
Figure 8.1.2.12.1-2: Antenna connection example for 2Rx tests with antenna configuration as 4x2 without interference (informative)
Figure 8.1.2.12.1-3: Antenna connection example for 4Rx tests with antenna configuration as 2x4 without interference (informative)
Figure 8.1.2.12.1-4: Antenna connection example for 4Rx tests with antenna configuration as 4x4 without interference (informative)
For 8Rx capable UEs without any 2Rx supported RF bands, for all single carrier tests listed in Table 8.1.2.12.1-1 specified from 8.2 to 8.8 with 2Rx can be skipped.
Table 8.1.2.12.1-1: Requirement lists with 2Rx not applicable to 8Rx capable UEs
For 8Rx capable UEs without any 4Rx supported RF bands, for all single carrier tests listed in Table 8.1.2.12.1-2 specified in 8.10 with 4Rx can be skipped.
Table 8.1.2.12.1-2: Requirement lists with 4Rx not applicable to 8Rx capable UEs
For 8Rx capable UEs, if corresponding tests listed from the 8Rx test lists from Table 8.1.2.12.1-3 are tested, the test coverage can be considered fulfilled without executing the corresponding tests listed from botht the 4Rx test lists and the 2Rx test lists from Table 8.1.2.12.1-3.
For 8Rx capable UEs, if corresponding tests listed from the 4Rx test lists from Table 8.1.2.12.1-3 are tested, the test coverage can be considered fulfilled without executing the corresponding tests listed from the 2Rx test lists from Table 8.1.2.12.1-3.
Table 8.1.2.12.1-3: Applicability rules for single carrier tests with 2Rx
8.1.2.12.1.2	Applicability rule and antenna connection for single carrier PDSCH tests with 8Rx
For 8Rx capable UEs all single carrier tests specified in 8.14 with 8Rx are tested on any of the 8Rx supported RF bands by connecting all 8Rx with data source from system simulator.",TS 36.101,8.1.2.12.1,all_images/image_1443.png,Antenna connection example for 2Rx tests with antenna configuration as 4x2
"8.1.2.12.1.1	Applicability rule and antenna connection for single carrier PDSCH tests with 2Rx and 4Rx
For 8Rx capable UEs, all single carrier tests specified in 8.2 to 8.8 with 2Rx are tested on any of the 2Rx supported RF bands by connecting 2 out of the 8Rx with data source from system simulator, and the other 6 Rx are connected with zero input, depending on UE’s declaration and AP configuration. Same requirements specified with 2Rx should be applied.
For 8Rx capable UEs, all single carrier test cases specified in 8.10 with 4Rx are tested on any of the 4Rx supported RF bands by connecting 4 out of 8 Rx with data source from system simulator, and the other 4 Rx are connected with zero input, depending on UE’s declaration and AP configuration. Same requirements specified with 4Rx should be applied.
For 8Rx capable UEs without support of any 4Rx RF bands, all single carrier tests specified in 8.10 with 4Rx are tested on any of the 8Rx supported RF bands by duplicating the fading channel from each Tx antenna and add independent noise for each Rx antenna. The SNR requirements should be applied with 1.5 dB less than the number specified for 4Rx tests.
For 8Rx capable UEs without support of any 2Rx and 4Rx RF bands, all single carrier tests specified in 8.2 to 8.8 with 2Rx are tested on any of the 8Rx supported RF bands by duplicating the fading channel from each Tx antenna and add independent noise for each Rx antenna. The SNR requirements should be applied with 3 dB less than the number specified for 2Rx tests.
For 8Rx capable UEs without support of any 2Rx RF bands but with support of 4Rx RF bands, all single carrier tests specified in 8.2 to 8.8 with 2Rx are tested on any of the 4Rx supported RF bands by duplicating the fading channel from each Tx antenna and add independent noise for each Rx antenna. 4 out of 8 Rx are connected with data source from system simulator, and the other 4 Rx are connected with zero input, depending on UE’s declaration and AP configuration. SNR requirements should be applied with 1.5 dB less than the number specified for 2Rx tests.
Figure 8.1.2.12.1-1 ~ Figure 8.1.2.12.1-4 show examples of antenna connection for 8Rx capable UE in any one 8Rx supported RF band to perform a 2Rx or 4Rx performance test with antenna configuration as 2x2 or 4x2 for 2Rx tests and 2x4 or 4x4 for 4Rx tests without interference for information.
Figure 8.1.2.12.1-1: Antenna connection example for 2Rx tests with antenna configuration as 2x2 without interference (informative)
Figure 8.1.2.12.1-2: Antenna connection example for 2Rx tests with antenna configuration as 4x2 without interference (informative)
Figure 8.1.2.12.1-3: Antenna connection example for 4Rx tests with antenna configuration as 2x4 without interference (informative)
Figure 8.1.2.12.1-4: Antenna connection example for 4Rx tests with antenna configuration as 4x4 without interference (informative)
For 8Rx capable UEs without any 2Rx supported RF bands, for all single carrier tests listed in Table 8.1.2.12.1-1 specified from 8.2 to 8.8 with 2Rx can be skipped.
Table 8.1.2.12.1-1: Requirement lists with 2Rx not applicable to 8Rx capable UEs
For 8Rx capable UEs without any 4Rx supported RF bands, for all single carrier tests listed in Table 8.1.2.12.1-2 specified in 8.10 with 4Rx can be skipped.
Table 8.1.2.12.1-2: Requirement lists with 4Rx not applicable to 8Rx capable UEs
For 8Rx capable UEs, if corresponding tests listed from the 8Rx test lists from Table 8.1.2.12.1-3 are tested, the test coverage can be considered fulfilled without executing the corresponding tests listed from botht the 4Rx test lists and the 2Rx test lists from Table 8.1.2.12.1-3.
For 8Rx capable UEs, if corresponding tests listed from the 4Rx test lists from Table 8.1.2.12.1-3 are tested, the test coverage can be considered fulfilled without executing the corresponding tests listed from the 2Rx test lists from Table 8.1.2.12.1-3.
Table 8.1.2.12.1-3: Applicability rules for single carrier tests with 2Rx
8.1.2.12.1.2	Applicability rule and antenna connection for single carrier PDSCH tests with 8Rx
For 8Rx capable UEs all single carrier tests specified in 8.14 with 8Rx are tested on any of the 8Rx supported RF bands by connecting all 8Rx with data source from system simulator.",TS 36.101,8.1.2.12.1,all_images/image_1444.png,Antenna connection example for 4Rx tests with antenna configuration as 2x4
"8.1.2.12.1.1	Applicability rule and antenna connection for single carrier PDSCH tests with 2Rx and 4Rx
For 8Rx capable UEs, all single carrier tests specified in 8.2 to 8.8 with 2Rx are tested on any of the 2Rx supported RF bands by connecting 2 out of the 8Rx with data source from system simulator, and the other 6 Rx are connected with zero input, depending on UE’s declaration and AP configuration. Same requirements specified with 2Rx should be applied.
For 8Rx capable UEs, all single carrier test cases specified in 8.10 with 4Rx are tested on any of the 4Rx supported RF bands by connecting 4 out of 8 Rx with data source from system simulator, and the other 4 Rx are connected with zero input, depending on UE’s declaration and AP configuration. Same requirements specified with 4Rx should be applied.
For 8Rx capable UEs without support of any 4Rx RF bands, all single carrier tests specified in 8.10 with 4Rx are tested on any of the 8Rx supported RF bands by duplicating the fading channel from each Tx antenna and add independent noise for each Rx antenna. The SNR requirements should be applied with 1.5 dB less than the number specified for 4Rx tests.
For 8Rx capable UEs without support of any 2Rx and 4Rx RF bands, all single carrier tests specified in 8.2 to 8.8 with 2Rx are tested on any of the 8Rx supported RF bands by duplicating the fading channel from each Tx antenna and add independent noise for each Rx antenna. The SNR requirements should be applied with 3 dB less than the number specified for 2Rx tests.
For 8Rx capable UEs without support of any 2Rx RF bands but with support of 4Rx RF bands, all single carrier tests specified in 8.2 to 8.8 with 2Rx are tested on any of the 4Rx supported RF bands by duplicating the fading channel from each Tx antenna and add independent noise for each Rx antenna. 4 out of 8 Rx are connected with data source from system simulator, and the other 4 Rx are connected with zero input, depending on UE’s declaration and AP configuration. SNR requirements should be applied with 1.5 dB less than the number specified for 2Rx tests.
Figure 8.1.2.12.1-1 ~ Figure 8.1.2.12.1-4 show examples of antenna connection for 8Rx capable UE in any one 8Rx supported RF band to perform a 2Rx or 4Rx performance test with antenna configuration as 2x2 or 4x2 for 2Rx tests and 2x4 or 4x4 for 4Rx tests without interference for information.
Figure 8.1.2.12.1-1: Antenna connection example for 2Rx tests with antenna configuration as 2x2 without interference (informative)
Figure 8.1.2.12.1-2: Antenna connection example for 2Rx tests with antenna configuration as 4x2 without interference (informative)
Figure 8.1.2.12.1-3: Antenna connection example for 4Rx tests with antenna configuration as 2x4 without interference (informative)
Figure 8.1.2.12.1-4: Antenna connection example for 4Rx tests with antenna configuration as 4x4 without interference (informative)
For 8Rx capable UEs without any 2Rx supported RF bands, for all single carrier tests listed in Table 8.1.2.12.1-1 specified from 8.2 to 8.8 with 2Rx can be skipped.
Table 8.1.2.12.1-1: Requirement lists with 2Rx not applicable to 8Rx capable UEs
For 8Rx capable UEs without any 4Rx supported RF bands, for all single carrier tests listed in Table 8.1.2.12.1-2 specified in 8.10 with 4Rx can be skipped.
Table 8.1.2.12.1-2: Requirement lists with 4Rx not applicable to 8Rx capable UEs
For 8Rx capable UEs, if corresponding tests listed from the 8Rx test lists from Table 8.1.2.12.1-3 are tested, the test coverage can be considered fulfilled without executing the corresponding tests listed from botht the 4Rx test lists and the 2Rx test lists from Table 8.1.2.12.1-3.
For 8Rx capable UEs, if corresponding tests listed from the 4Rx test lists from Table 8.1.2.12.1-3 are tested, the test coverage can be considered fulfilled without executing the corresponding tests listed from the 2Rx test lists from Table 8.1.2.12.1-3.
Table 8.1.2.12.1-3: Applicability rules for single carrier tests with 2Rx
8.1.2.12.1.2	Applicability rule and antenna connection for single carrier PDSCH tests with 8Rx
For 8Rx capable UEs all single carrier tests specified in 8.14 with 8Rx are tested on any of the 8Rx supported RF bands by connecting all 8Rx with data source from system simulator.",TS 36.101,8.1.2.12.1,all_images/image_1445.png,Antenna connection example for 4Rx tests with antenna configuration as 4x4
"The description in this sub clause is a model and does not specify or restrict implementations.
RRC is generally in control of the RLC configuration. For NB-IoT, RRC configurable parameters are specified in RLC-Config-NB [5].
Functions of the RLC sub layer are performed by RLC entities. For a RLC entity configured at the eNB, there is a peer RLC entity configured at the UE and vice versa. For an RLC entity configured at the transmitting UE for STCH or SBCCH there is a peer RLC entity configured at each receiving UE for STCH or SBCCH.
An RLC entity receives/delivers RLC SDUs from/to upper layer and sends/receives RLC PDUs to/from its peer RLC entity via lower layers. An RLC PDU can either be a RLC data PDU (see sub clause 6.1.1) or a RLC control PDU (see sub clause 6.1.2). If an RLC entity receives RLC SDUs from upper layer, it receives them through a single SAP between RLC and upper layer, and after forming RLC data PDUs from the received RLC SDUs, the RLC entity delivers the RLC data PDUs to lower layer through a single logical channel. If an RLC entity receives RLC data PDUs from lower layer, it receives them through a single logical channel, and after forming RLC SDUs from the received RLC data PDUs, the RLC entity delivers the RLC SDUs to upper layer through a single SAP between RLC and upper layer. If an RLC entity delivers/receives RLC control PDUs to/from lower layer, it delivers/receives them through the same logical channel it delivers/receives the RLC data PDUs through.
An RLC entity can be configured to perform data transfer in one of the following three modes: Transparent Mode (TM), Unacknowledged Mode (UM) or Acknowledged Mode (AM). Consequently, an RLC entity is categorized as a TM RLC entity, an UM RLC entity or an AM RLC entity depending on the mode of data transfer that the RLC entity is configured to provide.
A TM RLC entity is configured either as a transmitting TM RLC entity or a receiving TM RLC entity. The transmitting TM RLC entity receives RLC SDUs from upper layer and sends RLC PDUs to its peer receiving TM RLC entity via lower layers. The receiving TM RLC entity delivers RLC SDUs to upper layer and receives RLC PDUs from its peer transmitting TM RLC entity via lower layers.
An UM RLC entity is configured either as a transmitting UM RLC entity or a receiving UM RLC entity. The transmitting UM RLC entity receives RLC SDUs from upper layer and sends RLC PDUs to its peer receiving UM RLC entity via lower layers. The receiving UM RLC entity delivers RLC SDUs to upper layer and receives RLC PDUs from its peer transmitting UM RLC entity via lower layers.
An AM RLC entity consists of a transmitting side and a receiving side. The transmitting side of an AM RLC entity receives RLC SDUs from upper layer and sends RLC PDUs to its peer AM RLC entity via lower layers. The receiving side of an AM RLC entity delivers RLC SDUs to upper layer and receives RLC PDUs from its peer AM RLC entity via lower layers.
Figure 4.2.1-1 illustrates the overview model of the RLC sub layer.
Figure 4.2.1-1: Overview model of the RLC sub layer
The following applies to all RLC entity types (i.e. TM, UM and AM RLC entity):
-	RLC SDUs of variable sizes which are byte aligned (i.e. multiple of 8 bits) are supported;
-	RLC PDUs are formed only when a transmission opportunity has been notified by lower layer (i.e. by MAC) and are then delivered to lower layer.
Description of different RLC entity types are provided below.",TS 36.322,4.2.1,all_images/image_1446.png,Overview model of the RLC sub layer
"A TM RLC entity can be configured to deliver/receive RLC PDUs through the following logical channels:
-	BCCH, BR-BCCH, DL/UL CCCH, PCCH and SBCCH.
Figure 4.2.1.1.1-1: Model of two transparent mode peer entities
A TM RLC entity delivers/receives the following RLC data PDU:
-	TMD PDU.",TS 36.322,4.2.1.1.1,all_images/image_1447.jpeg,Model of two transparent mode peer entities
"An UM RLC entity can be configured to deliver/receive RLC PDUs through the following logical channels:
-	DL/UL DTCH, MCCH, MTCH, SC-MCCH, SC-MTCH or STCH.
Figure 4.2.1.2.1-1: Model of two unacknowledged mode peer entities
An UM RLC entity delivers/receives the following RLC data PDU:
-	UMD PDU.
NOTE:	HARQ reordering is not applicable for MCCH, MTCH, SC-MCCH, SC-MTCH or STCH reception for sidelink communication.",TS 36.322,4.2.1.2.1,all_images/image_1448.jpeg,Model of two unacknowledged mode peer entities
"An AM RLC entity can be configured to deliver/receive RLC PDUs through the following logical channels:
-	DL/UL DCCH or DL/UL DTCH.
Figure 4.2.1.3.1-1: Model of an acknowledged mode enttiy
An AM RLC entity delivers/receives the following RLC data PDUs:
-	AMD PDU;
-	AMD PDU segment.
An AM RLC entity delivers/receives the following RLC control PDU:
-	STATUS PDU.",TS 36.322,4.2.1.3.1,all_images/image_1449.png,Model of an acknowledged mode enttiy
"AMD PDU consists of a Data field and an AMD PDU header.
AMD PDU header consists of a fixed part (fields that are present for every AMD PDU) and an extension part (fields that are present for an AMD PDU when necessary). The fixed part of the AMD PDU header itself is byte aligned and consists of a D/C, a RF, a P, a FI, an E and a SN. The extension part of the AMD PDU header itself is byte aligned and consists of E(s) and LI(s).
The transmitting side and the receiving side of an AM RLC entity are configured by RRC to use either a 10 bit SN or a 16 bit SN. The length of the fixed part of the AMD PDU header is two and three bytes respectively. The default values for SN field length used by an AM RLC entity is 10 bits.
An AMD PDU header consists of an extension part only when more than one Data field elements are present in the AMD PDU, in which case an E and a LI are present for every Data field element except the last. Furthermore, when an AMD PDU header consists of an odd number of LI(s) and the length of the LI field is 11 bits, four padding bits follow after the last LI. The default value for LI field length used by an AM RLC entity is 11 bits.
Figure 6.2.1.4-1: AMD PDU with 10 bit SN (length of LI field is 11 bits) (No LI)
Figure 6.2.1.4-1a: AMD PDU with 16 bit SN (length of LI field is 11 bits) (No LI)
Figure 6.2.1.4-2: AMD PDU with 10 bit SN (length of LI field is 11 bits) (Odd number of LIs, i.e. K = 1, 3, 5, …)
Figure 6.2.1.4-2a: AMD PDU with 16 bit SN (length of LI field is 11 bits) (Odd number of LIs, i.e. K = 1, 3, 5, …)
Figure 6.2.1.4-3: AMD PDU with 10 bit SN (length of LI field is 11 bits) (Even number of LIs, i.e. K = 2, 4, 6, …)
Figure 6.2.1.4-3a: AMD PDU with 16 bit SN (length of LI field is 11 bits) (Even number of LIs, i.e. K = 2, 4, 6, …)
Figure 6.2.1.4-4: AMD PDU with 10 bit SN (length of LI field is 15 bits)
Figure 6.2.1.4-4a: AMD PDU with 16 bit SN (length of LI field is 15 bits)",TS 36.322,6.2.1.4,all_images/image_1450.jpeg,"AMD PDU with 10 bit SN (length of LI field is 11 bits) (Odd number of LIs, i.e. K = 1, 3,"
"AMD PDU consists of a Data field and an AMD PDU header.
AMD PDU header consists of a fixed part (fields that are present for every AMD PDU) and an extension part (fields that are present for an AMD PDU when necessary). The fixed part of the AMD PDU header itself is byte aligned and consists of a D/C, a RF, a P, a FI, an E and a SN. The extension part of the AMD PDU header itself is byte aligned and consists of E(s) and LI(s).
The transmitting side and the receiving side of an AM RLC entity are configured by RRC to use either a 10 bit SN or a 16 bit SN. The length of the fixed part of the AMD PDU header is two and three bytes respectively. The default values for SN field length used by an AM RLC entity is 10 bits.
An AMD PDU header consists of an extension part only when more than one Data field elements are present in the AMD PDU, in which case an E and a LI are present for every Data field element except the last. Furthermore, when an AMD PDU header consists of an odd number of LI(s) and the length of the LI field is 11 bits, four padding bits follow after the last LI. The default value for LI field length used by an AM RLC entity is 11 bits.
Figure 6.2.1.4-1: AMD PDU with 10 bit SN (length of LI field is 11 bits) (No LI)
Figure 6.2.1.4-1a: AMD PDU with 16 bit SN (length of LI field is 11 bits) (No LI)
Figure 6.2.1.4-2: AMD PDU with 10 bit SN (length of LI field is 11 bits) (Odd number of LIs, i.e. K = 1, 3, 5, …)
Figure 6.2.1.4-2a: AMD PDU with 16 bit SN (length of LI field is 11 bits) (Odd number of LIs, i.e. K = 1, 3, 5, …)
Figure 6.2.1.4-3: AMD PDU with 10 bit SN (length of LI field is 11 bits) (Even number of LIs, i.e. K = 2, 4, 6, …)
Figure 6.2.1.4-3a: AMD PDU with 16 bit SN (length of LI field is 11 bits) (Even number of LIs, i.e. K = 2, 4, 6, …)
Figure 6.2.1.4-4: AMD PDU with 10 bit SN (length of LI field is 15 bits)
Figure 6.2.1.4-4a: AMD PDU with 16 bit SN (length of LI field is 15 bits)",TS 36.322,6.2.1.4,all_images/image_1452.png,"AMD PDU with 10 bit SN (length of LI field is 11 bits) (Even number of LIs, i.e. K = 2,"
"AMD PDU segment consists of a Data field and an AMD PDU segment header.
AMD PDU segment header consists of a fixed part (fields that are present for every AMD PDU segment) and an extension part (fields that are present for an AMD PDU segment when necessary). The fixed part of the AMD PDU segment header itself is byte aligned and consists of a D/C, a RF, a P, a FI, an E, a SN, a LSF and a SO. The extension part of the AMD PDU segment header itself is byte aligned and consists of E(s) and LI(s).
The transmitting side and the receiving side of an AM RLC entity are configured by RRC to use either a 10 bit SN or a 16 bit SN. When a 10 bit SN is used, the SO field is 15 bits, and when a 16 bit SN is used, the SO field is 16 bits. The length of the fixed part of the AMD PDU segment header is four and five bytes respectively. The default values for SN field length and SO field length used by an AM RLC entity are 10 bits and 15 bits, respectively.
An AMD PDU segment header consists of an extension part only when more than one Data field elements are present in the AMD PDU segment, in which case an E and a LI are present for every Data field element except the last. Furthermore, when an AMD PDU segment header consists of an odd number of LI(s) and the length of the LI field is 11 bits, four padding bits follow after the last LI. The default value for LI field length used by an AM RLC entity is 11 bits.
Figure 6.2.1.5-1: AMD PDU segment with 10 bit SN (No LI)
Figure 6.2.1.5-1a: AMD PDU segment with 16 bit SN and with 16 bit SO (No LI)
Figure 6.2.1.5-2: AMD PDU segment with 10 bit SN (length of LI field is 11 bits) (Odd number of LIs, i.e. K = 1, 3, 5, …)
Figure 6.2.1.5-2a: AMD PDU segment with 16 bit SN and with 16 bit SO (length of LI field is 11 bits) (Odd number of LIs, i.e. K = 1, 3, 5, …)
Figure 6.2.1.5-3: AMD PDU segment with 10 bit SN (length of LI field is 11 bits) (Even number of LIs, i.e. K = 2, 4, 6, …)
Figure 6.2.1.5-3a: AMD PDU segment with 16 bit SN and with 16 bit SO (length of LI field is 11 bits) (Even number of LIs, i.e. K = 2, 4, 6, …)
Figure 6.2.1.5-4: AMD PDU segment with 10 bit SN (length of LI field is 15 bits)
Figure 6.2.1.5-4a: AMD PDU segment with 16 bit SN and with 16 bit SO (length of LI field is 15 bits)",TS 36.322,6.2.1.5,all_images/image_1454.jpeg,AMD PDU segment with 10 bit SN (No LI)
"AMD PDU segment consists of a Data field and an AMD PDU segment header.
AMD PDU segment header consists of a fixed part (fields that are present for every AMD PDU segment) and an extension part (fields that are present for an AMD PDU segment when necessary). The fixed part of the AMD PDU segment header itself is byte aligned and consists of a D/C, a RF, a P, a FI, an E, a SN, a LSF and a SO. The extension part of the AMD PDU segment header itself is byte aligned and consists of E(s) and LI(s).
The transmitting side and the receiving side of an AM RLC entity are configured by RRC to use either a 10 bit SN or a 16 bit SN. When a 10 bit SN is used, the SO field is 15 bits, and when a 16 bit SN is used, the SO field is 16 bits. The length of the fixed part of the AMD PDU segment header is four and five bytes respectively. The default values for SN field length and SO field length used by an AM RLC entity are 10 bits and 15 bits, respectively.
An AMD PDU segment header consists of an extension part only when more than one Data field elements are present in the AMD PDU segment, in which case an E and a LI are present for every Data field element except the last. Furthermore, when an AMD PDU segment header consists of an odd number of LI(s) and the length of the LI field is 11 bits, four padding bits follow after the last LI. The default value for LI field length used by an AM RLC entity is 11 bits.
Figure 6.2.1.5-1: AMD PDU segment with 10 bit SN (No LI)
Figure 6.2.1.5-1a: AMD PDU segment with 16 bit SN and with 16 bit SO (No LI)
Figure 6.2.1.5-2: AMD PDU segment with 10 bit SN (length of LI field is 11 bits) (Odd number of LIs, i.e. K = 1, 3, 5, …)
Figure 6.2.1.5-2a: AMD PDU segment with 16 bit SN and with 16 bit SO (length of LI field is 11 bits) (Odd number of LIs, i.e. K = 1, 3, 5, …)
Figure 6.2.1.5-3: AMD PDU segment with 10 bit SN (length of LI field is 11 bits) (Even number of LIs, i.e. K = 2, 4, 6, …)
Figure 6.2.1.5-3a: AMD PDU segment with 16 bit SN and with 16 bit SO (length of LI field is 11 bits) (Even number of LIs, i.e. K = 2, 4, 6, …)
Figure 6.2.1.5-4: AMD PDU segment with 10 bit SN (length of LI field is 15 bits)
Figure 6.2.1.5-4a: AMD PDU segment with 16 bit SN and with 16 bit SO (length of LI field is 15 bits)",TS 36.322,6.2.1.5,all_images/image_1455.jpeg,"AMD PDU segment with 10 bit SN (length of LI field is 11 bits) (Odd number of LIs,"
"AMD PDU segment consists of a Data field and an AMD PDU segment header.
AMD PDU segment header consists of a fixed part (fields that are present for every AMD PDU segment) and an extension part (fields that are present for an AMD PDU segment when necessary). The fixed part of the AMD PDU segment header itself is byte aligned and consists of a D/C, a RF, a P, a FI, an E, a SN, a LSF and a SO. The extension part of the AMD PDU segment header itself is byte aligned and consists of E(s) and LI(s).
The transmitting side and the receiving side of an AM RLC entity are configured by RRC to use either a 10 bit SN or a 16 bit SN. When a 10 bit SN is used, the SO field is 15 bits, and when a 16 bit SN is used, the SO field is 16 bits. The length of the fixed part of the AMD PDU segment header is four and five bytes respectively. The default values for SN field length and SO field length used by an AM RLC entity are 10 bits and 15 bits, respectively.
An AMD PDU segment header consists of an extension part only when more than one Data field elements are present in the AMD PDU segment, in which case an E and a LI are present for every Data field element except the last. Furthermore, when an AMD PDU segment header consists of an odd number of LI(s) and the length of the LI field is 11 bits, four padding bits follow after the last LI. The default value for LI field length used by an AM RLC entity is 11 bits.
Figure 6.2.1.5-1: AMD PDU segment with 10 bit SN (No LI)
Figure 6.2.1.5-1a: AMD PDU segment with 16 bit SN and with 16 bit SO (No LI)
Figure 6.2.1.5-2: AMD PDU segment with 10 bit SN (length of LI field is 11 bits) (Odd number of LIs, i.e. K = 1, 3, 5, …)
Figure 6.2.1.5-2a: AMD PDU segment with 16 bit SN and with 16 bit SO (length of LI field is 11 bits) (Odd number of LIs, i.e. K = 1, 3, 5, …)
Figure 6.2.1.5-3: AMD PDU segment with 10 bit SN (length of LI field is 11 bits) (Even number of LIs, i.e. K = 2, 4, 6, …)
Figure 6.2.1.5-3a: AMD PDU segment with 16 bit SN and with 16 bit SO (length of LI field is 11 bits) (Even number of LIs, i.e. K = 2, 4, 6, …)
Figure 6.2.1.5-4: AMD PDU segment with 10 bit SN (length of LI field is 15 bits)
Figure 6.2.1.5-4a: AMD PDU segment with 16 bit SN and with 16 bit SO (length of LI field is 15 bits)",TS 36.322,6.2.1.5,all_images/image_1456.jpeg,"AMD PDU segment with 10 bit SN (length of LI field is 11 bits) (Even number of LIs,"
"AMD PDU segment consists of a Data field and an AMD PDU segment header.
AMD PDU segment header consists of a fixed part (fields that are present for every AMD PDU segment) and an extension part (fields that are present for an AMD PDU segment when necessary). The fixed part of the AMD PDU segment header itself is byte aligned and consists of a D/C, a RF, a P, a FI, an E, a SN, a LSF and a SO. The extension part of the AMD PDU segment header itself is byte aligned and consists of E(s) and LI(s).
The transmitting side and the receiving side of an AM RLC entity are configured by RRC to use either a 10 bit SN or a 16 bit SN. When a 10 bit SN is used, the SO field is 15 bits, and when a 16 bit SN is used, the SO field is 16 bits. The length of the fixed part of the AMD PDU segment header is four and five bytes respectively. The default values for SN field length and SO field length used by an AM RLC entity are 10 bits and 15 bits, respectively.
An AMD PDU segment header consists of an extension part only when more than one Data field elements are present in the AMD PDU segment, in which case an E and a LI are present for every Data field element except the last. Furthermore, when an AMD PDU segment header consists of an odd number of LI(s) and the length of the LI field is 11 bits, four padding bits follow after the last LI. The default value for LI field length used by an AM RLC entity is 11 bits.
Figure 6.2.1.5-1: AMD PDU segment with 10 bit SN (No LI)
Figure 6.2.1.5-1a: AMD PDU segment with 16 bit SN and with 16 bit SO (No LI)
Figure 6.2.1.5-2: AMD PDU segment with 10 bit SN (length of LI field is 11 bits) (Odd number of LIs, i.e. K = 1, 3, 5, …)
Figure 6.2.1.5-2a: AMD PDU segment with 16 bit SN and with 16 bit SO (length of LI field is 11 bits) (Odd number of LIs, i.e. K = 1, 3, 5, …)
Figure 6.2.1.5-3: AMD PDU segment with 10 bit SN (length of LI field is 11 bits) (Even number of LIs, i.e. K = 2, 4, 6, …)
Figure 6.2.1.5-3a: AMD PDU segment with 16 bit SN and with 16 bit SO (length of LI field is 11 bits) (Even number of LIs, i.e. K = 2, 4, 6, …)
Figure 6.2.1.5-4: AMD PDU segment with 10 bit SN (length of LI field is 15 bits)
Figure 6.2.1.5-4a: AMD PDU segment with 16 bit SN and with 16 bit SO (length of LI field is 15 bits)",TS 36.322,6.2.1.5,all_images/image_1458.png,AMD PDU segment with 10 bit SN (length of LI field is 15 bits)
"STATUS PDU consists of a STATUS PDU payload and a RLC control PDU header.
RLC control PDU header consists of a D/C and a CPT field.
The STATUS PDU payload starts from the first bit following the RLC control PDU header, and it consists of one ACK_SN and one E1, zero or more sets of a NACK_SN, an E1 and an E2, and possibly a set of a SOstart and a SOend for each NACK_SN. When necessary one to seven padding bits are included in the end of the STATUS PDU to achieve octet alignment.
Figure 6.2.1.6-1: STATUS PDU with 10 bit SN
Figure 6.2.1.6-2: STATUS PDU with 16 bit SN and with 16 bit SOstart and SOend fields",TS 36.322,6.2.1.6,all_images/image_1460.jpeg,STATUS PDU with 10 bit SN
"STATUS PDU consists of a STATUS PDU payload and a RLC control PDU header.
RLC control PDU header consists of a D/C and a CPT field.
The STATUS PDU payload starts from the first bit following the RLC control PDU header, and it consists of one ACK_SN and one E1, zero or more sets of a NACK_SN, an E1 and an E2, and possibly a set of a SOstart and a SOend for each NACK_SN. When necessary one to seven padding bits are included in the end of the STATUS PDU to achieve octet alignment.
Figure 6.2.1.6-1: STATUS PDU with 10 bit SN
Figure 6.2.1.6-2: STATUS PDU with 16 bit SN and with 16 bit SOstart and SOend fields",TS 36.322,6.2.1.6,all_images/image_1461.png,STATUS PDU with 16 bit SN and with 16 bit SOstart and SOend fields
"Figure 8.7.6.2-1: MeNB initiated SgNB Modification Preparation, successful operation
The MeNB initiates the procedure by sending the SGNB MODIFICATION REQUEST message to the en-gNB. When the MeNB sends the SGNB MODIFICATION REQUEST message, it shall start the timer TDCprep.
The SGNB MODIFICATION REQUEST message may contain:
-	within the UE Context Information IE (if the modification of the UE context at the en-gNB is requested);
-	E-RABs to be added within the E-RABs To Be Added Item IE;
-	E-RABs to be modified within the E-RABs To Be Modified Item IE;
-	E-RABs to be released within the E-RABs To Be Released Item IE;
-	the SgNB UE Aggregate Maximum Bit Rate IE;
-	the MeNB to SgNB Container IE;
-	the SCG Configuration Query IE;
-	the MeNB Resource Coordination Information IE;
-	the Requested split SRBs IE;
-	the Requested split SRBs release IE;
-	the Requested fast MCG recovery via SRB3 IE;
-	the Requested fast MCG recovery via SRB3 Release IE.
If the SGNB MODIFICATION REQUEST message contains the Serving PLMN IE, the en-gNB may use it for RRM purposes.
If the SGNB MODIFICATION REQUEST message contains the Handover Restriction List IE, the en-gNB shall
-	replace the previously provided Handover Restriction List by the received Handover Restriction List in the UE context;
-	use this information to select an appropriate NR cell.
If the SgNB UE Aggregate Maximum Bit Rate IE is included in the SGNB MODIFICATION REQUEST message, the en-gNB shall:
-	replace the previously provided SgNB UE Aggregate Maximum Bit Rate by the received SgNB UE Aggregate Maximum Bit Rate in the UE context;
-	use the received SgNB UE Aggregate Maximum Bit Rate for non-GBR Bearers for the concerned UE as defined in TS 37.340 [32].
The allocation of resources according to the values of the QCI IE, Allocation and Retention Priority IE or GBR QoS Information IE included in the Full E-RAB Level QoS Parameters IE or in the Requested SCG E-RAB Level QoS Parameters IE shall follow the principles described for the E-RAB Setup procedure in TS 36.413 [4].
If the SGNB MODIFICATION REQUEST message contains the MeNB Resource Coordination Information IE, the en-gNB should forward it to lower layers and it may use it for the purpose of resource coordination with the MeNB, or to coordinate with sidelink resources used in the MeNB. The en-gNB shall consider the received UL Coordination Information IE value valid until reception of a new update of the IE for the same UE. The en-gNB shall consider the received DL Coordination Information IE value valid until reception of a new update of the IE for the same UE. If the MeNB Coordination Assistance Information IE is contained in the MeNB Resource Coordination Information IE, the en-gNB shall, if supported, use the information to determine further coordination of resource utilisation between the en-gNB and the MeNB.
If at least one of the requested modifications is admitted by the en-gNB, the en-gNB shall modify the related part of the UE context accordingly and send the SGNB MODIFICATION REQUEST ACKNOWLEDGE message back to the MeNB.
The en-gNB shall include the E-RABs for which resources have been either added or modified or released at the en-gNB either in the E-RABs Admitted To Be Added List IE or the E-RABs Admitted To Be Modified List IE or the E-RABs Admitted To Be Released List IE. The en-gNB shall include the E-RABs that have not been admitted in the E-RABs Not Admitted List IE with an appropriate cause value.
For each E-RAB successfully established or modified or released in the en-gNB, the en-gNB shall report to the MeNB, in the SGNB MODIFICATION REQUEST ACKNOWLEDGE message, the same value in the EN-DC Resource Configuration IE as received in the SGNB MODIFICATION REQUEST message.
The en-gNB shall, if included, choose the ciphering algorithm based on the information in the NR UE Security Capabilities IE and locally configured priority list of AS encryption algorithms and apply the key indicated in the SgNB Security Key IE as specified in the TS 33.401 [18].
For each E-RAB for which allocation of the PDCP entity is requested at the en-gNB:
-	if applicable, the MeNB may propose to apply forwarding of downlink data by including the DL Forwarding IE within the E-RABs To Be Added Item IE of the SGNB MODIFICATION REQUEST message. For each E-RAB that it has decided to admit, the en-gNB may include the DL Forwarding GTP Tunnel Endpoint IE within the E-RABs Admitted To Be Added Item IE of the SGNB MODIFICATION REQUEST ACKNOWLEDGE message to indicate that it accepts the proposed forwarding of downlink data for this bearer. The MeNB may also provide for an applicable E-RAB to be released the DL Forwarding GTP Tunnel Endpoint IE and the UL Forwarding GTP Tunnel Endpoint IE within the E-RABs To Be Released Item IE of the SGNB MODIFICATION REQUEST message.
-	if applicable, the en-gNB may include for each bearer in the E-RABs Admitted To Be Added List IE in the SGNB MODIFICATION REQUEST ACKNOWLEDGE message the UL Forwarding GTP Tunnel Endpoint IE to indicate that it requests data forwarding of uplink packets to be performed for that bearer.
-	if applicable, the en-gNB may include for each bearer in the E-RABs Admitted To Be Modified List IE which is configured with the SN terminated split bearer option in the SGNB MODIFICATION REQUEST ACKNOWLEDGE message the UL Configuration IE to indicate that the MCG UL configuration of the UE has changed.
-	if applicable, the en-gNB may include for each bearer in the E-RABs Admitted To Be Added List IE in the SGNB MODIFICATION REQUEST ACKNOWLEDGE message the UL PDCP SN Length IE and the DL PDCP SN Length IE to indicate the PDCP SN length for that bearer.
-	If the Bearer Type IE for the concerned E-RAB is received by the en-gNB and is set to""non IP"", then the en-gNB shall, if supported, not perform IP header compression for the concerned E-RAB.
-	If the Ethernet Type IE for the concerned E-RAB is received by the en-gNB and is set to ""True"", the en-gNB shall take this into account to perform header compression appropriately for the concerned E-RAB.
For each E-RAB configured with SCG resources and the PDCP entity is hosted by the MeNB and
-	requested to be modified,
-	if the SGNB MODIFICATION REQUEST message includes the MeNB UL GTP Tunnel Endpoint at PDCP IE in the E-RABs To Be Modified Item IE, the en-gNB shall act as specified in TS 37.340 [32].
-	if the SGNB MODIFICATION REQUEST message contains the MeNB UL GTP Tunnel Endpoint at PDCP IE the en-gNB shall use it as the new UL X2-U address.
-	the en-gNB may include in the SGNB MODIFICATION REQUEST ACKNOWLEDGE message the SgNB DL GTP Tunnel Endpoint at SCG IE.
If, dependent on the configured bearer type, the Full E-RAB Level QoS Parameters IE or the Maximum MCG admittable E-RAB Level QoS Parameters IE or the Requested SCG E-RAB level QoS Parameters IE are included in the SGNB MODIFICATION REQUEST message for an E-RAB to be modified the en-gNB shall allocate respective resources and provide corresponding radio configuration information within the SgNB to MeNB Container IE as described in TS 37.340 [32].
If the SGNB MODIFICATION REQUEST message contains, for an E-RAB to be modified which is configured with the PDCP entity in the en-gNB, the S1 UL GTP Tunnel Endpoint IE, the en-gNB shall use it as the new UL S1-U address.
If the SGNB MODIFICATION REQUEST message contains an E-RAB to be modified which is configured with the MN terminated split bearer option, the MeNB may include the UL Configuration IE to indicate that the SCG UL configuration of the UE has changed.
If the SGNB MODIFICATION REQUEST message contains for an E-RAB to be modified which is configured with the PDCP enitiy in the en-gNB and MCG resources the MeNB DL GTP Tunnel Endpoint at MCG IE the en-gNB shall use it as the DL X2-U address.
If the SGNB MODIFICATION REQUEST message contains the Subscriber Profile ID for RAT/Frequency Priority IE, the en-gNB may use it for RRM purposes.
If the SGNB MODIFICATION REQUEST message contains the Additional RRM Policy Index IE, the en-gNB may use it for RRM purposes.
For an E-RAB to be modified which is configured with the PDCP entity in the en-gNB the en-gNB may include in the SGNB MODIFICATION REQUEST ACKNOWLEDGE message the S1 DL GTP Tunnel Endpoint at the SgNB IE.
If the SGNB MODIFICATION REQUEST ACKNOWLEDGE message contains the SgNB Resource Coordination Information IE, the MeNB may use it for the purpose of resource coordination with the en-gNB. The MeNB shall consider the received UL Coordination Information IE value valid until reception of a new update of the IE for the same UE. The MeNB shall consider the received DL Coordination Information IE value valid until reception of a new update of the IE for the same UE. If the SgNB Coordination Assistance Information IE is contained in the SgNB Resource Coordination Information IE, the MeNB shall, if supported, use the information to determine further coordination of resource utilisation between the en-gNB and the MeNB.
Upon reception of the SGNB MODIFICATION REQUEST ACKNOWLEDGE message the MeNB shall stop the timer TDCprep. If the SGNB MODIFICATION REQUEST ACKNOWLEDGE message has included the SgNB to MeNB Container IE the MeNB is then defined to have a Prepared SgNB Modification for that X2 UE-associated signalling.
If the SCG Configuration Query IE is included in the SGNB MODIFICATION REQUEST message, the en-gNB shall provide corresponding radio configuration information within the SgNB to MeNB Container IE as described in TS 37.340 [32].
If the SGNB MODIFICATION REQUEST message contains the Requested split SRBs IE, the en-gNB may use it to add split SRBs. If the SGNB MODIFICATION REQUEST message contains the Requested split SRBs release IE, the en-gNB may use it to release split SRBs.
If the Requested Fast MCG recovery via SRB3 IE set to ""true"" is included in the SGNB MODIFICATION REQUEST message and the en-gNB decides to configure fast MCG link recovery via SRB3 as specified in TS 37.340 [32], the en-gNB shall, if supported, include the Available fast MCG recovery via SRB3 IE set to ""true"" in the SGNB MODIFICATION REQUEST ACKNOWLEDGE message. If the Requested Fast MCG recovery via SRB3 Release IE set to ""true"" is included in the SGNB MODIFICATION REQUEST message and the en-gNB decides to release fast MCG link recovery via SRB3, the en-gNB shall, if supported, include the Release fast MCG recovery via SRB3 IE set to ""true"" in the SGNB MODIFICATION REQUEST ACKNOWLEDGE message.
If the en-gNB receives for an E-RAB to be setup for which the PDCP entiy is allocated at the MeNB the Secondary MeNB UL GTP Tunnel Endpoint at PDCP IE and the Duplication Activation IE in the SGNB MODIFICATION REQUEST message, it may provide the Secondary SgNB DL GTP Tunnel Endpoint at SCG IE and the LCID IE to the MeNB in the SGNB MODIFICATION REQUEST ACKNOWLEDGE message if PDCP duplication is configured at the en-gNB.
If the SGNB MODIFICATION REQUEST message contains the RLC Status IE, the en-gNB shall assume that RLC has been reestablished at the MeNB and may trigger PDCP data recovery.
If the en-gNB applied a full configuration or delta configuration, e.g. as part of a mobility procedure involving a change of DU, the en-gNB shall inform the MeNB by including the RRC config indication IE in the SGNB MODIFICATION REQUEST ACKNOWLEDGE message.
If SGNB MODIFICATION REQUEST message contains the UL PDCP SN Length IE and the DL PDCP SN Length IE, the en-gNB shall, if supported, store this information and use it for lower layer configuration of the concerned MN terminated bearer.
If the RLC Mode IE is included for an E-RAB within the E-RABs To be Added List IE in the SGNB MODIFICATION REQUEST message, it indicates the mode that the MeNB used for the E-RAB when it was hosted at the MeNB.
If the SGNB MODIFICATION REQUEST message contains the MeNB Cell ID IE, the en-gNB may search for the target NR cell among the NR neighbour cells of the E-UTRAN cell indicated in MeNB Cell ID IE, as specified in the TS 37.340 [32].
If the SGNB MODIFICATION REQUEST ACKNOWLEDGE message contains the RLC Status IE, the MeNB shall assume that RLC has been reestablished at the en-gNB and may trigger PDCP data recovery.
The en-gNB may include the Location Information at SgNB IE in the SGNB MODIFICATION REQUEST ACKNOWLEDGE message, if respective information is available at the en-gNB.
If the Location Information at en-gNB Reporting IE set to ""pscell"" is included in the SGNB MODIFICATION REQUEST, the SgNB shall start providing information about the current location of the UE. If the Location Information at SgNB IE is included in the SGNB MODIFICATION REQUEST ACKNOWLEDGE, the MeNB shall store the included information so that it may be transferred towards the MME.
If the Lower Layer presence status change IE set to ""release lower layers"" is included in the SGNB MODIFICATION REQUEST message, the en-gNB shall act as specified in TS 37.340 [32].
If the Lower Layer presence status change IE set to ""re-establish lower layers"" is included in the SGNB MODIFICATION REQUEST message, the en-gNB shall act as specified in TS 37.340 [32].
If the Lower Layer presence status change IE set to ""suspend lower layers"" is included in the SGNB MODIFICATION REQUEST message, the en-gNB shall act as specified in TS 37.340 [32].
If the Lower Layer presence status change IE set to ""resume lower layers"" is included in the SGNB MODIFICATION REQUEST message, the en-gNB shall act as specified in TS 37.340 [32].
If the SGNB MODIFICATION REQUEST message contains the IAB Node Indication IE, the en-gNB shall, if supported, consider that the request is for an IAB node.
For each E-RAB for which the Security Indication IE is included in the E-RABs To Be Added Item IE of the SGNB MODIFICATION REQUEST message:
-	if the Integrity Protection Indication IE is set to ""required"", the en-gNB shall, if supported, perform user plane integrity protection for the concerned E-RAB as specified in TS 33.401 [18], and otherwise it shall reject the addition of the concerned E-RAB with an appropriate cause value.
-	if the Integrity Protection Indication IE is set to ""preferred"", the en-gNB should perform user plane integrity protection for the concerned E-RAB as specified in TS 33.401 [18], and it shall notify the MeNB whether it performed the user plane integrity protection by including the Integrity Protection result IE in the Security Result IE of the SGNB MODIFICATION REQUEST ACKNOWLEDGE message.
-	if the Integrity Protection Indication IE is set to ""not needed"", the en-gNB shall not perform user plane integrity protection for the concerned E-RAB.
For each requested E-RAB configured as MN-terminated split bearer/SCG bearer, if the QoS Mapping Information IE is contained in the GTP Tunnel Endpoint IE in the SGNB MODIFICATION REQUEST ACKNOWLEDGE message, the MeNB shall, if supported, use it to set DSCP and/or flow label fields for the downlink IP packets which are transmitted from MeNB to SgNB through the GTP tunnels indicated by the GTP Tunnel Endpoint IE.
If the PSCell History Information Retrieve IE is included in the SGNB MODIFICATION REQUEST message, the en-gNB shall, if supported, use this information as specified in TS 37.340 [32].
If the UE History Information from the UE IE is included in the SGNB MODIFICATION REQUEST message, the en-gNB shall, if supported, store this information.
If the CHO Information SN Modification IE is included in the SGNB MODIFICATION REQUEST message, the en-gNB shall, if supported, consider that the MeNB initiated SgNB Modification Preparation procedure has been triggered as part of a conditional handover. If the Estimated Arrival Probability IE is contained in the CHO Information SN Modification IE included in the SGNB MODIFICATION REQUEST message, then the en-gNB may use the information to allocate necessary resources for the UE.
If the SCG Activation Request IE is included in the SGNB MODIFICATION REQUEST message, the en-gNB may use it to configure SCG resources as specified in TS 37.340 [32], and shall, if supported, include the SCG Activation Status IE in the SGNB MODIFICATION REQUEST ACKNOWLEDGE message.
If the Conditional PSCell Change Information Update IE is included in the SGNB MODIFICATION REQUEST message, the en-gNB shall, if supported, consider that the request provides the list of PSCells prepared at the target en-gNB, as described in TS 37.340 [32].
If the Conditional PSCell Addition Information Modification Request IE is included in the SGNB MODIFICATION REQUEST message, the en-gNB shall, if supported, consider that the request concerns an update of the previous CPAC preparation, as described in TS 37.340 [32]. Accordingly, the en-gNB shall, if supported, include the Conditional PSCell Addition Information Modification Acknowledge IE in the SGNB MODIFICATION REQUEST ACKNOWLEDGE message.
If the CG-CandidateList is included in the SgNB to MeNB Container IE in the SGNB MODIFICATION REQUEST ACKNOWLEDGE message, the MeNB shall, if supported, use it for the purpose of CPAC.
If the Estimated Arrival Probability IE is contained in the Conditional PSCell Information Modification Request IE included in the SGNB MODIFICATION REQUEST message, then the candidate target en-gNB node may use the information to allocate necessary resources for the incoming CPAC procedure.
If the Source DL Forwarding IP Address IE is included in the SGNB MODIFICATION REQUEST message, the en-gNB shall, if supported, store this information and use it as part of its ACL functionality configuration actions, if such ACL functionality is deployed.
If the Source DL Forwarding IP Address IE is included in the SGNB MODIFICATION REQUEST ACKNOWLEDGE message, the MeNB shall, if supported, store this information and use it as part of its ACL functionality configuration actions to identify source TNL address for data forwarding in case of subsequent handover preparation, if such ACL functionality is deployed.
Interactions with the MeNB initiated SgNB Modification procedure:
If the en-gNB provides for an E-RAB to be setup for which the PDCP entiy is allocated at the MeNB the Secondary SgNB DL GTP Tunnel Endpoint at SCG IE and the LCID IE to the MeNB in the SGNB MODIFICATION REQUEST ACKNOWLEDGE message and the MeNB has not provided the Secondary MeNB UL GTP Tunnel Endpoint at PDCP IE and the Duplication Activation IE in the SGNB MODIFICATION REQUEST message, the MeNB shall trigger the MeNB initiated SgNB Modification procedure to provide the Secondary MeNB UL GTP Tunnel Endpoint at PDCP IE and the Duplication Activation IE to the SgNB.
Interactions with the SgNB Reconfiguration Completion procedure:
If the en-gNB admits a modification of the UE context requiring the MeNB to report about the success of the RRC connection reconfiguration procedure, the en-gNB shall start the timer TDCoverall when sending the SGNB MODIFICATION REQUEST ACKNOWLEDGE message to the MeNB except for a request for conditional configuration. The reception of the SGNB RECONFIGURATION COMPLETE message shall stop the timer TDCoverall if TDCoverall is running.
Interaction with the Activity Notification procedure
Upon receiving an SGNB MODIFICATION REQUEST message containing the Desired Activity Notification Level IE, the en-gNB shall, if supported, use this information to decide whether to trigger subsequent SgNB Activity Notification procedures, or stop or modify ongoing triggering of these procedures due to a previous request.
Interaction with the SgNB initiated SgNB Modification Preparation procedure:
If the MeNB receives the SGNB MODIFICATION REQUIRED message and the requested SN modification procedure needs further information from MeNB, the MeNB shall send SGNB MODIFICATION REQUEST message to en-gNB in response to a previously SgNB initiated SgNB Modification procedure.",TS 36.423,8.7.6.2,all_images/image_1462.jpeg,"MeNB initiated SgNB Modification Preparation, successful operation"
"Figure 8.7.6.3-1: MeNB initiated SgNB Modification Preparation, unsuccessful operation
If the en-gNB does not admit any modification requested by the MeNB, or a failure occurs during the MeNB initiated SgNB Modfication Preparation, the en-gNB shall send the SGNB MODIFICATION REQUEST REJECT message to the MeNB. The message shall contain the Cause IE with an appropriate value.
If the en-gNB receives a SGNB MODIFICATION REQUEST message containing the MeNB to SgNB Container IE that does not include required information as specified in TS 38.331 [31], the en-gNB shall send the SGNB MODIFICATION REQUEST REJECT message to the MeNB.",TS 36.423,8.7.6.3,all_images/image_1463.jpeg,"MeNB initiated SgNB Modification Preparation, unsuccessful operation"
"Figure 8.7.7.2-1: SgNB initiated SgNB Modification, successful operation.
The en-gNB initiates the procedure by sending the SGNB MODIFICATION REQUIRED message to the MeNB. When the en-gNB sends the SGNB MODIFICATION REQUIRED message, it shall start the timer TDCoverall.
The SGNB MODIFICATION REQUIRED message may contain
-	the PDCP Change Indication IE;
-	the SgNB to MeNB Container IE.
-	E-RABs to be modified within the E-RABs To Be Modified Item IE;
-	E-RABs to be released within the E-RABs To Be Released Item IE;
-	the SgNB Resource Coordination Information IE.
For the SN terminated split bearers, the en-gNB may include in the SGNB MODIFICATION REQUIRED message the UL Configuration IE to indicate that the MCG UL configuration of the UE has changed.
The en-gNB may include for each bearer in the E-RABs to Be Modified List IE in the SGNB MODIFICATION REQUIRED message the New DRB ID Request IE to request the MeNB to assign a new DRB ID for that bearer.
If the MeNB is able to perform the change requested by the en-gNB, the MeNB shall send the SGNB MODIFICATION CONFIRM message to the en-gNB. The SGNB MODIFICATION CONFIRM message may contain the MeNB to SgNB Container IE.
If the SGNB MODIFICATION REQUIRED message contains the SgNB Resource Coordination Information IE, the MeNB may use it for the purpose of resource coordination with the en-gNB. The MeNB shall consider the received UL Coordination Information IE value valid until reception of a new update of the IE for the same UE. The MeNB shall consider the received DL Coordination Information IE value valid until reception of a new update of the IE for the same UE. If the SgNB Coordination Assistance Information IE is contained in the SgNB Resource Coordination Information IE, the MeNB shall, if supported, use the information to determine further coordination of resource utilisation between the en-gNB and the MeNB.
If the en-gNB applied a full configuration or delta configuration, e.g. as part of a mobility procedure involving a change of DU, the en-gNB shall inform the MeNB by including the RRC config indication IE in the SGNB MODIFICATION REQUIRED message.
For each E-RAB successfully modified as requested by the en-gNB, the MeNB shall inform the en-gNB, in the SGNB MODIFICATION CONFIRM message, the same value in the EN-DC Resource Configuration IE as received in the SGNB MODIFICATION REQUIRED message.
If the SCG resources IE in the EN-DC Resource Configuration IE in the SGNB MODIFICATION REQUIRED message for all the E-RABs of the UE are set to “not present”, the MeNB shall, if supported, deduce that the SCG resources are removed.
Upon reception of the SGNB MODIFICATION CONFIRM message the en-gNB shall stop the timer TDCoverall.
If the SGNB MODIFICATION CONFIRM message contains the MeNB Resource Coordination Information IE, the en-gNB should forward it to lower layers and it may use it for the purpose of resource coordination with the MeNB, or to coordinate with sidelink resources used in the MeNB. The en-gNB shall consider the received UL Coordination Information IE value valid until reception of a new update of the IE for the same UE. The en-gNB shall consider the received DL Coordination Information IE value valid until reception of a new update of the IE for the same UE. If the MeNB Coordination Assistance Information IE is contained in the MeNB Resource Coordination Information IE, the en-gNB shall, if supported, use the information to determine further coordination of resource utilisation between the en-gNB and the MeNB.
If the MeNB receives for an E-RAB for which the PDCP entiy is allocated at the MeNB the Secondary SgNB DL GTP Tunnel Endpoint at SCG IE in the SGNB MODIFICATION REQUIRED message, it shall provide the Secondary MeNB UL GTP Tunnel Endpoint at PDCP IE to the en-gNB in the SGNB MODIFICATION CONFIRM message. If the LCID IE is included in the SGNB MODIFICATION REQUIRED message, the MeNB should take it into account.
If the SGNB MODIFICATION REQUIRED message contains the RLC Status IE, the MeNB shall assume that RLC has been reestablished at the en-gNB and may trigger PDCP data recovery.
If the RLC Mode IE is included for an E-RAB within the E-RABs To Be Released List IE (for E-RABs hosted at the en-gNB) in the SGNB MODIFICATION REQUIRED message, it indicates the mode that the en-gNB used for the E-RAB when it was hosted at the en-gNB.
The MeNB shall include only E-RABs with the following IE in E-RABs Admitted To Be Modified List IE:
-	the Secondary MeNB UL GTP Tunnel Endpoint at PDCP IE.
If the Location Information at SgNB IE is included in the SGNB MODIFICATION REQUIRED, the MeNB shall store the included information so that it may be transferred towards the MME.
For each requested E-RAB configured as MN-terminated split bearer/SCG bearer, if the QoS Mapping Information IE is included in the GTP Tunnel Endpoint IE in the SGNB MODIFICATION REQUIRED message, the MeNB shall, if supported, use it to set DSCP and/or flow label fields for the downlink IP packets which are transmitted from MeNB to SgNB through the GTP tunnels indicated by the GTP Tunnel Endpoint IE.
If the SGNB MODIFICATION REQUIRED message includes the SCG UE History Information IE, the MeNB shall, if supported, use the information to update the UE History Information with PSCell history.
If the SCG Activation Request IE is included in the SGNB MODIFICATION REQUIRED message, the MeNB shall, if supported, consider that the en-gNB node is about to reconfigure the SCG resources as specified in TS 37.340 [32].
If the CPAC Information Required IE is included in the SGNB MODIFICATION REQUIRED message, the MeNB shall, if supported, consider that the request provides the configuration update for the list of PSCells prepared at the target en-gNB, as described in TS 37.340 [32].
If the CG-CandidateList is included in the SgNB to MeNB Container IE in the SGNB MODIFICATION REQUIRED message, the MeNB shall, if supported, use it for the purpose of CPAC.
If the SCG Reconfiguration Notification IE is included in the SGNB MODIFICATION REQUIRED message, the MeNB shall, if supported, consider the request is sent to coordinate CHO or MN-initiated CPC with SCG reconfigurations:
-	If the SCG Reconfiguration Notification IE is set to ""executed"", the MeNB shall, if supported, consider that a reconfiguration of the SCG resources using SRB3 has been executed. If the SgNB to MeNB Container IE is also included in the SGNB MODIFICATION REQUIRED message, the MeNB shall, if supported, consider that the received SCG configuration has already been applied in the UE and should not be forwarded to the UE.
-	If the SCG Reconfiguration Notification IE is set to ""executed-deleted"", the MeNB shall, if supported, consider that a reconfiguration with sync of the SCG resources has been executed and earlier CHO or MN-initiated CPC configuration has been deleted in the UE. If the SgNB to MeNB Container IE is also included in the SGNB MODIFICATION REQUIRED message, the MeNB shall, if supported, consider that the received SCG configuration has already been applied in the UE and should not be forwarded to the UE.
-	If the SCG Reconfiguration Notification IE is set to ""deleted"", the MeNB shall, if supported, consider that an earlier CHO or MN-initiated CPC configuration will be deleted in the UE when the SCG configuration provided in the SgNB to MeNB Container IE is delivered to the UE and executed.
Interaction with the MeNB initiated SgNB Modification Preparation procedure:
If applicable, as specified in TS 37.340 [32], the en-gNB may receive, after having initiated the SgNB initiated SgNB Modification procedure, the SGNB MODIFICATION REQUEST message including the DL Forwarding GTP Tunnel Endpoint IE and the UL Forwarding GTP Tunnel Endpoint IE within the E-RABs To Be Released List IE.
If applicable, as specified in TS 37.340 [32], the en-gNB may receive, after having initiated the SgNB initiated SgNB Modification procedure, the SGNB MODIFICATION REQUEST message including the SgNB Security Key IE within the UE Context Information IE.
If applicable, as specified in TS 37.340 [32], the en-gNB may receive, after having initiated the SgNB initiated SgNB Modification procedure, the SGNB MODIFICATION REQUEST message including the measGapConfig contained in the CG-ConfigInfo message as defined in TS 38.331 [31] within the MeNB to SgNB Container IE.
The en-gNB may receive, after having initiated the SgNB initiated SgNB modification procedure including the New DRB ID Request IE for an SN terminated bearer within the E-RABs To Be Modified List IE, the SGNB MODIFICATION REQUEST message to release and add the same bearer with a new DRB ID or with the same DRB ID but together with the SgNB Security Key IE within the UE Context Information IE.
The en-gNB may receive, after having initiated the SgNB initiated SgNB modification procedure, the SGNB MODIFICATION REQUEST message including the SN triggered IE.",TS 36.423,8.7.7.2,all_images/image_1464.jpeg,"SgNB initiated SgNB Modification, successful operation."
"Figure 8.7.7.3-1: SgNB initiated SgNB Modification, unsuccessful operation.
In case the requested modification cannot be performed successfully the MeNB shall respond with the SGNB MODIFICATION REFUSE message to the en-gNB with an appropriate cause value in the Cause IE.
The MeNB may also provide configuration information in the MeNB to SgNB Container IE.",TS 36.423,8.7.7.3,all_images/image_1465.jpeg,"SgNB initiated SgNB Modification, unsuccessful operation."
"For the purposes of the present document, the following symbols apply:
	Roll-off factor
β	Percentage of the mean transmitted power emitted outside the occupied bandwidth on the assigned channel
BWChannel	Channel bandwidth
BWChannel_CA	Aggregated Channel Bandwidth, expressed in MHz. BWChannel_CA= Fedge_high- Fedge_low.
BWChannel,block	Sub-block bandwidth, expressed in MHz. BWChannel,block= Fedge,block,high- Fedge,block,low.
BWConfig	Transmission bandwidth configuration, expressed in MHz, where BWConfig = NRB x 180 kHz in the uplink and BWConfig = 15 kHz + NRB x 180 kHz in the downlink.
BWmax	Maximum Radio Bandwidth
BWtot	Total RF Bandwidth
CA_X	Intra-band contiguous CA of component carriers in one sub-block within band X where X is the applicable E-UTRA operating band
CA_X-X	Intra-band non-contiguous CA of component carriers in two sub-blocks within band X where X is the applicable E-UTRA operating band
CA_X-Y	Inter-band CA of component carrier(s) in one sub-blocks within band X and component carrier(s) in one sub-block within Band Y where X and Y are the applicable E-UTRA operating bands
CA_X-X-Y	CA of component carriers in two sub-blocks within Band X and component carrier(s) in one sub-block within Band Y where X and Y are the applicable E-UTRA operating bands
f	Frequency
f	Separation between the channel edge frequency and the nominal -3dB point of the measuring filter closest to the carrier frequency
fmax 	The largest value of f used for defining the requirement
FC	Carrier centre frequency
FC,block, high	Centre frequency of the highest transmitted/received carrier in a sub-block.
FC,block, low	Centre frequency of the lowest transmitted/received carrier in a sub-block.
FC_high 	The carrier centre frequency of the highest carrier, expressed in MHz.
FC_low 	The carrier centre frequency of the lowest carrier, expressed in MHz.
Fedge_low 	The lower edge of Aggregated Channel Bandwidth, expressed in MHz. Fedge_low = FC_low - Foffset.
Fedge_high 	The upper edge of Aggregated Channel Bandwidth, expressed in MHz. Fedge_high = FC_high + Foffset.
Fedge,block,low 	The lower sub-block edge, where Fedge,block,low = FC,block,low - Foffset.
Fedge,block,high 	The upper sub-block edge, where Fedge,block,high = FC,block,high + Foffset.
Foffset 	Frequency offset from FC_high to the upper Base Station RF Bandwidth edge or from F C,block, high to the upper sub-block edge, FC_low to the lower Base Station RF Bandwidth edge or from FC,block, low to the lower sub-block edge.
Ffilter	Filter centre frequency
f_offset 	Separation between the channel edge frequency and the centre of the measuring filter
f_offsetmax 	The maximum value of f_offset used for defining the requirement
EA: 	EPRE (energy per resource element) of PDSCH REs (resource elements) type A, i.e. REs in OFDM symbols that do not include reference symbols
EB: 	EPRE of PDSCH REs type B, i.e. REs in OFDM symbols that include reference symbols
ERS:	EPRE of reference symbols REs
FDL_low	The lowest frequency of the downlink operating band
FDL_high	The highest frequency of the downlink operating band
FUL_low	The lowest frequency of the uplink operating band
FUL_high	The highest frequency of the uplink operating band
MDL	Offset of NB-IoT Downlink channel number to Downlink EARFCN
MUL	Offset of NB-IoT Uplink channel number to Uplink EARFCN
NDL 	Downlink EARFCN
NOffs-DL 	Offset used for calculating downlink EARFCN
NOffs-UL 	Offset used for calculating uplink EARFCN
Physical layer cell identity
NCS	Number of Cyclic shifts for preamble generation in PRACH
NRB	Transmission bandwidth configuration, expressed in units of resource blocks
Downlink bandwidth configuration, expressed in multiples of
NUL 	Uplink EARFCN
Resource block size in the frequency domain, expressed as a number of subcarriers
System frame number
Physical resource block number
Radio network temporary identifier
Slot number within a radio frame
Antenna port number
Pd	Probability of PRACH preamble detection
Pfa	Total probability of false detection of the PRACH preamble
Pout	Output power
PEM,N	Declared emission level for channel N
PEM,B32,B75,B76,ind	Declared emission level in Band 32, Band 75 and Band 76, ind=a, b, c
PEM,B32,ind	Declared emission level in Band 32, ind= d, e
PEM,B50,B74,B75,ind	Declared emission level for Band 50, Band 74 and Band 75, ind=a,b
Prated,c	Rated output power (per carrier)
Prated,t	Rated Total Output PowerPmax,c	Maximum carrier output power
PREFSENS	Reference sensitivity power level
Code word number
TA	Timing advance command, as defined in [16]
Basic time unit, as defined in [12]
Wgap	Sub-block gap or Inter RF Bandwidth gap size
Figure 3.2-1: Illustration of Maximum Radio Bandwidth BWmax and Total RF Bandwidth BWtot for multi-band base station",TS 36.141,3.2,all_images/image_1467.jpeg,Illustration of Maximum Radio Bandwidth BWmax and Total RF Bandwidth BWtot for multi-
"Except for NB-IoT, figure 5.2.2-1 shows the states and state transitions and procedures in RRC_IDLE. Whenever a new PLMN selection is performed, it causes an exit to number 1.
Figure 5.2.2-1: RRC_IDLE Cell Selection and Reselection
For NB-IoT, figure 5.2.2-2 shows the states and state transitions and procedures in RRC_IDLE. Whenever a new PLMN selection is performed, it causes an exit to number 1.
Figure 5.2.2-2: RRC_IDLE Cell Selection and Reselection for NB-IoT",TS 36.304,5.2.2,all_images/image_1472.jpeg,RRC_IDLE Cell Selection and Reselection for NB-IoT
"For antenna port 5, in a physical resource block with frequency-domain index  assigned for the corresponding PDSCH transmission, the reference signal sequence  shall be mapped to complex-valued modulation symbols  with  in a subframe according to:
Normal cyclic prefix:
Extended cyclic prefix:
where  is the counter of UE-specific reference signal resource elements within a respective OFDM symbol of the PDSCH transmission.
The cell-specific frequency shift is given by .
The mapping shall be in increasing order of the frequency-domain index  of the physical resource blocks assigned for the corresponding PDSCH transmission. The quantity  denotes the assigned bandwidth in resource blocks of the corresponding PDSCH transmission.
Figure 6.10.3.2-1 illustrates the resource elements used for UE-specific reference signals for normal cyclic prefix for antenna port 5.
Figure 6.10.3.2-2 illustrates the resource elements used for UE-specific reference signals for extended cyclic prefix for antenna port 5.
The notation  is used to denote a resource element used for reference signal transmission on antenna port.
Figure 6.10.3.2-1: Mapping of UE-specific reference signals, antenna port 5 (normal cyclic prefix)
Figure 6.10.3.2-2: Mapping of UE-specific reference signals, antenna port 5 (extended cyclic prefix)
For antenna ports , , , , , , or  the antenna ports indicated in Table 6.3.4.4-1 in a physical resource block with frequency-domain index  assigned for the corresponding PDSCH transmission, a part of the reference signal sequence  shall be mapped to complex-valued modulation symbols  in a subframe according to
Normal cyclic prefix:
where
The sequence  is given by Table 6.10.3.2-1.
Table 6.10.3.2-1: The sequence  for normal cyclic prefix
Extended cyclic prefix:
where
The sequence  is given by Table 6.10.3.2-2.
Table 6.10.3.2-2: The sequence  for extended cyclic prefix and for slot/subslot-PDSCH
For extended cyclic prefix, UE-specific reference signals are not supported on antenna ports 9 to 14.
For slot-PDSCH transmission, the baseline pattern (see 'Baseline' in Figure 6.10.3.2-2A) of UE-specific reference signals is defined as follows. It is applied in MBSFN subframes.
where
-
-
-
-
-
-
and
-	 if the slot where the PDSCH is transmitted in () fulfils
-	 if the slot where the PDSCH is transmitted in () fulfils
The sequence  is given by Table 6.10.3.2-2.
For slot-PDSCH transmission in normal subframes,is generated as for the baseline slot-PDSCH UE-specific reference signal pattern for the same values of , while  is given by and depends on the cell-specific frequency shift as follows (see 'v0', 'v1' and 'v2' in Figure 6.10.3.2-2A for , , and , respectively):
-	For , ,
-	For , ,
-	For , .
Figure 6.10.3.2-2A: Mapping of UE-specific reference signals for slot-PDSCH, antenna ports 7, 8, 9 and 10 (normal cyclic prefix)
For subslot-PDSCH transmission, the baseline pattern (see 'Baseline' in Figure 6.10.3.2-2B) of UE-specific reference signals is defined as follows. It is applied if the presence of UE-specific reference signals is indicated in the DCI associated with the subslot-PDSCH (see DMRS position indicator field in TS 36.212 [3]), and in downlink subslots where the baseline pattern, including all the REs associated with  if the parameter maxLayersMIMO-STTI  is configured with 2 layers, or  if the parameter maxLayersMIMO-STTI  is configured with 4 layers, has no overlapping resource element with CRS and no overlapping resource element with configured zero-power and non-zero-power CSI reference signals:
where
The sequence  is given by Table 6.10.3.2-2.For subslot-PDSCH transmission in normal subframes, in downlink subslots where the baseline pattern, including all the REs associated with  if the parameter maxLayersMIMO-STTI  is configured with 2 layers, or  if the parameter maxLayersMIMO-STTI  is configured with 4 layers, has overlapping resource elements with configured zero-power or non-zero-power CSI reference signals or has overlapping resource elements with CRS, if the presence of UE-specific reference signals is indicated in the DCI associated (see DMRS position indicator field in TS 36.212 [3]) with the subslot-PDSCH, a shifted pattern of UE-specific reference signals is applied. In the shifted pattern,is generated as for the baseline subslot-PDSCH UE-specific reference signal pattern for the same value of , while  is given by and depends on the cell-specific frequency shift as follows (see also 'v0','v1' and 'v2' in Figure 6.10.3.2-2B for , , and , respectively):
-	For , ,
-	For , ,
-	For ,  ,
For subslot-PDSCH transmission in MBSFN subframes, in downlink subslots where the baseline pattern, including all the REs associated with  if the parameter maxLayersMIMO-STTI  is configured with 2 layers, or  if the parameter maxLayersMIMO-STTI  is configured with 4 layers,  has overlapping resource elements with configured zero-power or non-zero-power CSI reference signals, if the presence of UE-specific reference signals is indicated in the DCI associated (see DMRS position indicator field in TS 36.212 [3]) with the subslot-PDSCH, the shifted pattern of UE-specific reference signals for , as defined above, is applied (see 'v0' in Figure 6.10.3.2-2B for ).
Figure 6.10.3.2-2B: Mapping of UE-specific reference signals for subslot-PDSCH, antenna ports 7, 8, 9 and 10 (normal cyclic prefix)
Resource elements  used for transmission of UE-specific reference signals to one UE on any of the antenna ports in the set , where  or  shall
-	not be used for transmission of PDSCH on any antenna port in the same slot, and
-	not be used for UE-specific reference signals to the same UE on any antenna port other than those in  in the same slot.
Figure 6.10.3.2-3 illustrates the resource elements used for UE-specific reference signals for normal cyclic prefix for antenna ports 7, 8, 9 and 10. Figure 6.10.3.2-4 illustrates the resource elements used for UE-specific reference signals for extended cyclic prefix for antenna ports 7, 8.
For BL/CE UEs, if downlink resource reservation is enabled for the UE as specified in [9], and the Resource reservation field in the DCI is set to 1, then in case of PDSCH transmission associated with C-RNTI or SPS C-RNTI using UE-specific MPDCCH search space including PDSCH transmission without a corresponding MPDCCH,
-	If all OFDM symbols in a PRB are reserved, the demodulation reference signal transmission in that PRB is dropped.
Figure 6.10.3.2-3: Mapping of UE-specific reference signals, antenna ports 7, 8, 9 and 10 (normal cyclic prefix)
Figure 6.10.3.2-4: Mapping of UE-specific reference signals, antenna ports 7 and 8 (extended cyclic prefix)",TS 36.211,6.10.3.2,all_images/image_1475.png,"Mapping of UE-specific reference signals, antenna ports 7, 8, 9 and 10 (normal"
"If PRS frequency hopping is not configured by higher layers, the reference signal sequence  shall be mapped to complex-valued modulation symbols  used as reference signal for antenna port  in slot  according to
where
Normal cyclic prefix:
Extended cyclic prefix:
The bandwidth for positioning reference signals  is configured by higher layers and the cell-specific frequency shift is given by  where  if no value for  is configured by higher layers.
If PRS frequency hopping is configured by higher layers, a PRS frequency hopping configuration provided by higher layers contains the following:
-	The length of the PRS occasion group,
-	Number of PRS frequency hopping bands,
-	 defined as twice the starting PRB index of PRS frequency hopping band  where
-	 if ,
-	 where  is the index of the first PRB in the PRS frequency hopping narrowband configured by higher layers if
If PRS frequency hopping is configured by higher layers, the reference signal sequence in the PRS occasion , , in the PRS occasion group shall be mapped to complex-valued modulation symbols  used as reference signal for antenna port  in slot  according to
where
-	for normal cyclic prefix
-	for extended cyclic prefix
Figure 6.10.4.2-1: Mapping of positioning reference signals (normal cyclic prefix)
Figure 6.10.4.2-2: Mapping of positioning reference signals (extended cyclic prefix)",TS 36.211,6.10.4.2,all_images/image_1477.png,Mapping of positioning reference signals (normal cyclic prefix)
"If PRS frequency hopping is not configured by higher layers, the reference signal sequence  shall be mapped to complex-valued modulation symbols  used as reference signal for antenna port  in slot  according to
where
Normal cyclic prefix:
Extended cyclic prefix:
The bandwidth for positioning reference signals  is configured by higher layers and the cell-specific frequency shift is given by  where  if no value for  is configured by higher layers.
If PRS frequency hopping is configured by higher layers, a PRS frequency hopping configuration provided by higher layers contains the following:
-	The length of the PRS occasion group,
-	Number of PRS frequency hopping bands,
-	 defined as twice the starting PRB index of PRS frequency hopping band  where
-	 if ,
-	 where  is the index of the first PRB in the PRS frequency hopping narrowband configured by higher layers if
If PRS frequency hopping is configured by higher layers, the reference signal sequence in the PRS occasion , , in the PRS occasion group shall be mapped to complex-valued modulation symbols  used as reference signal for antenna port  in slot  according to
where
-	for normal cyclic prefix
-	for extended cyclic prefix
Figure 6.10.4.2-1: Mapping of positioning reference signals (normal cyclic prefix)
Figure 6.10.4.2-2: Mapping of positioning reference signals (extended cyclic prefix)",TS 36.211,6.10.4.2,all_images/image_1478.png,Mapping of positioning reference signals (extended cyclic prefix)
"In subframes configured for CSI reference signal transmission, the reference signal sequence  shall be mapped to complex-valued modulation symbols  used as reference symbols on antenna port  . The mapping depends on the higher-layer parameter CDMType.
For the case of CDMType is not configured or is configured to CDM2:
where
For the case of CDMType equal to CDM4:
where
and where  is given by Table 6.10.5.2-0.
Table 6.10.5.2-0: The sequence  for CDM4.
If neither of the higher-layer parameters NZP-FrequencyDensity and NZP-TransmissionComb are configured, .
If the UE is configured with one or more of the parameters NZP-FrequencyDensity and NZP-TransmissionComb,
-	if either NZP-FrequencyDensity equals 1,
-	if NZP-FrequencyDensity equals 1/2 and NZP-TransmissionComb equals 0,
-	if NZP-FrequencyDensity equals 1/2 and NZP-TransmissionComb equals 1,
-	if NZP-FrequencyDensity equals 1/3 and NZP-TransmissionComb equals 0,
-	if NZP-FrequencyDensity equals 1/3 and NZP-TransmissionComb equals 1,
-	if NZP-FrequencyDensity equals 1/3 and NZP-TransmissionComb equals 2,
The quantity  and the necessary conditions on  are given by Tables 6.10.5.2-1 and 6.10.5.2-2 for normal and extended cyclic prefix, respectively.
The relation between the antenna port number  and the quantity  depends on the number of CSI-RS antenna ports:
-	for CSI reference signals using up to eight antenna ports,
-	for CSI reference signals using more than eight antenna ports when the higher-layer parameter CDMType equals CDM2
where  is the CSI-RS resource number.
-	for CSI reference signals using more than eight antenna ports when the higher-layer parameter CDMType equals CDM4, antenna port number  where  for CSI-RS resource number .
For the case of CDMType equal to CDM8 and the number of CSI-RS antenna ports equal to 32:
where
The resource elements for the  CDM8 pattern, where , are determined by aggregating pairs of resource elements  satisfying  from the  aggregated CSI-RS configurations, where at most one pair of resource elements is drawn from each of the  aggregated CSI-RS configurations. For the case of CDMType equal to CDM8 and the number of CSI-RS antenna ports equal to 32, the aggregated CSI-RS configurations from Table 6.10.5.2-1 for normal cyclic prefix and from Table 6.10.5.2-2 for extended cyclic prefix are restricted to one of , , or . Antenna port number  where  for CSI-RS resource number . The sequence is given by Table 6.10.5.2-0A, where .
Table 6.10.5.2-0A: The sequence  for CDM8 with 32 CSI-RS antenna ports.
For the case of CDMType equal to CDM8 and the number of CSI-RS antenna ports equal to 24:
where
For the case of CDMType equal to CDM8 and the number of CSI-RS antenna ports equal to 24, the aggregated CSI-RS configurations from Table 6.10.5.2-1 for normal cyclic prefix are restricted to  in that order. Resource elements for CDM8 patterns are determined as follows:
-	Aggregating resource element quadruplet  satisfying  from CSI-RS configuration 1 with resource element quadruplet  satisfying  from CSI-RS configuration 2
-	Aggregating resource element quadruplet  satisfying  from CSI-RS configuration 3 with resource element quadruplet  satisfying  from CSI-RS configuration 1
-	Aggregating resource element quadruplet  satisfying  from CSI-RS configuration 2 with resource element quadruplet  satisfying  from CSI-RS configuration 3
Antenna port number  where  for CSI-RS resource number . The sequence is given by Table 6.10.5.2-0B. The sequence index  is determined as follows:
-	For resource element quadruplet  satisfying  from CSI-RS configuration 1, resource element quadruplet  satisfying  from CSI-RS configuration 2, or resource element quadruplet  satisfying  from CSI-RS configuration 3, .
-	For resource element quadruplet  satisfying  from CSI-RS configuration 1, resource element quadruplet  satisfying  from CSI-RS configuration 2, or resource element quadruplet  satisfying  from CSI-RS configuration 3, .
Table 6.10.5.2-0B: The sequence  for CDM8 with 24 CSI-RS antenna ports.
Multiple CSI reference signal configurations can be used in a given cell. A UE can be configured with multiple sets of CSI reference signals,
-	one or more configurations for CSI reporting for which the UE shall assume non-zero transmission power for the CSI-RS, and
-	zero or more configurations for which the UE shall assume zero transmission power, and
-	zero or more configurations valid across the system downlink bandwidth as part of the discovery signals for which the UE shall assume non-zero transmission power for the CSI-RS.
The CSI-RS configurations for which the UE shall assume non-zero transmission power are provided by higher layers.
The CSI-RS configurations for which the UE shall assume zero transmission power in a subframe are given by a bitmap derived according to clause 7.2.7 in TS 36.213 [4]. For each bit set to one in the 16-bit bitmap, the UE shall assume zero transmission power for the resource elements corresponding to the four CSI reference signal column in Tables 6.10.5.2-1 and 6.10.5.2-2 for normal and extended cyclic prefix, respectively, except for resource elements that overlap with those for which the UE shall assume non-zero transmission power CSI-RS as configured by higher layers. The most significant bit corresponds to the lowest CSI reference signal configuration index and subsequent bits in the bitmap correspond to configurations with indices in increasing order.
CSI reference signals not corresponding to higher layer configured parameters csi-RS-ConfigNZP-ApList or csi-RS-ConfigZP-ApList can only occur in
-	downlink slots where  fulfils the condition in Tables 6.10.5.2-1 and 6.10.5.2-2 for normal and extended cyclic prefix, respectively, and
-	where the subframe number fulfils the conditions in clause 6.10.5.3.
CSI reference signals corresponding to either higher layer configured parameter csi-RS-ConfigNZP-ApList or csi-RS-ConfigZP-ApList can only occur in
-	downlink slots where  fulfils the condition in Tables 6.10.5.2-1 and 6.10.5.2-2 for normal and extended cyclic prefix, respectively.
The UE shall assume that CSI reference signals are not transmitted
-	in the DwPTS for special subframe configuration 0, 5, 9 and 10 for normal cyclic prefix and special subframe configuration 0, 4 and 7 for extended cyclic prefix, in case of frame structure type 2,
-	in the DwPTS for normal CP for the case of CDMType equal to CDM8 and the number of CSI-RS antenna ports equal to 24,
-	in subframes where PDSCH/EPDCCH transmission starts in the second slot of a subframe for frame structure type 3,
-	in subframes where PDSCH/EPDCCH transmission ends prior to the end of a subframe for frame structure type 3,
-	in an empty subframe where there is no PDSCH or discovery signal transmission for frame structure type 3,
-	in subframes where transmission of a CSI-RS would collide with SystemInformationBlockType1 messages,
-	in the primary cell in subframes configured for transmission of paging messages in the primary cell for any UE with the cell-specific paging configuration.
For special subframe configuration {1, 2, 6, or 7}, a UE does not expect to be configured with one of CSI-RS configurations {1, 2, 3, 4, 6, 7, 8, 9, 12, 13, 14, 15, 16, 17} in DwPTS for normal CP.
The UE shall assume that none of the CSI reference signals corresponding to a CSI reference signal configuration are transmitted in subframes where transmission of any of those CSI reference signals would collide with transmission of synchronization signals or the core part of PBCH.
Resource elements  used for transmission of CSI reference signals on any of the antenna ports in the set , where , , , , , , , , , , , , , , ,  or  shall not be used for transmission of PDSCH on any antenna port in the same slot if higher layer parameter CDMType is not configured, or is configured to CDM2.
Resource elements  used for transmission of CSI reference signals on any of the antenna ports in the set , where
-	,  or  for CSI reference signals on 12 ports, or
-	, ,  or  for CSI reference signals on 16 ports, or
-	, , ,  or for CSI reference signals on 20 ports, or
-	, , , ,  or  for CSI reference signals on 24 ports, or
-	, , , ,,  or  for CSI reference signals on 28 ports, or
-	, , , , , ,  or  for CSI reference signals on 32 ports
shall not be used for transmission of PDSCH on any antenna port in the same slot if higher layer parameter CDMType is configured to CDM4.
Resource elements  used for transmission of CSI reference signals on any of the antenna ports in the set , where
-	,  or  for CSI reference signals on 24 ports, or
-	, ,  or  for CSI reference signals on 32 ports
shall not be used for transmission of PDSCH on any antenna port in the same slot if higher layer parameter CDMType is configured to CDM8.
The mapping for CSI reference signal configuration 0 is illustrated in Figures 6.10.5.2-1 and 6.10.5.2-2.
Table 6.10.5.2-1: Mapping from CSI reference signal configuration to  for normal cyclic prefix
Note:	. Configurations 0 – 19 for normal subframes are available for frame structure types 1, 2 and 3. Configurations 20 – 31 and configurations for special subframes are available for frame structure type 2 only.
Table 6.10.5.2-2: Mapping from CSI reference signal configuration to  for extended cyclic prefix.
Note:	. Configurations 0 – 15 for normal subframes are available for both frame structure type 1 and type 2. Configurations 16 – 27 and configurations for special subframes are available for frame structure type 2 only.
Figure 6.10.5.2-1: Mapping of CSI reference signals (CSI configuration 0, normal cyclic prefix)
Figure 6.10.5.2-2: Mapping of CSI reference signals (CSI configuration 0, extended cyclic prefix)",TS 36.211,6.10.5.2,all_images/image_1479.png,"Mapping of CSI reference signals (CSI configuration 0, normal cyclic prefix)"
"In subframes configured for CSI reference signal transmission, the reference signal sequence  shall be mapped to complex-valued modulation symbols  used as reference symbols on antenna port  . The mapping depends on the higher-layer parameter CDMType.
For the case of CDMType is not configured or is configured to CDM2:
where
For the case of CDMType equal to CDM4:
where
and where  is given by Table 6.10.5.2-0.
Table 6.10.5.2-0: The sequence  for CDM4.
If neither of the higher-layer parameters NZP-FrequencyDensity and NZP-TransmissionComb are configured, .
If the UE is configured with one or more of the parameters NZP-FrequencyDensity and NZP-TransmissionComb,
-	if either NZP-FrequencyDensity equals 1,
-	if NZP-FrequencyDensity equals 1/2 and NZP-TransmissionComb equals 0,
-	if NZP-FrequencyDensity equals 1/2 and NZP-TransmissionComb equals 1,
-	if NZP-FrequencyDensity equals 1/3 and NZP-TransmissionComb equals 0,
-	if NZP-FrequencyDensity equals 1/3 and NZP-TransmissionComb equals 1,
-	if NZP-FrequencyDensity equals 1/3 and NZP-TransmissionComb equals 2,
The quantity  and the necessary conditions on  are given by Tables 6.10.5.2-1 and 6.10.5.2-2 for normal and extended cyclic prefix, respectively.
The relation between the antenna port number  and the quantity  depends on the number of CSI-RS antenna ports:
-	for CSI reference signals using up to eight antenna ports,
-	for CSI reference signals using more than eight antenna ports when the higher-layer parameter CDMType equals CDM2
where  is the CSI-RS resource number.
-	for CSI reference signals using more than eight antenna ports when the higher-layer parameter CDMType equals CDM4, antenna port number  where  for CSI-RS resource number .
For the case of CDMType equal to CDM8 and the number of CSI-RS antenna ports equal to 32:
where
The resource elements for the  CDM8 pattern, where , are determined by aggregating pairs of resource elements  satisfying  from the  aggregated CSI-RS configurations, where at most one pair of resource elements is drawn from each of the  aggregated CSI-RS configurations. For the case of CDMType equal to CDM8 and the number of CSI-RS antenna ports equal to 32, the aggregated CSI-RS configurations from Table 6.10.5.2-1 for normal cyclic prefix and from Table 6.10.5.2-2 for extended cyclic prefix are restricted to one of , , or . Antenna port number  where  for CSI-RS resource number . The sequence is given by Table 6.10.5.2-0A, where .
Table 6.10.5.2-0A: The sequence  for CDM8 with 32 CSI-RS antenna ports.
For the case of CDMType equal to CDM8 and the number of CSI-RS antenna ports equal to 24:
where
For the case of CDMType equal to CDM8 and the number of CSI-RS antenna ports equal to 24, the aggregated CSI-RS configurations from Table 6.10.5.2-1 for normal cyclic prefix are restricted to  in that order. Resource elements for CDM8 patterns are determined as follows:
-	Aggregating resource element quadruplet  satisfying  from CSI-RS configuration 1 with resource element quadruplet  satisfying  from CSI-RS configuration 2
-	Aggregating resource element quadruplet  satisfying  from CSI-RS configuration 3 with resource element quadruplet  satisfying  from CSI-RS configuration 1
-	Aggregating resource element quadruplet  satisfying  from CSI-RS configuration 2 with resource element quadruplet  satisfying  from CSI-RS configuration 3
Antenna port number  where  for CSI-RS resource number . The sequence is given by Table 6.10.5.2-0B. The sequence index  is determined as follows:
-	For resource element quadruplet  satisfying  from CSI-RS configuration 1, resource element quadruplet  satisfying  from CSI-RS configuration 2, or resource element quadruplet  satisfying  from CSI-RS configuration 3, .
-	For resource element quadruplet  satisfying  from CSI-RS configuration 1, resource element quadruplet  satisfying  from CSI-RS configuration 2, or resource element quadruplet  satisfying  from CSI-RS configuration 3, .
Table 6.10.5.2-0B: The sequence  for CDM8 with 24 CSI-RS antenna ports.
Multiple CSI reference signal configurations can be used in a given cell. A UE can be configured with multiple sets of CSI reference signals,
-	one or more configurations for CSI reporting for which the UE shall assume non-zero transmission power for the CSI-RS, and
-	zero or more configurations for which the UE shall assume zero transmission power, and
-	zero or more configurations valid across the system downlink bandwidth as part of the discovery signals for which the UE shall assume non-zero transmission power for the CSI-RS.
The CSI-RS configurations for which the UE shall assume non-zero transmission power are provided by higher layers.
The CSI-RS configurations for which the UE shall assume zero transmission power in a subframe are given by a bitmap derived according to clause 7.2.7 in TS 36.213 [4]. For each bit set to one in the 16-bit bitmap, the UE shall assume zero transmission power for the resource elements corresponding to the four CSI reference signal column in Tables 6.10.5.2-1 and 6.10.5.2-2 for normal and extended cyclic prefix, respectively, except for resource elements that overlap with those for which the UE shall assume non-zero transmission power CSI-RS as configured by higher layers. The most significant bit corresponds to the lowest CSI reference signal configuration index and subsequent bits in the bitmap correspond to configurations with indices in increasing order.
CSI reference signals not corresponding to higher layer configured parameters csi-RS-ConfigNZP-ApList or csi-RS-ConfigZP-ApList can only occur in
-	downlink slots where  fulfils the condition in Tables 6.10.5.2-1 and 6.10.5.2-2 for normal and extended cyclic prefix, respectively, and
-	where the subframe number fulfils the conditions in clause 6.10.5.3.
CSI reference signals corresponding to either higher layer configured parameter csi-RS-ConfigNZP-ApList or csi-RS-ConfigZP-ApList can only occur in
-	downlink slots where  fulfils the condition in Tables 6.10.5.2-1 and 6.10.5.2-2 for normal and extended cyclic prefix, respectively.
The UE shall assume that CSI reference signals are not transmitted
-	in the DwPTS for special subframe configuration 0, 5, 9 and 10 for normal cyclic prefix and special subframe configuration 0, 4 and 7 for extended cyclic prefix, in case of frame structure type 2,
-	in the DwPTS for normal CP for the case of CDMType equal to CDM8 and the number of CSI-RS antenna ports equal to 24,
-	in subframes where PDSCH/EPDCCH transmission starts in the second slot of a subframe for frame structure type 3,
-	in subframes where PDSCH/EPDCCH transmission ends prior to the end of a subframe for frame structure type 3,
-	in an empty subframe where there is no PDSCH or discovery signal transmission for frame structure type 3,
-	in subframes where transmission of a CSI-RS would collide with SystemInformationBlockType1 messages,
-	in the primary cell in subframes configured for transmission of paging messages in the primary cell for any UE with the cell-specific paging configuration.
For special subframe configuration {1, 2, 6, or 7}, a UE does not expect to be configured with one of CSI-RS configurations {1, 2, 3, 4, 6, 7, 8, 9, 12, 13, 14, 15, 16, 17} in DwPTS for normal CP.
The UE shall assume that none of the CSI reference signals corresponding to a CSI reference signal configuration are transmitted in subframes where transmission of any of those CSI reference signals would collide with transmission of synchronization signals or the core part of PBCH.
Resource elements  used for transmission of CSI reference signals on any of the antenna ports in the set , where , , , , , , , , , , , , , , ,  or  shall not be used for transmission of PDSCH on any antenna port in the same slot if higher layer parameter CDMType is not configured, or is configured to CDM2.
Resource elements  used for transmission of CSI reference signals on any of the antenna ports in the set , where
-	,  or  for CSI reference signals on 12 ports, or
-	, ,  or  for CSI reference signals on 16 ports, or
-	, , ,  or for CSI reference signals on 20 ports, or
-	, , , ,  or  for CSI reference signals on 24 ports, or
-	, , , ,,  or  for CSI reference signals on 28 ports, or
-	, , , , , ,  or  for CSI reference signals on 32 ports
shall not be used for transmission of PDSCH on any antenna port in the same slot if higher layer parameter CDMType is configured to CDM4.
Resource elements  used for transmission of CSI reference signals on any of the antenna ports in the set , where
-	,  or  for CSI reference signals on 24 ports, or
-	, ,  or  for CSI reference signals on 32 ports
shall not be used for transmission of PDSCH on any antenna port in the same slot if higher layer parameter CDMType is configured to CDM8.
The mapping for CSI reference signal configuration 0 is illustrated in Figures 6.10.5.2-1 and 6.10.5.2-2.
Table 6.10.5.2-1: Mapping from CSI reference signal configuration to  for normal cyclic prefix
Note:	. Configurations 0 – 19 for normal subframes are available for frame structure types 1, 2 and 3. Configurations 20 – 31 and configurations for special subframes are available for frame structure type 2 only.
Table 6.10.5.2-2: Mapping from CSI reference signal configuration to  for extended cyclic prefix.
Note:	. Configurations 0 – 15 for normal subframes are available for both frame structure type 1 and type 2. Configurations 16 – 27 and configurations for special subframes are available for frame structure type 2 only.
Figure 6.10.5.2-1: Mapping of CSI reference signals (CSI configuration 0, normal cyclic prefix)
Figure 6.10.5.2-2: Mapping of CSI reference signals (CSI configuration 0, extended cyclic prefix)",TS 36.211,6.10.5.2,all_images/image_1480.png,"Mapping of CSI reference signals (CSI configuration 0, extended cyclic prefix)"
"According to 3GPP TS 23.379 [5] the controlling MCPTT function is divided into a floor control server and a media distribution function. In the present document the internal structure of the MCPTT server is illustrated in figure 4.2-1.
NOTE:	The real internal structure of the MCPTT server is implementation specific but a possible internal structure is shown to illustrate the procedures.
Figure 4.2.1-1: Internal structure of floor control in the controlling MCPTT function
All entities in the controlling MCPTT function are assumed to have a direct communication interface to the application and signalling plane. The interface to the application and signaling plane carries information about SIP session initialisation and SIP session release, SDP content, etc.
The reference point MCPTT-3 is described in 3GPP TS 23.379 [5].
The floor control interface towards the MCPTT client receives and transmits the floor control messages from and to the MCPTT client via the participating MCPTT function or non-controlling MCPTT function. The procedures are controlled by a state machine described in clause 6.3.5. One state machine is needed for each MCPTT client participating in an MCPTT call. A non-controlling MCPTT function is seen by the floor control interface towards the MCPTT client as an MCPTT client.
The floor control arbitration logic is performing the floor control. The floor control arbitration logic is controlled by a state machine described in clause 6.3.4. One state machine is needed per MCPTT call.
The floor request queue is accessible both by the floor control interface towards the MCPTT client for all MCPTT clients in the call and the floor control arbitration logic.
The network media interface is receiving and sending media from and to the associated MCPTT client via the participating MCPTT function or non-controlling MCPTT function. The network media interface is out of scope of the present document. One network media interface is needed for each MCPTT client participating in an MCPTT call. A non-controlling MCPTT function is seen by the network media interface as an MCPTT client.
The media distributor is controlled by the floor control arbitration logic. The media distributor is out of scope of the present document. One media distributor is needed per MCPTT call.
The internal interfaces are assumed to transport the following types of information.
1.	The interface between the network media interface and the floor control interface towards the MCPTT client:
a.	Indication that the network media interface has started to receive media packets from the associated MCPTT client or that media packets are no longer received from the associated MCPTT client.
NOTE:	It is an implementation option whether an indication e.g. is sent for every received RTP media packet or only when the first packet is received and then when no more RTP packets are received.
2.	The interface between the floor control interface towards the MCPTT client and the floor control arbitration logic:
a.	Floor control messages to and from the associated MCPTT client, requests to create or delete the state machine instance for the associated MCPTT client. The floor control messages to the floor control arbitration logic are limited to floor control messages that will change the state of the floor.
3.	The interface between the network media interface and the media distributor:
a.	Media to and from associated MCPTT clients. This interface is out of scope of the present document.
4.	The interface between the floor control arbitration logic and the media distributor:
a.	Requests to start or stop distributing media to participants in the MCPTT call. Indication that the media distributor has started to receive media packets from the network media interface associated with the MCPTT client with the permission to send media or that media packets are no longer received from the network media interface from the associated MCPTT client.
5.	The interface between the floor control interface towards the MCPTT client and the floor request queue:
a.	Requests to store received Floor Request messages in the queue or requests to remove Floor Request messages from the queue and the queue content for building the Floor Queue Position Info message.
6.	The interface between the floor control arbitration logic and the floor request queue:
a.	Requests to store received Floor Request messages in the queue or requests to remove Floor Request messages from the queue. Indications that the queue is modified.",TS 24.380,4.2.1,all_images/image_1489.png,Internal structure of floor control in the controlling MCPTT function
"According to 3GPP TS 24.379 [2] clause 5.3 the MCPTT server can act in a non-controlling MCPTT function of an MCPTT group role. In the present document the internal structure of the non-controlling MCPTT function of an MCPTT group is illustrated in figure 4.2.4-1.
NOTE:	The real internal structure of the MCPTT server is implementation specific but a possible internal structure is shown to illustrate the logic and the procedures.
Figure 4.2.4-1: Internal structure of the non-controlling MCPTT function
All entities in the non-controlling MCPTT function of an MCPTT group are assumed to have a direct communication interface to the application and signalling plane. The interface to the application and signaling plane carries information about SIP session initialisation and SIP session release, SDP content, etc.
The floor participant interface receives and transmits the floor control messages from and to the MCPTT client via the participating MCPTT function or non-controlling MCPTT function. The procedures are controlled by a state machine described in clause 6.5.5. One state machine is needed for each MCPTT client participating in an MCPTT call. A non-controlling MCPTT function is seen by the floor participant interface as an MCPTT client.
The floor control server interface is distributing floor control message to and from the floor control server in the controlling MCPTT function or non-controlling MCPTT function. The floor control server interface procedures are described in clause 6.5.4. One floor control server interface is needed per MCPTT call.
The network media interface is receiving and sending media from and to the associated MCPTT client via the participating MCPTT function or non-controlling MCPTT function. The network media interface is out of scope of the present document. One network media interface is needed for each MCPTT client participating in an MCPTT call. A non-controlling MCPTT function is seen by the network media interface as an MCPTT client.
The media distributor is controlled by the floor control server interface. The media distributor is out of scope of the present document. One media distributor is needed per MCPTT call.
The internal interfaces are assumed to transport the following type of information.
1.	The interface between the network media interface and the floor participant interface:
a.	Indication that the network media interface has started to receive media packets from the associated MCPTT client and requests from the floor participant interface to forward received RTP packets towards the media distributor or to stop forward RTP media packets to the media distributor.
NOTE:	It is an implementation option whether an indication e.g. is sent for every received RTP media packet or only when the first packet is received.
2.	The interface between the floor participant interface and the floor control server interface:
a.	Floor control messages to and from the associated floor participant. The floor control message to the floor control server interface are limited to floor control messages that can result in an action towards the floor control server.
3.	The interface between the network media interface and the media distributor:
a.	RTP media packets to and from associated MCPTT clients. This interface is out of scope of the present document.
4.	The interface between the floor control server interface and the media distributor:
a.	Requests to start or stop distributing media to participants in the MCPTT call. Indication that the media distributor has started to receive media packets from the network media interface associated with the MCPTT client with the permission to send media.",TS 24.380,4.2.4,all_images/image_1490.png,Internal structure of the non-controlling MCPTT function
"The floor participant shall behave according to the state diagram and the state transitions specified in this clause.
Figure 6.2.4.1-1 shows the state diagram for 'Floor participant state transition diagram for basic operation'.
Figure 6.2.4.1-1: Floor participant state transition diagram for basic operation.
State details are explained in the following clauses.
If an RTP media packet or a floor control message arrives in a state where there is no specific procedure specified for the RTP media packets or the received floor control message, the floor participant shall discard the floor control message or the RTP media packet and shall remain in the current state.
NOTE 1:	A badly formatted RTP packet or floor control message received in any state is ignored by the floor participant and does not cause any change of the current state.
NOTE 2:	The state transition diagram is the same for groups configured for audio cut-in floor control but the U: queued state should never be visited.",TS 24.380,6.2.4.1,all_images/image_1491.jpeg,Floor participant state transition diagram for basic operation.
"The floor participant interface shall behave according to the state diagram and state transitions specified in this clause.
Figure 6.5.5.1-1 shows the general floor control operation states (P states) and the state transition diagram.
Figure 6.5.5.1-1: The 'floor participant interface state transition' state diagram
The floor participant interface shall keep one instance of the 'floor participant interface state transition' state machine per MCPTT client in a session.
The floor participant associated to the 'floor participant interface state transition' state machine is in the following clauses referred to as the associated floor participant.
If floor control messages or RTP media packets arrives in a state where there is no procedure specified in the following clauses the floor participant interface:
1.	shall discard the floor control message;
2.	shall request the network media interface to discard any received RTP media packet; and
3.	shall remain in the current state.
State details are explained in the following clauses.",TS 24.380,6.5.5.1,all_images/image_1494.jpeg,The 'floor participant interface state transition' state diagram
"The floor participant shall behave according to the state diagram and the transitions specified in this clause.
The received floor messages and the RTP media packets are inputs to the state machine according to their arrival order. They are not ignored unless otherwise stated.
The MCPTT client also provides input to the state machine as request to talk (press PTT button) or as end of talk (release PTT button).
Figure 7.2.3.1-1 show the 'Floor participant state diagram – basic operation'.
Figure 7.2.3.1-1: 'Floor participant state diagram – basic operation'
State details are explained in the following clauses.
If an RTP media packet or a floor control message arrives in a state where there is no specific procedure specified for the RTP media packet or the received floor control message, the floor participant shall discard the floor control message or the RTP media packet and shall remain in the current state.
NOTE:	A badly formatted RTP packet or floor control message received in any state is ignored by the floor participant and does not cause any change of the current state.",TS 24.380,7.2.3.1,all_images/image_1495.jpeg,'Floor participant state diagram – basic operation'
"If the participating MCPTT function supports pre-established session, the participating MCPTT function shall behave according to the 'pre-established session state machine' and state transitions specified in this clause.
The 'pre-established session state machine' has three states: 'G: Pre-established session not in use' state, 'G: Pre-established session in use' state and 'G: Call releasing' state, the state transitions are partially controlled by the specifications in 3GPP TS 24.379 [2]. The 'Start-stop' state is the initial and final state.
Figure 9.3.2.1-1 shows the state diagram and the state transitions of the 'pre-established session state machine'.
Figure 9.3.2.1-1: State transitions of Pre-established Session state machine
The participating MCPTT function shall create one instance of the 'pre-established session state machine' per pre-established session per MCPTT client.
State and state transition details are explained in the following clauses.
If a pre-established session call control message, SIP request, SIP response or RTP media packet arrives in any state and there is no procedure specified for it in this clauses below, the participating MCPTT function shall discard the pre-established session call control message, SIP request, SIP response or RTP media packet and remain in the current state.",TS 24.380,9.3.2.1,all_images/image_1496.jpeg,State transitions of Pre-established Session state machine
"If the participating MCPTT function supports the MBMS subchannel control procedure, the participating MCPTT function shall support the behaviour implied by the state machine specified in this clause. The specifications are on the reception of floor control messages from the controlling MCPTT function, sending of floor control messages and the allocation/deallocation of a MBMS subchannel for a conversation in a group session.
Figure 10.2.1-1 shows the participating MCPTT function MBMS subchannel control state diagram.
Figure 10.2.1-1: Participating MCPTT function MBMS subchannel control state diagram
If a floor control message or RTP media packet arrives in a state where there are no procedures specified in the clauses below, the participating MCPTT function shall discard the message.",TS 24.380,10.2.1,all_images/image_1497.jpeg,Participating MCPTT function MBMS subchannel control state diagram
"The MO for BCP of MMTEL communication service is used to manage settings of the UE, which supports a RequestTimeout timer. The timer RequestTimeout is configurable as specified in 3GPP TS 24.173 [3].
The MO identifier is: urn:oma:mo:ext-3gpp-bcp:1.0.
Protocol compatibility: This MO is compatible with OMA DM 1.2.
Figure 4-1: MO for BCP of MMTEL communication service",TS 24.275,4,all_images/image_1498.jpeg,MO for BCP of MMTEL communication service
"Figure 4.2-1: Protocol layering for reliable data transfer between UE and SCEF in EPS
The reference model showing the protocol layering for reliable data transfer between UE and SCEF in EPS is illustrated in figure 4.2-1.
Figure 4.2-2: Protocol layering for reliable data transfer between UE and NEF in 5GS
The reference model showing the protocol layering for reliable data transfer between UE and NEF in 5GS is illustrated in figure 4.2-2.",TS 24.250,4.2,all_images/image_1499.png,Protocol layering for reliable data transfer between UE and SCEF in EPS
"Figure 4.2-1: Protocol layering for reliable data transfer between UE and SCEF in EPS
The reference model showing the protocol layering for reliable data transfer between UE and SCEF in EPS is illustrated in figure 4.2-1.
Figure 4.2-2: Protocol layering for reliable data transfer between UE and NEF in 5GS
The reference model showing the protocol layering for reliable data transfer between UE and NEF in 5GS is illustrated in figure 4.2-2.",TS 24.250,4.2,all_images/image_1500.png,Protocol layering for reliable data transfer between UE and NEF in 5GS
"If the originator wants to query the destination port numbers that are reserved but does not want to query the serialization format used by the application, the originator shall send a MANAGE_PORT command as shown in figure 5.4.2.6.4-1 by setting the Action field to ""Query port"" and indicating the destination port numbers that it intends to query in the optional Requested port numbers. If the originator wants to query the destination port numbers that are reserved and also wants to query the serialization format used by the application, the originator shall send a MANAGE_PORT command by setting the Action field to ""Query port and serialization format"" and indicating the destination port numbers that it intends to query in the optional Requested port numbers.  If the originator intends to query all the port numbers, then it shall not include the Requested port numbers.
Figure 5.4.2.6.4-1: MANAGE_PORT command field format for Action ""Query port"" or Action ""Query port with serialization format""
If the receiver received a MANAGE_PORT command with Action field set to ""Query port"", the receiver shall send a MANAGE_PORT response as shown in figure 5.4.2.6.4-2, by setting the Action field in response frame to ""Query port"". If the receiver received a MANAGE_PORT command with Action field set to ""Query port and serialization format"", the receiver shall send a MANAGE_PORT response as shown in figure 5.4.2.6.4-3, by setting the Action field in response frame to ""Query port and serialization format"". For each destination port included in the Requested port numbers in the MANAGE_PORT command that is reserved on the receiver and is associated with an application, the receiver shall include an entry in the MANAGE_PORT response. The receiver shall set the Num Entries field in the MANAGE_PORT response to the number of destination ports entries that are included in the MANAGE_PORT response. For each destination port entry, the receiver shall include the Source Port number that the destination port is paired with and the associated Application ID. If the receiver does not have any reserved source port number for the associated Application ID, the Source Port number shall be set to 0. If the receiver received a MANAGE_PORT command with Action field set to ""Query port and serialization format"", then for each destination port entry the receiver shall include the Serialization Format associated with the Application ID.
In the case that the entries for all the destination port numbers requested by the originator do not fit in the MANAGE_PORT response, the receiver shall include as many entries for destination port numbers as possible in the MANAGE_PORT response. For all the destination port numbers that are reserved on the receiver, for which the originator has requested information in Requested port numbers in the MANAGE_PORT command and for which information cannot be included in the MANAGE_PORT response, the receiver shall set the corresponding entry in the optional Port numbers not available bitmap. The originator can subsequently query information on these destination port numbers by sending another MANAGE_PORT command and setting Requested port numbers to Port numbers not available in the received MANAGE_PORT response. If the entries for all the destination port numbers requested by the originator fit in the MANAGE_PORT response, the receiver shall not include the optional Port numbers not available.
NOTE:	The entries for all the destination port numbers requested by the originator will fit in the MANAGE_PORT command for cases where the maximum length of the OS specific application identifier is equal-to or less-than 64 octets.
Figure 5.4.2.6.4-2: MANAGE_PORT response field format for Action ""Query port""
Figure 5.4.2.6.4-3: MANAGE_PORT response field format for Action ""Query port and serialization format""",TS 24.250,5.4.2.6.4,all_images/image_1501.png,"MANAGE_PORT response field format for Action ""Query port"""
"If the originator wants to notify the receiver of the source port numbers that are reserved at the originator but does not want to notify the serialization format used by the application, the originator shall send a MANAGE_PORT command as shown in figure 5.4.2.6.5-1 by setting the Action field to ""Notify port"". If the originator wants to notify the receiver of the source port numbers that are reserved at the originator and also the serialization format used by the application, the originator shall send a MANAGE_PORT command as shown in figure 5.4.2.6.5-2 by setting the Action field to ""Notify port and serialization format"".
For each source port that is reserved on the originator and is associated with an application, the originator shall include an entry in the MANAGE_PORT command. The originator shall set the Num Entries field in the MANAGE_PORT command to the number of source ports entries that are included in the MANAGE_PORT response. For each source port that is reserved, the originator shall include the Destination Port number that the source port is paired with and the associated Application ID. If the originator does not have any reserved destination port number for the associated Application ID, the Destination Port number shall be set to 0. If the originator wants to notify the receiver about the serialization format used by the application, then for each destination port entry the originator shall also include the Serialization Format associated with the Application ID.
In the case that the entries for all the source port numbers do not fit in the MANAGE_PORT command, the originator shall include as many entries on source port numbers as possible in the MANAGE_PORT command. For all the source port numbers that are reserved on the originator and for which information cannot be included in the MANAGE_PORT command, the originator shall set the corresponding entry in the optional Port numbers not available bitmap. The receiver can subsequently query information on these source port numbers by sending another MANAGE_PORT command by setting the Action field to ""Query port"" and setting Requested port numbers to Port numbers not available in the received MANAGE_PORT command. If the entries for all the source port numbers fit in the MANAGE_PORT command, the originator shall not include the Port numbers not available.
NOTE:	The entries for all the source port numbers will fit in the MANAGE_PORT command for cases where the maximum length of the OS specific application identifier is equal-to or less-than 64 octets.
Figure 5.4.2.6.5-1: MANAGE_PORT command field format for Action ""Notify port""
Figure 5.4.2.6.5-2: MANAGE_PORT command field format for Action ""Notify port and serialization format""
If the receiver supports MANAGE_PORT command with Action field set to ""Notify port"" or ""Notify port and serialization format"", there is no response frame sent by the receiver when it receives the above MANAGE_PORT command; otherwise the receiver transmits an ERROR response frame to the originator as described in subclause 5.4.2.4.",TS 24.250,5.4.2.6.5,all_images/image_1502.png,"MANAGE_PORT command field format for Action ""Notify port"""
"The supplementary services MSCancelDeferredLocation operation enables the UE to cancel ongoing periodic or triggered location in a target LMF using NAS signalling as described in 3GPP TS 23.273  clause 6.3.3 [2]. The supplementary services MCancelDeferredLocation messages are transported using the UL NAS TRANSPORT message and the DL NAS TRANSPORT message defined in 3GPP TS 24.501 [3]. The deferred routing identifier in the Additional information IE of the UL NAS TRANSPORT message for the cancellation of periodic or triggered location event reporting can be an LMF ID.
Figure 5.2.2.2.1-1: NAS signaling transport for UE initiated Cancel Deferred Location",TS 24.571,5.2.2.2.1,all_images/image_1504.png,NAS signaling transport for UE initiated Cancel Deferred Location
"The UE sends LPP message and the associated Routing identifier in the UL NAS Transport message (refer to 3GPP TS 24.501 [3] and 3GPP TS 23.273 [2] clause 6.11.1). Figure 5.2.2.3-1 illustrates an example of the NAS signalling transport for uplink LPP messages.
Figure 5.2.2.3-1: NAS signalling transport for uplink LPP messages",TS 24.571,5.2.2.3,all_images/image_1505.png,NAS signalling transport for uplink LPP messages
"The supplementary services EventReport operation enables the UE to report the periodic or triggered location event invoked by the LMF via LCS PeriodicTriggered Invoke operation as described in clause 6.3.1 of 3GPP TS 23.273 [2] when some certain events are detected in the UE. The supplementary services EventReport message is transferred to the LMF via the serving AMF in a UL NAS TRANSPORT message defined in 3GPP TS 24.501 [3]. A response from the LMF may be returned to the UE via the serving AMF and be transferred to the UE in a DL NAS TRANSPORT message. The deferred routing identifier in the Additional information IE of the UL NAS TRANSPORT for reporting the periodic or triggered location event can be an LMF ID. If the serving LMF is changed, the deferred routing identifier may be included in the EventReport Acknowledgement message (refer to clause  6.3.1 of 3GPP TS 23.273 [2]).
Figure 5.2.2.4.1-1 illustrates an example of the NAS signalling transport for EventReport messages,
Figure 5.2.2.4.1-1: NAS signalling transport for EventReport messages",TS 24.571,5.2.2.4.1,all_images/image_1506.png,NAS signalling transport for EventReport messages
"The supplmentary services LocationPrivacySetting operation enables the UE to update the UE Location Privacy Indication information via UE Location Privacy Setting procedure as described in clause 6.12.1 of 3GPP TS 23.273 [2] when the UE has generated or updated the UE Location Privacy Indication. The supplementary services LocationPrivacySetting message is transferred to the serving AMF in a UL NAS TRANSPORT message and an acknowledgement from the serving AMF may be returned to the UE in DL NAS TRANSPORT message defined in 3GPP TS 24.501 [3].
Figure 5.2.2.5.1-1 illustrates an example of the NAS signalling transport for UE Location Privacy Setting procedure,
Figure 5.2.2.5.1-1: NAS signalling transport for LocationPrivacySetting messages",TS 24.571,5.2.2.5.1,all_images/image_1507.png,NAS signalling transport for LocationPrivacySetting messages
"The supplementary services EventReport operation enables the UE to report the periodic or triggered location event invoked by the LMF via LCS PeriodicTriggered Invoke operation as described in clause 6.7.1 of 3GPP TS 23.273 [2] when certain events are detected in the UE and when the UE supports and the LMF allows the use of Control Plane CIoT 5GS Optimisation. The supplementary services EventReport message is transferred to the LMF via the serving AMF in a CONTROL PLANE SERVICE REQUEST message defined in 3GPP TS 24.501 [3]. A response from the LMF may be returned to the UE via the serving AMF and be transferred to the UE in a DL NAS TRANSPORT message defined in 3GPP TS 24.501 [3]. The deferred routing identifier in the Additional information IE of the CONTROL PLANE SERVICE REQUEST message for reporting the periodic or triggered location event can be an LMF ID. If the serving LMF is changed, the deferred routing identifier may be included in the EventReport Acknowledgement message (refer to clause 6.3.1 of 3GPP TS 23.273 [2]).
Figure 5.2.2.x.1-1 illustrates an example of the NAS signalling transport for EventReport messages,
Figure 5.2.2.6.1-1: NAS signalling transport for EventReport messages using Low Power Event Reporting and Triggered 5GC-MT-LR",TS 24.571,5.2.2.6.1,all_images/image_1508.png,NAS signalling transport for EventReport messages using Low Power Event
"Figure 5.1.2.2-1: IMS session setup, resource reservation on both sides
NOTE: Support for SDP capability negotiation is only optional for 3GPP release 7 and release 8 UEs and non-IMS UEs.
The details of the signalling flows are as follows:
1.	INVITE request (UE#1 to P-CSCF#1) see example in table 5.1.2.2-1
For this example, it is assumed that UE#1 is willing to establish a multimedia session comprising a video stream and an audio stream. The video stream supports two codecs, either H.263 or MPEG-4 Visual. The audio stream supports the AMR codec. For the video stream AVPF is offered and for the audio stream AVP is offered.
UE#1indicates that it supports precondition and it indicates that it supports reliable provisional responses. However, it does not use the ""Require"" header for these capabilities.
UE#1 does not have available the resources that are necessary to transport the media.
UE#2 supports both AVP and AVPF and supports SDP capability negotiation and since only AVPF is being offered for video and only AVP is offered for audio UE#2 therefore accepts AVPF for video and AVP for audio.
For this example it is assumed, that signalling encryption was negotiated between UE and P-CSCF in the security mode set-up procedure during the last successful authentication. This option will only be shown in this example.
Table 5.1.2.2-1: INVITE request (UE#1 to P-CSCF)
INVITE tel:+1-212-555-2222 SIP/2.0
Via: SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd]:1357;comp=sigcomp;branch=z9hG4bKnashds7
Max-Forwards: 70
Route: <sip:pcscf1.visited1.net:7531;lr;comp=sigcomp>, <sip:scscf1.home1.net;lr>
P-Preferred-Identity: ""John Doe"" <sip:user1_public1@home1.net>
P-Access-Network-Info: 3GPP-UTRAN-TDD; utran-cell-id-3gpp=234151D0FCE11
Privacy: none
From: <sip:user1_public1@home1.net>;tag=171828
To: <tel:+1-212-555-2222>
Call-ID: cb03a0s09a2sdfglkj490333
Cseq: 127 INVITE
Require: sec-agree
Supported: precondition, 100rel, gruu, 199
Accept: application/sdp,application/3gpp-ims+xml
Proxy-Require: sec-agree
Security-Verify: ipsec-3gpp; q=0.1; alg=hmac-sha-1-96; ealg=aes-cbc; spi-c=98765432; spi-s=87654321; port-c=8642; port-s=7531
Contact: <sip:user1_public1@home1.net;gr=urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6;comp=sigcomp>
Allow: INVITE, ACK, CANCEL, BYE, PRACK, UPDATE, REFER, MESSAGE
Content-Type: application/sdp
Content-Length: (…)
v=0
o=- 2987933615 2987933615 IN IP6 5555::aaa:bbb:ccc:ddd
s=-
c=IN IP6 5555::aaa:bbb:ccc:ddd
t=0 0
m=video 3400 RTP/AVPF 98 99
b=AS:75
a=curr:qos local none
a=curr:qos remote none
a=des:qos mandatory local sendrecv
a=des:qos none remote sendrecv
a=rtpmap:98 H263
a=fmtp:98 profile-level-id=0
a=rtpmap:99 MP4V-ES
m=audio 3456 RTP/AVP 97 96
b=AS:25.4
a=curr:qos local none
a=curr:qos remote none
a=des:qos mandatory local sendrecv
a=des:qos none remote sendrecv
a=rtpmap:97 AMR
a=fmtp:97 mode-set=0,2,5,7; maxframes=2
a=rtpmap:96 telephone-event
Supported:	The UE indicates support for the ""precondition"" mechanism, the support for reliable provisional responses and the support for the 199 (Early Dialog Terminated) response code.
SDP	The SDP contains a set of codecs supported by UE#1 and desired by the user at UE#1 for this session. The SDP does not use a direction attribute since sendrecv is the default.
Security-Verify:	The Security-Verify contains the content of the Security-Server header as received during last successful authentication. It indicates that integrity protection and encryption are in use for this session.
2.	100 (Trying) response (P-CSCF#1 to UE#1)
The P-CSCF responds to the INVITE request with a 100 (Trying) provisional response.
3.	INVITE request (P-CSCF#1 to S-CSCF#1) -  see example in table 5.1.2.2-2
Table 5.1.2.2-2: INVITE request (P-CSCF#1 to S-CSCF#1)
INVITE tel:+1-212-555-2222 SIP/2.0
Via: SIP/2.0/UDP pcscf1.visited1.net;branch=z9hG4bK240f34.1, SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd]:1357;comp=sigcomp;branch=z9hG4bKnashds7
Max-Forwards: 69
Route: <sip:scscf1.home1.net;lr>
Record-Route: <sip:pcscf1.visited1.net;lr>
P-Asserted-Identity: ""John Doe"" <sip:user1_public1@home1.net>
P-Access-Network-Info:
P-Charging-Vector: icid-value=""AyretyU0dm+6O2IrT5tAFrbHLso=023551024""
Privacy:
From:
To:
Call-ID:
Cseq:
Supported:
Accept:
Contact:
Allow:
Content-Type:
Content-Length: (…)
v=
o=
s=
c=
t=
m=
b=
a=
a=
a=
a=
a=
a=
4.	100 (Trying) response (S-CSCF#1 to P-CSCF#1)
The S-CSCF responds to the INVITE request with a 100 (Trying) provisional response.
5.	INVITE request (S-CSCF#2 to P-CSCF#2) see example in table 5.1.2.2-3
Table 5.1.2.2-3: INVITE request (S-CSCF#2 to P-CSCF#2)
INVITE sip:[5555::eee:fff:aaa:bbb]:8805;comp=sigcomp SIP/2.0
Via: SIP/2.0/UDP scscf2.home2.net;branch=z9hG4bK764z87.1, SIP/2.0/UDP icscf2_s.home2.net;branch=z9hG4bK871y12.1, SIP/2.0/UDP scscf1.home1.net;branch=z9hG4bK332b23.1, SIP/2.0/UDP pcscf1.visited1.net;branch=z9hG4bK240f34.1, SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd]:1357;comp=sigcomp;branch=z9hG4bKnashds7
Max-Forwards: 66
Route: <sip:pcscf2.visited2.net;lr>
Record-Route: <sip:scscf2.home2.net;lr>, <sip:scscf1.home1.net;lr>, <sip:pcscf1.visited1.net;lr>
P-Asserted-Identity:
P-Charging-Vector: icid-value=""AyretyU0dm+6O2IrT5tAFrbHLso=023551024""
Privacy:
From:
To:
Call-ID:
Cseq:
Require:
Supported:
Accept:
Contact:
Allow:
P-Called-Party-ID: <sip:user2_public1@home2.net>
Content-Type:
Content-Length: (…)
v=
o=
s=
c=
t=
m=
b=
a=
a=
a=
a=
a=
a=
a=
6.	100 (Trying) response (P-CSCF#2 to S-CSCF#2)
The P-CSCF#2 responds to the INVITE request with a 100 (Trying) provisional response.
7.	INVITE request (P-CSCF#2 to UE #2) - see example in table 5.1.2.2-4
P-CSCF#2 forwards the INVITE request to UE#2.
Table 5.1.2.2-4: INVITE request (P-CSCF#2 to UE#2)
INVITE sip:user2_public1@home2.net SIP/2.0
Via: SIP/2.0/UDP pcscf2.visited2.net:5088;comp=sigcomp;branch=z9hG4bK361k21.1, SIP/2.0/UDP scscf2.home2.net;branch=z9hG4bK764z87.1, SIP/2.0/UDP icscf2_s.home2.net;branch=z9hG4bK871y12.1, SIP/2.0/UDP scscf1.home1.net;branch=z9hG4bK332b23.1, SIP/2.0/UDP pcscf1.visited1.net;branch=z9hG4bK240f34.1, SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd]:1357;comp=sigcomp;branch=z9hG4bKnashds7
Max-Forwards: 65
Route: <sip:scscf2.home2.net;lr>
Record-Route: <sip:pcscf2.visited2.net:5088;lr;comp=sigcomp>, <sip:scscf2.home2.net;lr>, <sip:scscf1.home1.net;lr>, <sip:pcscf1.visited1.net;lr>
P-Asserted-Identity:
Privacy:
From:
To:
Call-ID:
Cseq:
Require:
Supported:
Accept:
Contact:
Allow:
Content-Type:
Content-Length: (…)
v=
o=
s=
c=
t=
m=
b=
a=
a=
a=
a=
a=
a=
8.	100 (Trying) response (UE#2 to P-CSCF)
The UE responds to the INVITE request with a 100 (Trying) provisional response.
9.	183 (Session Progress) response (UE#2 to P-CSCF) - - see example in table 5.1.2.2-5
UE#2 determines the complete set of codecs that it is capable of supporting for this session. It determines the intersection with those appearing in the SDP in the INVITE request. UE#2 makes the final codec selection and chooses H.263 and AMR.
UE#2 responds with a 183 (Session Progress) response containing SDP back to the originator. This response is sent to P-CSCF. UE#2 uses a conf line in the SDP to request a confirmation from UE#1 when the local resources are available at UE#1.
Table 5.1.2.2-5: 183 (Session Progress) response (UE#2 to P-CSCF#2)
SIP/2.0 183 Session Progress
Via: SIP/2.0/UDP pcscf2.visited2.net:5088;comp=sigcomp;branch=z9hG4bK361k21.1, SIP/2.0/UDP scscf2.home2.net;branch=z9hG4bK764z87.1, SIP/2.0/UDP icscf2_s.home2.net;branch=z9hG4bK871y12.1, SIP/2.0/UDP scscf1.home1.net;branch=z9hG4bK332b23.1, SIP/2.0/UDP pcscf1.visited1.net;branch=z9hG4bK240f34.1, SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd]:1357;comp=sigcomp;branch=z9hG4bKnashds7
Record-Route: <sip:pcscf2.visited2.net:5088;lr;comp=sigcomp>, <sip:scscf2.home2.net;lr>, <sip:scscf1.home1.net;lr>, <sip:pcscf1.visited1.net;lr>
P-Access-Network-Info: 3GPP-UTRAN-TDD; utran-cell-id-3gpp=234151D0FCE11
Privacy: none
From:
To: <tel:+1-212-555-2222>;tag=314159
Call-ID:
CSeq:
Require: 100rel, precondition
Contact: <sip:user2_public1@home2.net:gr=urn:uuid:2ad8950e-48a5-4a74-8d99-ad76cc7fc74c;comp=sigcomp>
Allow: INVITE, ACK, CANCEL, BYE, PRACK, UPDATE, REFER, MESSAGE
RSeq: 9021
Content-Type: application/sdp
Content-Length: (…)
v=0
o=- 2987933623 2987933623 IN IP6 5555::eee:fff:aaa:bbb
s=-
c=IN IP6 5555::eee:fff:aaa:bbb
t=0 0
m=video 10001 RTP/AVPF 98
b=AS:75
a=curr:qos local none
a=curr:qos remote none
a=des:qos mandatory local sendrecv
a=des:qos mandatory remote sendrecv
a=conf:qos remote sendrecv
a=rtpmap:98 H263
a=fmtp:98 profile-level-id=0
m=audio 6544 RTP/AVP 97 96
b=AS:25.4
a=curr:qos local none
a=curr:qos remote none
a=des:qos mandatory local sendrecv
a=des:qos mandatory remote sendrecv
a=conf:qos remote sendrecv
a=rtpmap:97 AMR
a=fmtp:97 mode-set=0,2,5,7; maxframes=2
a=rtpmap:96 telephone-event
10.	Reserve IP-CAN bearer for media
The terminating UA sets up the bearer in accordance with the media description received SDP.
11.	Authorize QoS
P-CSCF authorizes the resources necessary for this session.
12.	183 (session progress) response (P-CSCF#"" to S-CSCF#2) – see example in table 5.1.2.2-6
Table 5.1.2.2-6: 183 (Session Progress) response (P-CSCF#2 to S-CSCF#2)
SIP/2.0 183 Session Progress
Via: SIP/2.0/UDP scscf2.home2.net;branch=z9hG4bK764z87.1, SIP/2.0/UDP icscf2_s.home2.net;branch=z9hG4bK871y12.1, SIP/2.0/UDP scscf1.home1.net;branch=z9hG4bK332b23.1, SIP/2.0/UDP pcscf1.visited1.net;branch=z9hG4bK240f34.1, SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd]:1357;comp=sigcomp;branch=z9hG4bKnashds7
Record-Route:
P-Asserted-Identity: ""John Smith"" <sip:user2_public1@home2.net>
P-Access-Network-Info:
P-Charging-Vector: icid-value=""AyretyU0dm+6O2IrT5tAFrbHLso=023551024""
Privacy:
From:
To:
Call-ID:
CSeq:
Require:
Contact:
Allow:
RSeq:
Content-Type:
Content-Length:
v=
o=
s=
c=
t=
m=
b=
a=
a=
a=
a=
a=
a=
a=
a=
m=
13.	183 (session progress) response (S-CSCF#1 to P-CSCF#1) – see example in table 5.1.2.2-7
Table 5.1.2.2-7: 183 (Session Progress) response (P-CSCF#2 to S-CSCF#2)
SIP/2.0 183 Session Progress
Via: SIP/2.0/UDP pcscf1.visited1.net;branch=z9hG4bK240f34.1, SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd]:1357;comp=sigcomp;branch=z9hG4bKnashds7)
Record-Route:
P-Asserted-Identity:
P-Access-Network-Info:
P-Charging-Vector: icid-value=""AyretyU0dm+6O2IrT5tAFrbHLso=023551024""
Privacy:
From:
To:
Call-ID:
CSeq:
Require:
Contact:
Allow:
RSeq:
Content-Type:
Content-Length:
v=
o=
s=
c=
t=
m=
b=
a=
a=
a=
a=
a=
a=
a=
a=
m=
14.	Authorize QoS
P-CSCF authorizes the resources necessary for this session.
15.	183 (Session Progress) response (P-CSCF to UE) – see example in table 5.1.2.2-8
Table 5.1.2.2-8: 183 (Session Progress) response (P-CSCF#1 to UE#1)
SIP/2.0 183 Session Progress
Via: SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd]:1357;comp=sigcomp;branch=z9hG4bKnashds7
Record-Route:
P-Asserted-Identity:
Privacy:
From:
To:
Call-ID:
CSeq:
Require:
Contact:
Allow:
RSeq:
Content-Type:
Content-Length:
v=
o=
s=
c=
t=
m=
b=
a=
a=
a=
a=
a=
a=
a=
16.	Reserve IP-CAN bearer for media
The originating UE sets up the bearer in accordance with the media description received SDP.
17 -24.	PRACK request / 200(OK) response exchange
The PRACK request does not carry SDP as the final codec decision is already made as part of the initial offer/answer exchange.
25.	UPDATE request (UE#1 to P-CSCF#1) - see example in table 5.1.2.2-9
UE#1 indicates that it can send and receive media as the necessary resources are available.
Table 5.1.2.2-9: UPDATE request (UE#1 to P-CSCF#1)
UPDATE <sip:[5555::eee:fff:aaa:bbb]:8805;comp=sigcomp
Via: SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd]:1357;comp=sigcomp;branch=z9hG4bKnashds7
Max-Forwards: 70
Route: <sip:pcscf1.visited1.net:7531;lr;comp=sigcomp>, <sip:orig@scscf1.home1.net;lr>
From: <sip:user1_public1@home1.net>; tag=171828
To: <tel:+12125552222> tag=314159
Call-ID: cb03a0s09a2sdfglkj490333
Cseq: 129 UPDATE
Require: sec-agree, precondition
Proxy-Require: sec-agree
Security-Verify: ipsec-3gpp; q=0.1; alg=hmac-sha-1-96; ealg=aes-cbc; spi-c=98765432; spi-s=87654321; port-c=8642; port-s=7531
Contact: <sip:user1_public1@home1.net;gr=urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6;comp=sigcomp>
Content-Type: application/sdp
Content-Length: (…)
v=0
o=- 2987933615 2987933615 IN IP6 5555::aaa:bbb:ccc:ddd
s=-
c=IN IP6 5555::aaa:bbb:ccc:ddd
t=0 0
m=video 3400 RTP/AVP 98
b=AS:75
a=curr:qos local sendrececv
a=curr:qos remote none
a=des:qos mandatory local sendrecv
a=des:qos mandatory remote sendrecv
a=rtpmap:98 H263
a=fmtp:98 profile-level-id=0
m=audio 3456 RTP/AVPF 97 96
b=AS:25.4
a=curr:qos local sendrecv
a=curr:qos remote none
a=des:qos mandatory local sendrecv
a=des:qos mandatory remote sendrecv
a=rtpmap:97 AMR
a=fmtp:97 mode-set=0,2,5,7; maxframes
26.	UPDATE request (P-CSCF#1 to S-CSCF#1 ) - see example in table 5.1.2.2-10
Table 5.1.2.2-10: UPDATE request (P-CSCF#1 to S-CSCF#1)
UPDATE sip:[5555::eee:fff:aaa:bbb]:8805;comp=sigcomp SIP/2.0
Via: SIP/2.0/UDP pcscf1.visited1.net;branch=z9hG4bK240f34.1, SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd]:1357;comp=sigcomp;branch=z9hG4bKnashds7
Max-Forwards: 69
P-Access-Network-Info:
P-Charging-Vector: icid-value=""AyretyU0dm+6O2IrT5tAFrbHLso=023551024""; ggsn=[5555::4b4:3c3:2d2:1e1]; pdp-sig=no; gcid=723084371; auth-token=43876559; flow-id=3
Route: <sip:scscf1.home1.net;lr>, <sip:scscf2.home2.net;lr>, <sip:pcscf2.visited2.net;lr>
From:
To:
Call-ID:
Cseq:
Require:
Contact:
Content-Type:
Content-Length:
v=
o=
s=
c=
t=
m=
b=
a=
a=
a=
a=
a=
a=
27.	UPDATE request (S-CSCF#2 to P-CSCF#2 ) - see example in table 5.1.2.2-11
Table 5.1.2.2-11: UPDATE request (S-CSCF#2 to P-CSCF#2)
UPDATE sip:[5555::eee:fff:aaa:bbb]:8805;comp=sigcomp SIP/2.0
Via: SIP/2.0/UDP scscf2.home2.net;branch=z9hG4bK764z87.1, SIP/2.0/UDP scscf1.home1.net;branch=z9hG4bK332b23.1, SIP/2.0/UDP pcscf1.visited1.net;branch=z9hG4bK240f34.1, SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd]:1357;comp=sigcomp;branch=z9hG4bKnashds7
Max-Forwards: 67
Route: <sip:pcscf2.visited2.net;lr>
From:
To:
Call-ID:
Cseq:
Require:
Contact:
Content-Type:
Content-Length:
v=
o=
s=
c=
t=
m=
b=
a=
a=
a=
a=
a=
a=
28.	UPDATE request (P-CSCF#2 to UE#2 ) - see example in table 5.1.2.2-12
Table 5.1.2.2-12: UPDATE request (S-CSCF#2 to P-CSCF#2)
UPDATE sip:[5555::eee:fff:aaa:bbb]:8805;comp=sigcomp SIP/2.0
Via: SIP/2.0/UDP pcscf2.visited2.net:5088;comp=sigcomp;branch=z9hG4bK361k21.1, SIP/2.0/UDP scscf2.home2.net;branch=z9hG4bK764z87.1, SIP/2.0/UDP scscf1.home1.net;branch=z9hG4bK332b23.1, SIP/2.0/UDP pcscf1.visited1.net;branch=z9hG4bK240f34.1, SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd]:1357;comp=sigcomp;branch=z9hG4bKnashds7
Max-Forwards: 66
From:
To:
Call-ID:
Cseq:
Require:
Contact:
Content-Type:
Content-Length:
v=
o=
s=
c=
t=
m=
b=
a=
a=
a=
a=
a=
a=
29.	200 (OK) response (UE#2 to P-CSCF#1)  - see example in table 5.1.2.2-13
UE acknowledges the UPDATE request  with a 200 (OK) response.
UE indicates that the local resources are available
Table 5.1.2.2-13: 200(OK) response (UE to P-CSCF)
SIP/2.0 200 OK
Via: SIP/2.0/UDP pcscf2.visited2.net:5088;comp=sigcomp;branch=z9hG4bK361k21.1, SIP/2.0/UDP scscf2.home2.net;branch=z9hG4bK764z87.1, SIP/2.0/UDP icscf2_s.home2.net;branch=z9hG4bK871y12.1, SIP/2.0/UDP scscf1.home1.net;branch=z9hG4bK332b23.1, SIP/2.0/UDP pcscf1.visited1.net;branch=z9hG4bK240f34.1, SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd]:1357;comp=sigcomp;branch=z9hG4bKnashds7
P-Access-Network-Info: 3GPP-UTRAN-TDD; utran-cell-id-3gpp=234151D0FCE11
From: <sip:user1_public1@home1.net>;tag=171828
To: <tel:+12125552222>;tag=314159
Call-ID: cb03a0s09a2sdfglkj490333
Cseq: 129 UPDATE
Require: precondition
Content-Type: application/sdp
Content-Length: (…)
v=0
o=- 2987933615 2987933615 IN IP6 5555::eee:fff:aaa:bbb
s=-
c=IN IP6 5555::eee:fff:aaa:bbb
t=0 0
m=video 3400 RTP/AVPF 98
b=AS:75
a=curr:qos local sendrececv
a=curr:qos remote sendrecv
a=des:qos mandatory local sendrecv
a=des:qos mandatory remote sendrecv
a=rtpmap:98 H263
a=fmtp:98 profile-level-id=0
m=audio 3456 RTP/AVP 97 96
b=AS:25.4
a=curr:qos local sendrecv
a=curr:qos remote sendrecv
a=des:qos mandatory local sendrecv
a=des:qos mandatory remote sendrecv
a=rtpmap:97 AMR
a=fmtp:97 mode-set=0,2,5,7; maxframes
30.	200 (OK) response (P-CSCF#2 to S-CSCF#2 )  - see example in table 5.1.2.2-14
Table 5.1.2.2-14: 200(OK) response (P-CSCF#2 to S-CSCF#2)
SIP/2.0 200 OK
Via: SIP/2.0/UDP scscf2.home2.net;branch=z9hG4bK764z87.1, SIP/2.0/UDP scscf1.home1.net;branch=z9hG4bK332b23.1, SIP/2.0/UDP pcscf1.visited1.net;branch=z9hG4bK240f34.1, SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd]:1357;comp=sigcomp;branch=z9hG4bKnashds7
P-Access-Network-Info:
From:
To:
Call-ID:
CSeq:
Require:
Content-Type:
Content-Length:
v=
o=
s=
c=
t=
m=
b=
a=
a=
a=
a=
a=
a=
m=
b=
a=
a=
a=
a=
a=
a=
a=
31.	200 (OK) response (S-CSCF#1 to P-CSCF#21)  - see example in table 5.1.2.2-15
Table 5.1.2.2-15: 200(OK) response (S-CSCF#1 to P-CSCF#1)
SIP/2.0 200 OK
Via: SIP/2.0/UDP pcscf1.visited1.net;branch=z9hG4bK240f34.1, SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd]:1357;comp=sigcomp;branch=z9hG4bKnashds7
From:
To:
Call-ID:
CSeq:
Require:
Content-Type:
Content-Length:
v=
o=
s=
c=
t=
m=
b=
a=
a=
a=
a=
a=
a=
m=
b=
a=
a=
a=
a=
a=
a=
a=
32.	200 (OK) response (P-CSCF#1 to UE#1)  - see example in table 5.1.2.2-16
Table 5.1.2.2-16: 200(OK) response (P-CSCF#1 to UE#1)
SIP/2.0 200 OK
Via: SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd]:1357;comp=sigcomp;branch=z9hG4bKnashds7
From:
To:
Call-ID:
CSeq:
Require:
Content-Type:
Content-Length:
v=
o=
s=
c=
t=
m=
b=
a=
a=
a=
a=
a=
a=
m=
b=
a=
a=
a=
a=
a=
a=
a=
33 -36 . 180 (Ringing) response
UE#2 indicates that it is ringing. The UE#2 does not use Require ""100rel"" as the 180 (Ringing) does not have a SDP and therefore need not to be sent reliable.
37 –40 .200 (OK) response
When the called party answers the UE sends a 200 (OK) response final response to the INVITE request (6) to P-CSCF, and starts the media flow(s) for this session.
40-44 ACK request
The calling party  responds to the 200 (OK) response with an ACK request.",TR 24.930,5.1.2.2,all_images/image_1509.jpeg,"IMS session setup, resource reservation on both sides "
,TR 24.930,5.1,all_images/image_1512.jpeg,"IMS session setup, resource reservation on originating side only "
,TR 24.930,5.3,all_images/image_1514.jpeg,"IMS session setup, resource reservation only on terminating side "
,TR 24.930,5.3,all_images/image_1516.jpeg,"IMS session setup, resource reservation only on terminating side (NW-initiated)"
,TR 24.930,5.4,all_images/image_1517.jpeg,"IMS session setup, resource reservation on originating side"
,TR 24.930,5.5,all_images/image_1520.jpeg,"IMS session setup, resource reservation on terminating side"
,TR 24.930,5.6,all_images/image_1521.jpeg,"IMS session setup, no resource reservation, preconditions are used"
"The NAS configuration MO is used to manage configuration parameters related to NAS functionality for a UE supporting provisioning of such information. The presence and format of the non-access stratum configuration file on the USIM is specified in 3GPP TS 31.102 [6].
The MO identifier is: urn:oma:mo:ext-3gpp-nas-config:1.0.
The OMA DM Access Control List (ACL) property mechanism (see OMA-ERELD-DM-V1_2 [2]) may be used to grant or deny access rights to OMA DM servers in order to modify nodes and leaf objects of the NAS configuration MO.
The following nodes and leaf objects are possible in the NAS configuration MO as described in figure 4-1:
Figure 4-1: The NAS configuration Management Object (1 of 3)
Figure 4-2: The NAS configuration Management Object (2 of 3)
Figure 4-3: The NAS configuration Management Object (3 of 3)",TS 24.368,4,all_images/image_1522.jpeg,The NAS configuration Management Object (1 of 3)
,TS 24.229,5,all_images/image_1523.jpeg,User identity verification flow at the AS
"Upon receiving indication from the upper layer that no 5G-NAS messages need to be transmitted between the UE and N3IWF, the UE shall terminate the EAP-5G session by sending an EAP-Response/5G-Stop message to the N3IWF.
On reception of EAP-Response/5G-Stop message, the N3IWF shall complete the EAP-5G session by sending an EAP-Failure message to the UE.
On reception of the EAP-Failure message from the N3IWF, the UE shall delete any context related to IKE SA without requiring an explicit INFORMATIONAL exchange carrying a Delete payload as specified in IETF RFC 7296 [6].
Figure 7.3.3.3-1 shows an example the EAP-5G session completion after registration reject.
Figure 7.3.3.3-1: EAP-5G session when the UE's registration over untrusted non-3GPP access is rejected",TS 24.502,7.3.3.3,all_images/image_1524.jpeg,EAP-5G session when the UE's registration over untrusted non-3GPP access is
"The Location Notification operation enables the MME to trigger the end-user notification verification process on the UE using NAS signaling.  The NAS signaling (see  5.2.1.1.1) are transported using the Downlink Generic NAS Transport message and the Uplink Generic NAS Transport message defined in 3GPP TS 24.301 [3]. Figure 5.2.1.1.0-1 illustrates an example of the NAS signaling transport for an EPC-MT-LR session.
Figure 5.2.1.1.0-1: NAS signaling transport for Location Notification
NOTE:	The optional Additional Information IE of the Downlink/Uplink Generic NAS Transport message is not used when the LCS Location Notification signaling are transported in the Generic Message Container.",TS 24.171,5.2.1.1.0,all_images/image_1527.png,NAS signaling transport for Location Notification
"The MME sends LPP message and the associated Routing Identifier in the Downlink Generic NAS Transport message (Refer to 3GPP TS 24.301 [3]). Figure 5.2.1.2-1: illustrates an example of the NAS signaling transport for downlink LPP messages.
Figure 5.2.1.2-1: NAS signaling transport for downlink LPP messages",TS 24.171,5.2.1.2,all_images/image_1528.png,NAS signaling transport for downlink LPP messages
"The UE sends LPP message and the associated Routing Identifier in the Uplink Generic NAS Transport message (Refer to 3GPP TS 24.301 [3]). Figure 5.2.2.2-1 illustrates an example of the NAS signaling transport for uplink LPP messages.
Figure 5.2.2.2-1: NAS signaling transport for uplink LPP messages",TS 24.171,5.2.2.2,all_images/image_1530.png,NAS signaling transport for uplink LPP messages
"The Allowed CSG List Management Object (MO) is used to manage the list of allowed CSG IDs, the Operator CSG IDs and the related restricted access information at UE.
The Management Object Identifier is: urn:oma:mo:ext-3gpp-csg:1.0.
The OMA DM Access Control List (ACL) property mechanism (see OMA-ERELD-DM-V1_2 [5]) may be used to grant or deny access rights to OMA DM servers in order to modify nodes and leaf objects of the Allowed CSG list MO.
The following nodes and leaf objects are possible under the Allowed CSG List node as described in figure 4-1:
Figure 4-1: The Allowed CSG List Management Object
When a UE receives an Allowed CSG List Management Object (MO) containing the Allowed CSG List, it shall update its Allowed CSG list stored in a USIM or in a non-volatile memory in the ME.
When a UE receives an Allowed CSG List Management Object (MO) containing the Operator CSG List, it shall update the Operator CSG List stored in a non-volatile memory in the ME.",TS 24.285,4,all_images/image_1531.jpeg,The Allowed CSG List Management Object
"According to 3GPP TS 23.281 [5] the controlling MCVideo function is divided into a transmission control server and a media distribution function. In the present document the internal structure of the MCVideo server is illustrated in figure 4.2-1.
NOTE:	The real internal structure of the MCVideo server is implementation specific but a possible internal structure is shown to illustrate the procedures.
Figure 4.2.1-1: Internal structure of transmission control in the controlling MCVideo function
All entities in the controlling MCVideo function are assumed to have a direct communication interface to the application and signalling plane. The interface to the application and signaling plane carries information about SIP session initialisation and SIP session release, SDP content, etc.
The reference point MCVideo-3 is described in 3GPP TS 23.281 [5].
The transmission and reception control interface towards the MCVideo client receives and transmits the transmission control and reception control messages from and to the MCVideo client via the participating MCVideo function. The procedures are controlled by the state machines described in clause 6.3.5 and clause 6.3.7. One transmission control state machine and one reception control state machine are needed for each MCVideo client participating in an MCVideo call.
The transmission and reception control arbitration logic is performing the transmission and reception control. The transmission and reception control arbitration logic is controlled by the state machines described in clause 6.3.4 and clause 6.3.5. One transmission control state machine and one reception control ared needed per MCVideo call.
The transmission request queue is accessible both by the transmission and reception control interface towards the MCVideo client for all MCVideo clients in the call and the transmission and reception control arbitration logic.
The network media interface is receiving and sending media from and to the associated MCVideo client via the participating MCVideo function. The network media interface is out of scope of the present document. One network media interface is needed for each MCVideo client participating in an MCVideo call.
The media distributor is controlled by the transmission and reception control arbitration logic. The media distributor is out of scope of the present document. One media distributor is needed per MCVideo call.
The internal interfaces are assumed to transport the following types of information.
1.	The interface between the network media interface and the transmission and reception control interface towards the MCVideo client:
a.	Indication that the network media interface has started to receive media packets from the associated MCVideo client or that media packets are no longer received from the associated MCVideo client.
NOTE:	It is an implementation option whether an indication e.g. is sent for every received RTP media packet or only when the first packet is received and then when no more RTP packets are received.
2.	The interface between the transmission and reception control interface towards the MCVideo client and the transmission and reception control arbitration logic:
a.	Transmission control and reception control messages to and from the associated MCVideo client, requests to create or delete the state machine instance for the associated MCVideo client. The transmission control and reception control messages to the transmission and reception control arbitration logic are limited to transmission control and reception control messages that will change the state of the transmission.
3.	The interface between the network media interface and the media distributor:
a.	Media to and from associated MCVideo clients. This interface is out of scope of the present document.
4.	The interface between the transmission and reception control arbitration logic and the media distributor:
a.	Requests to start or stop distributing media to participants in the MCVideo call. Indication that the media distributor has started to receive media packets from the network media interface associated with the MCVideo client with the permission to send media or that media packets are no longer received from the network media interface from the associated MCVideo client.
5.	The interface between the transmission and reception control interface towards the MCVideo client and the transmission request queue:
a.	Requests to store received Transmission Request messages in the queue or requests to remove Transmission Request messages from the queue and the queue content for building the Transmission Queue Position Info message.
6.	The interface between the transmission and reception control arbitration logic and the transmission request queue:
a.	Requests to store received Transmission Request messages in the queue or requests to remove Transmission Request messages from the queue. Indications that the queue is modified.",TS 24.581,4.2.1,all_images/image_1532.png,Internal structure of transmission control in the controlling MCVideo function
"The transmission participant shall behave according to the state diagram and the state transitions specified in this clause.
Figure 6.2.4.1-1 shows the state diagram for 'Transmission participant state transition diagram for basic transmission control operation'.
Figure 6.2.4.1-1: Transmission participant state transition diagram for basic transmission control operation.
State details are explained in the following clauses.
If a transmission control message arrives in a state where there is no specific procedure specified for received transmission control message, the transmission participant shall discard the transmission control message and shall remain in the current state.
NOTE:	A badly formatted transmission control message received in any state is ignored by the transmission participant and does not cause any change of the current state.",TS 24.581,6.2.4.1,all_images/image_1533.jpeg,Transmission participant state transition diagram for basic transmission control
"The transmission participant shall behave according to the state diagrams and the state transitions specified in this clause.
Figure 6.2.5.1-1 shows the state diagram for 'Transmission participant state transition diagram for general reception control operation'.
Figure 6.2.5.1-1: Transmission participant state transition diagram for general reception control operation.
Figure 6.2.5.1-2 shows the state diagram for 'Transmission participant state transition diagram for basic reception control operation'.
Figure 6.2.5.1-2: Transmission participant state transition diagram for basic reception control operation.
The reception control arbitration logic in the transmission control participant shall keep one instance of the 'general reception control operation' state machine per MCVideo call and shall create one instance of the 'basic reception control operation' state machine for each 'receive media request' of the MCVideo user.
State details are explained in the following clauses.
If an RTP media packet arrives in a state where there is no specific procedure specified for the RTP media packets or the received reception control message, the transmission participant shall discard the reception control message or the RTP media packet and shall remain in the current state.
NOTE:	A badly formatted RTP packet or reception control message received in any state is ignored by the transmission participant and does not cause any change of the current state.",TS 24.581,6.2.5.1,all_images/image_1534.jpeg,Transmission participant state transition diagram for general reception control
"The transmission participant shall behave according to the state diagrams and the state transitions specified in this clause.
Figure 6.2.5.1-1 shows the state diagram for 'Transmission participant state transition diagram for general reception control operation'.
Figure 6.2.5.1-1: Transmission participant state transition diagram for general reception control operation.
Figure 6.2.5.1-2 shows the state diagram for 'Transmission participant state transition diagram for basic reception control operation'.
Figure 6.2.5.1-2: Transmission participant state transition diagram for basic reception control operation.
The reception control arbitration logic in the transmission control participant shall keep one instance of the 'general reception control operation' state machine per MCVideo call and shall create one instance of the 'basic reception control operation' state machine for each 'receive media request' of the MCVideo user.
State details are explained in the following clauses.
If an RTP media packet arrives in a state where there is no specific procedure specified for the RTP media packets or the received reception control message, the transmission participant shall discard the reception control message or the RTP media packet and shall remain in the current state.
NOTE:	A badly formatted RTP packet or reception control message received in any state is ignored by the transmission participant and does not cause any change of the current state.",TS 24.581,6.2.5.1,all_images/image_1535.jpeg,Transmission participant state transition diagram for basic reception control
"The transmission control server arbitration logic in the transmission control server shall behave according to the state diagram and state transitions specified in this clause.
Figure 6.3.4.1-1 shows the general transmission control operation states (G states) and the state transition diagram.
Figure 6.3.4.1-1: Transmission control server state transition diagram for 'general transmission control operation'
The transmission control arbitration logic in the transmission control server shall keep one instance of the 'general transmission control operation' state machine per MCVideo call.
If transmission control messages or RTP media packets arrives in a state where there is no procedure specified in the following clauses the transmission control arbitration logic in the transmission control server:
1.	shall discard the transmission control message;
2.	shall request the media distributor in the MCVideo server to discard any received RTP media packet; and
3.	shall remain in the current state.
State details are explained in the following clauses.",TS 24.581,6.3.4.1,all_images/image_1536.jpeg,Transmission control server state transition diagram for 'general transmission
"The transmission control interface towards the MCVideo client in the transmission control server shall behave according to the state diagram and state transitions specified in this clause.
Figure 6.3.5.1-1 shows the states and state transitions for an associated transmission participant in the transmission control server.
Figure 6.3.5.1-1: Transmission control server state transition diagram for basic transmission control operation towards the transmission participant
The transmission control interface towards the MCVideo client in the transmission control server shall create one instance of the 'basic transmission control operations' state machine towards the MCVideo client for every transmission participant served by the transmission control server as follows:
1.	For pre-arranged group call in case of an originating MCVideo call, the 'basic transmission control operation towards the transmission participant' state machine shall be created when the MCVideo server sends the SIP 200 (OK) response towards the originating MCVideo client.
2.	For pre-arranged group call in case of a terminating MCVideo call, the 'basic transmission control operation towards the transmission participant' state machine shall be created when the transmission control server receives the SIP 200 (OK) response.
3.	For chat group call the 'basic transmission control operation state machine towards the transmission participant' shall be created when the MCVideo server sends the SIP 200 (OK) response to the received initial SIP INVITE request.
The transmission participant associated to the 'basic transmission control operation towards the transmission participant' state machine is here referred to as the ""associated transmission participant"".
The external inputs to the state machine are:
1.	directives coming from the transmission control arbitration logic;
2.	transmission messages sent by the transmission participants;
3.	media; and
4.	in certain cases, SIP messages used for call handling.
If transmission control messages or RTP media packets arrives in a state where there is no procedure specified in the following clauses, the transmission control interface towards the MCVideo client in the transmission control server:
1.	shall discard the transmission control message;
2.	shall request the network media interface in the MCVideo server to discard any received RTP media packet; and
3.	shall remain in the current state.
State details are explained in the following clauses.",TS 24.581,6.3.5.1,all_images/image_1537.jpeg,Transmission control server state transition diagram for basic transmission control
"The reception control arbitration logic in the transmission control server shall behave according to the state diagram and state transitions specified in this clause.
Figure 6.3.6.1-1 shows the general reception operation states (Gr states) and the state transition diagram.
Figure 6.3.6.1-1: Transmission control server state transition diagram for 'general reception control operation'
The reception control arbitration logic in the transmission control server shall keep one instance of the 'general transmission control operation' state machine per MCVideo call.
If transmission control messages or RTP media packets arrives in a state where there is no procedure specified in the following clauses the transmission control arbitration logic in the transmission control server:
1.	shall discard the transmission control message;
2.	shall request the media distributor in the MCVideo server to discard any received RTP media packet; and
3.	shall remain in the current state.
State details are explained in the following clauses.",TS 24.581,6.3.6.1,all_images/image_1538.jpeg,Transmission control server state transition diagram for 'general reception control
"The transmission participant interface shall behave according to the state diagram and state transitions specified in this clause.
Figure 6.5.5.1-1 shows the general transmission control operation states (P states) and the state transition diagram.
Figure 6.5.5.1-1: The 'transmission participant interface state transition' state diagram
The transmission participant interface shall keep one instance of the 'transmission participant interface state transition' state machine per MCVideo client in a session.
The transmission participant associated to the 'transmission participant interface state transition' state machine is in the following clauses referred to as the associated transmission participant.
If transmission control messages or RTP media packets arrives in a state where there is no procedure specified in the following clauses the transmission participant interface:
1.	shall discard the transmission control message;
2.	shall request the network media interface to discard any received RTP media packet; and
3.	shall remain in the current state.
State details are explained in the following clauses.",TS 24.581,6.5.5.1,all_images/image_1539.jpeg,The 'transmission participant interface state transition' state diagram
"The transmission participant shall behave according to the state diagram and the transitions specified in this clause.
The received transmission messages and the RTP media packets are inputs to the state machine according to their arrival order. They are not ignored unless otherwise stated.
The MCVideo client also provides input to the state machine as request to transmit video (click video transmission send button) or as end of video transmission (click video transmission end button).
Figure 7.2.3.1-1 show the 'Transmission participant state diagram – basic operation'.
Figure 7.2.3.1-1: 'Transmission participant state diagram – basic operation'
State details are explained in the following clauses.
If an RTP media packet or a transmission control message arrives in a state where there is no specific procedure specified for the RTP media packet or the received transmission control message, the transmission participant shall discard the transmission control message or the RTP media packet and shall remain in the current state.
NOTE:	A badly formatted RTP packet or transmission control message received in any state is ignored by the transmission participant and does not cause any change of the current state.",TS 24.581,7.2.3.1,all_images/image_1540.jpeg,'Transmission participant state diagram – basic operation'
"If the participating MCVideo function supports the MBMS subchannel control procedure, the participating MCVideo function shall support the behaviour implied by the state machine specified in this clause. The specifications are on the reception of transmission control messages from the controlling MCVideo function, sending of transmission control messages and the allocation/deallocation of MBMS subchannels for a transmission in a group session.
Figure 10.2.1-1 shows the participating MCVideo function MBMS subchannel control state diagram.
Figure 10.2.1-1: Participating MCVideo function MBMS subchannel control state diagram
If a transmission control message or RTP media packet arrives in a state where there are no procedures specified in the clauses below, the participating MCVideo function shall discard the message.",TS 24.581,10.2.1,all_images/image_1541.jpeg,Participating MCVideo function MBMS subchannel control state diagram
"When PLMN D detects service interruptions and failures in PLMN D caused by a disaster, PLMN D informs the CBE using means out of scope of 3GPP.
If the CBE decides subject to regulatory requirements that the Disaster Condition applies for PLMN D and that UEs of PLMN D can use disaster roaming in another PLMN (called PLMN A) in the area, the CBE provides the CBC or the CBCF of PLMN A with a message (e.g. Disaster Roaming Command) with (updated) ""disaster roaming PLMN and area list"" containing PLMN D and the area. If the CBE provided a ""disaster roaming PLMN and area list"" previously, the CBE also indicates the previous ""disaster roaming PLMN and area list"" in the same message.
Upon receiving the message:
-	if PLMN A is able to provide disaster roaming to UEs of PLMN D in the area as indicated in the (updated) ""disaster roaming PLMN and area list"", the CBC or the CBCF of PLMN A informs the CBE accordingly (e.g. by sending Disaster Roaming Command Ack) and provides the (updated) ""disaster roaming PLMN and area list"" to the AMF(s) of PLMN A which serve at least part of an area in the (updated) ""disaster roaming PLMN and area list"" or the previous ""disaster roaming PLMN and area list"", if received; or
-	if PLMN A is unable to provide disaster roaming to UEs of PLMN D in the area as indicated in the (updated) ""disaster roaming PLMN and area list"", the CBC or the CBCF of PLMN A informs the CBE accordingly (e.g. by sending Disaster Roaming Command Reject).
When an AMF of PLMN A receives the ""disaster roaming PLMN and area list"" from the CBC (via the PWS-IWF) or the CBCF, the AMF removes the stored ""disaster roaming PLMN and area list"", if any, and if the AMF serves at least part of an area of the ""disaster roaming PLMN and area list"" provided by the CBC (via the PWS-IWF) or the CBCF, the AMF stores the ""disaster roaming PLMN and area list"".
When PLMN D resolves the service interruptions and failures in PLMN D caused by the disaster, PLMN D informs the CBE using means out of scope of 3GPP. If the CBE decides subject to regulatory requirements that the Disaster Condition no longer applies for PLMN D, the CBE provides the CBC or the CBCF with a message with an updated ""disaster roaming PLMN and area list"" not containing PLMN D and the area, and the previous ""disaster roaming PLMN and area list"".
Upon receiving the message, the CBC (via the PWS-IWF) or the CBCF provides the updated ""disaster roaming PLMN and area list"" to the AMF(s) of PLMN A which serve at least part of an area in the updated ""disaster roaming PLMN and area list"" or the previous ""disaster roaming PLMN and area list"".
When the AMF receives the ""disaster roaming PLMN and area list"" from the CBC (via the PWS-IWF) or the CBCF, the AMF removes the stored ""disaster roaming PLMN and area list"", if any, and if the AMF serves at least part of an area of the ""disaster roaming PLMN and area list"" provided by the CBC (via the PWS-IWF) or the CBCF, the AMF stores the ""disaster roaming PLMN and area list"".
Example flow can be found in figure 6.8.1.2-1.
Figure 6.8.1.2-1: CBE informing PLMN A without Disaster Condition with deployed CBCF that UEs of PLMN D with Disaster Condition can use disaster roaming in PLMN A",TR 24.811,6.8.1.2,all_images/image_1542.jpeg,CBE informing PLMN A without Disaster Condition with deployed CBCF that UEs of
"The Disaster Condition caused RAN unavailability can be treated as a network fault. As per 3GPP TS 32.101 [5] for defining the legacy PLMN management functional architecture, the fault management is a basic management function provided by the PLMN NMS.
Furthermore, as per 3GPP TS 28.533 [6] for the SBA based NMS defined for 5GS, the network fault supervision service is also a basic management service provided by the PLMN NMS for the management of the 3GPP network.
The PLMN NMS can directly interface with different network elements within 3GPP network, including core network functions (e.g. AMF, SMF) and RAN nodes (e.g. gNB) via O&M operations. The required O&M operations may or may not be standardized, i.e. to use the proprietary implementation.
The O&M-based solution for each question within Key Issue #6 is described as below:
When the Disaster Condition is no longer applicable to the serving PLMN, the serving PLMN NMS detects the fault recovery/correction via O&M operations, removes the stored disaster PLMN ID and disaster area information and then sends an indicaiton to other Disaster Roaming PLMN NMS to inform that the Disaster Condition is no longer applicable for it. The Disaster Roaming PLMN NMS removes the stored disaster PLMN ID and disaster area information and then sends an indicaiton to its AMFs which are providing the Disaster Roaming for the Disaster Inbound Roamers. The Disaster Roaming PLMN AMF removes the stored disaster PLMN ID and disaster area information if any, and informs the Disaster Inbound Roamers currently registered to it that the Disaster Condition is no longer applicable for its previous selected PLMN for which the Disaster Condition is no longer applicable over NAS.
The Disaster Roaming PLMN AMF determines the previous selected PLMN of the Disaster Inbound roamers when the Disaster Inbound Roamers register to the Disaster Roaming PLMN, as specified in the solution(s) to Key Issue #4 (Registration to the roaming PLMN without Disaster Condition in case of Disaster Condition).
NOTE 1:	The Disaster Roaming PLMN NMS can also send the indicaiton to its RAN nodes which are providing the Disaster Roaming for the Disaster Inbound Roamers and then the RAN node informs the Disaster Inbound Roamers that the Disaster Condition is no longer applicable for its previous selected PLMN for which the Disaster Condition is no longer applicable over radio interface. However this is not considered as an alternative in this solution.
""-	How to minimize interruption of the service receiving from Disaster Roaming PLMN (e.g. emergency service or high priority service) when the UE is notified that Disaster Condition is no longer applicable;""
When the Disaster Roaming PLMN AMF was notified that the Disaster Condition is no longer applicable for Disaster Inbound Roamers, to minimize interruption of the service receiving from Disaster Roaming PLMN (e.g. emergency service or high priority service), the AMF handles as following:
(1)	When the Disaster Inbound Roamer is current in the connected mode:
In this case, when the user-plane resources was established for the Disaster Inbound Roamer (i.e. the user data services are ongoing, including emergency service or high priority service), then after the completion of the ongoing user data services and before the release of the current N1 NAS signalling connection, the AMF initiates a network-initiated de-registration procedure by sending DEREGISTRATION REQUEST message with 5GMM cause #11 (PLMN not allowed) to the UE (i.e. Disaster Inbound Roamer). After completion of the network-initiated de-registration procedure, the AMF releases the current N1 NAS signalling connection to move the UE to the idle mode.
NOTE 2:	The AMF can based on the existing mechanism to know the completion of the ongoing user data services, e.g. based on the N2 UE Context Release Request from RAN.
(2)	When the Disaster Inbound Roamer is current in the idle mode:
The AMF defers the handling to the next time when the UE moves to the connected mode. When next time received a REGISTRATION REQUEST message or SERVICE REQUEST message from the UE, the AMF rejects it with 5GMM cause #11 (PLMN not allowed).
NOTE 3:	There is another alternative for the AMF actively pages the UE to move to the connected mode and then initiate a network-initiated de-registration procedure by sending DEREGISTRATION REQUEST message with 5GMM cause #11 (PLMN not allowed) to the UE. However, this is not considered as an alternative in this solution due to it will consume a lot of radio resources considering due to paging.
""-	How to remove the stored information on Disaster Condition from the UE's storage;""
Upon receipt of registration reject or service reject or de-registration request with 5GMM cause #11 (PLMN not allowed), if the UE currently is registered for the Disaster Roaming, then the UE knows the Disaster Condition is no longer applicable to its previous selected PLMN and then removes the stored information on Disaster Condition from the UE's storage.
""-	How Disaster Inbound Roamer UEs perform network selection when notified that Disaster Condition is no longer applicable.""
Upon receipt of registration reject or service reject or de-registration request with 5GMM cause #11 (PLMN not allowed), if the UE currently is registered for the Disaster Roaming, then the UE knows the Disaster Condition is no longer applicable to its previous selected PLMN and then performs the PLMN selection as legacy with the difference that to treat the previous selected PLMN as higher priority.
The end-to-end flow of O&M-based solution for KI#6 can be shown in Figure 6.29.2-1 for the UE in the connected mode and in Figure 6.29.2-2 for the UE in the idle mode:
Figure 6.29.2-1: End-to-end flow of O&M-based solution for KI#6, connected mode
Figure 6.29.2-2: End-to-end flow of O&M-based solution for KI#6, idle mode",TR 24.811,6.29.2,all_images/image_1543.jpeg,"End-to-end flow of O&M-based solution for KI#6, connected mode"
"Figure 6.57.1.2-1: UE registering with PLMN D via N3IWF using connectivity provided from PLMN A
The steps of the solution are as follows:
1.	The UE applies the network selection procedure for disaster condition, e.g. as described in other Key Issues. As a result, the UE selects to camp on a cell from PLMN A.
2.	The UE initiates registration procedure with PLMN A. The UE indicates in the RRC signalling or in the NAS REGISTRATION REQUEST message that the registration is due to disaster conditions. The NAS REGISTRATION REQUEST message includes the UE's subscription concealed identifier (SUCI), which is based on the HPLMN SUPI. If PLMN D is not the HPLMN, the UE includes the identity of PLMN D in the message.
3.	The AMF determines that the registration is by the UE from PLMN D and is due to disaster conditions in PLMN D. Since the AMF cannot communicate with PLMN D due to missing roaming agreements, the AMF determines to apply:
a)	a registration without performing the primary authentication procedure PLMN A applies unauthenticated registration which is similar to Emergency registration with no USIM. The AMF may request the PEI of the UE; or
b)	a local registration, which requires the AMF having local configuration data applicable for disaster conditions (e.g the configuration data may be configured from the OAM). The AMF performs a NAS security mode command (SMC) procedure and the UE transmits, in a secure way, its subscriber permanent identifier (SUPI) to the AMF, where it is stored to be used for signalling exchange with the SMF for e.g. charging purposes.
NOTE 1:	The end-to-end details of security protocol for the NAS message exchange during the registration is to be determined by SA3. Potential security risks resulting from accepting registration requests from the disaster inbound roamers from PLMN D without primary network authentication are to be checked by SA3.
4.	The AMF sends REGISTRATION ACCEPT message to the UE including an allowed NSSAI having a single S-NSSAI identifying a network slice that provides disaster condition services in PLMN A. The AMF indicates also to the UE that only a single PDU session is allowed which can be used for communication with destination addresses.
NOTE 2:	The UE is supposed to establish PDU session with an N3IWF in PLMN D.
5.	The UE sends a UL NAS TRANSPORT message containing a PDU SESSION ESTABLISHMENT REQUEST message to the AMF. The AMF selects an SMF (e.g. by applying the disaster configuration data) and sends an Nsmf_PDUSession_CreateSMContext request to SMF requesting to establish a PDU session for the UE. The AMF may indicate that the requested PDU session is due to disaster condition and also to include PLMN A ID from the SUCI from step 2.
6.	Based on the local configuration data for disaster in the SMF and the additional indication from the AMF:
a)	The SMF decides to apply restricted data connectivity for the requested PDU session so that communication with destination addresses in PLMN D is only supported. The SMF restricts the bit rate of the PDU sessions and configures the UPF to perform deep packet inspection (DPI) to determine if the UE has successfully registered to PLMN D via the N3IWF.
b)	If the local registration is performed so the AMF stores the UE's SUPI and also transmits to the SMF, the SMF uses the SUPI as a key in the signalling exchange with the charging function (CHF) and to generate charging data records (CDRs) for this UE.
NOTE 3:	SA5 needs to be consulted for the whether charging based on PEI or SUCI can be performed for an unauthenticated UE of PLMN D while roaming in PLMN A.
7.	The SMF sends a PDU SESSION ESTABLISHMENT ACCEPT message to the UE. This message indicates that data connectivity over the PDU session is limited to destination address of the N3IWF in PLMN D. The UE triggers registration to PLMN D via the N3IWF.
8. – 9.	The UE performs 5G registration via untrusted non-3GPP access via the N3IWF with PLMN D.
10.	The UPF determines whether the UE has successfully registered to PLMN D via the N3IWF, e.g. by performing deep-packet inspection (DPI) and analysing the traffic exchange via the PDU session. The UPF informs the SMF with the result and the SMF forwards this information to the AMF. The SMF decides to increase the bit rate of the PDU session.
11.	The AMF verifies whether the UE has successfully registered with PLMN D or the UE has registered to PLMN A in an attempt to misuse PLMN A. In the latter case, the AMF initiates deregistration procedure.
The SMF in PLMN A may collect offline charging data for the disaster inbound roamers using the PLMN D ID as key. PLMN D may also collect charging data for the UE.
NOTE 4:	Charging record is collected for all inbound disaster roamers as a group and not individually.",TR 24.811,6.57.1.2,all_images/image_1545.png,UE registering with PLMN D via N3IWF using connectivity provided from PLMN A
"The V2X communication provisioning MO is used to manage the V2X configuration parameters in a UE supporting 3GPP TS 24.386 [4].
The MO identifier is: urn:oma:mo:ext-3gpp-V2X-communication-provisioning:1.0.
The OMA DM access control list (ACL) property mechanism (see OMA-ERELD-DM-V1_2 [3]) can be used to grant or deny access rights to OMA DM servers in order to modify nodes of the V2X communication provisioning MO.
In order to request provisioning of the V2X communication provisioning MO, the UE includes in the Package 1 (see OMA-TS-DM_Protocol-V1_2 [5]) a Generic Alert message (along with other commands):
-	with the ""Type"" element set to ""urn:oma:mo:ext-3gpp-V2X-communication-provisioning:1.0"";
-	with the ""LocURI"" element (inside the ""Source"" element) set to the address of the V2X communication provisioning MO as specified by OMA-TS-DM_Protocol-V1_2 [5]; and
-	without the ""Data"" element.
The V2X communication provisioning MO consists of the nodes described in figure 4.1-1.
NOTE:	In this release of the document, charging configuration parameters in the V2X communication provisioning MO are not specified.
Figure 4.1-1: The V2X communication provisioning MO (part 1)
Figure 4.1-2: The V2X communication provisioning MO (part 2)
Figure 4.1-3: The V2X communication provisioning MO (part 3)
Figure 4.1-4: The V2X communication provisioning MO (part 4)
Figure 4.1-5: The V2X communication provisioning MO (part 5)
Figure 4.1-6: The V2X communication provisioning MO (part 6)
Figure 4.1-7: The V2X communication provisioning MO (part 7)
Figure 4.1-8: The V2X communication provisioning MO (part 8)
Figure 4.1-9: The V2X communication provisioning MO (part 9)
Figure 4.1-10: The V2X communication provisioning MO (part 10)
Figure 4.1-11: The V2X communication provisioning MO (part 11)",TS 24.385,4.1,all_images/image_1546.jpeg,The V2X communication provisioning MO (part 4)
"Integrity protection can be applied to a whole XML MIME body. When integrity protection is enabled, all XML MIME bodies transported in SIP requests and responses are integrity protected. The following XML MIME bodies used in the present specification in SIP signalling can be integrity protected:
-	application/vnd.3gpp.mcdata-info+xml;
-	application/vnd.3gpp.mcdata-mbms-usage-info+xml;
-	application/vnd.3gpp.mcdata-location-info+xml;
-	application/poc-settings+xml;
-	application/resources-list+xml;
-	application/vnd.3gpp.mcdata-affiliation-command+xml;
-	application/pidf+xml; and
-	application/xcap-diff+xml.
If integrity protection is enabled, and one or more of the XML MIME bodies complying to the types listed above are included in a SIP request or SIP response, then a MIME body of type application/vnd.3gpp.mcptt-signed+xml specified in 3GPP TS 24.379 [10] is included in the SIP request or SIP response containing one or more signatures pointing to those XML MIME bodies as illustrated in Figure 6.5.3.1-1.
In order to integrity protect the XML MIME bodies listed above in this clause in SIP requests and SIP responses, the MCData client and MCData server shall, for each MIME body, include the Content-ID header field as specified in IETF RFC 2045 [32] containing a Content-ID (""cid"") Uniform Resource Locator (URL) as specified in IETF RFC 2392 [33].
Figure 6.5.3.1-1: Integrity Protection of XML MIME bodies in SIP requests and SIP responses
Each MIME body that is integrity protected is assigned a unique signature.
Configuration for applying integrity protection is not selective to a specific MIME body. If configuration for integrity protection is turned on, then all XML MIME bodies in SIP requests and responses are integrity protected. If configuration for integrity protection is turned off, then no XML MIME bodies in SIP requests and SIP responses are integrity protected.",TS 24.282,6.5.3.1,all_images/image_1547.png,Integrity Protection of XML MIME bodies in SIP requests and SIP responses
"Integrity protection can be applied to a whole XML MIME body. When integrity protection is enabled, all XML MIME bodies transported in SIP requests and responses are integrity protected. The following XML MIME bodies used in the present specification in SIP signalling can be integrity protected:
-	application/vnd.3gpp.mcptt-info+xml;
-	application/poc-settings+xml;
-	application/resources-list+xml;
-	application/vnd.3gpp.mcptt-mbms-usage-info+xml;
-	application/vnd.3gpp.mcptt-location-info+xml;
-	application/vnd.3gpp.mcptt-affiliation-command+xml;
-	application/vnd.3gpp.mcptt-floor-request+xml;
-	application/conference-info+xml;
-	application/pidf+xml; and
-	application/xcap-diff+xml.
If integrity protection is enabled, and one or more of the XML MIME bodies complying to the types listed above are included in a SIP request or SIP response, then a MIME body of type application/vnd.3gpp.mcptt-signed+xml is included in the SIP request or SIP response containing one or more signatures pointing to those XML MIME bodies as illustrated in Figure 6.6.3.3-1.
In order to integrity protect the XML MIME bodies listed above in this clause in SIP requests and SIP responses, the MCPTT client and MCPTT server shall for each MIME body, include the Content-ID header field as specified in IETF RFC 2045 [68] containing a Content-ID (""cid"") Uniform Resource Locator (URL) as specified in IETF RFC 2392 [62].
Figure 6.6.3.1-1: Integrity Protection of XML MIME bodies in SIP requests and SIP responses
Each MIME body that is integrity protected is assigned a unique signature.
When integrity protecting the XML content in SIP REFER request used for pre-established sessions, the application/vnd.3gpp.mcptt-signed+xml MIME type can appear twice in the SIP REFER request as illustrated in Figure 6.6.3.1-2.
Figure 6.6.3.1-2: Integrity Protection of XML MIME bodies in SIP REFER requests
-	an application/vnd.3gpp.mcptt-signed+xml MIME body is included in the SIP REFER request with a signature pointing to the application/resource-lists MIME body; and
NOTE 1:	Sensitive XML content placed in the application/resource-lists MIME body can be encrypted.
-	an application/vnd.3gpp.mcptt-signed+xml MIME is included in the hname ""body"" parameter in the headers portion of the SIP URI in the ""uri"" attribute of the <entry> element of the application/resource-lists MIME body in the SIP REFER request, containing signatures pointing to the XML MIME bodies included in the hname ""body"" parameter in the headers portion of the SIP URI.
NOTE 2:	Sensitive XML content placed in the hname ""body"" parameter in the headers portion of the SIP URI can be encrypted.
Configuration for applying integrity protection is not selective to a specific MIME body. If configuration for integrity protection is turned on, then all XML MIME bodies in SIP requests and responses are integrity protected. If configuration for integrity protection is turned off, then no XML MIME bodies in SIP requests and SIP responses are integrity protected.",TS 24.379,6.6.3.1,all_images/image_1550.png,Integrity Protection of XML MIME bodies in SIP REFER requests
"The figure 10.3.2.2-1 gives an overview of the main states and transitions on the UE for broadcast group call control.
Figure 10.3.2.2-1: Broadcast group call control state machine",TS 24.379,10.3.2.2,all_images/image_1553.jpeg,Broadcast group call control state machine
"The MO for Multi-Device and Multi-Identity in IMS is used to manage settings of the UE for Multi-Device and Multi-Identity in IMS. Figure 4-1 gives an overview of the configuration parameters of this MO. The conventions used in this specification are as defined in OMA-TS-DM_TND [4] with the following modifications:
-	interior nodes are drawn as rectangles, not rectangles with rounded corners; and
-	leaf nodes are plain text, not rectangles.
The MO for Multi-Device and Multi-Identity in IMS covers configuration parameters for a UE supporting Multi-Device and Multi-Identity in IMS specified in TS 24.174 [3].
The MO identifier is: urn:oma:mo:ext-3gpp-mudmid:1.0.
Figure 4-1: MO for Multi-Device and Multi-Identity in IMS",TS 24.175,4,all_images/image_1563.jpeg,MO for Multi-Device and Multi-Identity in IMS
,TS 23.303,4.4.1,all_images/image_1567.jpeg,UE to ProSe Function Interfaces for each sub-function
"Figure 5.2.2.3-1: ProSe Function triggered ProSe direct services revocation (non-roaming)
NOTE:	Steps 2, 3, 4 can be executed at the same time as step 1.
1.	The HPLMN ProSe Function decides to revoke the authorization for ProSe direct service, e.g. ProSe Direct Discovery service is revoked on one PLMN. The UE get the updated authorization for ProSe direct service via the ProSe Service Notification message immediately or waits to the next time communication with the ProSe function in HPLMN per operator's policy.
2.	The ProSe Function notifies the HSS to change the subscription data by sending an Update ProSe Policy Data (IMSI, updated ProSe data) message. The updated ProSe data includes the indication and the PLMN ID. The combination of the indication and the PLMN ID denotes the authorization for ProSe direct service (discovery or communication or both) identified by the indication is to be revoked on the indicated PLMN. Upon receiving the message, the HSS updates the ProSe subscription data.
The description of steps 3-4 are the same as steps 3-4 in clause 5.2.2.2.",TS 23.303,5.2.2.3,all_images/image_1568.jpeg,ProSe Function triggered ProSe direct services revocation (non-roaming)
"Figure 5.3.2-1: Overall procedure for ProSe Direct Discovery
This procedure is only applied for open and restricted ProSe Direct Discovery when the ProSe enabled UE is served by E-UTRAN.
1.	Service authorisation for ProSe direct services is performed for ProSe Direct Discovery as defined in clauses 5.2, and 4.5.1.
If the UE is authorised to announce:
2a.	When the UE is triggered to announce, then it sends a discovery request for announcing to the ProSe Function in HPLMN as defined in clauses 5.3.3.2 and 5.3.3.3 for open ProSe Direct Discovery, and in clauses 5.3.3.2A and 5.3.3.3A for restricted ProSe Direct Discovery. In addition, for restricted ProSe Direct Discovery, the ProSe Function further interacts with the ProSe Application server for the authorization of the discovery request.
3a.	If the request is successful and is provided with ProSe Application Code/ProSe Restricted Code then it starts announcing on PC5 interface.
For ProSe restricted discovery and UE requests ""on demand"" announcing, ProSe Restricted Code may be provided to UE after this procedure. In this case, UE waits for the ProSe Restricted Code allocation and starts to announce the ProSe Restricted Code on PC5 after receiving it in Announcing Alert procedure specified in clause 5.3.5.
NOTE 1:	More details on the Access Stratum protocol of this step are provided in RAN specifications.
If the UE is authorised to monitor:
2b.	When the UE is triggered to monitor, it sends a discovery request for monitoring to the ProSe Function as defined in clauses 5.3.3.4 and 5.3.3.5 for open ProSe Direct Discovery, and in clauses 5.3.3.2A and 5.3.3.3A for restricted ProSe Direct Discovery. In addition, for restricted ProSe Direct Discovery, the ProSe Function further interacts with the ProSe Application server for the authorization of the discovery request.
3b.	If the request is successful and the UE is provided with a Discovery Filter consisting of ProSe Application Code(s)/ProSe Restricted Code(s) and/or ProSe Application Mask(s) it starts monitoring for these ProSe Application Codes/ProSe Restricted Codes on the PC5 interface.
NOTE 2:	More details on the Access Stratum protocol of this step are provided in RAN specifications.
4b.	When the UE detects that one or more ProSe Application Code(s)/ProSe Restricted Code(s) that match the filter (see clause 4.6.4.2), it reports the ProSe Application Code(s)/ProSe Restricted Code(s) to the ProSe Function as defined in clause 5.3.4.
Non roaming direct discovery procedures cover the case where both the ""announcing UE"" and ""monitoring UE"" are served by their respective HPLMN. Roaming direct discovery procedures cover the other cases.",TS 23.303,5.3.2,all_images/image_1569.png,Overall procedure for ProSe Direct Discovery
"Figure 5.6.2-1 shows how the EPC network enables UE-A and UE-B to directly communicate in WLAN direct mode. This is accomplished by triggering the two UEs to establish a WLAN direct group  and providing them with assistance information which enables the EPC network to control and to expedite the establishment of the WLAN direct group.
With the procedure shown in Figure 5.6.2-1 the EPC network can (i) control when a WLAN direct group can be established, (ii) authorize the UEs that can become members of this group (and thus communicate with each other in WLAN direct mode) and (iii) control the operating parameters of the WLAN direct group e.g. the SSID, the security keys, etc.
NOTE 1:	When the WLAN direct discovery and communication is based on the Wi-Fi Peer-to-Peer (P2P) specification [13], a WLAN direct group is autonomously established by one or more UEs without any network involvement. However, with the procedure shown in Figure 5.6.2-1 it is the EPC network that can authorize and trigger the establishment of WLAN direct groups. An example on the operating parameters provided by the ProSe Function when the direct communication is based on Wi-Fi Peer-to-Peer specification [13] can be found in Annex A.
NOTE 2:	WLAN direct discovery and communication without Assistance Information from EPC is outside the scope of 3GPP.
The ProSe Function shown in Figure 5.6.2-1 is the network function that triggers and controls the establishment of a WLAN direct group between one or more UEs.
Figure 5.6.2-1: Signalling flow for EPC support for WLAN direct communication
1.	The ProSe Function decides to trigger UE-A and UE-B to establish a WLAN direct group under the control of the network.
2.	The ProSe Function sends a WLAN Direct Group Setup Request (Assistance Information) to UE-A. The Assistance Information is a set of parameters which can expedite the establishment of the WLAN direct group and enables the EPC network to control the operating parameters of the WLAN direct group. The Assistance Information content depends on the WLAN technology. If UE-A accepts the request and the offered Assistance Information, it responds with a WLAN Direct Group Setup Response. This response may include parameters for the WLAN direct group proposed by UE-A (e.g. an operating channel).
NOTE 2:	When EPC support for WLAN direct discovery and communication is used in conjunction with EPC-level discovery, the assistance information for WLAN direct discovery and communication is provided as part of the Proximity Alert procedure.
3.	The ProSe Function sends also a WLAN Direct Group Setup Request (Assistance Information) to UE-B. The Assistance Information in the request may take into account the parameters proposed by UE-A in step 2b.
4.	The two UEs establish a WLAN direct group and may start communicating in WLAN direct mode.
NOTE 3:	In this release of the specification it is assumed that UE-A and UE-B are controlled by the same ProSe Function.",TS 23.303,5.6.2,all_images/image_1580.jpeg,Signalling flow for EPC support for WLAN direct communication
"At any time the ProSe Function may decide to revoke the EPC assisted WLAN direct communication as shown in Figure 5.6.3-1.
Figure 5.6.3-1: Signalling flow for Revocation of EPC assisted WLAN direct communication
1.	The ProSe Function decides to revoke EPC assisted WLAN direct communication for UE-A and UE-B.
2a.	The ProSe Function sends a WLAN Direct Communication Revocation Request to the UE-A.
2b.	The UE-A accepts the request.
3a.	The ProSe Function sends a WLAN Direct Communication Revocation Request (Control Information) to the UE-B.
3b.	The UE-B accepts the request.
4.	The EPC assisted WLAN direct communication Assistance Information is no longer valid and the EPC assisted WLAN direct communications using the EPC Assistance Information are released.",TS 23.303,5.6.3,all_images/image_1581.jpeg,Signalling flow for Revocation of EPC assisted WLAN direct communication
"Figure 4.1-1 shows the non-roaming architecture to support SBI-based SMS.
Figure 4.1-1: Non-roaming System Architecture for SBI-based SMS
Figure 4.1-2a, Figure 4.1-2b Figure 4.1-2c and Figure 4.1-2d depict the non-roaming architecture to support SBI-based SMS, using the reference point representation showing how various network functions interact with each other
Figure 4.1-2a: Non-roaming System Architecture for SBI-based MT SMS in reference point representation
Figure 4.1-2b: Non-roaming System Architecture for SBI-based MO SMS in reference point representation
Figure 4.1-2c: Architecture for SBI-based MSISDN-less MO SMS in reference point representation
Figure 4.1-2d: Architecture for NP staute Retrival from MNPF in reference point representation
NOTE 1:	The newly introduced reference points for SMS_SBI are marked in red, and numbered from SM1 to SM14.",TS 23.540,4.1,all_images/image_1582.jpeg,Non-roaming System Architecture for SBI-based SMS
"Figure 5.1.2-1: MT SMS over NAS without SMS Router/ IP-SM-GW
1.	MT SMS interaction between SC and SMS-GMSC follow the current procedure as defined in 3GPP TS 23.040 [2].
2a-2b.	The SMS-GMSC should query the NRF to find the UDM instance(s), supporting SMS SBI interfaces, and managing that manages the user subscriptions of the GPSI. The SMS-GMSC may need to retrieve the PLMN ID of the recipients GPSI before the discovery of the UDM instance based on the GPSI-to-Subscription-Network resolution procedure defined in clause 5.1.7.
3.	SMS-GMSC invokes Nudm_UECM_SendRoutingInfoForSM (GPSI) to the UDM to get the routing information of the nodes available for MT SMS delivery, in this case the registered serving SMSF instances for all access types for the UE.
4.	The UDM shall check the registration/reachability flags to determine the potential target nodes and responds to the SMS-GMSC by sending Nudm_UECM_SendRoutingInfoForSM response, in this procedure the SMSF instance Id and the indication for SMSF SMS_SBI support are included in the response message. The UDM shall include the SMSF for 3GPP access and the SMSF for non-3GPP access separately, if both the SMSFs are currently known to be valid for the UE.
5.	The SMS-GMSC forwards the SMS message to the SMSF. If the SMS-GMSC has more than one SMSF address to use for SMS transport towards the UE, then the SMS-GMSC chooses which SMSF address to use first, based on operator local policy.
The SMS-GMSC selects protocol based on the indication for SMSF SMS_SBI support.
If SMSF indicates it supports SMS_SBI, SMS-GMSC forwards the SMS message to the SMSF by invoking Nsmsf_SMService_MtForwardSm service operation.
If SMSF indicates that it does not support SMS_SBI, SMS-GMSC should forward SMS message to SMSF by legacy MAP/Diameter protocol. And the following steps follow the procedures for legacy MT SMS message transfer, as illustrated in Figure 15a of TS23.040 [2].
6.	MT SMS over NAS procedure between SMSF, AMF and UE is same as the definition in step 4a to 6b of Figure 4.13.3.6-1 of 3GPP TS 23.502 [4].
7.	The SMSF delivers the delivery report to SMS-GMSC by sending the Nsmsf_SMService_MtForwardSm response to the SMS-GMSC.
8.	The SMS-GMSC updates the SM-Delivery Report Status to UDM by invoking Nudm_SMReportStatus_Request.
9.	UDM responses Nudm_SMReportStatus_Request response to SMS-GMSC.
10.	The SMS-GMSC delivers the delivery report to SC as defined in TS 23.040 [2].
11.	MT SMS over NAS procedure between SMSF, AMF and UE is same as the definition in step 6c to 6d of Figure 4.13.3.6-1 of 3GPP TS 23.502 [4].",TS 23.540,5.1.2,all_images/image_1583.jpeg,MT SMS over NAS without SMS Router/ IP-SM-GW
"Figure 5.1.3-1: MT SMS over NAS via SMS Router
1.	MT SMS interaction between SC and SMS-GMSC follow the current procedure as defined in 3GPP TS 23.040 [2].
2a-2b.	The SMS-GMSC should query the NRF to find the UDM instance(s), supporting SMS SBI interfaces, and managing that manages the user subscriptions of the GPSI. The SMS-GMSC may need to retrieve the PLMN ID of the recipients GPSI before the discovery of the UDM instance based on the GPSI-to-Subscription-Network resolution procedure defined in clause 5.1.7.
3.	SMS-GMSC invokes Nudm_UECM_SendRoutingInfoForSM (GPSI) to the UDM to get the serving node information for all access types for the UE.
4.	The UDM shall check the registration/reachability flags to determine the potential target nodes, e.g. SMSF. For MT SM transfer via SMS Router, the UDM shall invoke the Nrouter_SMService_RoutingInfo to provide the SMSF Instance Id to the SMS Router. The address of the SMS Router to be contacted by the UDM may be configured locally.
5.	The SMS Router shall send Nrouter_SMService_RoutingInfo response to the UDM.
6.	UDM responds to the SMS-GMSC by sending Nudm_UECM_SendRoutingInfoForSM response, including SMS Router address, the indication for SMSF SMS_SBI support and the indication for SMS Router SMS_SBI support.
7-8.	The SMS-GMSC forwards the SMS message to the SMS Router, and then SMS Router forwards the SMS message to the SMSF. If the SMS Router has more than one SMSF address to use for SMS transport towards the UE, then the SMS Router chooses which SMSF address to use first, based on operator local policy.
The SMS-GMSC selects protocol based on the indications for SMSF SMS_SBI support and SMS Router SMS_SBI support.
If both SMSF and SMS Router indicate support for SMS_SBI, SMS-GMSC forwards the SMS message to the SMS Router by invoking Nrouter_SMService_MtForwardSm service operation. And then the SMS Router forwards the SMS message to the SMSF by invoking Nsmsf_SMService_MtForwardSm service operation.
If SMSF or SMS Router indicates that it does not support SMS_SBI, SMS-GMSC should forward SMS message to SMS Router by legacy MAP/Diameter protocol. Then SMS Router forwards the SMS message to the SMSF by legacy MAP/Diameter protocol. The following steps follow the procedures for legacy MT SMS message transfer, as illustrated in Figure 15aa of TS23.040.
9.	MT SMS over NAS procedure between SMSF, AMF and UE is same as the definition in step 4a to 6b of Figure 4.13.3.6-1 in 3GPP TS 23.502 [4].
10.	The SMSF delivers the delivery report to SMS Router by sending the Nsmsf_SMService_MtForwardSm response to the SMS Router.
11.	The SMS Router delivers the delivery report to SMS-GMSC by sending the Nrouter_SMService_MtForwardSm response to the SMS-GMSC.
12-13.	The SMS-GMSC may report the SM-Delivery Status to the UDM by invoking Nudm_ReportSMDeliveryStatus_Request and UDM responses Nudm_ReportSMDeliveryStatus_Request response to SMS-GMSC.
14.	The SMS-GMSC delivers the delivery report to SC as defined in 3GPP TS 23.040 [2].
15.	MT SMS over NAS procedure between SMSF, AMF and UE is same as the definition in step 6c to 6d of Figure 4.13.3.6-1 in 3GPP TS 23.502 [4].",TS 23.540,5.1.3,all_images/image_1584.jpeg,MT SMS over NAS via SMS Router
"Figure 5.1.4-1: MT SMS over NAS via IP-SM-GW
1.	MT SMS interaction between SC and SMS-GMSC follow the current procedure as defined in 3GPP TS 23.040 [2].
2a-2b.	The SMS-GMSC should query the NRF to find the UDM instance(s), supporting SMS SBI interfaces, and managing that manages the user subscriptions of the GPSI. The SMS-GMSC may need to retrieve the PLMN ID of the recipients GPSI before the discovery of the UDM instance based on the GPSI-to-Subscription-Network resolution procedure defined in clause 5.1.7.
3.	The SMS-GMSC invokes Nudm_UECM_SendRoutingInfoForSM (GPSI) to the UDM to get the serving node information for all access types for the UE.
4.	The UDM shall check the registration/reachability flags to determine the potential target nodes, e.g. SMSF. For MT SM transfer via IP-SM-GW, the UDM shall invoke the Nipsmgw_SMService_RoutingInfo to provide the SMSF Instance Id to the IP-SM-GW. The address of the IP-SM-GW to be contacted by the UDM may be configured locally.
5.	The IP-SM-GW shall send Nipsmgw_SMService_RoutingInfo response to the UDM.
6.	The UDM responds to the SMS-GMSC by sending Nudm_UECM_SendRoutingInfoForSM response, including IP-SM-GW address, the indication for SMSF SMS_SBI support and the indication for IP-SM-GW SMS_SBI support.
7-8.	The SMS-GMSC forwards the SMS message to the IP-SM-GW, and then IP-SM-GW performs service authorization and domain selection to determine the domain for delivery of the Short Message as defined in 3GPP TS 23.204 [15]. If the SMSF is selected, the IP-SM-GW forwards the SMS message to the SMSF. If the IP-SM-GW has more than one SMSF address to use for SMS transport towards the UE, then the IP-SM-GW chooses which SMSF address to use first based on operator local policy.
The SMS-GMSC selects protocol based on the indication for SMSF SMS_SBI support and IP-SM-GW SBI support:
If both SMSF and IP-SM-GW indicate support for SMS_SBI, SMS-GMSC forwards the SMS message to the IP-SM-GW by invoking Nipsmgw_SMService_MtForwardSm service operation. And then the IP-SM-GW forwards the SMS message to the SMSF by invoking Nsmsf_SMService_MtForwardSm service operation.
If SMSF or IP-SM-GW indicates that it does not support SMS_SBI, SMS-GMSC should forward SMS message to IP-SM-GW by legacy MAP/Diameter protocol. Then IP-SM-GW forwards the SMS message to the SMSF by legacy MAP/Diameter protocol. The following steps follow the procedures for legacy MT SMS message transfer, as illustrated in Figure 15aa of TS23.040 [2].
9.	The MT SMS over NAS procedure between SMSF, AMF and UE is the same as in step 4a to 6b of Figure 4.13.3.6-1 of 3GPP TS 23.502 [4].
10.	The SMSF delivers the delivery report to the IP-SM-GW by sending the Nsmsf_SMService_MtForwardSm response to the IP-SM-GW.
11.	The IP-SM-GW delivers the delivery report to the SMS-GMSC by sending the Nipsmgw_SMService_MtForwardSm response to the SMS-GMSC.
12.	The IP-SM-GW may report the SM-Delivery Status to the UDM by invoking Nudm_ReportSMDeliveryStatus_Request.
13.	The UDM responses with Nudm_ReportSMDeliveryStatus_Request response to the IP-SM-GW.
14-15.	The SMS-GMSC may report the SM-Delivery Status to the UDM by invoking Nudm_ReportSMDeliveryStatus_Request and the UDM shall ignore the information provided in this report.
16.	The SMS-GMSC delivers the delivery report to the SC as defined in 3GPP TS 23.040 [2].
17.	The MT SMS over NAS procedure between SMSF, AMF and UE is the same as in step 6c to 6d of Figure 4.13.3.6-1 of 3GPP TS 23.502 [4].",TS 23.540,5.1.4,all_images/image_1585.jpeg,MT SMS over NAS via IP-SM-GW
"Figure 5.1.5-1: Unsuccessful MT SMS over NAS without SMS Router/ IP-SM-GW
1.	MT SMS interaction between SC and SMS-GMSC follow the current procedure as defined in 3GPP TS 23.040 [2].
2a-2b.	The SMS-GMSC should query the NRF to find the UDM instance(s), supporting SMS SBI interfaces, and managing that manages the user subscriptions of the GPSI. If there is no available UDM returned from NRF, the SMS-GMSC may send error response to the SC.
3.	SMS-GMSC invokes Nudm_UECM_SendRoutingInfoForSM (GPSI) to the UDM to get the routing information of the nodes available for MT SMS delivery, in this case the registered serving SMSF instance for all access types for UE.
4.	The UDM shall check the registration/reachability flags to determine the potential target nodes. If the UDM is failed at this step, e.g. user not found in the UDM, the UDM shall respond to the SMS-GMSC by sending Nudm_UECM_SendRoutingInfoForSM response with error cause. If there is no target node address registered in the UDM, a response with error case indicating absent subscriber for SM is sent to the SMS-GMSC and the procedure continues in step 11.
5.	If successful response is returned in step 4, the SMS-GMSC forwards the SMS message to the SMSF by invoking Nsmsf_SMService_MtForwardSm service operation. If the SMS-GMSC has more than one SMSF address to use for SMS transport towards the UE, then the SMS-GMSC chooses which SMSF address to use first based on operator local policy.
6.	MT SMS over NAS procedure between SMSF, AMF and UE is same as the definition in step 4a to 6b of Figure 4.13.3.6-1 of 3GPP TS 23.502 [4].
7.	If the AMF informs the SMSF that it cannot deliver the MT-SMS to the UE in step 6, e.g. UE is not reachable, or the SMSF is failed at this step, e.g. memory capacity exceeded, the SMSF shall send the Nsmsf_SMService_MtForwardSm response with error cause to the SMS-GMSC.
If the SMS-GMSC has more than one SMSF address to use for SMS transport towards the UE, then upon receiving MT-SMS failure report, the SMS-GMSC, based on operator local policy, may re-attempt the MT-SMS delivery via the other SMSF. If MT-SMS delivery also fails over the other SMSF, then the SMS-GMSC continues with step 8.
8.	The SMS-GMSC may report the SM-Delivery Status (e.g. UE is not reachable or memory capacity exceeded) to UDM by invoking Nudm_ReportSMDeliveryStatus_Request.
9.	UDM responses Nudm_ReportSMDeliveryStatus_Request response to SMS-GMSC.
10.	The SMS-GMSC sends the failure report to SC as defined in TS 23.040 [2].
11.	The SMS-GMSC subscribes in UDM to be notified when the UE becomes reachable for SMS (i.e. when the UE gets in radio contact with the AMF while an SMSF is actually registered, or when an SMSF gets registered) by using the Nudm_EventExposure_Subscribe service operation for Reachability for SMS event as defined in 3GPP TS 23.502 [4].
12.	If applicable, the UDM subscribes to UE reachability notification in the AMF(s) using the Namf_EventExposure service and sets the relevant reachability flags. The UDM acknowledges the event subscription created by the SMS-GMSC.",TS 23.540,5.1.5,all_images/image_1586.jpeg,Unsuccessful MT SMS over NAS without SMS Router/ IP-SM-GW
"Figure 5.1.6-1: Unsuccessful MT SMS over NAS via IP-SM-GW
1.	MT SMS interaction between SC and SMS-GMSC follow the current procedure as defined in 3GPP TS 23.040 [2].
2a-2b.	The SMS-GMSC should query the NRF to find the UDM instance(s), supporting SMS SBI interfaces, and managing that manages the user subscriptions of the GPSI. If there is no available UDM returned from NRF, the SMS-GMSC may send error response to the SC.
3.	SMS-GMSC invokes Nudm_UECM_SendRoutingInfoForSM (GPSI) to the UDM to get the serving node information for UE.
4.	The UDM shall check the registration/reachability flags to determine the potential target nodes, e.g. SMSF. For MT SM transfer via IP-SM-GW, the UDM shall invoke the Nipsmgw_SMService_RoutingInfo to provide the SMSF Instance Id to the IP-SM-GW. The address of the IP-SM-GW to be contacted by the UDM may be configured locally.
5.	If any failure at this step, the IP-SM-GW shall send Nipsmgw_SMService_RoutingInfo response with error cause to the UDM.
6.	If the UDM receives error response from IP-SM-GW in step 5 or UDM is failed after step 3, e.g. user not found in the UDM, the UDM shall respond to the SMS-GMSC by sending Nudm_UECM_SendRoutingInfoForSM response with error cause. If there is no target node address registered in the UDM, a response with error case indicating absent subscriber for SM is sent to the SMS-GMSC and the procedure continues in step 14.
7.	If successful response is returned in step 6, the SMS-GMSC forwards the SMS message to the IP-SM-GW by invoking Nipsmgw_SMService_MtForwardSm service operation.
8.	The IP-SM-GW performs service authorization and domain selection to determine the domain for delivery of the Short Message as defined in 3GPP TS 23.204 [15]. If the SMSF is selected, the IP-SM-GW forwards the SMS message to the SMSF by invoking Nsmsf_SMService_MtForwardSm service operation. If the IP-SM-GW has more than one SMSF address to use for SMS transport towards the UE, then the IP-SM-GW chooses which SMSF address to use first based on operator local policy.
9.	MT SMS over NAS procedure between SMSF, AMF and UE is same as the definition in step 4a to 6b of Figure 4.13.3.6-1 of 3GPP TS 23.502 [4].
10.	If the AMF informs the SMSF that it cannot deliver the MT-SMS to the UE in step 9, e.g. UE is not reachable, or the SMSF is failed at this step, e.g. memory capacity exceeded, the SMSF shall send the Nsmsf_SMService_MtForwardSm response with error cause to the IP-SM-GW.
11.	If the IP-SM-GW receives error response from SMSF in step 10 and the IP-SM-GW has tried all selectable domains and accesses or the IP-SM-GW is failed after step 7, the IP-SM-GW shall send the Nipsmgw_SMService_MtForwardSm response with error cause to the SMS-GMSC.
12-13.	The IP-SM-GW may report the SM-Delivery Status (e.g. UE is not reachable or memory capacity exceeded) to UDM by invoking Nudm_ReportSMDeliveryStatus_Request.
14.	The IP-SM-GW subscribes in HSS to be notified when the UE becomes reachable again, and subsequently the HSS subscribes in the UDM to UE reachability for SMS over IP event, as defined in clause 5.5.6 of 3GPP TS 23.632 [5]. If applicable, the UDM subscribes to UE reachability notification in the AMF(s) using the Namf_EventExposure service and sets the relevant reachability flags.
15-16.	The SMS-GMSC may report the SM-Delivery Status to UDM by invoking Nudm_ReportSMDeliveryStatus_Request and the UDM shall ignore the information provided in this report.
17.	If the SMS-GMSC receives error response from IP-SM-GW in step 6 or step 11, the SMS-GMSC sends the failure report to SC as defined in TS 23.040 [2].",TS 23.540,5.1.6,all_images/image_1587.jpeg,Unsuccessful MT SMS over NAS via IP-SM-GW
,TS 23.540,5.1.7.2,all_images/image_1588.jpeg,GPSI-to-Subscription-Network resolution triggered by the SMS-GMSC
"Figure 5.1.7.3.2-1: SCP supports GPSI-to-Subscription-Network resolution with MNPF
1a-1b.	If the MNPF is deployed, the MNPF registers in the NRF with a new NF Type (e.g. MNPF).
2.	MT SMS interaction between SC and SMS-GMSC follow the current procedure as defined in 3GPP TS 23.040 [2].
3. The SMS-GMSC sends Nudm_UECM_SendRoutingInfoForSM to the SCP to get the serving node instance for UE from the UDM. As specified in the Indirect Communication with Delegated Discovery model, the Nudm_UECM_SendRoutingInfoForSMt shall contain the discovery factors containing the GPSI (pointing to the Number Range Holder Network) and an indicator (i.e. ""target-nw-resolution"") that Subscription Network resolution is delegated to the SCP. The ""target-nw-resolution"" may also be sent by an SCP to the next hop SCP. The SCP receives the ""target-nw-resolution"" shall query the NF service consumer (MNPF) to obtain the PLMN ID of the recipient GPSI's subscription network.
4a-4b.	The SCP shall query the NRF to find the MNPF instance that manages the PLMN ID of the recipients GPSI's subscription network. The MNPF may belong to the same PLMN with SMS-GMSC or belong to the number range holder network which is different with the PLMN of SMS-GMSC. In latter case, the local NRF forwards the discovery request to the NRF of the number range holder PLMN.
5.	The SCP determines the target PLMN of the recipients GPSI's subscription network using the SBI service of the MNPF i.e. the SCP invokes Nmnpf_NPStatus_Get (GPSI) to the MNPF.
6.	MNPF checks the portability status of the recipient GPSI and responds back with the target PLMN ID.
NOTE: If SCP is co-located with MNPF, steps between SCP and NRF to discover the MNPF, and steps between SCP and MNPF can be skipped.
7a-7b.	SCP shall query the NRF to find the UDM instance serving the target PLMN based on target PLMN ID received in step 6.
8.	SCP invokes Nudm_UECM_SendRoutingInfoForSM (GPSI) to the UDM to get the serving node instance for UE.
9.	The UDM shall check the registration/reachability flags to determine the potential target nodes and responds to the SCP by sending Nudm_UECM_SendRoutingInfoForSM response, in this procedure the SMSF instance Id is included in the response message.
10. SCP forward the responds to the SMS-GMSC by sending Nudm_UECM_SendRoutingInfoForSM response (SMS Router address).",TS 23.540,5.1.7.3.2,all_images/image_1589.jpeg,SCP supports GPSI-to-Subscription-Network resolution with MNPF
"Figure 5.1.7.3.3-1: SCP supports GPSI-to-Subscription-Network resolution with NRF
1a-1b.	If the MNPF is deployed, the MNPF registers in the NRF with a new NF Type (e.g. MNPF).
2.	MT SMS interaction between SC and SMS-GMSC follow the current procedure as defined in 3GPP TS 23.040 [2].
3. The SMS-GMSC sends Nudm_UECM_SendRoutingInfoForSM to the SCP to get the serving node instance for UE from the UDM. The Nudm_UECM_SendRoutingInfoForSM contains the NF service discovery factors with the GPSI (pointing to the Number Range Holder Network) and an indicator (i.e. ""target-nw-resolution"") indicating that Subscription Network resolution is delegated to the SCP. The ""target-nw-resolution"" may also be sent by an SCP to the next hop SCP.
4.	The SCP should query the NRF to find the UDM instance that manages the user subscriptions using the GPSI. The NRF receives the ""target-nw-resolution"" shall query the NF service consumer (MNPF) to obtain the PLMN ID of the recipient GPSI's subscription network.
5.	The NRF determines the target PLMN of the recipients GPSI's subscription network using the SBI service of the MNPF i.e. the NRF invokes Nmnpf_NPStatus_Get (GPSI) to the MNPF. As an implementation choice the NRF may determine the target PLMN by other means, e.g. local configuration of ENUM query.
6.	MNPF checks the portability status of the recipient GPSI and responds back with the target PLMN ID.
7.	NRF returns the UDM instance related to the GPSI and target PLMN Id to the SCP. For inter-PLMN discovery, the local NRF shall query the NRF in the target PLMN to find the UDM instance. If there are not NF instances available that can serve the request, the local NRF provides the discovery response indicating the consumer NF to use a legacy interface for the next operation request in the procedure.
8.	SCP invokes Nudm_UECM_SendRoutingInfoForSM (GPSI) to the UDM to get the serving node instance for UE.
9.	The UDM shall check the registration/reachability flags to determine the potential target nodes and responds to the SCP by sending Nudm_UECM_SendRoutingInfoForSM response, in this procedure the SMSF instance Id is included in the response message.
10. SCP forward the responds to the SMS-GMSC by sending Nudm_UECM_SendRoutingInfoForSM response (SMS Router address).",TS 23.540,5.1.7.3.3,all_images/image_1590.jpeg,SCP supports GPSI-to-Subscription-Network resolution with NRF
"Figure 5.1.7.4-1 shows the procedure to determine the target PLMN based on the GPSI using the discovery and selection framework via the NRF as defined in 3GPP TS 23.501 [3] and 3GPP TS 23.502 [4].
Figure 5.1.7.4-1: Determination of target PLMN based on GPSI using NRF
1.	The SMS-GMSC located in the PLMN of the SMS sender contacts the NRF in the originating PLMN to perform NF/NF service discovery of the UDM instance(s). The discovery request is based on the GPSI of the SMS recipient and includes an indication for the NRF to determine the target PLMN and interface to be used (SBI or legacy interface).
2.	Based on the indication to determine the target PLMN and interface to be used included in the discovery request, if direct routing mechanism is used the NRF in the originating PLMN retrieves the target PLMN ID from the MNPF in the originating PLMN by consuming the SBI services of the MNPF described in clause 6.7. The NRF performs an NP query to the MNPF using SBI for the GPSI of the SMS recipient.
If indirect routing mechanism is used, steps 2-3 are skipped and the procedure continues in step 4a.
3.	The MNPF provides in the response the target PLMN information corresponding to the GPSI of the SMS recipient and the procedure continues in step 4.
2a-3a.	The NRF may, as an alternative implementation option to steps 2-3, obtain the target PLMN information by other means, e.g., using DNS/ENUM resolution, local configuration in the NRF or direct access to Number Portability (NP) databases via non-SBI, if applicable.
NOTE 1:	NP applies to GPSIs representing E.164 addresses (i.e., MSISDN). NP is subject to regional and regulatory requirements and is accomplished through the retrieval of ported data from NP databases. Support of ENUM or direct access to NP via non-SBI interfaces and the exact means to make the number portability data available to the NRF is subject to and configured per operator policy.
The NRF may use the DNS/ENUM translation mechanism to resolve the GPSI of the SMS recipient in E.164 format to a URI as specified in IETF RFC 6116 [12]. The NRF performs an ENUM query for the GPSI of the SMS recipient in step 2a. The output of the lookup process in the DNS/ENUM server is a URI that is provided in the ENUM response and points to the originating PLMN or the NRF in the target PLMN with which the originating PLMN has an interconnection agreement using SBI, so that the NRF in the originating PLMN can send an inter-PLMN service discovery request to the NRF in the target PLMN.
NOTE 2:	The DNS/ENUM server searches for an ENUM record matching the GPSI of the SMS recipient. An ENUM record for the individual GPSI or number series provisioned in the DNS/ENUM server can be used to indicate whether the user belongs to the same PLMN or another PLMN in the same or different country. A URI as a result of the lookup process in the DNS/ENUM server can be provided by provisioning an ENUM service using the http or https scheme URI as defined in IETF RFC 4002 [13] and IETF RFC 6118 [14].
4.	Based on the response from the MNPF, the NRF in the originating PLMN determines the target PLMN where to search for UDM instances.
If the NRF has obtained the target PLMN information by other means in steps 2a-3a, the NRF determines the target PLMN based on the information from ENUM response, NP databases via non-SBI and/or local configuration.
If the GPSI belongs to the originating PLMN (i.e. originating network is the same as subscription network), the NRF searches for UDM instances matching the discovery criteria that can serve the request in the originating PLMN using SBI services and provides the discovery response in step 7.
If the GPSI belongs to a different PLMN, the NRF checks whether the originating PLMN has an interconnection agreement using SBI with the subscription PLMN and, in that case, sends an inter-PLMN discovery request including the GPSI to the NRF in the subscription PLMN to retrieve the UDM instances that can serve the SMS recipient, as defined in clause 4.17.5 of 3GPP TS 23.502 [4] and 3GPP TS 29.510 [10], and the procedure continues in step 6.
4a.	If indirect routing mechanism is used (i.e., no interaction as in steps 2-3 between NRF and MNPF in the originating PLMN), the NRF in the originating PLMN determines the PLMN ID of the number range holder network (e.g. from the recipient's GPSI prefix (CC+NDC) based on local configuration) and sends an inter-PLMN discovery request of UDM instances to the NRF in the number range holder network. In this case, the discovery request across PLMNs shall include the GPSI of the SMS recipient and the indication to determine the target PLMN and interface to be used.
5.	Based on the indication to determine the target PLMN and interface to be used included in the discovery request from the NRF in the originating PLMN, the NRF in the number range holder PLMN applies the behaviour described for the NRF in steps 2-3 (or alternatively, steps 2a-3a) and step 4.
The NRF in the number range holder network may perform a query to the MNPF using SBI if NP is required and NP information has not been retrieved previously (e.g., if originating and number range holder PLMNs belong to different countries or portability domains and NP is required in the country of the recipient GPSI). The NRF in the number range holder network obtains the PLMN ID of the subscription network in the response from the MNPF (or alternatively by other means such as ENUM/NP) and, if applicable, sends an inter-PLMN discovery request of UDM instances including the GPSI to the NRF in the subscription network.
6.	The NRF in the subscription network provides the inter-PLMN discovery response including UDM instance(s) matching the discovery criteria or no UDM instance(s) found in the target PLMN, implying that SBI interactions should not be used.
When using indirect routing, the NRF in the number range holder network forwards the discovery response from the NRF in the subscription network to the NRF in the originating network.
7.	If the NRF in the originating network finds UDM instances matching the filter criteria in the originating PLMN or receives UDM instances in the response to a discovery request across PLMNs in step 6, the NRF provides the UDM instances in the discovery response to the SMS-GMSC.
If no UDM instances can serve the request using SBI, the NRF provides the discovery response indicating the SMS-GMSC to use a non-SBI interface for the next operation request in the procedure.
8a.	If the discovery response includes UDM instances that can serve the SMS recipient, the SMS-GMSC sends the operation request using SBI to e.g., retrieve the SMS routing information from the UDM, and the SBI-based MT SMS procedure can be executed as described in clause 5.1.
8b.	If no UDM instances are provided in the discovery response, the SMS-GMSC sends the operation request via legacy interface using MAP/Diameter to e.g., retrieve the SMS routing information from the HLR/HSS/UDM.",TS 23.540,5.1.7.4,all_images/image_1591.jpeg,Determination of target PLMN based on GPSI using NRF
"Figure 5.1.9-1: Unsuccessful MT SMS over NAS via SMS Router
1.	MT SMS interaction between SC and SMS-GMSC follow the current procedure as defined in 3GPP TS 23.040 [2].
2a-2b.	The SMS-GMSC should query the NRF to find the UDM instance that manages the user subscriptions using the GPSI. If there is no available UDM returned from NRF, the SMS-GMSC may send error response to the SC.
3.	SMS-GMSC invokes Nudm_UECM_SendRoutingInfoForSM (GPSI) to the UDM to get the serving node information for all access types for the UE.
4.	The UDM shall check the registration/reachability flags to determine the potential target nodes, e.g. SMSF. For MT SM transfer via SMS Router, the UDM shall invoke the Nrouter_SMService_RoutingInfo to provide the SMSF Instance Id to the SMS Router. The address of the SMS Router to be contacted by the UDM may be configured locally.
5.	If any failure at this step, the SMS Router shall send Nrouter_SMService_RoutingInfo response with error cause to the UDM.
6.	If the UDM receives error response from SMS Router in step 5 or UDM is failed after step 3, e.g. user not found in the UDM, the UDM shall respond to the SMS-GMSC by sending Nudm_UECM_SendRoutingInfoForSM response with error cause. If there is no target node address registered in the UDM, a response with error case indicating absent subscriber for SM is sent to the SMS-GMSC and the procedure continues in step 15.
7.	If successful response is returned in step 6, the SMS-GMSC forwards the SMS message to the SMS Router by invoking Nrouter_SMService_MtForwardSm service operation.
8.	The SMS Router forwards the SMS message to the SMSF by invoking Nsmsf_SMService_MtForwardSm service operation.
9.	MT SMS over NAS procedure between SMSF, AMF and UE is same as the definition in step 4a to 6b of Figure 4.13.3.6-1 of 3GPP TS 23.502 [4].
10.	If the AMF informs the SMSF that it cannot deliver the MT-SMS to the UE in step 9, e.g. UE is not reachable, or the SMSF is failed at this step, e.g. memory capacity exceeded, the SMSF shall send the Nsmsf_SMService_MtForwardSm response with error cause to the SMS Router.
11.	If the SMS Router receives error response from SMSF in step 10 or the SMS Router is failed after step 7, the SMS Router shall send the Nrouter_SMService_MtForwardSm response with error cause to the SMS-GMSC.
12-13.	The SMS-GMSC may report the SM-Delivery Status (e.g. UE is not reachable or memory capacity exceeded) to UDM by invoking Nudm_ReportSMDeliveryStatus_Request.
14.	If the SMS-GMSC receives error response from SMS Router in step 6 or step 11, the SMS-GMSC sends the failure report to SC as defined in TS 23.040 [2].
15.	The SMS-GMSC subscribes in UDM to be notified when the UE becomes reachable for SMS (i.e. when the UE gets in radio contact with the AMF while an SMSF is actually registered, or when an SMSF gets registered) by using the Nudm_EventExposure_Subscribe service operation for Reachability for SMS event as defined in 3GPP TS 23.502 [4].
16.	If applicable, the UDM subscribes to UE reachability notification in the AMF(s) using the Namf_EventExposure service and sets the relevant reachability flags. The UDM acknowledges the event subscription created by the SMS-GMSC.",TS 23.540,5.1.9,all_images/image_1593.jpeg,Unsuccessful MT SMS over NAS via SMS Router
"Figure 5.2.3-1 depicts procedure for unsuccessful SBI-based SM MO message transfer
Figure 5.2.3-1: Procedures for unsuccessful SBI-based SM MO message transfer
0-3	The same as the procedures in step 0-3 of Figure 5.2.2-1 in clause 5.2.2
4	SMS-IWMSC sends Niwmsc_SMService_MoForwardSm response with HTTP status code for application errors as defined in Table 5.3.2-1.
5	Failure report from SMSF to UE, with the error cause code as defined in Table 5.3.2-2.
SMS-IWMSC indicates the different errors for MO SM transfer in MoForwardSm response according to the different failure scenarios which happened during MO SM transfer. The Application Errors used in Niwmsc_SMService_MoForwardSm response are defined in Table 5.3.2-1 below
Table 5.3.2-1: Application errors
If errors are indicated by the SMS-IWMSC, the SMSF shall send a failure report (i.e. a RP-ERROR message) to the UE, with the error cause coded as following map between errors indicated by SMS-IWMSC and error cause code in RP-ERROR message:
Table 5.3.2-2: MAP of Application errors
NOTE:	The coding and the use of the RP-ERROR message is specified in 3GPP TS 24.011 [8].",TS 23.540,5.2.3,all_images/image_1595.jpeg,Procedures for unsuccessful SBI-based SM MO message transfer
"Editor's note:	This clause describes the reference architecture for this study.
Figure 4.3-1: Overview of UAV architecture in a 3GPP System.
The architecture considers a Third Party Authorized Entity (TPAE), which is not part of the UTM functionality.
NOTE 1:	There may be a connection between TPAE and UTM/USS which is outside the scope of 3GPP.
The following reference points are considered:
NOTE 2:	for all the reference points below, C2 is an application-level protocol, and specific solutions for C2 are outside the scope of this TR. The messaging content of reference points for C2 is out of scope of this TR.
NOTE 3:	The semantics (i.e. protocol format and content) of reference points for remote identification are outside the scope of this study since such content is defined outside 3GPP. However, the UAV identification information is part of the study.
-	UAV1: interfaces the UAV and UAVC with the 3GPP system to support UAV and UAVC authorization, authentication, identification, and tracking.
-	UAV2: interfaces a TPAE with the 3GPP system for remote identification and tracking.
NOTE 4:	The semantics of UAV2 are outside the scope of this study. However, the UAV identification information is part of the study.
NOTE 5:	No assumptions are made as to whether UAV2 is a control plane or user plane interface.
-	UAV3: 3GPP user plane connectivity for transporting C2. UAV3 can be intra-PLMN or inter-PLMN.
NOTE 6:	C2 is an application-level protocol, and specific solutions for C2 are outside the scope of this TR. The messaging content of UAV3 is out of scope of this TR.
-	UAV4: interfaces a TPAE with a UAV over 3GPP network for:
-	Command and control (C2)
-	Remote identification (RID) and tracking of the UAV.
NOTE 7:	At any given time, a UAV may be controlled mutually exclusively by an UAVC, a TPAE, or the UTM. Therefore, C2 to a UAV may be either over UAV3, UAV4 or UAV9.
-	UAV5: like UAV3 for transporting C2 but interfacing a UAV with a non-networked UAVC via the Internet outside the scope of 3GPP.
-	UAV6: interfaces the 3GPP system with external USS/UTM for functionality exposure, support of identification and tracking, and UAV authorization.
NOTE 8:	No assumptions are made as to whether UAV6 is a control plane or user plane interface.
-	UAV7: for RID information sent in broadcast (BRID), on a transport outside the scope of 3GPP.
-	UAV8: UAV8 is used for C2 over a transport outside the scope of 3GPP.
-	UAV9: UAV9 supports connectivity between the UAV or a networked UAV Controller and the USS/UTM for UAS management, such as authentication and authorization, transporting C2, networked remote identification (NRID) and tracking of the UAV, etc.
-	U2U: supports UAV to UAV communications for broadcast RID.
NOTE 9:	U2U is outside the scope of this TR.
Editor's note:	Whether there is additional interface between a TPAE and a UAV via Internet is FFS.",TR 23.754,4.3,all_images/image_1597.jpeg,Overview of UAV architecture in a 3GPP System.
"This solution addresses the key issue #4.
Similar to Solution #13 and Solution #16, this solution is to support UTM/USS's Geofencing need.
Appling Geofencing is an important aspect for UAS management of UTM/USS. Geofencing areas, particularly as no-fly zones, are defined by aviation authorities, are areas where the UAV is not allowed to fly in such areas. For live data acquisition by law enforcement, UTM/USS may query the 3GPP system to identify whether there are any UAV in the target area. This solution provides a method for 3GPP network identifying the UAVs in a target area.",TR 23.754,6.1.1,all_images/image_1598.jpeg,UAS model in 3GPP ecosystem in TS 22.125 [5]
,TR 23.754,6.2.2,all_images/image_1599.jpeg,3GPP reference architecture for UAV remote identification (5GC)
,TR 23.754,6.5.3,all_images/image_1602.png,Procedure for UAV Authentication and Authorization with USS/UTM in 5GS – Part 1
,TR 23.754,6.5.3.1,all_images/image_1603.jpeg,Procedure for UAV Authentication and Authorization with USS/UTM in 5GS – Part 2
"Figure 6.5.3.1.2-1: Procedure for UUAA Revocation in 5GS
1.	USS/UTM determines that UUAA is to be revoked.
2.	USS/UTM sends an authorization revocation message to the UFES, addressing the UAV via the 3GPP UAV ID. The request contains a Revocation Cause indicating this is UUAA revocation.
3.	The UFES identifies the AMF serving the UAV by invoking the Nudm_UECM_Get service operation and forwards the request for revocation.
4.	The AMF triggers the UUAA revocation. Two expected behaviors are possible:
-	restricted services: the AMF triggers the removal of all the PDU sessions associated with the UAV (a cause code indicating revocation of authorization is provided in the SM signalling, detailed to be defined in stage 3) towards the corresponding SMFs, and performs a UCU procedure assigning the Tracking Areas of the Registration Area as a Non-Allowed Area (i.e. the UAV is only allowed to exchange NAS signalling and is not allowed to trigger a PDU session establishment, among other procedures), providing a ""failed UUAA"" indication. The UAV is restricted from performing e.g. any PDU session establishment dedicated for the UAS service. If the UAV needs to perform a new UUA, the UE performs a re-registration.
-	differentiated services: the AMF triggers the removal of all the PDU session(s) for UAS services towards the corresponding SMFs, i.e. for UAV-USS/UTM communication and for C2 connectivity associated with the UAV (a cause code indicating revocation of authorization is provided in the SM signalling, detailed to be defined in stage 3). The UAV may continue to access any other non-UAS PDU sessions
NOTE:	In the case of PDU sessions dedicated to UAV-USS/UTM communications and to C2 connectivity, it is assumed the AMF is configured with information on which specific PDU sessions (e.g. S-NSSAI and DNN) are dedicated for UAS-USS/UTM communication and for C2 connectivity.
5, 6.	The UUA connectivity revocation is confirmed to the UFES and USS/UTM.",TR 23.754,6.5.3.1.2,all_images/image_1604.jpeg,Procedure for UUAA Revocation in 5GS
"The procedure for UAV Authentication and Authorization by USS in the EPS case is depicted in Figure 6.5.3-2.
In this procedure, both the scenario of single PDN connection for both UAV-USS/UTM communication and C2, and the scenario of separate PDN connection for UAV-USS/UTM communications and C2 are shown. In this solution, the attach procedure succeeds and a PDN connection is established for at least UAV-USS/UTM communication only if the UUAA succeeds.
The option where the UUAA and the authorization of UAV and networked UAV-C pairing are performed via an EAP mechanisms using NAS transport and PCO extensions is possible but not depicted in the picture.
Figure 6.5.3.2.1-1: Procedure for UAV Authentication and Authorization with USS/UTM in EPS.
1.	[Outside the scope of 3GPP] As step 1 of clause 6.5.3-1.
2.	[Outside the scope of 3GPP] [Optional] As step 2 of clause 6.5.3-1.
3.	The UAV sends an Attach Request to the MME. In EPS, Protocol Configuration Options (PCO) in the ESM message container are used to transfer parameters between the UE and the PDN GW, and sent transparently through the MME and the Serving GW. The PCO is extended to enable the UAV to insert the CAA-Level UAV ID, the Flight Authorization ID (if available), the UUAA Aviation Payload containing application layer information that is transparent to the EPC, and the Aviation Connectivity Payload containing the information for flight path authorization/registration for flight operation and for the authorization of UAV and networked UAV controller pairing (the information exchanged between UAV and USS/UTM for authorization for pairing of the networked UAV controller and UAV can refer to clause 6.5.3.1). The UAV in the UUAA procedure uses credentials obtained by the UAV during registration with the USS/UTM. The UAV may include the USS/UTM address information (see clause 6.5.2.3).
4.	Primary authentication/authorization is performed as specified in TS 23.401 [10] clause 5.3.2.1.
5.	The MME determines the UAV has an aerial subscription and selects the Default APN for connectivity with the USS/UTM.
6.	The MME sends a Create Session Request to the SMF+PGW-C via the SGW. The MME may include the ME Identity (IMEISV of the UAV). For the default APN used for connectivity with the USS, the HSS must allow selection of a SMF+PGW-C in the VPLMN for such APN since the USS/UTM is always located in the VPLMN.
NOTE 1:	A dedicated well-known APN may be used for UAV services, but this should be defined outside 3GPP (e.g. in GSMA) for roaming and interworking purposes. At a minimum, the UAV needs to be configured with the APN to be used for UAV services or the MNO needs to set the Default APN to correspond to the APN for UAV services.
NOTE 2:	It is expected that the MME selects an SMF+PGW-C, with the Default APN for UAV-USS/UTM communications always resolving to an SMF+PWG-C.
7.	The SMF+PGW-Cverifies whether a secondary authentication is required for the PDN connection establishment request:
-	For the scenario of single PDN connection, UUAA, authorization of UAV and networked UAV controller pairing, and authorization for establishment of user plane resource are always requested for APNs corresponding to UAS services, and may be verified against the UAV subscription if the node is an SMF+PGW-C.
-	For the scenario with multiple PDN connections, at these steps only UUAA would be performed and the SMF+PGW-Cverifies as above if it is required.
7a.	The SMF+PGW-C establishes an N4 session with the UPF+PGW-U.
7b.	The SMF+PGW-C installs traffic filters and access control list (ACL) so that the UE is not able to access any data network using the PDN connection until a secondary authentication is successfully completed with the USS/UTM.
8[a-c].	If the UE provided the CAA-Level UAV ID, then the SMF+PGW-C sends back a Creation Session Response, otherwise the SMF+PGW-C rejects the establishment of the session. The MME sends attach accept. The UE then sends attach complete.
9[a-b].	VOID
10.	The UUAA, and optionally in the case of single PDN connection also authorization of UAV and networked UAV controller pairing, and flight path authorization/registration for flight, are performed.
10a.	The SMF+PGW-C selects the UFES based on pre-configured policies or as defined in the 5GS procedure. The SMF+PGW-C provides the information sent by the UAV in the PCO (CAA-level UAV ID, optional Flight Authorization ID, optional Aviation Connectivity Payload, optional USS/UTM address information, User Location Information (ECGI or geographical area corresponding to ECGI)) and the UAV's IMEISV (if provided) to the UFES. The SMF+PGW-C also provides the UFES the External Identifier to be used as 3GPP UAV ID.
10b.	The UFES discovers and selects the USS as described in 6.5.2.3.
10c.	The UFES forwards the information to the USS/UTM.
10d.	The USS validates the request for UUAA based on the CAA-Level UAV ID, the Flight Authorization ID (if one is provided).
If the Aviation Connectivity Payload is included, the USS/UTM also verifies the UAV and networked UAV controller pairing.
The USS/UTM may determine Remote Identification & Tracking Info (RITI) for the UAV to use (e.g. in the case of UUAA-only and separate PDN connections, the USS/UTM may do so only when authorizing UAV and networked UAV-C pairing and establishment of user plane resources for C2 connectivity). This may include amongst others, a new CAA-level UAV ID, a UAV Type that is used as a means to remotely identify the UAV.
The USS/UTM also determines Authorization Data containing information about the connectivity between the UAV and the USS/UTM. If the USS/UTM also authorizing the UAV and networked UAV-C pairing, Authorization Data contains also information about the user plane connectivity between the UAV and the networked UAV Controller. Some of the RITI information, e.g. the CAA-level UAV ID, are received and stored by the UFES, together with the Authorization Data.
The USS determines Authorization Data containing authorized operations and necessary information applicable to existing or future PDN connections, which influence SMF+PGW-C decisions for traffic of PDN connections.
The authorized operations may indicate to disable all connectivity of the UAV except for the connectivity to USS/UTM based on necessary information contained in Authorization Data, which can be dedicated APN of USS/UTM, or traffic filtering information (e.g. 5 Tuple) identifying the traffic flow to USS/UTM. For example:
-	The UAV may establish a PDN connection with dedicated APN for C2 communication which contains one bearer to USS/UTM and another bearer to UAVC, and may establish other PDN connections with common APN for other purposes, based on received authorized operations and necessary information, the SMF+PGW-C may only keep the bearer to USS/UTM and disable all other PDU connections and bearers.
The UAV may establish a PDU connection with common APN for C2 communication and other purposes, based on received authorized operations and necessary information, the SMF+PGW-C may only keep the bearer to USS/UTM and disable all other bearers in this PDN connection.
10e.	The USS/UTM returns the response to the UFES.
10f.	The UFES returns the response to the PGW.
10[g-h].	The SMF+PGW-C sends an Update Bearer Request to the MME including the RITI in the PCO. The MME sends the PCO in a Downlink NAS transport message to the UAV UE and confirms the bearer update procedure by sending an Update Bearer Response to the SMF+PGW-C
11.	If the PGW received the Authorization Data (including optional authorized UAV and networked UAV controller pairing information), the PGW installs traffic filters for the connectivity between the UAV and the networked UAV controller, and for connectivity between the UAV and the USS/UTM.
12.	[Optional] USS/UTM may subscribe/request network capability information such as network coverage and mobility limitations information. The details are described in solution #12, clause 6.12.
[Optional] Steps 13-20 are performed only in the case of separate PDN connections.
13.	The UAV sends a PDN Connection Request to the MME for the establishment of a PDN Connection for C2 connectivity with a networked UAV-C. The UAV includes in the PCO the CAA-Level UAV ID, the Flight Authorization ID (if available), and the Aviation Connectivity Payload containing the information for flight path authorization/registration for flight operation and for the authorization of UAV and networked UAV controller pairing (the information exchanged between UAV and USS/UTM for authorization for pairing networked UAV controller and UAV can refer to clause 6.5.3.1). The UAV may include the USS/UTM address information (see 6.5.2.3).
14.	The MME sends a Create Session Request to the SMF+PGW-C via the SGW. The MME may include the ME Identity (IMEISV of the UAV). The MME selects a SMF+PGW-C suitable to serving the APN for C2 connectivity (it is expected to select the same PGW serving the PDN connection for UAV-USS/UTM connectivity).
15.	The SMF+PGW-C verifies whether a secondary authentication is required for the PDN connection establishment request, in particular the authorization of UAV and networked UAV controller pairing, and flight path authorization/registration for flight, are performed. This is performed as step 14, with the USS/UTM verifying the UAV and networked UAV controller pairing. The USS/UTM may determine Remote Identification & Tracking Info (RITI) for the UAV to use. This may include amongst others, a new CAA-level UAV ID, a UAV Type that is used as a means to remotely identify the UAV. The USS/UTM also determines Authorization Data containing information about the user plane connectivity between the UAV and the networked UAV Controller.
16.	The SMF+PGW-C establishes an N4 session with the UPF+PGW-U.
17.	If the SMF+PGW-C received the Authorization Data (including optional authorized UAV and networked UAV controller pairing information), the SMF+PGW-C installs traffic filters for the connectivity between the UAV and the networked UAV controller.
18.	The SMF+PGW-C confirms the procedure to the MME along with providing the RITI in the PCO.
19.	The new MME sends PDN Connection Accept to the UE with the PCO containing the RITI.
20.	The USS/UTM may acts as an SCS/AS and communicates to the UFES, which acts as a SCEF, to trigger the establishment of an application session with a required QoS and providing traffic filters to enable UAV to networked UAV controller connectivity, and optionally for UAV to USS/UTM connectivity. The USS/UTM may also use other SCEF services of the UFES.
21.	UAV broadcasts remote identification information for remote identification based on RITI information.
22.	UAV sends remote identification information to the USS/UTM based on RITI information.
23.	The UE exchanges C2 traffic with the UAV Controller.",TR 23.754,6.5.3.2.1,all_images/image_1605.jpeg,Procedure for UAV Authentication and Authorization with USS/UTM in EPS.
"This clause provides an example of how the CAA-Level UAV ID is used for Broadcast Remote Identification.
Figure 6.9.3.1-1: Use of CAA-Level UAV ID For Broadcast Remote Identification.
1.	The UAV generates the following for Remote Identification broadcasting:
-	UAV Identification: this is the CAA-Level UAV ID which is expected to be protected against spoofing (i.e. to avoid impersonation) and for confidentiality (i.e. protected between the UAV and the UFES/USS), and verifiable by the TPAE by querying the UFES/USS to retrieve the UAV information (e.g. UAV Hardware ID, UAV Pilot, UAV Operator, etc.)
-	UAV Flight Information: this corresponds to dynamic flight information (e.g. height, direction, speed, etc.), protected for spoofing and verifiable by the received party (e.g. a TPAE or another UAV).
Editor's note:	How the information in the RID broadcasting is protected is FFS and shall be defined by SA WG3 or outside 3GPP.
2-3. Upon receiving the UAV Broadcast Remote Identification information, a receiving entity (e.g. UAV) verifies the validity of the Flight Information, and may use such information for e.g. collision avoidance.
4-5. Upon receiving the UAV broadcast Remote Identification information from an UAV, the TPAE identifies the relevant UFES/USS using the CAA-Level UAV ID as described in clause 6.9.2.4 and based on the CAA-Level UAV ID functional assumptions.
6.	The TPAE discovers the UFES/USS address (e.g. via DNS if the UFES/USS Routing Information is an FQDN), and requests information verification from the UFES/USS by providing the information received in the Broadcast Remote Identification information. In case of USS assigned CAA-Level UAV ID, the query is routed directly to the USS. In the case of 3GPP-assisted CAA-Level UAV ID assignment, the query is routed to the UFES which in turn interacts with the USS, as needed, and retrieves the UAV information (UAV Hardware ID, UAV pilot, UAV operator, etc.) and returns it to the TPAE.",TR 23.754,6.9.3.1,all_images/image_1607.jpeg,Use of CAA-Level UAV ID For Broadcast Remote Identification.
"Figure 6.9.3.2-1: UAV Identity registration and allocation based on UAV bootstrapping
1.	UAV conducts registration and data connectivity procedure with 3GPP network. In this phase the 3GPP system and UFES will have this new UAV identifier information (e.g. create an entry with mapping between the 3GPP UAV ID and the CAA-Level UAV ID).
2.	UAV updates UFES with its remote identification information (e.g. if the controller may be changed during the flight) as well as the operation status information.
3.	UFES updates the record of UAV remote Identification information which is stored in the UDM.
4.	TPAE queries (the query may reach UFES or USS depending on how TPAE is setup, depending on specific deployments; if sent to USS, the USS forwards to the UFESs of the MNOs serving UAVs registered with the USS) regarding the remote identification information of an un-identified UAV in certain location.
5.	UFES sends Nnef_EventExposure_Subscribe (Location) to NEF.
6.	NEF sends Namf_EventExposure_Subscribe (Area of interest) to AMF. The message includes a request for the identifier(s) of UAV(s) in the area of interest.
7.	AMF sends Namf_EventExposure_Notify (3GPP UAV ID(s)) to NEF.
8.	NEF sends Nnef_EventExposure_Notify (3GPP UAV ID(s)) to UFES.
10.	UFES queries the latest stored UAV remote identification and tracking information from UDM using the UE ID.
11.	UFES (directly or via USS) sends to the TPAE the UAV remote identification, UAV location and tracking information including the CAA-level UAV ID of the UAV in the queried location.",TR 23.754,6.9.3.2,all_images/image_1608.jpeg,UAV Identity registration and allocation based on UAV bootstrapping
,TR 23.754,6.10.2,all_images/image_1610.jpeg,Procedure for registering to UTM for UAS operations and issuance of CAA-Level
"Figure 6.11.3-1: Procedure for UAS flight authorization, indication of database for network publishing and authorized flight operations
1.	The UAV/UE initiates a registration procedure to register to the 3GPP system. This could be a standalone registration procedure as detailed in TS 23.502 [7], clause 4.2.2, or it can involve a linked procedure whereby the 3GPP system will extend that registration procedure toward sthe USS to obtain USS registration of the UAV. An example of how this can be performed is given in the Solution 6.10: ""Registration of UAV and issuance of Assigned Identity for Remote Identification and Tracking "".
2.	The UAV is now registered to 3GPP (i.e 3GPP registered) and also registered for UAS services with USS (i.e USS registered). With this the UAS has a USS_Assigned_ID.
NOTE 1:	There is no suggestion that step 2 always happens when step 1 happens. For instance, for a registration update by the UAV/UE, contacting the USS is not necessary.
NOTE 2	The time between step 2 and step 3 can be some time in between, maybe even hours or even days.
3.	UAS wishes to perform flight operations and if the user plane resources for UAS to contact UTM/USS is not available, the UE initiates session management procedures of TS 23.502 [7], to establish connectivity with the USS. Whilst the session mamangement procedures are part of the 3GPP system, the intent of UAS using the allocated resources for flight authorization request need not be made known to the 3GPP system.
4.	From UE subscription profile, the SMF knows it is a UAV requesting the establishment of a PDU Session. The SMF is not aware what the PDU Session is for but knows that it is a registered UAV requesting for a PDU Session.
The SMF interacts with NEF requesting notification of USS/UTM flight path authorisation for that UAV. Other events such as USS/UTM authorisation to UAV for UAV –UAVC pairing might also be requested too. It will be decided in normative phase if this event request for the notification of flight authorization is a new service event or a modification (additional) to an existing service event.
The NEF identifies and discovers the USS/UTM through the available CCA-Level UAV ID.
4a.	NEF having discovered the relevant USS/UTM, subscribes to the USS/UTM to notify the NEF whenever UAV's request for flight authorization is granted. The specific UAV can be indicated in this request by using either the 3GPP UAV ID or the CAA-Levl UAV ID following the conclusion of KI#1.
5.	Between the UAS and USS communication and information exchange is performed over the user plane. The USS grants the UAS the authorization to perform flight operations. This solution assumes that, along with that, the USS provides the USS with the address (and location details) of the database to which the UAS can publish flight information as part of Remote Identification and Tracking.
NOTE 3:	Step 5 is application level exchange and is transparent to the 3GPP system.
6.	USS informs the 3GPP system that the UAV has been granted authorization for flight operations. With knowledge of that authorization, the 3GPP system knows the UAV is entitled to request 3GPP resouces as part of the flight operations.
7.	NEF passes the notification to SMF that UAS flight operations has been authorized. This can be used by SMF for decision making when UAV request further session resources.
With the CAA-Level UAV-ID available to the 3GPP system and the SMF having the UAV subscription profile / UE context and there knowing there is the CAA-Level UAV ID will be able to associate that a request for PDU Establishment is by a UAV. As the subscribe event services and notify event services can also be linked to a UAV by its CAA-Level UAV ID, SMF thus know that certain UAVs have been authenticated and authorized for flight operations.
When this solution is applied to LTE/SAE, the AMF will be replaced by the MME, the SMF replaced by the PGW and the NEF replaced by the SCEF.",TR 23.754,6.11.3,all_images/image_1612.jpeg,"Procedure for UAS flight authorization, indication of database for network publishing"
"For the procedure to provide network capability to AF (USS/UTM) is depicted in figure 6.12.3-1.
Figure 6.12.3-1: procedure to provide network capability to AF (USS/UTM)
1.	An UAV request flight path authorization (out of scope of this solution).
2.	An UTM/USS request NEF to subscribe network capability information (e.g. network coverage, and mobility limitations information). The request may contain device type, departure time, flight path.
3.	(Optional) an NEF translate geographical representation of flight path into list of TAIs/cell IDs. If UTM/USS have the information of TAI/cell IDs deployment, this step could be skipped.
4.	An NEF subscribe PCF for network capability information with translated request in step 3.
5.	An PCF derive mobility limitations information for a requested departure time along with the flight path.
NOTE:	An PCF can derive mobility limitations information using local policy as described in Clause 5.3.4.1 of TS 23.501 [12].
6.	An PCF notify the network mobility limitations information to NEF.
7.	NEF translate the notification into geographical representation if required.
8.	NEF notify UTM/USS with the translated notification by step 7.
9.	UTM/USS response the UAV about the flight path authorization by considering network mobility limitations information. (out of scope of this solution).",TR 23.754,6.12.3,all_images/image_1613.jpeg,procedure to provide network capability to AF (USS/UTM)
"Figure 6.14.3.1-1: UAV and UAV Controller tracking and flight analyses
1.	The UTM sends Flight route tracking request (GPSI/MSISDN, UE trajectory) to UAVF. The UTM obtains UAV GPSI during UAV authentication and authorization procedure which is described in the solutions for KI#2 and KI#3.
2.	The UAVF requests periodic UE locations from GMLC by invoking the Deferred 5GC-MT-LR for periodic events in clause 6.3.1 in TS 23.273 [8] (if GPSI is received in step 1) or the Instigation and Reporting of Periodic and Triggered Location in clause 9.1.19.1 in TS 23.271 [13] (if MSISDN is received in step 1).
3.	The UAVF analyses the UE location with UE trajectory.
4.	[Conditional] When UAVF decides that the UAV location deviate the UE trajectory, it sends Flight route tracking response (deviation from trajectory notify, deviation distance) to the UTM.
5.	Based on notification, the UTM may perform flight control, e.g. sends warnings or updates flight route.",TR 23.754,6.14.3.1,all_images/image_1614.jpeg,UAV and UAV Controller tracking and flight analyses
"Figure 6.15.3.1-1: UAV and UAV Controller tracking based on eLCS mechanism
0.	The AMF triggers UAV/UAV Controller authentication and authorization to the UTM. In this step, the AMF sends the mapping between UAV/UAVC ID provided by UAV/UAVC and 3GPP UAV ID to UDM. After step 0, the UAV/UAVC requests PDU Session establishment. The UAV/UAVC ID is used for identification of UAV towards the UTM and the TPAEs and is defined outside 3GPP. The 3GPP UAV ID is described in solutions for Key Issue #1, #2 and #3.
1.	The UAV/UAV Controller sends Flight authorization Request (UAV ID, UAV Controller ID, flight path, UAV location, UAV Controller location) to the UTM. This message is sent via user plane and is out of scope for 3GPP.
2.	The UTM sends a LCS Service Request to GMLC to request UAV/UAVC location from network. The request includes UAV/UAVC ID, the required QoS and other attributes.
3.	This step is same as steps 2-23a in 5GC-MT-LR procedure in clause 6.1.2 in TS 23.273 [8]. Once the location is received from the 3GPP system, the UTM verifies the location information provided by UAV/UAV Controller.
4.	The UTM sends Flight authorization Response to UAV/UAV Controller.
5.	The UTM sends LCS Service Request to GMLC to request periodic location of UAV/UAVC.
6.	This step is same as steps 2-30a in Deferred 5GC-MT-LR procedure in clause 6.3.1 in TS 23.273 [8]. The UTM receives the periodic location of UAV and UAVC.
7.	UTM analyses the positions of UAV and UAV Controller, e.g. the UTM decides whether the UAV is approaching no-fly zones.
8.	[Conditional] Based on the analyses in step 7, the UTM controls the flight when necessary, e.g. sends warnings to UAV/UAV Controller or updates the flight route when the UAV is approaching no-fly zones.
9.	When the flight is finished, the UTM sends LCS Cancel Location to GMLC.
10.	This step is the same as steps 2-12a in Cancellation of Reporting of Location Events by LCS Client procedure in clause 6.3.3 in TS 23.273 [8].",TR 23.754,6.15.3.1,all_images/image_1615.png,UAV and UAV Controller tracking based on eLCS mechanism
"This procedure enables UTM to require 3GPP system to execute specific verification regarding specific target UAV, such verification result can be used by UTM as criteria to authorize UAV flight operation. Furthermore, this procedure also enables UTM to request the 3GPP system to report UAV behaviour information periodically for monitor and tracking purposes.
Figure 6.17.3-1: Procedure for Network-Assisted UAV Authorization & Monitoring upon Flight Operations
1.	UAV register to network and is authorized as a UAV. The UTM might be involved in the authorization procedure.
2.	UAV triggers and establish the PDU session with UTM for C2 communication.
NOTE 1:	The PDU Session establishment can reuse current PDU Session establishment procedure defined in clause 4.3.2.2 of TS 23.502 [7] or refer to solution 5.
3.	When UAV is triggered e.g. by an upper layer application to take off, UAV sends flight operation permission request to UTM via user plane of 3GPP system. This request may include UAV identity, UAV current location, UAV planned trajectory, etc.
NOTE 2:	Step 3 is outside the scope of 3GPP.
4.	UTM sends the Nnef_ProvideLocation Request to NEF to request 5GS to execute specific verifications regarding to target UAV, such as verify whether the UAV taking off site is within a restricted zone or not. This request may include the UAV identity, UAVC identity, UAV current location, and also indicate which verification type core network is requested to execute.
5.	The NEF forwards the request to UCF.
6.	After receiving the request, the network shall conduct the verification procedure as requested by UTM regarding to target UAV, such as obtaining the location information of UAV and corresponding UAVC by following the Location Procedures defined in TS 23.273 [8].
7.	UCF transfer the verification results or some other UAV flight behaviour information (e.g. UAV position) obtained in step 6 to NEF.
8.	NEF forwards the verification results or other requested UAV flight behaviour information to UTM.
9.	UTM evaluates the flight permission request sent by UAV based on the verification results or UAV flight behaviour information provided by the network and local policy, and then returns the flight permission response to UAV via user plane of 3GPP. Receiving information regarding the UAV location, the USS can verify e.g. if the UAV is within a restricted zone. If UAV does not get flight permission from the UTM, step 10 to step 16 are skipped.
10.If the UTM authorizes the UAV to take flight in step 9, UTM shall send Nnef_EventExposure_Subscribe request to the NEF to subscribe for the UAV flight report, this request shall indicate what UAV flight behaviour information required by UTM, such as UAV position, historical trajectory or monitoring events notifications (e.g. Loss of Connectivity, UE reachability).
11.	NEF invokes the Nnef_EventExposure_Subscribe Request to UCF for subscribing the UAV flight status report required by UTM.
12.	UCF acknowledges the execution of the subscription to NEF.
13.	NEF acknowledges the execution of the subscription to UTM.
14. Core network periodically monitors the UAV flight status e.g. UAV position, historical trajectory or subscribed monitoring events (e.g. Loss of Connectivity, UE reachability)as requested by the UTM.
15.	UCF invokes the Nnef_EventExposure_Notify to NEF to transfer the UAV flight report, this report includes the information requested by the UTM.
16.	NEF forwards the UAV flight report to UTM.
17.	After receiving the UAV flight report provided by core network, UTM shall evaluate the UAV flight behaviour based on the local policy or criteria, if detecting any UAV abnormal behaviour, UTM may, for example, take over the UAV control immediately by C2 communication with UAV.
NOTE 3:	Step 17 is outside the scope of 3GPP.",TR 23.754,6.17.3,all_images/image_1617.jpeg,Procedure for Network-Assisted UAV Authorization & Monitoring upon Flight
"Figure 6.20.3-1: UAV-UAV controller association and C2 communication setup
1.	A UAV Controller UE performs initial registration in the 3GPP network and establish a PDU session for communication between the UAV Controller and the USS/UTM.
2.	The UAV Controller UE performs UAS Registration with USS/UTM using application layer signalling to get authentication and authorization for the UAS service, if it has not registered in the USS/UTM. It is assumed that the UAV may also include information on its counter party (UAV controller) UEs in the Registration signalling message. The UAS registration is replaced by a notification of network connectivity change towards the USS/UTM if the UAV Controller UE is already registered in the USS/UTM.
NOTE:	The details of such information exchange at application layer are out of scope of SA WG2.
3-4.	The UAV UE performs the same procedures as described in step 1-2 for the UAV Controller UE.
5.	The  UAV UE initiates a PDU Session Establishment with DN authorization procedure to request USS/UTM authorization on association with the UAV Controller UE.
6.	The UAV UE provides the UAV Controller UE ID to the USS/UTM during the authorization procedure. The authentication/authorization procedure may be simplified just to handle association authorization. Upon successful authorization, the USS/UTM provides the counter party UE ID to the network for use in connectivity control.
7.	The UAV UE receives a PDU Session Establishment Response message from the 3GPP network for communication  with the selected counter party UE.
8	The 3GPP network provides the IP address of the UAV UE to the USS/UTM.
9.	The USS/UTM sends an application signalling to the counter party UE to trigger the PDU Session Establishment. The message includes the initiating UAV UE ID.
10.	Same DN authorization procedure as for step 5-8 is performed for the UAV Controller UE. The USS/UTM receives the IP address of the UAV Controller UE from the 3GPP network.
11-12.	The USS/UTM sends a UAS Association Update message to the 3GPP network, in which a UAV UE (or UAV Controller UE) is registered,  to deliver the IP addresses of the UAV controller UE (or UAV UE, respectively).
13-14.	The 3GPP network performs the PDU session modification procedure to update packet filter information for UAS communication. The UAC and UAV controller start UAS communication.",TR 23.754,6.20.3,all_images/image_1618.png,UAV-UAV controller association and C2 communication setup
"In the procedure, it is assumed that the UAV and the UAV-C are served by the same USS/UTM via different PLMNs which could be either EPC or 5GC. It is also assumed that the UAV and the UAV-C has successfully registered with the 3GPP network and established UP connectivity with the USS/UTM.
Figure 6.21.3-1: Procedure for UAV/UAV-C association and C2 communication path setup
1.	The UAV and the UAV-C perform authentication and authorization procedure with the USS/UTM. After successful authentication and authorization, the USS/UTM maintains a context for the UAV and UAV-C respectively which may contain their identifiers, such as UAV UE ID (3GPP identifiers) and UPID (e.g. drone serial number). Note that UAV-C may not be connected through a PLMN and in that case the PLMN related procedures described here on the UAV-C side may not be needed.
If the UAV or UAV-C has been previously authenticated and authorized for UAV operations, this step is not mandatory each time for establishing C2 communication.
2.	The UAV-C initiates an Association Request and indicates the peer UPID in the request. Other information such as flight plan information may be submitted at this time or at a later stage.
3.	The USS/UTM checks whether the association request can be authorized, e.g. by checking whether the owner certificates match each other. If the association request is approved, the USS/UTM allocates a UTID for the associated UAV and UAV-C respectively.
4.	The USS/UTM sends an association notification message to the serving PLMNs of the UAV and UAV-C. The USS/UTM may have stored the information of the UAV or networked UAV-C's serving PLMN during the previous UAV authentication/authorization procedure. The notification message may contain the UAV/UAV-C UE ID and the allocated UTID of UAV or UAV-C. If the UE has already established the UP connectivity for UAV operation (e.g. for communication with UTM), the PLMN may modify the existing UP connection to enable it for C2 communication. In this case, Step 6 is optional.
5.	The USS/UTM may also send an association notification message to the UAV and UAV-C via user plane. The network may forward the association information message (including UTID) to the UE via control plane signalling.
6.	Upon receiving the association notification, the UAV and the UAV-C may initiate UP connectivity setup for C2 communication. The APN or DNN used for the connectivity establishment may be dedicated for C2 communication and configured in the UE (e.g. via URSP rule). In the connectivity request the UAV/UAV-C may indicate the connectivity is used for C2 communication and include the associated UTID. The serving network may accept the connectivity establishment but may indicate to the UAV and UAV-C that the connectivity is limited pending further authorization.
7.	The serving PLMNs acknowledge the association notification to the USS/UTM and may inform the USS/UTM of the established UP connectivity info for C2 communication, such as the transport address (UAV/UAV-C IP addresses). The transport addresses of the UAV(or UAV-C) will be forwarded by the USS/UTM to the serving network of its peer-device (in Step 8), for the network to set up proper forwarding rules; or forwarded to the application in the peer-device (in Step11). Also, the IP address received from the network is considered trusted by USS/UTM as opposed to if it was send directly by the UAV. The serving PLMN provides the UTID to the USS/UTM for the latter to retrieve the corresponding UAV context. In the case of networked UAV-C the UTID may be used to further locate the specific UAS context, as the UAV-C may control multiple UAVs simultaneously.
8.	The USS/UTM updates the UAS context with the received UP connectivity info (e.g. peer transport addresses) for C2 communication.
9.	At this point, the USS/UTM may authorize the C2 communication between the UAV and UAV-C and send a notification message to the UAV and UAV-C's serving PLMNs. Based on the UAV IP addresses received in the message, the network may set up proper forwarding rules to enable UAV/UAV-C communication.
10.	The UAV and UAV-C's serving PLMNs may modify the UP connectivity to make it fully functional for C2 communication.
11.	The USS/UTM may optionally send an application layer notification via user plane to the UAV and UAV-C to inform them that they are now authorized for C2 communication. The application layer trigger may be used by USS/UTM to synchronize when UAV and UAV can start sending C2 traffic.
12.	The UAV and UAV-C may now start exchanging C2 communication.",TR 23.754,6.21.3,all_images/image_1619.png,Procedure for UAV/UAV-C association and C2 communication path setup
"Figure 6.22.3.1-1: UAV identification and notification to Remote ID USS
1-3.	3GPP registration of the UAV UE as per TS 23.502, Figure 4.2.2.2-1 for 5GC and TS 23.401, Figure 5.3.2.1-1 for EPC.
4.	From the downloaded UE subscription data, the AMF/MME identifies that the UE has an aerial subscription and it is an UAV UE. This implicitly configures an event notification to be sent to the Remote ID USS. The event notification is sent only at initial registration. The event notification to USS shall contain the CAA Level UAV Id assigned to the UAV. So, the AMF/MME at this point, sends an Identity Request to the UAV UE to provide the CAA Level UAV Id.
5.	UAV UE includes the CAA Level UAV Id in Identity Response.
6.	The AMF/MME now creates an event notification. The event notification contains event type as ""UAV UE registration"" and information elements like CAA Level UAV Id, GPSI (e.g. external identifier) and may also contain the current location of the UAV UE. The notification is sent to the USS via NEF/SCEF. Based on operator policies, the USS address can be pre-configured or could be derived based on the CAA Level UAV Id.
7.	The Remote ID USS may at this point authenticate the CAA Level UAV ID presented by the UAV UE. If the UAV is authenticated by the USS, the USS may through interfaces outside the scope of 3GPP, indicate to the UAS operator that they can operate the UAS. The 3GPP system is not involved in these operations and may also not be aware of the outcome of the authentication done by the Remote ID USS. The Remote ID USS is assumed to store and maintain a mapping between the CAA Level UAV Id and GPSI (e.g. external identifier)
8.	Remote ID USS further uses the GPSI (e.g. external identifier) for accessing any services exposed by the MNO for that UAV UE... The USS may use the GPSI (e.g. external Identifier) to send the configuration request to the 3GPP network, that can be further sent to the UAV UE by the network.",TR 23.754,6.22.3.1,all_images/image_1620.jpeg,UAV identification and notification to Remote ID USS
"The solution is based on below assumptions:
-	An UAS consists of one UAV controller (UAVC) and one UAV. A single USS/UTM is serving both the UAV and the UAVC associated within an UAS
-	The process for associating the UAV and UAVC to form an UAS is outside the scope of 3GPP and is assumed to be done at the USS/UTM.
-	The UAV and UAVC forming the UAS may be served by different MNO. The identification, authentication / authorization of the UAVC and UAV can happen independently.
-	The registration of the UAV with aviation authority (CAA) is outside the scope of 3GPP. Once the UAV is registered to the CAA, a CAA-Level UAV ID is assigned to the UAV.
-	At 3GPP level the UAV is publicly identified by an MNO assigned GPSI in the form of an External Identifier.
-	The UAV may establish separate PDU sessions with dedicated DNN/S-NSSAI (or dedicated APNs in EPC) for
-	Communication with USS/UTM (e.g. OAM purpose, Networked Remote Id, Tracking etc)
-	Command and control (C2) communication between UAV and mutually exclusively an UAVC or a TPAE or an USS/UTM
-	Possibly One or more PDU sessions (PDN connection in EPC) for other communication purposes (e.g. for video streaming etc).
-	The UAV gets via means out of scope of 3GPP a USS/UTM address and this is included by the UAV in the request for the PDU session establishment. How the USS/UTM address is configured in UAV is outside the scope of 3GPP.
-	Mapping between CAA-Level UAV ID and External Identifier is maintained by the USS/UTM.
-	For EPC, the PDN connections used by UAV are served by a combo SMF+PGW-C regardless of whether the UAV support 5G NAS or whether their subscription allows access to 5GC. This allows reusing common procedures between EPC and 5GC; and of course, allows UAV/UAVC to freely move between 5GC and EPC coverage.
-	The solution re-uses (with necessary adaptation) Secondary authentication/authorization by a DN-AAA.
NOTE 1:	Re-using (with necessary adaptation) of Secondary authentication/authorization by a DN-AAA allows to reuse an existing feature (limiting the cost of introduction of the UAS support by 3GPP systems) that can equally apply over EPC and 5GC.
NOTE 2:	APN used by the UAV for contacting the USS/UTM resolves to SMF+PGW-C only.
NOTE 3:	The 3GPP system shall be able to verify that the USS/UTM address provided by the UAV/UAVC UE can be trusted. Security solutions for verification of the USS/UTM address and establishing trust relationship by 3GPP network shall be covered at SA WG3.",TR 23.754,6.23.2.1,all_images/image_1621.jpeg,Overall solution for an UAV with non-networked UAVC
"The solution is based on below assumptions:
-	An UAS consists of one UAV controller (UAVC) and one UAV. A single USS/UTM is serving both the UAV and the UAVC associated within an UAS
-	The process for associating the UAV and UAVC to form an UAS is outside the scope of 3GPP and is assumed to be done at the USS/UTM.
-	The UAV and UAVC forming the UAS may be served by different MNO. The identification, authentication / authorization of the UAVC and UAV can happen independently.
-	The registration of the UAV with aviation authority (CAA) is outside the scope of 3GPP. Once the UAV is registered to the CAA, a CAA-Level UAV ID is assigned to the UAV.
-	At 3GPP level the UAV is publicly identified by an MNO assigned GPSI in the form of an External Identifier.
-	The UAV may establish separate PDU sessions with dedicated DNN/S-NSSAI (or dedicated APNs in EPC) for
-	Communication with USS/UTM (e.g. OAM purpose, Networked Remote Id, Tracking etc)
-	Command and control (C2) communication between UAV and mutually exclusively an UAVC or a TPAE or an USS/UTM
-	Possibly One or more PDU sessions (PDN connection in EPC) for other communication purposes (e.g. for video streaming etc).
-	The UAV gets via means out of scope of 3GPP a USS/UTM address and this is included by the UAV in the request for the PDU session establishment. How the USS/UTM address is configured in UAV is outside the scope of 3GPP.
-	Mapping between CAA-Level UAV ID and External Identifier is maintained by the USS/UTM.
-	For EPC, the PDN connections used by UAV are served by a combo SMF+PGW-C regardless of whether the UAV support 5G NAS or whether their subscription allows access to 5GC. This allows reusing common procedures between EPC and 5GC; and of course, allows UAV/UAVC to freely move between 5GC and EPC coverage.
-	The solution re-uses (with necessary adaptation) Secondary authentication/authorization by a DN-AAA.
NOTE 1:	Re-using (with necessary adaptation) of Secondary authentication/authorization by a DN-AAA allows to reuse an existing feature (limiting the cost of introduction of the UAS support by 3GPP systems) that can equally apply over EPC and 5GC.
NOTE 2:	APN used by the UAV for contacting the USS/UTM resolves to SMF+PGW-C only.
NOTE 3:	The 3GPP system shall be able to verify that the USS/UTM address provided by the UAV/UAVC UE can be trusted. Security solutions for verification of the USS/UTM address and establishing trust relationship by 3GPP network shall be covered at SA WG3.",TR 23.754,6.23.2.1,all_images/image_1622.jpeg,Overall solution for an UAV with networked UAVC
"The procedure for UAV authentication and authorization and further authentication and authorization of C2 communication establishment by the USS/UTM during PDU session establishment in a 5GC network is depicted in Figure 6.23.3.1-1 below.
Figure 6.23.3.1-1: Authentication/authorization and C2 communication establishment for UAV/UAVC by USS/UTM via 5GC
1.	The UAV registers to the 3GPP network. The UE's subscription information obtained by AMF from the   UDM has an indication for support for Aerial UE function and the AMF provides the subscription information on Aerial UE authorization to the gNB.
NOTE 1:	It is assumed that the UAV has been registered to the CAA level authority, a CAA-Level UAV ID is available with the UAV/UAVC and the UAV/UAVC has a USS/UTM address configured.
2.	The UAV initiates a PDU session establishment request for communication with USS/UTM.
3.	Based on the UAV UE's subscriber profile, DNN and S-NSSAI provided in the request the AMF selects the SMF and sends Nsmf_PDUSession_CreateSMContext Request to the SMF. It is assumed that the UAV is configured with the appropriate S-NSSAI and DNN to use or that the 3GPP Network has configured the Default S-NSSAI and Default DNN to be dedicated for UAV-USS/UTM connectivity.
4.	The SMF obtains subscription data from the UDM for the given SUPI obtained from the AMF.
The SMF checks the subscription data whether a secondary authentication is required for the PDU session request and whether the UE request is allowed according to the user subscription and local policies. If the secondary authentication is required and the UE request is allowed, the SMF may further send a request to the UAV to fetch the USS/UTM specific identifier (e.g. CAA-Level UAV ID) and (optionally) a USS/UTM address for secondary authentication if it was not already provided by the UAV in step 2 above.
The SMF send UAV authentication & authorization request to the UAV NF including the CAA-Level UAV ID received from the UAV UE, the GPSI (e.g. External Identifier of the UE) and USS/UTM address if received. The SMF may also reserve an IP address for the PDU session and include the UE IP address information in the UAV authentication & authorization request to the UAV NF.
5.	UAV NF shall verify that the USS/UTM address provided by the UAV can be trusted. If the USS/UTM address provided by the UAV is an FQDN, UAV NF uses DNS resolution to find out the IP address of the USS/UTM. The UAV NF forwards the UAV authentication & authorization request to the selected USS/UTM.
6.	Depending on the security mechanism, multiple roundtrip messages may be exchanged between the UAV and USS/UTM.
NOTE 2:	Security details will be determined by SA WG3.
7.	If the authentication & authorization was successful at USS/UTM, the USS/UTM provides the successful response with authorization information to the UAV NF. The USS/UTM may maintain a mapping of the CAA-Level UAV ID and the 3GPP level UAV ID (i.e. the GPSI) to further access services exposed by the 3GPP network using the 3GPP level UAV ID.
8.	The UAV NF provides the UAV A&A response to the SMF.
9.	After successful authorization by the USS/UTM, further PDU session establishment procedure is continued.
10.	SMF may notify the USS/UTM the IP address(es) allocated to the UAV via the UAV NF if it was not provided in step 4. The USS/UTM may store the correlated GPSI and PDU session IP address with the authorized CAA-Level UAV-ID to enable further service requests via network exposure APIs to the 3GPP system related to the authorized UAV. The GPSI may e.g.be used to activate monitoring of the UAV/UE location and the PDU session IP address for requests for dedicated QoS and gating to be applied for the authorized PDU session. It may also be used to revoke the established connectivity/PDU-session if it is deemed necessary by the USS/UTM.
11.	[Optional] USS/UTM may provide access control list information, so that the PDU session is used only for accessing UAS services (e.g. connecting to the USS/UTM or other UAV operations). For this the USS/UTM interacts with the PCF via UAV NF to configure dedicated polices.
12.	The UAV may use this PDU session for communicating with to the USS/UTM for Networked Remote ID (NRID) and tracking related communication with USS/UTM.
13.	Once the UAV is ready for flight operation, it initiates a new PDU session establishment request for C2 communication if separate PDU sessions are used for USS/UTM communication and for C2 communication. If a single PDU session is used for both, the UAV UE requests for PDU session modification indicating C2 related operation.
14.	The SMF verifies whether a secondary authentication is required for the PDU session establishment/modification request and performs authentication of the request by the USS/UTM using the same procedures as explained in steps 4 – 8 for UAV authentication and authorization.
15.	SMF continues with the PDU session establishment/modification only after successful authentication & authorization done the by USS/UTM.
16.	If a separate PDU session was used for C2 communication and the UE IP address allocation for the PDU session was not included in the authentication & authorization request towards USS/UTM in step 14, the SMF notifies the IP addresses allocated to the UAV UE to the USS/UTM via the UAV NF. If the same PDU session is used for C2 communication this step is skipped as the UE IP address is already notified in step 4 or 10. The USS/UTM may store the correlated GPSI and PDU session IP address with the authorized CAA-Level UAV-ID to enable further service requests via network exposure APIs to the 3GPP system related to the authorized UAV. The PDU session IP address may be used for requests for dedicated QoS and gating to be applied for the authorized PDU session. It may also be used to revoke the established connectivity/PDU-session if it is deemed necessary by the USS/UTM.
17.	USS/UTM provides necessary access control list information, so that using the PDU session the UAV can be controlled only by authorized UAV controller or TPAE. If this pairing information is not available, the USS/UTM may provide its own IP address as a UAV controller. And later when the UAV controller IP address is known to the USS/UTM, it may update the access control list, using the same SBI interfaces, to allow C2 communication between the UAV and UAV controller using this PDU session. The USS/UTM interacts with the PCF via UFES/NEF to configure dedicated polices required for setting up C2 communication and/or UAV/UAVC pairing as ""negotiated"" between UAV(C) and USS/UTM. SMF updates the ACL in UPF with the IP addresses provided by the USS/UTM.
18.	USS/UTM may now further configure the C2 communication related information on the UAV. This is done at the application level using PDU session that was established in Step 2-9, and the complete communication is transparent to 3GPP.",TR 23.754,6.23.3.1,all_images/image_1623.png,Authentication/authorization and C2 communication establishment for UAV/UAVC
"Figure 6.24.3.1.1-1: UTM triggered UAV Re-authentication and Re-authorization
1.	The UTM requests the re-authentication and re-authorization for the UAV identified by the 3GPP UAV ID.
2-3.	[Conditional] If UFES does not maintain the serving AMF of the UAV, UFES gets AMF ID from UDM using Nudm_UECM_Get with the 3GPP UAV ID in the received request in step 1.
4.	The UFES notifies Re-auth event to the AMF to re-authenticate/re-authorize the UAV using Nufes_UUAA_Notify with the 3GPP UAV ID and the UAV re-auth event.
5.	The AMF triggers the UUAA procedure.",TR 23.754,6.24.3.1.1,all_images/image_1625.jpeg,UTM triggered UAV Re-authentication and Re-authorization
"Figure 6.24.3.3.1-1: UTM triggered Re-authentication and Re-authorization in EPS
1.	The UTM sends UAV Re-auth request (CAA-level UAV ID, authorization data and RITI) to UFES.
2.	The UFES sends UAV operation request to PGW.
3.	The PGW initiated bearer modification procedure in clause 5.4.2.1 in TS 23.401 [10] to send authorization data and RITI to UE via PCO.
4.	The PGW sends UAV operation response to UFES. The message includes the information that the UE provided in PCO.
5.	The UFES sends UAV Re-auth response to UTM. The message includes the information that the UFES received in step 4.",TR 23.754,6.24.3.3.1,all_images/image_1627.jpeg,UTM triggered Re-authentication and Re-authorization in EPS
"Editor's note:	This clause describes high-level procedures and information flows for the solution.
The procedure for establishment of a PDU session for UAV operations is shown below:
Figure 6.26.3-1: Establishment of a PDU session for UAV operations
0.	UAV registration: A UAS operator registers the UAV, providing the PEI of the UAV device to a UTM/USS with a procedure which is out of scope of 3GPP. The registration procedure includes details of the UAS operator, pilot, UAV make and model etc. The UTM/USS may assign a CAA-Level UAV ID.
1.	UAV Flight Authorisation Request: A UAS operator requests flight authorisation from the UTM/USS provider. At this step the UAS operator provides information identifying the UAV device (i.e. the PEI) and flight path information. The UTM/USS authorises the request and may assign a Flight Authorisation ID. This procedure is also out of scope of 3GPP.
2.	UAV is configured with the Flight information (may include Flight Authorisation ID if provided by the UTM/USS). This operation is also out of scope of 3GPP.
3.	The UAV registers with the 5GC of PLMN-a by performing a normal 5G registration procedure.
4.	During the procedure the AMF obtains the PEI of the UAV.
5.	During registration an optional UUAA procedure may be initiated by the AMF as described in Solution 5.
6.	When the UAV requires connectivity to convey remote identification and tracking information for UAV operation to a UTM/USS the UAV initiates a PDU Session Establishment Request including an indication that the PDU session is required for UAV operation. The UAV includes in a UAV operations transparent container, the CAA-Level UAV ID and the Flight Authorisation ID of the associated flight path if provided by the UTM/USS in step 1.
Editor's note:	It is FFS if the ""indication for UAV operation"" in the PDU Session Establishment Request is explicitly (i.e. specific UAV operation indication) or implicitly (i.e. specific DNN, S-NSSAI) included.
7.	The AMF first selects an SMF that is capable to support PDU Sessions for UAV operation and forwards the PDU session establishment request to the selected SMF. This message includes the ""UAV operation request"" indication, the UAV operations transparent container, the PEI of the UAV and the present location of the UAV, i.e., the present Tracking Area Identity (TAI) and Cell Identity (CID) of the UAV. The ""UAV operation request"" indicates to SMF that the requested PDU Session is needed in order to support UAV operations (e.g. in order to allow a UAV to fly according to an authorized flight plan).
8.	The SMF/UFES obtains the SM subscription data of the UAV from UDM and selects a UTM/USS to verify the UAV is authorised for UAV operation. The SMF/UFES select a UTM/USS based on the present location of the UAV and the CAA-level UAV ID provided by the UAV.
9.	The SMF/UFES sends a UAV Operation Request message to UTM/USS which includes the PEI, the UAV operations transparent container and the present location of the UAV. This message is sent to the UTM/USS via UAV6 reference point.
10.	The UTM/USS authorises the request and determines the RITI. The RITI includes; a globally unique CAA-Level UAV ID, generated by the UTM/USS, that is used as a means to remotely identify the UAV and also includes the UTM endpoint address for the UAV to report data. In addition, the UTM/USS may determine Authorisation Data that include the authorised area & time where the UAV can operate.
NOTE:	At this point the UTM/USS verifies that the UAV s authorised for UAV operation based on PEI of the UAV and, if provided, the CAA-Level UAV ID and Flight Authorisation ID.
11.	UTM/USS sends a UAV Operation Accept response to SMF via UAV6 reference point including the RITI. The UTM may also provide Authorisation Data denoting conditions that this PDU session is authorised to be active (e.g. location area/time).
12.	The SMF/UFES stores the authorization data and may subsequently use it to determine if the UAV operates in compliance within this data, e.g. if it remains within the authorized area of operation.
After this step, the SMF may interact with the PCF, as normally, and receive PCC rules applicable to the PDU Session for UAV operation. As an example, these PCC rules may contain QoS information that should be applied by the radio access network for establishing the resources needed to support the UAV operation.
13.	The SMF sends a PDU Session Establishment Accept message that contains the RITI to the UAV.
14.	The UAV broadcasts the CAA-Level UAV ID which is used for remote identification of the UAV over the air.
15abc.	The UAV also uses the UAV ID to report flight information data (i.e. position, speed altitude etc) to the UTM (endpoint) identified by the received RITI. The UAV ID is used by the UTM to associate the UAV with a valid flight authorization.
16.	The UTM receives the UAV data provided by the UAV and identifies / tracks the UAV.",TR 23.754,6.26.3,all_images/image_1628.jpeg,Establishment of a PDU session for UAV operations
"Figure 6.27.2.1-1: Procedure for replacing the UAV Controller of a UAS
1.	The UAV is communicating with UAV Controller 1.
2.	The USS sends a UAV Operation Update to the SMF (via UFES if applicable), containing new authorized UAV and UAV Controller pairing information.
NOTE 1:	Other solutions define the content of such UAV and UAVC pairing information, e.g. 3GPP UAV IDs and corresponding IP addresses. How the IP addresses of UAV and UAVC are available to the USS/UTM is also described in other solutions.
3.	The SMF configures user plane connectivity for UAV to UAV Controller 2 communication based on information provided by the USS (e.g. policies and/or UTM authorized UAV and UAV Controller pairing information ) to enable user plane connectivity between the UAV and the UAV Controller 2 and disable user plane connectivity between the UAV and the UAV Controller 1.
NOTE 2:	The configuration includes configuring over N4 traffic filters with the IP addresses received at step 2 that enable/disable UAV and UAV controller connectivity, QoS information for data flow, etc., as for a regular IP data flow.
4.	[Conditional] If UAV Controller 1 or UAV Controller 2 is a Networked UAV Controller, steps 2 and 3 are repeated with the SMF(s) serving UAV Controller 1 and UAV Controller 2, respectively, which may belong to the same or to a different PLMN.
NOTE 3:	The messages can be combined with step 2 if the same UFES is used.
5.	The UAV communicates with UAV Controller 2.",TR 23.754,6.27.2.1,all_images/image_1629.png,Procedure for replacing the UAV Controller of a UAS
"NOTE 1:	UFES in these flows is the same as UAS NF.
In steps 2 - 12 a PDU session for UAV(C) connectivity to USS/UTM is set-up. This PDU session is used for application level UAV(C) - USS/UTM communication e.g. UAV tracking, C2 related configuration, UAV/UAVC pairing.
In the case of UAV/UAVC pairing it can be that the UAV and UAVC is in different operators' networks and the configuration of the C2 communication must be handled in each operator's network.
Step 13 handles setting up the dedicated policies need for C2, UAV/UAVC pairing, tracking performed in the 3GPP network, and other exposure functionality performed by the 3GPP network, etc.
Figure 8.3.1-1: Authentication/authorization and C2 communication establishment for UAV/UAVC by USS/UTM via 5GC
1.	The UAV/UAVC registers to the 3GPP network. The UE's subscription information obtained by AMF from the   UDM has an indication on support for Aerial UE function and the AMF provides the subscription information on Aerial UE authorization to the gNB.
NOTE 2:	It is assumed that the UAV has been registered to the CAA level authority, a CAA-Level UAV ID is available with the UAV/UAVC and the UAV/UAVC has a USS/UTM address configured.
2.	Once the UAV/UAVC is registered to the USS/UTM, it can initiate a PDU session establishment request for USS/UTM connectivity and/or C2 communication. The UAV/UAVC shall include the signed USS/UTM address and CAA-Level UAV ID, etc. in the PDU session establishment request.
3.	Based on the UAV/UAVC UE's subscriber profile, DNN and S-NSSAI provided in the request the AMF selects the SMF and sends Nsmf_PDUSession_CreateSMContext Request to the SMF, including the USS/UTM address and CAA-Level UAV ID, etc.
4.	The SMF obtains subscription data from the UDM and performs the necessary actions for UAV IP address allocation.
If the UUAA is required, the SMF sends an UAV Operation Request (e.g. using a service interface) to the UFES, including the CAA-level UAV ID, USS/UTM address, GPSI, PEI, ""allowed for aerial use"", UAV IP Address, etc.
NOTE 3:	Security details will be determined by SA WG3.
5.	The UFES selects a USS/UTM from either CAA-Level UAV ID or the USS/UTM address. 
The UFES checks if the subscription is ""allowed for aerial use"" and forwards the received information from the SMF to the USS/UTM, using a service-based interface. The USS/UTM is assumed to be known and trusted by the 3GPP System.
6.	Optionally the USS/UTM and the UAV/UAVC may exchange multiple messages as required by the authentication/authorization method used.
7.	The USS/UTM validates the request based on CAA-Level UAV ID and GPSI and optionally PEI. Upon successful authorization, the USS/UTM notifies the UFES on the authentication/authorization result, including security info to be used by the UAV to set up a secure connection to the USS/UTM using the PDU session.
The USS/UTM stores a mapping between CAA-Level UAV ID and the External Identifier. The External Identifier and/or UAV IP Address can be used at a later point by the USS/UTM for accessing various services exposed by 3GPP network e.g. location information retrieval, monitoring event configuration etc.
The External Identifier and/or UAV IP Address can be used at a later point by the USS/UTM for requesting dedicated policies for e.g. C2, etc.
8.	The UFES sends the authentication/authorization result to the SMF.
As alternative to step 13, if C2 and pairing related information is available from UAV(C) and/or USS/UTM during the initial PDU Session Establishment procedure the SMF may interact with the PCF to set up PCC rule(s) for the C2 communication and/or UAV/UAVC pairing.
NOTE 4:	If the UAV and UAVC are located in different operators network the dedicated policies needs to be configured in respective operator networks.
9-11. The final parts of PDU Session Establishment procedure are performed. The security info from step 7 is transferred to the UAV.
12.	A secure connection is set up based on the ""security info"" received from USS/UTM in steps 7 to 10. The PDU session may further be used for Networked Remote ID (NRID), Tracking, for C2 related configuration or UAV/UAVC pairing, etc.
13. The USS/UTM interacts with the PCF via UFES/NEF to configure dedicated polices required for setting up C2 communication and/or UAV/UAVC pairing as ""negotiated"" between UAV(C) and USS/UTM in step 12.",TR 23.754,8.3.1,all_images/image_1631.png,Authentication/authorization and C2 communication establishment for UAV/UAVC by
"This contribution proposes a service based interface between HSS and UDM. The architecture for this solution is outlined in the following figure:
Figure 6.1.2-1: Architecture for Direct UDM-HSS Interworking with independent UDRs
Figure 6.1.2-2: Architecture for Direct UDM-HSS Interworking with a common repository
A new reference point between UDM and HSS within the combined HSS/UDM (i.e. Nxx as depicted in Figures 6.1.2-1 and 6.1.2-2) is proposed. The new interface for interworking between HSS and UDM is proposed to be based on SBI principles.
NOTE:	The UDM and the HSS may be deployed in a stand-alone manner and could be from different vendors.",TR 23.973,6.1.2,all_images/image_1632.jpeg,Architecture for Direct UDM-HSS Interworking with independent UDRs
"The procedure of the interaction between UDM and HSS FE for Authentication vector(s) Retrieval is shown in Figure 6.2.3.1-1.
Figure 6.2.3.1-1: Authentication vectors Retrieval Procedure between UDM and HSS FE
1a.	When the UE attaches from EPS, MME sends Authentication-Information-Request to UDM to get authentication information for the UE. The MME message is sent to UDM by DRA routing (i.e. based on IMSI range).
1b.	When the UE registers from 5GS, AMF invokes Nausf_UEAuthentication_authenticate service operation to AUSF to get authentication information for the UE.
1b'. AUSF invokes Nudm_UEAuthentication_Get service operation.
2.	When UDM receives Nudm_UEAuthentication_Get, it determines to generate and send S6a Authentication-Information-Request message to HSS-FE based on local configuration, to retrieve UTRAN authentication vectors, if the authentication information is stored in EPS UDR due to operator's deployment.
3.	HSS FE interacts with EPS UDR to retrieve requested type of authentication information of the UE via legacy UDC architecture.
4.	HSS FE returns Authentication-Information-Answer with E-UTRAN authentication vectors or UTRAN authentication vectors to UDM.
5.	if MAP_SEND_AUTHENTICATION_INFO response is received, UDM converts CS or PS authentication vectors to 5GS authentication vectors.
5a.	UDM forwards Authentication-Information-Answer with E-UTRAN authentication vectors to MME.
5b'.	If UTRAN authentication vectors are received, UDM generates the respond to Nudm_UEAuthentication_Get service operation invocation with 5GS authentication vectors converted from UTRAN authentication vectors, and sends the respond to AUSF.
5b.	AUSF response the AMF invoked Nausf_UEAuthentication_authenticate service.
NOTE:	How UDM converts authentication vector is implementation specific.
The procedure of the interaction between UDM and HSS FE for single Registration is shown in Figure 6.2.3.1-1.
Figure 6.2.3.1-2: Single Registration Procedure between UDM and HSS FE
1.	The UE is registered in 5G. The AMF perform UE registration in UDM. The AMF indicates whether it requires single registration or dual registration.
2.	If the AMF requires single registration then the following steps are performed. Otherwise the procedure stops.
3.	The UDM selects the HSS FE based on the SUPI and sends Update Location Request to HSS FE. In this message a dedicated MME Identity is included. This dedicated MME Identity is pointing to the UDM. From HSS FE point of view, the UDM is now acted as a MME. This message also includes an indication to indicate single registration and an indication to indicate the skip of subscription data so the HSS FE will not send the UE 4G subscription data.
4.	The HSS FE stores the dedicated MME Identity into EPS UDR via Ud interface.
5.	The HSS FE sends Update Location Response to UDM.
6.	If the UE has been registered in an old MME, the HSS FE sends Cancel Location Request towards this old MME. This message will be routed to MME directly based on the old MME Identity.
7.	The old MME deregisters the UE and sends Cancel Location Response to the HSS FE.
8.	After the UE reselects 4G and performs Tracking Area Update procedure in 4G, the new MME sends Update Location Request towards the HSS FE. As the UDM is the only access point both to 5GC and EPC, this message is sent to UDM and the UDM relays this message to HSS FE.
9.	The HSS stores the new MME information into EPS UDR via Ud interface.
10.	The HSS sends Update Location Response to new MME via UDM including the UE 4G subscription.
11.	Because the UE has been registered in 5G and a dedicated MME Identity pointing to the UDM is stored in the EPS UDR, the EPS UDR triggers the HSS FE to send Cancel Location Request towards the UDM. This message will be routed to UDM based on the dedicated MME Identity.
12.	UDM sends Cancel Location Response to HSS FE.
13.	Upon receiving Cancel Location Request from HSS FE targeting to deregister the UE in 5G, the UDM initiated Deregistration procedure to deregister the UE in 5G.",TR 23.973,6.2.3.1,all_images/image_1638.jpeg,Authentication vectors Retrieval Procedure between UDM and HSS FE
"The procedure of the interaction between UDM and HSS FE for Authentication vector(s) Retrieval is shown in Figure 6.2.3.1-1.
Figure 6.2.3.1-1: Authentication vectors Retrieval Procedure between UDM and HSS FE
1a.	When the UE attaches from EPS, MME sends Authentication-Information-Request to UDM to get authentication information for the UE. The MME message is sent to UDM by DRA routing (i.e. based on IMSI range).
1b.	When the UE registers from 5GS, AMF invokes Nausf_UEAuthentication_authenticate service operation to AUSF to get authentication information for the UE.
1b'. AUSF invokes Nudm_UEAuthentication_Get service operation.
2.	When UDM receives Nudm_UEAuthentication_Get, it determines to generate and send S6a Authentication-Information-Request message to HSS-FE based on local configuration, to retrieve UTRAN authentication vectors, if the authentication information is stored in EPS UDR due to operator's deployment.
3.	HSS FE interacts with EPS UDR to retrieve requested type of authentication information of the UE via legacy UDC architecture.
4.	HSS FE returns Authentication-Information-Answer with E-UTRAN authentication vectors or UTRAN authentication vectors to UDM.
5.	if MAP_SEND_AUTHENTICATION_INFO response is received, UDM converts CS or PS authentication vectors to 5GS authentication vectors.
5a.	UDM forwards Authentication-Information-Answer with E-UTRAN authentication vectors to MME.
5b'.	If UTRAN authentication vectors are received, UDM generates the respond to Nudm_UEAuthentication_Get service operation invocation with 5GS authentication vectors converted from UTRAN authentication vectors, and sends the respond to AUSF.
5b.	AUSF response the AMF invoked Nausf_UEAuthentication_authenticate service.
NOTE:	How UDM converts authentication vector is implementation specific.
The procedure of the interaction between UDM and HSS FE for single Registration is shown in Figure 6.2.3.1-1.
Figure 6.2.3.1-2: Single Registration Procedure between UDM and HSS FE
1.	The UE is registered in 5G. The AMF perform UE registration in UDM. The AMF indicates whether it requires single registration or dual registration.
2.	If the AMF requires single registration then the following steps are performed. Otherwise the procedure stops.
3.	The UDM selects the HSS FE based on the SUPI and sends Update Location Request to HSS FE. In this message a dedicated MME Identity is included. This dedicated MME Identity is pointing to the UDM. From HSS FE point of view, the UDM is now acted as a MME. This message also includes an indication to indicate single registration and an indication to indicate the skip of subscription data so the HSS FE will not send the UE 4G subscription data.
4.	The HSS FE stores the dedicated MME Identity into EPS UDR via Ud interface.
5.	The HSS FE sends Update Location Response to UDM.
6.	If the UE has been registered in an old MME, the HSS FE sends Cancel Location Request towards this old MME. This message will be routed to MME directly based on the old MME Identity.
7.	The old MME deregisters the UE and sends Cancel Location Response to the HSS FE.
8.	After the UE reselects 4G and performs Tracking Area Update procedure in 4G, the new MME sends Update Location Request towards the HSS FE. As the UDM is the only access point both to 5GC and EPC, this message is sent to UDM and the UDM relays this message to HSS FE.
9.	The HSS stores the new MME information into EPS UDR via Ud interface.
10.	The HSS sends Update Location Response to new MME via UDM including the UE 4G subscription.
11.	Because the UE has been registered in 5G and a dedicated MME Identity pointing to the UDM is stored in the EPS UDR, the EPS UDR triggers the HSS FE to send Cancel Location Request towards the UDM. This message will be routed to UDM based on the dedicated MME Identity.
12.	UDM sends Cancel Location Response to HSS FE.
13.	Upon receiving Cancel Location Request from HSS FE targeting to deregister the UE in 5G, the UDM initiated Deregistration procedure to deregister the UE in 5G.",TR 23.973,6.2.3.1,all_images/image_1639.jpeg,Single Registration Procedure between UDM and HSS FE
"The procedure of the interaction between UDM and HSS FE is shown in Figure 6.2.3.2-1.
Figure 6.2.3.2-1: IP continuity procedure for interworking without N26 from 5GS to EPS
0.	PGW-C+SMF registers its FQDN in UDM during registration procedure. UDM stores the FQDN in 5GS UDR.
1.	When the UE attaches in EPS due to interworking without N26 from 5GS to EPS, during the procedure, MME sends Update Location Request to UDM.
2.	UDM forwards Update Location Request to HSS FE for further handling.
3.	HSS FE interacts with EPS UDR to handle Update Location Request.
4.	HSS FE returns Update Location Ack to UDM.
5.	after receiving Update Location Ack, UDM retrieve PGW-C+SMF FQDN from 5GS UDR.
6.	UDM generates a new Update Location Ack to add PGW-C+SMF FQDN into the message and forwards the message to MME.
NOTE:	The other signalling interactions not related to the solution are not present in this figure for simplification.",TR 23.973,6.2.3.2,all_images/image_1640.jpeg,IP continuity procedure for interworking without N26 from 5GS to EPS
"The procedure of the interaction between UDM and HSS FE is shown in Figure 6.2.3.3-1.
Figure 6.2.3.3-1: T-ADS Procedure between UDM and HSS FE
1.	SCC AS initiates T-ADS query towards UDM by sending a User-Data-Request message via Sh interface.
2.	UDM forwards this User-Data-Request message to get T-ADS information related to EPS and UMTS.
3.	HSS FE may query MME to get more T-ADS information as specified in TS 23.401 [16].
4.	HSS FE may query SGSN to get more T-ADS information as specified in TS 23.060 [15].
5.	HSS FE returns T-ADS information based on the information it derives by sending a User-Data-Answer message.
6.	after receiving T-ADS information from HSS FE, UDM may query AMF for more T-ADS information as specified in TS 23.501 [6].
7.	UDM determines T-ADS result based on T-ADS information received from HSS FE and AMF and responds to SCC AS with the T-ADS information by sending a User-Data-Answer message.
NOTE:	The other signalling interactions not related to the solution are not present in this figure for simplification.
For the single registration case the following message flow in figure 6.2.3.3-2 applies:
Figure 6.2.3.3-2: T-ADS Procedure with Single registration and UE is 5GS registered
In Figure 6.2.3.3-2 it is clear that due to the fake registration concept, the HSS is the entity that is in charge of taking T-ADS decisions, and not the UDM, even when the UE is registered in the 5GS with the UDM.",TR 23.973,6.2.3.3,all_images/image_1641.jpeg,T-ADS Procedure between UDM and HSS FE
"The procedure of the interaction between UDM and HSS FE is shown in Figure 6.2.3.3-1.
Figure 6.2.3.3-1: T-ADS Procedure between UDM and HSS FE
1.	SCC AS initiates T-ADS query towards UDM by sending a User-Data-Request message via Sh interface.
2.	UDM forwards this User-Data-Request message to get T-ADS information related to EPS and UMTS.
3.	HSS FE may query MME to get more T-ADS information as specified in TS 23.401 [16].
4.	HSS FE may query SGSN to get more T-ADS information as specified in TS 23.060 [15].
5.	HSS FE returns T-ADS information based on the information it derives by sending a User-Data-Answer message.
6.	after receiving T-ADS information from HSS FE, UDM may query AMF for more T-ADS information as specified in TS 23.501 [6].
7.	UDM determines T-ADS result based on T-ADS information received from HSS FE and AMF and responds to SCC AS with the T-ADS information by sending a User-Data-Answer message.
NOTE:	The other signalling interactions not related to the solution are not present in this figure for simplification.
For the single registration case the following message flow in figure 6.2.3.3-2 applies:
Figure 6.2.3.3-2: T-ADS Procedure with Single registration and UE is 5GS registered
In Figure 6.2.3.3-2 it is clear that due to the fake registration concept, the HSS is the entity that is in charge of taking T-ADS decisions, and not the UDM, even when the UE is registered in the 5GS with the UDM.",TR 23.973,6.2.3.3,all_images/image_1642.jpeg,T-ADS Procedure with Single registration and UE is 5GS registered
"The procedure of the interaction between UDM and HSS FE is shown in Figure 6.2.3.5-1.
Figure 6.2.3.5-1: SMSF address storage and retrieval between UDM and HSS FE
1.	SMSF invokes Nudm_UECM_Registration service operation to register its address in UDM.
2.	UDM interacts with 5GS UDR to store the SMSF address.
3.	When SMS-SC or SMS GMSC initiates MT SMS delivery procedure, SMS-SC or SMS GMSC send MAP request i.e. Send Routing Information for SM request, to UDM.
4.	UDM interacts with 5GS UDR to retrieve stored SMSF address.
5.	UDM responds with SMSF address.",TR 23.973,6.2.3.5,all_images/image_1644.jpeg,SMSF address storage and retrieval between UDM and HSS FE
"This solution applies to deployment scenario 1 and 2.
This solution proposes a deployment and coexistence alternative which avoids the need of specification of interworking procedures between UDM and the existing HSS.",TR 23.973,6.3.1,all_images/image_1646.jpeg,Coexistence of existing HSS and Combined HSS/UDM with common repository used
"This solution applies to deployment scenario 1 and 2.
This solution proposes a deployment and coexistence alternative which avoids the need of specification of interworking procedures between UDM and the existing HSS.",TR 23.973,6.3.1,all_images/image_1648.jpeg,Coexistence of existing HSS and Combined HSS/UDM with separate repositories
"This solution applies to deployment scenario 1 and 2.
This solution proposes a deployment and coexistence alternative which avoids the need of specification of interworking procedures between UDM and the existing HSS.",TR 23.973,6.3.1,all_images/image_1651.jpeg,Coexistence of existing HSS and Combined HSS/UDM using a common repository
,TS 23.251,7,all_images/image_1653.jpeg,Information flow for redirection in GERAN (PS domain)
,TS 23.251,7,all_images/image_1654.png,Information flow for registration in CS domain after PS Handover
"This solution addresses Key Issue #5 on UAV Application Server QoS Provisioning, and in particular provides a mechanism for ensuring the end-to-end application QoS requirement fulfilment for C2 application, considering that the QoS of one of the links may downgrade. It is assumed that the UAV flight is ongoing, and both the UAV and UAV-C are connected to 3GPP network (the same or different). C2 communication is assumed to be in-direct / network-assisted; hence two PDU sessions are established respectively (one for the UAV and one for the UAV-C). An illustration of the scenario is provided at the Figure below:
Figure 8.4.1.1-1: Exemplary illustration of network-assisted C2 communication
Initially, the UAE client at the UAV-C sends a request to the UAE-S to monitor and manage the end-to-end application QoS for the C2 communication. This triggers the UAE-S to subscribe to the corresponding PLMNs for receiving QoS monitoring events for both PDU sessions (one for UAV and one for UAV-C). When a QoS monitoring event is received by the UAE-S, the UAE-S checks whether the QoS of the other link can be upgraded and how, in order to meet the end-to-end C2 requirements. If UAE server evaluates that QoS upgrade can be triggered to compensate for the QoS downgrade of the other PDU session, the updated QoS requirements are sent to the underlying PLMN(s) for one or both sessions.",TR 23.755,8.4.1.1,all_images/image_1656.jpeg,Exemplary illustration of network-assisted C2 communication
"Pre-conditions:
1.	The UAS is registered and connected to the PLMN (s). UAV flight is ongoing and C2 communication is in-direct (two PDU sessions are established one for UAV and one for UAV-C and the relation / pairing between UAV and UAV-C is known at the UAE-S).
2.	UAE-S and UAE clients (of the UAV, UAV-C) have established application enabler layer sessions. UAE-S is also capable of using SEAL services.
3.	UAE-S has already registered to receive QoS monitoring event notifications from 5GC and notifications from UEs (from both UEs)
Figure 8.4.1.2-1: UAE-assisted coordinated QoS provisioning for C2 communication
1a.	The UAE-S receives from the UAE client of the UAV-C a request for managing the QoS for the C2 application session. This request message will provide to the UAE-S the capability to manage C2 communication and may include necessary information for the UAS such as UAS identification, PLMN ID(s), C2 control mode (direct stick, stick to waypoints), use of HD video flag, geographical area where the requirement applies, time of validity for the requirement.
1b.	Following, the UAE-C provides a response indicating a positive/negative acknowledgement.
2a.	The UAE-S receives a trigger event from the 5GC (SMF/NEF), denoting a QoS downgrade notification for the UAV session. Here there are two cases for the QNC: one for notification control with Alternative QoS profiles for the QoS flows (clause 5.7.2.4.1b of 3GPP TS 23.501 [12]) where the 5GS provides the alternative downgraded QoS to be applied; and one for notification control without Alternative QoS profiles (clause 5.7.2.4.1b of 3GPP TS 23.501 [12]).
2b.	(optionally, as alternative to 2a), A trigger event is sent from the UAE client of the UAV and/or the UAV-C to the UAE-S, denoting an application QoS change (experienced or expected) e.g. based on the experienced packet delay or packet loss for the Uu link (e.g. packet loss > X%)
3a.	The UAE-S interacts with 5GC (NEF) and/or SEAL services to acquire supplementary information for the UAV/UAV-C session or for the network status. This information may support identifying whether the QoS requirements for UAV/UAV-C session can or cannot be upgraded.  In particular, the 5GC/SEAL services may be:
-	On-demand location reporting from LM-S (clauses 9.3.4 and 9.4.2 of 3GPP TS 23.434 [11]): UAE-S acts as VAL server and requests/receives reporting on demand for the UAV-C.
-	NEF Monitoring Events (see 3GPP TS 23.502 [13]): UAE-S acting as AF subscribes and gets notified on network /QoS monitoring Events via ""MonitoringEvent"" and the ""AFSessionWithQoS"" APIs to track mobility and session related events for a certain UE.
-	QoS sustainability analytics (see 3GPP TS 23.288 [10]): UAE-S acting as AF subscribes and gets notified on the expected QoS status for the corresponding UAV-C session by NWDAF (via NEF). This will support the UAE-S to capture possible QoS fluctuations over a time window.
3b.	Optionally, the UAE-S may also receive notifications (based on subscription, as in Pre-condition 3) from UAV-C or UAV related to the application QoS fulfillment / status.
4.	The UAE-S checks the fulfilment/non-fulfilment of the E2E QoS based on the trigger event of step 2a/2b and the additional information from the 5GC/SEAL and/or the UAV/UAV-C as in steps 3a/3b (about the UAV/UAV-C session which is not downgraded). This is performed by matching the estimated application QoS per link to the composed E2E application QoS metrics. Then, the UAE-S, determines an action, based on the evaluation of the E2E QoS. This action is the QoS adaptation of both links (QoS profile downgrade for the link receive QoS notification control, and QoS upgrade for the link which can be upgraded).
NOTE:	If Alternative QoS profiles are set in advance by the AF, the UAE-S will only update the upgraded QoS and will not decide on the QoS requirements adaptation for the downgraded flow.
5.	The UAE/SEAL server, acting as AF, sends to the 5GC (to SMF via NEF or to PCF via N5) a request for a change of the QoS profile mapped to the one or both network sessions (UAV, UAV-C) or the update of the PCC rules to apply the new traffic policy (both AF triggered actions are supported in 3GPP TS 23.501 [12]/3GPP TS 23.502 [13])",TR 23.755,8.4.1.2,all_images/image_1657.jpeg,UAE-assisted coordinated QoS provisioning for C2 communication 
"Both uplink QoS (from the UAV/UAV-C to the network) or the downlink QoS (from the network to UAV/UAV-C) may be monitored and managed for UAV/UAV-C application layer operations as specified in 3GPP TS 22.125 [3]. The QoS includes but is not limited to network bandwidth, latency, jitter, data loss rate, etc. Currently, three supported C2 communication modes may require different network resources support from the UAS application layer.
With regarding to C2 communication using 3GPP network, a SEAL GM server as specified in 3GPP TS 23.434 [11] may need to be configured to ensure a match between a pair of UAV and UAV-C based on certain UAS ID configuration, such as either a 3GPP UE ID or CAA-level UAV ID. Network QoS provisioning can be triggered by the SEAL NRM server based on group ID.
Editor's note: The design of UAS ID is out of this specification's scope.
This solution provides a group-based scheme to address the QoS provisioning for C2 communication specified in the key issue #5. The procudure involves a group creation using SEAL GMS followed by a workflow for QoS management using SEAL NRM server.
Pre-conditions:
-	Both UAV-C and UAV have successfully connected to the UAE server.
-	A CAA-level UAV ID may be assigned during 3GPP network registration process.
Figure 8.5.1-1 illsutrates a high-level procedure for group creation.
Figure 8.5.1-1: Procedure for group creation for one pair of UAV and UAV-C
1.	The UAE server recognizes a unique pair of UAV and UAV-C either by 3GPP UE ID or CAA-level UAV ID.
2.	When the UAE server recognizes there is a QoS degradation for either UAV or UAV-C, the UAE server may send group creation request to SEAL GM server, if there is no pre-assigned group ID, by using GM-S reference link as specified in 3GPP TS 23.434 [11] using the procedure defined in clause 10.3.
3.	SEAL GM server may create one group ID for one pair of UAV and UAV-C as specified in 3GPP TS 23.434 [11].
4.	The UAE server may use the returned group ID for UAS for QoS management. In the absence of group, the SEAL NRM server may use UE IDs of the UAV and UAV-C to manage QoS for UAV and UAV-C separately.
5.	Once group ID has been created, the UAE server may use such group ID for the purpose of QoS provisioning by communicating with NRM.
Figure 8.5.1-2 illsutrates a high-level workflow of group-based C2 QoS provisioning.
Editor's note:	QoS provisioning when C2 is in dynamically changing mode is FFS.
Pre-conditions:
-	Both UAV and UAV-C have registered to 3GPP 5G network respectively. C2 communication is established.
-	The SEAL group manager has been configured and a group ID or a separate ID for a UAV and UAV-C assigned for each of the UAV and UAV-C.
Figure 8.5.1-2: Procedure of group-based approach for C2 QoS provisioning.
1.	The UAE server consistenly monitors the QoS for a UAV and UAV-C.
2.	In cases where the network condition for C2 communication does not satisfy the pre-defined QoS requirement, the UAE server may choose to send QoS adaptation request to the SEAL NRM server using the NRM-S reference point as specified in 3GPP TS 23.434 [11]. The QoS adaptation request may be sent per group ID for a pair of UAV and UAV-C or a unique ID for each UAV and UAV-C which depends on how the UAE server handles group creation specified in Figure 8.5.1-1.
3.	The SEAL NRM server performs network resource adaptation as specified in the 3GPP TS 23.434 [11] clause 14.3.2.1.
4.	The NRM server notifies the QoS update to the UAE server using procedure defined in 3GPP TS 23.434 [11] clause 14.3.2.2.
5.	UAS application layer adapts the updated QoS assignment.",TR 23.755,8.5.1,all_images/image_1658.png,Procedure of group-based approach for C2 QoS provisioning.
"The procedure below shows how a primary mode of C2 communication is selected and C2 communication is established between a UAV and UAV-C, and how the C2 communication is switched to a UTM-navigated C2 communication mode when instructed by USS/UTM. The solution is illustrated with network-assisted C2 communication as the initial C2 communication mode and UTM-navigated assisted as the final mode. The principle also applies in the reverse direction or from direct to UTM-navigated or vice-versa. UAE-S is assumed to be authorized to use SEAL services. The UAE-S forward messages (e.g. Sends link selection and switching policy, active C2 communication mode, C2 communication switch) between USS/UTM and UE (UAV/UAV-C).
Figure 8.6.1.2-1: UAS application layer assisted switch between Direct/Indirect and UTM-navigated C2 communication
1a.	The UAV is registered and connected with the USS/UTM and with direct and/or indirect link available for C2 communication.
1b.	The UAV-C is registered and connected with the USS/UTM and with direct and/or indirect link available for C2 communication.
2a.	UAV's UAE-C receives a C2 communication link selection and switching policy from the USS/UTM via UAE-S in a U1-AE message indicating: the allowed communication modes (e.g., direct, network assisted, UTM-navigated), the primary C2 communication mode (e.g., network-assisted, direct or UTM-navigated), policy for redundant C2 connection handling (e.g., backup link not needed, preferred, or required), and QoS threshold values to trigger the switch of C2 communication. UAV's UAE-C may notify locally the UAS Client via the Uc reference point about relevant parameters from the policy (e.g., allowed C2 communication modes).
NOTE:	C2 communication policy transmission can be performed either during or following the UAV/UAV authentication and authorization by USS/UTM procedure.
2b.	UAV-C's UAE-C receives a C2 communication link selection and switching policy from the USS/UTM via UAE-S in a U1-AE message. UAV-C's UAE-C may notify locally the UAS Client via the Uc reference point about relevant parameters from the policy (see 2a. for further details).
3a.	UAV's UAE-C selects a primary mode of communication based on C2 link selection and switching policy.
3b.	UAV-C's UAE-C selects a primary mode of communication based on C2 link selection and switching policy.
4.	UAV's UAE-C and UAV-C's UAE-C negotiate (e.g., over the primary link used as U1-AE) whether to use a backup C2 connection based on C2 link selection and switching communication policy.
5a.	UAV's UAE-C notifies USS/UTM via UAE-S about the current active C2 communication mode used (direct or network-assisted). UAV's UAE-C notifies locally UAS Client of the same.
5b. UAV-C's UAE-C notifies USS/UTM via UAE-S about the current active C2 communication mode used (direct or network-assisted). UAV-C's UAE-C notifies locally UAS Client of the same.
6a.	Alternative 1: UAV's UAS Client engages in indirect C2 communication with UAV-C's UAS Client via 5GC and a Data Network (DN).
6b.	Alternative 2: UAV's UAS Client engages in direct C2 communication with UAV-C's UAS Client.
7.	USS/UTM detects a condition to switch to UTM-navigated C2 communication mode (e.g., entry into a no-fly zone, based on reported UAV location).
8a.	USS/UTM instructs UAV's UAE-C via UAE-S in a U1-AE message to switch to UTM-navigated C2 communication mode indicating the target IP address to use for C2 communication (if different from the one used in step 1/2). UAV's UAE-C indicate to UAV's UAS client via the Uc reference point to switch C2 communication mode according to USS/UTM command. USS/UTM informs the UAE-S how to handle the existing C2 communication connection with UAV-C (e.g., maintain or release).
8b.	UAE-S transmits a message to NRM server to trigger the release of existing link if required.
8c.	USS/UTM may notify UAV-C's UAE-C via UAE-S of the switch to UTM-navigated (e.g., UAS client may alert operator of UTM take over). C2 communication with UAV and UAV-C is ""paused"" while UTM-navigation C2 communication mode is taking place  and may be resumed following a similar command from USS/UTM as step 8a/8b to switch back to direct/indirect C2 communication mode (e.g., after UAV moved away from a No Drone Zone).
9.	UAV's UAS Client switches to UTM-navigated C2 communication with USS/UTM via 5GC and a Data Network (DN).",TR 23.755,8.6.1.2,all_images/image_1659.png,UAS application layer assisted switch between Direct/Indirect and UTM-navigated C2
"The procedure below shows how a primary mode of C2 communication is selected and C2 communication is established between a UAV and a UAV-C, and how the C2 communication is switched to a secondary mode of C2 communication based on policies provisioned by the USS/UTM. The solution is illustrated with direct C2 communication as the primary and network assisted as the secondary mode, but the principle is the same for the reverse scenario. UAE-S is assumed to be authorized to use SEAL services.
Figure 8.7.1.2-1: UAS application layer assisted switch Direct/Indirect C2 communication
1a.	The UAV/UE is registered and connected with USS/UTM and direct and indirect links are available for C2 communication.
1b.	The UAV-C/UE is registered and connected with USS/UTM and direct and indirect links are available for C2 communication.
2a.	UAV's UAE-C receives a C2 communication link selection and switching policy from the USS/UTM via UAE-S in a U1-AE message indicating: the allowed communication modes (e.g., direct, network assisted, UTM-navigated), the primary C2 communication mode (e.g., network-assisted, direct) , policy for redundant C2 connection handling (e.g., backup link not needed, preferred, or required), and QoS threshold values (e.g., range/distance limit, delay, signal strength) used to determine whether to trigger the switch of C2 communication. UAV's UAE-C may notify locally the UAS Client via the Uc reference point about relevant parameters from the policy (e.g., allowed C2 communication modes).
NOTE 1:	Such C2 communication policy transmission can be performed either during or following the UAV/UAV authentication and authorization by USS/UTM procedure.
2b.	UAV-C's UAE-C receives a C2 communication link selection and switching policy from the USS/UTM via UAE-S in a U1-AE message. UAV-C's UAE-C may notify locally the UAS Client via the Uc reference point about relevant parameters from the policy (see 2a. for further details).
3a.	UAV's UAE-C selects a primary mode of communication based on C2 link selection and switching communication policy.
3b.	UAV-C's UAE-C selects a primary mode of communication based on C2 link selection and switching communication policy.
4.	The UAV's UAE-C and UAV-C's UAE-C negotiate (e.g., over the primary link used as U1-AE) whether to use a backup C2 connection based on allowed communication modes and redundant C2 communication policy (e.g., ""network-assisted"" allowed, backup required), and QoS thresholds for C2 switching based on values in the C2 communication policy.
5a.	UAV's UAE-C notifies USS/UTM via UAE-S about the current active C2 communication mode. UAV's UAE-C notifies locally UAS Client of the same.
5b.	UAV-C's UAE-C notifies USS/UTM via UAE-S about the current active C2 communication mode. UAV-C's UAE-C notifies locally UAS Client of the same.
6.	UAV's UAS Client and UAV-C's UAS Client engage in direct C2 communication while monitoring the current C2 link against the negotiated QoS thresholds for C2 switching.
NOTE 2:	Usage of ProSe/PC5 for direct C2 communication is not considered in this solution.
7.	UAV's UAE-C and/or UAV-C's UAE-C detects that C2 switching conditions are met on current C2 link (e.g., low signal strength) notifies peer and receive an ack of switch over of C2 communication to the secondary connection. The switch over may be triggered implicitly by UAV and UAV-C's UAS Clients when exchanging C2 messages over the secondary C2 connection (e.g., if the switch notification is lost over the primary connection).
8a.	UAV's UAE-C notifies USS/UTM via UAE-S about the switch to the new active C2 communication mode. UAV's UAE-C notifies locally UAS Client of the same via the Uc reference point.
8b.	UAV-C's UAE-C notifies USS/UTM via UAE-S about the switch to the new active C2 communication mode. UAV-C's UAE-C notifies locally UAS Client of the same via the Uc reference point.
9.	UAV's UAS Client and UAV-C's UAS Client switches to network-assisted C2 communication mode using the secondary C2 connection via 5GC and a Data Network (DN). Following a switch in one direction, the UAV/UAV-C may decide to switch back to the original C2 communication connection if its quality meets negotiated C2 communication QoS thresholds above.",TR 23.755,8.7.1.2,all_images/image_1660.jpeg,UAS application layer assisted switch Direct/Indirect C2 communication
"Figure 8.8.1.2-1: Procedure for QoS requirement retrieval during C2 connectivity establishment
1.	The UAV is authenticated by the USS/UTM and authorized for pairing with the UAV-C and for C2 communication.
2.	The UAV initiates connection establishment procedure for C2 communication. In the establishment request, the UAV indicates that the connection is used for C2 communication, and includes a UAS information container which includes its UAV identifier, UAE Server address, etc. The connection can be for C2 communication with USS/UTM or UAV-C (not shown). Step 2 (and Step 5) is existing NAS procedures (see 3GPP TS 23.502 [13] clause 4.3.2) with enhancement for UAS service.
NOTE 1:	Signaling enhancements are captured in 3GPP TR 23.754 [16].
3.	The 5GC (e.g., SMF/PCF) recognizes that the connection establishment request is for UAV C2 communication If it determines that additional QoS input is needed from the USS/UTM, it locates the UAE Server and queries the UAE-S for initial QoS requirements via the NEF using UAV-provided UAV information container. The UAE-S may retrieve the QoS requirements from the specific UAS application server. Besides the normal QoS requirement metrics such as DL/UL data rate requirements, DL/UL latency requirements, the UAE-S may provide additional filters for differentiating different C2 message types. For example, various C2 message types (e.g., flight control commands vs. location reports) may have different QoS requirements and Traffic Classes or DSCP codes may be assigned to these various message types to help QoS differentiation.
NOTE 2:	UAE-S discovery can use the USS/UTM discovery mechanism described in Solution 5 (Clause 6.5) of 3GPP TR 23.754 [16].
NOTE 3:	5GC initiated QoS requirement request can occur during the SMF-USS/UTM interaction for PDU Session secondary authentication as described in Figure 6.5.3.1-2 (Step 18) of 3GPP TR 23.754 [16].
4.	The UAE-S returns the requested QoS requirements, such as UL/DL data rate requirements, UL/DL latency requirements, additional filters for differentiating various C2 communication types, etc.
5.	Based on received QoS requirement information from the UAE-S, the 5GC provides the initial QoS configuration to the UE for the connection for C2 communication.
6.	The UAV or UAV-C monitors the QoS performance (e.g. latency, data loss, etc.) and sends QoS reports to the UAE-S/UAS Server.
7-8.	Based on received QoS report, the UAE-S may modify the resource requirement via the NRM service as described in 3GPP TS 23.434 [11].",TR 23.755,8.8.1.2,all_images/image_1661.jpeg,Procedure for QoS requirement retrieval during C2 connectivity establishment
"Pre-conditions:
1.	UAV(s) and UAV-C are both connected to 5GS for network-assisted C2 communication, via different PDU sessions.
2.	UAE server has established a UAE session with the respective UAE clients.
3.	UAE server has subscribed for using SEAL/LMS services and has configured the location event reporting, based on 3GPP TS 23.434 [11]. UAE server has also subscribed to NEF for receiving monitoring information on possible QoS downgrade of the one or more involved Uu links (UAV-C to UTM/USS or Application Server to UTM/USS).
4.	The UAS is pre-authorized by the UTM/USS to use and switch between direct and network-assisted communication for a C2 application session.
NOTE:	The configuration of such pre-authorization  by the UTM/USS is out of 3GPP scope.
Figure 8.9.1.1-1: UAE assisted network-assisted to direct C2 mode switching
1.	The UAE-S receives a QoS downgrade indication for the Uu link involving the UAV or UAV-C (as supported in 5GS with QoS notification control (QNC) as specified in clause 5.7.2.4 of 3GPP TS 23.501 [12].
2.	The UAE server requests from SEAL server to provide location information for the UAV and the UAV-C and receives a report (UAE-S acts as VAL server as specified in 3GPP TS 23.434 [11]). This may be processed/augmented location with additional information mobility/position information. Here to note that LMS service is used for receiving UE location reporting, since LMS can provide augmented/supplementary UE location information (from SEAL/LM clients as well as from 5GC / LMF). However, location reporting from 5GC/LMF may also be possible as alternative.
3.	The UAE-S calculates the relative actual or expected UAV-to-UAV-C location. Then by taking into account the relative location (or the expected location) as well as other factors like mobility/speed, direction, topography, weather conditions, it decides to trigger the switching to direct C2 mode.
4.	Optionally, the UAE-S sends a C2 mode switching request message to the UTM/USS, which includes the UAS identifier as well as the cause for switching and the switching option (network-assisted to direct).
5.	Conditional on step 4, the UAE-S receives from the UTM a response indicating a positive or negative result for the requested change.
6.	The UAE-S sends involved UAE clients, a C2 switching mode trigger message which provides an instruction to the UAV and UAV-C to switch to direct mode. Following the C2 direct mode is established; however, this procedure is out of 3GPP R17 scope.",TR 23.755,8.9.1.1,all_images/image_1662.jpeg,UAE assisted network-assisted to direct C2 mode switching
"Pre-conditions:
1.	UAV(s) and UAV-C are both connected to 5GS.
2.	UAE server has established a UAE session with the respective UAE clients.
3.	UAE server has subscribed to LMS to receive location reports for the UAV and the UAV-C. This subscription may be for receiving UAV/UAV-C coordinates or processed/augmented location with additional information mobility/position information.
4.	The UAS is pre-authorized by the UTM/USS to use and switch between direct and network-assisted communication for a C2 application session.
NOTE:	The configuration of such pre-authorization  by the UTM/USS is out of 3GPP scope.
Figure 8.9.1.2-1: UAE assisted direct to network-assisted C2 mode switching
1.	The UAE-S receives a location report for the UAV/UAV-C. The report can be either periodical or event-based (e.g. UAV moving towards an area covered by a different cell or different operator), based on the type of subscription in 3a. Here to note that LMS service is used for receiving UE location reporting, since LMS can provide augmented/supplementary UE location information (from SEAL/LM clients as well as from 5GC / LMF). However, location reporting from 5GC/LMF may also be possible as alternative.
2.	The UAE-S calculates the relative actual or expected UAV-to-UAV-C location. Then by considering the relative location (or the expected location) as well as other factors like augmented location, mobility/speed, direction, topography, weather conditions, it decides to trigger the switching to network-assisted C2 mode. Factors such as mobility/speed and direction can be obtained by the UAV/UAV-C or by the UAS server (as part of the UAS information, which may be provided in advance to the UAE server).
3.	Optionally, the UAE-S sends a C2 mode switching request message to the UTM/USS, which includes the UAS identifier as well as the cause for switching and the switching option (direct to network-assisted).
4.	Conditional on Step 3, the UAE-S receives from the UTM a response indicating a positive or negative result for the requested change.
5.	The UAE-S sends to the involved UAE clients, a C2 switching mode trigger message which provides an instruction to the UAV and UAV-C to switch to network-assisted mode. Following the UAV and UAV-C trigger PDU session establishment or PDU session modification for network-assisted C2 communication.",TR 23.755,8.9.1.2,all_images/image_1663.jpeg,UAE assisted direct to network-assisted C2 mode switching
"This solution addresses key issue#1 and key issue#3.
A 3GPP network-connected UAV may lose communication with the 3GPP network in any phase of UAV operation. When communication is lost, neither USS/UTM nor 3GPP network can pinpoint the location of the UAV. Therefore, it is important to be able to know the network condition in near real-time to avoid any service delays.
This solution provides a real-time UAV connection monitoring and location reporting mechanism to fulfil the Stage 1 requirement. It will not only enable the UAE server to actively monitor the 3GPP network connection with UAVs but also provides other advantages such as accurate location reporting and network converge monitoring.
This solution may apply to the following use cases:
-	Real-time monitor the 3GPP network connection with UAVs.
-	Report when loss of communication with UAVs.
-	Provide last known location after loss of communication.
Figure 8.12.1-1 illustrates the real-time support for UAV Connection monitoring and Location Reporting.
Pre-conditions:
-	A UAV has established a connection with the 3GPP network after the authentication and authorization process.
-	The SEAL network resource management and location services are deployed for connected UAVs.
Figure 8.12.1-1: Real-Time UAV Connection monitoring and Location Reporting
1.	The UAE-S obtains real-time network connection status by periodically pulling the 3GPP network signal reception quality report from NRM-C to NRM-S.
NOTE:	The frequency of actively pulling is implementation-independent. High frequency means high power consumption but provides near real-time monitoring.
2.	The NRM-S then periodically reports back to UAE-S regarding the current network connection status.
3.	When the connection status in step 2 is in UP status, the UAE-S may trigger location update request to LMS as specified in clause 9.3.9 of 3GPP TS 23.434 [11].
4.	The SEAL NRM server interacts with 3GPP CN regarding network connectivity status such as events regarding ""Loss_of_connectivity_notification"" or other PDN connectivities, as specified in 3GPP TS 29.522 [18].
4a.	The NRM server indicates to the UAE server there is a loss or unstable connection.
5.	(optional) With the loss of the communication link, the LMS may still provide the last known location to the UAE server using functions as specified in clause 9.3.9 of 3GPP TS 23.434 [11].
6.	The NRM-S detects communication resumption by interacting with 3GPP CN as specified in 3GPP TS 29.522 [18].
6a.	The NRM-S indicates to the UAE server that the connection is resumed.
7.	Once the UAE server receives notification about connection resumption, it may again trigger the location update request to LMS as specified in clause 9.3.9 of 3GPP TS 23.434 [11].",TR 23.755,8.12.1,all_images/image_1664.png,Real-Time UAV Connection monitoring and Location Reporting
"This procedure illustrated below shows how the UAE server monitors the geographic area of the UAV based on request from the USS/UTM server.
Figure 8.18.1.2-1: UAE layer and network assisted UAV location monitoring
1.	USS/UTM server sends UAV Location Request to UAE server including UAV Identifier, predetermined geographic area information, notification interval and notification URI where the USS/UTM intends to receive the notifications from UAE server regarding UAV's presence in a given area.
-	UAV identifier is 3GPP UAV ID, as per 3GPP TR 23.754 [16].
-	""Geographic area"" is the location information, which the USS/UTM wishes to monitor the UAV's location adherence. This parameter can include an area of interest information and other relevant parameters.
-	""Notify_Interval"" represents the periodic interval in which the UAE server needs to notify UAV's location information to the USS/UTM. When the UAV moves away from the ""Geographic area"", then the UAE server ignores ""Notify_Interval"" and sends the location notification to the USS/UTM immediately.
2.	UAE server, upon receiving the request from USS/UTM, sends a provisional response, indicating that the UAE server accepts USS/UTM's request and will monitor the location of the UAV to verify if the UAV is in the geographic area.
3.	UAE server processes the Geographic area information in the request, and then subscribes to UE location monitoring (LOCATION_REPORTING) as specified in clause 4.4.2 of 3GPP TS 29.522 [18] with appropriate parameters.
-	Location Type set to ""CURRENT_LOCATION""
-	Monitoring Type to ""LOCATION_REPORTING""
-	Accuracy level is determined by the UAE server, based on the details of the flight path information requested by USS/UTM.
4.	UAE server shall subscribe for Location information change event using SS_LocationInfoEvent API, as specified in 3GPP TS 23.434 [11]. Either SEAL server or UAE server maintains a mapping between VAL UE ID of UAV and the 3GPP UAV ID as specified in 3GPP TS 23.754 [16], or it is also possible that VAL UE ID is same as 3GPP UAV ID in the SEAL Location Management Procedures defined in 3GPP TS 23.434 [11].
Based on the location information processed by the UAE server, the UAE server may determine to additionally include the positioning methods to be used in the SS_LocationInfoEvent API invocation to SEAL LMS. If the request from UAE server includes positioning methods information (Like non-3GPP positioning technologies such as, GNSS, Network-based Assisted GNSS etc), then the SEAL Location Management Server and Location Management Client on the UAV shall consider the positioning methods in the request for location reporting.
5. and 6. The UAE server receives the UAV location information from the core network and Location Management Client on the UE, through notifications from NEF and SEAL servers as specified in 3GPP TS 29.522 [18] and 3GPP TS 23.434 [11] respectively.
7a and 7b. UAE server processes the location information received from Location Management Server and the core network, and validates the information. If the location information is matching, then the UAE server shall check if the UAV's current location is within the geographic area received in step 1. The UAE server will continue with step 8, step 9 and step 10 as applicable.
8.	If the location information received from Location management client and the core network do not match, then the UAE server may consider the UAV as outside from its specified geographic area and may notify (""Notify Mismatch Location"" message) the USS/UTM of the same, including 3GPP UAV ID and the location information from LMS and core network in the notification message.
9.	If the UAV's current location is not in the geographic area received in UAV Location Request message, then the UAE server considers the UAV as outside from its specified geographic area and shall notify the USS/UTM of UAV's current location outside of geographic area and UAV's ID in ""Notify UAV Location Absence"" message. USS/UTM may use this information for any corrective actions.
10.	When the UAV's current location is in geographic area, then the UAE server shall notify (""Notify UAV Presence"" message) the USS/UTM periodically, according to the ""Notify_Interval"" value in ""UAV Location Request"" message, indicating the USS/UTM that the UAV is within the geographic area, along with UAV's current location information.
In another alternative, the SEAL server can expose the UAV Location service offering the service described above as new SEAL service. In such a case, UAS server or USS/UTM directly consumes the UAV Location service from SEAL. SEAL LMS fetches the UAV's current location from the location management client of the UAV. Adding such a functionality in SEAL, will also enable other verticals like V2XAPP, to monitor the respective vertical specific UE path.",TR 23.755,8.18.1.2,all_images/image_1666.jpeg,UAE layer and network assisted UAV location monitoring
"This procedure is based on the Group announcement and join procedure in 3GPP TS 23.434 [8] clause 10.3.8. In this procedure the VAL server is composed of the FAE server and the FF application specific server.
Pre-conditions:
1.	The SEAL group management clients, SEAL group management server, VAL server and the VAL clients belong to the same VAL system.
2.	The VAL server is aware of the users' identities and is authorized to form a VAL group for 5G LAN-Type communication.
3.	The VAL clients (at the VAL UEs) belong to the same 5GLAN (5G-VN) group.
Figure 7.9.1.5-1: Procedure for creating a VAL group for 5G LAN-Type communication.
1.	The VAL server determines group information and the identity list to which the group announcement shall be sent. The decision can be based on the list of authorized UEs and other criteria such as requirement for 5G LAN-Type communication service.
2.	The VAL server requests the SEAL group management server to configure a new VAL group for 5G LAN-Type communication service providing a VAL Group ID, a list of VAL UEs and a list of VAL services.
3.	The SEAL group management server creates an empty group and determines that the group is for 5G LAN-Type communication, based on the information provided in the Configure VAL group request. The SEAL group management server determines 5GLAN group data for the VAL server.
4.	The SEAL group management server creates a 5GLAN group in the 5GS via N33 using the dynamic group management procedures specified in 3GPP TS 23.501 [7] clause 5.29.2 and 3GPP TS 23.502 [12] clause 4.15.6. The 5GS delivers 5G VN group configuration information (DNN, S-NSSAI, PDU session type) to the VAL UEs for each GPSI that belongs to the 5GLAN group. The 5G VN group configuration information is delivered in the UE Route Selection Policy (URSP) from the 5GS to the VAL UEs using the UE Configuration Update procedure for transparent UE Policy delivery as described in TS 23.502 [12] clause 4.2.4.3.
5.	The SEAL group management server may subscribe to PDN Connectivity Status events via N33 using the procedures specified in 3GPP TS 23.502 [12] clause 4.15.3.2.3 in order to be notified of the connectivity status of the VAL UEs of the 5GLAN group.
NOTE 1:	The SEAL group management server may use PDN Connectivity Status events e.g. to determine VAL UE's registration state in the group.
6.	The SEAL group management server announces the VAL group to the SEAL group management client at the VAL UEs, including the DNN and communication type (IP or Ethernet) corresponding to the 5GLAN group,
NOTE 2:	The SEAL group management server can decide to use the Application Trigger service provided by the NEF described in 3GPP TS 23.502 [12] clause 5.2.6.5 for group announcement to the group management client or to use the group announcement already specified in 3GPP TS 23.434 [8].
7.	The SEAL group management client in the VAL UEs determines the group to be a 5GLAN group and triggers establishment of a PDU session corresponding to the 5GLAN group.
8.	If the SEAL group management server subscribed to PDN Connectivity Status events in step 5, it is notified once the VAL UE establishes a PDU session to the 5GLAN group. Receiving this event is sufficient for the SEAL group management server to determine that the VAL UE is a member of the group.
9.	The SEAL group management client at the VAL UEs registers to VAL group communication using the VAL Group ID.
10	The SEAL group management server records the users who have registered to be the members of the group.
NOTE 3:	Step 10 may occur as a result of Step 8.
11.	The SEAL group management server sends a VAL group registration response to the SEAL group management clients.
12.	The SEAL group management server sends a configure VAL group response to the VAL server.
NOTE 4:	Step 12 may occur any time after Step 6.
13.	The SEAL group management server sends identity list notification about the newly registered users. The SEAL group management client in the VAL UEs may inform the VAL client about the updated identity list.",TR 23.745,7.9.1.5,all_images/image_1668.jpeg,Procedure for creating a VAL group for 5G LAN-Type communication.
"This solution corresponds to the key issue #8 on communication of FF application requirements with 5GS and key issue#11 on QoS coordination.
In this solution, a FAE client and FAE server (acting as an AS) exchange context information allowing for the desired service requirements (e.g. data rate) for the communication amongst the FF application specific clients to be derived. The FAE server adaptively triggers retrieval of context and establishment of direct service connectivity, e.g. when the two UEs are close to each other. Note that service connectivity among FF application specific clients is established over the FFA-2 reference point, without device-to-device direct radio connectivity (e.g. PC 5) requirement.
The procedure for establishing FFA-2 service communication with FF application specific clients service requirements provided via the FAE Clients is as illustrated in figure 7.11.1-1.
Pre-conditions:
-	FAE client 1 and FAE client 2 are provided configuration information for the FF application specific clients served e.g. connectivity requirements, etc.
-	FAE client 1 and FAE client 2 are configured with the information of the FAE server and have registered (e.g. using clause 7.4 procedures). The information is provided via pre-configuration or registration to the FAE server includes FAE client capabilities, security information, etc. Upon registration, FAE client 1 and FAE client 2 subscribe to connectivity notifications.
-	Pre-processing determines that connectivity between FF application specific client 1 to FF application specific client 2 via the FFA-2 reference point is required. Service requirements and destination information for this connection have been provided, e.g. via discovery.
NOTE: The preconditions above rely upon procedures (e.g. registration, discovery) detailed as part of other solutions.
Figure 7.11.1-1: Establishing communication connectivity between FAE Clients with FF application service requirements
1.	The FAE Client 1 sends the FFAPP connectivity request (source identity and IP address, destination identities, service requirements) to the Future Factory Enabler Server (FAE server) to establish connectivity for FF application specific client 1 on UE 1. The destination FF application specific client(s) may be hosted on one or multiple UEs (devices). The identity of the source and of the destination may be provided as the application user identity or the MAC address.
2.	The FAE server determines whether FF application specific client 1 is authorized to connect to FF application specific client 2 for direct service communications over FFA-2. If FF application specific client 1 is authorized to connect to FF application specific client 2, the FAE server contacts the FAE client 2 to retrieve its FF application specific client 2 context information. This step can be skipped if the FAE server is already aware of FF application specific client 2's context information.
Editor's Note: It is FFS how FAE server determines whether FF application specific client 1 is authorized to connect to FF application specific client 2 for direct service communications over FFA-2.
3.	The FAE client 2 determines whether context information is to be provided for establishing connectivity for FF application specific 2 to FF application specific 1. FAE client 2 makes this determination based on FF application specific client 1 information provided in the request, pre-provisioned information (e.g. policies) and its context (e.g. location, time, etc.) If FAE client 2 determines that context information is to be provided, it responds to FAE server and includes the context information for FF application specific client 2.
NOTE:	The signaling and functionality for handling the cases when FAE client 2 will be temporarily unavailable for establishing the direct service connection are implementation dependant.
4.	The FAE server responds to the FFAPP connectivity request in step 1.
5.	The FAE server retrieves location information of UE 1 and UE 2 hosting the two FF application specific clients respectively. This step may also include a request for direct link status (e.g. PDU Session Status, UE reachability, etc. as described in 23.502 [12]). This step may be skipped if the FAE server is already aware of UE 1's and UE 2's location information or if there are no location requirements for establishing the FF application specific client 1 to FF application specific 2 direct service connectivity.
NOTE:	If SEAL is used, location information may be obtained from the SEAL location management server. Alternatively, Location Reporting monitoring as described in 23.502[12] may be used.
6.	The FAE server takes FF application specific client 1's and FF application specific client 2's context information, their connectivity requirements, location information, and network context as input, checks connectivity service policies, and determines the parameters and patterns for direct service connectivity between the FF application specific clients (i.e. FFA-2 connectivity). The FAE server may also determine transport requirements, e.g. QoS requirements, for the 3GPP system (e.g. 5GS).
If the FAE server determines that direct service connectivity is not possible with the given connectivity requirements, it skips step 7 and proceeds to steps 9 and 10, informing each FAE client accordingly. If the FAE server determines that direct service connectivity is not authorized or not possible with the given connectivity requirements, it skips step 7 and proceeds to steps 9 and 10, informing each FAE client accordingly.
7.	The FAE server may request the 3GPP system to establish or modify the 3GPP system level connectivity that enables the application connection between FF application specific client 1 and FF application specific client 2 e.g. via modification of existing radio bearers. FAE server provides the necessary information (e.g. identifiers of FF application specific client 1 and FF application specific client 2, transport requirements) in this request message.
Editor's Note: If SEAL is used, the procedure for communicating FF application service requirements from FAE server to the 3GPP system may utilize enhanced NRM server functionality. It is FFS whether NRM server functionality may be enhanced to support translating FF application service requirements to 3GPP network requirements.
8.	The FAE server receives a response from the 3GPP system indicating whether the requested connectivity in Step 6 has been successfully established or modified.
9.	The FAE server notifies FAE client 1 of the established connection including its properties such as a FFA-2 direct service connection identifier, duration, etc.
10.	The FAE server notifies the FAE client 2 of the established connection including its properties such as a FFA-2 direct service connection identifier, duration, etc.
Editor's Note: Traffic routing between FAE client 1 and FAE client 2 over FFA-2 is FFS.",TR 23.745,7.11.1,all_images/image_1670.jpeg,Establishing communication connectivity between FAE Clients with FF application
"Pre-condition1: Slice#1 and Slice#2 have already been established. UEs of App#A have registered with the network and connected to Slice#1 (based on the URSP rules which are configured to the UE by the PCF (TS 23.501 [7], 23.503 [15])).
Pre-condition 2: Slice information, such as GST parameters and slice subscriptions are received at the FAE server by the OAM (by consuming Management APIs via EGMF, as in TS 28.533 [18]).
Pre-condition 3: FF application specific server has requested FAE server to manage the App#A to slice mapping. Following, the FAE server maps App#A (and the FF UEs within App#A) to Slice #1 (based on received slice information) and stores the mapping information.
Figure 7.13.1.2-1: FF application to slice mapping by FAE layer
1.	A trigger event is captured at the application layer. Two options are possible:
1a.	The FF application specific client of the FF-UE needs to adapt the app#A to service profile mapping, e.g. due to QoE adaptation, UE mobility, communication model change. Then, the FF application specific client sends to FAE server via the FAE client an updated service profile trigger event report for requesting the adaptation of the service requirements to FAE server.
1b.	FAE server receives from the FF application specific server a request to adapt the application requirements. This request can comprise the change of service profile/requirements mapped to app#A.
2.	FAE server determines the re-mapping of app#A to slice #2. This mapping is based on the updated application requirements (as of step 1a or 1b), the per UE slice subscriptions (for all UEs running app#A), slice capabilities and availability and the GST parameters.
3.	FAE server sends the updated app to slice mapping to the SEAL Server (e.g. NRx server). This message indicates the requirement for mapping the application traffic from slice #1 to slice #2.
4.	The SEAL Server, acting as AF, sends a Nnef_service_parameter create or update request to NEF (as provided in TS23.502 [12] clause 4.15.6.7). The Service Description can be represented by the application identifier (App#A ID) and a combination of the DNN and the target S-NSSAI (slice #2). The updated Service Description is stored in the UDR. The UDR then notifies the PCF and the PCF provides the updated UE policies to the affected UEs.
5. The SEAL server sends a Notification to the FAE server on the completion of the re-mapping of App#A to slice #2.
Editor's note: The enhancement of SEAL (e.g. NRx) to process the slice re-mapping instruction and generate an AF request to trigger the slice re-mapping towards 5GS as described in steps 1-3 is FFS.
Editor's note: Potential overlaps with SA2 for this solution are FFS.",TR 23.745,7.13.1.2,all_images/image_1671.jpeg,FF application to slice mapping by FAE layer
"Clause 6.2 in TS 23.434 [8] shows SEAL functional model for the signalling control plane. CoAP-based entities and reference points are introduced to the functional model, as shown in the figure 7.20.2-1.
Figure 7.20.2-1: SEAL functional model for signalling control plane including CoAP entities
The proposed CoAP signalling entities and reference points are described further in clauses 7.20.3 and 7.20.4, respectively.",TR 23.745,7.20.2,all_images/image_1674.jpeg,SEAL functional model for signalling control plane including CoAP entities
"The architecture for integration of the 5G with TSN is depicted in Figure 7.22.2-1. The SEAL NRM server acts as a TSN AF. Upon request from an FF Application layer server acting as a TSN CNC via the NRM-S reference point it configures the TSN flows in the 5GS. In this case the NRM-S supports the IEEE 802.1Qcc management protocol. As a TSN AF the SEAL NRM server interacts with the 5GS PCF over the N5 reference point to configure the 5G QoS and TSCAI parameters in the 5GS.
Figure 7.22.2-1: Functional model to support TSN in the SEAL layer
The architecture for the 5G-native TSC is depicted in Figure 7.22.2-2. The SEAL NRM server acts as an AF (referred to as TSC AF) towards the 5G Core Network and performs coordination of QoS flows to fulfill the end-to-end QoS requirements for the UEs involved in the TSC communication. When QoS monitoring is requested, the SEAL NRM server will also perform coordination of the QoS montoring subscriptions and notifications needed for the end-to-end QoS flows using the mechnisms of Solution #10. Upon request from an FF Application layer server via the NRM-S reference point it configures the TSC end-to-end QoS flows in the 5GS. In line with other SEAL service enablers the SEAL NRM server provides a RESTful interface on the NRM-S reference point. As a TSC AF the SEAL NRM server interacts with the 5GS PCF over the N5 reference point to configure the 5G QoS and TSCAI parameters in the 5GS. UE-TSC corresponds to UE-DS-TT in the TSN integration case, which also means that UE-TSC residence time is the same as UE-DS-TT residence time that is used for the end-to-end latency calculation.
NOTE: The NRM server uses procedures of the N5 reference point specified in Rel-16.
Figure 7.22.2-2: Functional model to support 5G-native TSC in the SEAL layer",TR 23.745,7.22.2,all_images/image_1676.jpeg,Functional model to support TSN in the SEAL layer
"The architecture for integration of the 5G with TSN is depicted in Figure 7.22.2-1. The SEAL NRM server acts as a TSN AF. Upon request from an FF Application layer server acting as a TSN CNC via the NRM-S reference point it configures the TSN flows in the 5GS. In this case the NRM-S supports the IEEE 802.1Qcc management protocol. As a TSN AF the SEAL NRM server interacts with the 5GS PCF over the N5 reference point to configure the 5G QoS and TSCAI parameters in the 5GS.
Figure 7.22.2-1: Functional model to support TSN in the SEAL layer
The architecture for the 5G-native TSC is depicted in Figure 7.22.2-2. The SEAL NRM server acts as an AF (referred to as TSC AF) towards the 5G Core Network and performs coordination of QoS flows to fulfill the end-to-end QoS requirements for the UEs involved in the TSC communication. When QoS monitoring is requested, the SEAL NRM server will also perform coordination of the QoS montoring subscriptions and notifications needed for the end-to-end QoS flows using the mechnisms of Solution #10. Upon request from an FF Application layer server via the NRM-S reference point it configures the TSC end-to-end QoS flows in the 5GS. In line with other SEAL service enablers the SEAL NRM server provides a RESTful interface on the NRM-S reference point. As a TSC AF the SEAL NRM server interacts with the 5GS PCF over the N5 reference point to configure the 5G QoS and TSCAI parameters in the 5GS. UE-TSC corresponds to UE-DS-TT in the TSN integration case, which also means that UE-TSC residence time is the same as UE-DS-TT residence time that is used for the end-to-end latency calculation.
NOTE: The NRM server uses procedures of the N5 reference point specified in Rel-16.
Figure 7.22.2-2: Functional model to support 5G-native TSC in the SEAL layer",TR 23.745,7.22.2,all_images/image_1677.jpeg,Functional model to support 5G-native TSC in the SEAL layer
"The following illustrate the states for the Multicast MBS session:
-	Configured state: Information about the Multicast MBS session (e.g. QoS information) is available in 5GC NFs (e.g. MB-SMF) serving the Multicast MBS session, but no User Plane resources towards NG-RAN are reserved and no MBS data can be transmitted. Only resources at MB-SMF, NEF and MB-UPF are reserved and no multicast data are transmitted. A TMGI can be allocated for the Multicast MBS session. UEs may be allowed to join (subject to authorization check and configuration), but the first accepted UE join request will trigger the Multicast MBS session establishment towards the NG-RAN and the UE, see clause 7.2.1.
NOTE 1:	The SMF is not involved in the Multicast MBS session while the Multicast MBS session is in configured state.
NOTE 2:	There may be several interim states in the configured state, e.g. TMGI requested, or information about the Multicast MBS session provided, but these interim states will not be specified in this release.
-	Active state: Multicast MBS session is established and MBS data can be transmitted to the UEs that have joined the Multicast MBS session. Radio resources for the Multicast MBS session are established. To receive multicast MBS session data, UEs that joined the Multicast MBS session shall be in CM-CONNECTED state for receiving data of the Multicast MBS session. UEs are allowed to join the Multicast MBS session (subject to authorization check). 5GC resources and radio resources for the Multicast MBS session are reserved for UEs that joined the Multicast MBS session.
-	Inactive state: Multicast MBS session is established but no MBS data is transmitted to the UEs that have joined the Multicast MBS session. Radio resources for the Multicast MBS session are released, and the UEs that joined the Multicast MBS session may be in CM-CONNECTED or CM-IDLE state. UEs are allowed to join the Multicast MBS session (subject to authorization check).
The following procedures are defined which result in transition of the Multicast MBS session state:
Multicast Session Creation: The AF provides information about the Multicast MBS session and optionally requests the allocation of a TMGI, see clause 7.1.1.2 and 7.1.1.3. Alternatively, the information about the Multicast MBS session can be pre-configured in the network. The creation may indicate whether the Multicast MBS session may be established in active or inactive state and when a Multicast MBS session can become active. The AF may perform creation in several steps, e.g. to first request TMGI and then provide full information about the Multicast MBS session and allow it to be established, or to update the information whether the Multicast MBS session is to be in Active or Inactive state after establishment. Multicast MBS session state transitions from ""Start (NULL)"" to Configured state.
NOTE 3:	A Multicast MBS session can also be created by the operator via OAM configuration or be established without prior creation.
-	Multicast Session Establishment: When the join request of the first UE for the Multicast MBS session is accepted, the Multicast MBS session is established towards the NG-RAN node and the UE, see clause 7.2.1. Multicast session state transitions from ""Start (NULL)"" or Configured state to either Inactive or Active state.
-	Multicast Session Activation: See clause 7.2.5.2, Triggered by the 5GC, the radio resources for the Multicast MBS session are established and Multicast MBS session data starts to be transmitted to the UE. UEs in CM-IDLE state and CM-CONNECTED with RRC Inactive state that joined the Multicast MBS session are notified. Activation can be triggered by AF request or data notification from the MB-UPF. Multicast session state transitions from Inactive state to Active state.
NOTE 4:	The AF could not be aware, and the NEF will not be aware, whether a session is in created or established state. An AF may therefore update the session state to request the activation of a session prior to the establishment of the session, and this will determine that the session is subsequently established in Active state when the first UE joins, but will not trigger the Multicast Session Activation state transition.
-	Multicast Session Deactivation: See clause 7.2.5.3. Triggered by the 5GC, the radio resources for the Multicast MBS session are released and Multicast MBS session data stops to be transmitted to the UE. Deactivation can be triggered by AF request or no reception of multicast data by the MB-UPF. Multicast session state transitions from Active to Inactive state.
-	Multicast Session Release: Triggered by the last UE leaving the Multicast MBS session (see clause 7.2.2.2), or Multicast Session Deletion procedure (7.1.1.4 or 7.1.1.5), the resources for the Multicast MBS session are released in both 5GC nodes and RAN nodes, see clause 7.2.2. Multicast session state transitions from Active or Inactive state to Configured.
-	Multicast Session Deletion: All information about the Multicast MBS session is removed from the 5GC, and the TMGI for the Multicast MBS session (if allocated during Multicast Session Configuration) is deallocated, see clause 7.1.1.4 or 7.1.1.5. The deletion may be triggered by an AF request. Multicast session state transitions from Configured, Active or Inactive state to ""End (NULL)"".
Figure 4.3-1: Multicast session states and state transitions
Figure 4.3-2: Multicast session states and state transitions in MB-SMF
Figure 4.3-3: Multicast session states and state transitions in NG-RAN
NOTE 5:	Multicast session states and state transitions in NG-RAN is for illustration purpose, normative procedures are provided by RAN WGs.
Figure 4.3-4: Multicast session states and state transitions in SMF",TS 23.247,4.3,all_images/image_1683.jpeg,Multicast session states and state transitions in MB-SMF
"Interworking between MBS and eMBMS at service layer functionality applies in cases where the same Multicast/Broadcast service is provided via eMBMS and MBS. Figure 5.2-1 depicts the system architecture for interworking between E-UTRAN/EPC eMBMS and MBS at service layer, with collocated BM-SC and MBSF/MBSTF functionalities.
Figure 5.2-1: MBS-eMBMS interworking system architecture at service layer
The BM-SC+MBSF/MBSTF exposes common Nmb5/Nmb10/xMB-C/MB2-C and Nmb8/xMB-U/MB2-U reference points to the NEF and/or AF/AS. A common TMGI is used towards the AF/AS. The TMGI is also used as identifier for transport over E-UTRAN/EPC. The MBSTF distributes the received data to the MB-UPF at reference point Nmb9 and/or the MBMS-GW at reference point SGi-mb, when supported by operator network configuration.
NOTE 1:	MB2-C/U and xMB-C/U are legacy reference points.
NOTE 2:	In the case of MBSTF providing MB2-C/U, it may be used for the GCS/AS only supporting GC1 and MB2 interfaces, as defined TS 23.468 [10].",TS 23.247,5.2,all_images/image_1685.jpeg,MBS-eMBMS interworking system architecture at service layer
"The MB-UPF acts as the MBS Session Anchor of an MBS session, and if the MBSTF is involved in the MBS session, then the MBSTF acts as the media anchor of the MBS traffic. The MB-UPF receives only one copy of MBS data packets from AF or MBSTF.
The user plane between MB-UPF and AF, may use either multicast transport or a unicast tunnel for the MBS session (depending on application and capabilities of control interface). If the transport network does not support multicast transport, the user plane uses a unicast tunnel for the MBS Session. The user plane between MBSTF and AF may use a unicast tunnel, multicast transport or other means (e.g. HTTP download from external CDN). The user plane between MBSTF and MB-UPF uses a unicast tunnel for the MBS session. If a unicast tunnel is used for the MBS Session between MB-UPF and AF or MBSTF, after receiving the downlink MBS data, the MB-UPF forwards the downlink MBS data without the received outer IP header and tunnel header information.
NOTE 1:	For location dependent MBS Session, the user plane towards the MB-UPF can only use unicast tunnel and content to be delivered to different areas are sent to MB-UPF via different tunnels.
The user plane from the MB-UPF to NG-RAN(s) (for 5GC Shared MBS traffic delivery) and the user plane from the MB-UPF to UPFs (for 5GC Individual MBS traffic delivery) may use multicast transport via a common GTP-U tunnel per MBS session, or use unicast transport via separate GTP-U tunnels at NG-RAN or at UPF per MBS session in the following way
-	For 5GC Shared MBS traffic delivery (i.e. MB-UPF delivers user plane data to NG-RAN supporting MBS), if the transport network supports IP multicast, the NG-RAN node uses multicast transport via a common GTP-U tunnel per MBS session, otherwise unicast transport via separate GTP-U tunnel per MBS session per NG-RAN node is used.
-	For 5GC Individual MBS traffic delivery (i.e. MB-UPF delivers user plane data to UPF), if the transport network supports IP multicast and the UPF supports reception of multicast data over N19mb, UPF use multicast transport via a common GTP-U tunnel per MBS session, otherwise unicast transport via separate GTP-U tunnel per MBS session per UPF is used.
If the user plane uses unicast transport, the transport layer destination is the IP address of the NG-RAN or UPF, each NG-RAN or UPF allocates the tunnel separately and multiple GTP-U tunnels are used for the MBS Session. If the user plane uses multicast transport, a common GTP-U tunnel is used for both RAN and UPF nodes. The GTP-U tunnel is identified by a common tunnel ID and an IP multicast address as the transport layer destination, both assigned by 5GC.
The above is depicted in Figure 6.7-1. There could be more than one NG-RANs or UPFs that are involved in the MBS traffic delivery.
Figure 6.7-1: Schematic showing user plane data transmission
The MB-SMF instructs the MB-UPF to receive packets related to an MBS session.
MB-UPF transmits the MBS data with the sequence number for each MBS QoS Flow as defined in TS 29.281 [23].
For shared delivery, if unicast transport over N3mb applies, the MB-SMF instructs MB-UPF to replicate the received MBS packets and forward them towards multiple RAN nodes via separate GTP tunnel. For shared delivery, if multicast transport over N3mb applies, the MB-SMF instructs the MB-UPF to replicate the received MBS data and forwards the data via a single GTP tunnel.
For individual delivery, the MBS data received by the MB-UPF is replicated towards the UPF(s) where individual delivery is performed in the following way:
-	The MB-SMF configures the MB-UPF to receive packets related to an MBS session, to replicate those packets and forward them towards multiple UPFs via GTP tunnels if unicast transport over N19mb is applied, or via a single GTP tunnel if multicast transport over N19mb is applied.
-	The SMF(s) instructs the UPF to receive packets related to a Multicast MBS session from an MB-UPF over N19mb, to replicate those packets and to forward them in multiple PDU sessions.
For the MB-SMF and MB-UPF, packet detection, replication and forwarding for an MBS session is realized by using for each MBS session one PDR that detects the incoming MBS packets and points to one FAR that describes the forwarding of the data towards multiple destinations (UPFs or RAN nodes):
-	A PFCP session is created when the MBS Session is started, regardless of multicast or unicast transport over N3mb and N19mb.
-	For Multicast transport over N3mb and N19mb, the destination in the FAR contains the MB-UPF IP Multicast Distribution Info.
-	For unicast transport over N3mb and N19mb, the FAR in the PFCP session may contain multiple destinations represented by the NG-RAN N3mb Tunnel Info and UPF N19mb Tunnel Info (if applicable).
For the SMF and the UPF (for 5GC individual delivery), packet detection, replication and forwarding for an MBS session is realized by PDR and FAR of the PDU session in which the UE has joined the MBS session:
-	The SMF instructs the UPF to associate the PFCP session of the PDU session with an MBS session.
-	A new PDR with Source Interface ""Core"" is used to detect MBS data from N19mb.
NOTE 2:	This PDR is also containing the MBS Session ID to enable a single detection of the incoming MBS data for multiple PDU sessions at the UPF.
-	For unicast transport over N19mb, the SMF requests UPF to allocate N19mb Tunnel Info if not allocated.
-	For multicast transport over N19mb, the SMF includes the low layer source specific multicast address information and C-TEID to UPF.
-	If the SMF wants to maintain the MBS data reception over N19mb but suspends the delivery of the data to the UE's PDU session, the Action of FAR set to ""drop"" (e.g. when the UE is switching from 5GC Individual delivery to 5GC Shared delivery due to the UE moving from MBS non-supporting NG-RAN to MBS supporting NG-RAN). Otherwise the SMF remove the related PDR and FAR.
See TS 29.244 [17] for the details of user plane handling.",TS 23.247,6.7,all_images/image_1686.jpeg,Schematic showing user plane data transmission
"The following steps are executed before the UE requests to join the MBS session:
-	The MBS Session may have been created in the 5GC (see clause 7.1.1 for details).
-	The UE registers in the PLMN or SNPN and may have established a PDU session that can be associated with multicast session(s).
-	The UE has known at least the MBS Session ID of a multicast group that the UE can join, e.g. via service announcement.
Figure 7.2.1.3-1: PDU Session modification for UE joining Multicast MBS session
1.	To join a multicast group:
-	if there is an existing PDU session that can be used to send the UE join request for the multicast MBS Session, the UE sends a PDU Session Modification Request over that PDU session (i.e. associated PDU Session) which additionally contains one or several MBS Session ID(s) and join request. The MBS Session ID(s) indicate the multicast MBS session(s) that UE wants to join.
-	if the UE has no appropriate PDU session established with the DNN and S-NSSAI for the multicast MBS session, the UE joins the multicast MBS session by sending PDU Session Establishment Request for associated PDU session together with one or several MBS Session ID(s) and join request. In that case, before step 2, the network proceeds with establishment of the associated PDU session executing steps 4 to 10 of PDU Session Establishment procedure as specified in TS 23.502 [6] clause 4.3.2.2.
2.	[Conditional] Based on the received MBS Session ID and join request, the SMF determines this is MBS Session join request.
If SMF has no information about MBS Session Context for the indicated MBS Session ID(s), SMF discovers and selects an MB-SMF for the MBS Session via the NRF as described in clause 7.1.2. If no MB-SMF is assigned for the MBS Session ID (i.e. the NRF provides empty MB-SMF profile), the SMF may select an MB-SMF and request it to configure the multicast MBS session or the SMF may reject the join request and respond to the UE with an appropriate cause value.
NOTE 1:	Details about how the SMF selects an MB-SMF and requests it to configure the multicast MBS session are left to SMF implementation.
3.	[Conditional] For each MBS session in step 1, if the SMF has not subscribed to the MBS Session Context, it invokes Nmbsmf_MBSSession_ContextStatusSubscribe request (MBS Session ID) towards the MB-SMF to subscribe to events notifications related to the multicast MBS session and to request information about the MBS Session Context. The MB-SMF responds with the information about the indicated multicast MBS session in Nmbsmf_MBSSession_ContextStatusSubscribe response (multicast QoS flow information (e.g. QoS profile(s) for the multicast MBS session), [start time], [session state (Active/Inactive)], [Any UE indication], [multicast DL tunnel info], [multicast session security context]).
If it is the first time for the MB-SMF to receive Nmbsmf_MBSSession_ContextStatusSubscribe request of the indicated MBS Session from any SMF, the MB-SMF learns it is the first UE joining the multicast MBS session. For multicast transport between MB-UPF and content provider, if it is the first UE joining the multicast MBS session, and MB-UPF has not joined the multicast tree in the MBS session creation procedure, described in clause 7.1.1, the MB-SMF requests the MB-UPF to join the multicast tree towards the AF/MBSF, otherwise MB-SMF will not send the request to the MB-UPF.
NOTE 2:	The MB-SMF can answer the Nmbsmf_MBSSession_ContextStatusSubscribe request either based on information received in the MBS session creation procedures in clause 7.1.1 or based on preconfigured information. The pre-configuration also includes information about the MBS session stored in the NRF. If the MB-SMF uses preconfigured information, the pre-configuration also includes MB-UPF configuration.
4.	The SMF determines whether the user is authorized to join the Multicast MBS session taking into account the MBS subscription data received from the UDM and the Any UE indication if received from the MB-SMF. The SMF considers the UE as authorized to the Multicast MBS session if the UE is authorized to use multicast MBS services, and if the MBS Session ID(s) in the PDU Session Modification Request is included in the MBS subscription data or Any UE indication is received. If authorization check fails, the SMF rejects the join request with a cause value. If a UE joins prior to the start time of the multicast MBS session, the SMF may accept the join request and indicate to the UE the start time, or it may reject the join request with an appropriate error cause and optionally a back-off timer. If a UE joins while the multicast MBS session is inactive, the SMF accepts the join request.
5.	If the join request is accepted, the SMF responds to the AMF through Nsmf_PDUSession_UpdateSMContext response (N2 SM information (PDU Session ID, MBS Session ID, [updated PDU Session information], [mapping information between unicast QoS flow(s) and multicast QoS flow (s)]), N1 SM container (PDU Session Modification Command, [multicast session security context])) to:
-	create an MBS Session Context for the indicated MBS session in the RAN, if it does not exist in the RAN already; and
-	inform the NG-RAN about the relation between the Multicast MBS Session Context and the UE's PDU Session context by including the MBS Session ID and the mapping between the multicast QoS flow(s) and associated QoS flow(s).
Based on operator policy, the SMF may prepare for 5GC Individual MBS traffic delivery fall-back. The SMF maps the received QoS information of the multicast QoS Flow into PDU Session's unicast QoS Flow information, and includes the information of the QoS Flows and the mapping information about the QoS Flows (termed ""associated QoS flow information"") in the SM information sent to RAN. The SMF compares the QFIs of the multicast QoS Flows received from the MB-SMF with QFIs in use for the PDU Session and assigns unused QFIs to the PDU Session's unicast QoS Flows corresponding to multicast QoS Flows.
NOTE 3:	Detailed information included in N2 SM information will be aligned with by RAN WG3.
NOTE 4:	The SMF uses the same QoS in the received MBS QoS Flow QoS information for the associated QoS Flow in the unicast PDU session.
If the MBS session join procedure was triggered by the UE together with PDU Session Establishment procedure for the associated PDU session, the SMF provides the N2 SM information and N1 SM container for the associated PDU session in Namf_Communication_N1N2MessageTransfer service operation towards the AMF, as described in step 11 of clause 4.3.2.2.1 in TS 23.502 [6]. The N2 SM information also includes the MBS Session ID and, if 5GC individual MBS traffic delivery fall-back is supported, the mapping information between unicast QoS flow(s) and multicast QoS flow(s).
If the join request is rejected, the SMF responds to the AMF through Nsmf_PDUSession_UpdateSMContext response (N1 SM container (PDU Session Modification Reject)) and the message will not contain any MBS Session Context or the N2 SM information for the associated PDU session. The PDU Session Modification Reject message is forwarded to the UE via the NG-RAN, and the following steps are skipped.
6.	The N2 message, which includes the MBS Session ID(s) the UE has joined and, if applicable, associated QoS Flow, is sent to the NG-RAN.
If the MBS is supported by NG-RAN, 5GC Shared MBS traffic delivery is adopted. If the MBS is not supported by NG-RAN, 5GC Individual MBS traffic delivery is used if the PDU Session's unicast QoS Flow include QoS Flows for the multicast session.
If the NG-RAN supports MBS, the NG-RAN uses the MBS Session ID to determine that the PDU Session identified by the PDU Session ID is associated with the indicated multicast MBS session.
If the NG-RAN supports MBS, the associated unicast QoS flow information, if provided, is not used to allocate the radio resource and CN resource for corresponding QoS flows.
NOTE 6:	UE join request via PDU Session signalling will fail if NG-RAN rejects the PDU Session Resource setup request (e.g. due to the number of UEs reaching a limit).
7.	[Conditional] If shared tunnel has not been established for the multicast MBS session towards the NG-RAN node, the procedures in clause 7.2.1.4 for the establishment of shared delivery toward NG-RAN node are executed. This step is executed separately for each multicast MBS session.
7a.	If the MBS Session is active, the NG-RAN configures radio resources for MBS session.
8.	If the MBS Session is active, the NG-RAN node performs AN specific signalling exchange with the UE to configure the UE with radio resources for the multicast MBS session. If the NG-RAN does not support MBS and the MBS Session is active, radio resources are reconfigured for unicast transmission of the MBS data over the associated PDU session. As part of the AN specific signalling exchange, the N1 SM container (PDU Session Modification Command) is provided to the UE.
9.	The NG-RAN node sends the PDU session modification response.
If the MBS is not supported by NG-RAN, the accepted unicast QoS flow is included in the N2 SM information. If the MBS is supported by NG-RAN, the N2 SM information further includes the indication of supporting MBS.
10.	The AMF invokes Nsmf_PDUSession_UpdateSMContext request ([N2 SM information]) to the SMF.
Per the indication of whether the NG-RAN supports MBS, the SMF determines whether 5GC Individual MBS traffic delivery is used for multicast data transmission.
NOTE 8:	If the shared tunnel is used, no interaction with UPF is needed for the indicated multicast MBS session
[Conditional] This step is used for 5GC Individual MBS traffic delivery, if the related NG-RAN does not support MBS. If a shared tunnel between the UPF (PSA) and MB-UPF for 5GC Individual MBS traffic delivery has not yet been established by the SMF for the multicast MBS session, steps 11a to 11d are executed. Step 11e is executed irrespective of that.
11a.	The SMF contacts the UPF to request the creation of a tunnel and provides the MBS Session ID. The UPF indicates to the SMF whether the tunnel for this multicast MBS session is newly allocated (as there can be multiple SMFs interacting with the same UPF for the same multicast MBS Session).
If the UPF determines to use unicast transport over N19mb, the UPF allocates a DL N19mb Tunnel endpoint for the multicast MBS session if the SMF request is the first one to allocate DL N19mb Tunnel endpoint for the multicast MBS Session in the UPF. The UPF includes the DL Tunnel Info in the response to the SMF. The DL tunnel info includes the downlink tunnel ID and the UPF address.
If the UPF determines to use multicast transport over N19mb, the UPF joins the multicast distribution if the SMF request is the first one for the MBS Session in the UPF. Steps 11b to 11d are skipped.
11b.	If the UPF indicates the DL N19mb Tunnel is newly allocated, the SMF invokes Nmbsmf_MBSSession_ContextUpdate request (MBS Session ID, [DL tunnel info]) towards the MB-SMF for establishing the multicast MBS session transport between MB-UPF and UPF.
11c.	If the DL tunnel info of the UPF is received, the MB-SMF configures the MB-UPF to transmit the multicast MBS session data towards UPF using the possibly received downlink tunnel ID.
11d.	The MB-SMF responds to the SMF through Nmbsmf_MBSSession_ContextUpdate response (MBS Session ID, [multicast DL tunnel info]). If the UPF DL tunnel info for unicast transport is not received by the MB-SMF, multicast transport between MB-UPF and UPF is to be used, and the MB-SMF includes the downlink tunnel information with the low layer transport multicast address for the multicast MBS session.
11e.	The SMF configures the UPF to forward the received multicast MBS session data within the PDU session. (This step may be combined with step 11a).
12.	The SMF responds to the AMF with Nsmf_PDUSession_UpdateSMContext response message.
13.	The MB-UPF receives multicast PDUs, either directly from the content provider or via the MBSTF that can manipulate the data.
Steps 14 to 16 are for 5GC Shared MBS traffic delivery:
14.	The MB-UPF sends multicast PDUs in the N3mb tunnel associated to the multicast MBS session to the NG-RAN. There is only one tunnel per multicast MBS session per MBS service area and NG-RAN node, i.e. all the UEs which have joined the multicast MBS session via the NG-RAN node share this tunnel for reception of the multicast MBS session data.
15.	Void.
16.	The NG-RAN transmits the multicast MBS session data to the UE(s) via the MBS Radio Bearer using either PTP or PTM transmission.
Steps 17 to 19 are for 5GC Individual MBS traffic delivery:
17.	The MB-UPF sends multicast PDUs in the N19mb tunnel associated to the multicast MBS session to the UPF. There is only one tunnel per multicast MBS session and destination UPF, i.e. all associated PDU sessions served by the destination UPF share this tunnel.
18.	The UPF forwards the multicast data towards the NG-RAN via unicast (i.e. in the N3 tunnel of the associated PDU Session).
19.	The NG-RAN forwards the multicast MBS session data to the UE via unicast (i.e. over the radio bearer(s) corresponding to the associated QoS flow(s) of the associated PDU Session).
NOTE 9:	Details of the DL MBS data transmission are described in clause 6.7.
NOTE 10:	When the MBSF is involved in the multicast MBS session, the tunnel between MBSTF and MB-UPF has been established in the MBS session creation procedure.",TS 23.247,7.2.1.3,all_images/image_1692.png,PDU Session modification for UE joining Multicast MBS session
"In the following cases, the shared tunnel for shared delivery is established between the NG-RAN and MB-UPF:
-	The first UE is included in the context of the MBS session in the NG-RAN.
NOTE 1:	When the multicast MBS session is inactive, if there is at least one UE joining the multicast MBS session is in RRC-CONNECTED state in the NG-RAN, the shared delivery is not released.
NOTE 2:	Share delivery establishment procedures are used when MBS supporting NG-RAN node(s) get involved in the multicast MBS session regardless of the state of the multicast MBS session.
-	Handover to the target NG-RAN when the shared delivery tunnel is not established in the target RAN node for this multicast MBS session.
Figure 7.2.1.4-1: Establishment of shared delivery toward NG-RAN node
1.	A NG-RAN node decides to establish shared delivery for a multicast MBS session when it serves at least one UE within the multicast MBS session. For location dependent services, the NG-RAN node needs to establish shared delivery for the location dependent contents of a multicast MBS session if it serves at least one UE assigned to an MBS Session ID and Area Session ID.
2.	The NG-RAN sends an N2 MBS Session request message (MBS Session ID, [Area Session ID], N2 SM information ([unicast DL tunnel Info])) towards the AMF.
If the NG-RAN node is configured to use unicast transport for the shared delivery, it allocates a GTP tunnel endpoint and provides the unicast DL tunnel Info in the request, which includes the GTP tunnel endpoint and NG-RAN node address. For location dependent MBS services, the NG-RAN node also provides the Area Session ID.
3.	The AMF selects the MB-SMF serving the multicast MBS session, e.g. using the NRF discovery service or locally stored information. It invokes Nmbsmf_MBSSession_ContextUpdate request (MBS Session ID, [Area Session ID], N2 SM information, NG-RAN Node ID) to the MB-SMF.
The AMF stores the information of the NG-RAN nodes (e.g. NG-RAN Node ID) for the subsequent signaling related to the multicast MBS Session.
4.	[Conditional] If the MB-SMF receives the unicast DL tunnel Info in step 3 in a deployment where NG-RAN nodes share a common user plane entity, the MB-SMF only establishes the shared tunnel towards the DL GTP tunnel endpoint if the shared tunnel has not yet been established (as determined based on the stored DL GTP Tunnel endpoint(s) for the MBS session). The MB-SMF also stores the received DL GTP Tunnel and corresponding NG-RAN Node ID for the MBS session.
To establish the shared tunnel towards the DL GTP tunnel endpoint, the MB-SMF configures the MB-UPF to send multicast data for the multicast MBS session (or location dependent content of the multicast MBS session if an Area Session ID was received) towards that GTP tunnel endpoint via unicast transport.
5.	The MB-SMF stores the information of the AMF (e.g. AMF ID) in the MBS Multicast MBS session context (or location dependent part of the Multicast MBS Session Context if an Area Session ID was received) to enable subsequent signalling towards that AMF.
6.	The MB-SMF sends Nmbsmf_MBSSession_ContextUpdate response (MBS Session ID, [Area Session ID], N2 SM information ([TMGI], multicast QoS flow information, session state (Active/Inactive), [multicast DL tunnel Info], [MBS service areas])) to the AMF. If the MB-SMF did not receive unicast DL tunnel Info in step 3, it provides the multicast DL tunnel info that includes transport multicast address (e.g. a LL SSM) and a GTP tunnel endpoint for multicast transport of the shared delivery.
7.	The AMF sends an N2 MBS Session response message (MBS Session ID, [Area Session ID], N2 SM information) to the NG-RAN node. If the NG-RAN node receives the multicast DL tunnel Info of the shared delivery, it uses the transport multicast address included in the multicast DL tunnel info to join the multicast transport distribution.",TS 23.247,7.2.1.4,all_images/image_1693.png,Establishment of shared delivery toward NG-RAN node
"When the UE determines to leave the Multicast MBS session, it shall send PDU session Modification request to inform the 5GC the leaving operation. The Figure 7.2.2.2-1 describes the procedure.
Figure 7.2.2.2-1: UE initiated Multicast MBS Session leave
1.	The UE sends the PDU Session Modification Request when the UE determine to leave the multicast MBS Session. The PDU Session Modification Request carries leave indication and the MBS Session ID which the UE want to leave.
2.	The AMF invokes Nsmf_PDUSession_UpdateSMContext (N1 SM container (PDU Session Modification Request)) to the SMF.
3a.	[Conditional] If 5GC individual MBS traffic delivery is applied towards the UE, the SMF sends an N4 Session Modification Request to the UPF (PSA). The SMF reconfigures the UPF to terminate the distribution of multicast data via the PDU session.
3b.	[Conditional] The UPF (PSA) sends an N4 Session Modification Response to the SMF.
If there are no PDU sessions to transmit the multicast MBS session data in the UPF, and unicast transport is used over N19mb, the UPF releases the DL N19mb tunnel endpoint and informs the SMF.
If there are no PDU sessions to transmit the multicast MBS session data in the UPF, and multicast transport is used over N19mb, the UPF leaves the multicast distribution tree of MB-UPF.
4.	[Conditional] If the UPF indicates the tunnel release (i.e. unicast transport was used), the SMF invokes Nmbsmf_MBSSession_ContextUpdate Request (Release, MBS Session ID, tunnel information) to release the tunnel between UPF and MB-UPF for this multicast MBS session. The MB-SMF determines whether the context update is for tunnel release or create based on whether the tunnel information exists in the multicast MBS Session Context stored in the MB-SMF or not.
5.	[Conditional] If the MB-SMF determines the context update is for tunnel release, the MB-SMF request to MB-UPF to release the tunnel between UPF and MB-UPF for the multicast MBS session.
6.	[Conditional] The MB-SMF responds to the SMF for step 4.
7.	The SMF invokes the Nsmf_PDUSession_UpdateSMContext Response (PDU Session ID, N2 SM information ([MBS Session ID], [leave indication]), N1 SM container) service operation. In the N2 SM information, the MBS Session ID and the leave indication are included for informing the NG-RAN to remove the UE from this MBS session if 5GC Shared MBS traffic delivery method is used towards the UE. If 5GC Individual MBS traffic delivery method is used towards the UE, the N2 SM information does not include MBS related information.
In the N2 SM information, the SMF also informs the NG-RAN to release the associated QoS Flow(s), which carry or intend to carry the multicast MBS session traffic for 5GC individual MBS traffic delivery.
The associated QoS Flow(s) are released as defined in TS 23.502 [6] clause 4.3.3.2.
8.	The AMF send N2 message (N2 SM information, N1 SM container) to the NG-RAN
9.	The NG-RAN node performs the necessary AN-specific resource modification procedure toward the UE and transports the N1 SM container received in step 7 to the UE.
10.	The NG-RAN node removes the UE from this multicast MBS session and sends a N2 message to the AMF.
11.	The AMF transfers the N2 message received in step 9 to the SMF via the Nsmf_PDUSession_UpdateSMContext service operation.
The SMF updates the associated PDU session context, e.g. remove the MBS Session ID from the associated PDU session context. In addition, if associated QoS flow is used for the multicast MBS session, the SMF also removes the associated QoS flow information associated with the indicated multicast MBS session from the associated PDU session context.
12.	[Conditional] If the UE is the last joined one of the multicast MBS session in the SMF, The SMF also indicates that the last UE served by the SMF leaves the Multicast MBS Session, the SMF unsubscribes the notifications of the MBS Session Context status updates from the MB-SMF by invoking Nmbsmf_MBSSession_ContextStatusUnsubscribe service operation. The MB-SMF will no longer notify the SMF of the further context status updates of the multicast MBS session (e.g. activation, deactivation, update, release, etc.). For multicast transport between MB-UPF and content provider, if the SMF is the last remaining SMF that is subscribed for the MBS Session notification from the MB-SMF, i.e. if it is the last UE leaving the MBS session, the MB-SMF requests the MB-UPF to stop forwarding the multicast MBS session data and may request the MB-UPF to leave the multicast tree towards the AF/MBSF, if the MB-UPF joins the multicast tree when the first UE joins the MBS session.
13.	[Conditional] If the UE is the last UE in this RAN node for this multicast MBS session, the NG-RAN release shared delivery between NG-RAN and MB-UPF as described in clause 7.2.2.4.
If release of the PDU Session associated with a multicast MBS session is triggered, corresponding procedures between UE, NG-RAN, AMF, and SMF are performed as described in clause 4.3.4 of TS 23.502 [6], and SMF triggers the UE leave the multicast MBS session by performing steps 3-6 in Figure 7.2.2.2-1 for each multicast MBS session(s) associated with the PDU Session, and UE considers as left all the multicast MBS sessions associated with the PDU Session.
NOTE:	If the associated PDU Session is released, the UE leaves MBS Session(s) associated with that PDU session implicitly. To resume the reception of the related MBS service(s), the UE needs to initiate the procedures as defined in clause 7.2.1 to re-join the MBS Session(s).
If the UE deregistration procedure is executed, corresponding procedures between UE, NG-RAN, AMF, and SMF are performed as described in clause 4.2.2.3 of TS 23.502 [6], and SMF performs steps 3-6 in Figure 7.2.2.2-1 for all multicast MBS sessions joined by the UE. When the PDU Session Release procedure or UE deregistration procedure is executed, according to the UE context, NG-RAN performs step 12 for each multicast MBS session associated with the released PDU Session(s).",TS 23.247,7.2.2.2,all_images/image_1694.jpeg,UE initiated Multicast MBS Session leave
"This procedure applies to the following scenarios:
1.	When the MB-SMF decides to release an MBS Session:
-	based on a request from the AF (directly or via the NEF/MBSF);
In this scenario, the MB-SMF notifies the SMF of multicast session release, and the SMF initiates procedures to remove all joined UEs from the MBS session.
2.	When the SMF decides to remove a UE from an MBS session:
-	based on a request from the UDM (subscription change); or
-	due to local and location dependent MBS service is described in clause 7.2.4; or
-	due to network internal reasons.
For the active MBS session, to release radio resources as early as possible, the MB-SMF may trigger Multicast Session Deactivation towards the NG-RAN as specified in steps 5-9 of clause 7.2.5.3, prior to or in parallel with triggering MBS Session Release to the SMF.
Figure 7.2.2.3-1: MBS Session Release or Multicast session leave requested by the network
1a.	For MB-SMF triggered MBS session release, the SMF receives Nmbsmf_MBSSession_ContextStatusNotify (MBS Session ID, multicast session release) from the MB-SMF with MBS Session ID. The SMF checks all joined UEs and perform step 2 to step 9 for each UE.
1b.	The SMF decides to remove a UE from the MBS session without MBS session release (e.g. due to UE moving out of MBS service area for local or location dependent MBS service as described in clause 7.2.4).
2.	For UEs without activated UP, the SMF may perform the same procedure as defined in step 3-7 in clause 7.2.5.2.
Alternatively, for UEs without activated UP, the SMF does not trigger message to the AMF, instead the SMF marks that the UE is to be informed of the MBS Session release. In this case, the SMF initiates PDU Session Modification to inform the UE of the MBS Session release at next UP activation of the associated PDU Session, if needed.
3.	For the joined UEs with UP activated, the SMF invokes Namf_Communicate_N1N2MessageTransfer to the AMF. The N1 SM container indicates UE removed from MBS session with appropriate cause (e.g. MBS session release, out of MBS service area, etc.). In N2 SM information, the SMF informs the NG-RAN to remove the UE from the MBS session. If there are associated QoS Flow(s) for individual delivery, the SMF also releases those QoS Flow(s) as specified in TS 23.502 [6] clause 4.3.3.2.
4.	The AMF sends N2 Request to the NG-RAN.
5.	The NG-RAN transports the N1 SM container (PDU Session Modification Command (MBS Session ID, UE removed from MBS session with appropriate cause)) to the UE.
6.	The NG-RAN performs radio resource modification. If there are no joined UEs in the MBS session, the NG-RAN releases the radio resources.
7.	If there are no joined UEs in the MBS session, for unicast transport of N3mb, the NG-RAN initiates the DL tunnel release towards MB-UPF via AMF and MB-SMF. For multicast transportation of N3mb, the NG-RAN performs IGMP/MLD Leave for the MBS session. See clause 7.2.2.4 for details.
8.	The NG-RAN sends N2 Response to the AMF. If there are no joined UEs in the MBS session, the MBS Session Context is removed from the NG-RAN.
9.	The AMF transfers the N2 message received in step 8 to the SMF via the Nsmf_PDUSession_UpdateSMContext service operation. The SMF removes the UE from the MBS Session.",TS 23.247,7.2.2.3,all_images/image_1695.jpeg,MBS Session Release or Multicast session leave requested by the network
"This clause describes an Xn based handover with MBS traffic delivered to the UE at the source NG-RAN node supporting MBS.
Figure 7.2.3.2-1: Xn based handover with MBS Session
The following additions apply compared to clause 4.9.1.2 of TS 23.502 [6]:
Before Handover:
The source NG RAN has been provided with MBS Session Resource information (including the MBS Session ID and multicast QoS flow information) and the UE Context information contains a mapping information within the PDU Session Resource associated with the MBS Session Resource, e.g. including mapped unicast QoS Flows associated with the multicast QoS flow(s) of the MBS Session Resource.
Handover Preparation Phase:
At Xn handover, the target NG-RAN is provided with MBS session information by the source NG-RAN which causes:
-	an MBS non-supporting target NG-RAN node to prepare the unicast resources according to associated QoS flow(s) information.
‐	an MBS supporting target NG-RAN node to allocate to the UE shared NG-RAN resources according to the MBS session information. If the 5GC Shared MBS traffic delivery for the indicated multicast MBS Session has not been established in target NG-RAN, target NG-RAN triggers setup of the resources for the 5GC Shared MBS traffic delivery, see clause 7.2.1.4 for details.
1.	Target NG-RAN to AMF: the target NG-RAN sends N2 Path Switch Request to AMF.
The target NG-RAN node, if MBS-capable, indicates it supports of MBS to SMF in N2 SM information. Per the received N2 SM information, the SMF knows whether the target NG-RAN node supports MBS and determines the delivery method, i.e. whether the 5GC Shared MBS traffic delivery or 5GC Individual MBS traffic delivery is used for MBS data transferring.
The SMF differentiates two cases:
Case A) The target NG-RAN supports MBS. Step 3 applies and step 4 is skipped.
3.	SMF to UPF: The SMF invokes N4 Session Modification procedure with the UPF (PSA) only for unicast PDU Session.
Case B) The target NG-RAN does not support MBS. Step 3 is skipped, step 4 applies.
4.	This steps is same as described in step 11 of clause 7.2.1.3.
The details of how to perform data forwarding refers to clause 7.2.3.5.
5.	SMF to AMF: The SMF responds to AMF through Nsmf_PDUSession_UpdateSMContext response.
6.	AMF to target NG-RAN: The AMF sends the path switch Ack to target NG-RAN.",TS 23.247,7.2.3.2,all_images/image_1696.jpeg,Xn based handover with MBS Session
"This clause describes the N2 based handover with MBS traffic delivered to the UE at the source NG-RAN node supporting MBS.
Figure 7.2.3.3-1: N2 based handover with MBS Session
The following additions apply compared to clause 4.9.1.3 of TS 23.502 [6]):
1.	Source NG-RAN to S-AMF: Handover Required (RAN container (MBS Session information, associated PDU session information, [associated QoS flow information and corresponding multicast QoS flow information])).
2.	[Conditional] S-AMF to T-AMF: The T-AMF is provided with associated PDU Session information and the MBS session related information.
3.	T-AMF and SMF(s): T-AMF interacts with SMF via Nsmf_PDUSession_UpdateSMContext request/response. In the response sent by SMF, multicast MBS session related information (i.e. MBS session ID and optionally the mapping between the multicast QoS flow(s) and associated QoS flow(s)), is included in the N2 SM information.
4.	T-AMF to Target NG-RAN: The Target NG-RAN prepares the radio resource based on the received information:
-	If the Target NG-RAN does not support MBS, the MBS Session related information is not used. The Target NG-RAN uses the associated PDU Session information to allocate resource to deliver MBS data. The MBS data are transmitted via the associated QoS flows within the associated PDU Session.
-	If the Target NG-RAN supports MBS, the Target NG-RAN uses the multicast MBS Session related information to allocate RAN resources to deliver the MBS data. If 5GC Shared MBS traffic delivery for the indicated multicast MBS session has not been established towards the Target NG-RAN, the Target NG-RAN initiates the shared delivery establishment towards the MB-SMF via AMF as described in clause 7.2.1.4.
5.	Target NG-RAN to T-AMF: The target NG-RAN sends Handover Request Ack to T-AMF.
The target NG-RAN node, if MBS-capable, indicates it supports MBS to SMF in N2 SM information. Per the received N2 SM information, the SMF knows whether the target NG-RAN node supports MBS and determines the delivery method, i.e. whether the 5GC Shared MBS traffic delivery or 5GC Individual MBS traffic delivery is used for MBS data transferring.
12.	T-AMF to SMF: The AMF invokes Nsmf_PDUSession_UpdateSMContext request towards SMF, the message includes the received N2 SM information received from the target NG-RAN.
13-14.	Same as described in steps 3-4 of clause 7.2.3.2.
The details of how to perform data forwarding, refers to clause 7.2.3.5.
15.	SMF to T-AMF: The SMF sends the Nsmf_PDUSession_UpdateSMContext Response to the T-AMF.",TS 23.247,7.2.3.3,all_images/image_1697.png,N2 based handover with MBS Session
"The MBS Session Delivery Status Indication for broadcast is used by the MB-SMF to notify the AF/AS of conditions affecting the delivery of the MBS session (e.g. MBS session created, MBS session terminated, etc.). The occurrence of the indicated condition may have been detected at the MB-SMF or may have been reported to the MB-SMF by other entities involved in the MBS session delivery.
Figure 7.3.5-1: MBS Session Delivery Status Indication for Broadcast
1.	The external AF subscribes event for delivery status towards the NEF, and the NEF subscribes corresponding event towards the MB-SMF (step 1a), or the legacy AS request status report towards the MBSF, and the MBSF subscribes event for delivery status towards the MB-SMF (step 1b), or the internal AF subscribes event for delivery status towards the MB-SMF (step 1c).
2.	The MB-SMF notifies the TMGI and the event towards the NEF, and the NEF notifies the TMGI and corresponding event towards the external AF (step 2a), or the MB-SMF notifies the TMGI and the event towards the MBSF, and the MBSF sends Delivery Status Indication to legacy AS with the TMGI and the corresponding event (step 2b), or the MB-SMF notifies the TMGI and the event towards the internal AF (step 2c).
For the ""MBS session started"" event, after the MB-SMF contacts AMFs to request the establishment of the Broadcast MBS session, the MB-SMF may wait until it has received a Namf_MBSBroadcast_ContextCreate Response or Namf_MBSBroadcast_ContextStatusNotify with the indication of the completion of the operation from each AMF (see clause 7.3.1) before determining that the Broadcast MBS session has been started.",TS 23.247,7.3.5,all_images/image_1703.png,MBS Session Delivery Status Indication for Broadcast
"Figure 6.1.2-1 illustrates an example operation of the solution for QoS aware power efficient PC5 communication for Pedestrian UEs.
Figure 6.1.2-1: QoS aware power efficient PC5 communication procedure for Pedestrian UEs
1.	On UE-1, the V2X Application 1 provides the V2X Application Requirements, including delay requirements, etc., for the PC5 communication, as specified in TS 23.287 [5], clause 5.4.1.1. For example, this Application 1 may be requesting a groupcast communication.
2.	Similarly, V2X Application 2 provides the V2X Application Requirements including delay requirements, traffic pattern information if available, for the PC5 communication. In this example, the Application 2 may be requesting a unicast communication.
3.	UE-1's V2X layer consolidates requirements from Application 1 and Application 2, and generates a UE level DRX schedule, so that the UE-1 would be able to maximize the DRX off-duration. The determination of the DRX schedule can be determined by the UE based on the configuration on the UE, for example as part of the V2X policies associated with the V2X service types.
4.	UE-1's V2X layer requests the UE level AS layer DRX schedule to AS layer.
5.	UE-1's AS layer applies the DRX schedule for the corresponding V2X communication. This may require some adjustment according to the AS layer configurations, e.g. the resources pool settings.
6.	UE-1's AS layer provides a response to the V2X layer on the results of the DRX schedule enforcement at AS layer.
7.	UE-1's V2X layer may further request an AS layer DRX schedule corresponds to Application 2's unicast communication and provides it to AS layer.
Editor's note:	The interactions between the V2X layer and AS layer regarding the DRX schedule requests need coordination with RAN WGs.
8.	UE-1 initiates PC5-S and/or PC5-RRC signalling towards UE-2 that is relevant for the Application 2's unicast communication, and then negotiates and confirms the DRX schedule. If there is no existing L2 link with the UE-2, this step also comprises the establishment of the L2 link.
Editor's note:	It is FFS if PC5-S or PC5-RRC signalling should be used for the DRX negotiation between UE-1 and UE-2 for the unicast DRX configuration.
9.	The negotiation results of the DRX schedule for the L2 Link is provided to the V2X layer.
10.	UE-1's V2X layer may expose transmission schedule information to Application 3, based on the UE level DRX schedule. Application 3 will determine its traffic generation schedule accordingly.
Application 3 may also send QoS requirements and traffic pattern information if available for the PC5 communication to V2X layer to generate new DRX schedule if the old one cannot satisfy the Application 3 requirements.
11.	[Optional] UE-1 determines if the PC5 DRX and Uu DRX need alignment.
If the alignment is necessary and UE-1 has active connection to NG-RAN over Uu (in RRC_CONNECTED state), V2X layer triggers RRC signalling towards NG-RAN, so step 10 is performed.
If the alignment is necessary between the PC5 DRX and Uu DRX (i.e. Paging DRX) and UE-1 is in RRC_IDLE state or RRC_INACTIVE state, UE-1 waits until Uu connection is established before initiating any alignment.
12.	[Optional] UE-1 sends RRC signalling over Uu interface towards NG-RAN informing the PC5 DRX setting.
Editor's note:	The Uu RRC singling for this DRX alignment is up to RAN WG to decide.
Editor's note:	Whether and how to align the PC5 DRX and the Uu DRX needs coordination with RAN WGs.",TR 23.776,6.1.2,all_images/image_1705.jpeg,QoS aware power efficient PC5 communication procedure for Pedestrian UEs
"Figure 6.2.2-1 illustrates an example operation of the solution for power efficient PC5 communication for Pedestrian UEs based on pre-defined PC5 DRX patterns.
Figure 6.2.2-1: PC5 DRX configuration procedure for QoS-aware and power-efficient communication of Pedestrian UEs
1a.	UEs are (pre-)configured with the PC5 DRX related parameters including a set of applicable PC5 DRX patterns from which UEs can select. The PC5 DRX configuration may be either provided by the PCF (or by the AF via NEF/PCF) using the procedure specified in TS 23.287 [5] clause 6.2, or pre-configured as specified in TS 23.287 [5] clause 5.1.1.
1b.	If the UE is ""served by NR"" (as defined in TS 23.287 [5]), the PC5 DRX configuration may be alternatively provided by the NG-RAN, potentially together with information about Uu configurations, either via broadcasting or with dedicated RRC signalling. In this option, the AS layer may indicate the relevant configured PC5 DRX parameters to the V2X layer or apply PC5 DRX configuration on the AS layer (see also the description of step 5).
Editor's note:	Whether and how the NG-RAN provides the PC5 DRX configuration to the UE is up to RAN WGs to decide.
2.	The V2X application layer provides the Application Requirements to the V2X layer which can be mapped to QoS parameters as defined in TS 23.287 [5] clause 5.4.1.1. V2X applications layer may also provide application traffic pattern information, which contains message periodicity/interval and message size/burst information if available.
NOTE 1:	The mentioned application traffic pattern information may also be provided by the V2X applications (via the V2X layer) to the AS layer, where they can be used as input when computing the AS-layer SL-TrafficPatternInfo (defined in TS 38.331 [9]), which could in turn have an impact on AS layer's final decision about the PC5 DRX configuration that is to be applied. The AS layer SL-TrafficPatternInfo contains more RAN related parameters in addition to message periodicity and message size.
Editor's note:	Whether and when it is useful to provide the application traffic pattern information from the V2X layer to the AS layer need coordination with RAN WGs.
3.	The V2X layer of UE1 may select one or more PC5 DRX pattern from the configured PC5 DRX pattern set. If more than one PC5 DRX patterns are selected, this means that the V2X layer can accept the application of any of them. The selection takes into account the following i) the requirements and application traffic pattern information of all active V2X service types that the UE1 currently has, ii) the Uu DRX configurations received by the NG-RAN (if any), and iii) the selected PC5 DRX patterns that other relevant UEs have applied and indicated.
NOTE 2:	The triggering of the selection of the PC5 DRX pattern(s) at the V2X Layer, e.g. upon expiration of a timer, upon changes of the V2X Application Requirements as defined in TS 23.287 [5] or the DRX-related information about other UEs, or similar, is up to implementation. Potential PC5 DRX negotiations performed in the context of a single unicast connection are not considered by the V2X layer in this step, but rather during the AS-layer decision to accept a V2X layer-requested PC5 DRX pattern (step 5) or during the V2X-layer-independent decision of the AS-layer to modify an applied PC5 DRX schedule or apply a new one (see step 6).
4.	The V2X layer of UE1 requests applying (one of) the selected PC5 DRX pattern(s) to the AS layer for control of PC5 transmission and reception according to the selected PC5 DRX pattern.
5.	The AS layer of UE1 decides to apply or not the requested PC5 DRX pattern (or one of the requested PC5 DRX patterns), i.e. it configures the (AS-layer) PC5 DRX schedule based on the ON/OFF periods indicated in the PC5 DRX pattern.
NOTE 3:	The selection and request of PC5 DRX patterns at the V2X layer is optional and the PC5 DRX schedule (and further related configuration) might be decided on the AS layer only, though ideally based on knowledge about V2X Application Requirements as defined in TS 23.287 [5] and traffic patterns. RAN WG will have a final confirmation on the criteria used in this case. In this case the AS layer may know the set of applicable PC5 DRX patterns (as well as all further inputs that it requires) and send indications about the applied PC5 DRX schedule to other UEs using mechanisms specified by the RAN WG. Further, again depending on RAN WG decisions, the AS layer of UE1 could potentially also decide to extend the ON durations of a selected (and applied) PC5 DRX schedule based on AS layer information (e.g. full buffers, misalignment with resource pools or AS-layer signalling, monitored QoS, etc.).
6.	The AS layer informs the V2X layer about the success or failure of the application of the requested PC5 DRX pattern(s), indicating which pattern was applied if multiple were provided in the request. In case the AS layer decides to apply a PC5 DRX schedule that does not correspond to any of the provided patterns, then the applied PC5 DRX schedule is also indicated to the V2X layer. This indication can be provided not only as a response to a PC5 DRX pattern request (step 4) but also later (asynchronously) in case the AS layer modifies the PC5 DRX schedule (or applies a new one) based on its own logic.
7.	The V2X layer of UE1 indicates (using broadcast or groupcast communication over the PC5 interface) the applied PC5 DRX pattern to other relevant UE(s) (e.g. UE2) to allow UE2 to select its PC5 DRX pattern in a coordinated manner.
8.	The V2X applications of UE2 may retrieve from the V2X layer information about the PC5 DRX patterns applied by one or more related UEs and adjust their communication schedule.
9.	The V2X layer of UE2 may provide the V2X layer information about the PC5 DRX patterns applied by one or more related UEs to the AS layer and the AS layer adapts the PC5 transmission schedule accordingly.",TR 23.776,6.2.2,all_images/image_1706.png,PC5 DRX configuration procedure for QoS-aware and power-efficient communication
"This solution is for ""Key Issue #1: Support of QoS aware NR PC5 power efficiency for pedestrian UEs"".
The UEs receive PC5 DRX configuration for transmitting/receiving V2X messages over PC5 from the network. The network configures the Pedestrian UEs with a PC5 DRX configuration over PC5 taking into account the V2X service types supported by the network and the V2X applications QoS requirements.
Two options are provided for the Pedestrian UE to receive V2X configuration information:
-	Option 1: Default PC5 DRX configuration is provided by the AMF during the registration procedure
-	Option 2: The AF/PCF provides mapping of PQI(s) to PC5 DRX configuration
The PC5 DRX configuration information for PQI includes the following:
-	A ""ran2_offset"" that defines at what point in the SFN cycle is the DRX configuration is applied
-	DRX cycle configuration
Editor's note:	Whether the AS layer requires PC5 DRX configuration to determine PC5 DRX requires confirmation from RAN.
In Option 1, the AMF can provide a default PC5 DRX configuration to the UE during the registration procedure. The default PC5 DRX configuration provided to the UE applies for all cast types and all V2X service types. When the UE is authorized to use V2X communication over PC5 reference point as Pedestrian UE as defined in clause 6.5.2 of TS 23.287 [5], the AMF determines the PC5 DRX configuration is required for the UE based on the UE subscription and if required provides the PC5 DRX Configuration to the UE. The AMF ensures that all UEs registered on the same areas receive the same PC5 DRX configuration. The default PC5 DRX configuration that is provided to the UE is based on pre-configuration at the AMF. The network operator configures the default PC5 DRX taking into account the QoS requirements of V2X applications providing pedestrian services. Whether the same default PC5 DRX configuration is used in all AMFs of a PLMN or a different PC5 DRX configuration is used at each AMF is up to network operator deployment.
In the inter-PLMN scenario, the default PC5 DRX configuration needs to be coordinated amongst all PLMNs serving a specific region.
In Option 2, the AF/PCF includes PC5 DRX configuration within V2X configuration information during UE Policy delivery procedure defined in clause 6.2 of TS 23.287 [5]. The configuration information includes mapping of PQI(s) to a specific PC5 DRX Configuration.
Editor's note:	Coordination with RAN is required to confirm if AS layer or V2X layer derives the DRX for PC5.
The UE applies the received PC5 DRX configuration as follows and shown in Figure 6.5.1-1.
-	The UE configures an ""Active Time"" and an ""Inactive Time"" for V2X Communication over PC5 based on the received PC5 DRX configuration.
-	When the UE is in ""Inactive Time"" the UE enters in a ""sleep"" state and does not transmit or listen for V2X messages over PC5
-	When the UE is in ""Active Time"" the UE can transmit V2X messages provided by the V2X application layer or listen for V2X messages over PC5. If the V2X application provides the data during the UE's inactive state the UE buffers the data and transmits them during the Active Time Period.
Editor's note:	The exact procedure for the UE to apply the received DRX configuration requires coordination with RAN.
Figure 6.5.1-1: Transmitting/Receiving V2X messages over PC5 based on PC5 DRX configuration
In certain scenarios, some V2X applications may provide the V2X layer with the specific V2X Application Requirements as described in TS 23.287 [5], to send V2X messages over PC5 for a V2X service type as defined in clause 5.4.1.1.2 of TS 23.287 [5]. In such cases the PC5 DRX configuration provided by the network may not be adequate to sustain such V2X application QoS requirements. The UE may add an offset in the configured PC5 DRX extending the ""Active Time"" for transmitting the data to support the QoS requirements of the application. This is shown in Figure 6.5.1-2.
Editor's note:	How the UE determines the offset if default PC5 DRX configuration is provided will be defined in RAN
Figure 6.5.1-2: Extending PC5 DRX to support required QoS
If the UE has received PC5 DRX configuration for PQI as part of V2X configuration information, the V2X layer in the UE provides to the AS layer the PC5 DRX configuration by following PC5 QoS Flow derivation as described in TS 23.287 [5] as follows:
-	Based on the V2X application provided QoS requirements or the mapping of the V2X service type to PC5 QoS parameters, the V2X layer determines PC5 QoS Parameters.
-	Based on the PQI, the V2X layer determines PC5 DRX configuration information from V2X configuration information.
-	The V2X layer determines the PC5 QoS Flow (creates new or modifies an existing one) and passes to the AS layer the PC5 QoS requirements and PC5 DRX configuration for the PC5 QoS Flow.
-	The AS layer applies the PC5 DRX configuration and determines Active Time and Offset.
For a receiving UE, the UE determines the PC5 DRX as follows:
-	The UE applies the default PC5 DRX if provided by the AMF or
-	The UE determines the destination layer-2 IDs for broadcast/groupcast reception based on the mapping of V2X service types to Destination Layer-2 ID(s) for broadcast/groupcast as specified in clause 5.6.1.2 of TS 23.287 [5]. The receiving UE then determines the PC5 QoS parameters based on the mapping of V2X service types to PC5 QoS parameters as specified in clause 5.1.2.1 of TS 23.287 [5] or based on QoS requirements provided by the application. The receiving UE then applies the PC5 DRX according to the mapping of PQI(s) to PC5 DRX configuration.
In case, a Pedestrian UE has multiple active PC5 QoS Flows with different PC5 QoS parameters each having a different PC5 DRX configuration, it is proposed the AS layer to configure a DRX cycle that combines all PC5 DRX configurations. This ensures that the UE will be able to monitor and send V2X messages from all ""active"" V2X applications. In addition, the AS layer can determine to switch the UE in ""always-on"" mode if there is no power efficiency by combining all DRX configuration.
In case the UE has received both default PC5 DRX configuration information from the AMF and the PC5 DRX configuration information for PQI from the AF/PCF, therefore the V2X layer provides both to the AS layer, the AS layer can also combine the PC5 DRX configuration.
Editor's note:	How the AS layer combines the PC5 DRX configuration needs to be defined/confirmed in RAN groups
Once the UE determines the offset the UE applies the offset for all V2X communications over unicast, groupcast or broadcast.",TR 23.776,6.5.1,all_images/image_1707.jpeg,Transmitting/Receiving V2X messages over PC5 based on PC5 DRX configuration
"Figure 6.5.2-1 provides the procedure for applying the PC5 DRX configuration.
Figure 6.5.2-1: UE applying received PC5 DRX configuration
1.	Pedestrian UEs register to the 5G network using standard procedures.
2.	The Pedestrian UE receives PC5 DRX configuration from the network (either based on Option 1 and/or Option 2 described in clause 6.5.1).
3.	Based on the received PC5 DRX configuration the AS layer in the UE determines an Active Time and an Inactive Time. The UE transmits and/or listen for V2X messages over PC5 only during the DRX Active Time.
4.	An application in the UE requests to send a V2X message over PC5 with specific QoS requirements by providing V2X Application Requirements to the V2X layer as described in TS 23.287 [5]. The V2X layer determines the PC5 QoS parameters based on the V2X Application Requirements and provide them to the AS layer as defined in clause 5.4.1.1.3 of TS 23.287 [5]. If the UE has received PC5 DRX configuration within V2X configuration information from the AF/PCF, the V2X layer also includes PC5 DRX configuration for each applicable PC5 QoS Flow.
5.	If the V2X layer provided the default PC5 DRX configuration, the AS layer in the UE determines that the configured PC5 DRX cannot support the QoS requirements and determines an additional offset in the configured PC5 DRX to support the required QoS.
If the V2X layer provided the PC5 DRX configuration for the PC5 QoS Flow, the AS layer determines the PC5 DRX taking into account the PC5 DRX configuration for all PC5 QoS Flows (default PC5 DRX configuration and/or PC5 DRX configuration for each PC5 QoS Flow).
6.	The AS layer applies the PC5 DRX for all sidelink communications over PC5 for any V2X service.
7.	When a pedestrian UE establishes a unicast link with a UE for V2X communication, the UEs may negotiate a new PC5 DRX according to the QoS requirements of the application requiring to send V2X messages via this unicast link.",TR 23.776,6.5.2,all_images/image_1708.png,UE applying received PC5 DRX configuration
"Figure 6.1.1-1 shows the functional model for the application plane of MCVideo service for on-network operations.
Figure 6.1.1-1: Functional model for application plane of MCVideo service
In the model shown in figure 6.1.1-1, the following apply:
-	The MCVideo server is an instantiation of a MC service server in accordance with 3GPP TS 23.280 [6].
-	The MCVideo server is an instantiation of a GCS AS in accordance with 3GPP TS 23.468 [9].
-	MCVideo-9 carries signalling over multicast bearer between the transmission control server of the MCVideo server and the transmission control participant of the MCVideo UE.
-	MCVideo-4 carries signalling over unicast bearer between the transmission control server of the MCVideo server and the transmission control participant of the MCVideo UE.",TS 23.281,6.1.1,all_images/image_1709.jpeg,Functional model for application plane of MCVideo service
"Figure 6.1.2-1 shows the functional model for the application plane of MCVideo service for off-network operations.
Figure 6.1.2-1: Functional model for application plane of off-network MCVideo service",TS 23.281,6.1.2,all_images/image_1710.png,Functional model for application plane of off-network MCVideo service
"Procedures in figure 7.1.2.3.2-1 are the signalling control plane procedures for the MCVideo server requesting a newly de-affiliated member to leave an ongoing MCVideo group call.
Pre-conditions:
1.	MCVideo group is previously defined on the group management server with MCVideo users affiliated to that group. All members of the group belong to the same MC system.
2.	MCVideo users on MCVideo client 1 to MCVideo client n are on an ongoing call.
3.	MCVideo client 1 has been de-affiliated from the MCVideo group.
Figure 7.1.2.3.2-1: Exiting MCVideo group call due to de-affiliation
1.	MCVideo client 1 which has been de-affiliated is instructed to leave the ongoing group call.
2.	MCVideo server sends a group call leave request to MCVideo client 1.
3.	MCVideo user at MCVideo client 1 is notified about leaving the group call.
4.	MCVideo client 1 sends the group call leave response and leaves the group call.
5.	MCVideo client 1 is now removed from the ongoing group call and MCVideo users at MCVideo client 2 to MCVideo client n may be notified that MCVideo client 1 has left the group call.",TS 23.281,7.1.2.3.2,all_images/image_1711.png,Exiting MCVideo group call due to de-affiliation
"The procedure describes the case where an authorized MCVideo user is upgrading an MCVideo group call to an MCVideo emergency group call while the MCVideo group call is already in progress.
Procedures in figure 7.1.2.5.1.2-1 are the signalling control plane procedures for the MCVideo client upgrading an MCVideo group call on an MCVideo group to an MCVideo emergency group call.
NOTE 1:	For simplicity, a single MCVideo server is shown in place of a user home MCVideo server and a group hosting MCVideo server.
Pre-conditions:
1.	The MCVideo group is previously defined on the group management server with MCVideo client 2 and MCVideo client 3 affiliated to that MCVideo group.
2.	All members of the MCVideo group belong to the same MC system.
3.	An MCVideo group call is already in progress.
4.	The initiating MCVideo client 1 has been configured to send an MCVideo emergency alert when upgrading an MCVideo emergency group call.
Figure 7.1.2.5.1.2-1: MCVideo group call upgraded to an MCVideo emergency group call
1.	The MCVideo user at MCVideo client 1 initiates a group emergency. MCVideo client 1 sets its MCVideo emergency state. The MCVideo emergency state of MCVideo client 1 is retained until explicitly cancelled by the user of MCVideo client 1.
NOTE 2: While MCVideo client 1 is in the emergency state, all MCVideo group and private calls initiated by MCVideo client 1 are initiated as MCVideo emergency calls.
2.	MCVideo client 1 requests the MCVideo server to upgrade the MCVideo group to an in-progress emergency state by sending an MCVideo emergency group call request. If configured to send an MCVideo alert when initiating an MCVideo emergency upgrade, the request also contains an indication that an MCVideo alert is to be initiated. The request may contain an indication of an implicit transmit media request.
NOTE 3:	While the MCVideo group is in the in-progress emergency state, all MCVideo group calls within the group are processed as emergency group calls by the MCVideo server. MCVideo group members that are not in the emergency state do not indicate emergency in group call requests but can set the requested priority of all group call requests to high priority.
3.	The MCVideo server adjusts the priority of the underlying bearer for all participants in the MCVideo group.
4.	MCVideo server sends the MCVideo emergency group call request towards the MCVideo clients of each of those affiliated MCVideo group members. The request contains an indication of an MCVideo emergency alert if the request from the originator indicated MCVideo emergency alert.
5.	MCVideo users are notified of the in-progress emergency state of the MCVideo group.
6.	The receiving MCVideo clients send the MCVideo emergency group call response to the MCVideo server to acknowledge the MCVideo group emergency request. For a multicast call, these acknowledgements are not sent.
7.	The MCVideo server sends the MCVideo emergency group call response to the MCVideo user 1 to confirm the upgrade request. If the MCVideo emergency request contained an implicit transmit media request, the OK message contains the result of the implicit transmit media request.
NOTE 4:	Step 7 can occur at any time following step 3, and prior to step 8 depending on the conditions to proceed with the call.
MCVideo client 1, MCVideo client 2 and MCVideo client 3 continue with the MCVideo group call, which has been transformed into an MCVideo emergency group call. MCVideo client 1 can override other clients in the call except those that are also in the MCVideo emergency state.",TS 23.281,7.1.2.5.1.2,all_images/image_1713.jpeg,MCVideo group call upgraded to an MCVideo emergency group call
"NOTE 1:	In Rel-14 and Rel-13 versions of this specification the title of this subclause is ""MCVideo emergency group call cancel"".
The procedure describes the case where an MCVideo client cancels an MCVideo group's in-progress emergency state. The emergency state of the group may alternatively be cancelled by the emergency alert cancellation procedure specified in 3GPP TS 23.280 [16], subclause 10.10.1.2.2.2.
Procedures in figure 7.1.2.5.1.3-1 are the signalling control plane procedures for the MCVideo client cancelling an in-progress emergency of a group.
NOTE 2:	For simplicity, a single MCVideo server is shown in place of a user home MCVideo server and a group hosting MCVideo server.
NOTE 3:	The end of the MCVideo emergency group call does not cancel the MCVideo group's in-progress emergency state. It is explicitly cancelled by an authorized user using this procedure, or by the emergency alert cancellation procedure specified in 3GPP TS 23.280 [5], subclause 10.10.1.2.2.2.
Pre-conditions:
1.	The MCVideo group is previously defined on the group management server with MCVideo client 2 and MCVideo client 3 affiliated to that MCVideo group.
2.	All members of the MCVideo group belong to the same MC system.
3.	MCVideo group members have been notified about the in-progress emergency.
4.	The MCVideo group is in the in-progress emergency state and has prioritized bearer support.
5.	MCVideo client 1 previously initiated the in-progress emergency for the group.
Figure 7.1.2.5.1.3-1: MCVideo in-progress emergency group state cancel
1.	The user at the MCVideo client 1 initiates an MCVideo in-progress emergency group state cancel.
NOTE 4:	An MCVideo user authorized to cancel in-progress emergencies on the MCVideo group can also be authorised to cancel the MCVideo emergency alert in addition to the initiator. However, only the initiator can cancel the initiator's local MCVideo emergency state.
2.	MCVideo client 1 sends an MCVideo in-progress emergency group state cancel request to the MCVideo server.
NOTE 5:	If an MCVideo emergency alert relating to MCVideo client 1 is in effect together with an MCVideo in-progress emergency group state on the MCVideo group, the MCVideo emergency alert of MCVideo client 1 can be cancelled at the same time. In that case, the MCVideo in-progress emergency group state request carries an indication that the emergency alert of MCVideo client 1 is also being cancelled.
NOTE 6:	If an MCVideo in-progress emergency group state cancel request is received by the MCVideo server while a group member that is in the emergency state is transmitting, the MCVideo in-progress emergency group state cancel request is rejected by the MCVideo server.
3.	MCVideo server resolves the MCVideo group ID to determine the members of that MCVideo group and their affiliation status, based upon the information from group management server.
4.	The MCVideo server adjusts the priority of the underlying bearer; priority treatment is no longer required. The MCVideo server cancels/resets the emergency in-progress state of the MCVideo group.
5.	The MCVideo server sends an MCVideo in-progress emergency group state cancel request to the MCVideo group members.
6.	MCVideo group members are notified of the MCVideo in-progress emergency group state cancel.
7.	The receiving MCVideo clients send the MCVideo in-progress emergency group state cancel response to the MCVideo server to acknowledge the MCVideo in-progress emergency group state cancel. For a multicast call scenario, these acknowledgements are not sent.
8.	The MCVideo server sends the MCVideo in-progress emergency group state cancel response to the MCVideo user 1 to confirm the MCVideo in-progress emergency group state cancel. If the MCVideo in-progress emergency group state cancel request (in step 2) contained the ""Alert indicator"" IE, the MCVideo client 1 resets its local emergency status.
NOTE 7:	Step 8 can occur at any time following step 4, depending on the conditions to proceed with the call.",TS 23.281,7.1.2.5.1.3,all_images/image_1714.jpeg,MCVideo in-progress emergency group state cancel
"The procedure focuses on the case where an authorized MCVideo user is upgrading an MCVideo group call to an imminent peril group call while the MCVideo group call is already in progress.
Procedures in figure 7.1.2.5.2.2-1 are the signalling control plane procedures for the MCVideo client upgrading an MCVideo group call on an MCVideo group to an imminent peril group call.
Pre-conditions:
1.	The MCVideo group is previously defined on the group management server with MCVideo client 1, MCVideo client 2 and MCVideo client 3 affiliated to that MCVideo group.
2.	All members of the MCVideo group belong to the same MC system.
3.	An MCVideo group call is already in progress.
Figure 7.1.2.5.2.2-1: MCVideo group call upgrade to an imminent peril group call
1.	The MCVideo user at MCVideo client 1 initiates an imminent peril call.
2.	MCVideo client 1 requests the MCVideo server to upgrade the MCVideo group to an in-progress imminent peril state by sending an MCVideo imminent peril group call request. The request may contain an indication of an implicit transmit media request.
3.	The MCVideo server adjusts the priority of the underlying bearer for all participants in the MCVideo group.
4.	MCVideo server sends the MCVideo imminent peril group call request towards the MCVideo clients of each of those affiliated MCVideo group members.
5.	MCVideo users are notified of the in-progress imminent peril state of the MCVideo group.
6.	The receiving MCVideo clients send the MCVideo imminent peril group call response to the MCVideo server to acknowledge the MCVideo imminent peril group call request. For a multicast call, these acknowledgements are not set.
7.	The MCVideo server sends the MCVideo imminent peril group call response to the MCVideo user 1 to confirm the upgrade request. If the MCVideo imminent peril group call request contained an implicit transmit media request, the OK message contains the result of the implicit transmit media request.
NOTE:	Step 7 can occur at any time following step 4, and prior to step 8 depending on the conditions to proceed with the call.
MCVideo client 1, MCVideo client 2 and MCVideo client 3 continue with the MCVideo group call, which has been transformed into an imminent peril group call.",TS 23.281,7.1.2.5.2.2,all_images/image_1716.png,MCVideo group call upgrade to an imminent peril group call
"The procedure focuses on the case where an authorized MCVideo user cancels an MCVideo group's in-progress imminent peril state.
Procedures in figure 7.1.2.5.2.3-1 are the signalling control plane procedures for the MCVideo client cancelling an MCVideo group's in-progress imminent peril state.
NOTE 1:	The end of the imminent peril call does not cancel the MCVideo group's in-progress imminent peril state. It is explicitly cancelled by an authorized user.
Pre-conditions:
1.	The MCVideo group is previously defined on the group management server with MCVideo client 1, MCVideo client 2 and MCVideo client 3 affiliated to that MCVideo group.
2.	All members of the MCVideo group belong to the same MC system.
3.	The MCVideo group is an in-progress imminent peril state and has prioritized bearer support.
4.	MCVideo group members have been notified about the MCVideo group's in-progress imminent peril state.
5.	MCVideo client 1 previously initiated the in-progress imminent peril.
Figure 7.1.2.5.2.3-1: MCVideo imminent peril group call cancel
1.	The user at the MCVideo client 1 initiates an imminent peril cancel.
2.	MCVideo client 1 sends an MCVideo imminent peril group call cancel request to the MCVideo server.
3.	The MCVideo server adjusts the priority of the underlying bearer; priority treatment is no longer required. The MCVideo server cancels/resets the in-progress imminent peril state.
4.	MCVideo server resolves the MCVideo group ID to determine the members of that MCVideo group and their affiliation status, based upon the information from group management server.
5.	The MCVideo server sends an MCVideo imminent peril group call cancel request to the MCVideo group members.
6.	MCVideo group members are notified of the in-progress imminent peril cancel.
7.	The receiving MCVideo group members send the MCVideo imminent peril group call cancel response to the MCVideo server to acknowledge the in-progress MCVideo imminent peril group call cancel request. For a multicast scenario, these acknowledgements are not set.
8.	The MCVideo server sends the MCVideo imminent peril group call cancel response to the MCVideo user 1 to confirm the MCVideo imminent peril group call cancel request.
NOTE 2:	Step 8 can occur at any time following step 4, depending on the conditions to proceed with the call.",TS 23.281,7.1.2.5.2.3,all_images/image_1717.png,MCVideo imminent peril group call cancel
"Figure 7.1.3.4.2-1 describes procedures to join a MCVideo group communication passively.
The MCVideo client X passively waits for a Group communication announcement message. Upon receiving a periodic Group communication announcement message, MCVideo client X establishes media plane and joins the MCVideo group communication.
Pre-conditions:
1.	Information for ProSe direct communications corresponding to the MCVideo group and its mapping to ProSe Layer-2 Group ID are pre-configured in MCVideo client 1 to client N and client X.
2.	MCVideo client 1 to MCVideo client N and MCVideo client X are members of the same MCVideo group.
3.	MCVideo client 1 to MCVideo client N are part of an ongoing MCVideo group communication.
Figure 7.1.3.4.2-1: Passive join to MCVideo group communication
1.	Another MCVideo client X enters in the communication range after the MCVideo group communication establishment. The MCVideo client X does not do anything and passively waits for a periodic Group communication announcement message.
2.	An MCVideo client which is part of the ongoing MCVideo group communication eventually sends a periodic Group communication announcement message.
3.	Upon receiving the periodic Group communication announcement message MCVideo client X sets the parameters for  media plane as described in the Group communication announcement message.
4.	If the Group communication announcement message included a confirm mode indication, MCVideo client X may sends a group communication answer response towards MCVideo group to inform all MCVideo group members of its participation the MCVideo group communication.
5.	MCVideo group communication continues with the MCVideo client X.",TS 23.281,7.1.3.4.2,all_images/image_1719.png,Passive join to MCVideo group communication
"Figure 7.1.3.5.2-1 describes procedures to join a MCVideo group communication actively.
The MCVideo client X sends a Group communication announcement message towards the MCVideo group.
Upon receiving a Group communication announcement message with new communication parameters, such as communication identifier, a MCVideo client participating in the on-going group communication for the MCVideo group sends a Group communication announcement message.
The Group communication announcement message contains parameters for the on-going MCVideo group communication. MCVideo client X upon receiving such a Group communication announcement message establishes the media plane as described in the message and joins the MCVideo group communication.
Pre-conditions:
1.	Information for ProSe direct communications corresponding to the MCVideo group and its mapping to ProSe Layer-2 Group ID are pre-configured in MCVideo client 1 to client N and client X.
2.	MCVideo client 1 to MCVideo client N and MCVideo client X are members of the same MCVideo group.
3.	MCVideo client 1 to MCVideo client N are part of an ongoing MCVideo group communication.
Figure 7.1.3.5.2-1: Active join to MCVideo group communication
1.	Another MCVideo client X enters in the communication range after the MCVideo group communication establishment. The MCVideo client X sends a Group communication announcement message to start a newMCVideo group communication.
2.	Upon receiving a Group communication announcement message with new communication parameters, such as communication identifier, another MCVideo client, which is part of the ongoing MCVideo group communication sends a Group communication announcement message.
3.	Upon receiving the Group communication announcement message MCVideo client X sets parameters for the media plane as described in the Group communication announcement message.
4.	If the Group communication announcement message included a confirm mode indication, MCVideo client X may send a group communication answer response towards MCVideo group to inform all MCVideo group members of its participation the MCVideo group communication.
5.	MCVideo group communication continues with the MCVideo client X.",TS 23.281,7.1.3.5.2,all_images/image_1720.png,Active join to MCVideo group communication
"The procedure describes the scenario where an MCVideo user is initiating an MCVideo private call for communicating with another MCVideo user, with or without transmission control enabled, in an automatic commencement mode.
Procedures in figure 7.2.2.3.1-1 are the basic signalling control plane procedures for the MCVideo client initiating establishment of MCVideo private call with the chosen MCVideo user.
Pre-conditions:
1.	MCVideo users on MCVideo client 1 and MCVideo client 2 are already registered for receiving MCVideo service.
2.	The calling MCVideo user has selected automatic commencement mode for the call; or
3.	The called MCVideo client is set to automatic commencement mode.
4.	Optionally, the MCVideo client 1 may have a functional alias activated to be used.
5.	The MCVideo server may have subscribed to the MCVideo functional alias controlling server within the MC system for functional alias activation/de-activation updates.
Figure 7.2.2.3.1-1: Private call setup in automatic commencement mode– MCVideo users in the same MC system
1.	User at MCVideo client 1 would like to initiate an MCVideo private call for the chosen MCVideo user. The MCVideo user at MCVideo client 1 may include a functional alias used within the MCVideo private call.
2.	MCVideo client 1 sends an MCVideo private call request towards the MCVideo server (via SIP core) using a service identifier as defined in 3GPP TS 23.228 [5] for MCVideo, for establishing a private call with the chosen MCVideo user. The MCVideo private call request contains the MCVideo ID or the functional alias of invited user, an SDP offer containing one or more media types. The MCVideo client 1 may include a Requested commencement mode that indicates that the call is to be established in automatic commencement mode if automatic commencement mode is requested by the initiating user.
NOTE 1:	As part of this step, MCVideo client 1 and MCVideo client 2 set up a security association (when no functional alias is present), if end-to-end encryption is used for this call.
3.	MCVideo server checks whether the MCVideo user at MCVideo client 1 is authorized to initiate the private call, and that MCVideo user at MCVideo client 2 is authorized to receive the private call. MCVideo server verifies whether the provided functional alias, if present, can be used and has been activated for the user. If the MCVideo private call request contains a functional alias instead of an MCVideo ID as called party, the MCVideo server shall resolve the functional alias to the corresponding MCVideo ID(s) for which the functional alias is active. The MCVideo server shall also check whether MCVideo client 1 is allowed to use the functional alias of MCVideo client 2 to setup a private call and whether MCVideo client 2 is allowed to receive a private call from MCVideo client 1 using the functional alias. If the MCVideo private call request requested automatic commencement mode then the MCVideo server also checks whether the MCVideo user at MCVideo client 1 is authorized to initiate a private call in automatic commencement mode.
NOTE 2:	When a functional alias is shared among multiple MCVideo users, only one target MCVideo user can be target of the private call request. The MCVideo server resolves the associated MCVideo IDs of the functional alias and determines a MCVideo ID by help of criteria not defined here (e.g. location, time etc). This determination can include rejection of the call, if no suitable MCVideo ID is selected.
4a.	If the MCVideo private call request contains only the functional alias instead of an MCVideo ID for the called party, the MCVideo server responds with a functional alias resolution response message that contains the resolved MCVideo ID back to MCVideo client 1.
4b.	If the MCVideo server replies with a MCVideo functional alias resolution response message, the MCVideo client 1 sends a new MCVideo private call request towards the resolved MCVideo ID.
NOTE 3:	MCVideo client 1 and MCVideo client 2 set up a security association for the media, if end-to-end encryption is used for this call.
5.	MCVideo server may provide a progress indication to MCVideo client 1 to indicate progress in the call setup process.
NOTE 4:	Step 5 can occur at any time following step 4b, and prior to step 9.
6.	If authorized, MCVideo server includes information that it communicates using MCVideo service, offers the same media types or a subset of the media types contained in the initial received request, includes the requested automatic commencement mode indication based on a requested automatic commencement mode by the calling user or based upon the setting of the called MCVideo client and sends the corresponding MCVideo private call request towards the MCVideo client 2, including the MC service ID and, if available the functional alias of the calling MCVideo user 1. If the called MCVideo user has registered to the MCVideo service with multiple MCVideo UEs and has designated the MCVideo UE for receiving the private calls, then the incoming MCVideo private call request is delivered only to the designated MCVideo UE.
7.	The receiving MCVideo client 2 notifies the user about the incoming private call. If the functional alias of the calling user is included, it is displayed.
8.	The receiving MCVideo client 2 accepts the private call automatically, and an MCVideo private call response is sent to the MCVideo server (via SIP core).
9.	Upon receiving the MCVideo private call response from MCVideo client 2 accepting the private call request, the MCVideo server informs the MCVideo client 1 about successful call establishment.
10.	MCVideo client 1 and MCVideo client 2 have successfully established media plane and transmission control for communication and both users can transmit media.",TS 23.281,7.2.2.3.1,all_images/image_1721.jpeg,Private call setup in automatic commencement mode– MCVideo users in the same
"Both clients are served by the primary MC service provider in figure 7.2.2.3.2.2-1.
Pre-conditions:
1.	MCVideo client 1 and MCVideo client 2 are both registered and their respective users, MCVideo user 1 and MCVideo user 2, are authenticated and authorized to use the MCVideo service.
2.	The calling MCVideo user has selected manual commencement mode or has not specified a commencement mode for the call; and
3.	The called MCVideo client is set to manual commencement mode.
4.	Optionally, the MCVideo client 1 may have a functional alias activated to be used.
5.	The MCVideo server may have subscribed to the MCVideo functional alias controlling server within the MC system for functional alias activation/de-activation updates.
Figure 7.2.2.3.2.2-1: MCVideo private call in manual commencement mode– MCVideo users in the same MC system
1.	MCVideo user at MCVideo client 1 would like to initiate an MCVideo private call for the selected MCVideo user. The MCVideo user at MCVideo client 1 may include a functional alias used within the MCVideo private call.
2.	MCVideo client 1 sends an MCVideo private call request addressed to the MC service ID of MCVideo user 2 using an MCVideo service identifier as defined in 3GPP TS 23.228 [5] (possible for the SIP core to route the request to the MCVideo server). The MCVideo private call request contains the MC service ID or the functional alias of invited user and an SDP offer containing one or more media types. The MCVideo client 1 may include a requested commencement mode that indicates that the call is to be established in manual commencement mode if manual commencement mode is requested by the initiating user.
NOTE 1:	As part of this step, MCVideo client 1 and MCVideo client 2 set up a security association (when no functional alias is present), if end-to-end encryption is used for this call.
3.	The MCVideo server confirms that both MCVideo users are authorized for the private call. MCVideo server verifies whether the provided functional alias, if present, can be used and has been activated for the user. If the MCVideo private call request contains a functional alias instead of an MCVideo ID as called party, the MCVideo server shall resolve the functional alias to the corresponding MCVideo ID(s) for which the functional alias is active. The MCVideo server shall also check whether MCVideo client 1 is allowed to use the functional alias of MCVideo client 2 to setup a private call and whether MCVideo client 2 is allowed to receive a private call from MCVideo client 1 using the functional alias. The MCVideo server checks the commencement mode setting of the called MCVideo client and also checks whether the MCVideo user at MCVideo client 1 is authorized to initiate a call in manual commencement mode.
NOTE 2:	When a functional alias is shared among multiple MCVideo users, only one target MCVideo user can be target of the private call request. The MCVideo server resolves the associated MCVideo IDs of the functional alias and determines a MCVideo ID by help of criteria not defined here (e.g. location, time etc). This determination can include rejection of the call, if no suitable MCVideo ID is selected.
4a.	If the MCVideo private call request contains only the functional alias instead of an MCVideo ID for the called party, the MCVideo server responds with a functional alias resolution response message that contains the resolved MCVideo ID back to MCVideo client 1.
4b.	If the MCVideo server provided the corresponding MCVideo ID, the MCVideo client 1 sends a new MCVideo private call request containing the resolved MCVideo ID.
NOTE 3:	MCVideo client 1 and MCVideo client 2 set up a security association for the media, if end-to-end encryption is used for this call.
5.	The MCVideo server includes information that it communicates using MCVideo service, offers the same media types or a subset of the media types contained in the initial received request and sends an MCVideo private call request for the call to MCVideo client 2, including the MC service ID, and, if available the functional alias of the calling MCVideo user 1. If the called MCVideo user has registered to the MCVideo service with multiple MCVideo UEs and has designated the MCVideo UE for receiving the private calls, then the incoming MCVideo private call request is delivered only to the designated MCVideo UE.
6.	MCVideo server may provide a progress indication to MCVideo client 1 to indicate progress in the call setup process.
NOTE 4:	Step 6 can occur at any time following step 4b, and prior to step 7b.
7a.	The MCVideo user is alerted. MCVideo client 2 sends an MCVideo ringing to the MCVideo server.
7b.	The MCVideo server sends an MCVideo ringing to MCVideo client 1, indicating that MCVideo client 2 is being alerted. If the functional alias of the calling user is included, it is displayed.
8.	MCVideo user 2 is notified and has accepted the call using manual commencement mode (i.e., has taken some action to accept via the user interface).
9.	The MCVideo client 2 sends an MCVideo private call response to the MCVideo server. If MCVideo user 2 has not accepted the incoming call, the MCVideo client 2 sends a call failure response to the MCVideo server without adding reason for call failure.
10.	The MCVideo server sends an MCVideo private call response to MCVideo client 1 indicating that MCVideo user 2 has accepted the call, including the accepted media parameters.
11.	The media plane and transmission control for communication is established.",TS 23.281,7.2.2.3.2.2,all_images/image_1722.png,MCVideo private call in manual commencement mode– MCVideo users in the
"The procedure describes the scenario where an MCVideo client is requesting to release an ongoing MCVideo private call (with or without transmission control) and the call established in either of the two commencement modes (manual or automatic).
Procedures in figure 7.2.2.3.3.1-1 are the basic signalling control plane procedures for the MCVideo client initiating the release of an ongoing MCVideo private call.
Pre-condition:
1.	It is assumed that MCVideo users on MCVideo client 1 and MCVideo client 2 are already registered for receiving MCVideo service and are involved in private call as described in subclause 7.2.2.3.1 and subclause 7.2.2.3.2.
Figure 7.2.2.3.3.1-1: Private call release – client initiated
1.	User at MCVideo client 1 would like to release an ongoing MCVideo private call with MCVideo client 2.
2.	MCVideo client 1 sends an MCVideo call end request towards the MCVideo server (via SIP core), for tearing down the private call with the other client.
3.	MCVideo server sends the corresponding MCVideo call end request towards the MCVideo client specified in the original MCVideo call end request.
4.	MCVideo user is notified about the release of the private call.
5.	The receiving MCVideo client 2 acknowledges the MCVideo call end request with a MCVideo call end response.
6.	After receiving the MCVideo call end response from MCVideo client 2, the MCVideo server generates an MCVideo call end response for the MCVideo client 1's MCVideo call end request.
7.	MCVideo clients release all the media plane resources used for the private call. Further, if the private call was established with transmission control, transmission control resources are released.",TS 23.281,7.2.2.3.3.1,all_images/image_1723.jpeg,Private call release – client initiated
"The procedure describes the scenario where an MCVideo server is terminating an ongoing MCVideo private call  and the call established in either of the two commencement modes (manual or automatic), upon conditions to terminate call e.g., MCVideo administrator configured maximum duration for MCVideo private calls has expired or timed out due to MCVideo private call without transmission/reception.
Procedures in figure 7.2.2.3.3.2-1 are the basic signalling control plane procedures for the MCVideo server initiating termination of an ongoing MCVideo private call.
Pre-condition:
1.	It is assumed that MCVideo users on MCVideo client 1 and MCVideo client 2 are already registered for receiving MCVideo service and are involved in private call established either in manual or automatic commencement mode.
Figure 7.2.2.3.3.2-1: End private call – server initiated
1.	Upon conditions to terminate call e.g., MCVideo administrator configured maximum duration for MCVideo private calls has expired or timed out due to MCVideo private call without transmission/reception, the MCVideo server decides to initiate termination of an ongoing MCVideo private call between MCVideo client 1 and MCVideo client 2.
2.	MCVideo server sends an MCVideo call end request towards the MCVideo clients 1 and 2 (via SIP core), for tearing down the private call between them.
3.	MCVideo users at client 1 and client 2 are notified about the termination of the private call.
4.	The MCVideo call end request receiving MCVideo clients 1 and 2 acknowledge the request with MCVideo call end response.
5.	MCVideo clients release all the media plane resources used for the private call. Further, if the private call was established with transmission control, transmission control resources are released.",TS 23.281,7.2.2.3.3.2,all_images/image_1724.png,End private call – server initiated
"Figure 7.2.3.5.2-1 describes procedures to establish an off-network manual commencement private communication between MCVideo user A MCVideo user B, which is accepted by the MCVideo user B.
Pre-conditions:
1.	MCVideo user A has initiated manual commencement private communication with MCVideo user B.
2.	MCVideo user B has indicated MCVideo client B as the designated MCVideo client for MCVideo private communications, if the MCVideo user B has signed on to the MCVideo service with multiple MCVideo clients.
3.	MCVideo client A and MCVideo client B are members of the same ProSe Discovery group and are ProSe 1:1 direct communication capable.
4.	MCVideo client A has discovered MCVideo clients B in proximity, associated with MCVideo user B, using ProSe Discovery procedures.
Editor's Note:	How MCVideo client A determines that MCVideo client B is the designated MCVideo client of MCVideo user B for private communications is FFS.
Figure 7.2.3.5.2-1: Off-network manual commencement private communication – Accepted
1.	The MCVideo client A sends the Private communication request towards MCVideo client associated with MCVideo user B. The Private communication request contains an indication for manual commencement and the SDP offer.
2.	On receiving a Private communication request, the MCVideo client checks if it is the designated MCVideo client for off-network MCVideo private communications.
3a.	The designated MCVideo client B presents the incoming Private communication request to the MCVideo user B.
3b.	The MCVideo client B sends back a Private communication ringing response to the MCVideo client A.
NOTE 1:	Step 3a and step 3b can occur in any order.
4.	The MCVideo client A notifies the ringing status to the MCVideo user A.
5.	The MCVideo user B accepts the Private communication request.
6.	The MCVideo client B sends the Private communication answer response to the MCVideo client A. The Private communication response contains the SDP answer.
7.	The MCVideo client A and the MCVideo client B establish the media plane for Private communication.
NOTE 2:	If a MCVideo client fails to establish the communication, the MCVideo client should send a Private communication failed response indicating the failure reason to the appropriate MCVideo client.
8.	MCVideo media is transmitted from the MCVideo client A to the MCVideo client B and is presented to the MCVideo user B.
NOTE 3:	If a Private communication failed response is received by a MCVideo client, before or after establishing the media session, if already established, the session is terminated and the MCVideo user is notified about the failure and its reason, if any.",TS 23.281,7.2.3.5.2,all_images/image_1727.png,Off-network manual commencement private communication – Accepted
"Figure 7.2.3.5.3-1 describes procedures to initiate an off-network manual commencement private communication between MCVideo user A MCVideo user B, which is rejected or ignored by the MCVideo user B.
Pre-conditions:
1.	MCVideo user A has initiated manual commencement private communication with MCVideo user B.
2.	MCVideo user B has indicated MCVideo client B as the designated MCVideo client for MCVideo Private Communications, if the MCVideo user B has signed on to the MCVideo service with multiple MCVideo clients.
3.	MCVideo client A and MCVideo client B are members of the same ProSe Discovery group and are ProSe 1:1 direct communication capable.
4.	MCVideo client A has discovered MCVideo clients B in proximity, associated with MCVideo user B, using ProSe Discovery procedures.
Editor's Note:	How MCVideo client A determines that MCVideo client B is the designated MCVideo client of MCVideo user B for private communications is FFS.
Figure 7.2.3.5.3-1: Off-network manual commencement private communication – Rejected or Ignored
1.	The MCVideo client A sends the private communication request towards MCVideo client associated with MCVideo user B. The private communication request contains an indication for manual commencement and the SDP offer.
2.	On receiving a Private communication request, the MCVideo client checks if it is the designated MCVideo client for off-network MCVideo private communications.
3a.	The designated MCVideo client B presents the incoming Private communication request to the MCVideo user B.
3b.	The MCVideo client B sends back a Private communication ringing response to the MCVideo client A.
NOTE 1:	Step 3a and step 3b can occur in any order.
4.	The MCVideo client A notifies the ringing status to the MCVideo user A.
5.	The MCVideo user B rejects (or ignores) the Private communication request.
NOTE 2:	The MCVideo client B determines that the MCVideo user B has ignored the Private communication request, if the MCVideo user B does not respond within a configured time limit.
6.	The MCVideo client B sends a Private communication reject response to the MCVideo client A. The Private communication reject response may indicate that the MCVideo user B has ignored the Private communication request.
7.	The MCVideo client A notifies the MCVideo user A that the Private communication request was rejected (or ignored).",TS 23.281,7.2.3.5.3,all_images/image_1728.png,Off-network manual commencement private communication – Rejected or Ignored
"The procedure describes the case where an authorized MCVideo user is initiating an remotely initiated video push call from source MCVideo user to a destination MCVideo user. Only the source user is allowed to transmit video to the destination user.
Procedures in figure 7.4.2.5.2-1 are the basic signalling control plane procedures for the MCVideo client remotely initiating establishment of MCVideo private call between the source and destination MCVideo users.
Figure 7.4.2.5.2-1: Remotely initiated video push – call setup
1.	MCVideo user on MCVideo client 3 initiates remote video push from MCVideo client 1 to MCVideo client 2, by sending a remote video push request to the MCVideo server for establishing a one-to-one video push call between MCVideo client 1 and MCVideo client 2. The remote video push call request contains MCVideo ID of source (MCVideo client 1) and destination (MCVideo client 2) users
2.	MCVideo server checks whether the MCVideo user at MCVideo client 3 is authorized to remotely initiate video push call between the source user and the destination user. MCVideo server also checks if there is any on-going call between the source user and the destination user.
3.	If MCVideo client 3 is authorized and there is no on-ongoing private call between source user and destination user, the MCVideo server sends the remote video push request message to MCVideo client 1 including the information of MCVideo ID of source and destination users.
4.	The MCVideo client 1 accepts the remote video push request and establishes a one-to-one video push call between MCVideo client 1 and MCVideo client 2 as described in the subclause 7.4.2.3.2. The video is transmitted from MCVideo client 1 to MCVideo Client 2.
5.	The MCVideo client 1 sends a remote video push response message to MCVideo server indicating success or failure of call establishment between MCVideo client 1 and MCVideo client 2.
6.	Upon receiving the remote video push response from MCVideo client 1, the MCVideo server informs the MCVideo client 3 about success or failure of the call establishment by sending a remote video push response message.
NOTE:	Steps 5 and 6 can occur before step 4.",TS 23.281,7.4.2.5.2,all_images/image_1731.png,Remotely initiated video push – call setup
"The procedure describes the case where an authorized MCVideo user is releasing an remotely initiated video push call.
Procedures in figure 7.4.2.5.3-1 are the basic signalling control plane procedures for the MCVideo client releasing the remotely initiated video push call between the source and destination users.
Figure 7.4.2.5.3-1: Remotely initiated video push – call release by authorized user
1.	MCVideo user on MCVideo client 3 initiates release of remotely initiated video push call between MCVideo client 1 and MCVideo client 2, by sending a remote video push release request to the MCVideo server for releasing a one-to-one video push call between MCVideo client 1 and MCVideo client 2. The remote video push release request contains MCVideo ID of source user (MCVideo client 1) and destination user (MCVideo client 2).
2.	MCVideo server checks whether the MCVideo user at MCVideo client 3 is authorized to release the remotely initiated video push call between MCVideo client 1 and MCVideo client 2, and whether there is any on-going one-to-one video push call between MCVideo client 1 and MCVideo client 2.
3.	MCVideo server sends the remote video push release request to MCVideo client 1 for releasing the on-going one-to-one video push call between MCVideo client 1 and MCVideo client 2.
4.	The MCVideo client 1 accepts the remote video push release request and performs the release procedure for the one-to-one video push call between MCVideo client 1 and MCVideo client 2 as described in the subclause 7.4.2.3.3.
5.	The MCVideo client 1 sends a remote video push release response to the MCVideo server indicating the release of the one-to-one video push call between MCVideo client 1 and MCVideo client 2.
6.	Upon receiving the remote video push release response from MCVideo client 1, the MCVideo server informs the MCVideo client 3 about the one-to-one video push call release by sending a remote video push release response message.
NOTE:	Steps 5 and 6 can occur before step 4.",TS 23.281,7.4.2.5.3,all_images/image_1732.png,Remotely initiated video push – call release by authorized user
